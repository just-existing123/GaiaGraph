// Version 1.47.7 react-force-graph - https://github.com/vasturiano/react-force-graph
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ForceGraph={},e.React)}(this,(function(e,n){"use strict";function i(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,s,o,a=[],l=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(i=s.call(n)).done)&&(a.push(i.value),a.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return a}}(e,t)||o(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(e){return function(e){if(Array.isArray(e))return a(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||o(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,t){if(e){if("string"==typeof e)return a(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?a(e,t):void 0}}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function c(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,s,o,a=[],l=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t);else for(;!(l=(i=s.call(n)).done)&&(a.push(i.value),a.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return a}}(e,t)||h(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e){return function(e){if(Array.isArray(e))return l(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||h(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e,t){if(e){if("string"==typeof e)return l(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(e,t):void 0}}function d(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=t.wrapperElementType,a=void 0===o?"div":o,l=t.nodeMapper,c=void 0===l?function(e){return e}:l,h=t.methodNames,d=void 0===h?[]:h,f=t.initPropNames,m=void 0===f?[]:f;return n.forwardRef((function(t,o){var l=n.useRef(),h=n.useMemo((function(){var n=Object.fromEntries(m.filter((function(e){return t.hasOwnProperty(e)})).map((function(e){return[e,t[e]]})));return e(n)}),[]);p((function(){h(c(l.current))}),n.useLayoutEffect),p((function(){return h._destructor instanceof Function?h._destructor:void 0}));var f,g,y,v=n.useCallback((function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return h[e]instanceof Function?h[e].apply(h,n):void 0}),[h]),_=n.useRef({});return Object.keys((f=t,g=[].concat(u(d),u(m)),y=new Set(g),Object.assign.apply(Object,[{}].concat(s(Object.entries(f).filter((function(e){var t=r(e,1)[0];return!y.has(t)})).map((function(e){var t=r(e,2);return i({},t[0],t[1])}))))))).filter((function(e){return _.current[e]!==t[e]})).forEach((function(e){return v(e,t[e])})),_.current=t,n.useImperativeHandle(o,(function(){return Object.fromEntries(d.map((function(e){return[e,function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return v.apply(void 0,[e].concat(n))}]})))}),[v]),n.createElement(a,{ref:l})}))}function p(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.useEffect,i=n.useRef(),r=n.useRef(!1),s=n.useRef(!1),o=c(n.useState(0),2);o[0];var a=o[1];r.current&&(s.current=!0),t((function(){return r.current||(i.current=e(),r.current=!0),a((function(e){return e+1})),function(){s.current&&i.current&&i.current()}}),[])}function f(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function m(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if("function"==typeof t){var n=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,i.get?i:{enumerable:!0,get:function(){return e[t]}})})),n}var g,y,v,_,x,b,w,T={};function S(){return v?y:(v=1,y=Object.assign((function(){}),{FACE_1:0,FACE_2:1,FACE_3:2,FACE_4:3,L_SHOULDER_1:4,R_SHOULDER_1:5,L_SHOULDER_2:6,R_SHOULDER_2:7,SELECT:8,START:9,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,VENDOR:16}))}function M(){if(w)return b;w=1;const e=S(),t=(x||(x=1,_=function(e,t,n){this.type=e,this.index=t,this.pressed=n.pressed,this.value=n.value}),_),n=.2,i="left",r="right",s=1,o=2;return b=AFRAME.registerComponent("gamepad-controls",{GamepadButton:e,schema:{enabled:{default:!0},rotationSensitivity:{default:2}},init:function(){const e=this.el.sceneEl;this.system=e.systems["tracked-controls"]||e.systems["tracked-controls-webxr"]||{controllers:[]},this.prevTime=window.performance.now(),this.buttons={};const t=this.el.object3D.rotation;this.pitch=new THREE.Object3D,this.pitch.rotation.x=t.x,this.yaw=new THREE.Object3D,this.yaw.position.y=10,this.yaw.rotation.y=t.y,this.yaw.add(this.pitch),this._lookVector=new THREE.Vector2,this._moveVector=new THREE.Vector2,this._dpadVector=new THREE.Vector2,e.addBehavior(this)},update:function(){this.tick()},tick:function(e,t){this.updateButtonState(),this.updateRotation(t)},remove:function(){},isVelocityActive:function(){if(!this.data.enabled||!this.isConnected())return!1;const e=this._dpadVector,t=this._moveVector;this.getDpad(e),this.getJoystick(s,t);const i=e.x||t.x,r=e.y||t.y;return Math.abs(i)>n||Math.abs(r)>n},getVelocityDelta:function(){const e=this._dpadVector,t=this._moveVector;this.getDpad(e),this.getJoystick(s,t);const i=e.x||t.x,r=e.y||t.y,o=new THREE.Vector3;return Math.abs(i)>n&&(o.x+=i),Math.abs(r)>n&&(o.z+=r),o},isRotationActive:function(){if(!this.data.enabled||!this.isConnected())return!1;const e=this._lookVector;return this.getJoystick(o,e),Math.abs(e.x)>n||Math.abs(e.y)>n},updateRotation:function(e){if(!this.isRotationActive())return;const t=this.data,i=this.yaw,r=this.pitch;i.rotation.y=this.el.object3D.rotation.y,r.rotation.x=this.el.object3D.rotation.x;const s=this._lookVector;this.getJoystick(o,s),Math.abs(s.x)<=n&&(s.x=0),Math.abs(s.y)<=n&&(s.y=0),s.multiplyScalar(t.rotationSensitivity*e/1e3),i.rotation.y-=s.x,r.rotation.x-=s.y,r.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,r.rotation.x)),this.el.object3D.rotation.set(r.rotation.x,i.rotation.y,0)},updateButtonState:function(){const e=this.getGamepad(r);if(this.data.enabled&&e)for(var n=0;n<e.buttons.length;n++)e.buttons[n].pressed&&!this.buttons[n]?this.emit(new t("gamepadbuttondown",n,e.buttons[n])):!e.buttons[n].pressed&&this.buttons[n]&&this.emit(new t("gamepadbuttonup",n,e.buttons[n])),this.buttons[n]=e.buttons[n].pressed;else for(const e in this.buttons)this.buttons[e]=!1},emit:function(e){this.el.emit(e.type,e),this.el.emit(e.type+":"+e.index,new t(e.type,e.index,e))},getGamepad:function(){const e=[],t=[];return function(n){const i=this.el.sceneEl.components["proxy-controls"],r=i&&i.isConnected()&&i.getGamepad(0);if(r)return r;e.length=0;for(let t=0;t<this.system.controllers.length;t++){const i=this.system.controllers[t],r=i?i.gamepad:null;if(e.push(r),r&&i.handedness===n)return r}const s=navigator.getGamepads?navigator.getGamepads():t;for(let e=0;e<s.length;e++){const t=s[e];if(t&&t.hand===n)return t}return e[0]||s[0]}}(),getButton:function(e){return this.getGamepad(r).buttons[e]},getAxis:function(e){return this.getGamepad(e>1?r:i).axes[e]},getJoystick:function(e,t){const n=this.getGamepad(e===s?i:r);if(!n)return t.set(0,0);if("xr-standard"===n.mapping)switch(e){case s:return t.set(n.axes[2],n.axes[3]);case o:return t.set(n.axes[2],0)}else switch(e){case s:return t.set(n.axes[0],n.axes[1]);case o:return t.set(n.axes[2],n.axes[3])}throw new Error('Unexpected joystick index "%d".',e)},getDpad:function(t){const n=this.getGamepad(i);return n&&n.buttons[e.DPAD_RIGHT]?t.set((n.buttons[e.DPAD_RIGHT].pressed?1:0)+(n.buttons[e.DPAD_LEFT].pressed?-1:0),(n.buttons[e.DPAD_UP].pressed?-1:0)+(n.buttons[e.DPAD_DOWN].pressed?1:0)):t.set(0,0)},isConnected:function(){const e=this.getGamepad(i);return!(!e||!e.connected)},getID:function(){return this.getGamepad(i).id}}),b}var E,A,C,R,N,P,D,L={};function I(){return E||(E=1,function(e){var t="KeyboardEvent"in e;t||(e.KeyboardEvent=function(){throw TypeError("Illegal constructor")}),"DOM_KEY_LOCATION_STANDARD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_STANDARD=0),"DOM_KEY_LOCATION_LEFT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_LEFT=1),"DOM_KEY_LOCATION_RIGHT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_RIGHT=2),"DOM_KEY_LOCATION_NUMPAD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD=3);var n=window.KeyboardEvent.DOM_KEY_LOCATION_STANDARD,i=window.KeyboardEvent.DOM_KEY_LOCATION_LEFT,r=window.KeyboardEvent.DOM_KEY_LOCATION_RIGHT,s=window.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD;function o(e,t){return-1!==String(e).indexOf(t)}var a=o(navigator.platform,"Win")?"win":o(navigator.platform,"Mac")?"mac":o(navigator.platform,"CrOS")?"cros":o(navigator.platform,"Linux")?"linux":o(navigator.userAgent,"iPad")||o(navigator.platform,"iPod")||o(navigator.platform,"iPhone")?"ios":"",l=o(navigator.userAgent,"Chrome/")?"chrome":o(navigator.vendor,"Apple")?"safari":o(navigator.userAgent,"MSIE")?"ie":o(navigator.userAgent,"Gecko/")?"moz":o(navigator.userAgent,"Opera/")?"opera":"",c=l+"-"+a;function u(e,t,n){c!==t&&l!==t&&a!==t||Object.keys(n).forEach((function(t){e[t]=n[t]}))}var h={3:{code:"Cancel"},6:{code:"Help"},8:{code:"Backspace"},9:{code:"Tab"},12:{code:"Clear"},13:{code:"Enter"},16:{code:"Shift"},17:{code:"Control"},18:{code:"Alt"},19:{code:"Pause"},20:{code:"CapsLock"},21:{code:"KanaMode"},22:{code:"HangulMode"},23:{code:"JunjaMode"},24:{code:"FinalMode"},25:{code:"KanjiMode"},27:{code:"Escape"},28:{code:"Convert"},29:{code:"NonConvert"},30:{code:"Accept"},31:{code:"ModeChange"},32:{code:"Space"},33:{code:"PageUp"},34:{code:"PageDown"},35:{code:"End"},36:{code:"Home"},37:{code:"ArrowLeft"},38:{code:"ArrowUp"},39:{code:"ArrowRight"},40:{code:"ArrowDown"},41:{code:"Select"},42:{code:"Print"},43:{code:"Execute"},44:{code:"PrintScreen"},45:{code:"Insert"},46:{code:"Delete"},47:{code:"Help"},48:{code:"Digit0",keyCap:"0"},49:{code:"Digit1",keyCap:"1"},50:{code:"Digit2",keyCap:"2"},51:{code:"Digit3",keyCap:"3"},52:{code:"Digit4",keyCap:"4"},53:{code:"Digit5",keyCap:"5"},54:{code:"Digit6",keyCap:"6"},55:{code:"Digit7",keyCap:"7"},56:{code:"Digit8",keyCap:"8"},57:{code:"Digit9",keyCap:"9"},65:{code:"KeyA",keyCap:"a"},66:{code:"KeyB",keyCap:"b"},67:{code:"KeyC",keyCap:"c"},68:{code:"KeyD",keyCap:"d"},69:{code:"KeyE",keyCap:"e"},70:{code:"KeyF",keyCap:"f"},71:{code:"KeyG",keyCap:"g"},72:{code:"KeyH",keyCap:"h"},73:{code:"KeyI",keyCap:"i"},74:{code:"KeyJ",keyCap:"j"},75:{code:"KeyK",keyCap:"k"},76:{code:"KeyL",keyCap:"l"},77:{code:"KeyM",keyCap:"m"},78:{code:"KeyN",keyCap:"n"},79:{code:"KeyO",keyCap:"o"},80:{code:"KeyP",keyCap:"p"},81:{code:"KeyQ",keyCap:"q"},82:{code:"KeyR",keyCap:"r"},83:{code:"KeyS",keyCap:"s"},84:{code:"KeyT",keyCap:"t"},85:{code:"KeyU",keyCap:"u"},86:{code:"KeyV",keyCap:"v"},87:{code:"KeyW",keyCap:"w"},88:{code:"KeyX",keyCap:"x"},89:{code:"KeyY",keyCap:"y"},90:{code:"KeyZ",keyCap:"z"},91:{code:"OSLeft",location:i},92:{code:"OSRight",location:r},93:{code:"ContextMenu"},95:{code:"Standby"},96:{code:"Numpad0",keyCap:"0",location:s},97:{code:"Numpad1",keyCap:"1",location:s},98:{code:"Numpad2",keyCap:"2",location:s},99:{code:"Numpad3",keyCap:"3",location:s},100:{code:"Numpad4",keyCap:"4",location:s},101:{code:"Numpad5",keyCap:"5",location:s},102:{code:"Numpad6",keyCap:"6",location:s},103:{code:"Numpad7",keyCap:"7",location:s},104:{code:"Numpad8",keyCap:"8",location:s},105:{code:"Numpad9",keyCap:"9",location:s},106:{code:"NumpadMultiply",keyCap:"*",location:s},107:{code:"NumpadAdd",keyCap:"+",location:s},108:{code:"NumpadComma",keyCap:",",location:s},109:{code:"NumpadSubtract",keyCap:"-",location:s},110:{code:"NumpadDecimal",keyCap:".",location:s},111:{code:"NumpadDivide",keyCap:"/",location:s},112:{code:"F1"},113:{code:"F2"},114:{code:"F3"},115:{code:"F4"},116:{code:"F5"},117:{code:"F6"},118:{code:"F7"},119:{code:"F8"},120:{code:"F9"},121:{code:"F10"},122:{code:"F11"},123:{code:"F12"},124:{code:"F13"},125:{code:"F14"},126:{code:"F15"},127:{code:"F16"},128:{code:"F17"},129:{code:"F18"},130:{code:"F19"},131:{code:"F20"},132:{code:"F21"},133:{code:"F22"},134:{code:"F23"},135:{code:"F24"},144:{code:"NumLock",location:s},145:{code:"ScrollLock"},160:{code:"ShiftLeft",location:i},161:{code:"ShiftRight",location:r},162:{code:"ControlLeft",location:i},163:{code:"ControlRight",location:r},164:{code:"AltLeft",location:i},165:{code:"AltRight",location:r},166:{code:"BrowserBack"},167:{code:"BrowserForward"},168:{code:"BrowserRefresh"},169:{code:"BrowserStop"},170:{code:"BrowserSearch"},171:{code:"BrowserFavorites"},172:{code:"BrowserHome"},173:{code:"VolumeMute"},174:{code:"VolumeDown"},175:{code:"VolumeUp"},176:{code:"MediaTrackNext"},177:{code:"MediaTrackPrevious"},178:{code:"MediaStop"},179:{code:"MediaPlayPause"},180:{code:"LaunchMail"},181:{code:"MediaSelect"},182:{code:"LaunchApp1"},183:{code:"LaunchApp2"},186:{code:"Semicolon",keyCap:";"},187:{code:"Equal",keyCap:"="},188:{code:"Comma",keyCap:","},189:{code:"Minus",keyCap:"-"},190:{code:"Period",keyCap:"."},191:{code:"Slash",keyCap:"/"},192:{code:"Backquote",keyCap:"`"},219:{code:"BracketLeft",keyCap:"["},220:{code:"Backslash",keyCap:"\\"},221:{code:"BracketRight",keyCap:"]"},222:{code:"Quote",keyCap:"'"},226:{code:"IntlBackslash",keyCap:"\\"},229:{code:"Process"},246:{code:"Attn"},247:{code:"CrSel"},248:{code:"ExSel"},249:{code:"EraseEof"},250:{code:"Play"},251:{code:"ZoomToggle"},254:{code:"Clear"}};u(h,"moz",{59:{code:"Semicolon",keyCap:";"},61:{code:"Equal",keyCap:"="},107:{code:"Equal",keyCap:"="},109:{code:"Minus",keyCap:"-"},187:{code:"NumpadAdd",keyCap:"+",location:s},189:{code:"NumpadSubtract",keyCap:"-",location:s}}),u(h,"moz-mac",{12:{code:"NumLock",location:s},173:{code:"Minus",keyCap:"-"}}),u(h,"moz-win",{173:{code:"Minus",keyCap:"-"}}),u(h,"chrome-mac",{93:{code:"OSRight",location:r}}),u(h,"safari",{3:{code:"Enter"},25:{code:"Tab"}}),u(h,"ios",{10:{code:"Enter",location:n}}),u(h,"safari-mac",{91:{code:"OSLeft",location:i},93:{code:"OSRight",location:r},229:{code:"KeyQ",keyCap:"Q"}});var d={};"cros"===a&&(d["U+00A0"]={code:"ShiftLeft",location:i},d["U+00A1"]={code:"ShiftRight",location:r},d["U+00A2"]={code:"ControlLeft",location:i},d["U+00A3"]={code:"ControlRight",location:r},d["U+00A4"]={code:"AltLeft",location:i},d["U+00A5"]={code:"AltRight",location:r}),"chrome-mac"===c&&(d["U+0010"]={code:"ContextMenu"}),"safari-mac"===c&&(d["U+0010"]={code:"ContextMenu"}),"ios"===a&&(d["U+0010"]={code:"Function"},d["U+001C"]={code:"ArrowLeft"},d["U+001D"]={code:"ArrowRight"},d["U+001E"]={code:"ArrowUp"},d["U+001F"]={code:"ArrowDown"},d["U+0001"]={code:"Home"},d["U+0004"]={code:"End"},d["U+000B"]={code:"PageUp"},d["U+000C"]={code:"PageDown"});var p=[];p[i]={16:{code:"ShiftLeft",location:i},17:{code:"ControlLeft",location:i},18:{code:"AltLeft",location:i}},p[r]={16:{code:"ShiftRight",location:r},17:{code:"ControlRight",location:r},18:{code:"AltRight",location:r}},p[s]={13:{code:"NumpadEnter",location:s}},u(p[s],"moz",{109:{code:"NumpadSubtract",location:s},107:{code:"NumpadAdd",location:s}}),u(p[i],"moz-mac",{224:{code:"OSLeft",location:i}}),u(p[r],"moz-mac",{224:{code:"OSRight",location:r}}),u(p[r],"moz-win",{91:{code:"OSRight",location:r}}),u(p[r],"mac",{93:{code:"OSRight",location:r}}),u(p[s],"chrome-mac",{12:{code:"NumLock",location:s}}),u(p[s],"safari-mac",{12:{code:"NumLock",location:s},187:{code:"NumpadAdd",location:s},189:{code:"NumpadSubtract",location:s},190:{code:"NumpadDecimal",location:s},191:{code:"NumpadDivide",location:s}});var f={ShiftLeft:{key:"Shift"},ShiftRight:{key:"Shift"},ControlLeft:{key:"Control"},ControlRight:{key:"Control"},AltLeft:{key:"Alt"},AltRight:{key:"Alt"},OSLeft:{key:"OS"},OSRight:{key:"OS"},NumpadEnter:{key:"Enter"},Space:{key:" "},Digit0:{key:"0",shiftKey:")"},Digit1:{key:"1",shiftKey:"!"},Digit2:{key:"2",shiftKey:"@"},Digit3:{key:"3",shiftKey:"#"},Digit4:{key:"4",shiftKey:"$"},Digit5:{key:"5",shiftKey:"%"},Digit6:{key:"6",shiftKey:"^"},Digit7:{key:"7",shiftKey:"&"},Digit8:{key:"8",shiftKey:"*"},Digit9:{key:"9",shiftKey:"("},KeyA:{key:"a",shiftKey:"A"},KeyB:{key:"b",shiftKey:"B"},KeyC:{key:"c",shiftKey:"C"},KeyD:{key:"d",shiftKey:"D"},KeyE:{key:"e",shiftKey:"E"},KeyF:{key:"f",shiftKey:"F"},KeyG:{key:"g",shiftKey:"G"},KeyH:{key:"h",shiftKey:"H"},KeyI:{key:"i",shiftKey:"I"},KeyJ:{key:"j",shiftKey:"J"},KeyK:{key:"k",shiftKey:"K"},KeyL:{key:"l",shiftKey:"L"},KeyM:{key:"m",shiftKey:"M"},KeyN:{key:"n",shiftKey:"N"},KeyO:{key:"o",shiftKey:"O"},KeyP:{key:"p",shiftKey:"P"},KeyQ:{key:"q",shiftKey:"Q"},KeyR:{key:"r",shiftKey:"R"},KeyS:{key:"s",shiftKey:"S"},KeyT:{key:"t",shiftKey:"T"},KeyU:{key:"u",shiftKey:"U"},KeyV:{key:"v",shiftKey:"V"},KeyW:{key:"w",shiftKey:"W"},KeyX:{key:"x",shiftKey:"X"},KeyY:{key:"y",shiftKey:"Y"},KeyZ:{key:"z",shiftKey:"Z"},Numpad0:{key:"0"},Numpad1:{key:"1"},Numpad2:{key:"2"},Numpad3:{key:"3"},Numpad4:{key:"4"},Numpad5:{key:"5"},Numpad6:{key:"6"},Numpad7:{key:"7"},Numpad8:{key:"8"},Numpad9:{key:"9"},NumpadMultiply:{key:"*"},NumpadAdd:{key:"+"},NumpadComma:{key:","},NumpadSubtract:{key:"-"},NumpadDecimal:{key:"."},NumpadDivide:{key:"/"},Semicolon:{key:";",shiftKey:":"},Equal:{key:"=",shiftKey:"+"},Comma:{key:",",shiftKey:"<"},Minus:{key:"-",shiftKey:"_"},Period:{key:".",shiftKey:">"},Slash:{key:"/",shiftKey:"?"},Backquote:{key:"`",shiftKey:"~"},BracketLeft:{key:"[",shiftKey:"{"},Backslash:{key:"\\",shiftKey:"|"},BracketRight:{key:"]",shiftKey:"}"},Quote:{key:"'",shiftKey:'"'},IntlBackslash:{key:"\\",shiftKey:"|"}};u(f,"mac",{OSLeft:{key:"Meta"},OSRight:{key:"Meta"}});var m={Esc:"Escape",Nonconvert:"NonConvert",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Menu:"ContextMenu",MediaNextTrack:"MediaTrackNext",MediaPreviousTrack:"MediaTrackPrevious",SelectMedia:"MediaSelect",HalfWidth:"Hankaku",FullWidth:"Zenkaku",RomanCharacters:"Romaji",Crsel:"CrSel",Exsel:"ExSel",Zoom:"ZoomToggle"},g=function(e,t){var n={};return Object.keys(e).forEach((function(i){var r=e[i];t in r&&(n[r[t]]=r)})),n}(h,"code");try{var y=t&&"location"in new KeyboardEvent("")}catch(e){}function v(e){var t="keyCode"in e?e.keyCode:"which"in e?e.which:0,n=function(){if(y||"keyLocation"in e){var n=y?e.location:e.keyLocation;if(n&&t in p[n])return p[n][t]}return"keyIdentifier"in e&&e.keyIdentifier in d?d[e.keyIdentifier]:t in h?h[t]:null}();if(!n)return null;var i,r=(i=f[n.code])?e.shiftKey&&"shiftKey"in i?i.shiftKey:i.key:n.code;return{code:n.code,key:r,location:n.location,keyCap:n.keyCap}}"KeyboardEvent"in e&&"defineProperty"in Object&&function(){function e(e,t,n){t in e||Object.defineProperty(e,t,n)}if(e(KeyboardEvent.prototype,"code",{get:function(){var e=v(this);return e?e.code:""}}),"key"in KeyboardEvent.prototype){var t=Object.getOwnPropertyDescriptor(KeyboardEvent.prototype,"key");Object.defineProperty(KeyboardEvent.prototype,"key",{get:function(){var e=t.get.call(this);return m.hasOwnProperty(e)?m[e]:e}})}e(KeyboardEvent.prototype,"key",{get:function(){var e=v(this);return e&&"key"in e?e.key:"Unidentified"}}),e(KeyboardEvent.prototype,"location",{get:function(){var e=v(this);return e&&"location"in e?e.location:n}}),e(KeyboardEvent.prototype,"locale",{get:function(){return""}})}(),"queryKeyCap"in e.KeyboardEvent||(e.KeyboardEvent.queryKeyCap=function(e,t){if(e=String(e),!g.hasOwnProperty(e))return"Undefined";if(t&&"en-us"!==String(t).toLowerCase())throw Error("Unsupported locale");var n=g[e];return n.keyCap||n.code||"Undefined"}),e.identifyKey=function(e){if(!("code"in e)){var t=v(e);e.code=t?t.code:"",e.key=t&&"key"in t?t.key:"Unidentified",e.location="location"in e?e.location:"keyLocation"in e?e.keyLocation:t&&"location"in t?t.location:n,e.locale=""}}}(window)),L}const k=(e,t)=>{const n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},O=e=>e*(Math.PI/180),U=e=>e*(180/Math.PI),F=new Map,B=e=>{F.has(e)&&clearTimeout(F.get(e)),F.set(e,setTimeout(e,100))},z=(e,t,n)=>{const i=t.split(/[ ,]+/g);let r;for(let t=0;t<i.length;t+=1)r=i[t],e.addEventListener?e.addEventListener(r,n,!1):e.attachEvent&&e.attachEvent(r,n)},V=(e,t,n)=>{const i=t.split(/[ ,]+/g);let r;for(let t=0;t<i.length;t+=1)r=i[t],e.removeEventListener?e.removeEventListener(r,n):e.detachEvent&&e.detachEvent(r,n)},G=e=>(e.preventDefault(),e.type.match(/^touch/)?e.changedTouches:e),j=()=>({x:void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,y:void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}),H=(e,t)=>{t.top||t.right||t.bottom||t.left?(e.style.top=t.top,e.style.right=t.right,e.style.bottom=t.bottom,e.style.left=t.left):(e.style.left=t.x+"px",e.style.top=t.y+"px")},W=(e,t,n)=>{const i=q(e);for(let e in i)if(i.hasOwnProperty(e))if("string"==typeof t)i[e]=t+" "+n;else{let r="";for(let e=0,i=t.length;e<i;e+=1)r+=t[e]+" "+n+", ";i[e]=r.slice(0,-2)}return i},q=e=>{const t={};t[e]="";return["webkit","Moz","o"].forEach((function(n){t[n+e.charAt(0).toUpperCase()+e.slice(1)]=""})),t},X=(e,t)=>{for(let n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},$=(e,t)=>{if(e.length)for(let n=0,i=e.length;n<i;n+=1)t(e[n]);else t(e)};var Y,K=!!("ontouchstart"in window),Z=!!window.PointerEvent,J=!!window.MSPointerEvent,Q={start:"mousedown",move:"mousemove",end:"mouseup"},ee={};function te(){}function ne(e,t){return this.identifier=t.identifier,this.position=t.position,this.frontPosition=t.frontPosition,this.collection=e,this.defaults={size:100,threshold:.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:.5,mode:"dynamic",zone:document.body,lockX:!1,lockY:!1,shape:"circle"},this.config(t),"dynamic"===this.options.mode&&(this.options.restOpacity=0),this.id=ne.id,ne.id+=1,this.buildEl().stylize(),this.instance={el:this.ui.el,on:this.on.bind(this),off:this.off.bind(this),show:this.show.bind(this),hide:this.hide.bind(this),add:this.addToDom.bind(this),remove:this.removeFromDom.bind(this),destroy:this.destroy.bind(this),setPosition:this.setPosition.bind(this),resetDirection:this.resetDirection.bind(this),computeDirection:this.computeDirection.bind(this),trigger:this.trigger.bind(this),position:this.position,frontPosition:this.frontPosition,ui:this.ui,identifier:this.identifier,id:this.id,options:this.options},this.instance}function ie(e,t){var n=this;n.nipples=[],n.idles=[],n.actives=[],n.ids=[],n.pressureIntervals={},n.manager=e,n.id=ie.id,ie.id+=1,n.defaults={zone:document.body,multitouch:!1,maxNumberOfNipples:10,mode:"dynamic",position:{top:0,left:0},catchDistance:200,size:100,threshold:.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:.5,lockX:!1,lockY:!1,shape:"circle",dynamicPage:!1,follow:!1},n.config(t),"static"!==n.options.mode&&"semi"!==n.options.mode||(n.options.multitouch=!1),n.options.multitouch||(n.options.maxNumberOfNipples=1);const i=getComputedStyle(n.options.zone.parentElement);return i&&"flex"===i.display&&(n.parentIsFlex=!0),n.updateBox(),n.prepareNipples(),n.bindings(),n.begin(),n.nipples}function re(e){var t=this;t.ids={},t.index=0,t.collections=[],t.scroll=j(),t.config(e),t.prepareCollections();var n=function(){var e;t.collections.forEach((function(n){n.forEach((function(n){e=n.el.getBoundingClientRect(),n.position={x:t.scroll.x+e.left,y:t.scroll.y+e.top}}))}))};z(window,"resize",(function(){B(n)}));var i=function(){t.scroll=j()};return z(window,"scroll",(function(){B(i)})),t.collections}Z?Y={start:"pointerdown",move:"pointermove",end:"pointerup, pointercancel"}:J?Y={start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}:K?(Y={start:"touchstart",move:"touchmove",end:"touchend, touchcancel"},ee=Q):Y=Q,te.prototype.on=function(e,t){var n,i=this,r=e.split(/[ ,]+/g);i._handlers_=i._handlers_||{};for(var s=0;s<r.length;s+=1)n=r[s],i._handlers_[n]=i._handlers_[n]||[],i._handlers_[n].push(t);return i},te.prototype.off=function(e,t){var n=this;return n._handlers_=n._handlers_||{},void 0===e?n._handlers_={}:void 0===t?n._handlers_[e]=null:n._handlers_[e]&&n._handlers_[e].indexOf(t)>=0&&n._handlers_[e].splice(n._handlers_[e].indexOf(t),1),n},te.prototype.trigger=function(e,t){var n,i=this,r=e.split(/[ ,]+/g);i._handlers_=i._handlers_||{};for(var s=0;s<r.length;s+=1)n=r[s],i._handlers_[n]&&i._handlers_[n].length&&i._handlers_[n].forEach((function(e){e.call(i,{type:n,target:i},t)}))},te.prototype.config=function(e){var t=this;t.options=t.defaults||{},e&&(t.options=((e,t)=>{const n={};for(let i in e)e.hasOwnProperty(i)&&t.hasOwnProperty(i)?n[i]=t[i]:e.hasOwnProperty(i)&&(n[i]=e[i]);return n})(t.options,e))},te.prototype.bindEvt=function(e,t){var n=this;return n._domHandlers_=n._domHandlers_||{},n._domHandlers_[t]=function(){"function"==typeof n["on"+t]?n["on"+t].apply(n,arguments):console.warn('[WARNING] : Missing "on'+t+'" handler.')},z(e,Y[t],n._domHandlers_[t]),ee[t]&&z(e,ee[t],n._domHandlers_[t]),n},te.prototype.unbindEvt=function(e,t){var n=this;return n._domHandlers_=n._domHandlers_||{},V(e,Y[t],n._domHandlers_[t]),ee[t]&&V(e,ee[t],n._domHandlers_[t]),delete n._domHandlers_[t],this},ne.prototype=new te,ne.constructor=ne,ne.id=0,ne.prototype.buildEl=function(e){return this.ui={},this.options.dataOnly||(this.ui.el=document.createElement("div"),this.ui.back=document.createElement("div"),this.ui.front=document.createElement("div"),this.ui.el.className="nipple collection_"+this.collection.id,this.ui.back.className="back",this.ui.front.className="front",this.ui.el.setAttribute("id","nipple_"+this.collection.id+"_"+this.id),this.ui.el.appendChild(this.ui.back),this.ui.el.appendChild(this.ui.front)),this},ne.prototype.stylize=function(){if(this.options.dataOnly)return this;var e=this.options.fadeTime+"ms",t=((e,t)=>{const n=q(e);for(let e in n)n.hasOwnProperty(e)&&(n[e]=t);return n})("borderRadius","50%"),n=W("transition","opacity",e),i={};return i.el={position:"absolute",opacity:this.options.restOpacity,display:"block",zIndex:999},i.back={position:"absolute",display:"block",width:this.options.size+"px",height:this.options.size+"px",left:0,marginLeft:-this.options.size/2+"px",marginTop:-this.options.size/2+"px",background:this.options.color,opacity:".5"},i.front={width:this.options.size/2+"px",height:this.options.size/2+"px",position:"absolute",display:"block",left:0,marginLeft:-this.options.size/4+"px",marginTop:-this.options.size/4+"px",background:this.options.color,opacity:".5",transform:"translate(0px, 0px)"},X(i.el,n),"circle"===this.options.shape&&X(i.back,t),X(i.front,t),this.applyStyles(i),this},ne.prototype.applyStyles=function(e){for(var t in this.ui)if(this.ui.hasOwnProperty(t))for(var n in e[t])this.ui[t].style[n]=e[t][n];return this},ne.prototype.addToDom=function(){return this.options.dataOnly||document.body.contains(this.ui.el)||this.options.zone.appendChild(this.ui.el),this},ne.prototype.removeFromDom=function(){return this.options.dataOnly||!document.body.contains(this.ui.el)||this.options.zone.removeChild(this.ui.el),this},ne.prototype.destroy=function(){clearTimeout(this.removeTimeout),clearTimeout(this.showTimeout),clearTimeout(this.restTimeout),this.trigger("destroyed",this.instance),this.removeFromDom(),this.off()},ne.prototype.show=function(e){var t=this;return t.options.dataOnly||(clearTimeout(t.removeTimeout),clearTimeout(t.showTimeout),clearTimeout(t.restTimeout),t.addToDom(),t.restCallback(),setTimeout((function(){t.ui.el.style.opacity=1}),0),t.showTimeout=setTimeout((function(){t.trigger("shown",t.instance),"function"==typeof e&&e.call(this)}),t.options.fadeTime)),t},ne.prototype.hide=function(e){var t=this;if(t.options.dataOnly)return t;if(t.ui.el.style.opacity=t.options.restOpacity,clearTimeout(t.removeTimeout),clearTimeout(t.showTimeout),clearTimeout(t.restTimeout),t.removeTimeout=setTimeout((function(){var n="dynamic"===t.options.mode?"none":"block";t.ui.el.style.display=n,"function"==typeof e&&e.call(t),t.trigger("hidden",t.instance)}),t.options.fadeTime),t.options.restJoystick){const n=t.options.restJoystick,i={};i.x=!0===n||!1!==n.x?0:t.instance.frontPosition.x,i.y=!0===n||!1!==n.y?0:t.instance.frontPosition.y,t.setPosition(e,i)}return t},ne.prototype.setPosition=function(e,t){var n=this;n.frontPosition={x:t.x,y:t.y};var i=n.options.fadeTime+"ms",r={};r.front=W("transition",["transform"],i);var s={front:{}};s.front={transform:"translate("+n.frontPosition.x+"px,"+n.frontPosition.y+"px)"},n.applyStyles(r),n.applyStyles(s),n.restTimeout=setTimeout((function(){"function"==typeof e&&e.call(n),n.restCallback()}),n.options.fadeTime)},ne.prototype.restCallback=function(){var e=this,t={};t.front=W("transition","none",""),e.applyStyles(t),e.trigger("rested",e.instance)},ne.prototype.resetDirection=function(){this.direction={x:!1,y:!1,angle:!1}},ne.prototype.computeDirection=function(e){var t,n,i,r=e.angle.radian,s=Math.PI/4,o=Math.PI/2;if(r>s&&r<3*s&&!e.lockX?t="up":r>-s&&r<=s&&!e.lockY?t="left":r>3*-s&&r<=-s&&!e.lockX?t="down":e.lockY||(t="right"),e.lockY||(n=r>-o&&r<o?"left":"right"),e.lockX||(i=r>0?"up":"down"),e.force>this.options.threshold){var a,l={};for(a in this.direction)this.direction.hasOwnProperty(a)&&(l[a]=this.direction[a]);var c={};for(a in this.direction={x:n,y:i,angle:t},e.direction=this.direction,l)l[a]===this.direction[a]&&(c[a]=!0);if(c.x&&c.y&&c.angle)return e;c.x&&c.y||this.trigger("plain",e),c.x||this.trigger("plain:"+n,e),c.y||this.trigger("plain:"+i,e),c.angle||this.trigger("dir dir:"+t,e)}else this.resetDirection();return e},ie.prototype=new te,ie.constructor=ie,ie.id=0,ie.prototype.prepareNipples=function(){var e=this,t=e.nipples;t.on=e.on.bind(e),t.off=e.off.bind(e),t.options=e.options,t.destroy=e.destroy.bind(e),t.ids=e.ids,t.id=e.id,t.processOnMove=e.processOnMove.bind(e),t.processOnEnd=e.processOnEnd.bind(e),t.get=function(e){if(void 0===e)return t[0];for(var n=0,i=t.length;n<i;n+=1)if(t[n].identifier===e)return t[n];return!1}},ie.prototype.bindings=function(){var e=this;e.bindEvt(e.options.zone,"start"),e.options.zone.style.touchAction="none",e.options.zone.style.msTouchAction="none"},ie.prototype.begin=function(){var e=this,t=e.options;if("static"===t.mode){var n=e.createNipple(t.position,e.manager.getIdentifier());n.add(),e.idles.push(n)}},ie.prototype.createNipple=function(e,t){var n=this,i=n.manager.scroll,r={},s=n.options,o=n.parentIsFlex?i.x:i.x+n.box.left,a=n.parentIsFlex?i.y:i.y+n.box.top;if(e.x&&e.y)r={x:e.x-o,y:e.y-a};else if(e.top||e.right||e.bottom||e.left){var l=document.createElement("DIV");l.style.display="hidden",l.style.top=e.top,l.style.right=e.right,l.style.bottom=e.bottom,l.style.left=e.left,l.style.position="absolute",s.zone.appendChild(l);var c=l.getBoundingClientRect();s.zone.removeChild(l),r=e,e={x:c.left+i.x,y:c.top+i.y}}var u=new ne(n,{color:s.color,size:s.size,threshold:s.threshold,fadeTime:s.fadeTime,dataOnly:s.dataOnly,restJoystick:s.restJoystick,restOpacity:s.restOpacity,mode:s.mode,identifier:t,position:e,zone:s.zone,frontPosition:{x:0,y:0},shape:s.shape});return s.dataOnly||(H(u.ui.el,r),H(u.ui.front,u.frontPosition)),n.nipples.push(u),n.trigger("added "+u.identifier+":added",u),n.manager.trigger("added "+u.identifier+":added",u),n.bindNipple(u),u},ie.prototype.updateBox=function(){this.box=this.options.zone.getBoundingClientRect()},ie.prototype.bindNipple=function(e){var t,n=this,i=function(e,i){t=e.type+" "+i.id+":"+e.type,n.trigger(t,i)};e.on("destroyed",n.onDestroyed.bind(n)),e.on("shown hidden rested dir plain",i),e.on("dir:up dir:right dir:down dir:left",i),e.on("plain:up plain:right plain:down plain:left",i)},ie.prototype.pressureFn=function(e,t,n){var i=this,r=0;clearInterval(i.pressureIntervals[n]),i.pressureIntervals[n]=setInterval(function(){var n=e.force||e.pressure||e.webkitForce||0;n!==r&&(t.trigger("pressure",n),i.trigger("pressure "+t.identifier+":pressure",n),r=n)}.bind(i),100)},ie.prototype.onstart=function(e){var t=this,n=t.options,i=e;e=G(e),t.updateBox();return $(e,(function(r){t.actives.length<n.maxNumberOfNipples?t.processOnStart(r):i.type.match(/^touch/)&&(Object.keys(t.manager.ids).forEach((function(n){if(Object.values(i.touches).findIndex((function(e){return e.identifier===n}))<0){var r=[e[0]];r.identifier=n,t.processOnEnd(r)}})),t.actives.length<n.maxNumberOfNipples&&t.processOnStart(r))})),t.manager.bindDocument(),!1},ie.prototype.processOnStart=function(e){var t,n=this,i=n.options,r=n.manager.getIdentifier(e),s=e.force||e.pressure||e.webkitForce||0,o={x:e.pageX,y:e.pageY},a=n.getOrCreate(r,o);a.identifier!==r&&n.manager.removeIdentifier(a.identifier),a.identifier=r;var l=function(t){t.trigger("start",t),n.trigger("start "+t.id+":start",t),t.show(),s>0&&n.pressureFn(e,t,t.identifier),n.processOnMove(e)};if((t=n.idles.indexOf(a))>=0&&n.idles.splice(t,1),n.actives.push(a),n.ids.push(a.identifier),"semi"!==i.mode)l(a);else{if(!(k(o,a.position)<=i.catchDistance))return a.destroy(),void n.processOnStart(e);l(a)}return a},ie.prototype.getOrCreate=function(e,t){var n,i=this,r=i.options;return/(semi|static)/.test(r.mode)?(n=i.idles[0])?(i.idles.splice(0,1),n):"semi"===r.mode?i.createNipple(t,e):(console.warn("Coudln't find the needed nipple."),!1):n=i.createNipple(t,e)},ie.prototype.processOnMove=function(e){var t=this,n=t.options,i=t.manager.getIdentifier(e),r=t.nipples.get(i),s=t.manager.scroll;if((e=>isNaN(e.buttons)?0!==e.pressure:0!==e.buttons)(e)){if(!r)return console.error("Found zombie joystick with ID "+i),void t.manager.removeIdentifier(i);if(n.dynamicPage){var o=r.el.getBoundingClientRect();r.position={x:s.x+o.left,y:s.y+o.top}}r.identifier=i;var a=r.options.size/2,l={x:e.pageX,y:e.pageY};n.lockX&&(l.y=r.position.y),n.lockY&&(l.x=r.position.x);var c,u,h=k(l,r.position),d=((e,t)=>{const n=t.x-e.x,i=t.y-e.y;return U(Math.atan2(i,n))})(l,r.position),p=O(d),f=h/a,m={distance:h,position:l};if("circle"===r.options.shape?(c=Math.min(h,a),u=((e,t,n)=>{const i={x:0,y:0};return n=O(n),i.x=e.x-t*Math.cos(n),i.y=e.y-t*Math.sin(n),i})(r.position,c,d)):(u=((e,t,n)=>({x:Math.min(Math.max(e.x,t.x-n),t.x+n),y:Math.min(Math.max(e.y,t.y-n),t.y+n)}))(l,r.position,a),c=k(u,r.position)),n.follow){if(h>a){let e=l.x-u.x,n=l.y-u.y;r.position.x+=e,r.position.y+=n,r.el.style.top=r.position.y-(t.box.top+s.y)+"px",r.el.style.left=r.position.x-(t.box.left+s.x)+"px",h=k(l,r.position)}}else l=u,h=c;var g=l.x-r.position.x,y=l.y-r.position.y;r.frontPosition={x:g,y:y},n.dataOnly||(r.ui.front.style.transform="translate("+g+"px,"+y+"px)");var v={identifier:r.identifier,position:l,force:f,pressure:e.force||e.pressure||e.webkitForce||0,distance:h,angle:{radian:p,degree:d},vector:{x:g/a,y:-y/a},raw:m,instance:r,lockX:n.lockX,lockY:n.lockY};(v=r.computeDirection(v)).angle={radian:O(180-d),degree:180-d},r.trigger("move",v),t.trigger("move "+r.id+":move",v)}else this.processOnEnd(e)},ie.prototype.processOnEnd=function(e){var t=this,n=t.options,i=t.manager.getIdentifier(e),r=t.nipples.get(i),s=t.manager.removeIdentifier(r.identifier);r&&(n.dataOnly||r.hide((function(){"dynamic"===n.mode&&(r.trigger("removed",r),t.trigger("removed "+r.id+":removed",r),t.manager.trigger("removed "+r.id+":removed",r),r.destroy())})),clearInterval(t.pressureIntervals[r.identifier]),r.resetDirection(),r.trigger("end",r),t.trigger("end "+r.id+":end",r),t.ids.indexOf(r.identifier)>=0&&t.ids.splice(t.ids.indexOf(r.identifier),1),t.actives.indexOf(r)>=0&&t.actives.splice(t.actives.indexOf(r),1),/(semi|static)/.test(n.mode)?t.idles.push(r):t.nipples.indexOf(r)>=0&&t.nipples.splice(t.nipples.indexOf(r),1),t.manager.unbindDocument(),/(semi|static)/.test(n.mode)&&(t.manager.ids[s.id]=s.identifier))},ie.prototype.onDestroyed=function(e,t){var n=this;n.nipples.indexOf(t)>=0&&n.nipples.splice(n.nipples.indexOf(t),1),n.actives.indexOf(t)>=0&&n.actives.splice(n.actives.indexOf(t),1),n.idles.indexOf(t)>=0&&n.idles.splice(n.idles.indexOf(t),1),n.ids.indexOf(t.identifier)>=0&&n.ids.splice(n.ids.indexOf(t.identifier),1),n.manager.removeIdentifier(t.identifier),n.manager.unbindDocument()},ie.prototype.destroy=function(){var e=this;for(var t in e.unbindEvt(e.options.zone,"start"),e.nipples.forEach((function(e){e.destroy()})),e.pressureIntervals)e.pressureIntervals.hasOwnProperty(t)&&clearInterval(e.pressureIntervals[t]);e.trigger("destroyed",e.nipples),e.manager.unbindDocument(),e.off()},re.prototype=new te,re.constructor=re,re.prototype.prepareCollections=function(){var e=this;e.collections.create=e.create.bind(e),e.collections.on=e.on.bind(e),e.collections.off=e.off.bind(e),e.collections.destroy=e.destroy.bind(e),e.collections.get=function(t){var n;return e.collections.every((function(e){return!(n=e.get(t))})),n}},re.prototype.create=function(e){return this.createCollection(e)},re.prototype.createCollection=function(e){var t=this,n=new ie(t,e);return t.bindCollection(n),t.collections.push(n),n},re.prototype.bindCollection=function(e){var t,n=this,i=function(e,i){t=e.type+" "+i.id+":"+e.type,n.trigger(t,i)};e.on("destroyed",n.onDestroyed.bind(n)),e.on("shown hidden rested dir plain",i),e.on("dir:up dir:right dir:down dir:left",i),e.on("plain:up plain:right plain:down plain:left",i)},re.prototype.bindDocument=function(){var e=this;e.binded||(e.bindEvt(document,"move").bindEvt(document,"end"),e.binded=!0)},re.prototype.unbindDocument=function(e){var t=this;Object.keys(t.ids).length&&!0!==e||(t.unbindEvt(document,"move").unbindEvt(document,"end"),t.binded=!1)},re.prototype.getIdentifier=function(e){var t;return e?void 0===(t=void 0===e.identifier?e.pointerId:e.identifier)&&(t=this.latest||0):t=this.index,void 0===this.ids[t]&&(this.ids[t]=this.index,this.index+=1),this.latest=t,this.ids[t]},re.prototype.removeIdentifier=function(e){var t={};for(var n in this.ids)if(this.ids[n]===e){t.id=n,t.identifier=this.ids[n],delete this.ids[n];break}return t},re.prototype.onmove=function(e){return this.onAny("move",e),!1},re.prototype.onend=function(e){return this.onAny("end",e),!1},re.prototype.oncancel=function(e){return this.onAny("end",e),!1},re.prototype.onAny=function(e,t){var n,i=this,r="processOn"+e.charAt(0).toUpperCase()+e.slice(1);t=G(t);var s=function(e,t,n){n.ids.indexOf(t)>=0&&(n[r](e),e._found_=!0)};return $(t,(function(e){n=i.getIdentifier(e),$(i.collections,s.bind(null,e,n)),e._found_||i.removeIdentifier(n)})),!1},re.prototype.destroy=function(){var e=this;e.unbindDocument(!0),e.ids={},e.index=0,e.collections.forEach((function(e){e.destroy()})),e.off()},re.prototype.onDestroyed=function(e,t){var n=this;if(n.collections.indexOf(t)<0)return!1;n.collections.splice(n.collections.indexOf(t),1)};const se=new re;var oe,ae=function(e){return se.create(e)};function le(){return oe||(oe=1,g||(g=1,AFRAME.registerComponent("checkpoint-controls",{schema:{enabled:{default:!0},mode:{default:"teleport",oneOf:["teleport","animate"]},animateSpeed:{default:3}},init:function(){this.active=!0,this.checkpoint=null,this.isNavMeshConstrained=!1,this.offset=new THREE.Vector3,this.position=new THREE.Vector3,this.targetPosition=new THREE.Vector3},play:function(){this.active=!0},pause:function(){this.active=!1},setCheckpoint:function(e){const t=this.el;this.active&&this.checkpoint!==e&&(this.checkpoint&&t.emit("navigation-end",{checkpoint:this.checkpoint}),this.checkpoint=e,this.sync(),this.position.distanceTo(this.targetPosition)<.1?this.checkpoint=null:(t.emit("navigation-start",{checkpoint:e}),"teleport"===this.data.mode&&(this.el.setAttribute("position",this.targetPosition),this.checkpoint=null,t.emit("navigation-end",{checkpoint:e}),t.components["movement-controls"].updateNavLocation())))},isVelocityActive:function(){return!(!this.active||!this.checkpoint)},getVelocity:function(){if(!this.active)return;const e=this.data,t=this.offset,n=this.position,i=this.targetPosition,r=this.checkpoint;return this.sync(),n.distanceTo(i)<.1?(this.checkpoint=null,this.el.emit("navigation-end",{checkpoint:r}),t.set(0,0,0)):(t.setLength(e.animateSpeed),t)},sync:function(){const e=this.offset,t=this.position,n=this.targetPosition;t.copy(this.el.getAttribute("position")),this.checkpoint.object3D.getWorldPosition(n),n.add(this.checkpoint.components.checkpoint.getOffset()),e.copy(n).sub(t)}})),M(),function(){if(C)return A;C=1,I();const e=window.KeyboardEvent;A=AFRAME.registerComponent("keyboard-controls",{schema:{enabled:{default:!0},debug:{default:!1}},init:function(){this.dVelocity=new THREE.Vector3,this.localKeys={},this.listeners={keydown:this.onKeyDown.bind(this),keyup:this.onKeyUp.bind(this),blur:this.onBlur.bind(this),onContextMenu:this.onContextMenu.bind(this)}},isVelocityActive:function(){return this.data.enabled&&!!Object.keys(this.getKeys()).length},getVelocityDelta:function(){const e=this.data,t=this.getKeys();return this.dVelocity.set(0,0,0),e.enabled&&((t.KeyW||t.ArrowUp)&&(this.dVelocity.z-=1),(t.KeyA||t.ArrowLeft)&&(this.dVelocity.x-=1),(t.KeyS||t.ArrowDown)&&(this.dVelocity.z+=1),(t.KeyD||t.ArrowRight)&&(this.dVelocity.x+=1),t.ShiftLeft&&(this.dVelocity=this.dVelocity.multiplyScalar(2))),this.dVelocity.clone()},play:function(){this.attachEventListeners()},pause:function(){this.removeEventListeners()},attachEventListeners:function(){window.addEventListener("contextmenu",this.listeners.onContextMenu,!1),window.addEventListener("keydown",this.listeners.keydown,!1),window.addEventListener("keyup",this.listeners.keyup,!1),window.addEventListener("blur",this.listeners.blur,!1)},onContextMenu:function(){for(const e in this.localKeys)this.localKeys.hasOwnProperty(e)&&delete this.localKeys[e]},removeEventListeners:function(){window.removeEventListener("keydown",this.listeners.keydown),window.removeEventListener("keyup",this.listeners.keyup),window.removeEventListener("blur",this.listeners.blur)},onKeyDown:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(this.localKeys[e.code]=!0,this.emit(e))},onKeyUp:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(delete this.localKeys[e.code],this.emit(e))},onBlur:function(){for(const e in this.localKeys)this.localKeys.hasOwnProperty(e)&&delete this.localKeys[e]},emit:function(t){"__keyboard-controls-proxy"in t&&this.el.emit(t.type,t),this.el.emit(t.type+":"+t.code,new e(t.type,t)),this.data.debug&&console.log(t.type+":"+t.code)},isPressed:function(e){return e in this.getKeys()},getKeys:function(){return this.isProxied()?this.el.sceneEl.components["proxy-controls"].getKeyboard():this.localKeys},isProxied:function(){const e=this.el.sceneEl.components["proxy-controls"];return e&&e.isConnected()}})}(),R||(R=1,AFRAME.registerComponent("touch-controls",{schema:{enabled:{default:!0},reverseEnabled:{default:!0}},init:function(){this.dVelocity=new THREE.Vector3,this.bindMethods(),this.direction=0},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){const e=this.el.sceneEl,t=e.canvas;if(!t)return void e.addEventListener("render-target-loaded",this.addEventListeners.bind(this));t.addEventListener("touchstart",this.onTouchStart,{passive:!0}),t.addEventListener("touchend",this.onTouchEnd,{passive:!0});const n=e.getAttribute("vr-mode-ui");n&&n.cardboardModeEnabled&&e.addEventListener("enter-vr",this.onEnterVR)},removeEventListeners:function(){const e=this.el.sceneEl&&this.el.sceneEl.canvas;e&&(e.removeEventListener("touchstart",this.onTouchStart),e.removeEventListener("touchend",this.onTouchEnd),this.el.sceneEl.removeEventListener("enter-vr",this.onEnterVR))},isVelocityActive:function(){return this.data.enabled&&!!this.direction},getVelocityDelta:function(){return this.dVelocity.z=this.direction,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onEnterVR=this.onEnterVR.bind(this)},onTouchStart:function(e){this.direction=-1,this.data.reverseEnabled&&e.touches&&2===e.touches.length&&(this.direction=1),e.preventDefault()},onTouchEnd:function(e){this.direction=0,e.preventDefault()},onEnterVR:function(){const e=this.el.sceneEl.xrSession;e&&(e.addEventListener("selectstart",this.onTouchStart),e.addEventListener("selectend",this.onTouchEnd))}})),function(){if(P)return N;P=1;const e="-controls";N=AFRAME.registerComponent("movement-controls",{dependencies:["rotation"],schema:{enabled:{default:!0},controls:{default:["gamepad","trackpad","keyboard","touch"]},speed:{default:.3,min:0},fly:{default:!1},constrainToNavMesh:{default:!1},camera:{default:"[movement-controls] [camera]",type:"selector"}},init:function(){const e=this.el;this.data.camera||(this.data.camera=e.querySelector("[camera]")),this.velocityCtrl=null,this.velocity=new THREE.Vector3,this.heading=new THREE.Quaternion,this.eventDetail={},this.navGroup=null,this.navNode=null,e.sceneEl.hasLoaded?this.injectControls():e.sceneEl.addEventListener("loaded",this.injectControls.bind(this))},update:function(t){const n=this.el,i=this.data,r=n.sceneEl.systems.nav;if(n.sceneEl.hasLoaded&&this.injectControls(),r&&i.constrainToNavMesh!==t.constrainToNavMesh&&(i.constrainToNavMesh?r.addAgent(this):r.removeAgent(this)),i.enabled!==t.enabled)for(let t=0;t<i.controls.length;t++){const n=i.controls[t]+e;this.el.setAttribute(n,{enabled:this.data.enabled})}},injectControls:function(){const t=this.data;for(let n=0;n<t.controls.length;n++){const i=t.controls[n]+e;this.el.setAttribute(i,{enabled:this.data.enabled})}},updateNavLocation:function(){this.navGroup=null,this.navNode=null},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,n=new THREE.Vector3;return function(i,r){if(!r)return;const s=this.el,o=this.data;if(!o.enabled)return;this.updateVelocityCtrl();const a=this.velocityCtrl,l=this.velocity;if(a)if(r/1e3>.2?l.set(0,0,0):this.updateVelocity(r),o.constrainToNavMesh&&!1!==a.isNavMeshConstrained){if(l.lengthSq()<1e-5)return;e.copy(s.object3D.position),t.copy(l).multiplyScalar(r/1e3).add(e);const i=s.sceneEl.systems.nav;this.navGroup=null===this.navGroup?i.getGroup(e):this.navGroup,this.navNode=this.navNode||i.getNode(e,this.navGroup),this.navNode=i.clampStep(e,t,this.navGroup,this.navNode,n),s.object3D.position.copy(n)}else s.hasAttribute("velocity")?s.setAttribute("velocity",l):(s.object3D.position.x+=l.x*r/1e3,s.object3D.position.y+=l.y*r/1e3,s.object3D.position.z+=l.z*r/1e3)}}(),updateVelocityCtrl:function(){const t=this.data;if(t.enabled){for(let n=0,i=t.controls.length;n<i;n++){const i=this.el.components[t.controls[n]+e];if(i&&i.isVelocityActive())return void(this.velocityCtrl=i)}this.velocityCtrl=null}},updateVelocity:function(){const e=new THREE.Vector2,t=new THREE.Quaternion;return function(n){let i;const r=this.el,s=this.velocityCtrl,o=this.velocity,a=this.data;if(s){if(!s.getVelocityDelta){if(s.getVelocity)return void o.copy(s.getVelocity());if(s.getPositionDelta)return void o.copy(s.getPositionDelta(n).multiplyScalar(1e3/n));throw new Error("Incompatible movement controls: ",s)}i=s.getVelocityDelta(n)}if(r.hasAttribute("velocity")&&!a.constrainToNavMesh&&o.copy(this.el.getAttribute("velocity")),i&&a.enabled){const n=a.camera;t.copy(n.object3D.quaternion),t.premultiply(r.object3D.quaternion),i.applyQuaternion(t);const s=i.length();a.fly?(o.copy(i),o.multiplyScalar(16.66667*this.data.speed)):(e.set(i.x,i.z),e.setLength(s*this.data.speed*16.66667),o.x=e.x,o.y=0,o.z=e.y),0===o.x&&0===o.y&&0===o.z||(this.eventDetail.velocity=o,this.el.emit("moved",this.eventDetail))}}}()})}(),D||(D=1,AFRAME.registerComponent("trackpad-controls",{schema:{enabled:{default:!0},enableNegX:{default:!0},enablePosX:{default:!0},enableNegZ:{default:!0},enablePosZ:{default:!0},mode:{default:"touch",oneOf:["swipe","touch","press"]}},init:function(){this.dVelocity=new THREE.Vector3,this.zVel=0,this.xVel=0,this.bindMethods()},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){const e=this.data,t=this.el.sceneEl;switch(t.addEventListener("axismove",this.onAxisMove),e.mode){case"swipe":case"touch":t.addEventListener("trackpadtouchstart",this.onTouchStart),t.addEventListener("trackpadtouchend",this.onTouchEnd);break;case"press":t.addEventListener("trackpaddown",this.onTouchStart),t.addEventListener("trackpadup",this.onTouchEnd)}},removeEventListeners:function(){const e=this.el.sceneEl;e.removeEventListener("axismove",this.onAxisMove),e.removeEventListener("trackpadtouchstart",this.onTouchStart),e.removeEventListener("trackpadtouchend",this.onTouchEnd),e.removeEventListener("trackpaddown",this.onTouchStart),e.removeEventListener("trackpadup",this.onTouchEnd)},isVelocityActive:function(){return this.data.enabled&&this.isMoving},getVelocityDelta:function(){return this.dVelocity.z=this.isMoving?-this.zVel:1,this.dVelocity.x=this.isMoving?this.xVel:1,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onAxisMove=this.onAxisMove.bind(this)},onTouchStart:function(e){switch(this.data.mode){case"swipe":this.canRecordAxis=!0,this.startingAxisData=[];break;case"touch":case"press":this.isMoving=!0}e.preventDefault()},onTouchEnd:function(e){"swipe"==this.data.mode&&(this.startingAxisData=[]),this.isMoving=!1,e.preventDefault()},onAxisMove:function(e){switch(this.data.mode){case"swipe":return this.handleSwipeAxis(e);case"touch":case"press":return this.handleTouchAxis(e)}},handleSwipeAxis:function(e){const t=this.data,n=e.detail.axis;if(0===this.startingAxisData.length&&this.canRecordAxis&&(this.canRecordAxis=!1,this.startingAxisData[0]=n[0],this.startingAxisData[1]=n[1]),this.startingAxisData.length>0){let e=0,i=0;t.enableNegX&&n[0]<this.startingAxisData[0]&&(e=-1),t.enablePosX&&n[0]>this.startingAxisData[0]&&(e=1),t.enablePosZ&&n[1]>this.startingAxisData[1]&&(i=-1),t.enableNegZ&&n[1]<this.startingAxisData[1]&&(i=1);const r=Math.abs(this.startingAxisData[1]-n[1]);Math.abs(this.startingAxisData[0]-n[0])>r?(this.zVel=0,this.xVel=e,this.isMoving=!0):(this.xVel=0,this.zVel=i,this.isMoving=!0)}},handleTouchAxis:function(e){const t=this.data,n=e.detail.axis;let i=0,r=0;t.enableNegX&&n[0]<0&&(i=-1),t.enablePosX&&n[0]>0&&(i=1),t.enablePosZ&&n[1]>0&&(r=-1),t.enableNegZ&&n[1]<0&&(r=1),Math.abs(n[0])>Math.abs(n[1])?(this.zVel=0,this.xVel=i):(this.xVel=0,this.zVel=r)}}))),T}AFRAME.registerComponent("nipple-controls",{schema:{enabled:{default:!0},mode:{default:"dynamic",oneOf:["static","semi","dynamic"]},rotationSensitivity:{default:1},moveJoystickEnabled:{default:!0},lookJoystickEnabled:{default:!0},sideMargin:{default:"30px"},bottomMargin:{default:"70px"},moveJoystickPosition:{default:"left",oneOf:["left","right"]},lookJoystickPosition:{default:"right",oneOf:["left","right"]}},init(){this.dVelocity=new THREE.Vector3,this.lookVector=new THREE.Vector2;const e=this.el.querySelector("[look-controls]").components["look-controls"];this.pitchObject=e.pitchObject,this.yawObject=e.yawObject,this.rigRotation=this.el.object3D.rotation,this.moveData=void 0,this.lookData=void 0,this.moving=!1,this.rotating=!1},update(e){this.data.moveJoystickPosition===e.moveJoystickPosition&&this.data.sideMargin===e.sideMargin&&this.data.bottomMargin===e.bottomMargin&&this.data.mode===e.mode||this.removeMoveJoystick(),this.data.lookJoystickPosition===e.lookJoystickPosition&&this.data.sideMargin===e.sideMargin&&this.data.bottomMargin===e.bottomMargin&&this.data.mode===e.mode||this.removeLookJoystick(),this.data.enabled&&this.data.moveJoystickEnabled?this.createMoveJoystick():this.removeMoveJoystick(),this.data.enabled&&this.data.lookJoystickEnabled?this.createLookJoystick():this.removeLookJoystick()},pause(){this.moving=!1,this.rotating=!1},remove(){this.removeMoveJoystick(),this.removeLookJoystick()},isVelocityActive(){return this.data.enabled&&this.moving},getVelocityDelta(){if(this.dVelocity.set(0,0,0),this.isVelocityActive()){const e=this.moveData.force<1?this.moveData.force:1,t=this.moveData.angle.radian,n=Math.cos(t)*e,i=-Math.sin(t)*e;this.dVelocity.set(n,0,i)}return this.dVelocity},isRotationActive(){return this.data.enabled&&this.rotating},updateRotation(e){if(!this.isRotationActive())return;const t=this.lookData.force<1?this.lookData.force:1,n=this.lookData.angle.radian,i=this.lookVector;i.x=Math.cos(n)*t,i.y=Math.sin(n)*t,i.multiplyScalar(this.data.rotationSensitivity*e/1e3),this.yawObject.rotation.y-=i.x;let r=this.pitchObject.rotation.x+i.y;r=Math.max(-Math.PI/2,Math.min(Math.PI/2,r)),this.pitchObject.rotation.x=r},tick:function(e,t){this.updateRotation(t)},initLeftZone(){const e=document.createElement("div");e.setAttribute("id","joystickLeftZone"),e.setAttribute("style",`position:absolute;${this.data.moveJoystickPosition}:${this.data.sideMargin};bottom:${this.data.bottomMargin};z-index:1`),document.body.appendChild(e),this.leftZone=e},initRightZone(){const e=document.createElement("div");e.setAttribute("id","joystickRightZone"),e.setAttribute("style",`position:absolute;${this.data.lookJoystickPosition}:${this.data.sideMargin};bottom:${this.data.bottomMargin};z-index:1`),document.body.appendChild(e),this.rightZone=e},createMoveJoystick(){if(this.moveJoystick)return;this.initLeftZone();const e={mode:this.data.mode,zone:this.leftZone,color:"white",fadeTime:0};this.leftZone.style.width="100px","static"===this.data.mode?(this.leftZone.style.height="100px",e.position={left:"50%",bottom:"50%"}):this.leftZone.style.height="400px",this.moveJoystick=ae(e),this.moveJoystick.on("move",((e,t)=>{this.moveData=t,this.moving=!0})),this.moveJoystick.on("end",((e,t)=>{this.moving=!1}))},createLookJoystick(){if(this.lookJoystick)return;this.initRightZone();const e={mode:this.data.mode,zone:this.rightZone,color:"white",fadeTime:0};this.rightZone.style.width="100px","static"===this.data.mode?(this.rightZone.style.height="100px",e.position={left:"50%",bottom:"50%"}):this.rightZone.style.height="400px",this.lookJoystick=ae(e),this.lookJoystick.on("move",((e,t)=>{this.lookData=t,this.rotating=!0})),this.lookJoystick.on("end",((e,t)=>{this.rotating=!1}))},removeMoveJoystick(){this.moveJoystick&&(this.moveJoystick.destroy(),this.moveJoystick=void 0),this.moveData=void 0,this.leftZone&&this.leftZone.parentNode&&(this.leftZone.remove(),this.leftZone=void 0)},removeLookJoystick(){this.lookJoystick&&(this.lookJoystick.destroy(),this.lookJoystick=void 0),this.lookData=void 0,this.rightZone&&this.rightZone.parentNode&&(this.rightZone.remove(),this.rightZone=void 0)}});var ce,ue,he={};function de(){if(ue)return ce;ue=1;const e={once:THREE.LoopOnce,repeat:THREE.LoopRepeat,pingpong:THREE.LoopPingPong};function t(e){return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&")}return ce=AFRAME.registerComponent("animation-mixer",{schema:{clip:{default:"*"},useRegExp:{default:!1},duration:{default:0},clampWhenFinished:{default:!1,type:"boolean"},crossFadeDuration:{default:0},loop:{default:"repeat",oneOf:Object.keys(e)},repetitions:{default:1/0,min:0},timeScale:{default:1},startAt:{default:0}},init:function(){this.model=null,this.mixer=null,this.activeActions=[];const e=this.el.getObject3D("mesh");e?this.load(e):this.el.addEventListener("model-loaded",(e=>{this.load(e.detail.model)}))},load:function(e){const t=this.el;this.model=e,this.mixer=new THREE.AnimationMixer(e),this.mixer.addEventListener("loop",(e=>{t.emit("animation-loop",{action:e.action,loopDelta:e.loopDelta})})),this.mixer.addEventListener("finished",(e=>{t.emit("animation-finished",{action:e.action,direction:e.direction})})),this.data.clip&&this.update({})},remove:function(){this.mixer&&this.mixer.stopAllAction()},update:function(t){if(!t)return;const n=this.data,i=AFRAME.utils.diff(n,t);if("clip"in i)return this.stopAction(),void(n.clip&&this.playAction());this.activeActions.forEach((t=>{"duration"in i&&n.duration&&t.setDuration(n.duration),"clampWhenFinished"in i&&(t.clampWhenFinished=n.clampWhenFinished),("loop"in i||"repetitions"in i)&&t.setLoop(e[n.loop],n.repetitions),"timeScale"in i&&t.setEffectiveTimeScale(n.timeScale)}))},stopAction:function(){const e=this.data;for(let t=0;t<this.activeActions.length;t++)e.crossFadeDuration?this.activeActions[t].fadeOut(e.crossFadeDuration):this.activeActions[t].stop();this.activeActions.length=0},playAction:function(){if(!this.mixer)return;const n=this.model,i=this.data,r=n.animations||(n.geometry||{}).animations||[];if(!r.length)return;const s=i.useRegExp?i.clip:function(e){return new RegExp("^"+e.split(/\*+/).map(t).join(".*")+"$")}(i.clip);for(let t,o=0;t=r[o];o++)if(t.name.match(s)){const r=this.mixer.clipAction(t,n);r.enabled=!0,r.clampWhenFinished=i.clampWhenFinished,i.duration&&r.setDuration(i.duration),1!==i.timeScale&&r.setEffectiveTimeScale(i.timeScale),r.startAt(this.mixer.time-i.startAt/1e3),r.setLoop(e[i.loop],i.repetitions).fadeIn(i.crossFadeDuration).play(),this.activeActions.push(r)}},tick:function(e,t){this.mixer&&!isNaN(t)&&this.mixer.update(t/1e3)}}),ce}const pe="attached",fe=1e3,me=1001,ge=1003,ye=1006,ve=1008,_e=1026,xe=2300,be=2301,we=2302,Te="srgb",Se="srgb-linear",Me="display-p3",Ee="display-p3-linear",Ae="linear",Ce="srgb",Re="rec709",Ne=7680,Pe=2e3,De=2001;let Le=class{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){if(void 0===this._listeners)return!1;const n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)}removeEventListener(e,t){if(void 0===this._listeners)return;const n=this._listeners[e];if(void 0!==n){const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}dispatchEvent(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const n=t.slice(0);for(let t=0,i=n.length;t<i;t++)n[t].call(this,e);e.target=null}}};const Ie=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let ke=1234567;const Oe=Math.PI/180,Ue=180/Math.PI;function Fe(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(Ie[255&e]+Ie[e>>8&255]+Ie[e>>16&255]+Ie[e>>24&255]+"-"+Ie[255&t]+Ie[t>>8&255]+"-"+Ie[t>>16&15|64]+Ie[t>>24&255]+"-"+Ie[63&n|128]+Ie[n>>8&255]+"-"+Ie[n>>16&255]+Ie[n>>24&255]+Ie[255&i]+Ie[i>>8&255]+Ie[i>>16&255]+Ie[i>>24&255]).toLowerCase()}function Be(e,t,n){return Math.max(t,Math.min(n,e))}function ze(e,t){return(e%t+t)%t}function Ve(e,t,n){return(1-n)*e+n*t}function Ge(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function je(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}const He={DEG2RAD:Oe,RAD2DEG:Ue,generateUUID:Fe,clamp:Be,euclideanModulo:ze,mapLinear:function(e,t,n,i,r){return i+(e-t)*(r-i)/(n-t)},inverseLerp:function(e,t,n){return e!==t?(n-e)/(t-e):0},lerp:Ve,damp:function(e,t,n,i){return Ve(e,t,1-Math.exp(-n*i))},pingpong:function(e,t=1){return t-Math.abs(ze(e,2*t)-t)},smoothstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*(3-2*e)},smootherstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){void 0!==e&&(ke=e);let t=ke+=1831565813;return t=Math.imul(t^t>>>15,1|t),t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296},degToRad:function(e){return e*Oe},radToDeg:function(e){return e*Ue},isPowerOfTwo:function(e){return!(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,n,i,r){const s=Math.cos,o=Math.sin,a=s(n/2),l=o(n/2),c=s((t+i)/2),u=o((t+i)/2),h=s((t-i)/2),d=o((t-i)/2),p=s((i-t)/2),f=o((i-t)/2);switch(r){case"XYX":e.set(a*u,l*h,l*d,a*c);break;case"YZY":e.set(l*d,a*u,l*h,a*c);break;case"ZXZ":e.set(l*h,l*d,a*u,a*c);break;case"XZX":e.set(a*u,l*f,l*p,a*c);break;case"YXY":e.set(l*p,a*u,l*f,a*c);break;case"ZYZ":e.set(l*f,l*p,a*u,a*c);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}},normalize:je,denormalize:Ge};let We=class e{constructor(t=0,n=0){e.prototype.isVector2=!0,this.x=t,this.y=n}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,n=this.y,i=e.elements;return this.x=i[0]*t+i[3]*n+i[6],this.y=i[1]*t+i[4]*n+i[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(Be(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const n=Math.cos(t),i=Math.sin(t),r=this.x-e.x,s=this.y-e.y;return this.x=r*n-s*i+e.x,this.y=r*i+s*n+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}},qe=class e{constructor(t,n,i,r,s,o,a,l,c){e.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,n,i,r,s,o,a,l,c)}set(e,t,n,i,r,s,o,a,l){const c=this.elements;return c[0]=e,c[1]=i,c[2]=o,c[3]=t,c[4]=r,c[5]=a,c[6]=n,c[7]=s,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],this}extractBasis(e,t,n){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),n.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,i=t.elements,r=this.elements,s=n[0],o=n[3],a=n[6],l=n[1],c=n[4],u=n[7],h=n[2],d=n[5],p=n[8],f=i[0],m=i[3],g=i[6],y=i[1],v=i[4],_=i[7],x=i[2],b=i[5],w=i[8];return r[0]=s*f+o*y+a*x,r[3]=s*m+o*v+a*b,r[6]=s*g+o*_+a*w,r[1]=l*f+c*y+u*x,r[4]=l*m+c*v+u*b,r[7]=l*g+c*_+u*w,r[2]=h*f+d*y+p*x,r[5]=h*m+d*v+p*b,r[8]=h*g+d*_+p*w,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],s=e[4],o=e[5],a=e[6],l=e[7],c=e[8];return t*s*c-t*o*l-n*r*c+n*o*a+i*r*l-i*s*a}invert(){const e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],s=e[4],o=e[5],a=e[6],l=e[7],c=e[8],u=c*s-o*l,h=o*a-c*r,d=l*r-s*a,p=t*u+n*h+i*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const f=1/p;return e[0]=u*f,e[1]=(i*l-c*n)*f,e[2]=(o*n-i*s)*f,e[3]=h*f,e[4]=(c*t-i*a)*f,e[5]=(i*r-o*t)*f,e[6]=d*f,e[7]=(n*a-l*t)*f,e[8]=(s*t-n*r)*f,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,n,i,r,s,o){const a=Math.cos(r),l=Math.sin(r);return this.set(n*a,n*l,-n*(a*s+l*o)+s+e,-i*l,i*a,-i*(-l*s+a*o)+o+t,0,0,1),this}scale(e,t){return this.premultiply(Xe.makeScale(e,t)),this}rotate(e){return this.premultiply(Xe.makeRotation(-e)),this}translate(e,t){return this.premultiply(Xe.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,n,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,n=e.elements;for(let e=0;e<9;e++)if(t[e]!==n[e])return!1;return!0}fromArray(e,t=0){for(let n=0;n<9;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e}clone(){return(new this.constructor).fromArray(this.elements)}};const Xe=new qe;function $e(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}const Ye={};const Ke=(new qe).set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),Ze=(new qe).set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),Je={[Se]:{transfer:Ae,primaries:Re,toReference:e=>e,fromReference:e=>e},[Te]:{transfer:Ce,primaries:Re,toReference:e=>e.convertSRGBToLinear(),fromReference:e=>e.convertLinearToSRGB()},[Ee]:{transfer:Ae,primaries:"p3",toReference:e=>e.applyMatrix3(Ze),fromReference:e=>e.applyMatrix3(Ke)},[Me]:{transfer:Ce,primaries:"p3",toReference:e=>e.convertSRGBToLinear().applyMatrix3(Ze),fromReference:e=>e.applyMatrix3(Ke).convertLinearToSRGB()}},Qe=new Set([Se,Ee]),et={enabled:!0,_workingColorSpace:Se,get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(e){if(!Qe.has(e))throw new Error(`Unsupported working color space, "${e}".`);this._workingColorSpace=e},convert:function(e,t,n){if(!1===this.enabled||t===n||!t||!n)return e;const i=Je[t].toReference;return(0,Je[n].fromReference)(i(e))},fromWorkingColorSpace:function(e,t){return this.convert(e,this._workingColorSpace,t)},toWorkingColorSpace:function(e,t){return this.convert(e,t,this._workingColorSpace)},getPrimaries:function(e){return Je[e].primaries},getTransfer:function(e){return""===e?Ae:Je[e].transfer}};function tt(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function nt(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let it,rt=class{static getDataURL(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{void 0===it&&(it=$e("canvas")),it.width=e.width,it.height=e.height;const n=it.getContext("2d");e instanceof ImageData?n.putImageData(e,0,0):n.drawImage(e,0,0,e.width,e.height),t=it}return t.width>2048||t.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",e),t.toDataURL("image/jpeg",.6)):t.toDataURL("image/png")}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=$e("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");n.drawImage(e,0,0,e.width,e.height);const i=n.getImageData(0,0,e.width,e.height),r=i.data;for(let e=0;e<r.length;e++)r[e]=255*tt(r[e]/255);return n.putImageData(i,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*tt(t[e]/255)):t[e]=tt(t[e]);return{data:t,width:e.width,height:e.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}},st=0,ot=class{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:st++}),this.uuid=Fe(),this.data=e,this.dataReady=!0,this.version=0}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const n={uuid:this.uuid,url:""},i=this.data;if(null!==i){let e;if(Array.isArray(i)){e=[];for(let t=0,n=i.length;t<n;t++)i[t].isDataTexture?e.push(at(i[t].image)):e.push(at(i[t]))}else e=at(i);n.url=e}return t||(e.images[this.uuid]=n),n}};function at(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?rt.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let lt=0,ct=class e extends Le{constructor(t=e.DEFAULT_IMAGE,n=e.DEFAULT_MAPPING,i=1001,r=1001,s=1006,o=1008,a=1023,l=1009,c=e.DEFAULT_ANISOTROPY,u=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:lt++}),this.uuid=Fe(),this.name="",this.source=new ot(t),this.mipmaps=[],this.mapping=n,this.channel=0,this.wrapS=i,this.wrapT=r,this.magFilter=s,this.minFilter=o,this.anisotropy=c,this.format=a,this.internalFormat=null,this.type=l,this.offset=new We(0,0),this.repeat=new We(1,1),this.center=new We(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new qe,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=u,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const n={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(n.userData=this.userData),t||(e.textures[this.uuid]=n),n}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case fe:e.x=e.x-Math.floor(e.x);break;case me:e.x=e.x<0?0:1;break;case 1002:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case fe:e.y=e.y-Math.floor(e.y);break;case me:e.y=e.y<0?0:1;break;case 1002:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}};ct.DEFAULT_IMAGE=null,ct.DEFAULT_MAPPING=300,ct.DEFAULT_ANISOTROPY=1;let ut=class e{constructor(t=0,n=0,i=0,r=1){e.prototype.isVector4=!0,this.x=t,this.y=n,this.z=i,this.w=r}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,n=this.y,i=this.z,r=this.w,s=e.elements;return this.x=s[0]*t+s[4]*n+s[8]*i+s[12]*r,this.y=s[1]*t+s[5]*n+s[9]*i+s[13]*r,this.z=s[2]*t+s[6]*n+s[10]*i+s[14]*r,this.w=s[3]*t+s[7]*n+s[11]*i+s[15]*r,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,n,i,r;const s=.01,o=.1,a=e.elements,l=a[0],c=a[4],u=a[8],h=a[1],d=a[5],p=a[9],f=a[2],m=a[6],g=a[10];if(Math.abs(c-h)<s&&Math.abs(u-f)<s&&Math.abs(p-m)<s){if(Math.abs(c+h)<o&&Math.abs(u+f)<o&&Math.abs(p+m)<o&&Math.abs(l+d+g-3)<o)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,a=(d+1)/2,y=(g+1)/2,v=(c+h)/4,_=(u+f)/4,x=(p+m)/4;return e>a&&e>y?e<s?(n=0,i=.707106781,r=.707106781):(n=Math.sqrt(e),i=v/n,r=_/n):a>y?a<s?(n=.707106781,i=0,r=.707106781):(i=Math.sqrt(a),n=v/i,r=x/i):y<s?(n=.707106781,i=.707106781,r=0):(r=Math.sqrt(y),n=_/r,i=x/r),this.set(n,i,r,t),this}let y=Math.sqrt((m-p)*(m-p)+(u-f)*(u-f)+(h-c)*(h-c));return Math.abs(y)<.001&&(y=1),this.x=(m-p)/y,this.y=(u-f)/y,this.z=(h-c)/y,this.w=Math.acos((l+d+g-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this.w=e.w+(t.w-e.w)*n,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}},ht=class{constructor(e=0,t=0,n=0,i=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=n,this._w=i}static slerpFlat(e,t,n,i,r,s,o){let a=n[i+0],l=n[i+1],c=n[i+2],u=n[i+3];const h=r[s+0],d=r[s+1],p=r[s+2],f=r[s+3];if(0===o)return e[t+0]=a,e[t+1]=l,e[t+2]=c,void(e[t+3]=u);if(1===o)return e[t+0]=h,e[t+1]=d,e[t+2]=p,void(e[t+3]=f);if(u!==f||a!==h||l!==d||c!==p){let e=1-o;const t=a*h+l*d+c*p+u*f,n=t>=0?1:-1,i=1-t*t;if(i>Number.EPSILON){const r=Math.sqrt(i),s=Math.atan2(r,t*n);e=Math.sin(e*s)/r,o=Math.sin(o*s)/r}const r=o*n;if(a=a*e+h*r,l=l*e+d*r,c=c*e+p*r,u=u*e+f*r,e===1-o){const e=1/Math.sqrt(a*a+l*l+c*c+u*u);a*=e,l*=e,c*=e,u*=e}}e[t]=a,e[t+1]=l,e[t+2]=c,e[t+3]=u}static multiplyQuaternionsFlat(e,t,n,i,r,s){const o=n[i],a=n[i+1],l=n[i+2],c=n[i+3],u=r[s],h=r[s+1],d=r[s+2],p=r[s+3];return e[t]=o*p+c*u+a*d-l*h,e[t+1]=a*p+c*h+l*u-o*d,e[t+2]=l*p+c*d+o*h-a*u,e[t+3]=c*p-o*u-a*h-l*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,n,i){return this._x=e,this._y=t,this._z=n,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const n=e._x,i=e._y,r=e._z,s=e._order,o=Math.cos,a=Math.sin,l=o(n/2),c=o(i/2),u=o(r/2),h=a(n/2),d=a(i/2),p=a(r/2);switch(s){case"XYZ":this._x=h*c*u+l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u-h*d*p;break;case"YXZ":this._x=h*c*u+l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u+h*d*p;break;case"ZXY":this._x=h*c*u-l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u-h*d*p;break;case"ZYX":this._x=h*c*u-l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u+h*d*p;break;case"YZX":this._x=h*c*u+l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u-h*d*p;break;case"XZY":this._x=h*c*u-l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u+h*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const n=t/2,i=Math.sin(n);return this._x=e.x*i,this._y=e.y*i,this._z=e.z*i,this._w=Math.cos(n),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,n=t[0],i=t[4],r=t[8],s=t[1],o=t[5],a=t[9],l=t[2],c=t[6],u=t[10],h=n+o+u;if(h>0){const e=.5/Math.sqrt(h+1);this._w=.25/e,this._x=(c-a)*e,this._y=(r-l)*e,this._z=(s-i)*e}else if(n>o&&n>u){const e=2*Math.sqrt(1+n-o-u);this._w=(c-a)/e,this._x=.25*e,this._y=(i+s)/e,this._z=(r+l)/e}else if(o>u){const e=2*Math.sqrt(1+o-n-u);this._w=(r-l)/e,this._x=(i+s)/e,this._y=.25*e,this._z=(a+c)/e}else{const e=2*Math.sqrt(1+u-n-o);this._w=(s-i)/e,this._x=(r+l)/e,this._y=(a+c)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let n=e.dot(t)+1;return n<Number.EPSILON?(n=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=n):(this._x=0,this._y=-e.z,this._z=e.y,this._w=n)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=n),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Be(this.dot(e),-1,1)))}rotateTowards(e,t){const n=this.angleTo(e);if(0===n)return this;const i=Math.min(1,t/n);return this.slerp(e,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const n=e._x,i=e._y,r=e._z,s=e._w,o=t._x,a=t._y,l=t._z,c=t._w;return this._x=n*c+s*o+i*l-r*a,this._y=i*c+s*a+r*o-n*l,this._z=r*c+s*l+n*a-i*o,this._w=s*c-n*o-i*a-r*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const n=this._x,i=this._y,r=this._z,s=this._w;let o=s*e._w+n*e._x+i*e._y+r*e._z;if(o<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,o=-o):this.copy(e),o>=1)return this._w=s,this._x=n,this._y=i,this._z=r,this;const a=1-o*o;if(a<=Number.EPSILON){const e=1-t;return this._w=e*s+t*this._w,this._x=e*n+t*this._x,this._y=e*i+t*this._y,this._z=e*r+t*this._z,this.normalize(),this}const l=Math.sqrt(a),c=Math.atan2(l,o),u=Math.sin((1-t)*c)/l,h=Math.sin(t*c)/l;return this._w=s*u+this._w*h,this._x=n*u+this._x*h,this._y=i*u+this._y*h,this._z=r*u+this._z*h,this._onChangeCallback(),this}slerpQuaternions(e,t,n){return this.copy(e).slerp(t,n)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),n=Math.random(),i=Math.sqrt(1-n),r=Math.sqrt(n);return this.set(i*Math.sin(e),i*Math.cos(e),r*Math.sin(t),r*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}},dt=class e{constructor(t=0,n=0,i=0){e.prototype.isVector3=!0,this.x=t,this.y=n,this.z=i}set(e,t,n){return void 0===n&&(n=this.z),this.x=e,this.y=t,this.z=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(ft.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(ft.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,n=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[3]*n+r[6]*i,this.y=r[1]*t+r[4]*n+r[7]*i,this.z=r[2]*t+r[5]*n+r[8]*i,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,n=this.y,i=this.z,r=e.elements,s=1/(r[3]*t+r[7]*n+r[11]*i+r[15]);return this.x=(r[0]*t+r[4]*n+r[8]*i+r[12])*s,this.y=(r[1]*t+r[5]*n+r[9]*i+r[13])*s,this.z=(r[2]*t+r[6]*n+r[10]*i+r[14])*s,this}applyQuaternion(e){const t=this.x,n=this.y,i=this.z,r=e.x,s=e.y,o=e.z,a=e.w,l=2*(s*i-o*n),c=2*(o*t-r*i),u=2*(r*n-s*t);return this.x=t+a*l+s*u-o*c,this.y=n+a*c+o*l-r*u,this.z=i+a*u+r*c-s*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,n=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[4]*n+r[8]*i,this.y=r[1]*t+r[5]*n+r[9]*i,this.z=r[2]*t+r[6]*n+r[10]*i,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const n=e.x,i=e.y,r=e.z,s=t.x,o=t.y,a=t.z;return this.x=i*a-r*o,this.y=r*s-n*a,this.z=n*o-i*s,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const n=e.dot(this)/t;return this.copy(e).multiplyScalar(n)}projectOnPlane(e){return pt.copy(this).projectOnVector(e),this.sub(pt)}reflect(e){return this.sub(pt.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(Be(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y,i=this.z-e.z;return t*t+n*n+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,n){const i=Math.sin(t)*e;return this.x=i*Math.sin(n),this.y=Math.cos(t)*e,this.z=i*Math.cos(n),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,n){return this.x=e*Math.sin(t),this.y=n,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),n=this.setFromMatrixColumn(e,1).length(),i=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=n,this.z=i,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=2*Math.random()-1,n=Math.sqrt(1-t*t);return this.x=n*Math.cos(e),this.y=t,this.z=n*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}};const pt=new dt,ft=new ht;let mt=class{constructor(e=new dt(1/0,1/0,1/0),t=new dt(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t+=3)this.expandByPoint(yt.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,n=e.count;t<n;t++)this.expandByPoint(yt.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const n=yt.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(n),this.max.copy(e).add(n),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const n=e.geometry;if(void 0!==n){const i=n.getAttribute("position");if(!0===t&&void 0!==i&&!0!==e.isInstancedMesh)for(let t=0,n=i.count;t<n;t++)!0===e.isMesh?e.getVertexPosition(t,yt):yt.fromBufferAttribute(i,t),yt.applyMatrix4(e.matrixWorld),this.expandByPoint(yt);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),vt.copy(e.boundingBox)):(null===n.boundingBox&&n.computeBoundingBox(),vt.copy(n.boundingBox)),vt.applyMatrix4(e.matrixWorld),this.union(vt)}const i=e.children;for(let e=0,n=i.length;e<n;e++)this.expandByObject(i[e],t);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,yt),yt.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,n;return e.normal.x>0?(t=e.normal.x*this.min.x,n=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,n=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,n+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,n+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,n+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,n+=e.normal.z*this.min.z),t<=-e.constant&&n>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(Mt),Et.subVectors(this.max,Mt),_t.subVectors(e.a,Mt),xt.subVectors(e.b,Mt),bt.subVectors(e.c,Mt),wt.subVectors(xt,_t),Tt.subVectors(bt,xt),St.subVectors(_t,bt);let t=[0,-wt.z,wt.y,0,-Tt.z,Tt.y,0,-St.z,St.y,wt.z,0,-wt.x,Tt.z,0,-Tt.x,St.z,0,-St.x,-wt.y,wt.x,0,-Tt.y,Tt.x,0,-St.y,St.x,0];return!!Rt(t,_t,xt,bt,Et)&&(t=[1,0,0,0,1,0,0,0,1],!!Rt(t,_t,xt,bt,Et)&&(At.crossVectors(wt,Tt),t=[At.x,At.y,At.z],Rt(t,_t,xt,bt,Et)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,yt).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(yt).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(gt[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),gt[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),gt[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),gt[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),gt[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),gt[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),gt[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),gt[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(gt)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}};const gt=[new dt,new dt,new dt,new dt,new dt,new dt,new dt,new dt],yt=new dt,vt=new mt,_t=new dt,xt=new dt,bt=new dt,wt=new dt,Tt=new dt,St=new dt,Mt=new dt,Et=new dt,At=new dt,Ct=new dt;function Rt(e,t,n,i,r){for(let s=0,o=e.length-3;s<=o;s+=3){Ct.fromArray(e,s);const o=r.x*Math.abs(Ct.x)+r.y*Math.abs(Ct.y)+r.z*Math.abs(Ct.z),a=t.dot(Ct),l=n.dot(Ct),c=i.dot(Ct);if(Math.max(-Math.max(a,l,c),Math.min(a,l,c))>o)return!1}return!0}const Nt=new mt,Pt=new dt,Dt=new dt;let Lt=class{constructor(e=new dt,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const n=this.center;void 0!==t?n.copy(t):Nt.setFromPoints(e).getCenter(n);let i=0;for(let t=0,r=e.length;t<r;t++)i=Math.max(i,n.distanceToSquared(e[t]));return this.radius=Math.sqrt(i),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const n=this.center.distanceToSquared(e);return t.copy(e),n>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;Pt.subVectors(e,this.center);const t=Pt.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),n=.5*(e-this.radius);this.center.addScaledVector(Pt,n/e),this.radius+=n}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(Dt.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(Pt.copy(e.center).add(Dt)),this.expandByPoint(Pt.copy(e.center).sub(Dt))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}};const It=new dt,kt=new dt,Ot=new dt,Ut=new dt,Ft=new dt,Bt=new dt,zt=new dt;let Vt=class{constructor(e=new dt,t=new dt(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,It)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const n=t.dot(this.direction);return n<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,n)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=It.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(It.copy(this.origin).addScaledVector(this.direction,t),It.distanceToSquared(e))}distanceSqToSegment(e,t,n,i){kt.copy(e).add(t).multiplyScalar(.5),Ot.copy(t).sub(e).normalize(),Ut.copy(this.origin).sub(kt);const r=.5*e.distanceTo(t),s=-this.direction.dot(Ot),o=Ut.dot(this.direction),a=-Ut.dot(Ot),l=Ut.lengthSq(),c=Math.abs(1-s*s);let u,h,d,p;if(c>0)if(u=s*a-o,h=s*o-a,p=r*c,u>=0)if(h>=-p)if(h<=p){const e=1/c;u*=e,h*=e,d=u*(u+s*h+2*o)+h*(s*u+h+2*a)+l}else h=r,u=Math.max(0,-(s*h+o)),d=-u*u+h*(h+2*a)+l;else h=-r,u=Math.max(0,-(s*h+o)),d=-u*u+h*(h+2*a)+l;else h<=-p?(u=Math.max(0,-(-s*r+o)),h=u>0?-r:Math.min(Math.max(-r,-a),r),d=-u*u+h*(h+2*a)+l):h<=p?(u=0,h=Math.min(Math.max(-r,-a),r),d=h*(h+2*a)+l):(u=Math.max(0,-(s*r+o)),h=u>0?r:Math.min(Math.max(-r,-a),r),d=-u*u+h*(h+2*a)+l);else h=s>0?-r:r,u=Math.max(0,-(s*h+o)),d=-u*u+h*(h+2*a)+l;return n&&n.copy(this.origin).addScaledVector(this.direction,u),i&&i.copy(kt).addScaledVector(Ot,h),d}intersectSphere(e,t){It.subVectors(e.center,this.origin);const n=It.dot(this.direction),i=It.dot(It)-n*n,r=e.radius*e.radius;if(i>r)return null;const s=Math.sqrt(r-i),o=n-s,a=n+s;return a<0?null:o<0?this.at(a,t):this.at(o,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const n=-(this.origin.dot(e.normal)+e.constant)/t;return n>=0?n:null}intersectPlane(e,t){const n=this.distanceToPlane(e);return null===n?null:this.at(n,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0}intersectBox(e,t){let n,i,r,s,o,a;const l=1/this.direction.x,c=1/this.direction.y,u=1/this.direction.z,h=this.origin;return l>=0?(n=(e.min.x-h.x)*l,i=(e.max.x-h.x)*l):(n=(e.max.x-h.x)*l,i=(e.min.x-h.x)*l),c>=0?(r=(e.min.y-h.y)*c,s=(e.max.y-h.y)*c):(r=(e.max.y-h.y)*c,s=(e.min.y-h.y)*c),n>s||r>i?null:((r>n||isNaN(n))&&(n=r),(s<i||isNaN(i))&&(i=s),u>=0?(o=(e.min.z-h.z)*u,a=(e.max.z-h.z)*u):(o=(e.max.z-h.z)*u,a=(e.min.z-h.z)*u),n>a||o>i?null:((o>n||n!=n)&&(n=o),(a<i||i!=i)&&(i=a),i<0?null:this.at(n>=0?n:i,t)))}intersectsBox(e){return null!==this.intersectBox(e,It)}intersectTriangle(e,t,n,i,r){Ft.subVectors(t,e),Bt.subVectors(n,e),zt.crossVectors(Ft,Bt);let s,o=this.direction.dot(zt);if(o>0){if(i)return null;s=1}else{if(!(o<0))return null;s=-1,o=-o}Ut.subVectors(this.origin,e);const a=s*this.direction.dot(Bt.crossVectors(Ut,Bt));if(a<0)return null;const l=s*this.direction.dot(Ft.cross(Ut));if(l<0)return null;if(a+l>o)return null;const c=-s*Ut.dot(zt);return c<0?null:this.at(c/o,r)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}},Gt=class e{constructor(t,n,i,r,s,o,a,l,c,u,h,d,p,f,m,g){e.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,n,i,r,s,o,a,l,c,u,h,d,p,f,m,g)}set(e,t,n,i,r,s,o,a,l,c,u,h,d,p,f,m){const g=this.elements;return g[0]=e,g[4]=t,g[8]=n,g[12]=i,g[1]=r,g[5]=s,g[9]=o,g[13]=a,g[2]=l,g[6]=c,g[10]=u,g[14]=h,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new e).fromArray(this.elements)}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],this}copyPosition(e){const t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,n){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),n.setFromMatrixColumn(this,2),this}makeBasis(e,t,n){return this.set(e.x,t.x,n.x,0,e.y,t.y,n.y,0,e.z,t.z,n.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,n=e.elements,i=1/jt.setFromMatrixColumn(e,0).length(),r=1/jt.setFromMatrixColumn(e,1).length(),s=1/jt.setFromMatrixColumn(e,2).length();return t[0]=n[0]*i,t[1]=n[1]*i,t[2]=n[2]*i,t[3]=0,t[4]=n[4]*r,t[5]=n[5]*r,t[6]=n[6]*r,t[7]=0,t[8]=n[8]*s,t[9]=n[9]*s,t[10]=n[10]*s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,n=e.x,i=e.y,r=e.z,s=Math.cos(n),o=Math.sin(n),a=Math.cos(i),l=Math.sin(i),c=Math.cos(r),u=Math.sin(r);if("XYZ"===e.order){const e=s*c,n=s*u,i=o*c,r=o*u;t[0]=a*c,t[4]=-a*u,t[8]=l,t[1]=n+i*l,t[5]=e-r*l,t[9]=-o*a,t[2]=r-e*l,t[6]=i+n*l,t[10]=s*a}else if("YXZ"===e.order){const e=a*c,n=a*u,i=l*c,r=l*u;t[0]=e+r*o,t[4]=i*o-n,t[8]=s*l,t[1]=s*u,t[5]=s*c,t[9]=-o,t[2]=n*o-i,t[6]=r+e*o,t[10]=s*a}else if("ZXY"===e.order){const e=a*c,n=a*u,i=l*c,r=l*u;t[0]=e-r*o,t[4]=-s*u,t[8]=i+n*o,t[1]=n+i*o,t[5]=s*c,t[9]=r-e*o,t[2]=-s*l,t[6]=o,t[10]=s*a}else if("ZYX"===e.order){const e=s*c,n=s*u,i=o*c,r=o*u;t[0]=a*c,t[4]=i*l-n,t[8]=e*l+r,t[1]=a*u,t[5]=r*l+e,t[9]=n*l-i,t[2]=-l,t[6]=o*a,t[10]=s*a}else if("YZX"===e.order){const e=s*a,n=s*l,i=o*a,r=o*l;t[0]=a*c,t[4]=r-e*u,t[8]=i*u+n,t[1]=u,t[5]=s*c,t[9]=-o*c,t[2]=-l*c,t[6]=n*u+i,t[10]=e-r*u}else if("XZY"===e.order){const e=s*a,n=s*l,i=o*a,r=o*l;t[0]=a*c,t[4]=-u,t[8]=l*c,t[1]=e*u+r,t[5]=s*c,t[9]=n*u-i,t[2]=i*u-n,t[6]=o*c,t[10]=r*u+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(Wt,e,qt)}lookAt(e,t,n){const i=this.elements;return Yt.subVectors(e,t),0===Yt.lengthSq()&&(Yt.z=1),Yt.normalize(),Xt.crossVectors(n,Yt),0===Xt.lengthSq()&&(1===Math.abs(n.z)?Yt.x+=1e-4:Yt.z+=1e-4,Yt.normalize(),Xt.crossVectors(n,Yt)),Xt.normalize(),$t.crossVectors(Yt,Xt),i[0]=Xt.x,i[4]=$t.x,i[8]=Yt.x,i[1]=Xt.y,i[5]=$t.y,i[9]=Yt.y,i[2]=Xt.z,i[6]=$t.z,i[10]=Yt.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,i=t.elements,r=this.elements,s=n[0],o=n[4],a=n[8],l=n[12],c=n[1],u=n[5],h=n[9],d=n[13],p=n[2],f=n[6],m=n[10],g=n[14],y=n[3],v=n[7],_=n[11],x=n[15],b=i[0],w=i[4],T=i[8],S=i[12],M=i[1],E=i[5],A=i[9],C=i[13],R=i[2],N=i[6],P=i[10],D=i[14],L=i[3],I=i[7],k=i[11],O=i[15];return r[0]=s*b+o*M+a*R+l*L,r[4]=s*w+o*E+a*N+l*I,r[8]=s*T+o*A+a*P+l*k,r[12]=s*S+o*C+a*D+l*O,r[1]=c*b+u*M+h*R+d*L,r[5]=c*w+u*E+h*N+d*I,r[9]=c*T+u*A+h*P+d*k,r[13]=c*S+u*C+h*D+d*O,r[2]=p*b+f*M+m*R+g*L,r[6]=p*w+f*E+m*N+g*I,r[10]=p*T+f*A+m*P+g*k,r[14]=p*S+f*C+m*D+g*O,r[3]=y*b+v*M+_*R+x*L,r[7]=y*w+v*E+_*N+x*I,r[11]=y*T+v*A+_*P+x*k,r[15]=y*S+v*C+_*D+x*O,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[4],i=e[8],r=e[12],s=e[1],o=e[5],a=e[9],l=e[13],c=e[2],u=e[6],h=e[10],d=e[14];return e[3]*(+r*a*u-i*l*u-r*o*h+n*l*h+i*o*d-n*a*d)+e[7]*(+t*a*d-t*l*h+r*s*h-i*s*d+i*l*c-r*a*c)+e[11]*(+t*l*u-t*o*d-r*s*u+n*s*d+r*o*c-n*l*c)+e[15]*(-i*o*c-t*a*u+t*o*h+i*s*u-n*s*h+n*a*c)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,n){const i=this.elements;return e.isVector3?(i[12]=e.x,i[13]=e.y,i[14]=e.z):(i[12]=e,i[13]=t,i[14]=n),this}invert(){const e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],s=e[4],o=e[5],a=e[6],l=e[7],c=e[8],u=e[9],h=e[10],d=e[11],p=e[12],f=e[13],m=e[14],g=e[15],y=u*m*l-f*h*l+f*a*d-o*m*d-u*a*g+o*h*g,v=p*h*l-c*m*l-p*a*d+s*m*d+c*a*g-s*h*g,_=c*f*l-p*u*l+p*o*d-s*f*d-c*o*g+s*u*g,x=p*u*a-c*f*a-p*o*h+s*f*h+c*o*m-s*u*m,b=t*y+n*v+i*_+r*x;if(0===b)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/b;return e[0]=y*w,e[1]=(f*h*r-u*m*r-f*i*d+n*m*d+u*i*g-n*h*g)*w,e[2]=(o*m*r-f*a*r+f*i*l-n*m*l-o*i*g+n*a*g)*w,e[3]=(u*a*r-o*h*r-u*i*l+n*h*l+o*i*d-n*a*d)*w,e[4]=v*w,e[5]=(c*m*r-p*h*r+p*i*d-t*m*d-c*i*g+t*h*g)*w,e[6]=(p*a*r-s*m*r-p*i*l+t*m*l+s*i*g-t*a*g)*w,e[7]=(s*h*r-c*a*r+c*i*l-t*h*l-s*i*d+t*a*d)*w,e[8]=_*w,e[9]=(p*u*r-c*f*r-p*n*d+t*f*d+c*n*g-t*u*g)*w,e[10]=(s*f*r-p*o*r+p*n*l-t*f*l-s*n*g+t*o*g)*w,e[11]=(c*o*r-s*u*r-c*n*l+t*u*l+s*n*d-t*o*d)*w,e[12]=x*w,e[13]=(c*f*i-p*u*i+p*n*h-t*f*h-c*n*m+t*u*m)*w,e[14]=(p*o*i-s*f*i-p*n*a+t*f*a+s*n*m-t*o*m)*w,e[15]=(s*u*i-c*o*i+c*n*a-t*u*a-s*n*h+t*o*h)*w,this}scale(e){const t=this.elements,n=e.x,i=e.y,r=e.z;return t[0]*=n,t[4]*=i,t[8]*=r,t[1]*=n,t[5]*=i,t[9]*=r,t[2]*=n,t[6]*=i,t[10]*=r,t[3]*=n,t[7]*=i,t[11]*=r,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],i=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,n,i))}makeTranslation(e,t,n){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const n=Math.cos(t),i=Math.sin(t),r=1-n,s=e.x,o=e.y,a=e.z,l=r*s,c=r*o;return this.set(l*s+n,l*o-i*a,l*a+i*o,0,l*o+i*a,c*o+n,c*a-i*s,0,l*a-i*o,c*a+i*s,r*a*a+n,0,0,0,0,1),this}makeScale(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this}makeShear(e,t,n,i,r,s){return this.set(1,n,r,0,e,1,s,0,t,i,1,0,0,0,0,1),this}compose(e,t,n){const i=this.elements,r=t._x,s=t._y,o=t._z,a=t._w,l=r+r,c=s+s,u=o+o,h=r*l,d=r*c,p=r*u,f=s*c,m=s*u,g=o*u,y=a*l,v=a*c,_=a*u,x=n.x,b=n.y,w=n.z;return i[0]=(1-(f+g))*x,i[1]=(d+_)*x,i[2]=(p-v)*x,i[3]=0,i[4]=(d-_)*b,i[5]=(1-(h+g))*b,i[6]=(m+y)*b,i[7]=0,i[8]=(p+v)*w,i[9]=(m-y)*w,i[10]=(1-(h+f))*w,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}decompose(e,t,n){const i=this.elements;let r=jt.set(i[0],i[1],i[2]).length();const s=jt.set(i[4],i[5],i[6]).length(),o=jt.set(i[8],i[9],i[10]).length();this.determinant()<0&&(r=-r),e.x=i[12],e.y=i[13],e.z=i[14],Ht.copy(this);const a=1/r,l=1/s,c=1/o;return Ht.elements[0]*=a,Ht.elements[1]*=a,Ht.elements[2]*=a,Ht.elements[4]*=l,Ht.elements[5]*=l,Ht.elements[6]*=l,Ht.elements[8]*=c,Ht.elements[9]*=c,Ht.elements[10]*=c,t.setFromRotationMatrix(Ht),n.x=r,n.y=s,n.z=o,this}makePerspective(e,t,n,i,r,s,o=2e3){const a=this.elements,l=2*r/(t-e),c=2*r/(n-i),u=(t+e)/(t-e),h=(n+i)/(n-i);let d,p;if(o===Pe)d=-(s+r)/(s-r),p=-2*s*r/(s-r);else{if(o!==De)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);d=-s/(s-r),p=-s*r/(s-r)}return a[0]=l,a[4]=0,a[8]=u,a[12]=0,a[1]=0,a[5]=c,a[9]=h,a[13]=0,a[2]=0,a[6]=0,a[10]=d,a[14]=p,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(e,t,n,i,r,s,o=2e3){const a=this.elements,l=1/(t-e),c=1/(n-i),u=1/(s-r),h=(t+e)*l,d=(n+i)*c;let p,f;if(o===Pe)p=(s+r)*u,f=-2*u;else{if(o!==De)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);p=r*u,f=-1*u}return a[0]=2*l,a[4]=0,a[8]=0,a[12]=-h,a[1]=0,a[5]=2*c,a[9]=0,a[13]=-d,a[2]=0,a[6]=0,a[10]=f,a[14]=-p,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}equals(e){const t=this.elements,n=e.elements;for(let e=0;e<16;e++)if(t[e]!==n[e])return!1;return!0}fromArray(e,t=0){for(let n=0;n<16;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e}};const jt=new dt,Ht=new Gt,Wt=new dt(0,0,0),qt=new dt(1,1,1),Xt=new dt,$t=new dt,Yt=new dt,Kt=new Gt,Zt=new ht;let Jt=class e{constructor(t=0,n=0,i=0,r=e.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=n,this._z=i,this._order=r}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,n,i=this._order){return this._x=e,this._y=t,this._z=n,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,n=!0){const i=e.elements,r=i[0],s=i[4],o=i[8],a=i[1],l=i[5],c=i[9],u=i[2],h=i[6],d=i[10];switch(t){case"XYZ":this._y=Math.asin(Be(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-s,r)):(this._x=Math.atan2(h,l),this._z=0);break;case"YXZ":this._x=Math.asin(-Be(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(o,d),this._z=Math.atan2(a,l)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(Be(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(-u,d),this._z=Math.atan2(-s,l)):(this._y=0,this._z=Math.atan2(a,r));break;case"ZYX":this._y=Math.asin(-Be(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(h,d),this._z=Math.atan2(a,r)):(this._x=0,this._z=Math.atan2(-s,l));break;case"YZX":this._z=Math.asin(Be(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(o,d));break;case"XZY":this._z=Math.asin(-Be(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(h,l),this._y=Math.atan2(o,r)):(this._x=Math.atan2(-c,d),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!0===n&&this._onChangeCallback(),this}setFromQuaternion(e,t,n){return Kt.makeRotationFromQuaternion(e),this.setFromRotationMatrix(Kt,t,n)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return Zt.setFromEuler(this),this.setFromQuaternion(Zt,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}};Jt.DEFAULT_ORDER="XYZ";let Qt=class{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return 0!==(this.mask&e.mask)}isEnabled(e){return!!(this.mask&1<<e)}},en=0;const tn=new dt,nn=new ht,rn=new Gt,sn=new dt,on=new dt,an=new dt,ln=new ht,cn=new dt(1,0,0),un=new dt(0,1,0),hn=new dt(0,0,1),dn={type:"added"},pn={type:"removed"},fn={type:"childadded",child:null},mn={type:"childremoved",child:null};let gn=class e extends Le{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:en++}),this.uuid=Fe(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=e.DEFAULT_UP.clone();const t=new dt,n=new Jt,i=new ht,r=new dt(1,1,1);n._onChange((function(){i.setFromEuler(n,!1)})),i._onChange((function(){n.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:n},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:r},modelViewMatrix:{value:new Gt},normalMatrix:{value:new qe}}),this.matrix=new Gt,this.matrixWorld=new Gt,this.matrixAutoUpdate=e.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=e.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Qt,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return nn.setFromAxisAngle(e,t),this.quaternion.multiply(nn),this}rotateOnWorldAxis(e,t){return nn.setFromAxisAngle(e,t),this.quaternion.premultiply(nn),this}rotateX(e){return this.rotateOnAxis(cn,e)}rotateY(e){return this.rotateOnAxis(un,e)}rotateZ(e){return this.rotateOnAxis(hn,e)}translateOnAxis(e,t){return tn.copy(e).applyQuaternion(this.quaternion),this.position.add(tn.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(cn,e)}translateY(e){return this.translateOnAxis(un,e)}translateZ(e){return this.translateOnAxis(hn,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(rn.copy(this.matrixWorld).invert())}lookAt(e,t,n){e.isVector3?sn.copy(e):sn.set(e,t,n);const i=this.parent;this.updateWorldMatrix(!0,!1),on.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?rn.lookAt(on,sn,this.up):rn.lookAt(sn,on,this.up),this.quaternion.setFromRotationMatrix(rn),i&&(rn.extractRotation(i.matrixWorld),nn.setFromRotationMatrix(rn),this.quaternion.premultiply(nn.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(dn),fn.child=e,this.dispatchEvent(fn),fn.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(pn),mn.child=e,this.dispatchEvent(mn),mn.child=null),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),rn.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),rn.multiply(e.parent.matrixWorld)),e.applyMatrix4(rn),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(dn),fn.child=e,this.dispatchEvent(fn),fn.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let n=0,i=this.children.length;n<i;n++){const i=this.children[n].getObjectByProperty(e,t);if(void 0!==i)return i}}getObjectsByProperty(e,t,n=[]){this[e]===t&&n.push(this);const i=this.children;for(let r=0,s=i.length;r<s;r++)i[r].getObjectsByProperty(e,t,n);return n}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(on,e,an),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(on,ln,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let n=0,i=t.length;n<i;n++){const i=t[n];!0!==i.matrixWorldAutoUpdate&&!0!==e||i.updateMatrixWorld(e)}}updateWorldMatrix(e,t){const n=this.parent;if(!0===e&&null!==n&&!0===n.matrixWorldAutoUpdate&&n.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;for(let t=0,n=e.length;t<n;t++){const n=e[t];!0===n.matrixWorldAutoUpdate&&n.updateWorldMatrix(!1,!0)}}}toJSON(e){const t=void 0===e||"string"==typeof e,n={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},n.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const i={};function r(t,n){return void 0===t[n.uuid]&&(t[n.uuid]=n.toJSON(e)),n.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.visibility=this._visibility,i.active=this._active,i.bounds=this._bounds.map((e=>({boxInitialized:e.boxInitialized,boxMin:e.box.min.toArray(),boxMax:e.box.max.toArray(),sphereInitialized:e.sphereInitialized,sphereRadius:e.sphere.radius,sphereCenter:e.sphere.center.toArray()}))),i.maxGeometryCount=this._maxGeometryCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.geometryCount=this._geometryCount,i.matricesTexture=this._matricesTexture.toJSON(e),null!==this.boundingSphere&&(i.boundingSphere={center:i.boundingSphere.center.toArray(),radius:i.boundingSphere.radius}),null!==this.boundingBox&&(i.boundingBox={min:i.boundingBox.min.toArray(),max:i.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(i.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=r(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const n=t.shapes;if(Array.isArray(n))for(let t=0,i=n.length;t<i;t++){const i=n[t];r(e.shapes,i)}else r(e.shapes,n)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(e.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let n=0,i=this.material.length;n<i;n++)t.push(r(e.materials,this.material[n]));i.material=t}else i.material=r(e.materials,this.material);if(this.children.length>0){i.children=[];for(let t=0;t<this.children.length;t++)i.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){i.animations=[];for(let t=0;t<this.animations.length;t++){const n=this.animations[t];i.animations.push(r(e.animations,n))}}if(t){const t=s(e.geometries),i=s(e.materials),r=s(e.textures),o=s(e.images),a=s(e.shapes),l=s(e.skeletons),c=s(e.animations),u=s(e.nodes);t.length>0&&(n.geometries=t),i.length>0&&(n.materials=i),r.length>0&&(n.textures=r),o.length>0&&(n.images=o),a.length>0&&(n.shapes=a),l.length>0&&(n.skeletons=l),c.length>0&&(n.animations=c),u.length>0&&(n.nodes=u)}return n.object=i,n;function s(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){const n=e.children[t];this.add(n.clone())}return this}};gn.DEFAULT_UP=new dt(0,1,0),gn.DEFAULT_MATRIX_AUTO_UPDATE=!0,gn.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const yn=new dt,vn=new dt,_n=new dt,xn=new dt,bn=new dt,wn=new dt,Tn=new dt,Sn=new dt,Mn=new dt,En=new dt;let An=class e{constructor(e=new dt,t=new dt,n=new dt){this.a=e,this.b=t,this.c=n}static getNormal(e,t,n,i){i.subVectors(n,t),yn.subVectors(e,t),i.cross(yn);const r=i.lengthSq();return r>0?i.multiplyScalar(1/Math.sqrt(r)):i.set(0,0,0)}static getBarycoord(e,t,n,i,r){yn.subVectors(i,t),vn.subVectors(n,t),_n.subVectors(e,t);const s=yn.dot(yn),o=yn.dot(vn),a=yn.dot(_n),l=vn.dot(vn),c=vn.dot(_n),u=s*l-o*o;if(0===u)return r.set(0,0,0),null;const h=1/u,d=(l*a-o*c)*h,p=(s*c-o*a)*h;return r.set(1-d-p,p,d)}static containsPoint(e,t,n,i){return null!==this.getBarycoord(e,t,n,i,xn)&&(xn.x>=0&&xn.y>=0&&xn.x+xn.y<=1)}static getInterpolation(e,t,n,i,r,s,o,a){return null===this.getBarycoord(e,t,n,i,xn)?(a.x=0,a.y=0,"z"in a&&(a.z=0),"w"in a&&(a.w=0),null):(a.setScalar(0),a.addScaledVector(r,xn.x),a.addScaledVector(s,xn.y),a.addScaledVector(o,xn.z),a)}static isFrontFacing(e,t,n,i){return yn.subVectors(n,t),vn.subVectors(e,t),yn.cross(vn).dot(i)<0}set(e,t,n){return this.a.copy(e),this.b.copy(t),this.c.copy(n),this}setFromPointsAndIndices(e,t,n,i){return this.a.copy(e[t]),this.b.copy(e[n]),this.c.copy(e[i]),this}setFromAttributeAndIndices(e,t,n,i){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,n),this.c.fromBufferAttribute(e,i),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return yn.subVectors(this.c,this.b),vn.subVectors(this.a,this.b),.5*yn.cross(vn).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return e.getNormal(this.a,this.b,this.c,t)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,n){return e.getBarycoord(t,this.a,this.b,this.c,n)}getInterpolation(t,n,i,r,s){return e.getInterpolation(t,this.a,this.b,this.c,n,i,r,s)}containsPoint(t){return e.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return e.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const n=this.a,i=this.b,r=this.c;let s,o;bn.subVectors(i,n),wn.subVectors(r,n),Sn.subVectors(e,n);const a=bn.dot(Sn),l=wn.dot(Sn);if(a<=0&&l<=0)return t.copy(n);Mn.subVectors(e,i);const c=bn.dot(Mn),u=wn.dot(Mn);if(c>=0&&u<=c)return t.copy(i);const h=a*u-c*l;if(h<=0&&a>=0&&c<=0)return s=a/(a-c),t.copy(n).addScaledVector(bn,s);En.subVectors(e,r);const d=bn.dot(En),p=wn.dot(En);if(p>=0&&d<=p)return t.copy(r);const f=d*l-a*p;if(f<=0&&l>=0&&p<=0)return o=l/(l-p),t.copy(n).addScaledVector(wn,o);const m=c*p-d*u;if(m<=0&&u-c>=0&&d-p>=0)return Tn.subVectors(r,i),o=(u-c)/(u-c+(d-p)),t.copy(i).addScaledVector(Tn,o);const g=1/(m+f+h);return s=f*g,o=h*g,t.copy(n).addScaledVector(bn,s).addScaledVector(wn,o)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}};const Cn={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Rn={h:0,s:0,l:0},Nn={h:0,s:0,l:0};function Pn(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+6*(t-e)*(2/3-n):e}let Dn=class{constructor(e,t,n){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,n)}set(e,t,n){if(void 0===t&&void 0===n){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,n);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=Te){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,et.toWorkingColorSpace(this,t),this}setRGB(e,t,n,i=et.workingColorSpace){return this.r=e,this.g=t,this.b=n,et.toWorkingColorSpace(this,i),this}setHSL(e,t,n,i=et.workingColorSpace){if(e=ze(e,1),t=Be(t,0,1),n=Be(n,0,1),0===t)this.r=this.g=this.b=n;else{const i=n<=.5?n*(1+t):n+t-n*t,r=2*n-i;this.r=Pn(r,i,e+1/3),this.g=Pn(r,i,e),this.b=Pn(r,i,e-1/3)}return et.toWorkingColorSpace(this,i),this}setStyle(e,t=Te){function n(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(e)){let r;const s=i[1],o=i[2];switch(s){case"rgb":case"rgba":if(r=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(r[4]),this.setRGB(Math.min(255,parseInt(r[1],10))/255,Math.min(255,parseInt(r[2],10))/255,Math.min(255,parseInt(r[3],10))/255,t);if(r=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(r[4]),this.setRGB(Math.min(100,parseInt(r[1],10))/100,Math.min(100,parseInt(r[2],10))/100,Math.min(100,parseInt(r[3],10))/100,t);break;case"hsl":case"hsla":if(r=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(r[4]),this.setHSL(parseFloat(r[1])/360,parseFloat(r[2])/100,parseFloat(r[3])/100,t);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(e)){const n=i[1],r=n.length;if(3===r)return this.setRGB(parseInt(n.charAt(0),16)/15,parseInt(n.charAt(1),16)/15,parseInt(n.charAt(2),16)/15,t);if(6===r)return this.setHex(parseInt(n,16),t);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=Te){const n=Cn[e.toLowerCase()];return void 0!==n?this.setHex(n,t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=tt(e.r),this.g=tt(e.g),this.b=tt(e.b),this}copyLinearToSRGB(e){return this.r=nt(e.r),this.g=nt(e.g),this.b=nt(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=Te){return et.fromWorkingColorSpace(Ln.copy(this),e),65536*Math.round(Be(255*Ln.r,0,255))+256*Math.round(Be(255*Ln.g,0,255))+Math.round(Be(255*Ln.b,0,255))}getHexString(e=Te){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=et.workingColorSpace){et.fromWorkingColorSpace(Ln.copy(this),t);const n=Ln.r,i=Ln.g,r=Ln.b,s=Math.max(n,i,r),o=Math.min(n,i,r);let a,l;const c=(o+s)/2;if(o===s)a=0,l=0;else{const e=s-o;switch(l=c<=.5?e/(s+o):e/(2-s-o),s){case n:a=(i-r)/e+(i<r?6:0);break;case i:a=(r-n)/e+2;break;case r:a=(n-i)/e+4}a/=6}return e.h=a,e.s=l,e.l=c,e}getRGB(e,t=et.workingColorSpace){return et.fromWorkingColorSpace(Ln.copy(this),t),e.r=Ln.r,e.g=Ln.g,e.b=Ln.b,e}getStyle(e=Te){et.fromWorkingColorSpace(Ln.copy(this),e);const t=Ln.r,n=Ln.g,i=Ln.b;return e!==Te?`color(${e} ${t.toFixed(3)} ${n.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*n)},${Math.round(255*i)})`}offsetHSL(e,t,n){return this.getHSL(Rn),this.setHSL(Rn.h+e,Rn.s+t,Rn.l+n)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,n){return this.r=e.r+(t.r-e.r)*n,this.g=e.g+(t.g-e.g)*n,this.b=e.b+(t.b-e.b)*n,this}lerpHSL(e,t){this.getHSL(Rn),e.getHSL(Nn);const n=Ve(Rn.h,Nn.h,t),i=Ve(Rn.s,Nn.s,t),r=Ve(Rn.l,Nn.l,t);return this.setHSL(n,i,r),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,n=this.g,i=this.b,r=e.elements;return this.r=r[0]*t+r[3]*n+r[6]*i,this.g=r[1]*t+r[4]*n+r[7]*i,this.b=r[2]*t+r[5]*n+r[8]*i,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}};const Ln=new Dn;Dn.NAMES=Cn;let In=0,kn=class extends Le{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:In++}),this.uuid=Fe(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=100,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Dn(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Ne,this.stencilZFail=Ne,this.stencilZPass=Ne,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const n=e[t];if(void 0===n){console.warn(`THREE.Material: parameter '${t}' has value of undefined.`);continue}const i=this[t];void 0!==i?i&&i.isColor?i.set(n):i&&i.isVector3&&n&&n.isVector3?i.copy(n):this[t]=n:console.warn(`THREE.Material: '${t}' is not a property of THREE.${this.type}.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const n={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function i(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),void 0!==this.roughness&&(n.roughness=this.roughness),void 0!==this.metalness&&(n.metalness=this.metalness),void 0!==this.sheen&&(n.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(n.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(n.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(n.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(n.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(n.shininess=this.shininess),void 0!==this.clearcoat&&(n.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(n.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(n.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(n.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(n.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,n.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(n.dispersion=this.dispersion),void 0!==this.iridescence&&(n.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(n.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(n.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(n.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(n.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(n.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(n.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(n.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(e).uuid,n.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(e).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(e).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(e).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(e).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(n.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(n.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(n.combine=this.combine)),void 0!==this.envMapRotation&&(n.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(n.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(n.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(n.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(n.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(n.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(n.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(n.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(n.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(n.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(n.size=this.size),null!==this.shadowSide&&(n.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(n.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(n.blending=this.blending),0!==this.side&&(n.side=this.side),!0===this.vertexColors&&(n.vertexColors=!0),this.opacity<1&&(n.opacity=this.opacity),!0===this.transparent&&(n.transparent=!0),204!==this.blendSrc&&(n.blendSrc=this.blendSrc),205!==this.blendDst&&(n.blendDst=this.blendDst),100!==this.blendEquation&&(n.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(n.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(n.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(n.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(n.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(n.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(n.depthFunc=this.depthFunc),!1===this.depthTest&&(n.depthTest=this.depthTest),!1===this.depthWrite&&(n.depthWrite=this.depthWrite),!1===this.colorWrite&&(n.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(n.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(n.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(n.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(n.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==Ne&&(n.stencilFail=this.stencilFail),this.stencilZFail!==Ne&&(n.stencilZFail=this.stencilZFail),this.stencilZPass!==Ne&&(n.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(n.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(n.rotation=this.rotation),!0===this.polygonOffset&&(n.polygonOffset=!0),0!==this.polygonOffsetFactor&&(n.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(n.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(n.linewidth=this.linewidth),void 0!==this.dashSize&&(n.dashSize=this.dashSize),void 0!==this.gapSize&&(n.gapSize=this.gapSize),void 0!==this.scale&&(n.scale=this.scale),!0===this.dithering&&(n.dithering=!0),this.alphaTest>0&&(n.alphaTest=this.alphaTest),!0===this.alphaHash&&(n.alphaHash=!0),!0===this.alphaToCoverage&&(n.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(n.premultipliedAlpha=!0),!0===this.forceSinglePass&&(n.forceSinglePass=!0),!0===this.wireframe&&(n.wireframe=!0),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(n.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(n.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(n.flatShading=!0),!1===this.visible&&(n.visible=!1),!1===this.toneMapped&&(n.toneMapped=!1),!1===this.fog&&(n.fog=!1),Object.keys(this.userData).length>0&&(n.userData=this.userData),t){const t=i(e.textures),r=i(e.images);t.length>0&&(n.textures=t),r.length>0&&(n.images=r)}return n}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let n=null;if(null!==t){const e=t.length;n=new Array(e);for(let i=0;i!==e;++i)n[i]=t[i].clone()}return this.clippingPlanes=n,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}},On=class extends kn{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Dn(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Jt,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}};const Un=new dt,Fn=new We;let Bn=class{constructor(e,t,n=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=n,this.usage=35044,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.gpuType=1015,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}get updateRange(){var e;return(e="THREE.BufferAttribute: updateRange() is deprecated and will be removed in r169. Use addUpdateRange() instead.")in Ye||(Ye[e]=!0,console.warn(e)),this._updateRange}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,n){e*=this.itemSize,n*=t.itemSize;for(let i=0,r=this.itemSize;i<r;i++)this.array[e+i]=t.array[n+i];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,n=this.count;t<n;t++)Fn.fromBufferAttribute(this,t),Fn.applyMatrix3(e),this.setXY(t,Fn.x,Fn.y);else if(3===this.itemSize)for(let t=0,n=this.count;t<n;t++)Un.fromBufferAttribute(this,t),Un.applyMatrix3(e),this.setXYZ(t,Un.x,Un.y,Un.z);return this}applyMatrix4(e){for(let t=0,n=this.count;t<n;t++)Un.fromBufferAttribute(this,t),Un.applyMatrix4(e),this.setXYZ(t,Un.x,Un.y,Un.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)Un.fromBufferAttribute(this,t),Un.applyNormalMatrix(e),this.setXYZ(t,Un.x,Un.y,Un.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)Un.fromBufferAttribute(this,t),Un.transformDirection(e),this.setXYZ(t,Un.x,Un.y,Un.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let n=this.array[e*this.itemSize+t];return this.normalized&&(n=Ge(n,this.array)),n}setComponent(e,t,n){return this.normalized&&(n=je(n,this.array)),this.array[e*this.itemSize+t]=n,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=Ge(t,this.array)),t}setX(e,t){return this.normalized&&(t=je(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=Ge(t,this.array)),t}setY(e,t){return this.normalized&&(t=je(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=Ge(t,this.array)),t}setZ(e,t){return this.normalized&&(t=je(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=Ge(t,this.array)),t}setW(e,t){return this.normalized&&(t=je(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,n){return e*=this.itemSize,this.normalized&&(t=je(t,this.array),n=je(n,this.array)),this.array[e+0]=t,this.array[e+1]=n,this}setXYZ(e,t,n,i){return e*=this.itemSize,this.normalized&&(t=je(t,this.array),n=je(n,this.array),i=je(i,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this}setXYZW(e,t,n,i,r){return e*=this.itemSize,this.normalized&&(t=je(t,this.array),n=je(n,this.array),i=je(i,this.array),r=je(r,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this.array[e+3]=r,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),35044!==this.usage&&(e.usage=this.usage),e}},zn=class extends Bn{constructor(e,t,n){super(new Uint16Array(e),t,n)}},Vn=class extends Bn{constructor(e,t,n){super(new Uint32Array(e),t,n)}},Gn=class extends Bn{constructor(e,t,n){super(new Float32Array(e),t,n)}},jn=0;const Hn=new Gt,Wn=new gn,qn=new dt,Xn=new mt,$n=new mt,Yn=new dt;let Kn=class e extends Le{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:jn++}),this.uuid=Fe(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(function(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}(e)?Vn:zn)(e,1):this.index=e,this}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,n=0){this.groups.push({start:e,count:t,materialIndex:n})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const n=this.attributes.normal;if(void 0!==n){const t=(new qe).getNormalMatrix(e);n.applyNormalMatrix(t),n.needsUpdate=!0}const i=this.attributes.tangent;return void 0!==i&&(i.transformDirection(e),i.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return Hn.makeRotationFromQuaternion(e),this.applyMatrix4(Hn),this}rotateX(e){return Hn.makeRotationX(e),this.applyMatrix4(Hn),this}rotateY(e){return Hn.makeRotationY(e),this.applyMatrix4(Hn),this}rotateZ(e){return Hn.makeRotationZ(e),this.applyMatrix4(Hn),this}translate(e,t,n){return Hn.makeTranslation(e,t,n),this.applyMatrix4(Hn),this}scale(e,t,n){return Hn.makeScale(e,t,n),this.applyMatrix4(Hn),this}lookAt(e){return Wn.lookAt(e),Wn.updateMatrix(),this.applyMatrix4(Wn.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(qn).negate(),this.translate(qn.x,qn.y,qn.z),this}setFromPoints(e){const t=[];for(let n=0,i=e.length;n<i;n++){const i=e[n];t.push(i.x,i.y,i.z||0)}return this.setAttribute("position",new Gn(t,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new mt);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),void this.boundingBox.set(new dt(-1/0,-1/0,-1/0),new dt(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,n=t.length;e<n;e++){const n=t[e];Xn.setFromBufferAttribute(n),this.morphTargetsRelative?(Yn.addVectors(this.boundingBox.min,Xn.min),this.boundingBox.expandByPoint(Yn),Yn.addVectors(this.boundingBox.max,Xn.max),this.boundingBox.expandByPoint(Yn)):(this.boundingBox.expandByPoint(Xn.min),this.boundingBox.expandByPoint(Xn.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Lt);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),void this.boundingSphere.set(new dt,1/0);if(e){const n=this.boundingSphere.center;if(Xn.setFromBufferAttribute(e),t)for(let e=0,n=t.length;e<n;e++){const n=t[e];$n.setFromBufferAttribute(n),this.morphTargetsRelative?(Yn.addVectors(Xn.min,$n.min),Xn.expandByPoint(Yn),Yn.addVectors(Xn.max,$n.max),Xn.expandByPoint(Yn)):(Xn.expandByPoint($n.min),Xn.expandByPoint($n.max))}Xn.getCenter(n);let i=0;for(let t=0,r=e.count;t<r;t++)Yn.fromBufferAttribute(e,t),i=Math.max(i,n.distanceToSquared(Yn));if(t)for(let r=0,s=t.length;r<s;r++){const s=t[r],o=this.morphTargetsRelative;for(let t=0,r=s.count;t<r;t++)Yn.fromBufferAttribute(s,t),o&&(qn.fromBufferAttribute(e,t),Yn.add(qn)),i=Math.max(i,n.distanceToSquared(Yn))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const n=t.position,i=t.normal,r=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new Bn(new Float32Array(4*n.count),4));const s=this.getAttribute("tangent"),o=[],a=[];for(let e=0;e<n.count;e++)o[e]=new dt,a[e]=new dt;const l=new dt,c=new dt,u=new dt,h=new We,d=new We,p=new We,f=new dt,m=new dt;function g(e,t,i){l.fromBufferAttribute(n,e),c.fromBufferAttribute(n,t),u.fromBufferAttribute(n,i),h.fromBufferAttribute(r,e),d.fromBufferAttribute(r,t),p.fromBufferAttribute(r,i),c.sub(l),u.sub(l),d.sub(h),p.sub(h);const s=1/(d.x*p.y-p.x*d.y);isFinite(s)&&(f.copy(c).multiplyScalar(p.y).addScaledVector(u,-d.y).multiplyScalar(s),m.copy(u).multiplyScalar(d.x).addScaledVector(c,-p.x).multiplyScalar(s),o[e].add(f),o[t].add(f),o[i].add(f),a[e].add(m),a[t].add(m),a[i].add(m))}let y=this.groups;0===y.length&&(y=[{start:0,count:e.count}]);for(let t=0,n=y.length;t<n;++t){const n=y[t],i=n.start;for(let t=i,r=i+n.count;t<r;t+=3)g(e.getX(t+0),e.getX(t+1),e.getX(t+2))}const v=new dt,_=new dt,x=new dt,b=new dt;function w(e){x.fromBufferAttribute(i,e),b.copy(x);const t=o[e];v.copy(t),v.sub(x.multiplyScalar(x.dot(t))).normalize(),_.crossVectors(b,t);const n=_.dot(a[e])<0?-1:1;s.setXYZW(e,v.x,v.y,v.z,n)}for(let t=0,n=y.length;t<n;++t){const n=y[t],i=n.start;for(let t=i,r=i+n.count;t<r;t+=3)w(e.getX(t+0)),w(e.getX(t+1)),w(e.getX(t+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let n=this.getAttribute("normal");if(void 0===n)n=new Bn(new Float32Array(3*t.count),3),this.setAttribute("normal",n);else for(let e=0,t=n.count;e<t;e++)n.setXYZ(e,0,0,0);const i=new dt,r=new dt,s=new dt,o=new dt,a=new dt,l=new dt,c=new dt,u=new dt;if(e)for(let h=0,d=e.count;h<d;h+=3){const d=e.getX(h+0),p=e.getX(h+1),f=e.getX(h+2);i.fromBufferAttribute(t,d),r.fromBufferAttribute(t,p),s.fromBufferAttribute(t,f),c.subVectors(s,r),u.subVectors(i,r),c.cross(u),o.fromBufferAttribute(n,d),a.fromBufferAttribute(n,p),l.fromBufferAttribute(n,f),o.add(c),a.add(c),l.add(c),n.setXYZ(d,o.x,o.y,o.z),n.setXYZ(p,a.x,a.y,a.z),n.setXYZ(f,l.x,l.y,l.z)}else for(let e=0,o=t.count;e<o;e+=3)i.fromBufferAttribute(t,e+0),r.fromBufferAttribute(t,e+1),s.fromBufferAttribute(t,e+2),c.subVectors(s,r),u.subVectors(i,r),c.cross(u),n.setXYZ(e+0,c.x,c.y,c.z),n.setXYZ(e+1,c.x,c.y,c.z),n.setXYZ(e+2,c.x,c.y,c.z);this.normalizeNormals(),n.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,n=e.count;t<n;t++)Yn.fromBufferAttribute(e,t),Yn.normalize(),e.setXYZ(t,Yn.x,Yn.y,Yn.z)}toNonIndexed(){function t(e,t){const n=e.array,i=e.itemSize,r=e.normalized,s=new n.constructor(t.length*i);let o=0,a=0;for(let r=0,l=t.length;r<l;r++){o=e.isInterleavedBufferAttribute?t[r]*e.data.stride+e.offset:t[r]*i;for(let e=0;e<i;e++)s[a++]=n[o++]}return new Bn(s,i,r)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const n=new e,i=this.index.array,r=this.attributes;for(const e in r){const s=t(r[e],i);n.setAttribute(e,s)}const s=this.morphAttributes;for(const e in s){const r=[],o=s[e];for(let e=0,n=o.length;e<n;e++){const n=t(o[e],i);r.push(n)}n.morphAttributes[e]=r}n.morphTargetsRelative=this.morphTargetsRelative;const o=this.groups;for(let e=0,t=o.length;e<t;e++){const t=o[e];n.addGroup(t.start,t.count,t.materialIndex)}return n}toJSON(){const e={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const n in t)void 0!==t[n]&&(e[n]=t[n]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const n=this.attributes;for(const t in n){const i=n[t];e.data.attributes[t]=i.toJSON(e.data)}const i={};let r=!1;for(const t in this.morphAttributes){const n=this.morphAttributes[t],s=[];for(let t=0,i=n.length;t<i;t++){const i=n[t];s.push(i.toJSON(e.data))}s.length>0&&(i[t]=s,r=!0)}r&&(e.data.morphAttributes=i,e.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));const o=this.boundingSphere;return null!==o&&(e.data.boundingSphere={center:o.center.toArray(),radius:o.radius}),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const n=e.index;null!==n&&this.setIndex(n.clone(t));const i=e.attributes;for(const e in i){const n=i[e];this.setAttribute(e,n.clone(t))}const r=e.morphAttributes;for(const e in r){const n=[],i=r[e];for(let e=0,r=i.length;e<r;e++)n.push(i[e].clone(t));this.morphAttributes[e]=n}this.morphTargetsRelative=e.morphTargetsRelative;const s=e.groups;for(let e=0,t=s.length;e<t;e++){const t=s[e];this.addGroup(t.start,t.count,t.materialIndex)}const o=e.boundingBox;null!==o&&(this.boundingBox=o.clone());const a=e.boundingSphere;return null!==a&&(this.boundingSphere=a.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}};const Zn=new Gt,Jn=new Vt,Qn=new Lt,ei=new dt,ti=new dt,ni=new dt,ii=new dt,ri=new dt,si=new dt,oi=new We,ai=new We,li=new We,ci=new dt,ui=new dt,hi=new dt,di=new dt,pi=new dt;let fi=class extends gn{constructor(e=new Kn,t=new On){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const n=this.geometry,i=n.attributes.position,r=n.morphAttributes.position,s=n.morphTargetsRelative;t.fromBufferAttribute(i,e);const o=this.morphTargetInfluences;if(r&&o){si.set(0,0,0);for(let n=0,i=r.length;n<i;n++){const i=o[n],a=r[n];0!==i&&(ri.fromBufferAttribute(a,e),s?si.addScaledVector(ri,i):si.addScaledVector(ri.sub(t),i))}t.add(si)}return t}raycast(e,t){const n=this.geometry,i=this.material,r=this.matrixWorld;if(void 0!==i){if(null===n.boundingSphere&&n.computeBoundingSphere(),Qn.copy(n.boundingSphere),Qn.applyMatrix4(r),Jn.copy(e.ray).recast(e.near),!1===Qn.containsPoint(Jn.origin)){if(null===Jn.intersectSphere(Qn,ei))return;if(Jn.origin.distanceToSquared(ei)>(e.far-e.near)**2)return}Zn.copy(r).invert(),Jn.copy(e.ray).applyMatrix4(Zn),null!==n.boundingBox&&!1===Jn.intersectsBox(n.boundingBox)||this._computeIntersections(e,t,Jn)}}_computeIntersections(e,t,n){let i;const r=this.geometry,s=this.material,o=r.index,a=r.attributes.position,l=r.attributes.uv,c=r.attributes.uv1,u=r.attributes.normal,h=r.groups,d=r.drawRange;if(null!==o)if(Array.isArray(s))for(let r=0,a=h.length;r<a;r++){const a=h[r],p=s[a.materialIndex];for(let r=Math.max(a.start,d.start),s=Math.min(o.count,Math.min(a.start+a.count,d.start+d.count));r<s;r+=3){i=mi(this,p,e,n,l,c,u,o.getX(r),o.getX(r+1),o.getX(r+2)),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=a.materialIndex,t.push(i))}}else{for(let r=Math.max(0,d.start),a=Math.min(o.count,d.start+d.count);r<a;r+=3){i=mi(this,s,e,n,l,c,u,o.getX(r),o.getX(r+1),o.getX(r+2)),i&&(i.faceIndex=Math.floor(r/3),t.push(i))}}else if(void 0!==a)if(Array.isArray(s))for(let r=0,o=h.length;r<o;r++){const o=h[r],p=s[o.materialIndex];for(let r=Math.max(o.start,d.start),s=Math.min(a.count,Math.min(o.start+o.count,d.start+d.count));r<s;r+=3){i=mi(this,p,e,n,l,c,u,r,r+1,r+2),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=o.materialIndex,t.push(i))}}else{for(let r=Math.max(0,d.start),o=Math.min(a.count,d.start+d.count);r<o;r+=3){i=mi(this,s,e,n,l,c,u,r,r+1,r+2),i&&(i.faceIndex=Math.floor(r/3),t.push(i))}}}};function mi(e,t,n,i,r,s,o,a,l,c){e.getVertexPosition(a,ti),e.getVertexPosition(l,ni),e.getVertexPosition(c,ii);const u=function(e,t,n,i,r,s,o,a){let l;if(l=1===t.side?i.intersectTriangle(o,s,r,!0,a):i.intersectTriangle(r,s,o,0===t.side,a),null===l)return null;pi.copy(a),pi.applyMatrix4(e.matrixWorld);const c=n.ray.origin.distanceTo(pi);return c<n.near||c>n.far?null:{distance:c,point:pi.clone(),object:e}}(e,t,n,i,ti,ni,ii,di);if(u){r&&(oi.fromBufferAttribute(r,a),ai.fromBufferAttribute(r,l),li.fromBufferAttribute(r,c),u.uv=An.getInterpolation(di,ti,ni,ii,oi,ai,li,new We)),s&&(oi.fromBufferAttribute(s,a),ai.fromBufferAttribute(s,l),li.fromBufferAttribute(s,c),u.uv1=An.getInterpolation(di,ti,ni,ii,oi,ai,li,new We)),o&&(ci.fromBufferAttribute(o,a),ui.fromBufferAttribute(o,l),hi.fromBufferAttribute(o,c),u.normal=An.getInterpolation(di,ti,ni,ii,ci,ui,hi,new dt),u.normal.dot(i.direction)>0&&u.normal.multiplyScalar(-1));const e={a:a,b:l,c:c,normal:new dt,materialIndex:0};An.getNormal(ti,ni,ii,e.normal),u.face=e}return u}let gi=class extends gn{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Gt,this.projectionMatrix=new Gt,this.projectionMatrixInverse=new Gt,this.coordinateSystem=Pe}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}};const yi=new dt,vi=new We,_i=new We;let xi=class extends gi{constructor(e=50,t=1,n=.1,i=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=n,this.far=i,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*Ue*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*Oe*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*Ue*Math.atan(Math.tan(.5*Oe*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,n){yi.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(yi.x,yi.y).multiplyScalar(-e/yi.z),yi.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),n.set(yi.x,yi.y).multiplyScalar(-e/yi.z)}getViewSize(e,t){return this.getViewBounds(e,vi,_i),t.subVectors(_i,vi)}setViewOffset(e,t,n,i,r,s){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=i,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*Oe*this.fov)/this.zoom,n=2*t,i=this.aspect*n,r=-.5*i;const s=this.view;if(null!==this.view&&this.view.enabled){const e=s.fullWidth,o=s.fullHeight;r+=s.offsetX*i/e,t-=s.offsetY*n/o,i*=s.width/e,n*=s.height/o}const o=this.filmOffset;0!==o&&(r+=e*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+i,t,t-n,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}};const bi=new dt,wi=new dt,Ti=new qe;let Si=class{constructor(e=new dt(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,n,i){return this.normal.set(e,t,n),this.constant=i,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,n){const i=bi.subVectors(n,t).cross(wi.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(i,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const n=e.delta(bi),i=this.normal.dot(n);if(0===i)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const r=-(e.start.dot(this.normal)+this.constant)/i;return r<0||r>1?null:t.copy(e.start).addScaledVector(n,r)}intersectsLine(e){const t=this.distanceToPoint(e.start),n=this.distanceToPoint(e.end);return t<0&&n>0||n<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const n=t||Ti.getNormalMatrix(e),i=this.coplanarPoint(bi).applyMatrix4(e),r=this.normal.applyMatrix3(n).normalize();return this.constant=-i.dot(r),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}};const Mi=new Lt,Ei=new dt;let Ai=class{constructor(e=new Si,t=new Si,n=new Si,i=new Si,r=new Si,s=new Si){this.planes=[e,t,n,i,r,s]}set(e,t,n,i,r,s){const o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(n),o[3].copy(i),o[4].copy(r),o[5].copy(s),this}copy(e){const t=this.planes;for(let n=0;n<6;n++)t[n].copy(e.planes[n]);return this}setFromProjectionMatrix(e,t=2e3){const n=this.planes,i=e.elements,r=i[0],s=i[1],o=i[2],a=i[3],l=i[4],c=i[5],u=i[6],h=i[7],d=i[8],p=i[9],f=i[10],m=i[11],g=i[12],y=i[13],v=i[14],_=i[15];if(n[0].setComponents(a-r,h-l,m-d,_-g).normalize(),n[1].setComponents(a+r,h+l,m+d,_+g).normalize(),n[2].setComponents(a+s,h+c,m+p,_+y).normalize(),n[3].setComponents(a-s,h-c,m-p,_-y).normalize(),n[4].setComponents(a-o,h-u,m-f,_-v).normalize(),t===Pe)n[5].setComponents(a+o,h+u,m+f,_+v).normalize();else{if(t!==De)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);n[5].setComponents(o,u,f,v).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),Mi.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),Mi.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(Mi)}intersectsSprite(e){return Mi.center.set(0,0,0),Mi.radius=.7071067811865476,Mi.applyMatrix4(e.matrixWorld),this.intersectsSphere(Mi)}intersectsSphere(e){const t=this.planes,n=e.center,i=-e.radius;for(let e=0;e<6;e++){if(t[e].distanceToPoint(n)<i)return!1}return!0}intersectsBox(e){const t=this.planes;for(let n=0;n<6;n++){const i=t[n];if(Ei.x=i.normal.x>0?e.max.x:e.min.x,Ei.y=i.normal.y>0?e.max.y:e.min.y,Ei.z=i.normal.z>0?e.max.z:e.min.z,i.distanceToPoint(Ei)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let n=0;n<6;n++)if(t[n].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}},Ci=class extends gi{constructor(e=-1,t=1,n=1,i=-1,r=.1,s=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=n,this.bottom=i,this.near=r,this.far=s,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,n,i,r,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=i,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let r=n-e,s=n+e,o=i+t,a=i-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=e*this.view.offsetX,s=r+e*this.view.width,o-=t*this.view.offsetY,a=o-t*this.view.height}this.projectionMatrix.makeOrthographic(r,s,o,a,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}},Ri=class extends ct{constructor(e,t,n,i,r,s,o,a,l,c){if((c=void 0!==c?c:_e)!==_e&&1027!==c)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===n&&c===_e&&(n=1014),void 0===n&&1027===c&&(n=1020),super(null,i,r,s,o,a,c,n,l),this.isDepthTexture=!0,this.image={width:e,height:t},this.magFilter=void 0!==o?o:ge,this.minFilter=void 0!==a?a:ge,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}};new Ri(1,1).compareFunction=515;let Ni=class extends gn{constructor(){super(),this.isGroup=!0,this.type="Group"}},Pi=class extends gn{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new Jt,this.environmentIntensity=1,this.environmentRotation=new Jt,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}};const Di=new dt,Li=new ut,Ii=new ut,ki=new dt,Oi=new Gt,Ui=new dt,Fi=new Lt,Bi=new Gt,zi=new Vt;class Vi extends fi{constructor(e,t){super(e,t),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=pe,this.bindMatrix=new Gt,this.bindMatrixInverse=new Gt,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){const e=this.geometry;null===this.boundingBox&&(this.boundingBox=new mt),this.boundingBox.makeEmpty();const t=e.getAttribute("position");for(let e=0;e<t.count;e++)this.getVertexPosition(e,Ui),this.boundingBox.expandByPoint(Ui)}computeBoundingSphere(){const e=this.geometry;null===this.boundingSphere&&(this.boundingSphere=new Lt),this.boundingSphere.makeEmpty();const t=e.getAttribute("position");for(let e=0;e<t.count;e++)this.getVertexPosition(e,Ui),this.boundingSphere.expandByPoint(Ui)}copy(e,t){return super.copy(e,t),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}raycast(e,t){const n=this.material,i=this.matrixWorld;void 0!==n&&(null===this.boundingSphere&&this.computeBoundingSphere(),Fi.copy(this.boundingSphere),Fi.applyMatrix4(i),!1!==e.ray.intersectsSphere(Fi)&&(Bi.copy(i).invert(),zi.copy(e.ray).applyMatrix4(Bi),null!==this.boundingBox&&!1===zi.intersectsBox(this.boundingBox)||this._computeIntersections(e,t,zi)))}getVertexPosition(e,t){return super.getVertexPosition(e,t),this.applyBoneTransform(e,t),t}bind(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const e=new ut,t=this.geometry.attributes.skinWeight;for(let n=0,i=t.count;n<i;n++){e.fromBufferAttribute(t,n);const i=1/e.manhattanLength();i!==1/0?e.multiplyScalar(i):e.set(1,0,0,0),t.setXYZW(n,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.bindMode===pe?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}applyBoneTransform(e,t){const n=this.skeleton,i=this.geometry;Li.fromBufferAttribute(i.attributes.skinIndex,e),Ii.fromBufferAttribute(i.attributes.skinWeight,e),Di.copy(t).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let e=0;e<4;e++){const i=Ii.getComponent(e);if(0!==i){const r=Li.getComponent(e);Oi.multiplyMatrices(n.bones[r].matrixWorld,n.boneInverses[r]),t.addScaledVector(ki.copy(Di).applyMatrix4(Oi),i)}}return t.applyMatrix4(this.bindMatrixInverse)}}class Gi extends gn{constructor(){super(),this.isBone=!0,this.type="Bone"}}let ji=class extends ct{constructor(e=null,t=1,n=1,i,r,s,o,a,l=1003,c=1003,u,h){super(null,s,o,a,l,c,i,r,u,h),this.isDataTexture=!0,this.image={data:e,width:t,height:n},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}};const Hi=new Gt,Wi=new Gt;class qi{constructor(e=[],t=[]){this.uuid=Fe(),this.bones=e.slice(0),this.boneInverses=t,this.boneMatrices=null,this.boneTexture=null,this.init()}init(){const e=this.bones,t=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===t.length)this.calculateInverses();else if(e.length!==t.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let e=0,t=this.bones.length;e<t;e++)this.boneInverses.push(new Gt)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,t=this.bones.length;e<t;e++){const t=new Gt;this.bones[e]&&t.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(t)}}pose(){for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&t.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&(t.parent&&t.parent.isBone?(t.matrix.copy(t.parent.matrixWorld).invert(),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))}}update(){const e=this.bones,t=this.boneInverses,n=this.boneMatrices,i=this.boneTexture;for(let i=0,r=e.length;i<r;i++){const r=e[i]?e[i].matrixWorld:Wi;Hi.multiplyMatrices(r,t[i]),Hi.toArray(n,16*i)}null!==i&&(i.needsUpdate=!0)}clone(){return new qi(this.bones,this.boneInverses)}computeBoneTexture(){let e=Math.sqrt(4*this.bones.length);e=4*Math.ceil(e/4),e=Math.max(e,4);const t=new Float32Array(e*e*4);t.set(this.boneMatrices);const n=new ji(t,e,e,1023,1015);return n.needsUpdate=!0,this.boneMatrices=t,this.boneTexture=n,this}getBoneByName(e){for(let t=0,n=this.bones.length;t<n;t++){const n=this.bones[t];if(n.name===e)return n}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,t){this.uuid=e.uuid;for(let n=0,i=e.bones.length;n<i;n++){const i=e.bones[n];let r=t[i];void 0===r&&(console.warn("THREE.Skeleton: No bone found with UUID:",i),r=new Gi),this.bones.push(r),this.boneInverses.push((new Gt).fromArray(e.boneInverses[n]))}return this.init(),this}toJSON(){const e={metadata:{version:4.6,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;const t=this.bones,n=this.boneInverses;for(let i=0,r=t.length;i<r;i++){const r=t[i];e.bones.push(r.uuid);const s=n[i];e.boneInverses.push(s.toArray())}return e}}let Xi=class extends kn{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Dn(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}};const $i=new dt,Yi=new dt,Ki=new Gt,Zi=new Vt,Ji=new Lt,Qi=new dt,er=new dt;let tr=class extends gn{constructor(e=new Kn,t=new Xi){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,n=[0];for(let e=1,i=t.count;e<i;e++)$i.fromBufferAttribute(t,e-1),Yi.fromBufferAttribute(t,e),n[e]=n[e-1],n[e]+=$i.distanceTo(Yi);e.setAttribute("lineDistance",new Gn(n,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,t){const n=this.geometry,i=this.matrixWorld,r=e.params.Line.threshold,s=n.drawRange;if(null===n.boundingSphere&&n.computeBoundingSphere(),Ji.copy(n.boundingSphere),Ji.applyMatrix4(i),Ji.radius+=r,!1===e.ray.intersectsSphere(Ji))return;Ki.copy(i).invert(),Zi.copy(e.ray).applyMatrix4(Ki);const o=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=o*o,l=this.isLineSegments?2:1,c=n.index,u=n.attributes.position;if(null!==c){const n=Math.max(0,s.start),i=Math.min(c.count,s.start+s.count);for(let r=n,s=i-1;r<s;r+=l){const n=c.getX(r),i=c.getX(r+1),s=nr(this,e,Zi,a,n,i);s&&t.push(s)}if(this.isLineLoop){const r=c.getX(i-1),s=c.getX(n),o=nr(this,e,Zi,a,r,s);o&&t.push(o)}}else{const n=Math.max(0,s.start),i=Math.min(u.count,s.start+s.count);for(let r=n,s=i-1;r<s;r+=l){const n=nr(this,e,Zi,a,r,r+1);n&&t.push(n)}if(this.isLineLoop){const r=nr(this,e,Zi,a,i-1,n);r&&t.push(r)}}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}};function nr(e,t,n,i,r,s){const o=e.geometry.attributes.position;$i.fromBufferAttribute(o,r),Yi.fromBufferAttribute(o,s);if(n.distanceSqToSegment($i,Yi,Qi,er)>i)return;Qi.applyMatrix4(e.matrixWorld);const a=t.ray.origin.distanceTo(Qi);return a<t.near||a>t.far?void 0:{distance:a,point:er.clone().applyMatrix4(e.matrixWorld),index:r,face:null,faceIndex:null,object:e}}const ir=new dt,rr=new dt;class sr extends tr{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,n=[];for(let e=0,i=t.count;e<i;e+=2)ir.fromBufferAttribute(t,e),rr.fromBufferAttribute(t,e+1),n[e]=0===e?0:n[e-1],n[e+1]=n[e]+ir.distanceTo(rr);e.setAttribute("lineDistance",new Gn(n,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}let or=class{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return console.warn("THREE.Curve: .getPoint() not implemented."),null}getPointAt(e,t){const n=this.getUtoTmapping(e);return this.getPoint(n,t)}getPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return t}getSpacedPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPointAt(n/e));return t}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let n,i=this.getPoint(0),r=0;t.push(0);for(let s=1;s<=e;s++)n=this.getPoint(s/e),r+=n.distanceTo(i),t.push(r),i=n;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t){const n=this.getLengths();let i=0;const r=n.length;let s;s=t||e*n[r-1];let o,a=0,l=r-1;for(;a<=l;)if(i=Math.floor(a+(l-a)/2),o=n[i]-s,o<0)a=i+1;else{if(!(o>0)){l=i;break}l=i-1}if(i=l,n[i]===s)return i/(r-1);const c=n[i];return(i+(s-c)/(n[i+1]-c))/(r-1)}getTangent(e,t){const n=1e-4;let i=e-n,r=e+n;i<0&&(i=0),r>1&&(r=1);const s=this.getPoint(i),o=this.getPoint(r),a=t||(s.isVector2?new We:new dt);return a.copy(o).sub(s).normalize(),a}getTangentAt(e,t){const n=this.getUtoTmapping(e);return this.getTangent(n,t)}computeFrenetFrames(e,t){const n=new dt,i=[],r=[],s=[],o=new dt,a=new Gt;for(let t=0;t<=e;t++){const n=t/e;i[t]=this.getTangentAt(n,new dt)}r[0]=new dt,s[0]=new dt;let l=Number.MAX_VALUE;const c=Math.abs(i[0].x),u=Math.abs(i[0].y),h=Math.abs(i[0].z);c<=l&&(l=c,n.set(1,0,0)),u<=l&&(l=u,n.set(0,1,0)),h<=l&&n.set(0,0,1),o.crossVectors(i[0],n).normalize(),r[0].crossVectors(i[0],o),s[0].crossVectors(i[0],r[0]);for(let t=1;t<=e;t++){if(r[t]=r[t-1].clone(),s[t]=s[t-1].clone(),o.crossVectors(i[t-1],i[t]),o.length()>Number.EPSILON){o.normalize();const e=Math.acos(Be(i[t-1].dot(i[t]),-1,1));r[t].applyMatrix4(a.makeRotationAxis(o,e))}s[t].crossVectors(i[t],r[t])}if(!0===t){let t=Math.acos(Be(r[0].dot(r[e]),-1,1));t/=e,i[0].dot(o.crossVectors(r[0],r[e]))>0&&(t=-t);for(let n=1;n<=e;n++)r[n].applyMatrix4(a.makeRotationAxis(i[n],t*n)),s[n].crossVectors(i[n],r[n])}return{tangents:i,normals:r,binormals:s}}clone(){return(new this.constructor).copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.6,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}};const ar=function(e,t,n=2){const i=t&&t.length,r=i?t[0]*n:e.length;let s=lr(e,0,r,n,!0);const o=[];if(!s||s.next===s.prev)return o;let a,l,c,u,h,d,p;if(i&&(s=function(e,t,n,i){const r=[];let s,o,a,l,c;for(s=0,o=t.length;s<o;s++)a=t[s]*i,l=s<o-1?t[s+1]*i:e.length,c=lr(e,a,l,i,!1),c===c.next&&(c.steiner=!0),r.push(_r(c));for(r.sort(mr),s=0;s<r.length;s++)n=gr(r[s],n);return n}(e,t,s,n)),e.length>80*n){a=c=e[0],l=u=e[1];for(let t=n;t<r;t+=n)h=e[t],d=e[t+1],h<a&&(a=h),d<l&&(l=d),h>c&&(c=h),d>u&&(u=d);p=Math.max(c-a,u-l),p=0!==p?32767/p:0}return ur(s,o,n,a,l,p,0),o};function lr(e,t,n,i,r){let s,o;if(r===function(e,t,n,i){let r=0;for(let s=t,o=n-i;s<n;s+=i)r+=(e[o]-e[s])*(e[s+1]+e[o+1]),o=s;return r}(e,t,n,i)>0)for(s=t;s<n;s+=i)o=Rr(s,e[s],e[s+1],o);else for(s=n-i;s>=t;s-=i)o=Rr(s,e[s],e[s+1],o);return o&&Tr(o,o.next)&&(Nr(o),o=o.next),o}function cr(e,t){if(!e)return e;t||(t=e);let n,i=e;do{if(n=!1,i.steiner||!Tr(i,i.next)&&0!==wr(i.prev,i,i.next))i=i.next;else{if(Nr(i),i=t=i.prev,i===i.next)break;n=!0}}while(n||i!==t);return t}function ur(e,t,n,i,r,s,o){if(!e)return;!o&&s&&function(e,t,n,i){let r=e;do{0===r.z&&(r.z=vr(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){let t,n,i,r,s,o,a,l,c=1;do{for(n=e,e=null,s=null,o=0;n;){for(o++,i=n,a=0,t=0;t<c&&(a++,i=i.nextZ,i);t++);for(l=c;a>0||l>0&&i;)0!==a&&(0===l||!i||n.z<=i.z)?(r=n,n=n.nextZ,a--):(r=i,i=i.nextZ,l--),s?s.nextZ=r:e=r,r.prevZ=s,s=r;n=i}s.nextZ=null,c*=2}while(o>1)}(r)}(e,i,r,s);let a,l,c=e;for(;e.prev!==e.next;)if(a=e.prev,l=e.next,s?dr(e,i,r,s):hr(e))t.push(a.i/n|0),t.push(e.i/n|0),t.push(l.i/n|0),Nr(e),e=l.next,c=l.next;else if((e=l)===c){o?1===o?ur(e=pr(cr(e),t,n),t,n,i,r,s,2):2===o&&fr(e,t,n,i,r,s):ur(cr(e),t,n,i,r,s,1);break}}function hr(e){const t=e.prev,n=e,i=e.next;if(wr(t,n,i)>=0)return!1;const r=t.x,s=n.x,o=i.x,a=t.y,l=n.y,c=i.y,u=r<s?r<o?r:o:s<o?s:o,h=a<l?a<c?a:c:l<c?l:c,d=r>s?r>o?r:o:s>o?s:o,p=a>l?a>c?a:c:l>c?l:c;let f=i.next;for(;f!==t;){if(f.x>=u&&f.x<=d&&f.y>=h&&f.y<=p&&xr(r,a,s,l,o,c,f.x,f.y)&&wr(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function dr(e,t,n,i){const r=e.prev,s=e,o=e.next;if(wr(r,s,o)>=0)return!1;const a=r.x,l=s.x,c=o.x,u=r.y,h=s.y,d=o.y,p=a<l?a<c?a:c:l<c?l:c,f=u<h?u<d?u:d:h<d?h:d,m=a>l?a>c?a:c:l>c?l:c,g=u>h?u>d?u:d:h>d?h:d,y=vr(p,f,t,n,i),v=vr(m,g,t,n,i);let _=e.prevZ,x=e.nextZ;for(;_&&_.z>=y&&x&&x.z<=v;){if(_.x>=p&&_.x<=m&&_.y>=f&&_.y<=g&&_!==r&&_!==o&&xr(a,u,l,h,c,d,_.x,_.y)&&wr(_.prev,_,_.next)>=0)return!1;if(_=_.prevZ,x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==o&&xr(a,u,l,h,c,d,x.x,x.y)&&wr(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;_&&_.z>=y;){if(_.x>=p&&_.x<=m&&_.y>=f&&_.y<=g&&_!==r&&_!==o&&xr(a,u,l,h,c,d,_.x,_.y)&&wr(_.prev,_,_.next)>=0)return!1;_=_.prevZ}for(;x&&x.z<=v;){if(x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==o&&xr(a,u,l,h,c,d,x.x,x.y)&&wr(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function pr(e,t,n){let i=e;do{const r=i.prev,s=i.next.next;!Tr(r,s)&&Sr(r,i,i.next,s)&&Ar(r,s)&&Ar(s,r)&&(t.push(r.i/n|0),t.push(i.i/n|0),t.push(s.i/n|0),Nr(i),Nr(i.next),i=e=s),i=i.next}while(i!==e);return cr(i)}function fr(e,t,n,i,r,s){let o=e;do{let e=o.next.next;for(;e!==o.prev;){if(o.i!==e.i&&br(o,e)){let a=Cr(o,e);return o=cr(o,o.next),a=cr(a,a.next),ur(o,t,n,i,r,s,0),void ur(a,t,n,i,r,s,0)}e=e.next}o=o.next}while(o!==e)}function mr(e,t){return e.x-t.x}function gr(e,t){const n=function(e,t){let n,i=t,r=-1/0;const s=e.x,o=e.y;do{if(o<=i.y&&o>=i.next.y&&i.next.y!==i.y){const e=i.x+(o-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(e<=s&&e>r&&(r=e,n=i.x<i.next.x?i:i.next,e===s))return n}i=i.next}while(i!==t);if(!n)return null;const a=n,l=n.x,c=n.y;let u,h=1/0;i=n;do{s>=i.x&&i.x>=l&&s!==i.x&&xr(o<c?s:r,o,l,c,o<c?r:s,o,i.x,i.y)&&(u=Math.abs(o-i.y)/(s-i.x),Ar(i,e)&&(u<h||u===h&&(i.x>n.x||i.x===n.x&&yr(n,i)))&&(n=i,h=u)),i=i.next}while(i!==a);return n}(e,t);if(!n)return t;const i=Cr(n,e);return cr(i,i.next),cr(n,n.next)}function yr(e,t){return wr(e.prev,e,t.prev)<0&&wr(t.next,e,e.next)<0}function vr(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function _r(e){let t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function xr(e,t,n,i,r,s,o,a){return(r-o)*(t-a)>=(e-o)*(s-a)&&(e-o)*(i-a)>=(n-o)*(t-a)&&(n-o)*(s-a)>=(r-o)*(i-a)}function br(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&Sr(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(Ar(e,t)&&Ar(t,e)&&function(e,t){let n=e,i=!1;const r=(e.x+t.x)/2,s=(e.y+t.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&r<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)&&(wr(e.prev,e,t.prev)||wr(e,t.prev,t))||Tr(e,t)&&wr(e.prev,e,e.next)>0&&wr(t.prev,t,t.next)>0)}function wr(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function Tr(e,t){return e.x===t.x&&e.y===t.y}function Sr(e,t,n,i){const r=Er(wr(e,t,n)),s=Er(wr(e,t,i)),o=Er(wr(n,i,e)),a=Er(wr(n,i,t));return r!==s&&o!==a||(!(0!==r||!Mr(e,n,t))||(!(0!==s||!Mr(e,i,t))||(!(0!==o||!Mr(n,e,i))||!(0!==a||!Mr(n,t,i)))))}function Mr(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function Er(e){return e>0?1:e<0?-1:0}function Ar(e,t){return wr(e.prev,e,e.next)<0?wr(e,t,e.next)>=0&&wr(e,e.prev,t)>=0:wr(e,t,e.prev)<0||wr(e,e.next,t)<0}function Cr(e,t){const n=new Pr(e.i,e.x,e.y),i=new Pr(t.i,t.x,t.y),r=e.next,s=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,s.next=i,i.prev=s,i}function Rr(e,t,n,i){const r=new Pr(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function Nr(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Pr(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}class Dr{static area(e){const t=e.length;let n=0;for(let i=t-1,r=0;r<t;i=r++)n+=e[i].x*e[r].y-e[r].x*e[i].y;return.5*n}static isClockWise(e){return Dr.area(e)<0}static triangulateShape(e,t){const n=[],i=[],r=[];Lr(e),Ir(n,e);let s=e.length;t.forEach(Lr);for(let e=0;e<t.length;e++)i.push(s),s+=t[e].length,Ir(n,t[e]);const o=ar(n,i);for(let e=0;e<o.length;e+=3)r.push(o.slice(e,e+3));return r}}function Lr(e){const t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function Ir(e,t){for(let n=0;n<t.length;n++)e.push(t[n].x),e.push(t[n].y)}let kr=class extends kn{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new Dn(16777215),this.specular=new Dn(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Dn(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new We(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Jt,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}},Or=class extends kn{constructor(e){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new Dn(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Dn(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new We(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Jt,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}};function Ur(e,t,n){return!e||!n&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)}function Fr(e){const t=e.length,n=new Array(t);for(let e=0;e!==t;++e)n[e]=e;return n.sort((function(t,n){return e[t]-e[n]})),n}function Br(e,t,n){const i=e.length,r=new e.constructor(i);for(let s=0,o=0;o!==i;++s){const i=n[s]*t;for(let n=0;n!==t;++n)r[o++]=e[i+n]}return r}function zr(e,t,n,i){let r=1,s=e[0];for(;void 0!==s&&void 0===s[i];)s=e[r++];if(void 0===s)return;let o=s[i];if(void 0!==o)if(Array.isArray(o))do{o=s[i],void 0!==o&&(t.push(s.time),n.push.apply(n,o)),s=e[r++]}while(void 0!==s);else if(void 0!==o.toArray)do{o=s[i],void 0!==o&&(t.push(s.time),o.toArray(n,n.length)),s=e[r++]}while(void 0!==s);else do{o=s[i],void 0!==o&&(t.push(s.time),n.push(o)),s=e[r++]}while(void 0!==s)}class Vr{constructor(e,t,n,i){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==i?i:new t.constructor(n),this.sampleValues=t,this.valueSize=n,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let n=this._cachedIndex,i=t[n],r=t[n-1];e:{t:{let s;n:{i:if(!(e<i)){for(let s=n+2;;){if(void 0===i){if(e<r)break i;return n=t.length,this._cachedIndex=n,this.copySampleValue_(n-1)}if(n===s)break;if(r=i,i=t[++n],e<i)break t}s=t.length;break n}if(e>=r)break e;{const o=t[1];e<o&&(n=2,r=o);for(let s=n-2;;){if(void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(n===s)break;if(i=r,r=t[--n-1],e>=r)break t}s=n,n=0}}for(;n<s;){const i=n+s>>>1;e<t[i]?s=i:n=i+1}if(i=t[n],r=t[n-1],void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===i)return n=t.length,this._cachedIndex=n,this.copySampleValue_(n-1)}this._cachedIndex=n,this.intervalChanged_(n,r,i)}return this.interpolate_(n,r,e,i)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,i=this.valueSize,r=e*i;for(let e=0;e!==i;++e)t[e]=n[r+e];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class Gr extends Vr{constructor(e,t,n,i){super(e,t,n,i),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(e,t,n){const i=this.parameterPositions;let r=e-2,s=e+1,o=i[r],a=i[s];if(void 0===o)switch(this.getSettings_().endingStart){case 2401:r=e,o=2*t-n;break;case 2402:r=i.length-2,o=t+i[r]-i[r+1];break;default:r=e,o=n}if(void 0===a)switch(this.getSettings_().endingEnd){case 2401:s=e,a=2*n-t;break;case 2402:s=1,a=n+i[1]-i[0];break;default:s=e-1,a=t}const l=.5*(n-t),c=this.valueSize;this._weightPrev=l/(t-o),this._weightNext=l/(a-n),this._offsetPrev=r*c,this._offsetNext=s*c}interpolate_(e,t,n,i){const r=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=e*o,l=a-o,c=this._offsetPrev,u=this._offsetNext,h=this._weightPrev,d=this._weightNext,p=(n-t)/(i-t),f=p*p,m=f*p,g=-h*m+2*h*f-h*p,y=(1+h)*m+(-1.5-2*h)*f+(-.5+h)*p+1,v=(-1-d)*m+(1.5+d)*f+.5*p,_=d*m-d*f;for(let e=0;e!==o;++e)r[e]=g*s[c+e]+y*s[l+e]+v*s[a+e]+_*s[u+e];return r}}class jr extends Vr{constructor(e,t,n,i){super(e,t,n,i)}interpolate_(e,t,n,i){const r=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=e*o,l=a-o,c=(n-t)/(i-t),u=1-c;for(let e=0;e!==o;++e)r[e]=s[l+e]*u+s[a+e]*c;return r}}class Hr extends Vr{constructor(e,t,n,i){super(e,t,n,i)}interpolate_(e){return this.copySampleValue_(e-1)}}class Wr{constructor(e,t,n,i){if(void 0===e)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===t||0===t.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=Ur(t,this.TimeBufferType),this.values=Ur(n,this.ValueBufferType),this.setInterpolation(i||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let n;if(t.toJSON!==this.toJSON)n=t.toJSON(e);else{n={name:e.name,times:Ur(e.times,Array),values:Ur(e.values,Array)};const t=e.getInterpolation();t!==e.DefaultInterpolation&&(n.interpolation=t)}return n.type=e.ValueTypeName,n}InterpolantFactoryMethodDiscrete(e){return new Hr(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new jr(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new Gr(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case xe:t=this.InterpolantFactoryMethodDiscrete;break;case be:t=this.InterpolantFactoryMethodLinear;break;case we:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){const t="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(t);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",t),this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return xe;case this.InterpolantFactoryMethodLinear:return be;case this.InterpolantFactoryMethodSmooth:return we}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){const t=this.times;for(let n=0,i=t.length;n!==i;++n)t[n]+=e}return this}scale(e){if(1!==e){const t=this.times;for(let n=0,i=t.length;n!==i;++n)t[n]*=e}return this}trim(e,t){const n=this.times,i=n.length;let r=0,s=i-1;for(;r!==i&&n[r]<e;)++r;for(;-1!==s&&n[s]>t;)--s;if(++s,0!==r||s!==i){r>=s&&(s=Math.max(s,1),r=s-1);const e=this.getValueSize();this.times=n.slice(r,s),this.values=this.values.slice(r*e,s*e)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!==0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),e=!1);const n=this.times,i=this.values,r=n.length;0===r&&(console.error("THREE.KeyframeTrack: Track is empty.",this),e=!1);let s=null;for(let t=0;t!==r;t++){const i=n[t];if("number"==typeof i&&isNaN(i)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,t,i),e=!1;break}if(null!==s&&s>i){console.error("THREE.KeyframeTrack: Out of order keys.",this,t,i,s),e=!1;break}s=i}if(void 0!==i&&(o=i,ArrayBuffer.isView(o)&&!(o instanceof DataView)))for(let t=0,n=i.length;t!==n;++t){const n=i[t];if(isNaN(n)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,t,n),e=!1;break}}var o;return e}optimize(){const e=this.times.slice(),t=this.values.slice(),n=this.getValueSize(),i=this.getInterpolation()===we,r=e.length-1;let s=1;for(let o=1;o<r;++o){let r=!1;const a=e[o];if(a!==e[o+1]&&(1!==o||a!==e[0]))if(i)r=!0;else{const e=o*n,i=e-n,s=e+n;for(let o=0;o!==n;++o){const n=t[e+o];if(n!==t[i+o]||n!==t[s+o]){r=!0;break}}}if(r){if(o!==s){e[s]=e[o];const i=o*n,r=s*n;for(let e=0;e!==n;++e)t[r+e]=t[i+e]}++s}}if(r>0){e[s]=e[r];for(let e=r*n,i=s*n,o=0;o!==n;++o)t[i+o]=t[e+o];++s}return s!==e.length?(this.times=e.slice(0,s),this.values=t.slice(0,s*n)):(this.times=e,this.values=t),this}clone(){const e=this.times.slice(),t=this.values.slice(),n=new(0,this.constructor)(this.name,e,t);return n.createInterpolant=this.createInterpolant,n}}Wr.prototype.TimeBufferType=Float32Array,Wr.prototype.ValueBufferType=Float32Array,Wr.prototype.DefaultInterpolation=be;class qr extends Wr{}qr.prototype.ValueTypeName="bool",qr.prototype.ValueBufferType=Array,qr.prototype.DefaultInterpolation=xe,qr.prototype.InterpolantFactoryMethodLinear=void 0,qr.prototype.InterpolantFactoryMethodSmooth=void 0;class Xr extends Wr{}Xr.prototype.ValueTypeName="color";class $r extends Wr{}$r.prototype.ValueTypeName="number";class Yr extends Vr{constructor(e,t,n,i){super(e,t,n,i)}interpolate_(e,t,n,i){const r=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=(n-t)/(i-t);let l=e*o;for(let e=l+o;l!==e;l+=4)ht.slerpFlat(r,0,s,l-o,s,l,a);return r}}class Kr extends Wr{InterpolantFactoryMethodLinear(e){return new Yr(this.times,this.values,this.getValueSize(),e)}}Kr.prototype.ValueTypeName="quaternion",Kr.prototype.DefaultInterpolation=be,Kr.prototype.InterpolantFactoryMethodSmooth=void 0;class Zr extends Wr{}Zr.prototype.ValueTypeName="string",Zr.prototype.ValueBufferType=Array,Zr.prototype.DefaultInterpolation=xe,Zr.prototype.InterpolantFactoryMethodLinear=void 0,Zr.prototype.InterpolantFactoryMethodSmooth=void 0;class Jr extends Wr{}Jr.prototype.ValueTypeName="vector";class Qr{constructor(e="",t=-1,n=[],i=2500){this.name=e,this.tracks=n,this.duration=t,this.blendMode=i,this.uuid=Fe(),this.duration<0&&this.resetDuration()}static parse(e){const t=[],n=e.tracks,i=1/(e.fps||1);for(let e=0,r=n.length;e!==r;++e)t.push(es(n[e]).scale(i));const r=new this(e.name,e.duration,t,e.blendMode);return r.uuid=e.uuid,r}static toJSON(e){const t=[],n=e.tracks,i={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode};for(let e=0,i=n.length;e!==i;++e)t.push(Wr.toJSON(n[e]));return i}static CreateFromMorphTargetSequence(e,t,n,i){const r=t.length,s=[];for(let e=0;e<r;e++){let o=[],a=[];o.push((e+r-1)%r,e,(e+1)%r),a.push(0,1,0);const l=Fr(o);o=Br(o,1,l),a=Br(a,1,l),i||0!==o[0]||(o.push(r),a.push(a[0])),s.push(new $r(".morphTargetInfluences["+t[e].name+"]",o,a).scale(1/n))}return new this(e,-1,s)}static findByName(e,t){let n=e;if(!Array.isArray(e)){const t=e;n=t.geometry&&t.geometry.animations||t.animations}for(let e=0;e<n.length;e++)if(n[e].name===t)return n[e];return null}static CreateClipsFromMorphTargetSequences(e,t,n){const i={},r=/^([\w-]*?)([\d]+)$/;for(let t=0,n=e.length;t<n;t++){const n=e[t],s=n.name.match(r);if(s&&s.length>1){const e=s[1];let t=i[e];t||(i[e]=t=[]),t.push(n)}}const s=[];for(const e in i)s.push(this.CreateFromMorphTargetSequence(e,i[e],t,n));return s}static parseAnimation(e,t){if(!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const n=function(e,t,n,i,r){if(0!==n.length){const s=[],o=[];zr(n,s,o,i),0!==s.length&&r.push(new e(t,s,o))}},i=[],r=e.name||"default",s=e.fps||30,o=e.blendMode;let a=e.length||-1;const l=e.hierarchy||[];for(let e=0;e<l.length;e++){const r=l[e].keys;if(r&&0!==r.length)if(r[0].morphTargets){const e={};let t;for(t=0;t<r.length;t++)if(r[t].morphTargets)for(let n=0;n<r[t].morphTargets.length;n++)e[r[t].morphTargets[n]]=-1;for(const n in e){const e=[],s=[];for(let i=0;i!==r[t].morphTargets.length;++i){const i=r[t];e.push(i.time),s.push(i.morphTarget===n?1:0)}i.push(new $r(".morphTargetInfluence["+n+"]",e,s))}a=e.length*s}else{const s=".bones["+t[e].name+"]";n(Jr,s+".position",r,"pos",i),n(Kr,s+".quaternion",r,"rot",i),n(Jr,s+".scale",r,"scl",i)}}if(0===i.length)return null;return new this(r,a,i,o)}resetDuration(){let e=0;for(let t=0,n=this.tracks.length;t!==n;++t){const n=this.tracks[t];e=Math.max(e,n.times[n.times.length-1])}return this.duration=e,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function es(e){if(void 0===e.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const t=function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return $r;case"vector":case"vector2":case"vector3":case"vector4":return Jr;case"color":return Xr;case"quaternion":return Kr;case"bool":case"boolean":return qr;case"string":return Zr}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}(e.type);if(void 0===e.times){const t=[],n=[];zr(e.keys,t,n,"value"),e.times=t,e.values=n}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)}const ts={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};let ns=class{constructor(e,t,n){const i=this;let r,s=!1,o=0,a=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=n,this.itemStart=function(e){a++,!1===s&&void 0!==i.onStart&&i.onStart(e,o,a),s=!0},this.itemEnd=function(e){o++,void 0!==i.onProgress&&i.onProgress(e,o,a),o===a&&(s=!1,void 0!==i.onLoad&&i.onLoad())},this.itemError=function(e){void 0!==i.onError&&i.onError(e)},this.resolveURL=function(e){return r?r(e):e},this.setURLModifier=function(e){return r=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,n=l.length;t<n;t+=2){const n=l[t],i=l[t+1];if(n.global&&(n.lastIndex=0),n.test(e))return i}return null}}};const is=new ns;let rs=class{constructor(e){this.manager=void 0!==e?e:is,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const n=this;return new Promise((function(i,r){n.load(e,i,t,r)}))}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}};rs.DEFAULT_MATERIAL_NAME="__DEFAULT";const ss={};class os extends Error{constructor(e,t){super(e),this.response=t}}class as extends rs{constructor(e){super(e)}load(e,t,n,i){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=ts.get(e);if(void 0!==r)return this.manager.itemStart(e),setTimeout((()=>{t&&t(r),this.manager.itemEnd(e)}),0),r;if(void 0!==ss[e])return void ss[e].push({onLoad:t,onProgress:n,onError:i});ss[e]=[],ss[e].push({onLoad:t,onProgress:n,onError:i});const s=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),o=this.mimeType,a=this.responseType;fetch(s).then((t=>{if(200===t.status||0===t.status){if(0===t.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body||void 0===t.body.getReader)return t;const n=ss[e],i=t.body.getReader(),r=t.headers.get("X-File-Size")||t.headers.get("Content-Length"),s=r?parseInt(r):0,o=0!==s;let a=0;const l=new ReadableStream({start(e){!function t(){i.read().then((({done:i,value:r})=>{if(i)e.close();else{a+=r.byteLength;const i=new ProgressEvent("progress",{lengthComputable:o,loaded:a,total:s});for(let e=0,t=n.length;e<t;e++){const t=n[e];t.onProgress&&t.onProgress(i)}e.enqueue(r),t()}}))}()}});return new Response(l)}throw new os(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`,t)})).then((e=>{switch(a){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((e=>(new DOMParser).parseFromString(e,o)));case"json":return e.json();default:if(void 0===o)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(o),n=t&&t[1]?t[1].toLowerCase():void 0,i=new TextDecoder(n);return e.arrayBuffer().then((e=>i.decode(e)))}}})).then((t=>{ts.add(e,t);const n=ss[e];delete ss[e];for(let e=0,i=n.length;e<i;e++){const i=n[e];i.onLoad&&i.onLoad(t)}})).catch((t=>{const n=ss[e];if(void 0===n)throw this.manager.itemError(e),t;delete ss[e];for(let e=0,i=n.length;e<i;e++){const i=n[e];i.onError&&i.onError(t)}this.manager.itemError(e)})).finally((()=>{this.manager.itemEnd(e)})),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}let ls=class extends rs{constructor(e){super(e)}load(e,t,n,i){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,s=ts.get(e);if(void 0!==s)return r.manager.itemStart(e),setTimeout((function(){t&&t(s),r.manager.itemEnd(e)}),0),s;const o=$e("img");function a(){c(),ts.add(e,this),t&&t(this),r.manager.itemEnd(e)}function l(t){c(),i&&i(t),r.manager.itemError(e),r.manager.itemEnd(e)}function c(){o.removeEventListener("load",a,!1),o.removeEventListener("error",l,!1)}return o.addEventListener("load",a,!1),o.addEventListener("error",l,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(o.crossOrigin=this.crossOrigin),r.manager.itemStart(e),o.src=e,o}};class cs extends rs{constructor(e){super(e)}load(e,t,n,i){const r=this,s=new ji,o=new as(this.manager);return o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setPath(this.path),o.setWithCredentials(r.withCredentials),o.load(e,(function(e){let n;try{n=r.parse(e)}catch(e){if(void 0===i)return void console.error(e);i(e)}void 0!==n.image?s.image=n.image:void 0!==n.data&&(s.image.width=n.width,s.image.height=n.height,s.image.data=n.data),s.wrapS=void 0!==n.wrapS?n.wrapS:me,s.wrapT=void 0!==n.wrapT?n.wrapT:me,s.magFilter=void 0!==n.magFilter?n.magFilter:ye,s.minFilter=void 0!==n.minFilter?n.minFilter:ye,s.anisotropy=void 0!==n.anisotropy?n.anisotropy:1,void 0!==n.colorSpace&&(s.colorSpace=n.colorSpace),void 0!==n.flipY&&(s.flipY=n.flipY),void 0!==n.format&&(s.format=n.format),void 0!==n.type&&(s.type=n.type),void 0!==n.mipmaps&&(s.mipmaps=n.mipmaps,s.minFilter=ve),1===n.mipmapCount&&(s.minFilter=ye),void 0!==n.generateMipmaps&&(s.generateMipmaps=n.generateMipmaps),s.needsUpdate=!0,t&&t(s,n)}),n,i),s}}let us=class extends rs{constructor(e){super(e)}load(e,t,n,i){const r=new ct,s=new ls(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(e,(function(e){r.image=e,r.needsUpdate=!0,void 0!==t&&t(r)}),n,i),r}},hs=class extends gn{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new Dn(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}};const ds=new Gt,ps=new dt,fs=new dt;let ms=class{constructor(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new We(512,512),this.map=null,this.mapPass=null,this.matrix=new Gt,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Ai,this._frameExtents=new We(1,1),this._viewportCount=1,this._viewports=[new ut(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,n=this.matrix;ps.setFromMatrixPosition(e.matrixWorld),t.position.copy(ps),fs.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(fs),t.updateMatrixWorld(),ds.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(ds),n.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),n.multiply(ds)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}},gs=class extends ms{constructor(){super(new xi(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(e){const t=this.camera,n=2*Ue*e.angle*this.focus,i=this.mapSize.width/this.mapSize.height,r=e.distance||t.far;n===t.fov&&i===t.aspect&&r===t.far||(t.fov=n,t.aspect=i,t.far=r,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}},ys=class extends hs{constructor(e,t,n=0,i=Math.PI/3,r=0,s=2){super(e,t),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(gn.DEFAULT_UP),this.updateMatrix(),this.target=new gn,this.distance=n,this.angle=i,this.penumbra=r,this.decay=s,this.map=null,this.shadow=new gs}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}};const vs=new Gt,_s=new dt,xs=new dt;let bs=class extends ms{constructor(){super(new xi(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new We(4,2),this._viewportCount=6,this._viewports=[new ut(2,1,1,1),new ut(0,1,1,1),new ut(3,1,1,1),new ut(1,1,1,1),new ut(3,0,1,1),new ut(1,0,1,1)],this._cubeDirections=[new dt(1,0,0),new dt(-1,0,0),new dt(0,0,1),new dt(0,0,-1),new dt(0,1,0),new dt(0,-1,0)],this._cubeUps=[new dt(0,1,0),new dt(0,1,0),new dt(0,1,0),new dt(0,1,0),new dt(0,0,1),new dt(0,0,-1)]}updateMatrices(e,t=0){const n=this.camera,i=this.matrix,r=e.distance||n.far;r!==n.far&&(n.far=r,n.updateProjectionMatrix()),_s.setFromMatrixPosition(e.matrixWorld),n.position.copy(_s),xs.copy(n.position),xs.add(this._cubeDirections[t]),n.up.copy(this._cubeUps[t]),n.lookAt(xs),n.updateMatrixWorld(),i.makeTranslation(-_s.x,-_s.y,-_s.z),vs.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),this._frustum.setFromProjectionMatrix(vs)}},ws=class extends hs{constructor(e,t,n=0,i=2){super(e,t),this.isPointLight=!0,this.type="PointLight",this.distance=n,this.decay=i,this.shadow=new bs}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}},Ts=class extends ms{constructor(){super(new Ci(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}},Ss=class extends hs{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(gn.DEFAULT_UP),this.updateMatrix(),this.target=new gn,this.shadow=new Ts}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}},Ms=class extends hs{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}};class Es{static decodeText(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let n=0,i=e.length;n<i;n++)t+=String.fromCharCode(e[n]);try{return decodeURIComponent(escape(t))}catch(e){return t}}static extractUrlBase(e){const t=e.lastIndexOf("/");return-1===t?"./":e.slice(0,t+1)}static resolveURL(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}}const As="\\[\\]\\.:\\/",Cs=new RegExp("["+As+"]","g"),Rs="[^"+As+"]",Ns="[^"+As.replace("\\.","")+"]",Ps=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",Rs)+/(WCOD+)?/.source.replace("WCOD",Ns)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",Rs)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",Rs)+"$"),Ds=["material","materials","bones","map"];class Ls{constructor(e,t,n){this.path=t,this.parsedPath=n||Ls.parseTrackName(t),this.node=Ls.findNode(e,this.parsedPath.nodeName),this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,t,n){return e&&e.isAnimationObjectGroup?new Ls.Composite(e,t,n):new Ls(e,t,n)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(Cs,"")}static parseTrackName(e){const t=Ps.exec(e);if(null===t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const n={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},i=n.nodeName&&n.nodeName.lastIndexOf(".");if(void 0!==i&&-1!==i){const e=n.nodeName.substring(i+1);-1!==Ds.indexOf(e)&&(n.nodeName=n.nodeName.substring(0,i),n.objectName=e)}if(null===n.propertyName||0===n.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return n}static findNode(e,t){if(void 0===t||""===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){const n=e.skeleton.getBoneByName(t);if(void 0!==n)return n}if(e.children){const n=function(e){for(let i=0;i<e.length;i++){const r=e[i];if(r.name===t||r.uuid===t)return r;const s=n(r.children);if(s)return s}return null},i=n(e.children);if(i)return i}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,t){e[t]=this.targetObject[this.propertyName]}_getValue_array(e,t){const n=this.resolvedProperty;for(let i=0,r=n.length;i!==r;++i)e[t++]=n[i]}_getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}_setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]}_setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,t){const n=this.resolvedProperty;for(let i=0,r=n.length;i!==r;++i)n[i]=e[t++]}_setValue_array_setNeedsUpdate(e,t){const n=this.resolvedProperty;for(let i=0,r=n.length;i!==r;++i)n[i]=e[t++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,t){const n=this.resolvedProperty;for(let i=0,r=n.length;i!==r;++i)n[i]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]}_setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)}_setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,t){this.bind(),this.getValue(e,t)}_setValue_unbound(e,t){this.bind(),this.setValue(e,t)}bind(){let e=this.node;const t=this.parsedPath,n=t.objectName,i=t.propertyName;let r=t.propertyIndex;if(e||(e=Ls.findNode(this.rootNode,t.nodeName),this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void console.warn("THREE.PropertyBinding: No target node found for track: "+this.path+".");if(n){let i=t.objectIndex;switch(n){case"materials":if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(let t=0;t<e.length;t++)if(e[t].name===i){i=t;break}break;case"map":if("map"in e){e=e.map;break}if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.map)return void console.error("THREE.PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);e=e.material.map;break;default:if(void 0===e[n])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[n]}if(void 0!==i){if(void 0===e[i])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[i]}}const s=e[i];if(void 0===s){const n=t.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+n+"."+i+" but it wasn't found.",e)}let o=this.Versioning.None;this.targetObject=e,void 0!==e.needsUpdate?o=this.Versioning.NeedsUpdate:void 0!==e.matrixWorldNeedsUpdate&&(o=this.Versioning.MatrixWorldNeedsUpdate);let a=this.BindingType.Direct;if(void 0!==r){if("morphTargetInfluences"===i){if(!e.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!e.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==e.morphTargetDictionary[r]&&(r=e.morphTargetDictionary[r])}a=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=r}else void 0!==s.fromArray&&void 0!==s.toArray?(a=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(a=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=i;this.getValue=this.GetterByBindingType[a],this.setValue=this.SetterByBindingTypeAndVersioning[a][o]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}Ls.Composite=class{constructor(e,t,n){const i=n||Ls.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,i)}getValue(e,t){this.bind();const n=this._targetGroup.nCachedObjects_,i=this._bindings[n];void 0!==i&&i.getValue(e,t)}setValue(e,t){const n=this._bindings;for(let i=this._targetGroup.nCachedObjects_,r=n.length;i!==r;++i)n[i].setValue(e,t)}bind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,n=e.length;t!==n;++t)e[t].bind()}unbind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,n=e.length;t!==n;++t)e[t].unbind()}},Ls.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Ls.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},Ls.prototype.GetterByBindingType=[Ls.prototype._getValue_direct,Ls.prototype._getValue_array,Ls.prototype._getValue_arrayElement,Ls.prototype._getValue_toArray],Ls.prototype.SetterByBindingTypeAndVersioning=[[Ls.prototype._setValue_direct,Ls.prototype._setValue_direct_setNeedsUpdate,Ls.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[Ls.prototype._setValue_array,Ls.prototype._setValue_array_setNeedsUpdate,Ls.prototype._setValue_array_setMatrixWorldNeedsUpdate],[Ls.prototype._setValue_arrayElement,Ls.prototype._setValue_arrayElement_setNeedsUpdate,Ls.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[Ls.prototype._setValue_fromArray,Ls.prototype._setValue_fromArray_setNeedsUpdate,Ls.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]],"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:"164"}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__="164");class Is extends cs{constructor(e){super(e)}parse(e){const t=0,n=1,i=2,r=3,s=9,o=10,a=11,l=48,c=4,u=0,h=1,d=2,p=3;if(e.length<19)throw new Error("THREE.TGALoader: Not enough data to contain header.");let f=0;const m=new Uint8Array(e),g={id_length:m[f++],colormap_type:m[f++],image_type:m[f++],colormap_index:m[f++]|m[f++]<<8,colormap_length:m[f++]|m[f++]<<8,colormap_size:m[f++],origin:[m[f++]|m[f++]<<8,m[f++]|m[f++]<<8],width:m[f++]|m[f++]<<8,height:m[f++]|m[f++]<<8,pixel_size:m[f++],flags:m[f++]};if(function(e){switch(e.image_type){case n:case s:if(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)throw new Error("THREE.TGALoader: Invalid type colormap data for indexed type.");break;case i:case r:case o:case a:if(e.colormap_type)throw new Error("THREE.TGALoader: Invalid type colormap data for colormap type.");break;case t:throw new Error("THREE.TGALoader: No data.");default:throw new Error("THREE.TGALoader: Invalid type "+e.image_type)}if(e.width<=0||e.height<=0)throw new Error("THREE.TGALoader: Invalid image size.");if(8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size)throw new Error("THREE.TGALoader: Invalid pixel size "+e.pixel_size)}(g),g.id_length+f>e.length)throw new Error("THREE.TGALoader: No data.");f+=g.id_length;let y=!1,v=!1,_=!1;switch(g.image_type){case s:y=!0,v=!0;break;case n:v=!0;break;case o:y=!0;break;case i:break;case a:y=!0,_=!0;break;case r:_=!0}const x=new Uint8Array(g.width*g.height*4),b=function(e,t,n,i,r){let s,o;const a=n.pixel_size>>3,l=n.width*n.height*a;if(t&&(o=r.subarray(i,i+=n.colormap_length*(n.colormap_size>>3))),e){let e,t,n;s=new Uint8Array(l);let o=0;const c=new Uint8Array(a);for(;o<l;)if(e=r[i++],t=1+(127&e),128&e){for(n=0;n<a;++n)c[n]=r[i++];for(n=0;n<t;++n)s.set(c,o+n*a);o+=a*t}else{for(t*=a,n=0;n<t;++n)s[o+n]=r[i++];o+=t}}else s=r.subarray(i,i+=t?n.width*n.height:l);return{pixel_data:s,palettes:o}}(y,v,g,f,m);return function(e,t,n,i,r){let s,o,a,f,m,y;switch((g.flags&l)>>c){default:case d:s=0,a=1,m=t,o=0,f=1,y=n;break;case u:s=0,a=1,m=t,o=n-1,f=-1,y=-1;break;case p:s=t-1,a=-1,m=-1,o=0,f=1,y=n;break;case h:s=t-1,a=-1,m=-1,o=n-1,f=-1,y=-1}if(_)switch(g.pixel_size){case 8:!function(e,t,n,i,r,s,o,a){let l,c,u,h=0;const d=g.width;for(u=t;u!==i;u+=n)for(c=r;c!==o;c+=s,h++)l=a[h],e[4*(c+d*u)+0]=l,e[4*(c+d*u)+1]=l,e[4*(c+d*u)+2]=l,e[4*(c+d*u)+3]=255}(e,o,f,y,s,a,m,i);break;case 16:!function(e,t,n,i,r,s,o,a){let l,c,u=0;const h=g.width;for(c=t;c!==i;c+=n)for(l=r;l!==o;l+=s,u+=2)e[4*(l+h*c)+0]=a[u+0],e[4*(l+h*c)+1]=a[u+0],e[4*(l+h*c)+2]=a[u+0],e[4*(l+h*c)+3]=a[u+1]}(e,o,f,y,s,a,m,i);break;default:throw new Error("THREE.TGALoader: Format not supported.")}else switch(g.pixel_size){case 8:!function(e,t,n,i,r,s,o,a,l){const c=l;let u,h,d,p=0;const f=g.width;for(d=t;d!==i;d+=n)for(h=r;h!==o;h+=s,p++)u=a[p],e[4*(h+f*d)+3]=255,e[4*(h+f*d)+2]=c[3*u+0],e[4*(h+f*d)+1]=c[3*u+1],e[4*(h+f*d)+0]=c[3*u+2]}(e,o,f,y,s,a,m,i,r);break;case 16:!function(e,t,n,i,r,s,o,a){let l,c,u,h=0;const d=g.width;for(u=t;u!==i;u+=n)for(c=r;c!==o;c+=s,h+=2)l=a[h+0]+(a[h+1]<<8),e[4*(c+d*u)+0]=(31744&l)>>7,e[4*(c+d*u)+1]=(992&l)>>2,e[4*(c+d*u)+2]=(31&l)<<3,e[4*(c+d*u)+3]=32768&l?0:255}(e,o,f,y,s,a,m,i);break;case 24:!function(e,t,n,i,r,s,o,a){let l,c,u=0;const h=g.width;for(c=t;c!==i;c+=n)for(l=r;l!==o;l+=s,u+=3)e[4*(l+h*c)+3]=255,e[4*(l+h*c)+2]=a[u+0],e[4*(l+h*c)+1]=a[u+1],e[4*(l+h*c)+0]=a[u+2]}(e,o,f,y,s,a,m,i);break;case 32:!function(e,t,n,i,r,s,o,a){let l,c,u=0;const h=g.width;for(c=t;c!==i;c+=n)for(l=r;l!==o;l+=s,u+=4)e[4*(l+h*c)+2]=a[u+0],e[4*(l+h*c)+1]=a[u+1],e[4*(l+h*c)+0]=a[u+2],e[4*(l+h*c)+3]=a[u+3]}(e,o,f,y,s,a,m,i);break;default:throw new Error("THREE.TGALoader: Format not supported.")}}(x,g.width,g.height,b.pixel_data,b.palettes),{data:x,width:g.width,height:g.height,flipY:!0,generateMipmaps:!0,minFilter:ve}}}THREE.ColladaLoader=class extends rs{load(e,t,n,i){const r=this,s=""===r.path?Es.extractUrlBase(e):r.path,o=new as(r.manager);o.setPath(r.path),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(e,(function(n){try{t(r.parse(n,s))}catch(t){i?i(t):console.error(t),r.manager.itemError(e)}}),n,i)}parse(e,t){function n(e,t){const n=[],i=e.childNodes;for(let e=0,r=i.length;e<r;e++){const r=i[e];r.nodeName===t&&n.push(r)}return n}function i(e){if(0===e.length)return[];const t=e.trim().split(/\s+/),n=new Array(t.length);for(let e=0,i=t.length;e<i;e++)n[e]=t[e];return n}function r(e){if(0===e.length)return[];const t=e.trim().split(/\s+/),n=new Array(t.length);for(let e=0,i=t.length;e<i;e++)n[e]=parseFloat(t[e]);return n}function s(e){if(0===e.length)return[];const t=e.trim().split(/\s+/),n=new Array(t.length);for(let e=0,i=t.length;e<i;e++)n[e]=parseInt(t[e]);return n}function o(e){return e.substring(1)}function a(e){return 0===Object.keys(e).length}function l(e){return void 0!==e&&!0===e.hasAttribute("meter")?parseFloat(e.getAttribute("meter")):1}function c(e){return void 0!==e?e.textContent:"Y_UP"}function u(e,t,i,r){const s=n(e,t)[0];if(void 0!==s){const e=n(s,i);for(let t=0;t<e.length;t++)r(e[t])}}function h(e,t){for(const n in e){e[n].build=t(e[n])}}function d(e,t){return void 0!==e.build||(e.build=t(e)),e.build}function p(e){const t={inputs:{}};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"input"===i.nodeName){const e=o(i.getAttribute("source")),n=i.getAttribute("semantic");t.inputs[n]=e}}return t}function f(e){const t={};let n=e.getAttribute("target").split("/");const i=n.shift();let r=n.shift();const s=-1!==r.indexOf("("),a=-1!==r.indexOf(".");if(a)n=r.split("."),r=n.shift(),t.member=n.shift();else if(s){const e=r.split("(");r=e.shift();for(let t=0;t<e.length;t++)e[t]=parseInt(e[t].replace(/\)/,""));t.indices=e}return t.id=i,t.sid=r,t.arraySyntax=s,t.memberSyntax=a,t.sampler=o(e.getAttribute("source")),t}function m(e){const t=[],n=e.channels,i=e.samplers,r=e.sources;for(const e in n)if(n.hasOwnProperty(e)){const s=n[e],o=i[s.sampler],a=o.inputs.INPUT,l=o.inputs.OUTPUT;b(y(s,r[a],r[l]),t)}return t}function g(e){return d(it.animations[e],m)}function y(e,t,n){const i=it.nodes[e.id],r=ze(i.id),s=i.transforms[e.sid],o=i.matrix.clone().transpose();let a,l,c,u,h,d;const p={};switch(s){case"matrix":for(c=0,u=t.array.length;c<u;c++)if(a=t.array[c],l=c*n.stride,void 0===p[a]&&(p[a]={}),!0===e.arraySyntax){const t=n.array[l],i=e.indices[0]+4*e.indices[1];p[a][i]=t}else for(h=0,d=n.stride;h<d;h++)p[a][h]=n.array[l+h];break;case"translate":case"rotate":case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',s)}const f=function(e,t){const n=[];for(const t in e)n.push({time:parseFloat(t),value:e[t]});n.sort(i);for(let e=0;e<16;e++)w(n,e,t.elements[e]);return n;function i(e,t){return e.time-t.time}}(p,o);return{name:r.uuid,keyframes:f}}const v=new dt,_=new dt,x=new ht;function b(e,t){const n=e.keyframes,i=e.name,r=[],s=[],o=[],a=[];for(let e=0,t=n.length;e<t;e++){const t=n[e],i=t.time,l=t.value;Re.fromArray(l).transpose(),Re.decompose(v,x,_),r.push(i),s.push(v.x,v.y,v.z),o.push(x.x,x.y,x.z,x.w),a.push(_.x,_.y,_.z)}return s.length>0&&t.push(new Jr(i+".position",r,s)),o.length>0&&t.push(new Kr(i+".quaternion",r,o)),a.length>0&&t.push(new Jr(i+".scale",r,a)),t}function w(e,t,n){let i,r,s,o=!0;for(r=0,s=e.length;r<s;r++)i=e[r],void 0===i.value[t]?i.value[t]=null:o=!1;if(!0===o)for(r=0,s=e.length;r<s;r++)i=e[r],i.value[t]=n;else!function(e,t){let n,i;for(let r=0,s=e.length;r<s;r++){const s=e[r];if(null===s.value[t]){if(n=T(e,r,t),i=S(e,r,t),null===n){s.value[t]=i.value[t];continue}if(null===i){s.value[t]=n.value[t];continue}M(s,n,i,t)}}}(e,t)}function T(e,t,n){for(;t>=0;){const i=e[t];if(null!==i.value[n])return i;t--}return null}function S(e,t,n){for(;t<e.length;){const i=e[t];if(null!==i.value[n])return i;t++}return null}function M(e,t,n,i){n.time-t.time!==0?e.value[i]=(e.time-t.time)*(n.value[i]-t.value[i])/(n.time-t.time)+t.value[i]:e.value[i]=t.value[i]}function E(e){const t=[],n=e.name,i=e.end-e.start||-1,r=e.animations;for(let e=0,n=r.length;e<n;e++){const n=g(r[e]);for(let e=0,i=n.length;e<i;e++)t.push(n[e])}return new Qr(n,i,t)}function A(e){return d(it.clips[e],E)}function C(e){const t={sources:{}};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"bind_shape_matrix":t.bindShapeMatrix=r(i.textContent);break;case"source":const e=i.getAttribute("id");t.sources[e]=oe(i);break;case"joints":t.joints=R(i);break;case"vertex_weights":t.vertexWeights=N(i)}}return t}function R(e){const t={inputs:{}};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"input"===i.nodeName){const e=i.getAttribute("semantic"),n=o(i.getAttribute("source"));t.inputs[e]=n}}return t}function N(e){const t={inputs:{}};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"input":const e=i.getAttribute("semantic"),n=o(i.getAttribute("source")),r=parseInt(i.getAttribute("offset"));t.inputs[e]={id:n,offset:r};break;case"vcount":t.vcount=s(i.textContent);break;case"v":t.v=s(i.textContent)}}return t}function P(e){const t={id:e.id},n=it.geometries[t.id];return void 0!==e.skin&&(t.skin=function(e){const t=4,n={joints:[],indices:{array:[],stride:t},weights:{array:[],stride:t}},i=e.sources,r=e.vertexWeights,s=r.vcount,o=r.v,a=r.inputs.JOINT.offset,l=r.inputs.WEIGHT.offset,c=e.sources[e.joints.inputs.JOINT],u=e.sources[e.joints.inputs.INV_BIND_MATRIX],h=i[r.inputs.WEIGHT.id].array;let d,p,f,m=0;for(d=0,f=s.length;d<f;d++){const e=s[d],i=[];for(p=0;p<e;p++){const e=o[m+a],t=h[o[m+l]];i.push({index:e,weight:t}),m+=2}for(i.sort(g),p=0;p<t;p++){const e=i[p];void 0!==e?(n.indices.array.push(e.index),n.weights.array.push(e.weight)):(n.indices.array.push(0),n.weights.array.push(0))}}e.bindShapeMatrix?n.bindMatrix=(new Gt).fromArray(e.bindShapeMatrix).transpose():n.bindMatrix=(new Gt).identity();for(d=0,f=c.array.length;d<f;d++){const e=c.array[d],t=(new Gt).fromArray(u.array,d*u.stride).transpose();n.joints.push({name:e,boneInverse:t})}return n;function g(e,t){return t.weight-e.weight}}(e.skin),n.sources.skinIndices=t.skin.indices,n.sources.skinWeights=t.skin.weights),t}function D(e){return d(it.controllers[e],P)}function L(e){return void 0!==e.build?e.build:e.init_from}function I(e){const t=it.images[e];return void 0!==t?d(t,L):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",e),null)}function k(e){const t={surfaces:{},samplers:{}};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"newparam":O(i,t);break;case"technique":t.technique=B(i);break;case"extra":t.extra=W(i)}}return t}function O(e,t){const n=e.getAttribute("sid");for(let i=0,r=e.childNodes.length;i<r;i++){const r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"surface":t.surfaces[n]=U(r);break;case"sampler2D":t.samplers[n]=F(r)}}}function U(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"init_from"===i.nodeName)t.init_from=i.textContent}return t}function F(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"source"===i.nodeName)t.source=i.textContent}return t}function B(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"constant":case"lambert":case"blinn":case"phong":t.type=i.nodeName,t.parameters=z(i);break;case"extra":t.extra=W(i)}}return t}function z(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":t[i.nodeName]=V(i);break;case"transparent":t[i.nodeName]={opaque:i.hasAttribute("opaque")?i.getAttribute("opaque"):"A_ONE",data:V(i)}}}return t}function V(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"color":t[i.nodeName]=r(i.textContent);break;case"float":t[i.nodeName]=parseFloat(i.textContent);break;case"texture":t[i.nodeName]={id:i.getAttribute("texture"),extra:G(i)}}}return t}function G(e){const t={technique:{}};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"extra"===i.nodeName)j(i,t)}return t}function j(e,t){for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"technique"===i.nodeName)H(i,t)}}function H(e,t){for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":t.technique[i.nodeName]=parseFloat(i.textContent);break;case"wrapU":case"wrapV":"TRUE"===i.textContent.toUpperCase()?t.technique[i.nodeName]=1:"FALSE"===i.textContent.toUpperCase()?t.technique[i.nodeName]=0:t.technique[i.nodeName]=parseInt(i.textContent);break;case"bump":t[i.nodeName]=X(i)}}}function W(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"technique"===i.nodeName)t.technique=q(i)}return t}function q(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"double_sided":t[i.nodeName]=parseInt(i.textContent);break;case"bump":t[i.nodeName]=X(i)}}return t}function X(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"texture"===i.nodeName)t[i.nodeName]={id:i.getAttribute("texture"),texcoord:i.getAttribute("texcoord"),extra:G(i)}}return t}function $(e){return e}function Y(e){const t=function(e){return d(it.effects[e],$)}(e.url),n=t.profile.technique;let i;switch(n.type){case"phong":case"blinn":i=new kr;break;case"lambert":i=new Or;break;default:i=new On}function r(e,n=null){const i=t.profile.samplers[e.id];let r=null;if(void 0!==i){r=I(t.profile.surfaces[i.source].init_from)}else console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),r=I(e.id);if(null!==r){const t=function(e){let t,n=e.slice((e.lastIndexOf(".")-1>>>0)+2);n=n.toLowerCase(),t="tga"===n?Je:Ze;return t}(r);if(void 0!==t){const i=t.load(r),s=e.extra;if(void 0!==s&&void 0!==s.technique&&!1===a(s.technique)){const e=s.technique;i.wrapS=e.wrapU?fe:me,i.wrapT=e.wrapV?fe:me,i.offset.set(e.offsetU||0,e.offsetV||0),i.repeat.set(e.repeatU||1,e.repeatV||1)}else i.wrapS=fe,i.wrapT=fe;return null!==n&&(i.colorSpace=n),i}return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",r),null}return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",e.id),null}i.name=e.name||"";const s=n.parameters;for(const e in s){const t=s[e];switch(e){case"diffuse":t.color&&i.color.fromArray(t.color),t.texture&&(i.map=r(t.texture,Te));break;case"specular":t.color&&i.specular&&i.specular.fromArray(t.color),t.texture&&(i.specularMap=r(t.texture));break;case"bump":t.texture&&(i.normalMap=r(t.texture));break;case"ambient":t.texture&&(i.lightMap=r(t.texture,Te));break;case"shininess":t.float&&i.shininess&&(i.shininess=t.float);break;case"emission":t.color&&i.emissive&&i.emissive.fromArray(t.color),t.texture&&(i.emissiveMap=r(t.texture,Te))}}i.color.convertSRGBToLinear(),i.specular&&i.specular.convertSRGBToLinear(),i.emissive&&i.emissive.convertSRGBToLinear();let o=s.transparent,l=s.transparency;if(void 0===l&&o&&(l={float:1}),void 0===o&&l&&(o={opaque:"A_ONE",data:{color:[1,1,1,1]}}),o&&l)if(o.data.texture)i.transparent=!0;else{const e=o.data.color;switch(o.opaque){case"A_ONE":i.opacity=e[3]*l.float;break;case"RGB_ZERO":i.opacity=1-e[0]*l.float;break;case"A_ZERO":i.opacity=1-e[3]*l.float;break;case"RGB_ONE":i.opacity=e[0]*l.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',o.opaque)}i.opacity<1&&(i.transparent=!0)}if(void 0!==n.extra&&void 0!==n.extra.technique){const e=n.extra.technique;for(const t in e){const n=e[t];switch(t){case"double_sided":i.side=1===n?2:0;break;case"bump":i.normalMap=r(n.texture),i.normalScale=new We(1,1)}}}return i}function K(e){return d(it.materials[e],Y)}function Z(e){for(let t=0;t<e.childNodes.length;t++){const n=e.childNodes[t];if("technique_common"===n.nodeName)return J(n)}return{}}function J(e){const t={};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];switch(i.nodeName){case"perspective":case"orthographic":t.technique=i.nodeName,t.parameters=Q(i)}}return t}function Q(e){const t={};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];switch(i.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":t[i.nodeName]=parseFloat(i.textContent)}}return t}function ee(e){let t;switch(e.optics.technique){case"perspective":t=new xi(e.optics.parameters.yfov,e.optics.parameters.aspect_ratio,e.optics.parameters.znear,e.optics.parameters.zfar);break;case"orthographic":let n=e.optics.parameters.ymag,i=e.optics.parameters.xmag;const r=e.optics.parameters.aspect_ratio;i=void 0===i?n*r:i,n=void 0===n?i/r:n,i*=.5,n*=.5,t=new Ci(-i,i,n,-n,e.optics.parameters.znear,e.optics.parameters.zfar);break;default:t=new xi}return t.name=e.name||"",t}function te(e){const t=it.cameras[e];return void 0!==t?d(t,ee):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",e),null)}function ne(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"directional":case"point":case"spot":case"ambient":t.technique=i.nodeName,t.parameters=ie(i)}}return t}function ie(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"color":const e=r(i.textContent);t.color=(new Dn).fromArray(e).convertSRGBToLinear();break;case"falloff_angle":t.falloffAngle=parseFloat(i.textContent);break;case"quadratic_attenuation":const n=parseFloat(i.textContent);t.distance=n?Math.sqrt(1/n):0}}return t}function re(e){let t;switch(e.technique){case"directional":t=new Ss;break;case"point":t=new ws;break;case"spot":t=new ys;break;case"ambient":t=new Ms}return e.parameters.color&&t.color.copy(e.parameters.color),e.parameters.distance&&(t.distance=e.parameters.distance),t}function se(e){const t=it.lights[e];return void 0!==t?d(t,re):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",e),null)}function oe(e){const t={array:[],stride:3};for(let s=0;s<e.childNodes.length;s++){const o=e.childNodes[s];if(1===o.nodeType)switch(o.nodeName){case"float_array":t.array=r(o.textContent);break;case"Name_array":t.array=i(o.textContent);break;case"technique_common":const e=n(o,"accessor")[0];void 0!==e&&(t.stride=parseInt(e.getAttribute("stride")))}}return t}function ae(e){const t={};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];1===i.nodeType&&(t[i.getAttribute("semantic")]=o(i.getAttribute("source")))}return t}function le(e){const t={type:e.nodeName,material:e.getAttribute("material"),count:parseInt(e.getAttribute("count")),inputs:{},stride:0,hasUV:!1};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"input":const e=o(i.getAttribute("source")),n=i.getAttribute("semantic"),r=parseInt(i.getAttribute("offset")),a=parseInt(i.getAttribute("set")),l=a>0?n+a:n;t.inputs[l]={id:e,offset:r},t.stride=Math.max(t.stride,r+1),"TEXCOORD"===n&&(t.hasUV=!0);break;case"vcount":t.vcount=s(i.textContent);break;case"p":t.p=s(i.textContent)}}return t}function ce(e){let t=0;for(let n=0,i=e.length;n<i;n++){!0===e[n].hasUV&&t++}t>0&&t<e.length&&(e.uvsNeedsFix=!0)}function ue(e){const t={},n=e.sources,i=e.vertices,r=e.primitives;if(0===r.length)return{};const s=function(e){const t={};for(let n=0;n<e.length;n++){const i=e[n];void 0===t[i.type]&&(t[i.type]=[]),t[i.type].push(i)}return t}(r);for(const e in s){const r=s[e];ce(r),t[e]=he(r,n,i)}return t}function he(e,t,n){const i={},r={array:[],stride:0},s={array:[],stride:0},o={array:[],stride:0},a={array:[],stride:0},l={array:[],stride:0},c=[],u=4,h=[],d=4,p=new Kn,f=[];let m=0;for(let i=0;i<e.length;i++){const u=e[i],d=u.inputs;let g=0;switch(u.type){case"lines":case"linestrips":g=2*u.count;break;case"triangles":g=3*u.count;break;case"polylist":for(let e=0;e<u.count;e++){const t=u.vcount[e];switch(t){case 3:g+=3;break;case 4:g+=6;break;default:g+=3*(t-2)}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",u.type)}p.addGroup(m,g,i),m+=g,u.material&&f.push(u.material);for(const i in d){const p=d[i];switch(i){case"VERTEX":for(const i in n){const d=n[i];switch(i){case"POSITION":const n=r.array.length;if(de(u,t[d],p.offset,r.array),r.stride=t[d].stride,t.skinWeights&&t.skinIndices&&(de(u,t.skinIndices,p.offset,c),de(u,t.skinWeights,p.offset,h)),!1===u.hasUV&&!0===e.uvsNeedsFix){const e=(r.array.length-n)/r.stride;for(let t=0;t<e;t++)o.array.push(0,0)}break;case"NORMAL":de(u,t[d],p.offset,s.array),s.stride=t[d].stride;break;case"COLOR":de(u,t[d],p.offset,l.array),l.stride=t[d].stride;break;case"TEXCOORD":de(u,t[d],p.offset,o.array),o.stride=t[d].stride;break;case"TEXCOORD1":de(u,t[d],p.offset,a.array),o.stride=t[d].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',i)}}break;case"NORMAL":de(u,t[p.id],p.offset,s.array),s.stride=t[p.id].stride;break;case"COLOR":de(u,t[p.id],p.offset,l.array,!0),l.stride=t[p.id].stride;break;case"TEXCOORD":de(u,t[p.id],p.offset,o.array),o.stride=t[p.id].stride;break;case"TEXCOORD1":de(u,t[p.id],p.offset,a.array),a.stride=t[p.id].stride}}}return r.array.length>0&&p.setAttribute("position",new Gn(r.array,r.stride)),s.array.length>0&&p.setAttribute("normal",new Gn(s.array,s.stride)),l.array.length>0&&p.setAttribute("color",new Gn(l.array,l.stride)),o.array.length>0&&p.setAttribute("uv",new Gn(o.array,o.stride)),a.array.length>0&&p.setAttribute("uv1",new Gn(a.array,a.stride)),c.length>0&&p.setAttribute("skinIndex",new Gn(c,u)),h.length>0&&p.setAttribute("skinWeight",new Gn(h,d)),i.data=p,i.type=e[0].type,i.materialKeys=f,i}function de(e,t,n,i,r=!1){const s=e.p,o=e.stride,a=e.vcount;function l(e){let t=s[e+n]*u;const o=t+u;for(;t<o;t++)i.push(c[t]);if(r){const e=i.length-u-1;Qe.setRGB(i[e+0],i[e+1],i[e+2]).convertSRGBToLinear(),i[e+0]=Qe.r,i[e+1]=Qe.g,i[e+2]=Qe.b}}const c=t.array,u=t.stride;if(void 0!==e.vcount){let e=0;for(let t=0,n=a.length;t<n;t++){const n=a[t];if(4===n){const t=e+1*o,n=e+2*o,i=e+3*o;l(e+0*o),l(t),l(i),l(t),l(n),l(i)}else if(3===n){const t=e+1*o,n=e+2*o;l(e+0*o),l(t),l(n)}else if(n>4)for(let t=1,i=n-2;t<=i;t++){const n=e+o*t,i=e+o*(t+1);l(e+0*o),l(n),l(i)}e+=o*n}}else for(let e=0,t=s.length;e<t;e+=o)l(e)}function pe(e){return d(it.geometries[e],ue)}function ge(e){return void 0!==e.build?e.build:e}function ye(e,t){for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"joint":t.joints[i.getAttribute("sid")]=ve(i);break;case"link":t.links.push(xe(i))}}}function ve(e){let t;for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"prismatic":case"revolute":t=_e(i)}}return t}function _e(e){const t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",axis:new dt,limits:{min:0,max:0},type:e.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"axis":const e=r(i.textContent);t.axis.fromArray(e);break;case"limits":const n=i.getElementsByTagName("max")[0],s=i.getElementsByTagName("min")[0];t.limits.max=parseFloat(n.textContent),t.limits.min=parseFloat(s.textContent)}}return t.limits.min>=t.limits.max&&(t.static=!0),t.middlePosition=(t.limits.min+t.limits.max)/2,t}function xe(e){const t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",attachments:[],transforms:[]};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"attachment_full":t.attachments.push(be(i));break;case"matrix":case"translate":case"rotate":t.transforms.push(we(i))}}return t}function be(e){const t={joint:e.getAttribute("joint").split("/").pop(),transforms:[],links:[]};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"link":t.links.push(xe(i));break;case"matrix":case"translate":case"rotate":t.transforms.push(we(i))}}return t}function we(e){const t={type:e.nodeName},n=r(e.textContent);switch(t.type){case"matrix":t.obj=new Gt,t.obj.fromArray(n).transpose();break;case"translate":t.obj=new dt,t.obj.fromArray(n);break;case"rotate":t.obj=new dt,t.obj.fromArray(n),t.angle=He.degToRad(n[3])}return t}function Se(e,t){for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1===i.nodeType&&"technique_common"===i.nodeName)Me(i,t)}}function Me(e,t){for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"inertia":t.inertia=r(i.textContent);break;case"mass":t.mass=r(i.textContent)[0]}}}function Ee(e){const t={target:e.getAttribute("target").split("/").pop()};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1===i.nodeType&&"axis"===i.nodeName){const e=i.getElementsByTagName("param")[0];t.axis=e.textContent;const n=t.axis.split("inst_").pop().split("axis")[0];t.jointIndex=n.substring(0,n.length-1)}}return t}function Ae(e){return void 0!==e.build?e.build:e}function Ce(e){const t=[],n=Xe.querySelector('[id="'+e.id+'"]');for(let e=0;e<n.childNodes.length;e++){const i=n.childNodes[e];if(1!==i.nodeType)continue;let s,o;switch(i.nodeName){case"matrix":s=r(i.textContent);const e=(new Gt).fromArray(s).transpose();t.push({sid:i.getAttribute("sid"),type:i.nodeName,obj:e});break;case"translate":case"scale":s=r(i.textContent),o=(new dt).fromArray(s),t.push({sid:i.getAttribute("sid"),type:i.nodeName,obj:o});break;case"rotate":s=r(i.textContent),o=(new dt).fromArray(s);const n=He.degToRad(s[3]);t.push({sid:i.getAttribute("sid"),type:i.nodeName,obj:o,angle:n})}}return t}const Re=new Gt,Ne=new dt;function Pe(e){const t={name:e.getAttribute("name")||"",type:e.getAttribute("type"),id:e.getAttribute("id"),sid:e.getAttribute("sid"),matrix:new Gt,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1!==i.nodeType)continue;let s;switch(i.nodeName){case"node":t.nodes.push(i.getAttribute("id")),Pe(i);break;case"instance_camera":t.instanceCameras.push(o(i.getAttribute("url")));break;case"instance_controller":t.instanceControllers.push(De(i));break;case"instance_light":t.instanceLights.push(o(i.getAttribute("url")));break;case"instance_geometry":t.instanceGeometries.push(De(i));break;case"instance_node":t.instanceNodes.push(o(i.getAttribute("url")));break;case"matrix":s=r(i.textContent),t.matrix.multiply(Re.fromArray(s).transpose()),t.transforms[i.getAttribute("sid")]=i.nodeName;break;case"translate":s=r(i.textContent),Ne.fromArray(s),t.matrix.multiply(Re.makeTranslation(Ne.x,Ne.y,Ne.z)),t.transforms[i.getAttribute("sid")]=i.nodeName;break;case"rotate":s=r(i.textContent);const e=He.degToRad(s[3]);t.matrix.multiply(Re.makeRotationAxis(Ne.fromArray(s),e)),t.transforms[i.getAttribute("sid")]=i.nodeName;break;case"scale":s=r(i.textContent),t.matrix.scale(Ne.fromArray(s)),t.transforms[i.getAttribute("sid")]=i.nodeName;break;case"extra":break;default:console.log(i)}}return Be(t.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",t.id):it.nodes[t.id]=t,t}function De(e){const t={id:o(e.getAttribute("url")),materials:{},skeletons:[]};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];switch(i.nodeName){case"bind_material":const e=i.getElementsByTagName("instance_material");for(let n=0;n<e.length;n++){const i=e[n],r=i.getAttribute("symbol"),s=i.getAttribute("target");t.materials[r]=o(s)}break;case"skeleton":t.skeletons.push(o(i.textContent))}}return t}function Le(e,t){const n=[],i=[];let r,s,o;for(r=0;r<e.length;r++){const i=e[r];let s;if(Be(i))s=ze(i),Ie(s,t,n);else if(Ge(i)){const e=it.visualScenes[i].children;for(let i=0;i<e.length;i++){const r=e[i];if("JOINT"===r.type){Ie(ze(r.id),t,n)}}}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",i)}for(r=0;r<t.length;r++)for(s=0;s<n.length;s++)if(o=n[s],o.bone.name===t[r].name){i[r]=o,o.processed=!0;break}for(r=0;r<n.length;r++)o=n[r],!1===o.processed&&(i.push(o),o.processed=!0);const a=[],l=[];for(r=0;r<i.length;r++)o=i[r],a.push(o.bone),l.push(o.boneInverse);return new qi(a,l)}function Ie(e,t,n){e.traverse((function(e){if(!0===e.isBone){let i;for(let n=0;n<t.length;n++){const r=t[n];if(r.name===e.name){i=r.boneInverse;break}}void 0===i&&(i=new Gt),n.push({bone:e,boneInverse:i,processed:!1})}}))}function ke(e){const t=[],n=e.matrix,i=e.nodes,r=e.type,s=e.instanceCameras,o=e.instanceControllers,a=e.instanceLights,l=e.instanceGeometries,c=e.instanceNodes;for(let e=0,n=i.length;e<n;e++)t.push(ze(i[e]));for(let e=0,n=s.length;e<n;e++){const n=te(s[e]);null!==n&&t.push(n.clone())}for(let e=0,n=o.length;e<n;e++){const n=o[e],i=D(n.id),r=Fe(pe(i.id),n.materials),s=Le(n.skeletons,i.skin.joints);for(let e=0,n=r.length;e<n;e++){const n=r[e];n.isSkinnedMesh&&(n.bind(s,i.skin.bindMatrix),n.normalizeSkinWeights()),t.push(n)}}for(let e=0,n=a.length;e<n;e++){const n=se(a[e]);null!==n&&t.push(n.clone())}for(let e=0,n=l.length;e<n;e++){const n=l[e],i=Fe(pe(n.id),n.materials);for(let e=0,n=i.length;e<n;e++)t.push(i[e])}for(let e=0,n=c.length;e<n;e++)t.push(ze(c[e]).clone());let u;if(0===i.length&&1===t.length)u=t[0];else{u="JOINT"===r?new Gi:new Ni;for(let e=0;e<t.length;e++)u.add(t[e])}return u.name="JOINT"===r?e.sid:e.name,u.matrix.copy(n),u.matrix.decompose(u.position,u.quaternion,u.scale),u}const Oe=new On({name:rs.DEFAULT_MATERIAL_NAME,color:16711935});function Ue(e,t){const n=[];for(let i=0,r=e.length;i<r;i++){const r=t[e[i]];void 0===r?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",e[i]),n.push(Oe)):n.push(K(r))}return n}function Fe(e,t){const n=[];for(const i in e){const r=e[i],s=Ue(r.materialKeys,t);if(0===s.length&&("lines"===i||"linestrips"===i?s.push(new Xi):s.push(new kr)),"lines"===i||"linestrips"===i)for(let e=0,t=s.length;e<t;e++){const t=s[e];if(!0===t.isMeshPhongMaterial||!0===t.isMeshLambertMaterial){const n=new Xi;n.color.copy(t.color),n.opacity=t.opacity,n.transparent=t.transparent,s[e]=n}}const o=void 0!==r.data.attributes.skinIndex,a=1===s.length?s[0]:s;let l;switch(i){case"lines":l=new sr(r.data,a);break;case"linestrips":l=new tr(r.data,a);break;case"triangles":case"polylist":l=o?new Vi(r.data,a):new fi(r.data,a)}n.push(l)}return n}function Be(e){return void 0!==it.nodes[e]}function ze(e){return d(it.nodes[e],ke)}function Ve(e){const t=new Ni;t.name=e.name;const n=e.children;for(let e=0;e<n.length;e++){const i=n[e];t.add(ze(i.id))}return t}function Ge(e){return void 0!==it.visualScenes[e]}function je(e){return d(it.visualScenes[e],Ve)}if(0===e.length)return{scene:new Pi};const qe=(new DOMParser).parseFromString(e,"application/xml"),Xe=n(qe,"COLLADA")[0],$e=qe.getElementsByTagName("parsererror")[0];if(void 0!==$e){const e=n($e,"div")[0];let t;return t=e?e.textContent:function(e){let t="";const n=[e];for(;n.length;){const e=n.shift();e.nodeType===Node.TEXT_NODE?t+=e.textContent:(t+="\n",n.push.apply(n,e.childNodes))}return t.trim()}($e),console.error("THREE.ColladaLoader: Failed to parse collada file.\n",t),null}const Ye=Xe.getAttribute("version");console.debug("THREE.ColladaLoader: File version",Ye);const Ke=function(e){return{unit:l(n(e,"unit")[0]),upAxis:c(n(e,"up_axis")[0])}}(n(Xe,"asset")[0]),Ze=new us(this.manager);let Je;Ze.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin),Is&&(Je=new Is(this.manager),Je.setPath(this.resourcePath||t));const Qe=new Dn,et=[];let tt={},nt=0;const it={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};u(Xe,"library_animations","animation",(function e(t){const n={sources:{},samplers:{},channels:{}};let i=!1;for(let r=0,s=t.childNodes.length;r<s;r++){const s=t.childNodes[r];if(1!==s.nodeType)continue;let o;switch(s.nodeName){case"source":o=s.getAttribute("id"),n.sources[o]=oe(s);break;case"sampler":o=s.getAttribute("id"),n.samplers[o]=p(s);break;case"channel":o=s.getAttribute("target"),n.channels[o]=f(s);break;case"animation":e(s),i=!0;break;default:console.log(s)}}!1===i&&(it.animations[t.getAttribute("id")||He.generateUUID()]=n)})),u(Xe,"library_animation_clips","animation_clip",(function(e){const t={name:e.getAttribute("id")||"default",start:parseFloat(e.getAttribute("start")||0),end:parseFloat(e.getAttribute("end")||0),animations:[]};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"instance_animation"===i.nodeName)t.animations.push(o(i.getAttribute("url")))}it.clips[e.getAttribute("id")]=t})),u(Xe,"library_controllers","controller",(function(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"skin":t.id=o(i.getAttribute("source")),t.skin=C(i);break;case"morph":t.id=o(i.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.")}}it.controllers[e.getAttribute("id")]=t})),u(Xe,"library_images","image",(function(e){const t={init_from:n(e,"init_from")[0].textContent};it.images[e.getAttribute("id")]=t})),u(Xe,"library_effects","effect",(function(e){const t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"profile_COMMON"===i.nodeName)t.profile=k(i)}it.effects[e.getAttribute("id")]=t})),u(Xe,"library_materials","material",(function(e){const t={name:e.getAttribute("name")};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"instance_effect"===i.nodeName)t.url=o(i.getAttribute("url"))}it.materials[e.getAttribute("id")]=t})),u(Xe,"library_cameras","camera",(function(e){const t={name:e.getAttribute("name")};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"optics"===i.nodeName)t.optics=Z(i)}it.cameras[e.getAttribute("id")]=t})),u(Xe,"library_lights","light",(function(e){let t={};for(let n=0,i=e.childNodes.length;n<i;n++){const i=e.childNodes[n];if(1===i.nodeType&&"technique_common"===i.nodeName)t=ne(i)}it.lights[e.getAttribute("id")]=t})),u(Xe,"library_geometries","geometry",(function(e){const t={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]},i=n(e,"mesh")[0];if(void 0!==i){for(let e=0;e<i.childNodes.length;e++){const n=i.childNodes[e];if(1!==n.nodeType)continue;const r=n.getAttribute("id");switch(n.nodeName){case"source":t.sources[r]=oe(n);break;case"vertices":t.vertices=ae(n);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",n.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":t.primitives.push(le(n));break;default:console.log(n)}}it.geometries[e.getAttribute("id")]=t}})),u(Xe,"library_nodes","node",Pe),u(Xe,"library_visual_scenes","visual_scene",(function(e){const t={name:e.getAttribute("name"),children:[]};!function(e){const t=e.getElementsByTagName("node");for(let e=0;e<t.length;e++){const n=t[e];!1===n.hasAttribute("id")&&n.setAttribute("id","three_default_"+nt++)}}(e);const i=n(e,"node");for(let e=0;e<i.length;e++)t.children.push(Pe(i[e]));it.visualScenes[e.getAttribute("id")]=t})),u(Xe,"library_kinematics_models","kinematics_model",(function(e){const t={name:e.getAttribute("name")||"",joints:{},links:[]};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1===i.nodeType&&"technique_common"===i.nodeName)ye(i,t)}it.kinematicsModels[e.getAttribute("id")]=t})),u(Xe,"library_physics_models","physics_model",(function(e){const t={name:e.getAttribute("name")||"",rigidBodies:{}};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1===i.nodeType&&"rigid_body"===i.nodeName)t.rigidBodies[i.getAttribute("name")]={},Se(i,t.rigidBodies[i.getAttribute("name")])}it.physicsModels[e.getAttribute("id")]=t})),u(Xe,"scene","instance_kinematics_scene",(function(e){const t={bindJointAxis:[]};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1===i.nodeType&&"bind_joint_axis"===i.nodeName)t.bindJointAxis.push(Ee(i))}it.kinematicsScenes[o(e.getAttribute("url"))]=t})),h(it.animations,m),h(it.clips,E),h(it.controllers,P),h(it.images,L),h(it.effects,$),h(it.materials,Y),h(it.cameras,ee),h(it.lights,re),h(it.geometries,ue),h(it.visualScenes,Ve),function(){const e=it.clips;if(!0===a(e)){if(!1===a(it.animations)){const e=[];for(const t in it.animations){const n=g(t);for(let t=0,i=n.length;t<i;t++)e.push(n[t])}et.push(new Qr("default",-1,e))}}else for(const t in e)et.push(A(t))}(),function(){const e=Object.keys(it.kinematicsModels)[0],t=Object.keys(it.kinematicsScenes)[0],n=Object.keys(it.visualScenes)[0];if(void 0===e||void 0===t)return;const i=function(e){return d(it.kinematicsModels[e],ge)}(e),r=function(e){return d(it.kinematicsScenes[e],Ae)}(t),s=je(n),o=r.bindJointAxis,a={};for(let e=0,t=o.length;e<t;e++){const t=o[e],n=Xe.querySelector('[sid="'+t.target+'"]');if(n){const e=n.parentElement;l(t.jointIndex,e)}}function l(e,t){const n=t.getAttribute("name"),r=i.joints[e];s.traverse((function(i){i.name===n&&(a[e]={object:i,transforms:Ce(t),joint:r,position:r.zeroPosition})}))}const c=new Gt;tt={joints:i&&i.joints,getJointValue:function(e){const t=a[e];if(t)return t.position;console.warn("THREE.ColladaLoader: Joint "+e+" doesn't exist.")},setJointValue:function(e,t){const n=a[e];if(n){const i=n.joint;if(t>i.limits.max||t<i.limits.min)console.warn("THREE.ColladaLoader: Joint "+e+" value "+t+" outside of limits (min: "+i.limits.min+", max: "+i.limits.max+").");else if(i.static)console.warn("THREE.ColladaLoader: Joint "+e+" is static.");else{const r=n.object,s=i.axis,o=n.transforms;Re.identity();for(let n=0;n<o.length;n++){const r=o[n];if(r.sid&&-1!==r.sid.indexOf(e))switch(i.type){case"revolute":Re.multiply(c.makeRotationAxis(s,He.degToRad(t)));break;case"prismatic":Re.multiply(c.makeTranslation(s.x*t,s.y*t,s.z*t));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+i.type)}else switch(r.type){case"matrix":Re.multiply(r.obj);break;case"translate":Re.multiply(c.makeTranslation(r.obj.x,r.obj.y,r.obj.z));break;case"scale":Re.scale(r.obj);break;case"rotate":Re.multiply(c.makeRotationAxis(r.obj,r.angle))}}r.matrix.copy(Re),r.matrix.decompose(r.position,r.quaternion,r.scale),a[e].position=t}}else console.log("THREE.ColladaLoader: "+e+" does not exist.")}}}();const rt=function(e){return je(o(n(e,"instance_visual_scene")[0].getAttribute("url")))}(n(Xe,"scene")[0]);return rt.animations=et,"Z_UP"===Ke.upAxis&&(console.warn("THREE.ColladaLoader: You are loading an asset with a Z-UP coordinate system. The loader just rotates the asset to transform it into Y-UP. The vertex data are not converted, see #24289."),rt.rotation.set(-Math.PI/2,0,0)),rt.scale.multiplyScalar(Ke.unit),{get animations(){return console.warn("THREE.ColladaLoader: Please access animations over scene.animations now."),et},kinematics:tt,library:it,scene:rt}}},AFRAME.registerComponent("collada-model-legacy",{schema:{type:"asset"},init:function(){this.model=null,this.loader=new THREE.ColladaLoader},update:function(){var e=this,t=this.el,n=this.data,i=this.el.sceneEl.systems.renderer;n&&(this.remove(),this.loader.load(n,(function(n){e.model=n.scene,e.model.traverse((function(e){if(e.isMesh){var t=e.material;t.color&&i.applyColorCorrection(t.color),t.map&&i.applyColorCorrection(t.map),t.emissive&&i.applyColorCorrection(t.emissive),t.emissiveMap&&i.applyColorCorrection(t.emissiveMap)}})),t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"collada",model:e.model})})))},remove:function(){this.model&&this.el.removeObject3D("mesh")}});var ks=Uint8Array,Os=Uint16Array,Us=Int32Array,Fs=new ks([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Bs=new ks([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),zs=new ks([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Vs=function(e,t){for(var n=new Os(31),i=0;i<31;++i)n[i]=t+=1<<e[i-1];var r=new Us(n[30]);for(i=1;i<30;++i)for(var s=n[i];s<n[i+1];++s)r[s]=s-n[i]<<5|i;return{b:n,r:r}},Gs=Vs(Fs,2),js=Gs.b,Hs=Gs.r;js[28]=258,Hs[258]=28;for(var Ws=Vs(Bs,0).b,qs=new Os(32768),Xs=0;Xs<32768;++Xs){var $s=(43690&Xs)>>1|(21845&Xs)<<1;$s=(61680&($s=(52428&$s)>>2|(13107&$s)<<2))>>4|(3855&$s)<<4,qs[Xs]=((65280&$s)>>8|(255&$s)<<8)>>1}var Ys=function(e,t,n){for(var i=e.length,r=0,s=new Os(t);r<i;++r)e[r]&&++s[e[r]-1];var o,a=new Os(t);for(r=1;r<t;++r)a[r]=a[r-1]+s[r-1]<<1;if(n){o=new Os(1<<t);var l=15-t;for(r=0;r<i;++r)if(e[r])for(var c=r<<4|e[r],u=t-e[r],h=a[e[r]-1]++<<u,d=h|(1<<u)-1;h<=d;++h)o[qs[h]>>l]=c}else for(o=new Os(i),r=0;r<i;++r)e[r]&&(o[r]=qs[a[e[r]-1]++]>>15-e[r]);return o},Ks=new ks(288);for(Xs=0;Xs<144;++Xs)Ks[Xs]=8;for(Xs=144;Xs<256;++Xs)Ks[Xs]=9;for(Xs=256;Xs<280;++Xs)Ks[Xs]=7;for(Xs=280;Xs<288;++Xs)Ks[Xs]=8;var Zs=new ks(32);for(Xs=0;Xs<32;++Xs)Zs[Xs]=5;var Js=Ys(Ks,9,1),Qs=Ys(Zs,5,1),eo=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},to=function(e,t,n){var i=t/8|0;return(e[i]|e[i+1]<<8)>>(7&t)&n},no=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},io=function(e){return(e+7)/8|0},ro=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],so=function(e,t,n){var i=new Error(t||ro[e]);if(i.code=e,Error.captureStackTrace&&Error.captureStackTrace(i,so),!n)throw i;return i},oo=function(e,t,n,i){var r=e.length;if(!r||t.f&&!t.l)return n||new ks(0);var s=!n,o=s||2!=t.i,a=t.i;s&&(n=new ks(3*r));var l=function(e){var t=n.length;if(e>t){var i=new ks(Math.max(2*t,e));i.set(n),n=i}},c=t.f||0,u=t.p||0,h=t.b||0,d=t.l,p=t.d,f=t.m,m=t.n,g=8*r;do{if(!d){c=to(e,u,1);var y=to(e,u+1,3);if(u+=3,!y){var v=e[(R=io(u)+4)-4]|e[R-3]<<8,_=R+v;if(_>r){a&&so(0);break}o&&l(h+v),n.set(e.subarray(R,_),h),t.b=h+=v,t.p=u=8*_,t.f=c;continue}if(1==y)d=Js,p=Qs,f=9,m=5;else if(2==y){var x=to(e,u,31)+257,b=to(e,u+10,15)+4,w=x+to(e,u+5,31)+1;u+=14;for(var T=new ks(w),S=new ks(19),M=0;M<b;++M)S[zs[M]]=to(e,u+3*M,7);u+=3*b;var E=eo(S),A=(1<<E)-1,C=Ys(S,E,1);for(M=0;M<w;){var R,N=C[to(e,u,A)];if(u+=15&N,(R=N>>4)<16)T[M++]=R;else{var P=0,D=0;for(16==R?(D=3+to(e,u,3),u+=2,P=T[M-1]):17==R?(D=3+to(e,u,7),u+=3):18==R&&(D=11+to(e,u,127),u+=7);D--;)T[M++]=P}}var L=T.subarray(0,x),I=T.subarray(x);f=eo(L),m=eo(I),d=Ys(L,f,1),p=Ys(I,m,1)}else so(1);if(u>g){a&&so(0);break}}o&&l(h+131072);for(var k=(1<<f)-1,O=(1<<m)-1,U=u;;U=u){var F=(P=d[no(e,u)&k])>>4;if((u+=15&P)>g){a&&so(0);break}if(P||so(2),F<256)n[h++]=F;else{if(256==F){U=u,d=null;break}var B=F-254;if(F>264){var z=Fs[M=F-257];B=to(e,u,(1<<z)-1)+js[M],u+=z}var V=p[no(e,u)&O],G=V>>4;V||so(3),u+=15&V;I=Ws[G];if(G>3){z=Bs[G];I+=no(e,u)&(1<<z)-1,u+=z}if(u>g){a&&so(0);break}o&&l(h+131072);var j=h+B;if(h<I){var H=0-I,W=Math.min(I,j);for(H+h<0&&so(3);h<W;++h)n[h]=i[H+h]}for(;h<j;++h)n[h]=n[h-I]}}t.l=d,t.p=U,t.b=h,t.f=c,d&&(c=1,t.m=f,t.d=p,t.n=m)}while(!c);return h!=n.length&&s?function(e,t,n){return(null==n||n>e.length)&&(n=e.length),new ks(e.subarray(t,n))}(n,0,h):n.subarray(0,h)},ao=new ks(0);function lo(e,t){return oo(e.subarray(function(e){return(8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31)&&so(6,"invalid zlib data"),1==(e[1]>>5&1)&&so(6,"invalid zlib data: "+(32&e[1]?"need":"unexpected")+" dictionary"),2+(e[1]>>3&4)}(e),-4),{i:2},t,t)}var co="undefined"!=typeof TextDecoder&&new TextDecoder;try{co.decode(ao,{stream:!0})}catch(Hq){}function uo(e,t,n){const i=n.length-e-1;if(t>=n[i])return i-1;if(t<=n[e])return e;let r=e,s=i,o=Math.floor((r+s)/2);for(;t<n[o]||t>=n[o+1];)t<n[o]?s=o:r=o,o=Math.floor((r+s)/2);return o}function ho(e,t){let n=1;for(let t=2;t<=e;++t)n*=t;let i=1;for(let e=2;e<=t;++e)i*=e;for(let n=2;n<=e-t;++n)i*=n;return n/i}function po(e,t,n,i,r){const s=function(e,t,n,i,r){const s=r<e?r:e,o=[],a=uo(e,i,t),l=function(e,t,n,i,r){const s=[];for(let e=0;e<=n;++e)s[e]=0;const o=[];for(let e=0;e<=i;++e)o[e]=s.slice(0);const a=[];for(let e=0;e<=n;++e)a[e]=s.slice(0);a[0][0]=1;const l=s.slice(0),c=s.slice(0);for(let i=1;i<=n;++i){l[i]=t-r[e+1-i],c[i]=r[e+i]-t;let n=0;for(let e=0;e<i;++e){const t=c[e+1],r=l[i-e];a[i][e]=t+r;const s=a[e][i-1]/a[i][e];a[e][i]=n+t*s,n=r*s}a[i][i]=n}for(let e=0;e<=n;++e)o[0][e]=a[e][n];for(let e=0;e<=n;++e){let t=0,r=1;const l=[];for(let e=0;e<=n;++e)l[e]=s.slice(0);l[0][0]=1;for(let s=1;s<=i;++s){let i=0;const c=e-s,u=n-s;e>=s&&(l[r][0]=l[t][0]/a[u+1][c],i=l[r][0]*a[c][u]);const h=e-1<=u?s-1:n-e;for(let e=c>=-1?1:-c;e<=h;++e)l[r][e]=(l[t][e]-l[t][e-1])/a[u+1][c+e],i+=l[r][e]*a[c+e][u];e<=u&&(l[r][s]=-l[t][s-1]/a[u+1][e],i+=l[r][s]*a[e][u]),o[s][e]=i;const d=t;t=r,r=d}}let u=n;for(let e=1;e<=i;++e){for(let t=0;t<=n;++t)o[e][t]*=u;u*=n-e}return o}(a,i,e,s,t),c=[];for(let e=0;e<n.length;++e){const t=n[e].clone(),i=t.w;t.x*=i,t.y*=i,t.z*=i,c[e]=t}for(let t=0;t<=s;++t){const n=c[a-e].clone().multiplyScalar(l[t][0]);for(let i=1;i<=e;++i)n.add(c[a-e+i].clone().multiplyScalar(l[t][i]));o[t]=n}for(let e=s+1;e<=r+1;++e)o[e]=new ut(0,0,0);return o}(e,t,n,i,r);return function(e){const t=e.length,n=[],i=[];for(let r=0;r<t;++r){const t=e[r];n[r]=new dt(t.x,t.y,t.z),i[r]=t.w}const r=[];for(let e=0;e<t;++e){const t=n[e].clone();for(let n=1;n<=e;++n)t.sub(r[e-n].clone().multiplyScalar(ho(e,n)*i[n]));r[e]=t.divideScalar(i[0])}return r}(s)}class fo extends or{constructor(e,t,n,i,r){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=i||0,this.endKnot=r||this.knots.length-1;for(let e=0;e<n.length;++e){const t=n[e];this.controlPoints[e]=new ut(t.x,t.y,t.z,t.w)}}getPoint(e,t=new dt){const n=t,i=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),r=function(e,t,n,i){const r=uo(e,i,t),s=function(e,t,n,i){const r=[],s=[],o=[];r[0]=1;for(let a=1;a<=n;++a){s[a]=t-i[e+1-a],o[a]=i[e+a]-t;let n=0;for(let e=0;e<a;++e){const t=o[e+1],i=s[a-e],l=r[e]/(t+i);r[e]=n+t*l,n=i*l}r[a]=n}return r}(r,i,e,t),o=new ut(0,0,0,0);for(let t=0;t<=e;++t){const i=n[r-e+t],a=s[t],l=i.w*a;o.x+=i.x*l,o.y+=i.y*l,o.z+=i.z*l,o.w+=i.w*a}return o}(this.degree,this.knots,this.controlPoints,i);return 1!==r.w&&r.divideScalar(r.w),n.set(r.x,r.y,r.z)}getTangent(e,t=new dt){const n=t,i=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=po(this.degree,this.knots,this.controlPoints,i,1);return n.copy(r[1]).normalize(),n}}
/**
   * Loader loads FBX file and generates Group representing FBX scene.
   * Requires FBX file to be >= 7.0 and in ASCII or >= 6400 in Binary format
   * Versions lower than this may load but will probably have errors
   *
   * Needs Support:
   *  Morph normals / blend shape normals
   *
   * FBX format references:
   * 	https://help.autodesk.com/view/FBX/2017/ENU/?guid=__cpp_ref_index_html (C++ SDK reference)
   *
   * Binary format specification:
   *	https://code.blender.org/2013/08/fbx-binary-file-format-specification/
   */let mo,go,yo;class vo{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){go=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),i=this.parseDeformers(),r=(new _o).parse(i);return this.parseScene(i,r,n),yo}parseConnections(){const e=new Map;if("Connections"in mo){mo.Connections.connections.forEach((function(t){const n=t[0],i=t[1],r=t[2];e.has(n)||e.set(n,{parents:[],children:[]});const s={ID:i,relationship:r};e.get(n).parents.push(s),e.has(i)||e.set(i,{parents:[],children:[]});const o={ID:n,relationship:r};e.get(i).children.push(o)}))}return e}parseImages(){const e={},t={};if("Video"in mo.Objects){const n=mo.Objects.Video;for(const i in n){const r=n[i];if(e[parseInt(i)]=r.RelativeFilename||r.Filename,"Content"in r){const e=r.Content instanceof ArrayBuffer&&r.Content.byteLength>0,s="string"==typeof r.Content&&""!==r.Content;if(e||s){const e=this.parseImage(n[i]);t[r.RelativeFilename||r.Filename]=e}}}}for(const n in e){const i=e[n];void 0!==t[i]?e[n]=t[i]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,i=n.slice(n.lastIndexOf(".")+1).toLowerCase();let r;switch(i){case"bmp":r="image/bmp";break;case"jpg":case"jpeg":r="image/jpeg";break;case"png":r="image/png";break;case"tif":r="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",n),r="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+i+'" is not supported.')}if("string"==typeof t)return"data:"+r+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:r}))}}parseTextures(e){const t=new Map;if("Texture"in mo.Objects){const n=mo.Objects.Texture;for(const i in n){const r=this.parseTexture(n[i],e);t.set(parseInt(i),r)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const i=e.WrapModeU,r=e.WrapModeV,s=void 0!==i?i.value:0,o=void 0!==r?r.value:0;if(n.wrapS=0===s?fe:me,n.wrapT=0===o?fe:me,"Scaling"in e){const t=e.Scaling.value;n.repeat.x=t[0],n.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;n.offset.x=t[0],n.offset.y=t[1]}return n}loadTexture(e,t){let n;const i=this.textureLoader.path,r=go.get(e.id).children;let s;void 0!==r&&r.length>0&&void 0!==t[r[0].ID]&&(n=t[r[0].ID],0!==n.indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));const o=e.FileName.slice(-3).toLowerCase();if("tga"===o){const t=this.manager.getHandler(".tga");null===t?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),s=new ct):(t.setPath(this.textureLoader.path),s=t.load(n))}else if("dds"===o){const t=this.manager.getHandler(".dds");null===t?(console.warn("FBXLoader: DDS loader not found, creating placeholder texture for",e.RelativeFilename),s=new ct):(t.setPath(this.textureLoader.path),s=t.load(n))}else"psd"===o?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),s=new ct):s=this.textureLoader.load(n);return this.textureLoader.setPath(i),s}parseMaterials(e){const t=new Map;if("Material"in mo.Objects){const n=mo.Objects.Material;for(const i in n){const r=this.parseMaterial(n[i],e);null!==r&&t.set(parseInt(i),r)}}return t}parseMaterial(e,t){const n=e.id,i=e.attrName;let r=e.ShadingModel;if("object"==typeof r&&(r=r.value),!go.has(n))return null;const s=this.parseParameters(e,t,n);let o;switch(r.toLowerCase()){case"phong":o=new kr;break;case"lambert":o=new Or;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',r),o=new kr}return o.setValues(s),o.name=i,o}parseParameters(e,t,n){const i={};e.BumpFactor&&(i.bumpScale=e.BumpFactor.value),e.Diffuse?i.color=(new Dn).fromArray(e.Diffuse.value).convertSRGBToLinear():!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(i.color=(new Dn).fromArray(e.DiffuseColor.value).convertSRGBToLinear()),e.DisplacementFactor&&(i.displacementScale=e.DisplacementFactor.value),e.Emissive?i.emissive=(new Dn).fromArray(e.Emissive.value).convertSRGBToLinear():!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(i.emissive=(new Dn).fromArray(e.EmissiveColor.value).convertSRGBToLinear()),e.EmissiveFactor&&(i.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(i.opacity=parseFloat(e.Opacity.value)),i.opacity<1&&(i.transparent=!0),e.ReflectionFactor&&(i.reflectivity=e.ReflectionFactor.value),e.Shininess&&(i.shininess=e.Shininess.value),e.Specular?i.specular=(new Dn).fromArray(e.Specular.value).convertSRGBToLinear():e.SpecularColor&&"Color"===e.SpecularColor.type&&(i.specular=(new Dn).fromArray(e.SpecularColor.value).convertSRGBToLinear());const r=this;return go.get(n).children.forEach((function(e){const n=e.relationship;switch(n){case"Bump":i.bumpMap=r.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":i.aoMap=r.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":i.map=r.getTexture(t,e.ID),void 0!==i.map&&(i.map.colorSpace=Te);break;case"DisplacementColor":i.displacementMap=r.getTexture(t,e.ID);break;case"EmissiveColor":i.emissiveMap=r.getTexture(t,e.ID),void 0!==i.emissiveMap&&(i.emissiveMap.colorSpace=Te);break;case"NormalMap":case"Maya|TEX_normal_map":i.normalMap=r.getTexture(t,e.ID);break;case"ReflectionColor":i.envMap=r.getTexture(t,e.ID),void 0!==i.envMap&&(i.envMap.mapping=303,i.envMap.colorSpace=Te);break;case"SpecularColor":i.specularMap=r.getTexture(t,e.ID),void 0!==i.specularMap&&(i.specularMap.colorSpace=Te);break;case"TransparentColor":case"TransparencyFactor":i.alphaMap=r.getTexture(t,e.ID),i.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",n)}})),i}getTexture(e,t){return"LayeredTexture"in mo.Objects&&t in mo.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=go.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in mo.Objects){const n=mo.Objects.Deformer;for(const i in n){const r=n[i],s=go.get(parseInt(i));if("Skin"===r.attrType){const t=this.parseSkeleton(s,n);t.ID=i,s.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=s.parents[0].ID,e[i]=t}else if("BlendShape"===r.attrType){const e={id:i};e.rawTargets=this.parseMorphTargets(s,n),e.id=i,s.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[i]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach((function(e){const i=t[e.ID];if("Cluster"!==i.attrType)return;const r={ID:e.ID,indices:[],weights:[],transformLink:(new Gt).fromArray(i.TransformLink.a)};"Indexes"in i&&(r.indices=i.Indexes.a,r.weights=i.Weights.a),n.push(r)})),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let i=0;i<e.children.length;i++){const r=e.children[i],s=t[r.ID],o={name:s.attrName,initialWeight:s.DeformPercent,id:s.id,fullWeights:s.FullWeights.a};if("BlendShapeChannel"!==s.attrType)return;o.geoID=go.get(parseInt(r.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(o)}return n}parseScene(e,t,n){yo=new Ni;const i=this.parseModels(e.skeletons,t,n),r=mo.Objects.Model,s=this;i.forEach((function(e){const t=r[e.ID];s.setLookAtProperties(e,t);go.get(e.ID).parents.forEach((function(t){const n=i.get(t.ID);void 0!==n&&n.add(e)})),null===e.parent&&yo.add(e)})),this.bindSkeleton(e.skeletons,t,i),this.addGlobalSceneSettings(),yo.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=Po(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const o=(new xo).parse();1===yo.children.length&&yo.children[0].isGroup&&(yo.children[0].animations=o,yo=yo.children[0]),yo.animations=o}parseModels(e,t,n){const i=new Map,r=mo.Objects.Model;for(const s in r){const o=parseInt(s),a=r[s],l=go.get(o);let c=this.buildSkeleton(l,e,o,a.attrName);if(!c){switch(a.attrType){case"Camera":c=this.createCamera(l);break;case"Light":c=this.createLight(l);break;case"Mesh":c=this.createMesh(l,t,n);break;case"NurbsCurve":c=this.createCurve(l,t);break;case"LimbNode":case"Root":c=new Gi;break;default:c=new Ni}c.name=a.attrName?Ls.sanitizeNodeName(a.attrName):"",c.userData.originalName=a.attrName,c.ID=o}this.getTransformData(c,a),i.set(o,c)}return i}buildSkeleton(e,t,n,i){let r=null;return e.parents.forEach((function(e){for(const s in t){const o=t[s];o.rawBones.forEach((function(t,s){if(t.ID===e.ID){const e=r;r=new Gi,r.matrixWorld.copy(t.transformLink),r.name=i?Ls.sanitizeNodeName(i):"",r.userData.originalName=i,r.ID=n,o.bones[s]=r,null!==e&&r.add(e)}}))}})),r}createCamera(e){let t,n;if(e.children.forEach((function(e){const t=mo.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new gn;else{let e=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(e=1);let i=1;void 0!==n.NearPlane&&(i=n.NearPlane.value/1e3);let r=1e3;void 0!==n.FarPlane&&(r=n.FarPlane.value/1e3);let s=window.innerWidth,o=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(s=n.AspectWidth.value,o=n.AspectHeight.value);const a=s/o;let l=45;void 0!==n.FieldOfView&&(l=n.FieldOfView.value);const c=n.FocalLength?n.FocalLength.value:null;switch(e){case 0:t=new xi(l,a,i,r),null!==c&&t.setFocalLength(c);break;case 1:t=new Ci(-s/2,s/2,o/2,-o/2,i,r);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),t=new gn}}return t}createLight(e){let t,n;if(e.children.forEach((function(e){const t=mo.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new gn;else{let e;e=void 0===n.LightType?0:n.LightType.value;let i=16777215;void 0!==n.Color&&(i=(new Dn).fromArray(n.Color.value).convertSRGBToLinear());let r=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(r=0);let s=0;void 0!==n.FarAttenuationEnd&&(s=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);const o=1;switch(e){case 0:t=new ws(i,r,s,o);break;case 1:t=new Ss(i,r);break;case 2:let e=Math.PI/3;void 0!==n.InnerAngle&&(e=He.degToRad(n.InnerAngle.value));let a=0;void 0!==n.OuterAngle&&(a=He.degToRad(n.OuterAngle.value),a=Math.max(a,1)),t=new ys(i,r,s,e,a,o);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new ws(i,r)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,n){let i,r=null,s=null;const o=[];return e.children.forEach((function(e){t.has(e.ID)&&(r=t.get(e.ID)),n.has(e.ID)&&o.push(n.get(e.ID))})),o.length>1?s=o:o.length>0?s=o[0]:(s=new kr({name:rs.DEFAULT_MATERIAL_NAME,color:13421772}),o.push(s)),"color"in r.attributes&&o.forEach((function(e){e.vertexColors=!0})),r.FBX_Deformer?(i=new Vi(r,s),i.normalizeSkinWeights()):i=new fi(r,s),i}createCurve(e,t){const n=e.children.reduce((function(e,n){return t.has(n.ID)&&(e=t.get(n.ID)),e}),null),i=new Xi({name:rs.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new tr(n,i)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),n.eulerOrder="RotationOrder"in t?Do(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){if("LookAtProperty"in t){go.get(e.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){const n=mo.Objects.Model[t.ID];if("Lcl_Translation"in n){const t=n.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),yo.add(e.target)):e.lookAt((new dt).fromArray(t))}}}))}}bindSkeleton(e,t,n){const i=this.parsePoseNodes();for(const r in e){const s=e[r];go.get(parseInt(s.ID)).parents.forEach((function(e){if(t.has(e.ID)){const t=e.ID;go.get(t).parents.forEach((function(e){if(n.has(e.ID)){n.get(e.ID).bind(new qi(s.bones),i[e.ID])}}))}}))}}parsePoseNodes(){const e={};if("Pose"in mo.Objects){const t=mo.Objects.Pose;for(const n in t)if("BindPose"===t[n].attrType&&t[n].NbPoseNodes>0){const i=t[n].PoseNode;Array.isArray(i)?i.forEach((function(t){e[t.Node]=(new Gt).fromArray(t.Matrix.a)})):e[i.Node]=(new Gt).fromArray(i.Matrix.a)}}return e}addGlobalSceneSettings(){if("GlobalSettings"in mo){if("AmbientColor"in mo.GlobalSettings){const e=mo.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],i=e[2];if(0!==t||0!==n||0!==i){const e=new Dn(t,n,i).convertSRGBToLinear();yo.add(new Ms(e,1))}}"UnitScaleFactor"in mo.GlobalSettings&&(yo.userData.unitScaleFactor=mo.GlobalSettings.UnitScaleFactor.value)}}}class _o{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in mo.Objects){const n=mo.Objects.Geometry;for(const i in n){const r=go.get(parseInt(i)),s=this.parseGeometry(r,n[i],e);t.set(parseInt(i),s)}}return!0===this.negativeMaterialIndices&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const i=n.skeletons,r=[],s=e.parents.map((function(e){return mo.Objects.Model[e.ID]}));if(0===s.length)return;const o=e.children.reduce((function(e,t){return void 0!==i[t.ID]&&(e=i[t.ID]),e}),null);e.children.forEach((function(e){void 0!==n.morphTargets[e.ID]&&r.push(n.morphTargets[e.ID])}));const a=s[0],l={};"RotationOrder"in a&&(l.eulerOrder=Do(a.RotationOrder.value)),"InheritType"in a&&(l.inheritType=parseInt(a.InheritType.value)),"GeometricTranslation"in a&&(l.translation=a.GeometricTranslation.value),"GeometricRotation"in a&&(l.rotation=a.GeometricRotation.value),"GeometricScaling"in a&&(l.scale=a.GeometricScaling.value);const c=Po(l);return this.genGeometry(t,o,r,c)}genGeometry(e,t,n,i){const r=new Kn;e.attrName&&(r.name=e.attrName);const s=this.parseGeoNode(e,t),o=this.genBuffers(s),a=new Gn(o.vertex,3);if(a.applyMatrix4(i),r.setAttribute("position",a),o.colors.length>0&&r.setAttribute("color",new Gn(o.colors,3)),t&&(r.setAttribute("skinIndex",new zn(o.weightsIndices,4)),r.setAttribute("skinWeight",new Gn(o.vertexWeights,4)),r.FBX_Deformer=t),o.normal.length>0){const e=(new qe).getNormalMatrix(i),t=new Gn(o.normal,3);t.applyNormalMatrix(e),r.setAttribute("normal",t)}if(o.uvs.forEach((function(e,t){const n=0===t?"uv":`uv${t}`;r.setAttribute(n,new Gn(o.uvs[t],2))})),s.material&&"AllSame"!==s.material.mappingType){let e=o.materialIndex[0],t=0;if(o.materialIndex.forEach((function(n,i){n!==e&&(r.addGroup(t,i-t,e),e=n,t=i)})),r.groups.length>0){const t=r.groups[r.groups.length-1],n=t.start+t.count;n!==o.materialIndex.length&&r.addGroup(n,o.materialIndex.length-n,e)}0===r.groups.length&&r.addGroup(0,o.materialIndex.length,o.materialIndex[0])}return this.addMorphTargets(r,e,n,i),r}parseGeoNode(e,t){const n={};if(n.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],n.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return n.weightTable={},null!==t&&(n.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(i,r){void 0===n.weightTable[i]&&(n.weightTable[i]=[]),n.weightTable[i].push({id:t,weight:e.weights[r]})}))}))),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,i=0,r=!1,s=[],o=[],a=[],l=[],c=[],u=[];const h=this;return e.vertexIndices.forEach((function(d,p){let f,m=!1;d<0&&(d^=-1,m=!0);let g=[],y=[];if(s.push(3*d,3*d+1,3*d+2),e.color){const t=Co(p,n,d,e.color);a.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach((function(e){y.push(e.weight),g.push(e.id)})),y.length>4){r||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),r=!0);const e=[0,0,0,0],t=[0,0,0,0];y.forEach((function(n,i){let r=n,s=g[i];t.forEach((function(t,n,i){if(r>t){i[n]=r,r=t;const o=e[n];e[n]=s,s=o}}))})),g=e,y=t}for(;y.length<4;)y.push(0),g.push(0);for(let e=0;e<4;++e)c.push(y[e]),u.push(g[e])}if(e.normal){const t=Co(p,n,d,e.normal);o.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(f=Co(p,n,d,e.material)[0],f<0&&(h.negativeMaterialIndices=!0,f=0)),e.uv&&e.uv.forEach((function(e,t){const i=Co(p,n,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(i[0]),l[t].push(i[1])})),i++,m&&(h.genFace(t,e,s,f,o,a,l,c,u,i),n++,i=0,s=[],o=[],a=[],l=[],c=[],u=[])})),t}getNormalNewell(e){const t=new dt(0,0,0);for(let n=0;n<e.length;n++){const i=e[n],r=e[(n+1)%e.length];t.x+=(i.y-r.y)*(i.z+r.z),t.y+=(i.z-r.z)*(i.x+r.x),t.z+=(i.x-r.x)*(i.y+r.y)}return t.normalize(),t}getNormalTangentAndBitangent(e){const t=this.getNormalNewell(e),n=(Math.abs(t.z)>.5?new dt(0,1,0):new dt(0,0,1)).cross(t).normalize(),i=t.clone().cross(n).normalize();return{normal:t,tangent:n,bitangent:i}}flattenVertex(e,t,n){return new We(e.dot(t),e.dot(n))}genFace(e,t,n,i,r,s,o,a,l,c){let u;if(c>3){const e=[];for(let i=0;i<n.length;i+=3)e.push(new dt(t.vertexPositions[n[i]],t.vertexPositions[n[i+1]],t.vertexPositions[n[i+2]]));const{tangent:i,bitangent:r}=this.getNormalTangentAndBitangent(e),s=[];for(const t of e)s.push(this.flattenVertex(t,i,r));u=Dr.triangulateShape(s,[])}else u=[[0,1,2]];for(const[c,h,d]of u)e.vertex.push(t.vertexPositions[n[3*c]]),e.vertex.push(t.vertexPositions[n[3*c+1]]),e.vertex.push(t.vertexPositions[n[3*c+2]]),e.vertex.push(t.vertexPositions[n[3*h]]),e.vertex.push(t.vertexPositions[n[3*h+1]]),e.vertex.push(t.vertexPositions[n[3*h+2]]),e.vertex.push(t.vertexPositions[n[3*d]]),e.vertex.push(t.vertexPositions[n[3*d+1]]),e.vertex.push(t.vertexPositions[n[3*d+2]]),t.skeleton&&(e.vertexWeights.push(a[4*c]),e.vertexWeights.push(a[4*c+1]),e.vertexWeights.push(a[4*c+2]),e.vertexWeights.push(a[4*c+3]),e.vertexWeights.push(a[4*h]),e.vertexWeights.push(a[4*h+1]),e.vertexWeights.push(a[4*h+2]),e.vertexWeights.push(a[4*h+3]),e.vertexWeights.push(a[4*d]),e.vertexWeights.push(a[4*d+1]),e.vertexWeights.push(a[4*d+2]),e.vertexWeights.push(a[4*d+3]),e.weightsIndices.push(l[4*c]),e.weightsIndices.push(l[4*c+1]),e.weightsIndices.push(l[4*c+2]),e.weightsIndices.push(l[4*c+3]),e.weightsIndices.push(l[4*h]),e.weightsIndices.push(l[4*h+1]),e.weightsIndices.push(l[4*h+2]),e.weightsIndices.push(l[4*h+3]),e.weightsIndices.push(l[4*d]),e.weightsIndices.push(l[4*d+1]),e.weightsIndices.push(l[4*d+2]),e.weightsIndices.push(l[4*d+3])),t.color&&(e.colors.push(s[3*c]),e.colors.push(s[3*c+1]),e.colors.push(s[3*c+2]),e.colors.push(s[3*h]),e.colors.push(s[3*h+1]),e.colors.push(s[3*h+2]),e.colors.push(s[3*d]),e.colors.push(s[3*d+1]),e.colors.push(s[3*d+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(i),e.materialIndex.push(i),e.materialIndex.push(i)),t.normal&&(e.normal.push(r[3*c]),e.normal.push(r[3*c+1]),e.normal.push(r[3*c+2]),e.normal.push(r[3*h]),e.normal.push(r[3*h+1]),e.normal.push(r[3*h+2]),e.normal.push(r[3*d]),e.normal.push(r[3*d+1]),e.normal.push(r[3*d+2])),t.uv&&t.uv.forEach((function(t,n){void 0===e.uvs[n]&&(e.uvs[n]=[]),e.uvs[n].push(o[n][2*c]),e.uvs[n].push(o[n][2*c+1]),e.uvs[n].push(o[n][2*h]),e.uvs[n].push(o[n][2*h+1]),e.uvs[n].push(o[n][2*d]),e.uvs[n].push(o[n][2*d+1])}))}addMorphTargets(e,t,n,i){if(0===n.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const r=this;n.forEach((function(n){n.rawTargets.forEach((function(n){const s=mo.Objects.Geometry[n.geoID];void 0!==s&&r.genMorphGeometry(e,t,s,i,n.name)}))}))}genMorphGeometry(e,t,n,i,r){const s=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],o=void 0!==n.Vertices?n.Vertices.a:[],a=void 0!==n.Indexes?n.Indexes.a:[],l=3*e.attributes.position.count,c=new Float32Array(l);for(let e=0;e<a.length;e++){const t=3*a[e];c[t]=o[3*e],c[t+1]=o[3*e+1],c[t+2]=o[3*e+2]}const u={vertexIndices:s,vertexPositions:c},h=this.genBuffers(u),d=new Gn(h.vertex,3);d.name=r||n.attrName,d.applyMatrix4(i),e.morphAttributes.position.push(d)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,i=e.Normals.a;let r=[];return"IndexToDirect"===n&&("NormalIndex"in e?r=e.NormalIndex.a:"NormalsIndex"in e&&(r=e.NormalsIndex.a)),{dataSize:3,buffer:i,indices:r,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,i=e.UV.a;let r=[];return"IndexToDirect"===n&&(r=e.UVIndex.a),{dataSize:2,buffer:i,indices:r,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,i=e.Colors.a;let r=[];"IndexToDirect"===n&&(r=e.ColorIndex.a);for(let e=0,t=new Dn;e<i.length;e+=4)t.fromArray(i,e).convertSRGBToLinear().toArray(i,e);return{dataSize:4,buffer:i,indices:r,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const i=e.Materials.a,r=[];for(let e=0;e<i.length;++e)r.push(e);return{dataSize:1,buffer:i,indices:r,mappingType:t,referenceType:n}}parseNurbsGeometry(e){const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new Kn;const n=t-1,i=e.KnotVector.a,r=[],s=e.Points.a;for(let e=0,t=s.length;e<t;e+=4)r.push((new ut).fromArray(s,e));let o,a;if("Closed"===e.Form)r.push(r[0]);else if("Periodic"===e.Form){o=n,a=i.length-1-o;for(let e=0;e<n;++e)r.push(r[e])}const l=new fo(n,i,r,o,a).getPoints(12*r.length);return(new Kn).setFromPoints(l)}}class xo{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const n in t){const i=t[n],r=this.addClip(i);e.push(r)}return e}parseClips(){if(void 0===mo.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=mo.Objects.AnimationCurveNode,t=new Map;for(const n in e){const i=e[n];if(null!==i.attrName.match(/S|R|T|DeformPercent/)){const e={id:i.id,attr:i.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=mo.Objects.AnimationCurve;for(const n in t){const i={id:t[n].id,times:t[n].KeyTime.a.map(Eo),values:t[n].KeyValueFloat.a},r=go.get(i.id);if(void 0!==r){const t=r.parents[0].ID,n=r.parents[0].relationship;n.match(/X/)?e.get(t).curves.x=i:n.match(/Y/)?e.get(t).curves.y=i:n.match(/Z/)?e.get(t).curves.z=i:n.match(/DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=i)}}}parseAnimationLayers(e){const t=mo.Objects.AnimationLayer,n=new Map;for(const i in t){const t=[],r=go.get(parseInt(i));if(void 0!==r){r.children.forEach((function(n,i){if(e.has(n.ID)){const r=e.get(n.ID);if(void 0!==r.curves.x||void 0!==r.curves.y||void 0!==r.curves.z){if(void 0===t[i]){const e=go.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const r=mo.Objects.Model[e.toString()];if(void 0===r)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",n);const s={modelName:r.attrName?Ls.sanitizeNodeName(r.attrName):"",ID:r.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};yo.traverse((function(e){e.ID===r.id&&(s.transform=e.matrix,e.userData.transformData&&(s.eulerOrder=e.userData.transformData.eulerOrder))})),s.transform||(s.transform=new Gt),"PreRotation"in r&&(s.preRotation=r.PreRotation.value),"PostRotation"in r&&(s.postRotation=r.PostRotation.value),t[i]=s}}t[i]&&(t[i][r.attr]=r)}else if(void 0!==r.curves.morph){if(void 0===t[i]){const e=go.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,r=go.get(e).parents[0].ID,s=go.get(r).parents[0].ID,o=go.get(s).parents[0].ID,a=mo.Objects.Model[o],l={modelName:a.attrName?Ls.sanitizeNodeName(a.attrName):"",morphName:mo.Objects.Deformer[e].attrName};t[i]=l}t[i][r.attr]=r}}})),n.set(parseInt(i),t)}}return n}parseAnimStacks(e){const t=mo.Objects.AnimationStack,n={};for(const i in t){const r=go.get(parseInt(i)).children;r.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const s=e.get(r[0].ID);n[i]={name:t[i].attrName,layer:s}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach((function(e){t=t.concat(n.generateTracks(e))})),new Qr(e.name,-1,t)}generateTracks(e){const t=[];let n=new dt,i=new dt;if(e.transform&&e.transform.decompose(n,new ht,i),n=n.toArray(),i=i.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const i=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");void 0!==i&&t.push(i)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const n=this.generateRotationTrack(e.modelName,e.R.curves,e.preRotation,e.postRotation,e.eulerOrder);void 0!==n&&t.push(n)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const n=this.generateVectorTrack(e.modelName,e.S.curves,i,"scale");void 0!==n&&t.push(n)}if(void 0!==e.DeformPercent){const n=this.generateMorphTrack(e);void 0!==n&&t.push(n)}return t}generateVectorTrack(e,t,n,i){const r=this.getTimesForAllAxes(t),s=this.getKeyframeTrackValues(r,t,n);return new Jr(e+"."+i,r,s)}generateRotationTrack(e,t,n,i,r){let s,o;if(void 0!==t.x&&void 0!==t.y&&void 0!==t.z){const e=this.interpolateRotations(t.x,t.y,t.z,r);s=e[0],o=e[1]}void 0!==n&&((n=n.map(He.degToRad)).push(r),n=(new Jt).fromArray(n),n=(new ht).setFromEuler(n)),void 0!==i&&((i=i.map(He.degToRad)).push(r),i=(new Jt).fromArray(i),i=(new ht).setFromEuler(i).invert());const a=new ht,l=new Jt,c=[];if(!o||!s)return new Kr(e+".quaternion",[0],[0]);for(let e=0;e<o.length;e+=3){if(l.set(o[e],o[e+1],o[e+2],r),a.setFromEuler(l),void 0!==n&&a.premultiply(n),void 0!==i&&a.multiply(i),e>2){(new ht).fromArray(c,(e-3)/3*4).dot(a)<0&&a.set(-a.x,-a.y,-a.z,-a.w)}a.toArray(c,e/3*4)}return new Kr(e+".quaternion",s,c)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map((function(e){return e/100})),i=yo.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new $r(e.modelName+".morphTargetInfluences["+i+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,n=t[0];for(let i=1;i<t.length;i++){const r=t[i];r!==n&&(t[e]=r,n=r,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,n){const i=n,r=[];let s=-1,o=-1,a=-1;return e.forEach((function(e){if(t.x&&(s=t.x.times.indexOf(e)),t.y&&(o=t.y.times.indexOf(e)),t.z&&(a=t.z.times.indexOf(e)),-1!==s){const e=t.x.values[s];r.push(e),i[0]=e}else r.push(i[0]);if(-1!==o){const e=t.y.values[o];r.push(e),i[1]=e}else r.push(i[1]);if(-1!==a){const e=t.z.values[a];r.push(e),i[2]=e}else r.push(i[2])})),r}interpolateRotations(e,t,n,i){const r=[],s=[];r.push(e.times[0]),s.push(He.degToRad(e.values[0])),s.push(He.degToRad(t.values[0])),s.push(He.degToRad(n.values[0]));for(let o=1;o<e.values.length;o++){const a=[e.values[o-1],t.values[o-1],n.values[o-1]];if(isNaN(a[0])||isNaN(a[1])||isNaN(a[2]))continue;const l=a.map(He.degToRad),c=[e.values[o],t.values[o],n.values[o]];if(isNaN(c[0])||isNaN(c[1])||isNaN(c[2]))continue;const u=c.map(He.degToRad),h=[c[0]-a[0],c[1]-a[1],c[2]-a[2]],d=[Math.abs(h[0]),Math.abs(h[1]),Math.abs(h[2])];if(d[0]>=180||d[1]>=180||d[2]>=180){const t=Math.max(...d)/180,n=new Jt(...l,i),a=new Jt(...u,i),c=(new ht).setFromEuler(n),h=(new ht).setFromEuler(a);c.dot(h)&&h.set(-h.x,-h.y,-h.z,-h.w);const p=e.times[o-1],f=e.times[o]-p,m=new ht,g=new Jt;for(let e=0;e<1;e+=1/t)m.copy(c.clone().slerp(h.clone(),e)),r.push(p+e*f),g.setFromQuaternion(m,i),s.push(g.x),s.push(g.y),s.push(g.z)}else r.push(e.times[o]),s.push(He.degToRad(e.values[o])),s.push(He.degToRad(t.values[o])),s.push(He.degToRad(n.values[o]))}return[r,s]}}class bo{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new So,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach((function(e,i){const r=e.match(/^[\s\t]*;/),s=e.match(/^[\s\t]*$/);if(r||s)return;const o=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),a=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");o?t.parseNodeBegin(e,o):a?t.parseNodeProperty(e,a,n[++i]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),i=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),r={name:n},s=this.parseNodeAttr(i),o=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(n,r):n in o?("PoseNode"===n?o.PoseNode.push(r):void 0!==o[n].id&&(o[n]={},o[n][o[n].id]=o[n]),""!==s.id&&(o[n][s.id]=r)):"number"==typeof s.id?(o[n]={},o[n][s.id]=r):"Properties70"!==n&&(o[n]="PoseNode"===n?[r]:r),"number"==typeof s.id&&(r.id=s.id),""!==s.name&&(r.attrName=s.name),""!==s.type&&(r.attrType=s.type),this.pushStack(r)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",i="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),i=e[2]),{id:t,name:n,type:i}}parseNodeProperty(e,t,n){let i=t[1].replace(/^"/,"").replace(/"$/,"").trim(),r=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===i&&","===r&&(r=n.replace(/"/g,"").replace(/,$/,"").trim());const s=this.getCurrentNode();if("Properties70"!==s.name){if("C"===i){const e=r.split(",").slice(1),t=parseInt(e[0]),n=parseInt(e[1]);let o=r.split(",").slice(3);o=o.map((function(e){return e.trim().replace(/^"/,"")})),i="connections",r=[t,n],function(e,t){for(let n=0,i=e.length,r=t.length;n<r;n++,i++)e[i]=t[n]}(r,o),void 0===s[i]&&(s[i]=[])}"Node"===i&&(s.id=r),i in s&&Array.isArray(s[i])?s[i].push(r):"a"!==i?s[i]=r:s.a=r,this.setCurrentProp(s,i),"a"===i&&","!==r.slice(-1)&&(s.a=Lo(r))}else this.parseNodeSpecialProperty(e,i,r)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=Lo(t.a))}parseNodeSpecialProperty(e,t,n){const i=n.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),r=i[0],s=i[1],o=i[2],a=i[3];let l=i[4];switch(s){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=Lo(l)}this.getPrevNode()[r]={type:s,type2:o,flag:a,value:l},this.setCurrentProp(this.getPrevNode(),r)}}class wo{parse(e){const t=new To(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const i=new So;for(;!this.endOfContent(t);){const e=this.parseNode(t,n);null!==e&&i.add(e.name,e)}return i}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},i=t>=7500?e.getUint64():e.getUint32(),r=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const s=e.getUint8(),o=e.getString(s);if(0===i)return null;const a=[];for(let t=0;t<r;t++)a.push(this.parseProperty(e));const l=a.length>0?a[0]:"",c=a.length>1?a[1]:"",u=a.length>2?a[2]:"";for(n.singleProperty=1===r&&e.getOffset()===i;i>e.getOffset();){const i=this.parseNode(e,t);null!==i&&this.parseSubNode(o,n,i)}return n.propertyList=a,"number"==typeof l&&(n.id=l),""!==c&&(n.attrName=c),""!==u&&(n.attrType=u),""!==o&&(n.name=o),n}parseSubNode(e,t,n){if(!0===n.singleProperty){const e=n.propertyList[0];Array.isArray(e)?(t[n.name]=n,n.a=e):t[n.name]=e}else if("Connections"===e&&"C"===n.name){const e=[];n.propertyList.forEach((function(t,n){0!==n&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===n.name){Object.keys(n).forEach((function(e){t[e]=n[e]}))}else if("Properties70"===e&&"P"===n.name){let e=n.propertyList[0],i=n.propertyList[1];const r=n.propertyList[2],s=n.propertyList[3];let o;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===i.indexOf("Lcl ")&&(i=i.replace("Lcl ","Lcl_")),o="Color"===i||"ColorRGB"===i||"Vector"===i||"Vector3D"===i||0===i.indexOf("Lcl_")?[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:n.propertyList[4],t[e]={type:i,type2:r,flag:s,value:o}}else void 0===t[n.name]?"number"==typeof n.id?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:"PoseNode"===n.name?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):void 0===t[n.name][n.id]&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const i=e.getUint32(),r=e.getUint32(),s=e.getUint32();if(0===r)switch(t){case"b":case"c":return e.getBooleanArray(i);case"d":return e.getFloat64Array(i);case"f":return e.getFloat32Array(i);case"i":return e.getInt32Array(i);case"l":return e.getInt64Array(i)}const o=lo(new Uint8Array(e.getArrayBuffer(s))),a=new To(o.buffer);switch(t){case"b":case"c":return a.getBooleanArray(i);case"d":return a.getFloat64Array(i);case"f":return a.getFloat32Array(i);case"i":return a.getInt32Array(i);case"l":return a.getInt64Array(i)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class To{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return!(1&~this.getUint8())}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let n=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const i=n.indexOf(0);return i>=0&&(n=new Uint8Array(this.dv.buffer,t,i)),this._textDecoder.decode(n)}}class So{add(e,t){this[e]=t}}function Mo(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function Eo(e){return e/46186158e3}const Ao=[];function Co(e,t,n,i){let r;switch(i.mappingType){case"ByPolygonVertex":r=e;break;case"ByPolygon":r=t;break;case"ByVertice":r=n;break;case"AllSame":r=i.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+i.mappingType)}"IndexToDirect"===i.referenceType&&(r=i.indices[r]);const s=r*i.dataSize,o=s+i.dataSize;return function(e,t,n,i){for(let r=n,s=0;r<i;r++,s++)e[s]=t[r];return e}(Ao,i.buffer,s,o)}const Ro=new Jt,No=new dt;function Po(e){const t=new Gt,n=new Gt,i=new Gt,r=new Gt,s=new Gt,o=new Gt,a=new Gt,l=new Gt,c=new Gt,u=new Gt,h=new Gt,d=new Gt,p=e.inheritType?e.inheritType:0;if(e.translation&&t.setPosition(No.fromArray(e.translation)),e.preRotation){const t=e.preRotation.map(He.degToRad);t.push(e.eulerOrder||Jt.DEFAULT_ORDER),n.makeRotationFromEuler(Ro.fromArray(t))}if(e.rotation){const t=e.rotation.map(He.degToRad);t.push(e.eulerOrder||Jt.DEFAULT_ORDER),i.makeRotationFromEuler(Ro.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(He.degToRad);t.push(e.eulerOrder||Jt.DEFAULT_ORDER),r.makeRotationFromEuler(Ro.fromArray(t)),r.invert()}e.scale&&s.scale(No.fromArray(e.scale)),e.scalingOffset&&a.setPosition(No.fromArray(e.scalingOffset)),e.scalingPivot&&o.setPosition(No.fromArray(e.scalingPivot)),e.rotationOffset&&l.setPosition(No.fromArray(e.rotationOffset)),e.rotationPivot&&c.setPosition(No.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(h.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));const f=n.clone().multiply(i).multiply(r),m=new Gt;m.extractRotation(u);const g=new Gt;g.copyPosition(u);const y=g.clone().invert().multiply(u),v=m.clone().invert().multiply(y),_=s,x=new Gt;if(0===p)x.copy(m).multiply(f).multiply(v).multiply(_);else if(1===p)x.copy(m).multiply(v).multiply(f).multiply(_);else{const e=(new Gt).scale((new dt).setFromMatrixScale(h)).clone().invert(),t=v.clone().multiply(e);x.copy(m).multiply(f).multiply(t).multiply(_)}const b=c.clone().invert(),w=o.clone().invert();let T=t.clone().multiply(l).multiply(c).multiply(n).multiply(i).multiply(r).multiply(b).multiply(a).multiply(o).multiply(s).multiply(w);const S=(new Gt).copyPosition(T),M=u.clone().multiply(S);return d.copyPosition(M),T=d.clone().multiply(x),T.premultiply(u.invert()),T}function Do(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function Lo(e){return e.split(",").map((function(e){return parseFloat(e)}))}function Io(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=e.byteLength),(new TextDecoder).decode(new Uint8Array(e,t,n))}var ko,Oo,Uo,Fo,Bo,zo;function Vo(){if(Oo)return ko;function e(e){const t=document.getElementById(e),n=t.parentNode;try{n&&n.removeChild(t)}catch(e){}}function t(t,n,i){return new i((function(i,r){const s=n.timeout||5e3,o="script_"+Date.now()+"_"+Math.ceil(1e5*Math.random()),a=function(e,t){var n=document.createElement("script");return n.type="text/javascript",n.async=!0,n.id=t,n.src=e,n}(t,o),l=setTimeout((function(){r(new Error("Script request to "+t+" timed out")),e(o)}),s),c=function(e){clearTimeout(e)};a.addEventListener("load",(function(t){i({ok:!0}),c(l),e(o)})),a.addEventListener("error",(function(n){r(new Error("Script request to "+t+" failed "+n)),c(l),e(o)})),function(e){const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}(a)}))}return Oo=1,ko=function(e){return e=e||{},function(n,i){return t(n,i=i||{},e.Promise||Promise)}}}function Go(){return zo||(zo=1,de(),function(){if(Fo)return Uo;Fo=1;const e=Vo()(),t=function(){let t;return function(){return t=t||e("https://cdn.jsdelivr.net/gh/mrdoob/three.js@r86/examples/js/loaders/GLTFLoader.js"),t}}();Uo=AFRAME.registerComponent("gltf-model-legacy",{schema:{type:"model"},init:function(){this.model=null,this.loader=null,this.loaderPromise=t().then((()=>{this.loader=new THREE.GLTFLoader,this.loader.setCrossOrigin("Anonymous")}))},update:function(){const e=this,t=this.el,n=this.data;n&&(this.remove(),this.loaderPromise.then((()=>{this.loader.load(n,(function(n){e.model=n.scene,e.model.animations=n.animations,t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"gltf",model:e.model})}))})))},remove:function(){this.model&&this.el.removeObject3D("mesh")}})}(),Bo||(Bo=1,AFRAME.registerComponent("object-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){let e;const t=this.data;t.src&&(this.remove(),e=new THREE.ObjectLoader,t.crossorigin&&e.setCrossOrigin(t.crossorigin),e.load(t.src,(e=>{e.traverse((e=>{e instanceof THREE.SkinnedMesh&&e.material&&(e.material.skinning=!!(e.geometry&&e.geometry.bones||[]).length)})),this.load(e)})))},load:function(e){this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"json",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}}))),he}THREE.FBXLoader=class extends rs{constructor(e){super(e)}load(e,t,n,i){const r=this,s=""===r.path?Es.extractUrlBase(e):r.path,o=new as(this.manager);o.setPath(r.path),o.setResponseType("arraybuffer"),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(e,(function(n){try{t(r.parse(n,s))}catch(t){i?i(t):console.error(t),r.manager.itemError(e)}}),n,i)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===Io(e,0,t.length)}(e))mo=(new wo).parse(e);else{const t=Io(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let n=0;function i(t){const i=e[t-1];return e=e.slice(n+t),n++,i}for(let e=0;e<t.length;++e){if(i(1)===t[e])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(Mo(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+Mo(t));mo=(new bo).parse(t)}const n=new us(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new vo(n,this.manager).parse(mo)}},AFRAME.registerComponent("fbx-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){const e=this.data;if(!e.src)return;this.remove();const t=new THREE.FBXLoader;e.crossorigin&&t.setCrossOrigin(e.crossorigin),t.load(e.src,this.load.bind(this))},load:function(e){this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"fbx",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}});var jo,Ho,Wo,qo,Xo,$o,Yo,Ko={};function Zo(){if(Wo)return Ho;function e(e,t,n,i){e&&(t=t||[],e.traverse((e=>{if(!e.isMesh)return;var r;((r=e.material)?Array.isArray(r)?r:r.materials?r.materials:[r]:[]).forEach((e=>{e&&!("envMap"in e)||t.length&&-1===t.indexOf(e.name)||(e.envMap=n,e.reflectivity=i,e.needsUpdate=!0)}))})))}return Wo=1,Ho=AFRAME.registerComponent("cube-env-map",{multiple:!0,schema:{path:{default:""},extension:{default:"jpg",oneOf:["jpg","png"]},enableBackground:{default:!1},reflectivity:{default:1,min:0,max:1},materials:{default:[]}},init:function(){const t=this.data;this.texture=(new THREE.CubeTextureLoader).load([t.path+"posx."+t.extension,t.path+"negx."+t.extension,t.path+"posy."+t.extension,t.path+"negy."+t.extension,t.path+"posz."+t.extension,t.path+"negz."+t.extension]),this.texture.format=THREE.RGBAFormat,this.object3dsetHandler=()=>{const t=this.el.getObject3D("mesh"),n=this.data;e(t,n.materials,this.texture,n.reflectivity)},this.object3dsetHandler(),this.el.addEventListener("object3dset",this.object3dsetHandler)},update:function(t){const n=this.data,i=this.el.getObject3D("mesh");let r=[],s=[];if(n.materials.length&&(t.materials?(r=n.materials.filter((e=>!t.materials.includes(e))),s=t.materials.filter((e=>!n.materials.includes(e)))):r=n.materials),r.length&&e(i,r,this.texture,n.reflectivity),s.length&&e(i,s,null,1),t.materials&&n.reflectivity!==t.reflectivity){const r=n.materials.filter((e=>t.materials.includes(e)));r.length&&e(i,r,this.texture,n.reflectivity)}this.data.enableBackground&&!t.enableBackground?this.setBackground(this.texture):!this.data.enableBackground&&t.enableBackground&&this.setBackground(null)},remove:function(){this.el.removeEventListener("object3dset",this.object3dsetHandler);const t=this.el.getObject3D("mesh"),n=this.data;e(t,n.materials,null,1),n.enableBackground&&this.setBackground(null)},setBackground:function(e){this.el.sceneEl.object3D.background=e}}),Ho}function Jo(){return Yo||(Yo=1,jo||(jo=1,AFRAME.registerComponent("checkpoint",{schema:{offset:{default:{x:0,y:0,z:0},type:"vec3"}},init:function(){this.active=!1,this.targetEl=null,this.fire=this.fire.bind(this),this.offset=new THREE.Vector3},update:function(){this.offset.copy(this.data.offset)},play:function(){this.el.addEventListener("click",this.fire)},pause:function(){this.el.removeEventListener("click",this.fire)},remove:function(){this.pause()},fire:function(){const e=this.el.sceneEl.querySelector("[checkpoint-controls]");if(!e)throw new Error("No `checkpoint-controls` component found.");e.components["checkpoint-controls"].setCheckpoint(this.el)},getOffset:function(){return this.offset.copy(this.data.offset)}})),Zo(),qo||(qo=1,AFRAME.registerComponent("grab",{init:function(){this.system=this.el.sceneEl.systems.physics,this.GRABBED_STATE="grabbed",this.grabbing=!1,this.hitEl=null,this.physics=this.el.sceneEl.systems.physics,this.constraint=null,this.onHit=this.onHit.bind(this),this.onGripOpen=this.onGripOpen.bind(this),this.onGripClose=this.onGripClose.bind(this)},play:function(){const e=this.el;e.addEventListener("hit",this.onHit),e.addEventListener("gripdown",this.onGripClose),e.addEventListener("gripup",this.onGripOpen),e.addEventListener("trackpaddown",this.onGripClose),e.addEventListener("trackpadup",this.onGripOpen),e.addEventListener("triggerdown",this.onGripClose),e.addEventListener("triggerup",this.onGripOpen)},pause:function(){const e=this.el;e.removeEventListener("hit",this.onHit),e.removeEventListener("gripdown",this.onGripClose),e.removeEventListener("gripup",this.onGripOpen),e.removeEventListener("trackpaddown",this.onGripClose),e.removeEventListener("trackpadup",this.onGripOpen),e.removeEventListener("triggerdown",this.onGripClose),e.removeEventListener("triggerup",this.onGripOpen)},onGripClose:function(){this.grabbing=!0},onGripOpen:function(){const e=this.hitEl;this.grabbing=!1,e&&(e.removeState(this.GRABBED_STATE),this.hitEl=void 0,this.system.removeConstraint(this.constraint),this.constraint=null)},onHit:function(e){const t=e.detail.el;t.is(this.GRABBED_STATE)||!this.grabbing||this.hitEl||(t.addState(this.GRABBED_STATE),this.hitEl=t,this.constraint=new CANNON.LockConstraint(this.el.body,t.body),this.system.addConstraint(this.constraint))}})),Xo||(Xo=1,AFRAME.registerComponent("normal-material",{init:function(){this.material=new THREE.MeshNormalMaterial({flatShading:!0}),this.applyMaterial=this.applyMaterial.bind(this),this.el.addEventListener("object3dset",this.applyMaterial),this.applyMaterial()},remove:function(){this.el.removeEventListener("object3dset",this.applyMaterial)},applyMaterial:function(){this.el.object3D.traverse((e=>{e.isMesh&&(e.material=this.material)}))}})),$o||($o=1,AFRAME.registerComponent("sphere-collider",{schema:{enabled:{default:!0},interval:{default:80},objects:{default:""},state:{default:"collided"},radius:{default:.05},watch:{default:!0}},init:function(){this.observer=null,this.els=[],this.collisions=[],this.prevCheckTime=void 0,this.eventDetail={},this.handleHit=this.handleHit.bind(this),this.handleHitEnd=this.handleHitEnd.bind(this)},play:function(){const e=this.el.sceneEl;this.data.watch&&(this.observer=new MutationObserver(this.update.bind(this,null)),this.observer.observe(e,{childList:!0,subtree:!0}))},pause:function(){this.observer&&(this.observer.disconnect(),this.observer=null)},update:function(){const e=this.data;let t;t=e.objects?this.el.sceneEl.querySelectorAll(e.objects):this.el.sceneEl.children,this.els=Array.prototype.slice.call(t)},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,n=new THREE.Vector3,i=new THREE.Vector3,r=new THREE.Box3,s=[],o=new Map;return function(a){if(!this.data.enabled)return;const l=this.prevCheckTime;if(l&&a-l<this.data.interval)return;this.prevCheckTime=a;const c=this.el,u=this.data;let h;var d;c.getObject3D("mesh")&&(s.length=0,o.clear(),c.object3D.getWorldPosition(e),c.object3D.getWorldScale(n),h=u.radius*(d=n,Math.max(d.x,d.y,d.z)),this.els.forEach((function(n){let a,l,c,u;n.isEntity&&(l=n.getObject3D("mesh"),l&&(r.setFromObject(l).getSize(i),u=Math.max(i.x,i.y,i.z)/2,a=Math.sqrt(2*u*u),r.getCenter(t),a&&(c=e.distanceTo(t),c<a+h&&(s.push(n),o.set(n,c)))))})),s.sort(((e,t)=>o.get(e)>o.get(t)?1:-1)).forEach(this.handleHit),this.collisions.filter((e=>!o.has(e))).forEach(this.handleHitEnd),function(e,t){e.length=0;for(let n=0;n<t.length;n++)e[n]=t[n]}(this.collisions,s))}}(),handleHit:function(e){e.emit("hit"),e.addState(this.data.state),this.eventDetail.el=e,this.el.emit("hit",this.eventDetail)},handleHitEnd:function(e){e.emit("hitend"),e.removeState(this.data.state),this.eventDetail.el=e,this.el.emit("hitend",this.eventDetail)}}))),Ko}var Qo,ea,ta={};const na="177",ia=0,ra=1,sa=2,oa=0,aa=1,la=2,ca=3,ua=0,ha=1,da=2,pa=100,fa=101,ma=102,ga=200,ya=201,va=202,_a=203,xa=204,ba=205,wa=206,Ta=207,Sa=208,Ma=209,Ea=210,Aa=211,Ca=212,Ra=213,Na=214,Pa=0,Da=1,La=2,Ia=3,ka=4,Oa=5,Ua=6,Fa=7,Ba=301,za=302,Va=303,Ga=304,ja=306,Ha=1e3,Wa=1001,qa=1002,Xa=1003,$a=1004,Ya=1005,Ka=1006,Za=1007,Ja=1008,Qa=1009,el=1010,tl=1011,nl=1012,il=1013,rl=1014,sl=1015,ol=1016,al=1017,ll=1018,cl=1020,ul=35902,hl=1021,dl=1022,pl=1023,fl=1026,ml=1027,gl=1028,yl=1029,vl=1030,_l=1031,xl=1033,bl=33776,wl=33777,Tl=33778,Sl=33779,Ml=35840,El=35841,Al=35842,Cl=35843,Rl=36196,Nl=37492,Pl=37496,Dl=37808,Ll=37809,Il=37810,kl=37811,Ol=37812,Ul=37813,Fl=37814,Bl=37815,zl=37816,Vl=37817,Gl=37818,jl=37819,Hl=37820,Wl=37821,ql=36492,Xl=36494,$l=36495,Yl=36283,Kl=36284,Zl=36285,Jl=36286,Ql="",ec="srgb",tc="srgb-linear",nc="linear",ic="srgb",rc=7680,sc=512,oc=513,ac=514,lc=515,cc=516,uc=517,hc=518,dc=519,pc=35044,fc=35048,mc="300 es",gc=2e3,yc=2001;class vc{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){const n=this._listeners;return void 0!==n&&(void 0!==n[e]&&-1!==n[e].indexOf(t))}removeEventListener(e,t){const n=this._listeners;if(void 0===n)return;const i=n[e];if(void 0!==i){const e=i.indexOf(t);-1!==e&&i.splice(e,1)}}dispatchEvent(e){const t=this._listeners;if(void 0===t)return;const n=t[e.type];if(void 0!==n){e.target=this;const t=n.slice(0);for(let n=0,i=t.length;n<i;n++)t[n].call(this,e);e.target=null}}}const _c=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let xc=1234567;const bc=Math.PI/180,wc=180/Math.PI;function Tc(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(_c[255&e]+_c[e>>8&255]+_c[e>>16&255]+_c[e>>24&255]+"-"+_c[255&t]+_c[t>>8&255]+"-"+_c[t>>16&15|64]+_c[t>>24&255]+"-"+_c[63&n|128]+_c[n>>8&255]+"-"+_c[n>>16&255]+_c[n>>24&255]+_c[255&i]+_c[i>>8&255]+_c[i>>16&255]+_c[i>>24&255]).toLowerCase()}function Sc(e,t,n){return Math.max(t,Math.min(n,e))}function Mc(e,t){return(e%t+t)%t}function Ec(e,t,n){return(1-n)*e+n*t}function Ac(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function Cc(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}const Rc={DEG2RAD:bc,RAD2DEG:wc,generateUUID:Tc,clamp:Sc,euclideanModulo:Mc,mapLinear:function(e,t,n,i,r){return i+(e-t)*(r-i)/(n-t)},inverseLerp:function(e,t,n){return e!==t?(n-e)/(t-e):0},lerp:Ec,damp:function(e,t,n,i){return Ec(e,t,1-Math.exp(-n*i))},pingpong:function(e,t=1){return t-Math.abs(Mc(e,2*t)-t)},smoothstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*(3-2*e)},smootherstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){void 0!==e&&(xc=e);let t=xc+=1831565813;return t=Math.imul(t^t>>>15,1|t),t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296},degToRad:function(e){return e*bc},radToDeg:function(e){return e*wc},isPowerOfTwo:function(e){return!(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,n,i,r){const s=Math.cos,o=Math.sin,a=s(n/2),l=o(n/2),c=s((t+i)/2),u=o((t+i)/2),h=s((t-i)/2),d=o((t-i)/2),p=s((i-t)/2),f=o((i-t)/2);switch(r){case"XYX":e.set(a*u,l*h,l*d,a*c);break;case"YZY":e.set(l*d,a*u,l*h,a*c);break;case"ZXZ":e.set(l*h,l*d,a*u,a*c);break;case"XZX":e.set(a*u,l*f,l*p,a*c);break;case"YXY":e.set(l*p,a*u,l*f,a*c);break;case"ZYZ":e.set(l*f,l*p,a*u,a*c);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}},normalize:Cc,denormalize:Ac};class Nc{constructor(e=0,t=0){Nc.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,n=this.y,i=e.elements;return this.x=i[0]*t+i[3]*n+i[6],this.y=i[1]*t+i[4]*n+i[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Sc(this.x,e.x,t.x),this.y=Sc(this.y,e.y,t.y),this}clampScalar(e,t){return this.x=Sc(this.x,e,t),this.y=Sc(this.y,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Sc(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(Sc(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const n=Math.cos(t),i=Math.sin(t),r=this.x-e.x,s=this.y-e.y;return this.x=r*n-s*i+e.x,this.y=r*i+s*n+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Pc{constructor(e=0,t=0,n=0,i=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=n,this._w=i}static slerpFlat(e,t,n,i,r,s,o){let a=n[i+0],l=n[i+1],c=n[i+2],u=n[i+3];const h=r[s+0],d=r[s+1],p=r[s+2],f=r[s+3];if(0===o)return e[t+0]=a,e[t+1]=l,e[t+2]=c,void(e[t+3]=u);if(1===o)return e[t+0]=h,e[t+1]=d,e[t+2]=p,void(e[t+3]=f);if(u!==f||a!==h||l!==d||c!==p){let e=1-o;const t=a*h+l*d+c*p+u*f,n=t>=0?1:-1,i=1-t*t;if(i>Number.EPSILON){const r=Math.sqrt(i),s=Math.atan2(r,t*n);e=Math.sin(e*s)/r,o=Math.sin(o*s)/r}const r=o*n;if(a=a*e+h*r,l=l*e+d*r,c=c*e+p*r,u=u*e+f*r,e===1-o){const e=1/Math.sqrt(a*a+l*l+c*c+u*u);a*=e,l*=e,c*=e,u*=e}}e[t]=a,e[t+1]=l,e[t+2]=c,e[t+3]=u}static multiplyQuaternionsFlat(e,t,n,i,r,s){const o=n[i],a=n[i+1],l=n[i+2],c=n[i+3],u=r[s],h=r[s+1],d=r[s+2],p=r[s+3];return e[t]=o*p+c*u+a*d-l*h,e[t+1]=a*p+c*h+l*u-o*d,e[t+2]=l*p+c*d+o*h-a*u,e[t+3]=c*p-o*u-a*h-l*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,n,i){return this._x=e,this._y=t,this._z=n,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const n=e._x,i=e._y,r=e._z,s=e._order,o=Math.cos,a=Math.sin,l=o(n/2),c=o(i/2),u=o(r/2),h=a(n/2),d=a(i/2),p=a(r/2);switch(s){case"XYZ":this._x=h*c*u+l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u-h*d*p;break;case"YXZ":this._x=h*c*u+l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u+h*d*p;break;case"ZXY":this._x=h*c*u-l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u-h*d*p;break;case"ZYX":this._x=h*c*u-l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u+h*d*p;break;case"YZX":this._x=h*c*u+l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u-h*d*p;break;case"XZY":this._x=h*c*u-l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u+h*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const n=t/2,i=Math.sin(n);return this._x=e.x*i,this._y=e.y*i,this._z=e.z*i,this._w=Math.cos(n),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,n=t[0],i=t[4],r=t[8],s=t[1],o=t[5],a=t[9],l=t[2],c=t[6],u=t[10],h=n+o+u;if(h>0){const e=.5/Math.sqrt(h+1);this._w=.25/e,this._x=(c-a)*e,this._y=(r-l)*e,this._z=(s-i)*e}else if(n>o&&n>u){const e=2*Math.sqrt(1+n-o-u);this._w=(c-a)/e,this._x=.25*e,this._y=(i+s)/e,this._z=(r+l)/e}else if(o>u){const e=2*Math.sqrt(1+o-n-u);this._w=(r-l)/e,this._x=(i+s)/e,this._y=.25*e,this._z=(a+c)/e}else{const e=2*Math.sqrt(1+u-n-o);this._w=(s-i)/e,this._x=(r+l)/e,this._y=(a+c)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let n=e.dot(t)+1;return n<Number.EPSILON?(n=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=n):(this._x=0,this._y=-e.z,this._z=e.y,this._w=n)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=n),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Sc(this.dot(e),-1,1)))}rotateTowards(e,t){const n=this.angleTo(e);if(0===n)return this;const i=Math.min(1,t/n);return this.slerp(e,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const n=e._x,i=e._y,r=e._z,s=e._w,o=t._x,a=t._y,l=t._z,c=t._w;return this._x=n*c+s*o+i*l-r*a,this._y=i*c+s*a+r*o-n*l,this._z=r*c+s*l+n*a-i*o,this._w=s*c-n*o-i*a-r*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const n=this._x,i=this._y,r=this._z,s=this._w;let o=s*e._w+n*e._x+i*e._y+r*e._z;if(o<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,o=-o):this.copy(e),o>=1)return this._w=s,this._x=n,this._y=i,this._z=r,this;const a=1-o*o;if(a<=Number.EPSILON){const e=1-t;return this._w=e*s+t*this._w,this._x=e*n+t*this._x,this._y=e*i+t*this._y,this._z=e*r+t*this._z,this.normalize(),this}const l=Math.sqrt(a),c=Math.atan2(l,o),u=Math.sin((1-t)*c)/l,h=Math.sin(t*c)/l;return this._w=s*u+this._w*h,this._x=n*u+this._x*h,this._y=i*u+this._y*h,this._z=r*u+this._z*h,this._onChangeCallback(),this}slerpQuaternions(e,t,n){return this.copy(e).slerp(t,n)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),n=Math.random(),i=Math.sqrt(1-n),r=Math.sqrt(n);return this.set(i*Math.sin(e),i*Math.cos(e),r*Math.sin(t),r*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class Dc{constructor(e=0,t=0,n=0){Dc.prototype.isVector3=!0,this.x=e,this.y=t,this.z=n}set(e,t,n){return void 0===n&&(n=this.z),this.x=e,this.y=t,this.z=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(Ic.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(Ic.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,n=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[3]*n+r[6]*i,this.y=r[1]*t+r[4]*n+r[7]*i,this.z=r[2]*t+r[5]*n+r[8]*i,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,n=this.y,i=this.z,r=e.elements,s=1/(r[3]*t+r[7]*n+r[11]*i+r[15]);return this.x=(r[0]*t+r[4]*n+r[8]*i+r[12])*s,this.y=(r[1]*t+r[5]*n+r[9]*i+r[13])*s,this.z=(r[2]*t+r[6]*n+r[10]*i+r[14])*s,this}applyQuaternion(e){const t=this.x,n=this.y,i=this.z,r=e.x,s=e.y,o=e.z,a=e.w,l=2*(s*i-o*n),c=2*(o*t-r*i),u=2*(r*n-s*t);return this.x=t+a*l+s*u-o*c,this.y=n+a*c+o*l-r*u,this.z=i+a*u+r*c-s*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,n=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[4]*n+r[8]*i,this.y=r[1]*t+r[5]*n+r[9]*i,this.z=r[2]*t+r[6]*n+r[10]*i,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Sc(this.x,e.x,t.x),this.y=Sc(this.y,e.y,t.y),this.z=Sc(this.z,e.z,t.z),this}clampScalar(e,t){return this.x=Sc(this.x,e,t),this.y=Sc(this.y,e,t),this.z=Sc(this.z,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Sc(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const n=e.x,i=e.y,r=e.z,s=t.x,o=t.y,a=t.z;return this.x=i*a-r*o,this.y=r*s-n*a,this.z=n*o-i*s,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const n=e.dot(this)/t;return this.copy(e).multiplyScalar(n)}projectOnPlane(e){return Lc.copy(this).projectOnVector(e),this.sub(Lc)}reflect(e){return this.sub(Lc.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(Sc(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y,i=this.z-e.z;return t*t+n*n+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,n){const i=Math.sin(t)*e;return this.x=i*Math.sin(n),this.y=Math.cos(t)*e,this.z=i*Math.cos(n),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,n){return this.x=e*Math.sin(t),this.y=n,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),n=this.setFromMatrixColumn(e,1).length(),i=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=n,this.z=i,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=2*Math.random()-1,n=Math.sqrt(1-t*t);return this.x=n*Math.cos(e),this.y=t,this.z=n*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const Lc=new Dc,Ic=new Pc;class kc{constructor(e,t,n,i,r,s,o,a,l){kc.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,n,i,r,s,o,a,l)}set(e,t,n,i,r,s,o,a,l){const c=this.elements;return c[0]=e,c[1]=i,c[2]=o,c[3]=t,c[4]=r,c[5]=a,c[6]=n,c[7]=s,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],this}extractBasis(e,t,n){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),n.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,i=t.elements,r=this.elements,s=n[0],o=n[3],a=n[6],l=n[1],c=n[4],u=n[7],h=n[2],d=n[5],p=n[8],f=i[0],m=i[3],g=i[6],y=i[1],v=i[4],_=i[7],x=i[2],b=i[5],w=i[8];return r[0]=s*f+o*y+a*x,r[3]=s*m+o*v+a*b,r[6]=s*g+o*_+a*w,r[1]=l*f+c*y+u*x,r[4]=l*m+c*v+u*b,r[7]=l*g+c*_+u*w,r[2]=h*f+d*y+p*x,r[5]=h*m+d*v+p*b,r[8]=h*g+d*_+p*w,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],s=e[4],o=e[5],a=e[6],l=e[7],c=e[8];return t*s*c-t*o*l-n*r*c+n*o*a+i*r*l-i*s*a}invert(){const e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],s=e[4],o=e[5],a=e[6],l=e[7],c=e[8],u=c*s-o*l,h=o*a-c*r,d=l*r-s*a,p=t*u+n*h+i*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const f=1/p;return e[0]=u*f,e[1]=(i*l-c*n)*f,e[2]=(o*n-i*s)*f,e[3]=h*f,e[4]=(c*t-i*a)*f,e[5]=(i*r-o*t)*f,e[6]=d*f,e[7]=(n*a-l*t)*f,e[8]=(s*t-n*r)*f,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,n,i,r,s,o){const a=Math.cos(r),l=Math.sin(r);return this.set(n*a,n*l,-n*(a*s+l*o)+s+e,-i*l,i*a,-i*(-l*s+a*o)+o+t,0,0,1),this}scale(e,t){return this.premultiply(Oc.makeScale(e,t)),this}rotate(e){return this.premultiply(Oc.makeRotation(-e)),this}translate(e,t){return this.premultiply(Oc.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,n,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,n=e.elements;for(let e=0;e<9;e++)if(t[e]!==n[e])return!1;return!0}fromArray(e,t=0){for(let n=0;n<9;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}const Oc=new kc;function Uc(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}function Fc(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function Bc(){const e=Fc("canvas");return e.style.display="block",e}const zc={};function Vc(e){e in zc||(zc[e]=!0,console.warn(e))}const Gc=(new kc).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),jc=(new kc).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function Hc(){const e={enabled:!0,workingColorSpace:tc,spaces:{},convert:function(e,t,n){return!1!==this.enabled&&t!==n&&t&&n?(this.spaces[t].transfer===ic&&(e.r=qc(e.r),e.g=qc(e.g),e.b=qc(e.b)),this.spaces[t].primaries!==this.spaces[n].primaries&&(e.applyMatrix3(this.spaces[t].toXYZ),e.applyMatrix3(this.spaces[n].fromXYZ)),this.spaces[n].transfer===ic&&(e.r=Xc(e.r),e.g=Xc(e.g),e.b=Xc(e.b)),e):e},workingToColorSpace:function(e,t){return this.convert(e,this.workingColorSpace,t)},colorSpaceToWorking:function(e,t){return this.convert(e,t,this.workingColorSpace)},getPrimaries:function(e){return this.spaces[e].primaries},getTransfer:function(e){return e===Ql?nc:this.spaces[e].transfer},getLuminanceCoefficients:function(e,t=this.workingColorSpace){return e.fromArray(this.spaces[t].luminanceCoefficients)},define:function(e){Object.assign(this.spaces,e)},_getMatrix:function(e,t,n){return e.copy(this.spaces[t].toXYZ).multiply(this.spaces[n].fromXYZ)},_getDrawingBufferColorSpace:function(e){return this.spaces[e].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(e=this.workingColorSpace){return this.spaces[e].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(t,n){return Vc("THREE.ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),e.workingToColorSpace(t,n)},toWorkingColorSpace:function(t,n){return Vc("THREE.ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),e.colorSpaceToWorking(t,n)}},t=[.64,.33,.3,.6,.15,.06],n=[.2126,.7152,.0722],i=[.3127,.329];return e.define({[tc]:{primaries:t,whitePoint:i,transfer:nc,toXYZ:Gc,fromXYZ:jc,luminanceCoefficients:n,workingColorSpaceConfig:{unpackColorSpace:ec},outputColorSpaceConfig:{drawingBufferColorSpace:ec}},[ec]:{primaries:t,whitePoint:i,transfer:ic,toXYZ:Gc,fromXYZ:jc,luminanceCoefficients:n,outputColorSpaceConfig:{drawingBufferColorSpace:ec}}}),e}const Wc=Hc();function qc(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function Xc(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let $c;class Yc{static getDataURL(e,t="image/png"){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let n;if(e instanceof HTMLCanvasElement)n=e;else{void 0===$c&&($c=Fc("canvas")),$c.width=e.width,$c.height=e.height;const t=$c.getContext("2d");e instanceof ImageData?t.putImageData(e,0,0):t.drawImage(e,0,0,e.width,e.height),n=$c}return n.toDataURL(t)}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=Fc("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");n.drawImage(e,0,0,e.width,e.height);const i=n.getImageData(0,0,e.width,e.height),r=i.data;for(let e=0;e<r.length;e++)r[e]=255*qc(r[e]/255);return n.putImageData(i,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*qc(t[e]/255)):t[e]=qc(t[e]);return{data:t,width:e.width,height:e.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let Kc=0;class Zc{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:Kc++}),this.uuid=Tc(),this.data=e,this.dataReady=!0,this.version=0}getSize(e){const t=this.data;return t instanceof HTMLVideoElement?e.set(t.videoWidth,t.videoHeight):null!==t?e.set(t.width,t.height,t.depth||0):e.set(0,0,0),e}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const n={uuid:this.uuid,url:""},i=this.data;if(null!==i){let e;if(Array.isArray(i)){e=[];for(let t=0,n=i.length;t<n;t++)i[t].isDataTexture?e.push(Jc(i[t].image)):e.push(Jc(i[t]))}else e=Jc(i);n.url=e}return t||(e.images[this.uuid]=n),n}}function Jc(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?Yc.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let Qc=0;const eu=new Dc;class tu extends vc{constructor(e=tu.DEFAULT_IMAGE,t=tu.DEFAULT_MAPPING,n=1001,i=1001,r=1006,s=1008,o=1023,a=1009,l=tu.DEFAULT_ANISOTROPY,c=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:Qc++}),this.uuid=Tc(),this.name="",this.source=new Zc(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=n,this.wrapT=i,this.magFilter=r,this.minFilter=s,this.anisotropy=l,this.format=o,this.internalFormat=null,this.type=a,this.offset=new Nc(0,0),this.repeat=new Nc(1,1),this.center=new Nc(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new kc,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=c,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(e&&e.depth&&e.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(eu).x}get height(){return this.source.getSize(eu).y}get depth(){return this.source.getSize(eu).z}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.isArrayTexture=e.isArrayTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}setValues(e){for(const t in e){const n=e[t];if(void 0===n){console.warn(`THREE.Texture.setValues(): parameter '${t}' has value of undefined.`);continue}const i=this[t];void 0!==i?i&&n&&i.isVector2&&n.isVector2||i&&n&&i.isVector3&&n.isVector3||i&&n&&i.isMatrix3&&n.isMatrix3?i.copy(n):this[t]=n:console.warn(`THREE.Texture.setValues(): property '${t}' does not exist.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const n={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(n.userData=this.userData),t||(e.textures[this.uuid]=n),n}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case Ha:e.x=e.x-Math.floor(e.x);break;case Wa:e.x=e.x<0?0:1;break;case qa:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case Ha:e.y=e.y-Math.floor(e.y);break;case Wa:e.y=e.y<0?0:1;break;case qa:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}}tu.DEFAULT_IMAGE=null,tu.DEFAULT_MAPPING=300,tu.DEFAULT_ANISOTROPY=1;class nu{constructor(e=0,t=0,n=0,i=1){nu.prototype.isVector4=!0,this.x=e,this.y=t,this.z=n,this.w=i}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,n=this.y,i=this.z,r=this.w,s=e.elements;return this.x=s[0]*t+s[4]*n+s[8]*i+s[12]*r,this.y=s[1]*t+s[5]*n+s[9]*i+s[13]*r,this.z=s[2]*t+s[6]*n+s[10]*i+s[14]*r,this.w=s[3]*t+s[7]*n+s[11]*i+s[15]*r,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,n,i,r;const s=.01,o=.1,a=e.elements,l=a[0],c=a[4],u=a[8],h=a[1],d=a[5],p=a[9],f=a[2],m=a[6],g=a[10];if(Math.abs(c-h)<s&&Math.abs(u-f)<s&&Math.abs(p-m)<s){if(Math.abs(c+h)<o&&Math.abs(u+f)<o&&Math.abs(p+m)<o&&Math.abs(l+d+g-3)<o)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,a=(d+1)/2,y=(g+1)/2,v=(c+h)/4,_=(u+f)/4,x=(p+m)/4;return e>a&&e>y?e<s?(n=0,i=.707106781,r=.707106781):(n=Math.sqrt(e),i=v/n,r=_/n):a>y?a<s?(n=.707106781,i=0,r=.707106781):(i=Math.sqrt(a),n=v/i,r=x/i):y<s?(n=.707106781,i=.707106781,r=0):(r=Math.sqrt(y),n=_/r,i=x/r),this.set(n,i,r,t),this}let y=Math.sqrt((m-p)*(m-p)+(u-f)*(u-f)+(h-c)*(h-c));return Math.abs(y)<.001&&(y=1),this.x=(m-p)/y,this.y=(u-f)/y,this.z=(h-c)/y,this.w=Math.acos((l+d+g-1)/2),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Sc(this.x,e.x,t.x),this.y=Sc(this.y,e.y,t.y),this.z=Sc(this.z,e.z,t.z),this.w=Sc(this.w,e.w,t.w),this}clampScalar(e,t){return this.x=Sc(this.x,e,t),this.y=Sc(this.y,e,t),this.z=Sc(this.z,e,t),this.w=Sc(this.w,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Sc(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this.w=e.w+(t.w-e.w)*n,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class iu extends vc{constructor(e=1,t=1,n={}){super(),n=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:Ka,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},n),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=n.depth,this.scissor=new nu(0,0,e,t),this.scissorTest=!1,this.viewport=new nu(0,0,e,t);const i={width:e,height:t,depth:n.depth},r=new tu(i);this.textures=[];const s=n.count;for(let e=0;e<s;e++)this.textures[e]=r.clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;this._setTextureOptions(n),this.depthBuffer=n.depthBuffer,this.stencilBuffer=n.stencilBuffer,this.resolveDepthBuffer=n.resolveDepthBuffer,this.resolveStencilBuffer=n.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=n.depthTexture,this.samples=n.samples,this.multiview=n.multiview}_setTextureOptions(e={}){const t={minFilter:Ka,generateMipmaps:!1,flipY:!1,internalFormat:null};void 0!==e.mapping&&(t.mapping=e.mapping),void 0!==e.wrapS&&(t.wrapS=e.wrapS),void 0!==e.wrapT&&(t.wrapT=e.wrapT),void 0!==e.wrapR&&(t.wrapR=e.wrapR),void 0!==e.magFilter&&(t.magFilter=e.magFilter),void 0!==e.minFilter&&(t.minFilter=e.minFilter),void 0!==e.format&&(t.format=e.format),void 0!==e.type&&(t.type=e.type),void 0!==e.anisotropy&&(t.anisotropy=e.anisotropy),void 0!==e.colorSpace&&(t.colorSpace=e.colorSpace),void 0!==e.flipY&&(t.flipY=e.flipY),void 0!==e.generateMipmaps&&(t.generateMipmaps=e.generateMipmaps),void 0!==e.internalFormat&&(t.internalFormat=e.internalFormat);for(let e=0;e<this.textures.length;e++){this.textures[e].setValues(t)}}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==e&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,t,n=1){if(this.width!==e||this.height!==t||this.depth!==n){this.width=e,this.height=t,this.depth=n;for(let i=0,r=this.textures.length;i<r;i++)this.textures[i].image.width=e,this.textures[i].image.height=t,this.textures[i].image.depth=n,this.textures[i].isArrayTexture=this.textures[i].image.depth>1;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,n=e.textures.length;t<n;t++){this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;const n=Object.assign({},e.textures[t].image);this.textures[t].source=new Zc(n)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class ru extends iu{constructor(e=1,t=1,n={}){super(e,t,n),this.isWebGLRenderTarget=!0}}class su extends tu{constructor(e=null,t=1,n=1,i=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:n,depth:i},this.magFilter=Xa,this.minFilter=Xa,this.wrapR=Wa,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class ou extends tu{constructor(e=null,t=1,n=1,i=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:n,depth:i},this.magFilter=Xa,this.minFilter=Xa,this.wrapR=Wa,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class au{constructor(e=new Dc(1/0,1/0,1/0),t=new Dc(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t+=3)this.expandByPoint(cu.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,n=e.count;t<n;t++)this.expandByPoint(cu.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const n=cu.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(n),this.max.copy(e).add(n),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const n=e.geometry;if(void 0!==n){const i=n.getAttribute("position");if(!0===t&&void 0!==i&&!0!==e.isInstancedMesh)for(let t=0,n=i.count;t<n;t++)!0===e.isMesh?e.getVertexPosition(t,cu):cu.fromBufferAttribute(i,t),cu.applyMatrix4(e.matrixWorld),this.expandByPoint(cu);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),uu.copy(e.boundingBox)):(null===n.boundingBox&&n.computeBoundingBox(),uu.copy(n.boundingBox)),uu.applyMatrix4(e.matrixWorld),this.union(uu)}const i=e.children;for(let e=0,n=i.length;e<n;e++)this.expandByObject(i[e],t);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,cu),cu.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,n;return e.normal.x>0?(t=e.normal.x*this.min.x,n=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,n=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,n+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,n+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,n+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,n+=e.normal.z*this.min.z),t<=-e.constant&&n>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(yu),vu.subVectors(this.max,yu),hu.subVectors(e.a,yu),du.subVectors(e.b,yu),pu.subVectors(e.c,yu),fu.subVectors(du,hu),mu.subVectors(pu,du),gu.subVectors(hu,pu);let t=[0,-fu.z,fu.y,0,-mu.z,mu.y,0,-gu.z,gu.y,fu.z,0,-fu.x,mu.z,0,-mu.x,gu.z,0,-gu.x,-fu.y,fu.x,0,-mu.y,mu.x,0,-gu.y,gu.x,0];return!!bu(t,hu,du,pu,vu)&&(t=[1,0,0,0,1,0,0,0,1],!!bu(t,hu,du,pu,vu)&&(_u.crossVectors(fu,mu),t=[_u.x,_u.y,_u.z],bu(t,hu,du,pu,vu)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,cu).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(cu).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(lu[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),lu[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),lu[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),lu[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),lu[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),lu[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),lu[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),lu[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(lu)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(e){return this.min.fromArray(e.min),this.max.fromArray(e.max),this}}const lu=[new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc],cu=new Dc,uu=new au,hu=new Dc,du=new Dc,pu=new Dc,fu=new Dc,mu=new Dc,gu=new Dc,yu=new Dc,vu=new Dc,_u=new Dc,xu=new Dc;function bu(e,t,n,i,r){for(let s=0,o=e.length-3;s<=o;s+=3){xu.fromArray(e,s);const o=r.x*Math.abs(xu.x)+r.y*Math.abs(xu.y)+r.z*Math.abs(xu.z),a=t.dot(xu),l=n.dot(xu),c=i.dot(xu);if(Math.max(-Math.max(a,l,c),Math.min(a,l,c))>o)return!1}return!0}const wu=new au,Tu=new Dc,Su=new Dc;class Mu{constructor(e=new Dc,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const n=this.center;void 0!==t?n.copy(t):wu.setFromPoints(e).getCenter(n);let i=0;for(let t=0,r=e.length;t<r;t++)i=Math.max(i,n.distanceToSquared(e[t]));return this.radius=Math.sqrt(i),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const n=this.center.distanceToSquared(e);return t.copy(e),n>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;Tu.subVectors(e,this.center);const t=Tu.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),n=.5*(e-this.radius);this.center.addScaledVector(Tu,n/e),this.radius+=n}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(Su.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(Tu.copy(e.center).add(Su)),this.expandByPoint(Tu.copy(e.center).sub(Su))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(e){return this.radius=e.radius,this.center.fromArray(e.center),this}}const Eu=new Dc,Au=new Dc,Cu=new Dc,Ru=new Dc,Nu=new Dc,Pu=new Dc,Du=new Dc;class Lu{constructor(e=new Dc,t=new Dc(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,Eu)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const n=t.dot(this.direction);return n<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,n)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=Eu.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(Eu.copy(this.origin).addScaledVector(this.direction,t),Eu.distanceToSquared(e))}distanceSqToSegment(e,t,n,i){Au.copy(e).add(t).multiplyScalar(.5),Cu.copy(t).sub(e).normalize(),Ru.copy(this.origin).sub(Au);const r=.5*e.distanceTo(t),s=-this.direction.dot(Cu),o=Ru.dot(this.direction),a=-Ru.dot(Cu),l=Ru.lengthSq(),c=Math.abs(1-s*s);let u,h,d,p;if(c>0)if(u=s*a-o,h=s*o-a,p=r*c,u>=0)if(h>=-p)if(h<=p){const e=1/c;u*=e,h*=e,d=u*(u+s*h+2*o)+h*(s*u+h+2*a)+l}else h=r,u=Math.max(0,-(s*h+o)),d=-u*u+h*(h+2*a)+l;else h=-r,u=Math.max(0,-(s*h+o)),d=-u*u+h*(h+2*a)+l;else h<=-p?(u=Math.max(0,-(-s*r+o)),h=u>0?-r:Math.min(Math.max(-r,-a),r),d=-u*u+h*(h+2*a)+l):h<=p?(u=0,h=Math.min(Math.max(-r,-a),r),d=h*(h+2*a)+l):(u=Math.max(0,-(s*r+o)),h=u>0?r:Math.min(Math.max(-r,-a),r),d=-u*u+h*(h+2*a)+l);else h=s>0?-r:r,u=Math.max(0,-(s*h+o)),d=-u*u+h*(h+2*a)+l;return n&&n.copy(this.origin).addScaledVector(this.direction,u),i&&i.copy(Au).addScaledVector(Cu,h),d}intersectSphere(e,t){Eu.subVectors(e.center,this.origin);const n=Eu.dot(this.direction),i=Eu.dot(Eu)-n*n,r=e.radius*e.radius;if(i>r)return null;const s=Math.sqrt(r-i),o=n-s,a=n+s;return a<0?null:o<0?this.at(a,t):this.at(o,t)}intersectsSphere(e){return!(e.radius<0)&&this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const n=-(this.origin.dot(e.normal)+e.constant)/t;return n>=0?n:null}intersectPlane(e,t){const n=this.distanceToPlane(e);return null===n?null:this.at(n,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0}intersectBox(e,t){let n,i,r,s,o,a;const l=1/this.direction.x,c=1/this.direction.y,u=1/this.direction.z,h=this.origin;return l>=0?(n=(e.min.x-h.x)*l,i=(e.max.x-h.x)*l):(n=(e.max.x-h.x)*l,i=(e.min.x-h.x)*l),c>=0?(r=(e.min.y-h.y)*c,s=(e.max.y-h.y)*c):(r=(e.max.y-h.y)*c,s=(e.min.y-h.y)*c),n>s||r>i?null:((r>n||isNaN(n))&&(n=r),(s<i||isNaN(i))&&(i=s),u>=0?(o=(e.min.z-h.z)*u,a=(e.max.z-h.z)*u):(o=(e.max.z-h.z)*u,a=(e.min.z-h.z)*u),n>a||o>i?null:((o>n||n!=n)&&(n=o),(a<i||i!=i)&&(i=a),i<0?null:this.at(n>=0?n:i,t)))}intersectsBox(e){return null!==this.intersectBox(e,Eu)}intersectTriangle(e,t,n,i,r){Nu.subVectors(t,e),Pu.subVectors(n,e),Du.crossVectors(Nu,Pu);let s,o=this.direction.dot(Du);if(o>0){if(i)return null;s=1}else{if(!(o<0))return null;s=-1,o=-o}Ru.subVectors(this.origin,e);const a=s*this.direction.dot(Pu.crossVectors(Ru,Pu));if(a<0)return null;const l=s*this.direction.dot(Nu.cross(Ru));if(l<0)return null;if(a+l>o)return null;const c=-s*Ru.dot(Du);return c<0?null:this.at(c/o,r)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class Iu{constructor(e,t,n,i,r,s,o,a,l,c,u,h,d,p,f,m){Iu.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,n,i,r,s,o,a,l,c,u,h,d,p,f,m)}set(e,t,n,i,r,s,o,a,l,c,u,h,d,p,f,m){const g=this.elements;return g[0]=e,g[4]=t,g[8]=n,g[12]=i,g[1]=r,g[5]=s,g[9]=o,g[13]=a,g[2]=l,g[6]=c,g[10]=u,g[14]=h,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Iu).fromArray(this.elements)}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],this}copyPosition(e){const t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,n){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),n.setFromMatrixColumn(this,2),this}makeBasis(e,t,n){return this.set(e.x,t.x,n.x,0,e.y,t.y,n.y,0,e.z,t.z,n.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,n=e.elements,i=1/ku.setFromMatrixColumn(e,0).length(),r=1/ku.setFromMatrixColumn(e,1).length(),s=1/ku.setFromMatrixColumn(e,2).length();return t[0]=n[0]*i,t[1]=n[1]*i,t[2]=n[2]*i,t[3]=0,t[4]=n[4]*r,t[5]=n[5]*r,t[6]=n[6]*r,t[7]=0,t[8]=n[8]*s,t[9]=n[9]*s,t[10]=n[10]*s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,n=e.x,i=e.y,r=e.z,s=Math.cos(n),o=Math.sin(n),a=Math.cos(i),l=Math.sin(i),c=Math.cos(r),u=Math.sin(r);if("XYZ"===e.order){const e=s*c,n=s*u,i=o*c,r=o*u;t[0]=a*c,t[4]=-a*u,t[8]=l,t[1]=n+i*l,t[5]=e-r*l,t[9]=-o*a,t[2]=r-e*l,t[6]=i+n*l,t[10]=s*a}else if("YXZ"===e.order){const e=a*c,n=a*u,i=l*c,r=l*u;t[0]=e+r*o,t[4]=i*o-n,t[8]=s*l,t[1]=s*u,t[5]=s*c,t[9]=-o,t[2]=n*o-i,t[6]=r+e*o,t[10]=s*a}else if("ZXY"===e.order){const e=a*c,n=a*u,i=l*c,r=l*u;t[0]=e-r*o,t[4]=-s*u,t[8]=i+n*o,t[1]=n+i*o,t[5]=s*c,t[9]=r-e*o,t[2]=-s*l,t[6]=o,t[10]=s*a}else if("ZYX"===e.order){const e=s*c,n=s*u,i=o*c,r=o*u;t[0]=a*c,t[4]=i*l-n,t[8]=e*l+r,t[1]=a*u,t[5]=r*l+e,t[9]=n*l-i,t[2]=-l,t[6]=o*a,t[10]=s*a}else if("YZX"===e.order){const e=s*a,n=s*l,i=o*a,r=o*l;t[0]=a*c,t[4]=r-e*u,t[8]=i*u+n,t[1]=u,t[5]=s*c,t[9]=-o*c,t[2]=-l*c,t[6]=n*u+i,t[10]=e-r*u}else if("XZY"===e.order){const e=s*a,n=s*l,i=o*a,r=o*l;t[0]=a*c,t[4]=-u,t[8]=l*c,t[1]=e*u+r,t[5]=s*c,t[9]=n*u-i,t[2]=i*u-n,t[6]=o*c,t[10]=r*u+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(Uu,e,Fu)}lookAt(e,t,n){const i=this.elements;return Vu.subVectors(e,t),0===Vu.lengthSq()&&(Vu.z=1),Vu.normalize(),Bu.crossVectors(n,Vu),0===Bu.lengthSq()&&(1===Math.abs(n.z)?Vu.x+=1e-4:Vu.z+=1e-4,Vu.normalize(),Bu.crossVectors(n,Vu)),Bu.normalize(),zu.crossVectors(Vu,Bu),i[0]=Bu.x,i[4]=zu.x,i[8]=Vu.x,i[1]=Bu.y,i[5]=zu.y,i[9]=Vu.y,i[2]=Bu.z,i[6]=zu.z,i[10]=Vu.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,i=t.elements,r=this.elements,s=n[0],o=n[4],a=n[8],l=n[12],c=n[1],u=n[5],h=n[9],d=n[13],p=n[2],f=n[6],m=n[10],g=n[14],y=n[3],v=n[7],_=n[11],x=n[15],b=i[0],w=i[4],T=i[8],S=i[12],M=i[1],E=i[5],A=i[9],C=i[13],R=i[2],N=i[6],P=i[10],D=i[14],L=i[3],I=i[7],k=i[11],O=i[15];return r[0]=s*b+o*M+a*R+l*L,r[4]=s*w+o*E+a*N+l*I,r[8]=s*T+o*A+a*P+l*k,r[12]=s*S+o*C+a*D+l*O,r[1]=c*b+u*M+h*R+d*L,r[5]=c*w+u*E+h*N+d*I,r[9]=c*T+u*A+h*P+d*k,r[13]=c*S+u*C+h*D+d*O,r[2]=p*b+f*M+m*R+g*L,r[6]=p*w+f*E+m*N+g*I,r[10]=p*T+f*A+m*P+g*k,r[14]=p*S+f*C+m*D+g*O,r[3]=y*b+v*M+_*R+x*L,r[7]=y*w+v*E+_*N+x*I,r[11]=y*T+v*A+_*P+x*k,r[15]=y*S+v*C+_*D+x*O,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[4],i=e[8],r=e[12],s=e[1],o=e[5],a=e[9],l=e[13],c=e[2],u=e[6],h=e[10],d=e[14];return e[3]*(+r*a*u-i*l*u-r*o*h+n*l*h+i*o*d-n*a*d)+e[7]*(+t*a*d-t*l*h+r*s*h-i*s*d+i*l*c-r*a*c)+e[11]*(+t*l*u-t*o*d-r*s*u+n*s*d+r*o*c-n*l*c)+e[15]*(-i*o*c-t*a*u+t*o*h+i*s*u-n*s*h+n*a*c)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,n){const i=this.elements;return e.isVector3?(i[12]=e.x,i[13]=e.y,i[14]=e.z):(i[12]=e,i[13]=t,i[14]=n),this}invert(){const e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],s=e[4],o=e[5],a=e[6],l=e[7],c=e[8],u=e[9],h=e[10],d=e[11],p=e[12],f=e[13],m=e[14],g=e[15],y=u*m*l-f*h*l+f*a*d-o*m*d-u*a*g+o*h*g,v=p*h*l-c*m*l-p*a*d+s*m*d+c*a*g-s*h*g,_=c*f*l-p*u*l+p*o*d-s*f*d-c*o*g+s*u*g,x=p*u*a-c*f*a-p*o*h+s*f*h+c*o*m-s*u*m,b=t*y+n*v+i*_+r*x;if(0===b)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/b;return e[0]=y*w,e[1]=(f*h*r-u*m*r-f*i*d+n*m*d+u*i*g-n*h*g)*w,e[2]=(o*m*r-f*a*r+f*i*l-n*m*l-o*i*g+n*a*g)*w,e[3]=(u*a*r-o*h*r-u*i*l+n*h*l+o*i*d-n*a*d)*w,e[4]=v*w,e[5]=(c*m*r-p*h*r+p*i*d-t*m*d-c*i*g+t*h*g)*w,e[6]=(p*a*r-s*m*r-p*i*l+t*m*l+s*i*g-t*a*g)*w,e[7]=(s*h*r-c*a*r+c*i*l-t*h*l-s*i*d+t*a*d)*w,e[8]=_*w,e[9]=(p*u*r-c*f*r-p*n*d+t*f*d+c*n*g-t*u*g)*w,e[10]=(s*f*r-p*o*r+p*n*l-t*f*l-s*n*g+t*o*g)*w,e[11]=(c*o*r-s*u*r-c*n*l+t*u*l+s*n*d-t*o*d)*w,e[12]=x*w,e[13]=(c*f*i-p*u*i+p*n*h-t*f*h-c*n*m+t*u*m)*w,e[14]=(p*o*i-s*f*i-p*n*a+t*f*a+s*n*m-t*o*m)*w,e[15]=(s*u*i-c*o*i+c*n*a-t*u*a-s*n*h+t*o*h)*w,this}scale(e){const t=this.elements,n=e.x,i=e.y,r=e.z;return t[0]*=n,t[4]*=i,t[8]*=r,t[1]*=n,t[5]*=i,t[9]*=r,t[2]*=n,t[6]*=i,t[10]*=r,t[3]*=n,t[7]*=i,t[11]*=r,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],i=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,n,i))}makeTranslation(e,t,n){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const n=Math.cos(t),i=Math.sin(t),r=1-n,s=e.x,o=e.y,a=e.z,l=r*s,c=r*o;return this.set(l*s+n,l*o-i*a,l*a+i*o,0,l*o+i*a,c*o+n,c*a-i*s,0,l*a-i*o,c*a+i*s,r*a*a+n,0,0,0,0,1),this}makeScale(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this}makeShear(e,t,n,i,r,s){return this.set(1,n,r,0,e,1,s,0,t,i,1,0,0,0,0,1),this}compose(e,t,n){const i=this.elements,r=t._x,s=t._y,o=t._z,a=t._w,l=r+r,c=s+s,u=o+o,h=r*l,d=r*c,p=r*u,f=s*c,m=s*u,g=o*u,y=a*l,v=a*c,_=a*u,x=n.x,b=n.y,w=n.z;return i[0]=(1-(f+g))*x,i[1]=(d+_)*x,i[2]=(p-v)*x,i[3]=0,i[4]=(d-_)*b,i[5]=(1-(h+g))*b,i[6]=(m+y)*b,i[7]=0,i[8]=(p+v)*w,i[9]=(m-y)*w,i[10]=(1-(h+f))*w,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}decompose(e,t,n){const i=this.elements;let r=ku.set(i[0],i[1],i[2]).length();const s=ku.set(i[4],i[5],i[6]).length(),o=ku.set(i[8],i[9],i[10]).length();this.determinant()<0&&(r=-r),e.x=i[12],e.y=i[13],e.z=i[14],Ou.copy(this);const a=1/r,l=1/s,c=1/o;return Ou.elements[0]*=a,Ou.elements[1]*=a,Ou.elements[2]*=a,Ou.elements[4]*=l,Ou.elements[5]*=l,Ou.elements[6]*=l,Ou.elements[8]*=c,Ou.elements[9]*=c,Ou.elements[10]*=c,t.setFromRotationMatrix(Ou),n.x=r,n.y=s,n.z=o,this}makePerspective(e,t,n,i,r,s,o=2e3){const a=this.elements,l=2*r/(t-e),c=2*r/(n-i),u=(t+e)/(t-e),h=(n+i)/(n-i);let d,p;if(o===gc)d=-(s+r)/(s-r),p=-2*s*r/(s-r);else{if(o!==yc)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);d=-s/(s-r),p=-s*r/(s-r)}return a[0]=l,a[4]=0,a[8]=u,a[12]=0,a[1]=0,a[5]=c,a[9]=h,a[13]=0,a[2]=0,a[6]=0,a[10]=d,a[14]=p,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(e,t,n,i,r,s,o=2e3){const a=this.elements,l=1/(t-e),c=1/(n-i),u=1/(s-r),h=(t+e)*l,d=(n+i)*c;let p,f;if(o===gc)p=(s+r)*u,f=-2*u;else{if(o!==yc)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);p=r*u,f=-1*u}return a[0]=2*l,a[4]=0,a[8]=0,a[12]=-h,a[1]=0,a[5]=2*c,a[9]=0,a[13]=-d,a[2]=0,a[6]=0,a[10]=f,a[14]=-p,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}equals(e){const t=this.elements,n=e.elements;for(let e=0;e<16;e++)if(t[e]!==n[e])return!1;return!0}fromArray(e,t=0){for(let n=0;n<16;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e}}const ku=new Dc,Ou=new Iu,Uu=new Dc(0,0,0),Fu=new Dc(1,1,1),Bu=new Dc,zu=new Dc,Vu=new Dc,Gu=new Iu,ju=new Pc;class Hu{constructor(e=0,t=0,n=0,i=Hu.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=n,this._order=i}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,n,i=this._order){return this._x=e,this._y=t,this._z=n,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,n=!0){const i=e.elements,r=i[0],s=i[4],o=i[8],a=i[1],l=i[5],c=i[9],u=i[2],h=i[6],d=i[10];switch(t){case"XYZ":this._y=Math.asin(Sc(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-s,r)):(this._x=Math.atan2(h,l),this._z=0);break;case"YXZ":this._x=Math.asin(-Sc(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(o,d),this._z=Math.atan2(a,l)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(Sc(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(-u,d),this._z=Math.atan2(-s,l)):(this._y=0,this._z=Math.atan2(a,r));break;case"ZYX":this._y=Math.asin(-Sc(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(h,d),this._z=Math.atan2(a,r)):(this._x=0,this._z=Math.atan2(-s,l));break;case"YZX":this._z=Math.asin(Sc(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(o,d));break;case"XZY":this._z=Math.asin(-Sc(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(h,l),this._y=Math.atan2(o,r)):(this._x=Math.atan2(-c,d),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!0===n&&this._onChangeCallback(),this}setFromQuaternion(e,t,n){return Gu.makeRotationFromQuaternion(e),this.setFromRotationMatrix(Gu,t,n)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return ju.setFromEuler(this),this.setFromQuaternion(ju,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Hu.DEFAULT_ORDER="XYZ";class Wu{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return 0!==(this.mask&e.mask)}isEnabled(e){return!!(this.mask&1<<e)}}let qu=0;const Xu=new Dc,$u=new Pc,Yu=new Iu,Ku=new Dc,Zu=new Dc,Ju=new Dc,Qu=new Pc,eh=new Dc(1,0,0),th=new Dc(0,1,0),nh=new Dc(0,0,1),ih={type:"added"},rh={type:"removed"},sh={type:"childadded",child:null},oh={type:"childremoved",child:null};class ah extends vc{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:qu++}),this.uuid=Tc(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=ah.DEFAULT_UP.clone();const e=new Dc,t=new Hu,n=new Pc,i=new Dc(1,1,1);t._onChange((function(){n.setFromEuler(t,!1)})),n._onChange((function(){t.setFromQuaternion(n,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:n},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new Iu},normalMatrix:{value:new kc}}),this.matrix=new Iu,this.matrixWorld=new Iu,this.matrixAutoUpdate=ah.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=ah.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Wu,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return $u.setFromAxisAngle(e,t),this.quaternion.multiply($u),this}rotateOnWorldAxis(e,t){return $u.setFromAxisAngle(e,t),this.quaternion.premultiply($u),this}rotateX(e){return this.rotateOnAxis(eh,e)}rotateY(e){return this.rotateOnAxis(th,e)}rotateZ(e){return this.rotateOnAxis(nh,e)}translateOnAxis(e,t){return Xu.copy(e).applyQuaternion(this.quaternion),this.position.add(Xu.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(eh,e)}translateY(e){return this.translateOnAxis(th,e)}translateZ(e){return this.translateOnAxis(nh,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(Yu.copy(this.matrixWorld).invert())}lookAt(e,t,n){e.isVector3?Ku.copy(e):Ku.set(e,t,n);const i=this.parent;this.updateWorldMatrix(!0,!1),Zu.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Yu.lookAt(Zu,Ku,this.up):Yu.lookAt(Ku,Zu,this.up),this.quaternion.setFromRotationMatrix(Yu),i&&(Yu.extractRotation(i.matrixWorld),$u.setFromRotationMatrix(Yu),this.quaternion.premultiply($u.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(ih),sh.child=e,this.dispatchEvent(sh),sh.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(rh),oh.child=e,this.dispatchEvent(oh),oh.child=null),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),Yu.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),Yu.multiply(e.parent.matrixWorld)),e.applyMatrix4(Yu),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(ih),sh.child=e,this.dispatchEvent(sh),sh.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let n=0,i=this.children.length;n<i;n++){const i=this.children[n].getObjectByProperty(e,t);if(void 0!==i)return i}}getObjectsByProperty(e,t,n=[]){this[e]===t&&n.push(this);const i=this.children;for(let r=0,s=i.length;r<s;r++)i[r].getObjectsByProperty(e,t,n);return n}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Zu,e,Ju),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Zu,Qu,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let n=0,i=t.length;n<i;n++){t[n].updateMatrixWorld(e)}}updateWorldMatrix(e,t){const n=this.parent;if(!0===e&&null!==n&&n.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===t){const e=this.children;for(let t=0,n=e.length;t<n;t++){e[t].updateWorldMatrix(!1,!0)}}}toJSON(e){const t=void 0===e||"string"==typeof e,n={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},n.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const i={};function r(t,n){return void 0===t[n.uuid]&&(t[n.uuid]=n.toJSON(e)),n.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.geometryInfo=this._geometryInfo.map((e=>({...e,boundingBox:e.boundingBox?e.boundingBox.toJSON():void 0,boundingSphere:e.boundingSphere?e.boundingSphere.toJSON():void 0}))),i.instanceInfo=this._instanceInfo.map((e=>({...e}))),i.availableInstanceIds=this._availableInstanceIds.slice(),i.availableGeometryIds=this._availableGeometryIds.slice(),i.nextIndexStart=this._nextIndexStart,i.nextVertexStart=this._nextVertexStart,i.geometryCount=this._geometryCount,i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.matricesTexture=this._matricesTexture.toJSON(e),i.indirectTexture=this._indirectTexture.toJSON(e),null!==this._colorsTexture&&(i.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(i.boundingSphere=this.boundingSphere.toJSON()),null!==this.boundingBox&&(i.boundingBox=this.boundingBox.toJSON())),this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(i.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=r(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const n=t.shapes;if(Array.isArray(n))for(let t=0,i=n.length;t<i;t++){const i=n[t];r(e.shapes,i)}else r(e.shapes,n)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(e.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let n=0,i=this.material.length;n<i;n++)t.push(r(e.materials,this.material[n]));i.material=t}else i.material=r(e.materials,this.material);if(this.children.length>0){i.children=[];for(let t=0;t<this.children.length;t++)i.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){i.animations=[];for(let t=0;t<this.animations.length;t++){const n=this.animations[t];i.animations.push(r(e.animations,n))}}if(t){const t=s(e.geometries),i=s(e.materials),r=s(e.textures),o=s(e.images),a=s(e.shapes),l=s(e.skeletons),c=s(e.animations),u=s(e.nodes);t.length>0&&(n.geometries=t),i.length>0&&(n.materials=i),r.length>0&&(n.textures=r),o.length>0&&(n.images=o),a.length>0&&(n.shapes=a),l.length>0&&(n.skeletons=l),c.length>0&&(n.animations=c),u.length>0&&(n.nodes=u)}return n.object=i,n;function s(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){const n=e.children[t];this.add(n.clone())}return this}}ah.DEFAULT_UP=new Dc(0,1,0),ah.DEFAULT_MATRIX_AUTO_UPDATE=!0,ah.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const lh=new Dc,ch=new Dc,uh=new Dc,hh=new Dc,dh=new Dc,ph=new Dc,fh=new Dc,mh=new Dc,gh=new Dc,yh=new Dc,vh=new nu,_h=new nu,xh=new nu;class bh{constructor(e=new Dc,t=new Dc,n=new Dc){this.a=e,this.b=t,this.c=n}static getNormal(e,t,n,i){i.subVectors(n,t),lh.subVectors(e,t),i.cross(lh);const r=i.lengthSq();return r>0?i.multiplyScalar(1/Math.sqrt(r)):i.set(0,0,0)}static getBarycoord(e,t,n,i,r){lh.subVectors(i,t),ch.subVectors(n,t),uh.subVectors(e,t);const s=lh.dot(lh),o=lh.dot(ch),a=lh.dot(uh),l=ch.dot(ch),c=ch.dot(uh),u=s*l-o*o;if(0===u)return r.set(0,0,0),null;const h=1/u,d=(l*a-o*c)*h,p=(s*c-o*a)*h;return r.set(1-d-p,p,d)}static containsPoint(e,t,n,i){return null!==this.getBarycoord(e,t,n,i,hh)&&(hh.x>=0&&hh.y>=0&&hh.x+hh.y<=1)}static getInterpolation(e,t,n,i,r,s,o,a){return null===this.getBarycoord(e,t,n,i,hh)?(a.x=0,a.y=0,"z"in a&&(a.z=0),"w"in a&&(a.w=0),null):(a.setScalar(0),a.addScaledVector(r,hh.x),a.addScaledVector(s,hh.y),a.addScaledVector(o,hh.z),a)}static getInterpolatedAttribute(e,t,n,i,r,s){return vh.setScalar(0),_h.setScalar(0),xh.setScalar(0),vh.fromBufferAttribute(e,t),_h.fromBufferAttribute(e,n),xh.fromBufferAttribute(e,i),s.setScalar(0),s.addScaledVector(vh,r.x),s.addScaledVector(_h,r.y),s.addScaledVector(xh,r.z),s}static isFrontFacing(e,t,n,i){return lh.subVectors(n,t),ch.subVectors(e,t),lh.cross(ch).dot(i)<0}set(e,t,n){return this.a.copy(e),this.b.copy(t),this.c.copy(n),this}setFromPointsAndIndices(e,t,n,i){return this.a.copy(e[t]),this.b.copy(e[n]),this.c.copy(e[i]),this}setFromAttributeAndIndices(e,t,n,i){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,n),this.c.fromBufferAttribute(e,i),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return lh.subVectors(this.c,this.b),ch.subVectors(this.a,this.b),.5*lh.cross(ch).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return bh.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return bh.getBarycoord(e,this.a,this.b,this.c,t)}getInterpolation(e,t,n,i,r){return bh.getInterpolation(e,this.a,this.b,this.c,t,n,i,r)}containsPoint(e){return bh.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return bh.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const n=this.a,i=this.b,r=this.c;let s,o;dh.subVectors(i,n),ph.subVectors(r,n),mh.subVectors(e,n);const a=dh.dot(mh),l=ph.dot(mh);if(a<=0&&l<=0)return t.copy(n);gh.subVectors(e,i);const c=dh.dot(gh),u=ph.dot(gh);if(c>=0&&u<=c)return t.copy(i);const h=a*u-c*l;if(h<=0&&a>=0&&c<=0)return s=a/(a-c),t.copy(n).addScaledVector(dh,s);yh.subVectors(e,r);const d=dh.dot(yh),p=ph.dot(yh);if(p>=0&&d<=p)return t.copy(r);const f=d*l-a*p;if(f<=0&&l>=0&&p<=0)return o=l/(l-p),t.copy(n).addScaledVector(ph,o);const m=c*p-d*u;if(m<=0&&u-c>=0&&d-p>=0)return fh.subVectors(r,i),o=(u-c)/(u-c+(d-p)),t.copy(i).addScaledVector(fh,o);const g=1/(m+f+h);return s=f*g,o=h*g,t.copy(n).addScaledVector(dh,s).addScaledVector(ph,o)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const wh={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Th={h:0,s:0,l:0},Sh={h:0,s:0,l:0};function Mh(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+6*(t-e)*(2/3-n):e}let Eh=class{constructor(e,t,n){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,n)}set(e,t,n){if(void 0===t&&void 0===n){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,n);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=ec){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,Wc.colorSpaceToWorking(this,t),this}setRGB(e,t,n,i=Wc.workingColorSpace){return this.r=e,this.g=t,this.b=n,Wc.colorSpaceToWorking(this,i),this}setHSL(e,t,n,i=Wc.workingColorSpace){if(e=Mc(e,1),t=Sc(t,0,1),n=Sc(n,0,1),0===t)this.r=this.g=this.b=n;else{const i=n<=.5?n*(1+t):n+t-n*t,r=2*n-i;this.r=Mh(r,i,e+1/3),this.g=Mh(r,i,e),this.b=Mh(r,i,e-1/3)}return Wc.colorSpaceToWorking(this,i),this}setStyle(e,t=ec){function n(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(e)){let r;const s=i[1],o=i[2];switch(s){case"rgb":case"rgba":if(r=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(r[4]),this.setRGB(Math.min(255,parseInt(r[1],10))/255,Math.min(255,parseInt(r[2],10))/255,Math.min(255,parseInt(r[3],10))/255,t);if(r=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(r[4]),this.setRGB(Math.min(100,parseInt(r[1],10))/100,Math.min(100,parseInt(r[2],10))/100,Math.min(100,parseInt(r[3],10))/100,t);break;case"hsl":case"hsla":if(r=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(r[4]),this.setHSL(parseFloat(r[1])/360,parseFloat(r[2])/100,parseFloat(r[3])/100,t);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(e)){const n=i[1],r=n.length;if(3===r)return this.setRGB(parseInt(n.charAt(0),16)/15,parseInt(n.charAt(1),16)/15,parseInt(n.charAt(2),16)/15,t);if(6===r)return this.setHex(parseInt(n,16),t);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=ec){const n=wh[e.toLowerCase()];return void 0!==n?this.setHex(n,t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=qc(e.r),this.g=qc(e.g),this.b=qc(e.b),this}copyLinearToSRGB(e){return this.r=Xc(e.r),this.g=Xc(e.g),this.b=Xc(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=ec){return Wc.workingToColorSpace(Ah.copy(this),e),65536*Math.round(Sc(255*Ah.r,0,255))+256*Math.round(Sc(255*Ah.g,0,255))+Math.round(Sc(255*Ah.b,0,255))}getHexString(e=ec){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=Wc.workingColorSpace){Wc.workingToColorSpace(Ah.copy(this),t);const n=Ah.r,i=Ah.g,r=Ah.b,s=Math.max(n,i,r),o=Math.min(n,i,r);let a,l;const c=(o+s)/2;if(o===s)a=0,l=0;else{const e=s-o;switch(l=c<=.5?e/(s+o):e/(2-s-o),s){case n:a=(i-r)/e+(i<r?6:0);break;case i:a=(r-n)/e+2;break;case r:a=(n-i)/e+4}a/=6}return e.h=a,e.s=l,e.l=c,e}getRGB(e,t=Wc.workingColorSpace){return Wc.workingToColorSpace(Ah.copy(this),t),e.r=Ah.r,e.g=Ah.g,e.b=Ah.b,e}getStyle(e=ec){Wc.workingToColorSpace(Ah.copy(this),e);const t=Ah.r,n=Ah.g,i=Ah.b;return e!==ec?`color(${e} ${t.toFixed(3)} ${n.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*n)},${Math.round(255*i)})`}offsetHSL(e,t,n){return this.getHSL(Th),this.setHSL(Th.h+e,Th.s+t,Th.l+n)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,n){return this.r=e.r+(t.r-e.r)*n,this.g=e.g+(t.g-e.g)*n,this.b=e.b+(t.b-e.b)*n,this}lerpHSL(e,t){this.getHSL(Th),e.getHSL(Sh);const n=Ec(Th.h,Sh.h,t),i=Ec(Th.s,Sh.s,t),r=Ec(Th.l,Sh.l,t);return this.setHSL(n,i,r),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,n=this.g,i=this.b,r=e.elements;return this.r=r[0]*t+r[3]*n+r[6]*i,this.g=r[1]*t+r[4]*n+r[7]*i,this.b=r[2]*t+r[5]*n+r[8]*i,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}};const Ah=new Eh;Eh.NAMES=wh;let Ch=0;class Rh extends vc{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Ch++}),this.uuid=Tc(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=xa,this.blendDst=ba,this.blendEquation=pa,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Eh(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=rc,this.stencilZFail=rc,this.stencilZPass=rc,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const n=e[t];if(void 0===n){console.warn(`THREE.Material: parameter '${t}' has value of undefined.`);continue}const i=this[t];void 0!==i?i&&i.isColor?i.set(n):i&&i.isVector3&&n&&n.isVector3?i.copy(n):this[t]=n:console.warn(`THREE.Material: '${t}' is not a property of THREE.${this.type}.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const n={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};function i(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),void 0!==this.roughness&&(n.roughness=this.roughness),void 0!==this.metalness&&(n.metalness=this.metalness),void 0!==this.sheen&&(n.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(n.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(n.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(n.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(n.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(n.shininess=this.shininess),void 0!==this.clearcoat&&(n.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(n.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(n.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(n.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(n.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,n.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(n.dispersion=this.dispersion),void 0!==this.iridescence&&(n.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(n.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(n.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(n.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(n.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(n.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(n.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(n.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(e).uuid,n.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(e).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(e).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(e).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(e).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(n.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(n.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(n.combine=this.combine)),void 0!==this.envMapRotation&&(n.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(n.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(n.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(n.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(n.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(n.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(n.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(n.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(n.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(n.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(n.size=this.size),null!==this.shadowSide&&(n.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(n.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(n.blending=this.blending),0!==this.side&&(n.side=this.side),!0===this.vertexColors&&(n.vertexColors=!0),this.opacity<1&&(n.opacity=this.opacity),!0===this.transparent&&(n.transparent=!0),this.blendSrc!==xa&&(n.blendSrc=this.blendSrc),this.blendDst!==ba&&(n.blendDst=this.blendDst),this.blendEquation!==pa&&(n.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(n.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(n.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(n.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(n.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(n.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(n.depthFunc=this.depthFunc),!1===this.depthTest&&(n.depthTest=this.depthTest),!1===this.depthWrite&&(n.depthWrite=this.depthWrite),!1===this.colorWrite&&(n.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(n.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(n.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(n.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(n.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==rc&&(n.stencilFail=this.stencilFail),this.stencilZFail!==rc&&(n.stencilZFail=this.stencilZFail),this.stencilZPass!==rc&&(n.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(n.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(n.rotation=this.rotation),!0===this.polygonOffset&&(n.polygonOffset=!0),0!==this.polygonOffsetFactor&&(n.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(n.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(n.linewidth=this.linewidth),void 0!==this.dashSize&&(n.dashSize=this.dashSize),void 0!==this.gapSize&&(n.gapSize=this.gapSize),void 0!==this.scale&&(n.scale=this.scale),!0===this.dithering&&(n.dithering=!0),this.alphaTest>0&&(n.alphaTest=this.alphaTest),!0===this.alphaHash&&(n.alphaHash=!0),!0===this.alphaToCoverage&&(n.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(n.premultipliedAlpha=!0),!0===this.forceSinglePass&&(n.forceSinglePass=!0),!0===this.wireframe&&(n.wireframe=!0),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(n.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(n.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(n.flatShading=!0),!1===this.visible&&(n.visible=!1),!1===this.toneMapped&&(n.toneMapped=!1),!1===this.fog&&(n.fog=!1),Object.keys(this.userData).length>0&&(n.userData=this.userData),t){const t=i(e.textures),r=i(e.images);t.length>0&&(n.textures=t),r.length>0&&(n.images=r)}return n}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let n=null;if(null!==t){const e=t.length;n=new Array(e);for(let i=0;i!==e;++i)n[i]=t[i].clone()}return this.clippingPlanes=n,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}class Nh extends Rh{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Eh(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Hu,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const Ph=Dh();function Dh(){const e=new ArrayBuffer(4),t=new Float32Array(e),n=new Uint32Array(e),i=new Uint32Array(512),r=new Uint32Array(512);for(let e=0;e<256;++e){const t=e-127;t<-27?(i[e]=0,i[256|e]=32768,r[e]=24,r[256|e]=24):t<-14?(i[e]=1024>>-t-14,i[256|e]=1024>>-t-14|32768,r[e]=-t-1,r[256|e]=-t-1):t<=15?(i[e]=t+15<<10,i[256|e]=t+15<<10|32768,r[e]=13,r[256|e]=13):t<128?(i[e]=31744,i[256|e]=64512,r[e]=24,r[256|e]=24):(i[e]=31744,i[256|e]=64512,r[e]=13,r[256|e]=13)}const s=new Uint32Array(2048),o=new Uint32Array(64),a=new Uint32Array(64);for(let e=1;e<1024;++e){let t=e<<13,n=0;for(;!(8388608&t);)t<<=1,n-=8388608;t&=-8388609,n+=947912704,s[e]=t|n}for(let e=1024;e<2048;++e)s[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)o[e]=e<<23;o[31]=1199570944,o[32]=2147483648;for(let e=33;e<63;++e)o[e]=2147483648+(e-32<<23);o[63]=3347054592;for(let e=1;e<64;++e)32!==e&&(a[e]=1024);return{floatView:t,uint32View:n,baseTable:i,shiftTable:r,mantissaTable:s,exponentTable:o,offsetTable:a}}function Lh(e){Math.abs(e)>65504&&console.warn("THREE.DataUtils.toHalfFloat(): Value out of range."),e=Sc(e,-65504,65504),Ph.floatView[0]=e;const t=Ph.uint32View[0],n=t>>23&511;return Ph.baseTable[n]+((8388607&t)>>Ph.shiftTable[n])}function Ih(e){const t=e>>10;return Ph.uint32View[0]=Ph.mantissaTable[Ph.offsetTable[t]+(1023&e)]+Ph.exponentTable[t],Ph.floatView[0]}const kh=new Dc,Oh=new Nc;let Uh=0;class Fh{constructor(e,t,n=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:Uh++}),this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=n,this.usage=pc,this.updateRanges=[],this.gpuType=sl,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,n){e*=this.itemSize,n*=t.itemSize;for(let i=0,r=this.itemSize;i<r;i++)this.array[e+i]=t.array[n+i];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,n=this.count;t<n;t++)Oh.fromBufferAttribute(this,t),Oh.applyMatrix3(e),this.setXY(t,Oh.x,Oh.y);else if(3===this.itemSize)for(let t=0,n=this.count;t<n;t++)kh.fromBufferAttribute(this,t),kh.applyMatrix3(e),this.setXYZ(t,kh.x,kh.y,kh.z);return this}applyMatrix4(e){for(let t=0,n=this.count;t<n;t++)kh.fromBufferAttribute(this,t),kh.applyMatrix4(e),this.setXYZ(t,kh.x,kh.y,kh.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)kh.fromBufferAttribute(this,t),kh.applyNormalMatrix(e),this.setXYZ(t,kh.x,kh.y,kh.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)kh.fromBufferAttribute(this,t),kh.transformDirection(e),this.setXYZ(t,kh.x,kh.y,kh.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let n=this.array[e*this.itemSize+t];return this.normalized&&(n=Ac(n,this.array)),n}setComponent(e,t,n){return this.normalized&&(n=Cc(n,this.array)),this.array[e*this.itemSize+t]=n,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=Ac(t,this.array)),t}setX(e,t){return this.normalized&&(t=Cc(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=Ac(t,this.array)),t}setY(e,t){return this.normalized&&(t=Cc(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=Ac(t,this.array)),t}setZ(e,t){return this.normalized&&(t=Cc(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=Ac(t,this.array)),t}setW(e,t){return this.normalized&&(t=Cc(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,n){return e*=this.itemSize,this.normalized&&(t=Cc(t,this.array),n=Cc(n,this.array)),this.array[e+0]=t,this.array[e+1]=n,this}setXYZ(e,t,n,i){return e*=this.itemSize,this.normalized&&(t=Cc(t,this.array),n=Cc(n,this.array),i=Cc(i,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this}setXYZW(e,t,n,i,r){return e*=this.itemSize,this.normalized&&(t=Cc(t,this.array),n=Cc(n,this.array),i=Cc(i,this.array),r=Cc(r,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this.array[e+3]=r,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),this.usage!==pc&&(e.usage=this.usage),e}}class Bh extends Fh{constructor(e,t,n){super(new Uint16Array(e),t,n)}}class zh extends Fh{constructor(e,t,n){super(new Uint32Array(e),t,n)}}class Vh extends Fh{constructor(e,t,n){super(new Uint16Array(e),t,n),this.isFloat16BufferAttribute=!0}getX(e){let t=Ih(this.array[e*this.itemSize]);return this.normalized&&(t=Ac(t,this.array)),t}setX(e,t){return this.normalized&&(t=Cc(t,this.array)),this.array[e*this.itemSize]=Lh(t),this}getY(e){let t=Ih(this.array[e*this.itemSize+1]);return this.normalized&&(t=Ac(t,this.array)),t}setY(e,t){return this.normalized&&(t=Cc(t,this.array)),this.array[e*this.itemSize+1]=Lh(t),this}getZ(e){let t=Ih(this.array[e*this.itemSize+2]);return this.normalized&&(t=Ac(t,this.array)),t}setZ(e,t){return this.normalized&&(t=Cc(t,this.array)),this.array[e*this.itemSize+2]=Lh(t),this}getW(e){let t=Ih(this.array[e*this.itemSize+3]);return this.normalized&&(t=Ac(t,this.array)),t}setW(e,t){return this.normalized&&(t=Cc(t,this.array)),this.array[e*this.itemSize+3]=Lh(t),this}setXY(e,t,n){return e*=this.itemSize,this.normalized&&(t=Cc(t,this.array),n=Cc(n,this.array)),this.array[e+0]=Lh(t),this.array[e+1]=Lh(n),this}setXYZ(e,t,n,i){return e*=this.itemSize,this.normalized&&(t=Cc(t,this.array),n=Cc(n,this.array),i=Cc(i,this.array)),this.array[e+0]=Lh(t),this.array[e+1]=Lh(n),this.array[e+2]=Lh(i),this}setXYZW(e,t,n,i,r){return e*=this.itemSize,this.normalized&&(t=Cc(t,this.array),n=Cc(n,this.array),i=Cc(i,this.array),r=Cc(r,this.array)),this.array[e+0]=Lh(t),this.array[e+1]=Lh(n),this.array[e+2]=Lh(i),this.array[e+3]=Lh(r),this}}class Gh extends Fh{constructor(e,t,n){super(new Float32Array(e),t,n)}}let jh=0;const Hh=new Iu,Wh=new ah,qh=new Dc,Xh=new au,$h=new au,Yh=new Dc;class Kh extends vc{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:jh++}),this.uuid=Tc(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(Uc(e)?zh:Bh)(e,1):this.index=e,this}setIndirect(e){return this.indirect=e,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,n=0){this.groups.push({start:e,count:t,materialIndex:n})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const n=this.attributes.normal;if(void 0!==n){const t=(new kc).getNormalMatrix(e);n.applyNormalMatrix(t),n.needsUpdate=!0}const i=this.attributes.tangent;return void 0!==i&&(i.transformDirection(e),i.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return Hh.makeRotationFromQuaternion(e),this.applyMatrix4(Hh),this}rotateX(e){return Hh.makeRotationX(e),this.applyMatrix4(Hh),this}rotateY(e){return Hh.makeRotationY(e),this.applyMatrix4(Hh),this}rotateZ(e){return Hh.makeRotationZ(e),this.applyMatrix4(Hh),this}translate(e,t,n){return Hh.makeTranslation(e,t,n),this.applyMatrix4(Hh),this}scale(e,t,n){return Hh.makeScale(e,t,n),this.applyMatrix4(Hh),this}lookAt(e){return Wh.lookAt(e),Wh.updateMatrix(),this.applyMatrix4(Wh.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(qh).negate(),this.translate(qh.x,qh.y,qh.z),this}setFromPoints(e){const t=this.getAttribute("position");if(void 0===t){const t=[];for(let n=0,i=e.length;n<i;n++){const i=e[n];t.push(i.x,i.y,i.z||0)}this.setAttribute("position",new Gh(t,3))}else{const n=Math.min(e.length,t.count);for(let i=0;i<n;i++){const n=e[i];t.setXYZ(i,n.x,n.y,n.z||0)}e.length>t.count&&console.warn("THREE.BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),t.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new au);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),void this.boundingBox.set(new Dc(-1/0,-1/0,-1/0),new Dc(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,n=t.length;e<n;e++){const n=t[e];Xh.setFromBufferAttribute(n),this.morphTargetsRelative?(Yh.addVectors(this.boundingBox.min,Xh.min),this.boundingBox.expandByPoint(Yh),Yh.addVectors(this.boundingBox.max,Xh.max),this.boundingBox.expandByPoint(Yh)):(this.boundingBox.expandByPoint(Xh.min),this.boundingBox.expandByPoint(Xh.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Mu);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),void this.boundingSphere.set(new Dc,1/0);if(e){const n=this.boundingSphere.center;if(Xh.setFromBufferAttribute(e),t)for(let e=0,n=t.length;e<n;e++){const n=t[e];$h.setFromBufferAttribute(n),this.morphTargetsRelative?(Yh.addVectors(Xh.min,$h.min),Xh.expandByPoint(Yh),Yh.addVectors(Xh.max,$h.max),Xh.expandByPoint(Yh)):(Xh.expandByPoint($h.min),Xh.expandByPoint($h.max))}Xh.getCenter(n);let i=0;for(let t=0,r=e.count;t<r;t++)Yh.fromBufferAttribute(e,t),i=Math.max(i,n.distanceToSquared(Yh));if(t)for(let r=0,s=t.length;r<s;r++){const s=t[r],o=this.morphTargetsRelative;for(let t=0,r=s.count;t<r;t++)Yh.fromBufferAttribute(s,t),o&&(qh.fromBufferAttribute(e,t),Yh.add(qh)),i=Math.max(i,n.distanceToSquared(Yh))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const n=t.position,i=t.normal,r=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new Fh(new Float32Array(4*n.count),4));const s=this.getAttribute("tangent"),o=[],a=[];for(let e=0;e<n.count;e++)o[e]=new Dc,a[e]=new Dc;const l=new Dc,c=new Dc,u=new Dc,h=new Nc,d=new Nc,p=new Nc,f=new Dc,m=new Dc;function g(e,t,i){l.fromBufferAttribute(n,e),c.fromBufferAttribute(n,t),u.fromBufferAttribute(n,i),h.fromBufferAttribute(r,e),d.fromBufferAttribute(r,t),p.fromBufferAttribute(r,i),c.sub(l),u.sub(l),d.sub(h),p.sub(h);const s=1/(d.x*p.y-p.x*d.y);isFinite(s)&&(f.copy(c).multiplyScalar(p.y).addScaledVector(u,-d.y).multiplyScalar(s),m.copy(u).multiplyScalar(d.x).addScaledVector(c,-p.x).multiplyScalar(s),o[e].add(f),o[t].add(f),o[i].add(f),a[e].add(m),a[t].add(m),a[i].add(m))}let y=this.groups;0===y.length&&(y=[{start:0,count:e.count}]);for(let t=0,n=y.length;t<n;++t){const n=y[t],i=n.start;for(let t=i,r=i+n.count;t<r;t+=3)g(e.getX(t+0),e.getX(t+1),e.getX(t+2))}const v=new Dc,_=new Dc,x=new Dc,b=new Dc;function w(e){x.fromBufferAttribute(i,e),b.copy(x);const t=o[e];v.copy(t),v.sub(x.multiplyScalar(x.dot(t))).normalize(),_.crossVectors(b,t);const n=_.dot(a[e])<0?-1:1;s.setXYZW(e,v.x,v.y,v.z,n)}for(let t=0,n=y.length;t<n;++t){const n=y[t],i=n.start;for(let t=i,r=i+n.count;t<r;t+=3)w(e.getX(t+0)),w(e.getX(t+1)),w(e.getX(t+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let n=this.getAttribute("normal");if(void 0===n)n=new Fh(new Float32Array(3*t.count),3),this.setAttribute("normal",n);else for(let e=0,t=n.count;e<t;e++)n.setXYZ(e,0,0,0);const i=new Dc,r=new Dc,s=new Dc,o=new Dc,a=new Dc,l=new Dc,c=new Dc,u=new Dc;if(e)for(let h=0,d=e.count;h<d;h+=3){const d=e.getX(h+0),p=e.getX(h+1),f=e.getX(h+2);i.fromBufferAttribute(t,d),r.fromBufferAttribute(t,p),s.fromBufferAttribute(t,f),c.subVectors(s,r),u.subVectors(i,r),c.cross(u),o.fromBufferAttribute(n,d),a.fromBufferAttribute(n,p),l.fromBufferAttribute(n,f),o.add(c),a.add(c),l.add(c),n.setXYZ(d,o.x,o.y,o.z),n.setXYZ(p,a.x,a.y,a.z),n.setXYZ(f,l.x,l.y,l.z)}else for(let e=0,o=t.count;e<o;e+=3)i.fromBufferAttribute(t,e+0),r.fromBufferAttribute(t,e+1),s.fromBufferAttribute(t,e+2),c.subVectors(s,r),u.subVectors(i,r),c.cross(u),n.setXYZ(e+0,c.x,c.y,c.z),n.setXYZ(e+1,c.x,c.y,c.z),n.setXYZ(e+2,c.x,c.y,c.z);this.normalizeNormals(),n.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,n=e.count;t<n;t++)Yh.fromBufferAttribute(e,t),Yh.normalize(),e.setXYZ(t,Yh.x,Yh.y,Yh.z)}toNonIndexed(){function e(e,t){const n=e.array,i=e.itemSize,r=e.normalized,s=new n.constructor(t.length*i);let o=0,a=0;for(let r=0,l=t.length;r<l;r++){o=e.isInterleavedBufferAttribute?t[r]*e.data.stride+e.offset:t[r]*i;for(let e=0;e<i;e++)s[a++]=n[o++]}return new Fh(s,i,r)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new Kh,n=this.index.array,i=this.attributes;for(const r in i){const s=e(i[r],n);t.setAttribute(r,s)}const r=this.morphAttributes;for(const i in r){const s=[],o=r[i];for(let t=0,i=o.length;t<i;t++){const i=e(o[t],n);s.push(i)}t.morphAttributes[i]=s}t.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let e=0,n=s.length;e<n;e++){const n=s[e];t.addGroup(n.start,n.count,n.materialIndex)}return t}toJSON(){const e={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const n in t)void 0!==t[n]&&(e[n]=t[n]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const n=this.attributes;for(const t in n){const i=n[t];e.data.attributes[t]=i.toJSON(e.data)}const i={};let r=!1;for(const t in this.morphAttributes){const n=this.morphAttributes[t],s=[];for(let t=0,i=n.length;t<i;t++){const i=n[t];s.push(i.toJSON(e.data))}s.length>0&&(i[t]=s,r=!0)}r&&(e.data.morphAttributes=i,e.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));const o=this.boundingSphere;return null!==o&&(e.data.boundingSphere=o.toJSON()),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const n=e.index;null!==n&&this.setIndex(n.clone());const i=e.attributes;for(const e in i){const n=i[e];this.setAttribute(e,n.clone(t))}const r=e.morphAttributes;for(const e in r){const n=[],i=r[e];for(let e=0,r=i.length;e<r;e++)n.push(i[e].clone(t));this.morphAttributes[e]=n}this.morphTargetsRelative=e.morphTargetsRelative;const s=e.groups;for(let e=0,t=s.length;e<t;e++){const t=s[e];this.addGroup(t.start,t.count,t.materialIndex)}const o=e.boundingBox;null!==o&&(this.boundingBox=o.clone());const a=e.boundingSphere;return null!==a&&(this.boundingSphere=a.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const Zh=new Iu,Jh=new Lu,Qh=new Mu,ed=new Dc,td=new Dc,nd=new Dc,id=new Dc,rd=new Dc,sd=new Dc,od=new Dc,ad=new Dc;class ld extends ah{constructor(e=new Kh,t=new Nh){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const n=this.geometry,i=n.attributes.position,r=n.morphAttributes.position,s=n.morphTargetsRelative;t.fromBufferAttribute(i,e);const o=this.morphTargetInfluences;if(r&&o){sd.set(0,0,0);for(let n=0,i=r.length;n<i;n++){const i=o[n],a=r[n];0!==i&&(rd.fromBufferAttribute(a,e),s?sd.addScaledVector(rd,i):sd.addScaledVector(rd.sub(t),i))}t.add(sd)}return t}raycast(e,t){const n=this.geometry,i=this.material,r=this.matrixWorld;if(void 0!==i){if(null===n.boundingSphere&&n.computeBoundingSphere(),Qh.copy(n.boundingSphere),Qh.applyMatrix4(r),Jh.copy(e.ray).recast(e.near),!1===Qh.containsPoint(Jh.origin)){if(null===Jh.intersectSphere(Qh,ed))return;if(Jh.origin.distanceToSquared(ed)>(e.far-e.near)**2)return}Zh.copy(r).invert(),Jh.copy(e.ray).applyMatrix4(Zh),null!==n.boundingBox&&!1===Jh.intersectsBox(n.boundingBox)||this._computeIntersections(e,t,Jh)}}_computeIntersections(e,t,n){let i;const r=this.geometry,s=this.material,o=r.index,a=r.attributes.position,l=r.attributes.uv,c=r.attributes.uv1,u=r.attributes.normal,h=r.groups,d=r.drawRange;if(null!==o)if(Array.isArray(s))for(let r=0,a=h.length;r<a;r++){const a=h[r],p=s[a.materialIndex];for(let r=Math.max(a.start,d.start),s=Math.min(o.count,Math.min(a.start+a.count,d.start+d.count));r<s;r+=3){i=cd(this,p,e,n,l,c,u,o.getX(r),o.getX(r+1),o.getX(r+2)),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=a.materialIndex,t.push(i))}}else{for(let r=Math.max(0,d.start),a=Math.min(o.count,d.start+d.count);r<a;r+=3){i=cd(this,s,e,n,l,c,u,o.getX(r),o.getX(r+1),o.getX(r+2)),i&&(i.faceIndex=Math.floor(r/3),t.push(i))}}else if(void 0!==a)if(Array.isArray(s))for(let r=0,o=h.length;r<o;r++){const o=h[r],p=s[o.materialIndex];for(let r=Math.max(o.start,d.start),s=Math.min(a.count,Math.min(o.start+o.count,d.start+d.count));r<s;r+=3){i=cd(this,p,e,n,l,c,u,r,r+1,r+2),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=o.materialIndex,t.push(i))}}else{for(let r=Math.max(0,d.start),o=Math.min(a.count,d.start+d.count);r<o;r+=3){i=cd(this,s,e,n,l,c,u,r,r+1,r+2),i&&(i.faceIndex=Math.floor(r/3),t.push(i))}}}}function cd(e,t,n,i,r,s,o,a,l,c){e.getVertexPosition(a,td),e.getVertexPosition(l,nd),e.getVertexPosition(c,id);const u=function(e,t,n,i,r,s,o,a){let l;if(l=1===t.side?i.intersectTriangle(o,s,r,!0,a):i.intersectTriangle(r,s,o,0===t.side,a),null===l)return null;ad.copy(a),ad.applyMatrix4(e.matrixWorld);const c=n.ray.origin.distanceTo(ad);return c<n.near||c>n.far?null:{distance:c,point:ad.clone(),object:e}}(e,t,n,i,td,nd,id,od);if(u){const e=new Dc;bh.getBarycoord(od,td,nd,id,e),r&&(u.uv=bh.getInterpolatedAttribute(r,a,l,c,e,new Nc)),s&&(u.uv1=bh.getInterpolatedAttribute(s,a,l,c,e,new Nc)),o&&(u.normal=bh.getInterpolatedAttribute(o,a,l,c,e,new Dc),u.normal.dot(i.direction)>0&&u.normal.multiplyScalar(-1));const t={a:a,b:l,c:c,normal:new Dc,materialIndex:0};bh.getNormal(td,nd,id,t.normal),u.face=t,u.barycoord=e}return u}class ud extends Kh{constructor(e=1,t=1,n=1,i=1,r=1,s=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:n,widthSegments:i,heightSegments:r,depthSegments:s};const o=this;i=Math.floor(i),r=Math.floor(r),s=Math.floor(s);const a=[],l=[],c=[],u=[];let h=0,d=0;function p(e,t,n,i,r,s,p,f,m,g,y){const v=s/m,_=p/g,x=s/2,b=p/2,w=f/2,T=m+1,S=g+1;let M=0,E=0;const A=new Dc;for(let s=0;s<S;s++){const o=s*_-b;for(let a=0;a<T;a++){const h=a*v-x;A[e]=h*i,A[t]=o*r,A[n]=w,l.push(A.x,A.y,A.z),A[e]=0,A[t]=0,A[n]=f>0?1:-1,c.push(A.x,A.y,A.z),u.push(a/m),u.push(1-s/g),M+=1}}for(let e=0;e<g;e++)for(let t=0;t<m;t++){const n=h+t+T*e,i=h+t+T*(e+1),r=h+(t+1)+T*(e+1),s=h+(t+1)+T*e;a.push(n,i,s),a.push(i,r,s),E+=6}o.addGroup(d,E,y),d+=E,h+=M}p("z","y","x",-1,-1,n,t,e,s,r,0),p("z","y","x",1,-1,n,t,-e,s,r,1),p("x","z","y",1,1,e,n,t,i,s,2),p("x","z","y",1,-1,e,n,-t,i,s,3),p("x","y","z",1,-1,e,t,n,i,r,4),p("x","y","z",-1,-1,e,t,-n,i,r,5),this.setIndex(a),this.setAttribute("position",new Gh(l,3)),this.setAttribute("normal",new Gh(c,3)),this.setAttribute("uv",new Gh(u,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ud(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function hd(e){const t={};for(const n in e){t[n]={};for(const i in e[n]){const r=e[n][i];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?r.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),t[n][i]=null):t[n][i]=r.clone():Array.isArray(r)?t[n][i]=r.slice():t[n][i]=r}}return t}function dd(e){const t={};for(let n=0;n<e.length;n++){const i=hd(e[n]);for(const e in i)t[e]=i[e]}return t}function pd(e){const t=e.getRenderTarget();return null===t?e.outputColorSpace:!0===t.isXRRenderTarget?t.texture.colorSpace:Wc.workingColorSpace}const fd={clone:hd,merge:dd};class md extends Rh{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=hd(e.uniforms),this.uniformsGroups=function(e){const t=[];for(let n=0;n<e.length;n++)t.push(e[n].clone());return t}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const n in this.uniforms){const i=this.uniforms[n].value;i&&i.isTexture?t.uniforms[n]={type:"t",value:i.toJSON(e).uuid}:i&&i.isColor?t.uniforms[n]={type:"c",value:i.getHex()}:i&&i.isVector2?t.uniforms[n]={type:"v2",value:i.toArray()}:i&&i.isVector3?t.uniforms[n]={type:"v3",value:i.toArray()}:i&&i.isVector4?t.uniforms[n]={type:"v4",value:i.toArray()}:i&&i.isMatrix3?t.uniforms[n]={type:"m3",value:i.toArray()}:i&&i.isMatrix4?t.uniforms[n]={type:"m4",value:i.toArray()}:t.uniforms[n]={value:i}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const n={};for(const e in this.extensions)!0===this.extensions[e]&&(n[e]=!0);return Object.keys(n).length>0&&(t.extensions=n),t}}class gd extends ah{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Iu,this.projectionMatrix=new Iu,this.projectionMatrixInverse=new Iu,this.coordinateSystem=gc}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const yd=new Dc,vd=new Nc,_d=new Nc;class xd extends gd{constructor(e=50,t=1,n=.1,i=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=n,this.far=i,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*wc*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*bc*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*wc*Math.atan(Math.tan(.5*bc*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,n){yd.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(yd.x,yd.y).multiplyScalar(-e/yd.z),yd.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),n.set(yd.x,yd.y).multiplyScalar(-e/yd.z)}getViewSize(e,t){return this.getViewBounds(e,vd,_d),t.subVectors(_d,vd)}setViewOffset(e,t,n,i,r,s){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=i,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*bc*this.fov)/this.zoom,n=2*t,i=this.aspect*n,r=-.5*i;const s=this.view;if(null!==this.view&&this.view.enabled){const e=s.fullWidth,o=s.fullHeight;r+=s.offsetX*i/e,t-=s.offsetY*n/o,i*=s.width/e,n*=s.height/o}const o=this.filmOffset;0!==o&&(r+=e*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+i,t,t-n,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const bd=-90;class wd extends ah{constructor(e,t,n){super(),this.type="CubeCamera",this.renderTarget=n,this.coordinateSystem=null,this.activeMipmapLevel=0;const i=new xd(bd,1,e,t);i.layers=this.layers,this.add(i);const r=new xd(bd,1,e,t);r.layers=this.layers,this.add(r);const s=new xd(bd,1,e,t);s.layers=this.layers,this.add(s);const o=new xd(bd,1,e,t);o.layers=this.layers,this.add(o);const a=new xd(bd,1,e,t);a.layers=this.layers,this.add(a);const l=new xd(bd,1,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[n,i,r,s,o,a]=t;for(const e of t)this.remove(e);if(e===gc)n.up.set(0,1,0),n.lookAt(1,0,0),i.up.set(0,1,0),i.lookAt(-1,0,0),r.up.set(0,0,-1),r.lookAt(0,1,0),s.up.set(0,0,1),s.lookAt(0,-1,0),o.up.set(0,1,0),o.lookAt(0,0,1),a.up.set(0,1,0),a.lookAt(0,0,-1);else{if(e!==yc)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);n.up.set(0,-1,0),n.lookAt(-1,0,0),i.up.set(0,-1,0),i.lookAt(1,0,0),r.up.set(0,0,1),r.lookAt(0,1,0),s.up.set(0,0,-1),s.lookAt(0,-1,0),o.up.set(0,-1,0),o.lookAt(0,0,1),a.up.set(0,-1,0),a.lookAt(0,0,-1)}for(const e of t)this.add(e),e.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();const{renderTarget:n,activeMipmapLevel:i}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[r,s,o,a,l,c]=this.children,u=e.getRenderTarget(),h=e.getActiveCubeFace(),d=e.getActiveMipmapLevel(),p=e.xr.enabled;e.xr.enabled=!1;const f=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,e.setRenderTarget(n,0,i),e.render(t,r),e.setRenderTarget(n,1,i),e.render(t,s),e.setRenderTarget(n,2,i),e.render(t,o),e.setRenderTarget(n,3,i),e.render(t,a),e.setRenderTarget(n,4,i),e.render(t,l),n.texture.generateMipmaps=f,e.setRenderTarget(n,5,i),e.render(t,c),e.setRenderTarget(u,h,d),e.xr.enabled=p,n.texture.needsPMREMUpdate=!0}}class Td extends tu{constructor(e=[],t=301,n,i,r,s,o,a,l,c){super(e,t,n,i,r,s,o,a,l,c),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class Sd extends ru{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const n={width:e,height:e,depth:1},i=[n,n,n,n,n,n];this.texture=new Td(i),this._setTextureOptions(t),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const n={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},i=new ud(5,5,5),r=new md({name:"CubemapFromEquirect",uniforms:hd(n.uniforms),vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,side:1,blending:0});r.uniforms.tEquirect.value=t;const s=new ld(i,r),o=t.minFilter;t.minFilter===Ja&&(t.minFilter=Ka);return new wd(1,10,this).update(e,s),t.minFilter=o,s.geometry.dispose(),s.material.dispose(),this}clear(e,t=!0,n=!0,i=!0){const r=e.getRenderTarget();for(let r=0;r<6;r++)e.setRenderTarget(this,r),e.clear(t,n,i);e.setRenderTarget(r)}}let Md=class extends ah{constructor(){super(),this.isGroup=!0,this.type="Group"}};const Ed={type:"move"};class Ad{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new Md,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new Md,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new Dc,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new Dc),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new Md,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new Dc,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new Dc),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const n of e.hand.values())this._getHandJoint(t,n)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,n){let i=null,r=null,s=null;const o=this._targetRay,a=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){s=!0;for(const i of e.hand.values()){const e=t.getJointPose(i,n),r=this._getHandJoint(l,i);null!==e&&(r.matrix.fromArray(e.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale),r.matrixWorldNeedsUpdate=!0,r.jointRadius=e.radius),r.visible=null!==e}const i=l.joints["index-finger-tip"],r=l.joints["thumb-tip"],o=i.position.distanceTo(r.position),a=.02,c=.005;l.inputState.pinching&&o>a+c?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&o<=a-c&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==a&&e.gripSpace&&(r=t.getPose(e.gripSpace,n),null!==r&&(a.matrix.fromArray(r.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,r.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(r.linearVelocity)):a.hasLinearVelocity=!1,r.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(r.angularVelocity)):a.hasAngularVelocity=!1));null!==o&&(i=t.getPose(e.targetRaySpace,n),null===i&&null!==r&&(i=r),null!==i&&(o.matrix.fromArray(i.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,i.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(i.linearVelocity)):o.hasLinearVelocity=!1,i.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(i.angularVelocity)):o.hasAngularVelocity=!1,this.dispatchEvent(Ed)))}return null!==o&&(o.visible=null!==i),null!==a&&(a.visible=null!==r),null!==l&&(l.visible=null!==s),this}_getHandJoint(e,t){if(void 0===e.joints[t.jointName]){const n=new Md;n.matrixAutoUpdate=!1,n.visible=!1,e.joints[t.jointName]=n,e.add(n)}return e.joints[t.jointName]}}class Cd extends ah{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new Hu,this.environmentIntensity=1,this.environmentRotation=new Hu,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}}class Rd{constructor(e,t){this.isInterleavedBuffer=!0,this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.usage=pc,this.updateRanges=[],this.version=0,this.uuid=Tc()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,n){e*=this.stride,n*=t.stride;for(let i=0,r=this.stride;i<r;i++)this.array[e+i]=t.array[n+i];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Tc()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),n=new this.constructor(t,this.stride);return n.setUsage(this.usage),n}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Tc()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const Nd=new Dc;class Pd{constructor(e,t,n,i=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=t,this.offset=n,this.normalized=i}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,n=this.data.count;t<n;t++)Nd.fromBufferAttribute(this,t),Nd.applyMatrix4(e),this.setXYZ(t,Nd.x,Nd.y,Nd.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)Nd.fromBufferAttribute(this,t),Nd.applyNormalMatrix(e),this.setXYZ(t,Nd.x,Nd.y,Nd.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)Nd.fromBufferAttribute(this,t),Nd.transformDirection(e),this.setXYZ(t,Nd.x,Nd.y,Nd.z);return this}getComponent(e,t){let n=this.array[e*this.data.stride+this.offset+t];return this.normalized&&(n=Ac(n,this.array)),n}setComponent(e,t,n){return this.normalized&&(n=Cc(n,this.array)),this.data.array[e*this.data.stride+this.offset+t]=n,this}setX(e,t){return this.normalized&&(t=Cc(t,this.array)),this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.normalized&&(t=Cc(t,this.array)),this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.normalized&&(t=Cc(t,this.array)),this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.normalized&&(t=Cc(t,this.array)),this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){let t=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(t=Ac(t,this.array)),t}getY(e){let t=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(t=Ac(t,this.array)),t}getZ(e){let t=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(t=Ac(t,this.array)),t}getW(e){let t=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(t=Ac(t,this.array)),t}setXY(e,t,n){return e=e*this.data.stride+this.offset,this.normalized&&(t=Cc(t,this.array),n=Cc(n,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this}setXYZ(e,t,n,i){return e=e*this.data.stride+this.offset,this.normalized&&(t=Cc(t,this.array),n=Cc(n,this.array),i=Cc(i,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=i,this}setXYZW(e,t,n,i,r){return e=e*this.data.stride+this.offset,this.normalized&&(t=Cc(t,this.array),n=Cc(n,this.array),i=Cc(i,this.array),r=Cc(r,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=i,this.data.array[e+3]=r,this}clone(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const n=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[n+t])}return new Fh(new this.array.constructor(e),this.itemSize,this.normalized)}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new Pd(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const n=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[n+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class Dd extends Rh{constructor(e){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new Eh(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}class Ld extends tu{constructor(e=null,t=1,n=1,i,r,s,o,a,l=1003,c=1003,u,h){super(null,s,o,a,l,c,i,r,u,h),this.isDataTexture=!0,this.image={data:e,width:t,height:n},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Id extends Fh{constructor(e,t,n,i=1){super(e,t,n),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=i}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}const kd=new Dc,Od=new Dc,Ud=new kc;class Fd{constructor(e=new Dc(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,n,i){return this.normal.set(e,t,n),this.constant=i,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,n){const i=kd.subVectors(n,t).cross(Od.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(i,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const n=e.delta(kd),i=this.normal.dot(n);if(0===i)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const r=-(e.start.dot(this.normal)+this.constant)/i;return r<0||r>1?null:t.copy(e.start).addScaledVector(n,r)}intersectsLine(e){const t=this.distanceToPoint(e.start),n=this.distanceToPoint(e.end);return t<0&&n>0||n<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const n=t||Ud.getNormalMatrix(e),i=this.coplanarPoint(kd).applyMatrix4(e),r=this.normal.applyMatrix3(n).normalize();return this.constant=-i.dot(r),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const Bd=new Mu,zd=new Dc;class Vd{constructor(e=new Fd,t=new Fd,n=new Fd,i=new Fd,r=new Fd,s=new Fd){this.planes=[e,t,n,i,r,s]}set(e,t,n,i,r,s){const o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(n),o[3].copy(i),o[4].copy(r),o[5].copy(s),this}copy(e){const t=this.planes;for(let n=0;n<6;n++)t[n].copy(e.planes[n]);return this}setFromProjectionMatrix(e,t=2e3){const n=this.planes,i=e.elements,r=i[0],s=i[1],o=i[2],a=i[3],l=i[4],c=i[5],u=i[6],h=i[7],d=i[8],p=i[9],f=i[10],m=i[11],g=i[12],y=i[13],v=i[14],_=i[15];if(n[0].setComponents(a-r,h-l,m-d,_-g).normalize(),n[1].setComponents(a+r,h+l,m+d,_+g).normalize(),n[2].setComponents(a+s,h+c,m+p,_+y).normalize(),n[3].setComponents(a-s,h-c,m-p,_-y).normalize(),n[4].setComponents(a-o,h-u,m-f,_-v).normalize(),t===gc)n[5].setComponents(a+o,h+u,m+f,_+v).normalize();else{if(t!==yc)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);n[5].setComponents(o,u,f,v).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),Bd.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),Bd.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(Bd)}intersectsSprite(e){return Bd.center.set(0,0,0),Bd.radius=.7071067811865476,Bd.applyMatrix4(e.matrixWorld),this.intersectsSphere(Bd)}intersectsSphere(e){const t=this.planes,n=e.center,i=-e.radius;for(let e=0;e<6;e++){if(t[e].distanceToPoint(n)<i)return!1}return!0}intersectsBox(e){const t=this.planes;for(let n=0;n<6;n++){const i=t[n];if(zd.x=i.normal.x>0?e.max.x:e.min.x,zd.y=i.normal.y>0?e.max.y:e.min.y,zd.z=i.normal.z>0?e.max.z:e.min.z,i.distanceToPoint(zd)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let n=0;n<6;n++)if(t[n].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}const Gd=new Iu,jd=new Vd;class Hd{constructor(){this.coordinateSystem=gc}intersectsObject(e,t){if(!t.isArrayCamera||0===t.cameras.length)return!1;for(let n=0;n<t.cameras.length;n++){const i=t.cameras[n];if(Gd.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),jd.setFromProjectionMatrix(Gd,this.coordinateSystem),jd.intersectsObject(e))return!0}return!1}intersectsSprite(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let n=0;n<t.cameras.length;n++){const i=t.cameras[n];if(Gd.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),jd.setFromProjectionMatrix(Gd,this.coordinateSystem),jd.intersectsSprite(e))return!0}return!1}intersectsSphere(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let n=0;n<t.cameras.length;n++){const i=t.cameras[n];if(Gd.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),jd.setFromProjectionMatrix(Gd,this.coordinateSystem),jd.intersectsSphere(e))return!0}return!1}intersectsBox(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let n=0;n<t.cameras.length;n++){const i=t.cameras[n];if(Gd.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),jd.setFromProjectionMatrix(Gd,this.coordinateSystem),jd.intersectsBox(e))return!0}return!1}containsPoint(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let n=0;n<t.cameras.length;n++){const i=t.cameras[n];if(Gd.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),jd.setFromProjectionMatrix(Gd,this.coordinateSystem),jd.containsPoint(e))return!0}return!1}clone(){return new Hd}}class Wd extends Rh{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Eh(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}const qd=new Dc,Xd=new Dc,$d=new Iu,Yd=new Lu,Kd=new Mu,Zd=new Dc,Jd=new Dc;class Qd extends ah{constructor(e=new Kh,t=new Wd){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,n=[0];for(let e=1,i=t.count;e<i;e++)qd.fromBufferAttribute(t,e-1),Xd.fromBufferAttribute(t,e),n[e]=n[e-1],n[e]+=qd.distanceTo(Xd);e.setAttribute("lineDistance",new Gh(n,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,t){const n=this.geometry,i=this.matrixWorld,r=e.params.Line.threshold,s=n.drawRange;if(null===n.boundingSphere&&n.computeBoundingSphere(),Kd.copy(n.boundingSphere),Kd.applyMatrix4(i),Kd.radius+=r,!1===e.ray.intersectsSphere(Kd))return;$d.copy(i).invert(),Yd.copy(e.ray).applyMatrix4($d);const o=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=o*o,l=this.isLineSegments?2:1,c=n.index,u=n.attributes.position;if(null!==c){const n=Math.max(0,s.start),i=Math.min(c.count,s.start+s.count);for(let r=n,s=i-1;r<s;r+=l){const n=c.getX(r),i=c.getX(r+1),s=ep(this,e,Yd,a,n,i,r);s&&t.push(s)}if(this.isLineLoop){const r=c.getX(i-1),s=c.getX(n),o=ep(this,e,Yd,a,r,s,i-1);o&&t.push(o)}}else{const n=Math.max(0,s.start),i=Math.min(u.count,s.start+s.count);for(let r=n,s=i-1;r<s;r+=l){const n=ep(this,e,Yd,a,r,r+1,r);n&&t.push(n)}if(this.isLineLoop){const r=ep(this,e,Yd,a,i-1,n,i-1);r&&t.push(r)}}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}function ep(e,t,n,i,r,s,o){const a=e.geometry.attributes.position;qd.fromBufferAttribute(a,r),Xd.fromBufferAttribute(a,s);if(n.distanceSqToSegment(qd,Xd,Zd,Jd)>i)return;Zd.applyMatrix4(e.matrixWorld);const l=t.ray.origin.distanceTo(Zd);return l<t.near||l>t.far?void 0:{distance:l,point:Jd.clone().applyMatrix4(e.matrixWorld),index:o,face:null,faceIndex:null,barycoord:null,object:e}}class tp extends Rh{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new Eh(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}class np extends tu{constructor(e,t){super({width:e,height:t}),this.isFramebufferTexture=!0,this.magFilter=Xa,this.minFilter=Xa,this.generateMipmaps=!1,this.needsUpdate=!0}}class ip extends tu{constructor(e,t,n=1014,i,r,s,o=1003,a=1003,l,c=1026,u=1){if(c!==fl&&c!==ml)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");super({width:e,height:t,depth:u},i,r,s,o,a,c,n,l),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new Zc(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}class rp extends Kh{constructor(e=1,t=1,n=1,i=32,r=1,s=!1,o=0,a=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:n,radialSegments:i,heightSegments:r,openEnded:s,thetaStart:o,thetaLength:a};const l=this;i=Math.floor(i),r=Math.floor(r);const c=[],u=[],h=[],d=[];let p=0;const f=[],m=n/2;let g=0;function y(n){const r=p,s=new Nc,f=new Dc;let y=0;const v=!0===n?e:t,_=!0===n?1:-1;for(let e=1;e<=i;e++)u.push(0,m*_,0),h.push(0,_,0),d.push(.5,.5),p++;const x=p;for(let e=0;e<=i;e++){const t=e/i*a+o,n=Math.cos(t),r=Math.sin(t);f.x=v*r,f.y=m*_,f.z=v*n,u.push(f.x,f.y,f.z),h.push(0,_,0),s.x=.5*n+.5,s.y=.5*r*_+.5,d.push(s.x,s.y),p++}for(let e=0;e<i;e++){const t=r+e,i=x+e;!0===n?c.push(i,i+1,t):c.push(i+1,i,t),y+=3}l.addGroup(g,y,!0===n?1:2),g+=y}!function(){const s=new Dc,y=new Dc;let v=0;const _=(t-e)/n;for(let l=0;l<=r;l++){const c=[],g=l/r,v=g*(t-e)+e;for(let e=0;e<=i;e++){const t=e/i,r=t*a+o,l=Math.sin(r),f=Math.cos(r);y.x=v*l,y.y=-g*n+m,y.z=v*f,u.push(y.x,y.y,y.z),s.set(l,_,f).normalize(),h.push(s.x,s.y,s.z),d.push(t,1-g),c.push(p++)}f.push(c)}for(let n=0;n<i;n++)for(let i=0;i<r;i++){const s=f[i][n],o=f[i+1][n],a=f[i+1][n+1],l=f[i][n+1];(e>0||0!==i)&&(c.push(s,o,l),v+=3),(t>0||i!==r-1)&&(c.push(o,a,l),v+=3)}l.addGroup(g,v,0),g+=v}(),!1===s&&(e>0&&y(!0),t>0&&y(!1)),this.setIndex(c),this.setAttribute("position",new Gh(u,3)),this.setAttribute("normal",new Gh(h,3)),this.setAttribute("uv",new Gh(d,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new rp(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class sp extends rp{constructor(e=1,t=1,n=32,i=1,r=!1,s=0,o=2*Math.PI){super(0,e,t,n,i,r,s,o),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:n,heightSegments:i,openEnded:r,thetaStart:s,thetaLength:o}}static fromJSON(e){return new sp(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class op{constructor(){this.type="Curve",this.arcLengthDivisions=200,this.needsUpdate=!1,this.cacheArcLengths=null}getPoint(){console.warn("THREE.Curve: .getPoint() not implemented.")}getPointAt(e,t){const n=this.getUtoTmapping(e);return this.getPoint(n,t)}getPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return t}getSpacedPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPointAt(n/e));return t}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let n,i=this.getPoint(0),r=0;t.push(0);for(let s=1;s<=e;s++)n=this.getPoint(s/e),r+=n.distanceTo(i),t.push(r),i=n;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t=null){const n=this.getLengths();let i=0;const r=n.length;let s;s=t||e*n[r-1];let o,a=0,l=r-1;for(;a<=l;)if(i=Math.floor(a+(l-a)/2),o=n[i]-s,o<0)a=i+1;else{if(!(o>0)){l=i;break}l=i-1}if(i=l,n[i]===s)return i/(r-1);const c=n[i];return(i+(s-c)/(n[i+1]-c))/(r-1)}getTangent(e,t){const n=1e-4;let i=e-n,r=e+n;i<0&&(i=0),r>1&&(r=1);const s=this.getPoint(i),o=this.getPoint(r),a=t||(s.isVector2?new Nc:new Dc);return a.copy(o).sub(s).normalize(),a}getTangentAt(e,t){const n=this.getUtoTmapping(e);return this.getTangent(n,t)}computeFrenetFrames(e,t=!1){const n=new Dc,i=[],r=[],s=[],o=new Dc,a=new Iu;for(let t=0;t<=e;t++){const n=t/e;i[t]=this.getTangentAt(n,new Dc)}r[0]=new Dc,s[0]=new Dc;let l=Number.MAX_VALUE;const c=Math.abs(i[0].x),u=Math.abs(i[0].y),h=Math.abs(i[0].z);c<=l&&(l=c,n.set(1,0,0)),u<=l&&(l=u,n.set(0,1,0)),h<=l&&n.set(0,0,1),o.crossVectors(i[0],n).normalize(),r[0].crossVectors(i[0],o),s[0].crossVectors(i[0],r[0]);for(let t=1;t<=e;t++){if(r[t]=r[t-1].clone(),s[t]=s[t-1].clone(),o.crossVectors(i[t-1],i[t]),o.length()>Number.EPSILON){o.normalize();const e=Math.acos(Sc(i[t-1].dot(i[t]),-1,1));r[t].applyMatrix4(a.makeRotationAxis(o,e))}s[t].crossVectors(i[t],r[t])}if(!0===t){let t=Math.acos(Sc(r[0].dot(r[e]),-1,1));t/=e,i[0].dot(o.crossVectors(r[0],r[e]))>0&&(t=-t);for(let n=1;n<=e;n++)r[n].applyMatrix4(a.makeRotationAxis(i[n],t*n)),s[n].crossVectors(i[n],r[n])}return{tangents:i,normals:r,binormals:s}}clone(){return(new this.constructor).copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.7,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class ap extends op{constructor(e=0,t=0,n=1,i=1,r=0,s=2*Math.PI,o=!1,a=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=i,this.aStartAngle=r,this.aEndAngle=s,this.aClockwise=o,this.aRotation=a}getPoint(e,t=new Nc){const n=t,i=2*Math.PI;let r=this.aEndAngle-this.aStartAngle;const s=Math.abs(r)<Number.EPSILON;for(;r<0;)r+=i;for(;r>i;)r-=i;r<Number.EPSILON&&(r=s?0:i),!0!==this.aClockwise||s||(r===i?r=-i:r-=i);const o=this.aStartAngle+e*r;let a=this.aX+this.xRadius*Math.cos(o),l=this.aY+this.yRadius*Math.sin(o);if(0!==this.aRotation){const e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),n=a-this.aX,i=l-this.aY;a=n*e-i*t+this.aX,l=n*t+i*e+this.aY}return n.set(a,l)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}function lp(){let e=0,t=0,n=0,i=0;function r(r,s,o,a){e=r,t=o,n=-3*r+3*s-2*o-a,i=2*r-2*s+o+a}return{initCatmullRom:function(e,t,n,i,s){r(t,n,s*(n-e),s*(i-t))},initNonuniformCatmullRom:function(e,t,n,i,s,o,a){let l=(t-e)/s-(n-e)/(s+o)+(n-t)/o,c=(n-t)/o-(i-t)/(o+a)+(i-n)/a;l*=o,c*=o,r(t,n,l,c)},calc:function(r){const s=r*r;return e+t*r+n*s+i*(s*r)}}}const cp=new Dc,up=new lp,hp=new lp,dp=new lp;function pp(e,t,n,i,r){const s=.5*(i-t),o=.5*(r-n),a=e*e;return(2*n-2*i+s+o)*(e*a)+(-3*n+3*i-2*s-o)*a+s*e+n}function fp(e,t,n,i){return function(e,t){const n=1-e;return n*n*t}(e,t)+function(e,t){return 2*(1-e)*e*t}(e,n)+function(e,t){return e*e*t}(e,i)}function mp(e,t,n,i,r){return function(e,t){const n=1-e;return n*n*n*t}(e,t)+function(e,t){const n=1-e;return 3*n*n*e*t}(e,n)+function(e,t){return 3*(1-e)*e*e*t}(e,i)+function(e,t){return e*e*e*t}(e,r)}class gp extends op{constructor(e=new Dc,t=new Dc,n=new Dc,i=new Dc){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=n,this.v3=i}getPoint(e,t=new Dc){const n=t,i=this.v0,r=this.v1,s=this.v2,o=this.v3;return n.set(mp(e,i.x,r.x,s.x,o.x),mp(e,i.y,r.y,s.y,o.y),mp(e,i.z,r.z,s.z,o.z)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class yp extends op{constructor(e=new Dc,t=new Dc,n=new Dc){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=n}getPoint(e,t=new Dc){const n=t,i=this.v0,r=this.v1,s=this.v2;return n.set(fp(e,i.x,r.x,s.x),fp(e,i.y,r.y,s.y),fp(e,i.z,r.z,s.z)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}var vp=Object.freeze({__proto__:null,ArcCurve:class extends ap{constructor(e,t,n,i,r,s){super(e,t,n,n,i,r,s),this.isArcCurve=!0,this.type="ArcCurve"}},CatmullRomCurve3:class extends op{constructor(e=[],t=!1,n="centripetal",i=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=n,this.tension=i}getPoint(e,t=new Dc){const n=t,i=this.points,r=i.length,s=(r-(this.closed?0:1))*e;let o,a,l=Math.floor(s),c=s-l;this.closed?l+=l>0?0:(Math.floor(Math.abs(l)/r)+1)*r:0===c&&l===r-1&&(l=r-2,c=1),this.closed||l>0?o=i[(l-1)%r]:(cp.subVectors(i[0],i[1]).add(i[0]),o=cp);const u=i[l%r],h=i[(l+1)%r];if(this.closed||l+2<r?a=i[(l+2)%r]:(cp.subVectors(i[r-1],i[r-2]).add(i[r-1]),a=cp),"centripetal"===this.curveType||"chordal"===this.curveType){const e="chordal"===this.curveType?.5:.25;let t=Math.pow(o.distanceToSquared(u),e),n=Math.pow(u.distanceToSquared(h),e),i=Math.pow(h.distanceToSquared(a),e);n<1e-4&&(n=1),t<1e-4&&(t=n),i<1e-4&&(i=n),up.initNonuniformCatmullRom(o.x,u.x,h.x,a.x,t,n,i),hp.initNonuniformCatmullRom(o.y,u.y,h.y,a.y,t,n,i),dp.initNonuniformCatmullRom(o.z,u.z,h.z,a.z,t,n,i)}else"catmullrom"===this.curveType&&(up.initCatmullRom(o.x,u.x,h.x,a.x,this.tension),hp.initCatmullRom(o.y,u.y,h.y,a.y,this.tension),dp.initCatmullRom(o.z,u.z,h.z,a.z,this.tension));return n.set(up.calc(c),hp.calc(c),dp.calc(c)),n}copy(e){super.copy(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const n=e.points[t];this.points.push(n.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,n=this.points.length;t<n;t++){const n=this.points[t];e.points.push(n.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const n=e.points[t];this.points.push((new Dc).fromArray(n))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}},CubicBezierCurve:class extends op{constructor(e=new Nc,t=new Nc,n=new Nc,i=new Nc){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=n,this.v3=i}getPoint(e,t=new Nc){const n=t,i=this.v0,r=this.v1,s=this.v2,o=this.v3;return n.set(mp(e,i.x,r.x,s.x,o.x),mp(e,i.y,r.y,s.y,o.y)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}},CubicBezierCurve3:gp,EllipseCurve:ap,LineCurve:class extends op{constructor(e=new Nc,t=new Nc){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new Nc){const n=t;return 1===e?n.copy(this.v2):(n.copy(this.v2).sub(this.v1),n.multiplyScalar(e).add(this.v1)),n}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new Nc){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}},LineCurve3:class extends op{constructor(e=new Dc,t=new Dc){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=e,this.v2=t}getPoint(e,t=new Dc){const n=t;return 1===e?n.copy(this.v2):(n.copy(this.v2).sub(this.v1),n.multiplyScalar(e).add(this.v1)),n}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new Dc){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}},QuadraticBezierCurve:class extends op{constructor(e=new Nc,t=new Nc,n=new Nc){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=n}getPoint(e,t=new Nc){const n=t,i=this.v0,r=this.v1,s=this.v2;return n.set(fp(e,i.x,r.x,s.x),fp(e,i.y,r.y,s.y)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}},QuadraticBezierCurve3:yp,SplineCurve:class extends op{constructor(e=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=e}getPoint(e,t=new Nc){const n=t,i=this.points,r=(i.length-1)*e,s=Math.floor(r),o=r-s,a=i[0===s?s:s-1],l=i[s],c=i[s>i.length-2?i.length-1:s+1],u=i[s>i.length-3?i.length-1:s+2];return n.set(pp(o,a.x,l.x,c.x,u.x),pp(o,a.y,l.y,c.y,u.y)),n}copy(e){super.copy(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const n=e.points[t];this.points.push(n.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,n=this.points.length;t<n;t++){const n=this.points[t];e.points.push(n.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const n=e.points[t];this.points.push((new Nc).fromArray(n))}return this}}});class _p extends Kh{constructor(e=1,t=1,n=1,i=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:n,heightSegments:i};const r=e/2,s=t/2,o=Math.floor(n),a=Math.floor(i),l=o+1,c=a+1,u=e/o,h=t/a,d=[],p=[],f=[],m=[];for(let e=0;e<c;e++){const t=e*h-s;for(let n=0;n<l;n++){const i=n*u-r;p.push(i,-t,0),f.push(0,0,1),m.push(n/o),m.push(1-e/a)}}for(let e=0;e<a;e++)for(let t=0;t<o;t++){const n=t+l*e,i=t+l*(e+1),r=t+1+l*(e+1),s=t+1+l*e;d.push(n,i,s),d.push(i,r,s)}this.setIndex(d),this.setAttribute("position",new Gh(p,3)),this.setAttribute("normal",new Gh(f,3)),this.setAttribute("uv",new Gh(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new _p(e.width,e.height,e.widthSegments,e.heightSegments)}}class xp extends Kh{constructor(e=1,t=32,n=16,i=0,r=2*Math.PI,s=0,o=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:n,phiStart:i,phiLength:r,thetaStart:s,thetaLength:o},t=Math.max(3,Math.floor(t)),n=Math.max(2,Math.floor(n));const a=Math.min(s+o,Math.PI);let l=0;const c=[],u=new Dc,h=new Dc,d=[],p=[],f=[],m=[];for(let d=0;d<=n;d++){const g=[],y=d/n;let v=0;0===d&&0===s?v=.5/t:d===n&&a===Math.PI&&(v=-.5/t);for(let n=0;n<=t;n++){const a=n/t;u.x=-e*Math.cos(i+a*r)*Math.sin(s+y*o),u.y=e*Math.cos(s+y*o),u.z=e*Math.sin(i+a*r)*Math.sin(s+y*o),p.push(u.x,u.y,u.z),h.copy(u).normalize(),f.push(h.x,h.y,h.z),m.push(a+v,1-y),g.push(l++)}c.push(g)}for(let e=0;e<n;e++)for(let i=0;i<t;i++){const t=c[e][i+1],r=c[e][i],o=c[e+1][i],l=c[e+1][i+1];(0!==e||s>0)&&d.push(t,r,l),(e!==n-1||a<Math.PI)&&d.push(r,o,l)}this.setIndex(d),this.setAttribute("position",new Gh(p,3)),this.setAttribute("normal",new Gh(f,3)),this.setAttribute("uv",new Gh(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new xp(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class bp extends Kh{constructor(e=new yp(new Dc(-1,-1,0),new Dc(-1,1,0),new Dc(1,1,0)),t=64,n=1,i=8,r=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:n,radialSegments:i,closed:r};const s=e.computeFrenetFrames(t,r);this.tangents=s.tangents,this.normals=s.normals,this.binormals=s.binormals;const o=new Dc,a=new Dc,l=new Nc;let c=new Dc;const u=[],h=[],d=[],p=[];function f(r){c=e.getPointAt(r/t,c);const l=s.normals[r],d=s.binormals[r];for(let e=0;e<=i;e++){const t=e/i*Math.PI*2,r=Math.sin(t),s=-Math.cos(t);a.x=s*l.x+r*d.x,a.y=s*l.y+r*d.y,a.z=s*l.z+r*d.z,a.normalize(),h.push(a.x,a.y,a.z),o.x=c.x+n*a.x,o.y=c.y+n*a.y,o.z=c.z+n*a.z,u.push(o.x,o.y,o.z)}}!function(){for(let e=0;e<t;e++)f(e);f(!1===r?t:0),function(){for(let e=0;e<=t;e++)for(let n=0;n<=i;n++)l.x=e/t,l.y=n/i,d.push(l.x,l.y)}(),function(){for(let e=1;e<=t;e++)for(let t=1;t<=i;t++){const n=(i+1)*(e-1)+(t-1),r=(i+1)*e+(t-1),s=(i+1)*e+t,o=(i+1)*(e-1)+t;p.push(n,r,o),p.push(r,s,o)}}()}(),this.setIndex(p),this.setAttribute("position",new Gh(u,3)),this.setAttribute("normal",new Gh(h,3)),this.setAttribute("uv",new Gh(d,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return e.path=this.parameters.path.toJSON(),e}static fromJSON(e){return new bp((new vp[e.path.type]).fromJSON(e.path),e.tubularSegments,e.radius,e.radialSegments,e.closed)}}class wp extends Rh{constructor(e){super(),this.isShadowMaterial=!0,this.type="ShadowMaterial",this.color=new Eh(0),this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.fog=e.fog,this}}class Tp extends Rh{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new Eh(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Eh(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Nc(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Hu,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class Sp extends Tp{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new Nc(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return Sc(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new Eh(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new Eh(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new Eh(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._dispersion=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get dispersion(){return this._dispersion}set dispersion(e){this._dispersion>0!=e>0&&this.version++,this._dispersion=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.dispersion=e.dispersion,this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}class Mp extends Rh{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new Eh(16777215),this.specular=new Eh(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Eh(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Nc(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Hu,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class Ep extends Rh{constructor(e){super(),this.isMeshToonMaterial=!0,this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new Eh(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Eh(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Nc(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}class Ap extends Rh{constructor(e){super(),this.isMeshNormalMaterial=!0,this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Nc(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this}}class Cp extends Rh{constructor(e){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new Eh(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Eh(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Nc(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Hu,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class Rp extends Rh{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class Np extends Rh{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}class Pp extends Rh{constructor(e){super(),this.isMeshMatcapMaterial=!0,this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new Eh(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Nc(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:""},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.flatShading=e.flatShading,this.fog=e.fog,this}}class Dp extends Wd{constructor(e){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}}const Lp={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};class Ip{constructor(e,t,n){const i=this;let r,s=!1,o=0,a=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=n,this.itemStart=function(e){a++,!1===s&&void 0!==i.onStart&&i.onStart(e,o,a),s=!0},this.itemEnd=function(e){o++,void 0!==i.onProgress&&i.onProgress(e,o,a),o===a&&(s=!1,void 0!==i.onLoad&&i.onLoad())},this.itemError=function(e){void 0!==i.onError&&i.onError(e)},this.resolveURL=function(e){return r?r(e):e},this.setURLModifier=function(e){return r=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,n=l.length;t<n;t+=2){const n=l[t],i=l[t+1];if(n.global&&(n.lastIndex=0),n.test(e))return i}return null}}}const kp=new Ip;class Op{constructor(e){this.manager=void 0!==e?e:kp,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const n=this;return new Promise((function(i,r){n.load(e,i,t,r)}))}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}Op.DEFAULT_MATERIAL_NAME="__DEFAULT";class Up extends Op{constructor(e){super(e)}load(e,t,n,i){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,s=Lp.get(e);if(void 0!==s)return r.manager.itemStart(e),setTimeout((function(){t&&t(s),r.manager.itemEnd(e)}),0),s;const o=Fc("img");function a(){c(),Lp.add(e,this),t&&t(this),r.manager.itemEnd(e)}function l(t){c(),i&&i(t),r.manager.itemError(e),r.manager.itemEnd(e)}function c(){o.removeEventListener("load",a,!1),o.removeEventListener("error",l,!1)}return o.addEventListener("load",a,!1),o.addEventListener("error",l,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(o.crossOrigin=this.crossOrigin),r.manager.itemStart(e),o.src=e,o}}class Fp extends ah{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new Eh(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),void 0!==this.target&&(t.object.target=this.target.uuid),t}}class Bp extends Fp{constructor(e,t,n){super(e,n),this.isHemisphereLight=!0,this.type="HemisphereLight",this.position.copy(ah.DEFAULT_UP),this.updateMatrix(),this.groundColor=new Eh(t)}copy(e,t){return super.copy(e,t),this.groundColor.copy(e.groundColor),this}}const zp=new Iu,Vp=new Dc,Gp=new Dc;class jp{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new Nc(512,512),this.mapType=Qa,this.map=null,this.mapPass=null,this.matrix=new Iu,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Vd,this._frameExtents=new Nc(1,1),this._viewportCount=1,this._viewports=[new nu(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,n=this.matrix;Vp.setFromMatrixPosition(e.matrixWorld),t.position.copy(Vp),Gp.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(Gp),t.updateMatrixWorld(),zp.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(zp),n.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),n.multiply(zp)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.autoUpdate=e.autoUpdate,this.needsUpdate=e.needsUpdate,this.normalBias=e.normalBias,this.blurSamples=e.blurSamples,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class Hp extends jp{constructor(){super(new xd(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1,this.aspect=1}updateMatrices(e){const t=this.camera,n=2*wc*e.angle*this.focus,i=this.mapSize.width/this.mapSize.height*this.aspect,r=e.distance||t.far;n===t.fov&&i===t.aspect&&r===t.far||(t.fov=n,t.aspect=i,t.far=r,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class Wp extends Fp{constructor(e,t,n=0,i=Math.PI/3,r=0,s=2){super(e,t),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(ah.DEFAULT_UP),this.updateMatrix(),this.target=new ah,this.distance=n,this.angle=i,this.penumbra=r,this.decay=s,this.map=null,this.shadow=new Hp}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}const qp=new Iu,Xp=new Dc,$p=new Dc;class Yp extends jp{constructor(){super(new xd(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new Nc(4,2),this._viewportCount=6,this._viewports=[new nu(2,1,1,1),new nu(0,1,1,1),new nu(3,1,1,1),new nu(1,1,1,1),new nu(3,0,1,1),new nu(1,0,1,1)],this._cubeDirections=[new Dc(1,0,0),new Dc(-1,0,0),new Dc(0,0,1),new Dc(0,0,-1),new Dc(0,1,0),new Dc(0,-1,0)],this._cubeUps=[new Dc(0,1,0),new Dc(0,1,0),new Dc(0,1,0),new Dc(0,1,0),new Dc(0,0,1),new Dc(0,0,-1)]}updateMatrices(e,t=0){const n=this.camera,i=this.matrix,r=e.distance||n.far;r!==n.far&&(n.far=r,n.updateProjectionMatrix()),Xp.setFromMatrixPosition(e.matrixWorld),n.position.copy(Xp),$p.copy(n.position),$p.add(this._cubeDirections[t]),n.up.copy(this._cubeUps[t]),n.lookAt($p),n.updateMatrixWorld(),i.makeTranslation(-Xp.x,-Xp.y,-Xp.z),qp.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),this._frustum.setFromProjectionMatrix(qp)}}class Kp extends Fp{constructor(e,t,n=0,i=2){super(e,t),this.isPointLight=!0,this.type="PointLight",this.distance=n,this.decay=i,this.shadow=new Yp}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}class Zp extends gd{constructor(e=-1,t=1,n=1,i=-1,r=.1,s=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=n,this.bottom=i,this.near=r,this.far=s,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,n,i,r,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=i,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let r=n-e,s=n+e,o=i+t,a=i-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=e*this.view.offsetX,s=r+e*this.view.width,o-=t*this.view.offsetY,a=o-t*this.view.height}this.projectionMatrix.makeOrthographic(r,s,o,a,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}class Jp extends jp{constructor(){super(new Zp(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class Qp extends Fp{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(ah.DEFAULT_UP),this.updateMatrix(),this.target=new ah,this.shadow=new Jp}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class ef extends Fp{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}class tf extends Fp{constructor(e,t,n=10,i=10){super(e,t),this.isRectAreaLight=!0,this.type="RectAreaLight",this.width=n,this.height=i}get power(){return this.intensity*this.width*this.height*Math.PI}set power(e){this.intensity=e/(this.width*this.height*Math.PI)}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){const t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}}class nf{constructor(){this.isSphericalHarmonics3=!0,this.coefficients=[];for(let e=0;e<9;e++)this.coefficients.push(new Dc)}set(e){for(let t=0;t<9;t++)this.coefficients[t].copy(e[t]);return this}zero(){for(let e=0;e<9;e++)this.coefficients[e].set(0,0,0);return this}getAt(e,t){const n=e.x,i=e.y,r=e.z,s=this.coefficients;return t.copy(s[0]).multiplyScalar(.282095),t.addScaledVector(s[1],.488603*i),t.addScaledVector(s[2],.488603*r),t.addScaledVector(s[3],.488603*n),t.addScaledVector(s[4],n*i*1.092548),t.addScaledVector(s[5],i*r*1.092548),t.addScaledVector(s[6],.315392*(3*r*r-1)),t.addScaledVector(s[7],n*r*1.092548),t.addScaledVector(s[8],.546274*(n*n-i*i)),t}getIrradianceAt(e,t){const n=e.x,i=e.y,r=e.z,s=this.coefficients;return t.copy(s[0]).multiplyScalar(.886227),t.addScaledVector(s[1],1.023328*i),t.addScaledVector(s[2],1.023328*r),t.addScaledVector(s[3],1.023328*n),t.addScaledVector(s[4],.858086*n*i),t.addScaledVector(s[5],.858086*i*r),t.addScaledVector(s[6],.743125*r*r-.247708),t.addScaledVector(s[7],.858086*n*r),t.addScaledVector(s[8],.429043*(n*n-i*i)),t}add(e){for(let t=0;t<9;t++)this.coefficients[t].add(e.coefficients[t]);return this}addScaledSH(e,t){for(let n=0;n<9;n++)this.coefficients[n].addScaledVector(e.coefficients[n],t);return this}scale(e){for(let t=0;t<9;t++)this.coefficients[t].multiplyScalar(e);return this}lerp(e,t){for(let n=0;n<9;n++)this.coefficients[n].lerp(e.coefficients[n],t);return this}equals(e){for(let t=0;t<9;t++)if(!this.coefficients[t].equals(e.coefficients[t]))return!1;return!0}copy(e){return this.set(e.coefficients)}clone(){return(new this.constructor).copy(this)}fromArray(e,t=0){const n=this.coefficients;for(let i=0;i<9;i++)n[i].fromArray(e,t+3*i);return this}toArray(e=[],t=0){const n=this.coefficients;for(let i=0;i<9;i++)n[i].toArray(e,t+3*i);return e}static getBasisAt(e,t){const n=e.x,i=e.y,r=e.z;t[0]=.282095,t[1]=.488603*i,t[2]=.488603*r,t[3]=.488603*n,t[4]=1.092548*n*i,t[5]=1.092548*i*r,t[6]=.315392*(3*r*r-1),t[7]=1.092548*n*r,t[8]=.546274*(n*n-i*i)}}class rf extends Fp{constructor(e=new nf,t=1){super(void 0,t),this.isLightProbe=!0,this.sh=e}copy(e){return super.copy(e),this.sh.copy(e.sh),this}fromJSON(e){return this.intensity=e.intensity,this.sh.fromArray(e.sh),this}toJSON(e){const t=super.toJSON(e);return t.object.sh=this.sh.toArray(),t}}class sf extends xd{constructor(e=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=e}}class of{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=af(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=af();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}function af(){return performance.now()}class lf extends Rd{constructor(e,t,n=1){super(e,t),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=n}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}clone(e){const t=super.clone(e);return t.meshPerAttribute=this.meshPerAttribute,t}toJSON(e){const t=super.toJSON(e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}}const cf=new Iu;class uf{constructor(e,t,n=0,i=1/0){this.ray=new Lu(e,t),this.near=n,this.far=i,this.camera=null,this.layers=new Wu,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)}setFromXRController(e){return cf.identity().extractRotation(e.matrixWorld),this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(0,0,-1).applyMatrix4(cf),this}intersectObject(e,t=!0,n=[]){return df(e,this,n,t),n.sort(hf),n}intersectObjects(e,t=!0,n=[]){for(let i=0,r=e.length;i<r;i++)df(e[i],this,n,t);return n.sort(hf),n}}function hf(e,t){return e.distance-t.distance}function df(e,t,n,i){let r=!0;if(e.layers.test(t.layers)){!1===e.raycast(t,n)&&(r=!1)}if(!0===r&&!0===i){const i=e.children;for(let e=0,r=i.length;e<r;e++)df(i[e],t,n,!0)}}class pf{constructor(e=1,t=0,n=0){this.radius=e,this.phi=t,this.theta=n}set(e,t,n){return this.radius=e,this.phi=t,this.theta=n,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){const e=1e-6;return this.phi=Sc(this.phi,e,Math.PI-e),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,n){return this.radius=Math.sqrt(e*e+t*t+n*n),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,n),this.phi=Math.acos(Sc(t/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}class ff{constructor(e,t,n,i){ff.prototype.isMatrix2=!0,this.elements=[1,0,0,1],void 0!==e&&this.set(e,t,n,i)}identity(){return this.set(1,0,0,1),this}fromArray(e,t=0){for(let n=0;n<4;n++)this.elements[n]=e[n+t];return this}set(e,t,n,i){const r=this.elements;return r[0]=e,r[2]=t,r[1]=n,r[3]=i,this}}class mf extends vc{constructor(e,t=null){super(),this.object=e,this.domElement=t,this.enabled=!0,this.state=-1,this.keys={},this.mouseButtons={LEFT:null,MIDDLE:null,RIGHT:null},this.touches={ONE:null,TWO:null}}connect(e){void 0!==e?(null!==this.domElement&&this.disconnect(),this.domElement=e):console.warn("THREE.Controls: connect() now requires an element.")}disconnect(){}dispose(){}update(){}}function gf(e,t,n,i){const r=function(e){switch(e){case Qa:case el:return{byteLength:1,components:1};case nl:case tl:case ol:return{byteLength:2,components:1};case al:case ll:return{byteLength:2,components:4};case rl:case il:case sl:return{byteLength:4,components:1};case ul:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${e}.`)}(i);switch(n){case hl:return e*t;case gl:case yl:return e*t/r.components*r.byteLength;case vl:case _l:return e*t*2/r.components*r.byteLength;case dl:return e*t*3/r.components*r.byteLength;case pl:case xl:return e*t*4/r.components*r.byteLength;case bl:case wl:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case Tl:case Sl:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case El:case Cl:return Math.max(e,16)*Math.max(t,8)/4;case Ml:case Al:return Math.max(e,8)*Math.max(t,8)/2;case Rl:case Nl:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case Pl:case Dl:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case Ll:return Math.floor((e+4)/5)*Math.floor((t+3)/4)*16;case Il:return Math.floor((e+4)/5)*Math.floor((t+4)/5)*16;case kl:return Math.floor((e+5)/6)*Math.floor((t+4)/5)*16;case Ol:return Math.floor((e+5)/6)*Math.floor((t+5)/6)*16;case Ul:return Math.floor((e+7)/8)*Math.floor((t+4)/5)*16;case Fl:return Math.floor((e+7)/8)*Math.floor((t+5)/6)*16;case Bl:return Math.floor((e+7)/8)*Math.floor((t+7)/8)*16;case zl:return Math.floor((e+9)/10)*Math.floor((t+4)/5)*16;case Vl:return Math.floor((e+9)/10)*Math.floor((t+5)/6)*16;case Gl:return Math.floor((e+9)/10)*Math.floor((t+7)/8)*16;case jl:return Math.floor((e+9)/10)*Math.floor((t+9)/10)*16;case Hl:return Math.floor((e+11)/12)*Math.floor((t+9)/10)*16;case Wl:return Math.floor((e+11)/12)*Math.floor((t+11)/12)*16;case ql:case Xl:case $l:return Math.ceil(e/4)*Math.ceil(t/4)*16;case Yl:case Kl:return Math.ceil(e/4)*Math.ceil(t/4)*8;case Zl:case Jl:return Math.ceil(e/4)*Math.ceil(t/4)*16}throw new Error(`Unable to determine texture byte length for ${n} format.`)}function yf(){let e=null,t=!1,n=null,i=null;function r(t,s){n(t,s),i=e.requestAnimationFrame(r)}return{start:function(){!0!==t&&null!==n&&(i=e.requestAnimationFrame(r),t=!0)},stop:function(){e.cancelAnimationFrame(i),t=!1},setAnimationLoop:function(e){n=e},setContext:function(t){e=t}}}function vf(e){const t=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),t.get(e)},remove:function(n){n.isInterleavedBufferAttribute&&(n=n.data);const i=t.get(n);i&&(e.deleteBuffer(i.buffer),t.delete(n))},update:function(n,i){if(n.isInterleavedBufferAttribute&&(n=n.data),n.isGLBufferAttribute){const e=t.get(n);return void((!e||e.version<n.version)&&t.set(n,{buffer:n.buffer,type:n.type,bytesPerElement:n.elementSize,version:n.version}))}const r=t.get(n);if(void 0===r)t.set(n,function(t,n){const i=t.array,r=t.usage,s=i.byteLength,o=e.createBuffer();let a;if(e.bindBuffer(n,o),e.bufferData(n,i,r),t.onUploadCallback(),i instanceof Float32Array)a=e.FLOAT;else if(i instanceof Uint16Array)a=t.isFloat16BufferAttribute?e.HALF_FLOAT:e.UNSIGNED_SHORT;else if(i instanceof Int16Array)a=e.SHORT;else if(i instanceof Uint32Array)a=e.UNSIGNED_INT;else if(i instanceof Int32Array)a=e.INT;else if(i instanceof Int8Array)a=e.BYTE;else if(i instanceof Uint8Array)a=e.UNSIGNED_BYTE;else{if(!(i instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+i);a=e.UNSIGNED_BYTE}return{buffer:o,type:a,bytesPerElement:i.BYTES_PER_ELEMENT,version:t.version,size:s}}(n,i));else if(r.version<n.version){if(r.size!==n.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(t,n,i){const r=n.array,s=n.updateRanges;if(e.bindBuffer(i,t),0===s.length)e.bufferSubData(i,0,r);else{s.sort(((e,t)=>e.start-t.start));let t=0;for(let e=1;e<s.length;e++){const n=s[t],i=s[e];i.start<=n.start+n.count+1?n.count=Math.max(n.count,i.start+i.count-n.start):(++t,s[t]=i)}s.length=t+1;for(let t=0,n=s.length;t<n;t++){const n=s[t];e.bufferSubData(i,n.start*r.BYTES_PER_ELEMENT,r,n.start,n.count)}n.clearUpdateRanges()}n.onUploadCallback()}(r.buffer,n,i),r.version=n.version}}}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:na}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=na);const _f={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\t#ifdef ALPHA_TO_COVERAGE\n\tdiffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );\n\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\tif ( diffuseColor.a < alphaTest ) discard;\n\t#endif\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",batching_pars_vertex:"#ifdef USE_BATCHING\n\t#if ! defined( GL_ANGLE_multi_draw )\n\t#define gl_DrawID _gl_DrawID\n\tuniform int _gl_DrawID;\n\t#endif\n\tuniform highp sampler2D batchingTexture;\n\tuniform highp usampler2D batchingIdTexture;\n\tmat4 getBatchingMatrix( const in float i ) {\n\t\tint size = textureSize( batchingTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n\tfloat getIndirectIndex( const in int i ) {\n\t\tint size = textureSize( batchingIdTexture, 0 ).x;\n\t\tint x = i % size;\n\t\tint y = i / size;\n\t\treturn float( texelFetch( batchingIdTexture, ivec2( x, y ), 0 ).r );\n\t}\n#endif\n#ifdef USE_BATCHING_COLOR\n\tuniform sampler2D batchingColorTexture;\n\tvec3 getBatchingColor( const in float i ) {\n\t\tint size = textureSize( batchingColorTexture, 0 ).x;\n\t\tint j = int( i );\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\treturn texelFetch( batchingColorTexture, ivec2( x, y ), 0 ).rgb;\n\t}\n#endif",batching_vertex:"#ifdef USE_BATCHING\n\tmat4 batchingMatrix = getBatchingMatrix( getIndirectIndex( gl_DrawID ) );\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#ifdef ALPHA_TO_COVERAGE\n\t\tfloat distanceToPlane, distanceGradient;\n\t\tfloat clipOpacity = 1.0;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\tclipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\tif ( clipOpacity == 0.0 ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tfloat unionClipOpacity = 1.0;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\t\tunionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tclipOpacity *= 1.0 - unionClipOpacity;\n\t\t#endif\n\t\tdiffuseColor.a *= clipOpacity;\n\t\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tbool clipped = true;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tif ( clipped ) discard;\n\t\t#endif\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif\n#ifdef USE_BATCHING_COLOR\n\tvec3 batchingColor = getBatchingColor( getIndirectIndex( gl_DrawID ) );\n\tvColor.xyz *= batchingColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = objectTangent;\n#endif\n#ifdef USE_BATCHING\n\tmat3 bm = mat3( batchingMatrix );\n\ttransformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );\n\ttransformedNormal = bm * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = bm * transformedTangent;\n\t#endif\n#endif\n#ifdef USE_INSTANCING\n\tmat3 im = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );\n\ttransformedNormal = im * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = im * transformedTangent;\n\t#endif\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\ttransformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE_EMISSIVE\n\t\temissiveColor = sRGBTransferEOTF( emissiveColor );\n\t#endif\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"vec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferEOTF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, envMapRotation * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform mat3 envMapRotation;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif ( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_DISPERSION\n\tmaterial.dispersion = dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tif( material.anisotropy == 0.0 ) {\n\t\tanisotropyV = vec2( 1.0, 0.0 );\n\t} else {\n\t\tanisotropyV /= material.anisotropy;\n\t\tmaterial.anisotropy = saturate( material.anisotropy );\n\t}\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\tfloat dispersion;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tgl_FragDepth = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvFragDepth = 1.0 + gl_Position.w;\n\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = sRGBTransferEOTF( sampledDiffuseColor );\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphinstance_vertex:"#ifdef USE_INSTANCING_MORPH\n\tfloat morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\tfloat morphTargetBaseInfluence = texelFetch( morphTexture, ivec2( 0, gl_InstanceID ), 0 ).r;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tmorphTargetInfluences[i] =  texelFetch( morphTexture, ivec2( i + 1, gl_InstanceID ), 0 ).r;\n\t}\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_INSTANCING_MORPH\n\t\tuniform float morphTargetBaseInfluence;\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t#endif\n\tuniform sampler2DArray morphTargetsTexture;\n\tuniform ivec2 morphTargetsTextureSize;\n\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t}\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;const float ShiftRight8 = 1. / 256.;\nconst float Inv255 = 1. / 255.;\nconst vec4 PackFactors = vec4( 1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0 );\nconst vec2 UnpackFactors2 = vec2( UnpackDownscale, 1.0 / PackFactors.g );\nconst vec3 UnpackFactors3 = vec3( UnpackDownscale / PackFactors.rg, 1.0 / PackFactors.b );\nconst vec4 UnpackFactors4 = vec4( UnpackDownscale / PackFactors.rgb, 1.0 / PackFactors.a );\nvec4 packDepthToRGBA( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec4( 0., 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec4( 1., 1., 1., 1. );\n\tfloat vuf;\n\tfloat af = modf( v * PackFactors.a, vuf );\n\tfloat bf = modf( vuf * ShiftRight8, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec4( vuf * Inv255, gf * PackUpscale, bf * PackUpscale, af );\n}\nvec3 packDepthToRGB( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec3( 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec3( 1., 1., 1. );\n\tfloat vuf;\n\tfloat bf = modf( v * PackFactors.b, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec3( vuf * Inv255, gf * PackUpscale, bf );\n}\nvec2 packDepthToRG( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec2( 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec2( 1., 1. );\n\tfloat vuf;\n\tfloat gf = modf( v * 256., vuf );\n\treturn vec2( vuf * Inv255, gf );\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors4 );\n}\nfloat unpackRGBToDepth( const in vec3 v ) {\n\treturn dot( v, UnpackFactors3 );\n}\nfloat unpackRGToDepth( const in vec2 v ) {\n\treturn v.r * UnpackFactors2.r + v.g * UnpackFactors2.g;\n}\nvec4 pack2HalfToRGBA( const in vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( const in vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_BATCHING\n\tmvPosition = batchingMatrix * mvPosition;\n#endif\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tfloat shadow = 1.0;\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\t\n\t\tfloat lightToPositionLength = length( lightToPosition );\n\t\tif ( lightToPositionLength - shadowCameraFar <= 0.0 && lightToPositionLength - shadowCameraNear >= 0.0 ) {\n\t\t\tfloat dp = ( lightToPositionLength - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\t\tdp += shadowBias;\n\t\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\t\tshadow = (\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t\t) * ( 1.0 / 9.0 );\n\t\t\t#else\n\t\t\t\tshadow = texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowIntensity, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowIntensity, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowIntensity, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tint size = textureSize( boneTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 CineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nconst mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.6605, - 0.1246, - 0.0182 ),\n\tvec3( - 0.5876, 1.1329, - 0.1006 ),\n\tvec3( - 0.0728, - 0.0083, 1.1187 )\n);\nconst mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(\n\tvec3( 0.6274, 0.0691, 0.0164 ),\n\tvec3( 0.3293, 0.9195, 0.0880 ),\n\tvec3( 0.0433, 0.0113, 0.8956 )\n);\nvec3 agxDefaultContrastApprox( vec3 x ) {\n\tvec3 x2 = x * x;\n\tvec3 x4 = x2 * x2;\n\treturn + 15.5 * x4 * x2\n\t\t- 40.14 * x4 * x\n\t\t+ 31.96 * x4\n\t\t- 6.868 * x2 * x\n\t\t+ 0.4298 * x2\n\t\t+ 0.1191 * x\n\t\t- 0.00232;\n}\nvec3 AgXToneMapping( vec3 color ) {\n\tconst mat3 AgXInsetMatrix = mat3(\n\t\tvec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),\n\t\tvec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),\n\t\tvec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )\n\t);\n\tconst mat3 AgXOutsetMatrix = mat3(\n\t\tvec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),\n\t\tvec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),\n\t\tvec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )\n\t);\n\tconst float AgxMinEv = - 12.47393;\tconst float AgxMaxEv = 4.026069;\n\tcolor *= toneMappingExposure;\n\tcolor = LINEAR_SRGB_TO_LINEAR_REC2020 * color;\n\tcolor = AgXInsetMatrix * color;\n\tcolor = max( color, 1e-10 );\tcolor = log2( color );\n\tcolor = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );\n\tcolor = clamp( color, 0.0, 1.0 );\n\tcolor = agxDefaultContrastApprox( color );\n\tcolor = AgXOutsetMatrix * color;\n\tcolor = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );\n\tcolor = LINEAR_REC2020_TO_LINEAR_SRGB * color;\n\tcolor = clamp( color, 0.0, 1.0 );\n\treturn color;\n}\nvec3 NeutralToneMapping( vec3 color ) {\n\tconst float StartCompression = 0.8 - 0.04;\n\tconst float Desaturation = 0.15;\n\tcolor *= toneMappingExposure;\n\tfloat x = min( color.r, min( color.g, color.b ) );\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max( color.r, max( color.g, color.b ) );\n\tif ( peak < StartCompression ) return color;\n\tfloat d = 1. - StartCompression;\n\tfloat newPeak = 1. - d * d / ( peak + d - StartCompression );\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / ( Desaturation * ( peak - newPeak ) + 1. );\n\treturn mix( color, vec3( newPeak ), g );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.dispersion, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float dispersion, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec4 transmittedLight;\n\t\tvec3 transmittance;\n\t\t#ifdef USE_DISPERSION\n\t\t\tfloat halfSpread = ( ior - 1.0 ) * 0.025 * dispersion;\n\t\t\tvec3 iors = vec3( ior - halfSpread, ior, ior + halfSpread );\n\t\t\tfor ( int i = 0; i < 3; i ++ ) {\n\t\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, iors[ i ], modelMatrix );\n\t\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\t\trefractionCoords += 1.0;\n\t\t\t\trefractionCoords /= 2.0;\n\t\t\t\tvec4 transmissionSample = getTransmissionSample( refractionCoords, roughness, iors[ i ] );\n\t\t\t\ttransmittedLight[ i ] = transmissionSample[ i ];\n\t\t\t\ttransmittedLight.a += transmissionSample.a;\n\t\t\t\ttransmittance[ i ] = diffuseColor[ i ] * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance )[ i ];\n\t\t\t}\n\t\t\ttransmittedLight.a /= 3.0;\n\t\t#else\n\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\trefractionCoords += 1.0;\n\t\t\trefractionCoords /= 2.0;\n\t\t\ttransmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\t\ttransmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\t#endif\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_BATCHING\n\t\tworldPosition = batchingMatrix * worldPosition;\n\t#endif\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nuniform mat3 backgroundRotation;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#elif DEPTH_PACKING == 3202\n\t\tgl_FragColor = vec4( packDepthToRGB( fragCoordZ ), 1.0 );\n\t#elif DEPTH_PACKING == 3203\n\t\tgl_FragColor = vec4( packDepthToRG( fragCoordZ ), 0.0, 1.0 );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), diffuseColor.a );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_DISPERSION\n\tuniform float dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix[ 3 ];\n\tvec2 scale = vec2( length( modelMatrix[ 0 ].xyz ), length( modelMatrix[ 1 ].xyz ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},xf={common:{diffuse:{value:new Eh(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new kc},alphaMap:{value:null},alphaMapTransform:{value:new kc},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new kc}},envmap:{envMap:{value:null},envMapRotation:{value:new kc},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new kc}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new kc}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new kc},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new kc},normalScale:{value:new Nc(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new kc},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new kc}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new kc}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new kc}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Eh(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Eh(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new kc},alphaTest:{value:0},uvTransform:{value:new kc}},sprite:{diffuse:{value:new Eh(16777215)},opacity:{value:1},center:{value:new Nc(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new kc},alphaMap:{value:null},alphaMapTransform:{value:new kc},alphaTest:{value:0}}},bf={basic:{uniforms:dd([xf.common,xf.specularmap,xf.envmap,xf.aomap,xf.lightmap,xf.fog]),vertexShader:_f.meshbasic_vert,fragmentShader:_f.meshbasic_frag},lambert:{uniforms:dd([xf.common,xf.specularmap,xf.envmap,xf.aomap,xf.lightmap,xf.emissivemap,xf.bumpmap,xf.normalmap,xf.displacementmap,xf.fog,xf.lights,{emissive:{value:new Eh(0)}}]),vertexShader:_f.meshlambert_vert,fragmentShader:_f.meshlambert_frag},phong:{uniforms:dd([xf.common,xf.specularmap,xf.envmap,xf.aomap,xf.lightmap,xf.emissivemap,xf.bumpmap,xf.normalmap,xf.displacementmap,xf.fog,xf.lights,{emissive:{value:new Eh(0)},specular:{value:new Eh(1118481)},shininess:{value:30}}]),vertexShader:_f.meshphong_vert,fragmentShader:_f.meshphong_frag},standard:{uniforms:dd([xf.common,xf.envmap,xf.aomap,xf.lightmap,xf.emissivemap,xf.bumpmap,xf.normalmap,xf.displacementmap,xf.roughnessmap,xf.metalnessmap,xf.fog,xf.lights,{emissive:{value:new Eh(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:_f.meshphysical_vert,fragmentShader:_f.meshphysical_frag},toon:{uniforms:dd([xf.common,xf.aomap,xf.lightmap,xf.emissivemap,xf.bumpmap,xf.normalmap,xf.displacementmap,xf.gradientmap,xf.fog,xf.lights,{emissive:{value:new Eh(0)}}]),vertexShader:_f.meshtoon_vert,fragmentShader:_f.meshtoon_frag},matcap:{uniforms:dd([xf.common,xf.bumpmap,xf.normalmap,xf.displacementmap,xf.fog,{matcap:{value:null}}]),vertexShader:_f.meshmatcap_vert,fragmentShader:_f.meshmatcap_frag},points:{uniforms:dd([xf.points,xf.fog]),vertexShader:_f.points_vert,fragmentShader:_f.points_frag},dashed:{uniforms:dd([xf.common,xf.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:_f.linedashed_vert,fragmentShader:_f.linedashed_frag},depth:{uniforms:dd([xf.common,xf.displacementmap]),vertexShader:_f.depth_vert,fragmentShader:_f.depth_frag},normal:{uniforms:dd([xf.common,xf.bumpmap,xf.normalmap,xf.displacementmap,{opacity:{value:1}}]),vertexShader:_f.meshnormal_vert,fragmentShader:_f.meshnormal_frag},sprite:{uniforms:dd([xf.sprite,xf.fog]),vertexShader:_f.sprite_vert,fragmentShader:_f.sprite_frag},background:{uniforms:{uvTransform:{value:new kc},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:_f.background_vert,fragmentShader:_f.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new kc}},vertexShader:_f.backgroundCube_vert,fragmentShader:_f.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:_f.cube_vert,fragmentShader:_f.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:_f.equirect_vert,fragmentShader:_f.equirect_frag},distanceRGBA:{uniforms:dd([xf.common,xf.displacementmap,{referencePosition:{value:new Dc},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:_f.distanceRGBA_vert,fragmentShader:_f.distanceRGBA_frag},shadow:{uniforms:dd([xf.lights,xf.fog,{color:{value:new Eh(0)},opacity:{value:1}}]),vertexShader:_f.shadow_vert,fragmentShader:_f.shadow_frag}};bf.physical={uniforms:dd([bf.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new kc},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new kc},clearcoatNormalScale:{value:new Nc(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new kc},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new kc},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new kc},sheen:{value:0},sheenColor:{value:new Eh(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new kc},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new kc},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new kc},transmissionSamplerSize:{value:new Nc},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new kc},attenuationDistance:{value:0},attenuationColor:{value:new Eh(0)},specularColor:{value:new Eh(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new kc},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new kc},anisotropyVector:{value:new Nc},anisotropyMap:{value:null},anisotropyMapTransform:{value:new kc}}]),vertexShader:_f.meshphysical_vert,fragmentShader:_f.meshphysical_frag};const wf={r:0,b:0,g:0},Tf=new Hu,Sf=new Iu;function Mf(e,t,n,i,r,s,o){const a=new Eh(0);let l,c,u=!0===s?0:1,h=null,d=0,p=null;function f(e){let i=!0===e.isScene?e.background:null;if(i&&i.isTexture){i=(e.backgroundBlurriness>0?n:t).get(i)}return i}function m(t,n){t.getRGB(wf,pd(e)),i.buffers.color.setClear(wf.r,wf.g,wf.b,n,o)}return{getClearColor:function(){return a},setClearColor:function(e,t=1){a.set(e),u=t,m(a,u)},getClearAlpha:function(){return u},setClearAlpha:function(e){u=e,m(a,u)},render:function(t){let n=!1;const r=f(t);null===r?m(a,u):r&&r.isColor&&(m(r,1),n=!0);const s=e.xr.getEnvironmentBlendMode();"additive"===s?i.buffers.color.setClear(0,0,0,1,o):"alpha-blend"===s&&i.buffers.color.setClear(0,0,0,0,o),(e.autoClear||n)&&(i.buffers.depth.setTest(!0),i.buffers.depth.setMask(!0),i.buffers.color.setMask(!0),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil))},addToRenderList:function(t,n){const i=f(n);i&&(i.isCubeTexture||i.mapping===ja)?(void 0===c&&(c=new ld(new ud(1,1,1),new md({name:"BackgroundCubeMaterial",uniforms:hd(bf.backgroundCube.uniforms),vertexShader:bf.backgroundCube.vertexShader,fragmentShader:bf.backgroundCube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),c.geometry.deleteAttribute("normal"),c.geometry.deleteAttribute("uv"),c.onBeforeRender=function(e,t,n){this.matrixWorld.copyPosition(n.matrixWorld)},Object.defineProperty(c.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),r.update(c)),Tf.copy(n.backgroundRotation),Tf.x*=-1,Tf.y*=-1,Tf.z*=-1,i.isCubeTexture&&!1===i.isRenderTargetTexture&&(Tf.y*=-1,Tf.z*=-1),c.material.uniforms.envMap.value=i,c.material.uniforms.flipEnvMap.value=i.isCubeTexture&&!1===i.isRenderTargetTexture?-1:1,c.material.uniforms.backgroundBlurriness.value=n.backgroundBlurriness,c.material.uniforms.backgroundIntensity.value=n.backgroundIntensity,c.material.uniforms.backgroundRotation.value.setFromMatrix4(Sf.makeRotationFromEuler(Tf)),c.material.toneMapped=Wc.getTransfer(i.colorSpace)!==ic,h===i&&d===i.version&&p===e.toneMapping||(c.material.needsUpdate=!0,h=i,d=i.version,p=e.toneMapping),c.layers.enableAll(),t.unshift(c,c.geometry,c.material,0,0,null)):i&&i.isTexture&&(void 0===l&&(l=new ld(new _p(2,2),new md({name:"BackgroundMaterial",uniforms:hd(bf.background.uniforms),vertexShader:bf.background.vertexShader,fragmentShader:bf.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),r.update(l)),l.material.uniforms.t2D.value=i,l.material.uniforms.backgroundIntensity.value=n.backgroundIntensity,l.material.toneMapped=Wc.getTransfer(i.colorSpace)!==ic,!0===i.matrixAutoUpdate&&i.updateMatrix(),l.material.uniforms.uvTransform.value.copy(i.matrix),h===i&&d===i.version&&p===e.toneMapping||(l.material.needsUpdate=!0,h=i,d=i.version,p=e.toneMapping),l.layers.enableAll(),t.unshift(l,l.geometry,l.material,0,0,null))},dispose:function(){void 0!==c&&(c.geometry.dispose(),c.material.dispose(),c=void 0),void 0!==l&&(l.geometry.dispose(),l.material.dispose(),l=void 0)}}}function Ef(e,t){const n=e.getParameter(e.MAX_VERTEX_ATTRIBS),i={},r=c(null);let s=r,o=!1;function a(t){return e.bindVertexArray(t)}function l(t){return e.deleteVertexArray(t)}function c(e){const t=[],i=[],r=[];for(let e=0;e<n;e++)t[e]=0,i[e]=0,r[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:i,attributeDivisors:r,object:e,attributes:{},index:null}}function u(){const e=s.newAttributes;for(let t=0,n=e.length;t<n;t++)e[t]=0}function h(e){d(e,0)}function d(t,n){const i=s.newAttributes,r=s.enabledAttributes,o=s.attributeDivisors;i[t]=1,0===r[t]&&(e.enableVertexAttribArray(t),r[t]=1),o[t]!==n&&(e.vertexAttribDivisor(t,n),o[t]=n)}function p(){const t=s.newAttributes,n=s.enabledAttributes;for(let i=0,r=n.length;i<r;i++)n[i]!==t[i]&&(e.disableVertexAttribArray(i),n[i]=0)}function f(t,n,i,r,s,o,a){!0===a?e.vertexAttribIPointer(t,n,i,s,o):e.vertexAttribPointer(t,n,i,r,s,o)}function m(){g(),o=!0,s!==r&&(s=r,a(s.object))}function g(){r.geometry=null,r.program=null,r.wireframe=!1}return{setup:function(n,r,l,m,g){let y=!1;const v=function(t,n,r){const s=!0===r.wireframe;let o=i[t.id];void 0===o&&(o={},i[t.id]=o);let a=o[n.id];void 0===a&&(a={},o[n.id]=a);let l=a[s];void 0===l&&(l=c(e.createVertexArray()),a[s]=l);return l}(m,l,r);s!==v&&(s=v,a(s.object)),y=function(e,t,n,i){const r=s.attributes,o=t.attributes;let a=0;const l=n.getAttributes();for(const t in l){if(l[t].location>=0){const n=r[t];let i=o[t];if(void 0===i&&("instanceMatrix"===t&&e.instanceMatrix&&(i=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(i=e.instanceColor)),void 0===n)return!0;if(n.attribute!==i)return!0;if(i&&n.data!==i.data)return!0;a++}}return s.attributesNum!==a||s.index!==i}(n,m,l,g),y&&function(e,t,n,i){const r={},o=t.attributes;let a=0;const l=n.getAttributes();for(const t in l){if(l[t].location>=0){let n=o[t];void 0===n&&("instanceMatrix"===t&&e.instanceMatrix&&(n=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(n=e.instanceColor));const i={};i.attribute=n,n&&n.data&&(i.data=n.data),r[t]=i,a++}}s.attributes=r,s.attributesNum=a,s.index=i}(n,m,l,g),null!==g&&t.update(g,e.ELEMENT_ARRAY_BUFFER),(y||o)&&(o=!1,function(n,i,r,s){u();const o=s.attributes,a=r.getAttributes(),l=i.defaultAttributeValues;for(const i in a){const r=a[i];if(r.location>=0){let a=o[i];if(void 0===a&&("instanceMatrix"===i&&n.instanceMatrix&&(a=n.instanceMatrix),"instanceColor"===i&&n.instanceColor&&(a=n.instanceColor)),void 0!==a){const i=a.normalized,o=a.itemSize,l=t.get(a);if(void 0===l)continue;const c=l.buffer,u=l.type,p=l.bytesPerElement,m=u===e.INT||u===e.UNSIGNED_INT||a.gpuType===il;if(a.isInterleavedBufferAttribute){const t=a.data,l=t.stride,g=a.offset;if(t.isInstancedInterleavedBuffer){for(let e=0;e<r.locationSize;e++)d(r.location+e,t.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===s._maxInstanceCount&&(s._maxInstanceCount=t.meshPerAttribute*t.count)}else for(let e=0;e<r.locationSize;e++)h(r.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<r.locationSize;e++)f(r.location+e,o/r.locationSize,u,i,l*p,(g+o/r.locationSize*e)*p,m)}else{if(a.isInstancedBufferAttribute){for(let e=0;e<r.locationSize;e++)d(r.location+e,a.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===s._maxInstanceCount&&(s._maxInstanceCount=a.meshPerAttribute*a.count)}else for(let e=0;e<r.locationSize;e++)h(r.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<r.locationSize;e++)f(r.location+e,o/r.locationSize,u,i,o*p,o/r.locationSize*e*p,m)}}else if(void 0!==l){const t=l[i];if(void 0!==t)switch(t.length){case 2:e.vertexAttrib2fv(r.location,t);break;case 3:e.vertexAttrib3fv(r.location,t);break;case 4:e.vertexAttrib4fv(r.location,t);break;default:e.vertexAttrib1fv(r.location,t)}}}}p()}(n,r,l,m),null!==g&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.get(g).buffer))},reset:m,resetDefaultState:g,dispose:function(){m();for(const e in i){const t=i[e];for(const e in t){const n=t[e];for(const e in n)l(n[e].object),delete n[e];delete t[e]}delete i[e]}},releaseStatesOfGeometry:function(e){if(void 0===i[e.id])return;const t=i[e.id];for(const e in t){const n=t[e];for(const e in n)l(n[e].object),delete n[e];delete t[e]}delete i[e.id]},releaseStatesOfProgram:function(e){for(const t in i){const n=i[t];if(void 0===n[e.id])continue;const r=n[e.id];for(const e in r)l(r[e].object),delete r[e];delete n[e.id]}},initAttributes:u,enableAttribute:h,disableUnusedAttributes:p}}function Af(e,t,n){let i;function r(t,r,s){0!==s&&(e.drawArraysInstanced(i,t,r,s),n.update(r,i,s))}this.setMode=function(e){i=e},this.render=function(t,r){e.drawArrays(i,t,r),n.update(r,i,1)},this.renderInstances=r,this.renderMultiDraw=function(e,r,s){if(0===s)return;t.get("WEBGL_multi_draw").multiDrawArraysWEBGL(i,e,0,r,0,s);let o=0;for(let e=0;e<s;e++)o+=r[e];n.update(o,i,1)},this.renderMultiDrawInstances=function(e,s,o,a){if(0===o)return;const l=t.get("WEBGL_multi_draw");if(null===l)for(let t=0;t<e.length;t++)r(e[t],s[t],a[t]);else{l.multiDrawArraysInstancedWEBGL(i,e,0,s,0,a,0,o);let t=0;for(let e=0;e<o;e++)t+=s[e]*a[e];n.update(t,i,1)}}}function Cf(e,t,n,i){let r;function s(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}let o=void 0!==n.precision?n.precision:"highp";const a=s(o);a!==o&&(console.warn("THREE.WebGLRenderer:",o,"not supported, using",a,"instead."),o=a);const l=!0===n.logarithmicDepthBuffer,c=!0===n.reverseDepthBuffer&&t.has("EXT_clip_control"),u=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),h=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS);return{isWebGL2:!0,getMaxAnisotropy:function(){if(void 0!==r)return r;if(!0===t.has("EXT_texture_filter_anisotropic")){const n=t.get("EXT_texture_filter_anisotropic");r=e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else r=0;return r},getMaxPrecision:s,textureFormatReadable:function(t){return t===pl||i.convert(t)===e.getParameter(e.IMPLEMENTATION_COLOR_READ_FORMAT)},textureTypeReadable:function(n){const r=n===ol&&(t.has("EXT_color_buffer_half_float")||t.has("EXT_color_buffer_float"));return!(n!==Qa&&i.convert(n)!==e.getParameter(e.IMPLEMENTATION_COLOR_READ_TYPE)&&n!==sl&&!r)},precision:o,logarithmicDepthBuffer:l,reverseDepthBuffer:c,maxTextures:u,maxVertexTextures:h,maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxCubemapSize:e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),maxAttributes:e.getParameter(e.MAX_VERTEX_ATTRIBS),maxVertexUniforms:e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),maxVaryings:e.getParameter(e.MAX_VARYING_VECTORS),maxFragmentUniforms:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),vertexTextures:h>0,maxSamples:e.getParameter(e.MAX_SAMPLES)}}function Rf(e){const t=this;let n=null,i=0,r=!1,s=!1;const o=new Fd,a=new kc,l={value:null,needsUpdate:!1};function c(e,n,i,r){const s=null!==e?e.length:0;let c=null;if(0!==s){if(c=l.value,!0!==r||null===c){const t=i+4*s,r=n.matrixWorldInverse;a.getNormalMatrix(r),(null===c||c.length<t)&&(c=new Float32Array(t));for(let t=0,n=i;t!==s;++t,n+=4)o.copy(e[t]).applyMatrix4(r,a),o.normal.toArray(c,n),c[n+3]=o.constant}l.value=c,l.needsUpdate=!0}return t.numPlanes=s,t.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t){const n=0!==e.length||t||0!==i||r;return r=t,i=e.length,n},this.beginShadows=function(){s=!0,c(null)},this.endShadows=function(){s=!1},this.setGlobalState=function(e,t){n=c(e,t,0)},this.setState=function(o,a,u){const h=o.clippingPlanes,d=o.clipIntersection,p=o.clipShadows,f=e.get(o);if(!r||null===h||0===h.length||s&&!p)s?c(null):function(){l.value!==n&&(l.value=n,l.needsUpdate=i>0);t.numPlanes=i,t.numIntersection=0}();else{const e=s?0:i,t=4*e;let r=f.clippingState||null;l.value=r,r=c(h,a,t,u);for(let e=0;e!==t;++e)r[e]=n[e];f.clippingState=r,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=e}}}function Nf(e){let t=new WeakMap;function n(e,t){return t===Va?e.mapping=Ba:t===Ga&&(e.mapping=za),e}function i(e){const n=e.target;n.removeEventListener("dispose",i);const r=t.get(n);void 0!==r&&(t.delete(n),r.dispose())}return{get:function(r){if(r&&r.isTexture){const s=r.mapping;if(s===Va||s===Ga){if(t.has(r)){return n(t.get(r).texture,r.mapping)}{const s=r.image;if(s&&s.height>0){const o=new Sd(s.height);return o.fromEquirectangularTexture(e,r),t.set(r,o),r.addEventListener("dispose",i),n(o.texture,r.mapping)}return null}}}return r},dispose:function(){t=new WeakMap}}}const Pf=[.125,.215,.35,.446,.526,.582],Df=20,Lf=new Zp,If=new Eh;let kf=null,Of=0,Uf=0,Ff=!1;const Bf=(1+Math.sqrt(5))/2,zf=1/Bf,Vf=[new Dc(-Bf,zf,0),new Dc(Bf,zf,0),new Dc(-zf,0,Bf),new Dc(zf,0,Bf),new Dc(0,Bf,-zf),new Dc(0,Bf,zf),new Dc(-1,1,-1),new Dc(1,1,-1),new Dc(-1,1,1),new Dc(1,1,1)],Gf=new Dc;let jf=class{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,n=.1,i=100,r={}){const{size:s=256,position:o=Gf}=r;kf=this._renderer.getRenderTarget(),Of=this._renderer.getActiveCubeFace(),Uf=this._renderer.getActiveMipmapLevel(),Ff=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(s);const a=this._allocateTargets();return a.depthBuffer=!0,this._sceneToCubeUV(e,n,i,a,o),t>0&&this._blur(a,0,0,t),this._applyPMREM(a),this._cleanup(a),a}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=Xf(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=qf(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(kf,Of,Uf),this._renderer.xr.enabled=Ff,e.scissorTest=!1,Wf(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===Ba||e.mapping===za?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),kf=this._renderer.getRenderTarget(),Of=this._renderer.getActiveCubeFace(),Uf=this._renderer.getActiveMipmapLevel(),Ff=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;const n=t||this._allocateTargets();return this._textureToCubeUV(e,n),this._applyPMREM(n),this._cleanup(n),n}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,n={magFilter:Ka,minFilter:Ka,generateMipmaps:!1,type:ol,format:pl,colorSpace:tc,depthBuffer:!1},i=Hf(e,t,n);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=Hf(e,t,n);const{_lodMax:i}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(e){const t=[],n=[],i=[];let r=e;const s=e-4+1+Pf.length;for(let o=0;o<s;o++){const s=Math.pow(2,r);n.push(s);let a=1/s;o>e-4?a=Pf[o-e+4-1]:0===o&&(a=0),i.push(a);const l=1/(s-2),c=-l,u=1+l,h=[c,c,u,c,u,u,c,c,u,u,c,u],d=6,p=6,f=3,m=2,g=1,y=new Float32Array(f*p*d),v=new Float32Array(m*p*d),_=new Float32Array(g*p*d);for(let e=0;e<d;e++){const t=e%3*2/3-1,n=e>2?0:-1,i=[t,n,0,t+2/3,n,0,t+2/3,n+1,0,t,n,0,t+2/3,n+1,0,t,n+1,0];y.set(i,f*p*e),v.set(h,m*p*e);const r=[e,e,e,e,e,e];_.set(r,g*p*e)}const x=new Kh;x.setAttribute("position",new Fh(y,f)),x.setAttribute("uv",new Fh(v,m)),x.setAttribute("faceIndex",new Fh(_,g)),t.push(x),r>4&&r--}return{lodPlanes:t,sizeLods:n,sigmas:i}}(i)),this._blurMaterial=function(e,t,n){const i=new Float32Array(Df),r=new Dc(0,1,0),s=new md({name:"SphericalGaussianBlur",defines:{n:Df,CUBEUV_TEXEL_WIDTH:1/t,CUBEUV_TEXEL_HEIGHT:1/n,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:i},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:r}},vertexShader:$f(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1});return s}(i,e,t)}return i}_compileMaterial(e){const t=new ld(this._lodPlanes[0],e);this._renderer.compile(t,Lf)}_sceneToCubeUV(e,t,n,i,r){const s=new xd(90,1,t,n),o=[1,-1,1,1,1,1],a=[1,1,1,-1,-1,-1],l=this._renderer,c=l.autoClear,u=l.toneMapping;l.getClearColor(If),l.toneMapping=0,l.autoClear=!1;const h=new Nh({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1}),d=new ld(new ud,h);let p=!1;const f=e.background;f?f.isColor&&(h.color.copy(f),e.background=null,p=!0):(h.color.copy(If),p=!0);for(let t=0;t<6;t++){const n=t%3;0===n?(s.up.set(0,o[t],0),s.position.set(r.x,r.y,r.z),s.lookAt(r.x+a[t],r.y,r.z)):1===n?(s.up.set(0,0,o[t]),s.position.set(r.x,r.y,r.z),s.lookAt(r.x,r.y+a[t],r.z)):(s.up.set(0,o[t],0),s.position.set(r.x,r.y,r.z),s.lookAt(r.x,r.y,r.z+a[t]));const c=this._cubeSize;Wf(i,n*c,t>2?c:0,c,c),l.setRenderTarget(i),p&&l.render(d,s),l.render(e,s)}d.geometry.dispose(),d.material.dispose(),l.toneMapping=u,l.autoClear=c,e.background=f}_textureToCubeUV(e,t){const n=this._renderer,i=e.mapping===Ba||e.mapping===za;i?(null===this._cubemapMaterial&&(this._cubemapMaterial=Xf()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=qf());const r=i?this._cubemapMaterial:this._equirectMaterial,s=new ld(this._lodPlanes[0],r);r.uniforms.envMap.value=e;const o=this._cubeSize;Wf(t,0,0,3*o,2*o),n.setRenderTarget(t),n.render(s,Lf)}_applyPMREM(e){const t=this._renderer,n=t.autoClear;t.autoClear=!1;const i=this._lodPlanes.length;for(let t=1;t<i;t++){const n=Math.sqrt(this._sigmas[t]*this._sigmas[t]-this._sigmas[t-1]*this._sigmas[t-1]),r=Vf[(i-t-1)%Vf.length];this._blur(e,t-1,t,n,r)}t.autoClear=n}_blur(e,t,n,i,r){const s=this._pingPongRenderTarget;this._halfBlur(e,s,t,n,i,"latitudinal",r),this._halfBlur(s,e,n,n,i,"longitudinal",r)}_halfBlur(e,t,n,i,r,s,o){const a=this._renderer,l=this._blurMaterial;"latitudinal"!==s&&"longitudinal"!==s&&console.error("blur direction must be either latitudinal or longitudinal!");const c=new ld(this._lodPlanes[i],l),u=l.uniforms,h=this._sizeLods[n]-1,d=isFinite(r)?Math.PI/(2*h):2*Math.PI/39,p=r/d,f=isFinite(r)?1+Math.floor(3*p):Df;f>Df&&console.warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${f} samples when the maximum is set to 20`);const m=[];let g=0;for(let e=0;e<Df;++e){const t=e/p,n=Math.exp(-t*t/2);m.push(n),0===e?g+=n:e<f&&(g+=2*n)}for(let e=0;e<m.length;e++)m[e]=m[e]/g;u.envMap.value=e.texture,u.samples.value=f,u.weights.value=m,u.latitudinal.value="latitudinal"===s,o&&(u.poleAxis.value=o);const{_lodMax:y}=this;u.dTheta.value=d,u.mipInt.value=y-n;const v=this._sizeLods[i];Wf(t,3*v*(i>y-4?i-y+4:0),4*(this._cubeSize-v),3*v,2*v),a.setRenderTarget(t),a.render(c,Lf)}};function Hf(e,t,n){const i=new ru(e,t,n);return i.texture.mapping=ja,i.texture.name="PMREM.cubeUv",i.scissorTest=!0,i}function Wf(e,t,n,i,r){e.viewport.set(t,n,i,r),e.scissor.set(t,n,i,r)}function qf(){return new md({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:$f(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function Xf(){return new md({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:$f(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function $f(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function Yf(e){let t=new WeakMap,n=null;function i(e){const n=e.target;n.removeEventListener("dispose",i);const r=t.get(n);void 0!==r&&(t.delete(n),r.dispose())}return{get:function(r){if(r&&r.isTexture){const s=r.mapping,o=s===Va||s===Ga,a=s===Ba||s===za;if(o||a){let s=t.get(r);const l=void 0!==s?s.texture.pmremVersion:0;if(r.isRenderTargetTexture&&r.pmremVersion!==l)return null===n&&(n=new jf(e)),s=o?n.fromEquirectangular(r,s):n.fromCubemap(r,s),s.texture.pmremVersion=r.pmremVersion,t.set(r,s),s.texture;if(void 0!==s)return s.texture;{const l=r.image;return o&&l&&l.height>0||a&&l&&function(e){let t=0;const n=6;for(let i=0;i<n;i++)void 0!==e[i]&&t++;return t===n}(l)?(null===n&&(n=new jf(e)),s=o?n.fromEquirectangular(r):n.fromCubemap(r),s.texture.pmremVersion=r.pmremVersion,t.set(r,s),r.addEventListener("dispose",i),s.texture):null}}}return r},dispose:function(){t=new WeakMap,null!==n&&(n.dispose(),n=null)}}}function Kf(e){const t={};function n(n){if(void 0!==t[n])return t[n];let i;switch(n){case"WEBGL_depth_texture":i=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:i=e.getExtension(n)}return t[n]=i,i}return{has:function(e){return null!==n(e)},init:function(){n("EXT_color_buffer_float"),n("WEBGL_clip_cull_distance"),n("OES_texture_float_linear"),n("EXT_color_buffer_half_float"),n("WEBGL_multisampled_render_to_texture"),n("WEBGL_render_shared_exponent")},get:function(e){const t=n(e);return null===t&&Vc("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function Zf(e,t,n,i){const r={},s=new WeakMap;function o(e){const a=e.target;null!==a.index&&t.remove(a.index);for(const e in a.attributes)t.remove(a.attributes[e]);a.removeEventListener("dispose",o),delete r[a.id];const l=s.get(a);l&&(t.remove(l),s.delete(a)),i.releaseStatesOfGeometry(a),!0===a.isInstancedBufferGeometry&&delete a._maxInstanceCount,n.memory.geometries--}function a(e){const n=[],i=e.index,r=e.attributes.position;let o=0;if(null!==i){const e=i.array;o=i.version;for(let t=0,i=e.length;t<i;t+=3){const i=e[t+0],r=e[t+1],s=e[t+2];n.push(i,r,r,s,s,i)}}else{if(void 0===r)return;{const e=r.array;o=r.version;for(let t=0,i=e.length/3-1;t<i;t+=3){const e=t+0,i=t+1,r=t+2;n.push(e,i,i,r,r,e)}}}const a=new(Uc(n)?zh:Bh)(n,1);a.version=o;const l=s.get(e);l&&t.remove(l),s.set(e,a)}return{get:function(e,t){return!0===r[t.id]||(t.addEventListener("dispose",o),r[t.id]=!0,n.memory.geometries++),t},update:function(n){const i=n.attributes;for(const n in i)t.update(i[n],e.ARRAY_BUFFER)},getWireframeAttribute:function(e){const t=s.get(e);if(t){const n=e.index;null!==n&&t.version<n.version&&a(e)}else a(e);return s.get(e)}}}function Jf(e,t,n){let i,r,s;function o(t,o,a){0!==a&&(e.drawElementsInstanced(i,o,r,t*s,a),n.update(o,i,a))}this.setMode=function(e){i=e},this.setIndex=function(e){r=e.type,s=e.bytesPerElement},this.render=function(t,o){e.drawElements(i,o,r,t*s),n.update(o,i,1)},this.renderInstances=o,this.renderMultiDraw=function(e,s,o){if(0===o)return;t.get("WEBGL_multi_draw").multiDrawElementsWEBGL(i,s,0,r,e,0,o);let a=0;for(let e=0;e<o;e++)a+=s[e];n.update(a,i,1)},this.renderMultiDrawInstances=function(e,a,l,c){if(0===l)return;const u=t.get("WEBGL_multi_draw");if(null===u)for(let t=0;t<e.length;t++)o(e[t]/s,a[t],c[t]);else{u.multiDrawElementsInstancedWEBGL(i,a,0,r,e,0,c,0,l);let t=0;for(let e=0;e<l;e++)t+=a[e]*c[e];n.update(t,i,1)}}}function Qf(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(n,i,r){switch(t.calls++,i){case e.TRIANGLES:t.triangles+=r*(n/3);break;case e.LINES:t.lines+=r*(n/2);break;case e.LINE_STRIP:t.lines+=r*(n-1);break;case e.LINE_LOOP:t.lines+=r*n;break;case e.POINTS:t.points+=r*n;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",i)}}}}function em(e,t,n){const i=new WeakMap,r=new nu;return{update:function(s,o,a){const l=s.morphTargetInfluences,c=o.morphAttributes.position||o.morphAttributes.normal||o.morphAttributes.color,u=void 0!==c?c.length:0;let h=i.get(o);if(void 0===h||h.count!==u){void 0!==h&&h.texture.dispose();const d=void 0!==o.morphAttributes.position,p=void 0!==o.morphAttributes.normal,f=void 0!==o.morphAttributes.color,m=o.morphAttributes.position||[],g=o.morphAttributes.normal||[],y=o.morphAttributes.color||[];let v=0;!0===d&&(v=1),!0===p&&(v=2),!0===f&&(v=3);let _=o.attributes.position.count*v,x=1;_>t.maxTextureSize&&(x=Math.ceil(_/t.maxTextureSize),_=t.maxTextureSize);const b=new Float32Array(_*x*4*u),w=new su(b,_,x,u);w.type=sl,w.needsUpdate=!0;const T=4*v;for(let M=0;M<u;M++){const E=m[M],A=g[M],C=y[M],R=_*x*4*M;for(let N=0;N<E.count;N++){const P=N*T;!0===d&&(r.fromBufferAttribute(E,N),b[R+P+0]=r.x,b[R+P+1]=r.y,b[R+P+2]=r.z,b[R+P+3]=0),!0===p&&(r.fromBufferAttribute(A,N),b[R+P+4]=r.x,b[R+P+5]=r.y,b[R+P+6]=r.z,b[R+P+7]=0),!0===f&&(r.fromBufferAttribute(C,N),b[R+P+8]=r.x,b[R+P+9]=r.y,b[R+P+10]=r.z,b[R+P+11]=4===C.itemSize?r.w:1)}}function S(){w.dispose(),i.delete(o),o.removeEventListener("dispose",S)}h={count:u,texture:w,size:new Nc(_,x)},i.set(o,h),o.addEventListener("dispose",S)}if(!0===s.isInstancedMesh&&null!==s.morphTexture)a.getUniforms().setValue(e,"morphTexture",s.morphTexture,n);else{let D=0;for(let I=0;I<l.length;I++)D+=l[I];const L=o.morphTargetsRelative?1:1-D;a.getUniforms().setValue(e,"morphTargetBaseInfluence",L),a.getUniforms().setValue(e,"morphTargetInfluences",l)}a.getUniforms().setValue(e,"morphTargetsTexture",h.texture,n),a.getUniforms().setValue(e,"morphTargetsTextureSize",h.size)}}}function tm(e,t,n,i){let r=new WeakMap;function s(e){const t=e.target;t.removeEventListener("dispose",s),n.remove(t.instanceMatrix),null!==t.instanceColor&&n.remove(t.instanceColor)}return{update:function(o){const a=i.render.frame,l=o.geometry,c=t.get(o,l);if(r.get(c)!==a&&(t.update(c),r.set(c,a)),o.isInstancedMesh&&(!1===o.hasEventListener("dispose",s)&&o.addEventListener("dispose",s),r.get(o)!==a&&(n.update(o.instanceMatrix,e.ARRAY_BUFFER),null!==o.instanceColor&&n.update(o.instanceColor,e.ARRAY_BUFFER),r.set(o,a))),o.isSkinnedMesh){const e=o.skeleton;r.get(e)!==a&&(e.update(),r.set(e,a))}return c},dispose:function(){r=new WeakMap}}}const nm=new tu,im=new ip(1,1),rm=new su,sm=new ou,om=new Td,am=[],lm=[],cm=new Float32Array(16),um=new Float32Array(9),hm=new Float32Array(4);function dm(e,t,n){const i=e[0];if(i<=0||i>0)return e;const r=t*n;let s=am[r];if(void 0===s&&(s=new Float32Array(r),am[r]=s),0!==t){i.toArray(s,0);for(let i=1,r=0;i!==t;++i)r+=n,e[i].toArray(s,r)}return s}function pm(e,t){if(e.length!==t.length)return!1;for(let n=0,i=e.length;n<i;n++)if(e[n]!==t[n])return!1;return!0}function fm(e,t){for(let n=0,i=t.length;n<i;n++)e[n]=t[n]}function mm(e,t){let n=lm[t];void 0===n&&(n=new Int32Array(t),lm[t]=n);for(let i=0;i!==t;++i)n[i]=e.allocateTextureUnit();return n}function gm(e,t){const n=this.cache;n[0]!==t&&(e.uniform1f(this.addr,t),n[0]=t)}function ym(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(pm(n,t))return;e.uniform2fv(this.addr,t),fm(n,t)}}function vm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else if(void 0!==t.r)n[0]===t.r&&n[1]===t.g&&n[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),n[0]=t.r,n[1]=t.g,n[2]=t.b);else{if(pm(n,t))return;e.uniform3fv(this.addr,t),fm(n,t)}}function _m(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(pm(n,t))return;e.uniform4fv(this.addr,t),fm(n,t)}}function xm(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(pm(n,t))return;e.uniformMatrix2fv(this.addr,!1,t),fm(n,t)}else{if(pm(n,i))return;hm.set(i),e.uniformMatrix2fv(this.addr,!1,hm),fm(n,i)}}function bm(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(pm(n,t))return;e.uniformMatrix3fv(this.addr,!1,t),fm(n,t)}else{if(pm(n,i))return;um.set(i),e.uniformMatrix3fv(this.addr,!1,um),fm(n,i)}}function wm(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(pm(n,t))return;e.uniformMatrix4fv(this.addr,!1,t),fm(n,t)}else{if(pm(n,i))return;cm.set(i),e.uniformMatrix4fv(this.addr,!1,cm),fm(n,i)}}function Tm(e,t){const n=this.cache;n[0]!==t&&(e.uniform1i(this.addr,t),n[0]=t)}function Sm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2i(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(pm(n,t))return;e.uniform2iv(this.addr,t),fm(n,t)}}function Mm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3i(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(pm(n,t))return;e.uniform3iv(this.addr,t),fm(n,t)}}function Em(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4i(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(pm(n,t))return;e.uniform4iv(this.addr,t),fm(n,t)}}function Am(e,t){const n=this.cache;n[0]!==t&&(e.uniform1ui(this.addr,t),n[0]=t)}function Cm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2ui(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(pm(n,t))return;e.uniform2uiv(this.addr,t),fm(n,t)}}function Rm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3ui(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(pm(n,t))return;e.uniform3uiv(this.addr,t),fm(n,t)}}function Nm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4ui(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(pm(n,t))return;e.uniform4uiv(this.addr,t),fm(n,t)}}function Pm(e,t,n){const i=this.cache,r=n.allocateTextureUnit();let s;i[0]!==r&&(e.uniform1i(this.addr,r),i[0]=r),this.type===e.SAMPLER_2D_SHADOW?(im.compareFunction=lc,s=im):s=nm,n.setTexture2D(t||s,r)}function Dm(e,t,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(e.uniform1i(this.addr,r),i[0]=r),n.setTexture3D(t||sm,r)}function Lm(e,t,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(e.uniform1i(this.addr,r),i[0]=r),n.setTextureCube(t||om,r)}function Im(e,t,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(e.uniform1i(this.addr,r),i[0]=r),n.setTexture2DArray(t||rm,r)}function km(e,t){e.uniform1fv(this.addr,t)}function Om(e,t){const n=dm(t,this.size,2);e.uniform2fv(this.addr,n)}function Um(e,t){const n=dm(t,this.size,3);e.uniform3fv(this.addr,n)}function Fm(e,t){const n=dm(t,this.size,4);e.uniform4fv(this.addr,n)}function Bm(e,t){const n=dm(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,n)}function zm(e,t){const n=dm(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,n)}function Vm(e,t){const n=dm(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,n)}function Gm(e,t){e.uniform1iv(this.addr,t)}function jm(e,t){e.uniform2iv(this.addr,t)}function Hm(e,t){e.uniform3iv(this.addr,t)}function Wm(e,t){e.uniform4iv(this.addr,t)}function qm(e,t){e.uniform1uiv(this.addr,t)}function Xm(e,t){e.uniform2uiv(this.addr,t)}function $m(e,t){e.uniform3uiv(this.addr,t)}function Ym(e,t){e.uniform4uiv(this.addr,t)}function Km(e,t,n){const i=this.cache,r=t.length,s=mm(n,r);pm(i,s)||(e.uniform1iv(this.addr,s),fm(i,s));for(let e=0;e!==r;++e)n.setTexture2D(t[e]||nm,s[e])}function Zm(e,t,n){const i=this.cache,r=t.length,s=mm(n,r);pm(i,s)||(e.uniform1iv(this.addr,s),fm(i,s));for(let e=0;e!==r;++e)n.setTexture3D(t[e]||sm,s[e])}function Jm(e,t,n){const i=this.cache,r=t.length,s=mm(n,r);pm(i,s)||(e.uniform1iv(this.addr,s),fm(i,s));for(let e=0;e!==r;++e)n.setTextureCube(t[e]||om,s[e])}function Qm(e,t,n){const i=this.cache,r=t.length,s=mm(n,r);pm(i,s)||(e.uniform1iv(this.addr,s),fm(i,s));for(let e=0;e!==r;++e)n.setTexture2DArray(t[e]||rm,s[e])}class eg{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.setValue=function(e){switch(e){case 5126:return gm;case 35664:return ym;case 35665:return vm;case 35666:return _m;case 35674:return xm;case 35675:return bm;case 35676:return wm;case 5124:case 35670:return Tm;case 35667:case 35671:return Sm;case 35668:case 35672:return Mm;case 35669:case 35673:return Em;case 5125:return Am;case 36294:return Cm;case 36295:return Rm;case 36296:return Nm;case 35678:case 36198:case 36298:case 36306:case 35682:return Pm;case 35679:case 36299:case 36307:return Dm;case 35680:case 36300:case 36308:case 36293:return Lm;case 36289:case 36303:case 36311:case 36292:return Im}}(t.type)}}class tg{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.size=t.size,this.setValue=function(e){switch(e){case 5126:return km;case 35664:return Om;case 35665:return Um;case 35666:return Fm;case 35674:return Bm;case 35675:return zm;case 35676:return Vm;case 5124:case 35670:return Gm;case 35667:case 35671:return jm;case 35668:case 35672:return Hm;case 35669:case 35673:return Wm;case 5125:return qm;case 36294:return Xm;case 36295:return $m;case 36296:return Ym;case 35678:case 36198:case 36298:case 36306:case 35682:return Km;case 35679:case 36299:case 36307:return Zm;case 35680:case 36300:case 36308:case 36293:return Jm;case 36289:case 36303:case 36311:case 36292:return Qm}}(t.type)}}class ng{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,n){const i=this.seq;for(let r=0,s=i.length;r!==s;++r){const s=i[r];s.setValue(e,t[s.id],n)}}}const ig=/(\w+)(\])?(\[|\.)?/g;function rg(e,t){e.seq.push(t),e.map[t.id]=t}function sg(e,t,n){const i=e.name,r=i.length;for(ig.lastIndex=0;;){const s=ig.exec(i),o=ig.lastIndex;let a=s[1];const l="]"===s[2],c=s[3];if(l&&(a|=0),void 0===c||"["===c&&o+2===r){rg(n,void 0===c?new eg(a,e,t):new tg(a,e,t));break}{let e=n.map[a];void 0===e&&(e=new ng(a),rg(n,e)),n=e}}}class og{constructor(e,t){this.seq=[],this.map={};const n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let i=0;i<n;++i){const n=e.getActiveUniform(t,i);sg(n,e.getUniformLocation(t,n.name),this)}}setValue(e,t,n,i){const r=this.map[t];void 0!==r&&r.setValue(e,n,i)}setOptional(e,t,n){const i=t[n];void 0!==i&&this.setValue(e,n,i)}static upload(e,t,n,i){for(let r=0,s=t.length;r!==s;++r){const s=t[r],o=n[s.id];!1!==o.needsUpdate&&s.setValue(e,o.value,i)}}static seqWithValue(e,t){const n=[];for(let i=0,r=e.length;i!==r;++i){const r=e[i];r.id in t&&n.push(r)}return n}}function ag(e,t,n){const i=e.createShader(t);return e.shaderSource(i,n),e.compileShader(i),i}let lg=0;const cg=new kc;function ug(e,t,n){const i=e.getShaderParameter(t,e.COMPILE_STATUS),r=e.getShaderInfoLog(t).trim();if(i&&""===r)return"";const s=/ERROR: 0:(\d+)/.exec(r);if(s){const i=parseInt(s[1]);return n.toUpperCase()+"\n\n"+r+"\n\n"+function(e,t){const n=e.split("\n"),i=[],r=Math.max(t-6,0),s=Math.min(t+6,n.length);for(let e=r;e<s;e++){const r=e+1;i.push(`${r===t?">":" "} ${r}: ${n[e]}`)}return i.join("\n")}(e.getShaderSource(t),i)}return r}function hg(e,t){const n=function(e){Wc._getMatrix(cg,Wc.workingColorSpace,e);const t=`mat3( ${cg.elements.map((e=>e.toFixed(4)))} )`;switch(Wc.getTransfer(e)){case nc:return[t,"LinearTransferOETF"];case ic:return[t,"sRGBTransferOETF"];default:return console.warn("THREE.WebGLProgram: Unsupported color space: ",e),[t,"LinearTransferOETF"]}}(t);return[`vec4 ${e}( vec4 value ) {`,`\treturn ${n[1]}( vec4( value.rgb * ${n[0]}, value.a ) );`,"}"].join("\n")}function dg(e,t){let n;switch(t){case 1:n="Linear";break;case 2:n="Reinhard";break;case 3:n="Cineon";break;case 4:n="ACESFilmic";break;case 6:n="AgX";break;case 7:n="Neutral";break;case 5:n="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",t),n="Linear"}return"vec3 "+e+"( vec3 color ) { return "+n+"ToneMapping( color ); }"}const pg=new Dc;function fg(){Wc.getLuminanceCoefficients(pg);return["float luminance( const in vec3 rgb ) {",`\tconst vec3 weights = vec3( ${pg.x.toFixed(4)}, ${pg.y.toFixed(4)}, ${pg.z.toFixed(4)} );`,"\treturn dot( weights, rgb );","}"].join("\n")}function mg(e){return""!==e}function gg(e,t){const n=t.numSpotLightShadows+t.numSpotLightMaps-t.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,t.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,n).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,t.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function yg(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const vg=/^[ \t]*#include +<([\w\d./]+)>/gm;function _g(e){return e.replace(vg,bg)}const xg=new Map;function bg(e,t){let n=_f[t];if(void 0===n){const e=xg.get(t);if(void 0===e)throw new Error("Can not resolve #include <"+t+">");n=_f[e],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',t,e)}return _g(n)}const wg=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Tg(e){return e.replace(wg,Sg)}function Sg(e,t,n,i){let r="";for(let e=parseInt(t);e<parseInt(n);e++)r+=i.replace(/\[\s*i\s*\]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return r}function Mg(e){let t=`precision ${e.precision} float;\n\tprecision ${e.precision} int;\n\tprecision ${e.precision} sampler2D;\n\tprecision ${e.precision} samplerCube;\n\tprecision ${e.precision} sampler3D;\n\tprecision ${e.precision} sampler2DArray;\n\tprecision ${e.precision} sampler2DShadow;\n\tprecision ${e.precision} samplerCubeShadow;\n\tprecision ${e.precision} sampler2DArrayShadow;\n\tprecision ${e.precision} isampler2D;\n\tprecision ${e.precision} isampler3D;\n\tprecision ${e.precision} isamplerCube;\n\tprecision ${e.precision} isampler2DArray;\n\tprecision ${e.precision} usampler2D;\n\tprecision ${e.precision} usampler3D;\n\tprecision ${e.precision} usamplerCube;\n\tprecision ${e.precision} usampler2DArray;\n\t`;return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function Eg(e,t,n,i){const r=e.getContext(),s=n.defines;let o=n.vertexShader,a=n.fragmentShader;const l=function(e){let t="SHADOWMAP_TYPE_BASIC";return 1===e.shadowMapType?t="SHADOWMAP_TYPE_PCF":2===e.shadowMapType?t="SHADOWMAP_TYPE_PCF_SOFT":3===e.shadowMapType&&(t="SHADOWMAP_TYPE_VSM"),t}(n),c=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case Ba:case za:t="ENVMAP_TYPE_CUBE";break;case ja:t="ENVMAP_TYPE_CUBE_UV"}return t}(n),u=function(e){let t="ENVMAP_MODE_REFLECTION";e.envMap&&e.envMapMode===za&&(t="ENVMAP_MODE_REFRACTION");return t}(n),h=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case 0:t="ENVMAP_BLENDING_MULTIPLY";break;case 1:t="ENVMAP_BLENDING_MIX";break;case 2:t="ENVMAP_BLENDING_ADD"}return t}(n),d=function(e){const t=e.envMapCubeUVHeight;if(null===t)return null;const n=Math.log2(t)-2,i=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,n),112)),texelHeight:i,maxMip:n}}(n),p=function(e){return[e.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",e.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(mg).join("\n")}(n),f=function(e){const t=[];for(const n in e){const i=e[n];!1!==i&&t.push("#define "+n+" "+i)}return t.join("\n")}(s),m=r.createProgram();let g,y,v=n.glslVersion?"#version "+n.glslVersion+"\n":"";n.isRawShaderMaterial?(g=["#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f].filter(mg).join("\n"),g.length>0&&(g+="\n"),y=["#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f].filter(mg).join("\n"),y.length>0&&(y+="\n")):(g=[Mg(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f,n.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",n.batching?"#define USE_BATCHING":"",n.batchingColor?"#define USE_BATCHING_COLOR":"",n.instancing?"#define USE_INSTANCING":"",n.instancingColor?"#define USE_INSTANCING_COLOR":"",n.instancingMorph?"#define USE_INSTANCING_MORPH":"",n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+u:"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.displacementMap?"#define USE_DISPLACEMENTMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.mapUv?"#define MAP_UV "+n.mapUv:"",n.alphaMapUv?"#define ALPHAMAP_UV "+n.alphaMapUv:"",n.lightMapUv?"#define LIGHTMAP_UV "+n.lightMapUv:"",n.aoMapUv?"#define AOMAP_UV "+n.aoMapUv:"",n.emissiveMapUv?"#define EMISSIVEMAP_UV "+n.emissiveMapUv:"",n.bumpMapUv?"#define BUMPMAP_UV "+n.bumpMapUv:"",n.normalMapUv?"#define NORMALMAP_UV "+n.normalMapUv:"",n.displacementMapUv?"#define DISPLACEMENTMAP_UV "+n.displacementMapUv:"",n.metalnessMapUv?"#define METALNESSMAP_UV "+n.metalnessMapUv:"",n.roughnessMapUv?"#define ROUGHNESSMAP_UV "+n.roughnessMapUv:"",n.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+n.anisotropyMapUv:"",n.clearcoatMapUv?"#define CLEARCOATMAP_UV "+n.clearcoatMapUv:"",n.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+n.clearcoatNormalMapUv:"",n.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+n.clearcoatRoughnessMapUv:"",n.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+n.iridescenceMapUv:"",n.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+n.iridescenceThicknessMapUv:"",n.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+n.sheenColorMapUv:"",n.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+n.sheenRoughnessMapUv:"",n.specularMapUv?"#define SPECULARMAP_UV "+n.specularMapUv:"",n.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+n.specularColorMapUv:"",n.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+n.specularIntensityMapUv:"",n.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+n.transmissionMapUv:"",n.thicknessMapUv?"#define THICKNESSMAP_UV "+n.thicknessMapUv:"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.flatShading?"#define FLAT_SHADED":"",n.skinning?"#define USE_SKINNING":"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals&&!1===n.flatShading?"#define USE_MORPHNORMALS":"",n.morphColors?"#define USE_MORPHCOLORS":"",n.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+n.morphTextureStride:"",n.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+n.morphTargetsCount:"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","\tuniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(mg).join("\n"),y=[Mg(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f,n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",n.map?"#define USE_MAP":"",n.matcap?"#define USE_MATCAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+c:"",n.envMap?"#define "+u:"",n.envMap?"#define "+h:"",d?"#define CUBEUV_TEXEL_WIDTH "+d.texelWidth:"",d?"#define CUBEUV_TEXEL_HEIGHT "+d.texelHeight:"",d?"#define CUBEUV_MAX_MIP "+d.maxMip+".0":"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoat?"#define USE_CLEARCOAT":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.dispersion?"#define USE_DISPERSION":"",n.iridescence?"#define USE_IRIDESCENCE":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaTest?"#define USE_ALPHATEST":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.sheen?"#define USE_SHEEN":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors||n.instancingColor||n.batchingColor?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.gradientMap?"#define USE_GRADIENTMAP":"",n.flatShading?"#define FLAT_SHADED":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",n.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==n.toneMapping?"#define TONE_MAPPING":"",0!==n.toneMapping?_f.tonemapping_pars_fragment:"",0!==n.toneMapping?dg("toneMapping",n.toneMapping):"",n.dithering?"#define DITHERING":"",n.opaque?"#define OPAQUE":"",_f.colorspace_pars_fragment,hg("linearToOutputTexel",n.outputColorSpace),fg(),n.useDepthPacking?"#define DEPTH_PACKING "+n.depthPacking:"","\n"].filter(mg).join("\n")),o=_g(o),o=gg(o,n),o=yg(o,n),a=_g(a),a=gg(a,n),a=yg(a,n),o=Tg(o),a=Tg(a),!0!==n.isRawShaderMaterial&&(v="#version 300 es\n",g=[p,"#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,y=["#define varying in",n.glslVersion===mc?"":"layout(location = 0) out highp vec4 pc_fragColor;",n.glslVersion===mc?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+y);const _=v+g+o,x=v+y+a,b=ag(r,r.VERTEX_SHADER,_),w=ag(r,r.FRAGMENT_SHADER,x);function T(t){if(e.debug.checkShaderErrors){const n=r.getProgramInfoLog(m).trim(),i=r.getShaderInfoLog(b).trim(),s=r.getShaderInfoLog(w).trim();let o=!0,a=!0;if(!1===r.getProgramParameter(m,r.LINK_STATUS))if(o=!1,"function"==typeof e.debug.onShaderError)e.debug.onShaderError(r,m,b,w);else{const e=ug(r,b,"vertex"),i=ug(r,w,"fragment");console.error("THREE.WebGLProgram: Shader Error "+r.getError()+" - VALIDATE_STATUS "+r.getProgramParameter(m,r.VALIDATE_STATUS)+"\n\nMaterial Name: "+t.name+"\nMaterial Type: "+t.type+"\n\nProgram Info Log: "+n+"\n"+e+"\n"+i)}else""!==n?console.warn("THREE.WebGLProgram: Program Info Log:",n):""!==i&&""!==s||(a=!1);a&&(t.diagnostics={runnable:o,programLog:n,vertexShader:{log:i,prefix:g},fragmentShader:{log:s,prefix:y}})}r.deleteShader(b),r.deleteShader(w),S=new og(r,m),M=function(e,t){const n={},i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let r=0;r<i;r++){const i=e.getActiveAttrib(t,r),s=i.name;let o=1;i.type===e.FLOAT_MAT2&&(o=2),i.type===e.FLOAT_MAT3&&(o=3),i.type===e.FLOAT_MAT4&&(o=4),n[s]={type:i.type,location:e.getAttribLocation(t,s),locationSize:o}}return n}(r,m)}let S,M;r.attachShader(m,b),r.attachShader(m,w),void 0!==n.index0AttributeName?r.bindAttribLocation(m,0,n.index0AttributeName):!0===n.morphTargets&&r.bindAttribLocation(m,0,"position"),r.linkProgram(m),this.getUniforms=function(){return void 0===S&&T(this),S},this.getAttributes=function(){return void 0===M&&T(this),M};let E=!1===n.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===E&&(E=r.getProgramParameter(m,37297)),E},this.destroy=function(){i.releaseStatesOfProgram(this),r.deleteProgram(m),this.program=void 0},this.type=n.shaderType,this.name=n.shaderName,this.id=lg++,this.cacheKey=t,this.usedTimes=1,this.program=m,this.vertexShader=b,this.fragmentShader=w,this}let Ag=0;class Cg{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.vertexShader,n=e.fragmentShader,i=this._getShaderStage(t),r=this._getShaderStage(n),s=this._getShaderCacheForMaterial(e);return!1===s.has(i)&&(s.add(i),i.usedTimes++),!1===s.has(r)&&(s.add(r),r.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const e of t)e.usedTimes--,0===e.usedTimes&&this.shaderCache.delete(e.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let n=t.get(e);return void 0===n&&(n=new Set,t.set(e,n)),n}_getShaderStage(e){const t=this.shaderCache;let n=t.get(e);return void 0===n&&(n=new Rg(e),t.set(e,n)),n}}class Rg{constructor(e){this.id=Ag++,this.code=e,this.usedTimes=0}}function Ng(e,t,n,i,r,s,o){const a=new Wu,l=new Cg,c=new Set,u=[],h=r.logarithmicDepthBuffer,d=r.vertexTextures;let p=r.precision;const f={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function m(e){return c.add(e),0===e?"uv":`uv${e}`}return{getParameters:function(s,a,u,g,y){const v=g.fog,_=y.geometry,x=s.isMeshStandardMaterial?g.environment:null,b=(s.isMeshStandardMaterial?n:t).get(s.envMap||x),w=b&&b.mapping===ja?b.image.height:null,T=f[s.type];null!==s.precision&&(p=r.getMaxPrecision(s.precision),p!==s.precision&&console.warn("THREE.WebGLProgram.getParameters:",s.precision,"not supported, using",p,"instead."));const S=_.morphAttributes.position||_.morphAttributes.normal||_.morphAttributes.color,M=void 0!==S?S.length:0;let E,A,C,R,N=0;if(void 0!==_.morphAttributes.position&&(N=1),void 0!==_.morphAttributes.normal&&(N=2),void 0!==_.morphAttributes.color&&(N=3),T){const e=bf[T];E=e.vertexShader,A=e.fragmentShader}else E=s.vertexShader,A=s.fragmentShader,l.update(s),C=l.getVertexShaderID(s),R=l.getFragmentShaderID(s);const P=e.getRenderTarget(),D=e.state.buffers.depth.getReversed(),L=!0===y.isInstancedMesh,I=!0===y.isBatchedMesh,k=!!s.map,O=!!s.matcap,U=!!b,F=!!s.aoMap,B=!!s.lightMap,z=!!s.bumpMap,V=!!s.normalMap,G=!!s.displacementMap,j=!!s.emissiveMap,H=!!s.metalnessMap,W=!!s.roughnessMap,q=s.anisotropy>0,X=s.clearcoat>0,$=s.dispersion>0,Y=s.iridescence>0,K=s.sheen>0,Z=s.transmission>0,J=q&&!!s.anisotropyMap,Q=X&&!!s.clearcoatMap,ee=X&&!!s.clearcoatNormalMap,te=X&&!!s.clearcoatRoughnessMap,ne=Y&&!!s.iridescenceMap,ie=Y&&!!s.iridescenceThicknessMap,re=K&&!!s.sheenColorMap,se=K&&!!s.sheenRoughnessMap,oe=!!s.specularMap,ae=!!s.specularColorMap,le=!!s.specularIntensityMap,ce=Z&&!!s.transmissionMap,ue=Z&&!!s.thicknessMap,he=!!s.gradientMap,de=!!s.alphaMap,pe=s.alphaTest>0,fe=!!s.alphaHash,me=!!s.extensions;let ge=0;s.toneMapped&&(null!==P&&!0!==P.isXRRenderTarget||(ge=e.toneMapping));const ye={shaderID:T,shaderType:s.type,shaderName:s.name,vertexShader:E,fragmentShader:A,defines:s.defines,customVertexShaderID:C,customFragmentShaderID:R,isRawShaderMaterial:!0===s.isRawShaderMaterial,glslVersion:s.glslVersion,precision:p,batching:I,batchingColor:I&&null!==y._colorsTexture,instancing:L,instancingColor:L&&null!==y.instanceColor,instancingMorph:L&&null!==y.morphTexture,supportsVertexTextures:d,outputColorSpace:null===P?e.outputColorSpace:!0===P.isXRRenderTarget?P.texture.colorSpace:tc,alphaToCoverage:!!s.alphaToCoverage,map:k,matcap:O,envMap:U,envMapMode:U&&b.mapping,envMapCubeUVHeight:w,aoMap:F,lightMap:B,bumpMap:z,normalMap:V,displacementMap:d&&G,emissiveMap:j,normalMapObjectSpace:V&&1===s.normalMapType,normalMapTangentSpace:V&&0===s.normalMapType,metalnessMap:H,roughnessMap:W,anisotropy:q,anisotropyMap:J,clearcoat:X,clearcoatMap:Q,clearcoatNormalMap:ee,clearcoatRoughnessMap:te,dispersion:$,iridescence:Y,iridescenceMap:ne,iridescenceThicknessMap:ie,sheen:K,sheenColorMap:re,sheenRoughnessMap:se,specularMap:oe,specularColorMap:ae,specularIntensityMap:le,transmission:Z,transmissionMap:ce,thicknessMap:ue,gradientMap:he,opaque:!1===s.transparent&&1===s.blending&&!1===s.alphaToCoverage,alphaMap:de,alphaTest:pe,alphaHash:fe,combine:s.combine,mapUv:k&&m(s.map.channel),aoMapUv:F&&m(s.aoMap.channel),lightMapUv:B&&m(s.lightMap.channel),bumpMapUv:z&&m(s.bumpMap.channel),normalMapUv:V&&m(s.normalMap.channel),displacementMapUv:G&&m(s.displacementMap.channel),emissiveMapUv:j&&m(s.emissiveMap.channel),metalnessMapUv:H&&m(s.metalnessMap.channel),roughnessMapUv:W&&m(s.roughnessMap.channel),anisotropyMapUv:J&&m(s.anisotropyMap.channel),clearcoatMapUv:Q&&m(s.clearcoatMap.channel),clearcoatNormalMapUv:ee&&m(s.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:te&&m(s.clearcoatRoughnessMap.channel),iridescenceMapUv:ne&&m(s.iridescenceMap.channel),iridescenceThicknessMapUv:ie&&m(s.iridescenceThicknessMap.channel),sheenColorMapUv:re&&m(s.sheenColorMap.channel),sheenRoughnessMapUv:se&&m(s.sheenRoughnessMap.channel),specularMapUv:oe&&m(s.specularMap.channel),specularColorMapUv:ae&&m(s.specularColorMap.channel),specularIntensityMapUv:le&&m(s.specularIntensityMap.channel),transmissionMapUv:ce&&m(s.transmissionMap.channel),thicknessMapUv:ue&&m(s.thicknessMap.channel),alphaMapUv:de&&m(s.alphaMap.channel),vertexTangents:!!_.attributes.tangent&&(V||q),vertexColors:s.vertexColors,vertexAlphas:!0===s.vertexColors&&!!_.attributes.color&&4===_.attributes.color.itemSize,pointsUvs:!0===y.isPoints&&!!_.attributes.uv&&(k||de),fog:!!v,useFog:!0===s.fog,fogExp2:!!v&&v.isFogExp2,flatShading:!0===s.flatShading,sizeAttenuation:!0===s.sizeAttenuation,logarithmicDepthBuffer:h,reverseDepthBuffer:D,skinning:!0===y.isSkinnedMesh,morphTargets:void 0!==_.morphAttributes.position,morphNormals:void 0!==_.morphAttributes.normal,morphColors:void 0!==_.morphAttributes.color,morphTargetsCount:M,morphTextureStride:N,numDirLights:a.directional.length,numPointLights:a.point.length,numSpotLights:a.spot.length,numSpotLightMaps:a.spotLightMap.length,numRectAreaLights:a.rectArea.length,numHemiLights:a.hemi.length,numDirLightShadows:a.directionalShadowMap.length,numPointLightShadows:a.pointShadowMap.length,numSpotLightShadows:a.spotShadowMap.length,numSpotLightShadowsWithMaps:a.numSpotLightShadowsWithMaps,numLightProbes:a.numLightProbes,numClippingPlanes:o.numPlanes,numClipIntersection:o.numIntersection,dithering:s.dithering,shadowMapEnabled:e.shadowMap.enabled&&u.length>0,shadowMapType:e.shadowMap.type,toneMapping:ge,decodeVideoTexture:k&&!0===s.map.isVideoTexture&&Wc.getTransfer(s.map.colorSpace)===ic,decodeVideoTextureEmissive:j&&!0===s.emissiveMap.isVideoTexture&&Wc.getTransfer(s.emissiveMap.colorSpace)===ic,premultipliedAlpha:s.premultipliedAlpha,doubleSided:2===s.side,flipSided:1===s.side,useDepthPacking:s.depthPacking>=0,depthPacking:s.depthPacking||0,index0AttributeName:s.index0AttributeName,extensionClipCullDistance:me&&!0===s.extensions.clipCullDistance&&i.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(me&&!0===s.extensions.multiDraw||I)&&i.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:i.has("KHR_parallel_shader_compile"),customProgramCacheKey:s.customProgramCacheKey()};return ye.vertexUv1s=c.has(1),ye.vertexUv2s=c.has(2),ye.vertexUv3s=c.has(3),c.clear(),ye},getProgramCacheKey:function(t){const n=[];if(t.shaderID?n.push(t.shaderID):(n.push(t.customVertexShaderID),n.push(t.customFragmentShaderID)),void 0!==t.defines)for(const e in t.defines)n.push(e),n.push(t.defines[e]);return!1===t.isRawShaderMaterial&&(!function(e,t){e.push(t.precision),e.push(t.outputColorSpace),e.push(t.envMapMode),e.push(t.envMapCubeUVHeight),e.push(t.mapUv),e.push(t.alphaMapUv),e.push(t.lightMapUv),e.push(t.aoMapUv),e.push(t.bumpMapUv),e.push(t.normalMapUv),e.push(t.displacementMapUv),e.push(t.emissiveMapUv),e.push(t.metalnessMapUv),e.push(t.roughnessMapUv),e.push(t.anisotropyMapUv),e.push(t.clearcoatMapUv),e.push(t.clearcoatNormalMapUv),e.push(t.clearcoatRoughnessMapUv),e.push(t.iridescenceMapUv),e.push(t.iridescenceThicknessMapUv),e.push(t.sheenColorMapUv),e.push(t.sheenRoughnessMapUv),e.push(t.specularMapUv),e.push(t.specularColorMapUv),e.push(t.specularIntensityMapUv),e.push(t.transmissionMapUv),e.push(t.thicknessMapUv),e.push(t.combine),e.push(t.fogExp2),e.push(t.sizeAttenuation),e.push(t.morphTargetsCount),e.push(t.morphAttributeCount),e.push(t.numDirLights),e.push(t.numPointLights),e.push(t.numSpotLights),e.push(t.numSpotLightMaps),e.push(t.numHemiLights),e.push(t.numRectAreaLights),e.push(t.numDirLightShadows),e.push(t.numPointLightShadows),e.push(t.numSpotLightShadows),e.push(t.numSpotLightShadowsWithMaps),e.push(t.numLightProbes),e.push(t.shadowMapType),e.push(t.toneMapping),e.push(t.numClippingPlanes),e.push(t.numClipIntersection),e.push(t.depthPacking)}(n,t),function(e,t){a.disableAll(),t.supportsVertexTextures&&a.enable(0);t.instancing&&a.enable(1);t.instancingColor&&a.enable(2);t.instancingMorph&&a.enable(3);t.matcap&&a.enable(4);t.envMap&&a.enable(5);t.normalMapObjectSpace&&a.enable(6);t.normalMapTangentSpace&&a.enable(7);t.clearcoat&&a.enable(8);t.iridescence&&a.enable(9);t.alphaTest&&a.enable(10);t.vertexColors&&a.enable(11);t.vertexAlphas&&a.enable(12);t.vertexUv1s&&a.enable(13);t.vertexUv2s&&a.enable(14);t.vertexUv3s&&a.enable(15);t.vertexTangents&&a.enable(16);t.anisotropy&&a.enable(17);t.alphaHash&&a.enable(18);t.batching&&a.enable(19);t.dispersion&&a.enable(20);t.batchingColor&&a.enable(21);e.push(a.mask),a.disableAll(),t.fog&&a.enable(0);t.useFog&&a.enable(1);t.flatShading&&a.enable(2);t.logarithmicDepthBuffer&&a.enable(3);t.reverseDepthBuffer&&a.enable(4);t.skinning&&a.enable(5);t.morphTargets&&a.enable(6);t.morphNormals&&a.enable(7);t.morphColors&&a.enable(8);t.premultipliedAlpha&&a.enable(9);t.shadowMapEnabled&&a.enable(10);t.doubleSided&&a.enable(11);t.flipSided&&a.enable(12);t.useDepthPacking&&a.enable(13);t.dithering&&a.enable(14);t.transmission&&a.enable(15);t.sheen&&a.enable(16);t.opaque&&a.enable(17);t.pointsUvs&&a.enable(18);t.decodeVideoTexture&&a.enable(19);t.decodeVideoTextureEmissive&&a.enable(20);t.alphaToCoverage&&a.enable(21);e.push(a.mask)}(n,t),n.push(e.outputColorSpace)),n.push(t.customProgramCacheKey),n.join()},getUniforms:function(e){const t=f[e.type];let n;if(t){const e=bf[t];n=fd.clone(e.uniforms)}else n=e.uniforms;return n},acquireProgram:function(t,n){let i;for(let e=0,t=u.length;e<t;e++){const t=u[e];if(t.cacheKey===n){i=t,++i.usedTimes;break}}return void 0===i&&(i=new Eg(e,n,t,s),u.push(i)),i},releaseProgram:function(e){if(0===--e.usedTimes){const t=u.indexOf(e);u[t]=u[u.length-1],u.pop(),e.destroy()}},releaseShaderCache:function(e){l.remove(e)},programs:u,dispose:function(){l.dispose()}}}function Pg(){let e=new WeakMap;return{has:function(t){return e.has(t)},get:function(t){let n=e.get(t);return void 0===n&&(n={},e.set(t,n)),n},remove:function(t){e.delete(t)},update:function(t,n,i){e.get(t)[n]=i},dispose:function(){e=new WeakMap}}}function Dg(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function Lg(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Ig(){const e=[];let t=0;const n=[],i=[],r=[];function s(n,i,r,s,o,a){let l=e[t];return void 0===l?(l={id:n.id,object:n,geometry:i,material:r,groupOrder:s,renderOrder:n.renderOrder,z:o,group:a},e[t]=l):(l.id=n.id,l.object=n,l.geometry=i,l.material=r,l.groupOrder=s,l.renderOrder=n.renderOrder,l.z=o,l.group=a),t++,l}return{opaque:n,transmissive:i,transparent:r,init:function(){t=0,n.length=0,i.length=0,r.length=0},push:function(e,t,o,a,l,c){const u=s(e,t,o,a,l,c);o.transmission>0?i.push(u):!0===o.transparent?r.push(u):n.push(u)},unshift:function(e,t,o,a,l,c){const u=s(e,t,o,a,l,c);o.transmission>0?i.unshift(u):!0===o.transparent?r.unshift(u):n.unshift(u)},finish:function(){for(let n=t,i=e.length;n<i;n++){const t=e[n];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.group=null}},sort:function(e,t){n.length>1&&n.sort(e||Dg),i.length>1&&i.sort(t||Lg),r.length>1&&r.sort(t||Lg)}}}function kg(){let e=new WeakMap;return{get:function(t,n){const i=e.get(t);let r;return void 0===i?(r=new Ig,e.set(t,[r])):n>=i.length?(r=new Ig,i.push(r)):r=i[n],r},dispose:function(){e=new WeakMap}}}function Og(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":n={direction:new Dc,color:new Eh};break;case"SpotLight":n={position:new Dc,direction:new Dc,color:new Eh,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":n={position:new Dc,color:new Eh,distance:0,decay:0};break;case"HemisphereLight":n={direction:new Dc,skyColor:new Eh,groundColor:new Eh};break;case"RectAreaLight":n={color:new Eh,position:new Dc,halfWidth:new Dc,halfHeight:new Dc}}return e[t.id]=n,n}}}let Ug=0;function Fg(e,t){return(t.castShadow?2:0)-(e.castShadow?2:0)+(t.map?1:0)-(e.map?1:0)}function Bg(e){const t=new Og,n=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":case"SpotLight":n={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Nc};break;case"PointLight":n={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Nc,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=n,n}}}(),i={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let e=0;e<9;e++)i.probe.push(new Dc);const r=new Dc,s=new Iu,o=new Iu;return{setup:function(r){let s=0,o=0,a=0;for(let e=0;e<9;e++)i.probe[e].set(0,0,0);let l=0,c=0,u=0,h=0,d=0,p=0,f=0,m=0,g=0,y=0,v=0;r.sort(Fg);for(let e=0,_=r.length;e<_;e++){const _=r[e],x=_.color,b=_.intensity,w=_.distance,T=_.shadow&&_.shadow.map?_.shadow.map.texture:null;if(_.isAmbientLight)s+=x.r*b,o+=x.g*b,a+=x.b*b;else if(_.isLightProbe){for(let e=0;e<9;e++)i.probe[e].addScaledVector(_.sh.coefficients[e],b);v++}else if(_.isDirectionalLight){const e=t.get(_);if(e.color.copy(_.color).multiplyScalar(_.intensity),_.castShadow){const e=_.shadow,t=n.get(_);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,i.directionalShadow[l]=t,i.directionalShadowMap[l]=T,i.directionalShadowMatrix[l]=_.shadow.matrix,p++}i.directional[l]=e,l++}else if(_.isSpotLight){const e=t.get(_);e.position.setFromMatrixPosition(_.matrixWorld),e.color.copy(x).multiplyScalar(b),e.distance=w,e.coneCos=Math.cos(_.angle),e.penumbraCos=Math.cos(_.angle*(1-_.penumbra)),e.decay=_.decay,i.spot[u]=e;const r=_.shadow;if(_.map&&(i.spotLightMap[g]=_.map,g++,r.updateMatrices(_),_.castShadow&&y++),i.spotLightMatrix[u]=r.matrix,_.castShadow){const e=n.get(_);e.shadowIntensity=r.intensity,e.shadowBias=r.bias,e.shadowNormalBias=r.normalBias,e.shadowRadius=r.radius,e.shadowMapSize=r.mapSize,i.spotShadow[u]=e,i.spotShadowMap[u]=T,m++}u++}else if(_.isRectAreaLight){const e=t.get(_);e.color.copy(x).multiplyScalar(b),e.halfWidth.set(.5*_.width,0,0),e.halfHeight.set(0,.5*_.height,0),i.rectArea[h]=e,h++}else if(_.isPointLight){const e=t.get(_);if(e.color.copy(_.color).multiplyScalar(_.intensity),e.distance=_.distance,e.decay=_.decay,_.castShadow){const e=_.shadow,t=n.get(_);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,t.shadowCameraNear=e.camera.near,t.shadowCameraFar=e.camera.far,i.pointShadow[c]=t,i.pointShadowMap[c]=T,i.pointShadowMatrix[c]=_.shadow.matrix,f++}i.point[c]=e,c++}else if(_.isHemisphereLight){const e=t.get(_);e.skyColor.copy(_.color).multiplyScalar(b),e.groundColor.copy(_.groundColor).multiplyScalar(b),i.hemi[d]=e,d++}}h>0&&(!0===e.has("OES_texture_float_linear")?(i.rectAreaLTC1=xf.LTC_FLOAT_1,i.rectAreaLTC2=xf.LTC_FLOAT_2):(i.rectAreaLTC1=xf.LTC_HALF_1,i.rectAreaLTC2=xf.LTC_HALF_2)),i.ambient[0]=s,i.ambient[1]=o,i.ambient[2]=a;const _=i.hash;_.directionalLength===l&&_.pointLength===c&&_.spotLength===u&&_.rectAreaLength===h&&_.hemiLength===d&&_.numDirectionalShadows===p&&_.numPointShadows===f&&_.numSpotShadows===m&&_.numSpotMaps===g&&_.numLightProbes===v||(i.directional.length=l,i.spot.length=u,i.rectArea.length=h,i.point.length=c,i.hemi.length=d,i.directionalShadow.length=p,i.directionalShadowMap.length=p,i.pointShadow.length=f,i.pointShadowMap.length=f,i.spotShadow.length=m,i.spotShadowMap.length=m,i.directionalShadowMatrix.length=p,i.pointShadowMatrix.length=f,i.spotLightMatrix.length=m+g-y,i.spotLightMap.length=g,i.numSpotLightShadowsWithMaps=y,i.numLightProbes=v,_.directionalLength=l,_.pointLength=c,_.spotLength=u,_.rectAreaLength=h,_.hemiLength=d,_.numDirectionalShadows=p,_.numPointShadows=f,_.numSpotShadows=m,_.numSpotMaps=g,_.numLightProbes=v,i.version=Ug++)},setupView:function(e,t){let n=0,a=0,l=0,c=0,u=0;const h=t.matrixWorldInverse;for(let t=0,d=e.length;t<d;t++){const d=e[t];if(d.isDirectionalLight){const e=i.directional[n];e.direction.setFromMatrixPosition(d.matrixWorld),r.setFromMatrixPosition(d.target.matrixWorld),e.direction.sub(r),e.direction.transformDirection(h),n++}else if(d.isSpotLight){const e=i.spot[l];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(h),e.direction.setFromMatrixPosition(d.matrixWorld),r.setFromMatrixPosition(d.target.matrixWorld),e.direction.sub(r),e.direction.transformDirection(h),l++}else if(d.isRectAreaLight){const e=i.rectArea[c];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(h),o.identity(),s.copy(d.matrixWorld),s.premultiply(h),o.extractRotation(s),e.halfWidth.set(.5*d.width,0,0),e.halfHeight.set(0,.5*d.height,0),e.halfWidth.applyMatrix4(o),e.halfHeight.applyMatrix4(o),c++}else if(d.isPointLight){const e=i.point[a];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(h),a++}else if(d.isHemisphereLight){const e=i.hemi[u];e.direction.setFromMatrixPosition(d.matrixWorld),e.direction.transformDirection(h),u++}}},state:i}}function zg(e){const t=new Bg(e),n=[],i=[];const r={lightsArray:n,shadowsArray:i,camera:null,lights:t,transmissionRenderTarget:{}};return{init:function(e){r.camera=e,n.length=0,i.length=0},state:r,setupLights:function(){t.setup(n)},setupLightsView:function(e){t.setupView(n,e)},pushLight:function(e){n.push(e)},pushShadow:function(e){i.push(e)}}}function Vg(e){let t=new WeakMap;return{get:function(n,i=0){const r=t.get(n);let s;return void 0===r?(s=new zg(e),t.set(n,[s])):i>=r.length?(s=new zg(e),r.push(s)):s=r[i],s},dispose:function(){t=new WeakMap}}}function Gg(e,t,n){let i=new Vd;const r=new Nc,s=new Nc,o=new nu,a=new Rp({depthPacking:3201}),l=new Np,c={},u=n.maxTextureSize,h={[ua]:1,[ha]:0,[da]:2},d=new md({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new Nc},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),p=d.clone();p.defines.HORIZONTAL_PASS=1;const f=new Kh;f.setAttribute("position",new Fh(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const m=new ld(f,d),g=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1;let y=this.type;function v(n,i){const s=t.update(m);d.defines.VSM_SAMPLES!==n.blurSamples&&(d.defines.VSM_SAMPLES=n.blurSamples,p.defines.VSM_SAMPLES=n.blurSamples,d.needsUpdate=!0,p.needsUpdate=!0),null===n.mapPass&&(n.mapPass=new ru(r.x,r.y)),d.uniforms.shadow_pass.value=n.map.texture,d.uniforms.resolution.value=n.mapSize,d.uniforms.radius.value=n.radius,e.setRenderTarget(n.mapPass),e.clear(),e.renderBufferDirect(i,null,s,d,m,null),p.uniforms.shadow_pass.value=n.mapPass.texture,p.uniforms.resolution.value=n.mapSize,p.uniforms.radius.value=n.radius,e.setRenderTarget(n.map),e.clear(),e.renderBufferDirect(i,null,s,p,m,null)}function _(t,n,i,r){let s=null;const o=!0===i.isPointLight?t.customDistanceMaterial:t.customDepthMaterial;if(void 0!==o)s=o;else if(s=!0===i.isPointLight?l:a,e.localClippingEnabled&&!0===n.clipShadows&&Array.isArray(n.clippingPlanes)&&0!==n.clippingPlanes.length||n.displacementMap&&0!==n.displacementScale||n.alphaMap&&n.alphaTest>0||n.map&&n.alphaTest>0||!0===n.alphaToCoverage){const e=s.uuid,t=n.uuid;let i=c[e];void 0===i&&(i={},c[e]=i);let r=i[t];void 0===r&&(r=s.clone(),i[t]=r,n.addEventListener("dispose",b)),s=r}if(s.visible=n.visible,s.wireframe=n.wireframe,s.side=3===r?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:h[n.side],s.alphaMap=n.alphaMap,s.alphaTest=!0===n.alphaToCoverage?.5:n.alphaTest,s.map=n.map,s.clipShadows=n.clipShadows,s.clippingPlanes=n.clippingPlanes,s.clipIntersection=n.clipIntersection,s.displacementMap=n.displacementMap,s.displacementScale=n.displacementScale,s.displacementBias=n.displacementBias,s.wireframeLinewidth=n.wireframeLinewidth,s.linewidth=n.linewidth,!0===i.isPointLight&&!0===s.isMeshDistanceMaterial){e.properties.get(s).light=i}return s}function x(n,r,s,o,a){if(!1===n.visible)return;if(n.layers.test(r.layers)&&(n.isMesh||n.isLine||n.isPoints)&&(n.castShadow||n.receiveShadow&&3===a)&&(!n.frustumCulled||i.intersectsObject(n))){n.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,n.matrixWorld);const i=t.update(n),l=n.material;if(Array.isArray(l)){const t=i.groups;for(let c=0,u=t.length;c<u;c++){const u=t[c],h=l[u.materialIndex];if(h&&h.visible){const t=_(n,h,o,a);n.onBeforeShadow(e,n,r,s,i,t,u),e.renderBufferDirect(s,null,i,t,n,u),n.onAfterShadow(e,n,r,s,i,t,u)}}}else if(l.visible){const t=_(n,l,o,a);n.onBeforeShadow(e,n,r,s,i,t,null),e.renderBufferDirect(s,null,i,t,n,null),n.onAfterShadow(e,n,r,s,i,t,null)}}const l=n.children;for(let e=0,t=l.length;e<t;e++)x(l[e],r,s,o,a)}function b(e){e.target.removeEventListener("dispose",b);for(const t in c){const n=c[t],i=e.target.uuid;if(i in n){n[i].dispose(),delete n[i]}}}this.render=function(t,n,a){if(!1===g.enabled)return;if(!1===g.autoUpdate&&!1===g.needsUpdate)return;if(0===t.length)return;const l=e.getRenderTarget(),c=e.getActiveCubeFace(),h=e.getActiveMipmapLevel(),d=e.state;d.setBlending(0),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);const p=3!==y&&3===this.type,f=3===y&&3!==this.type;for(let l=0,c=t.length;l<c;l++){const c=t[l],h=c.shadow;if(void 0===h){console.warn("THREE.WebGLShadowMap:",c,"has no shadow.");continue}if(!1===h.autoUpdate&&!1===h.needsUpdate)continue;r.copy(h.mapSize);const m=h.getFrameExtents();if(r.multiply(m),s.copy(h.mapSize),(r.x>u||r.y>u)&&(r.x>u&&(s.x=Math.floor(u/m.x),r.x=s.x*m.x,h.mapSize.x=s.x),r.y>u&&(s.y=Math.floor(u/m.y),r.y=s.y*m.y,h.mapSize.y=s.y)),null===h.map||!0===p||!0===f){const e=3!==this.type?{minFilter:Xa,magFilter:Xa}:{};null!==h.map&&h.map.dispose(),h.map=new ru(r.x,r.y,e),h.map.texture.name=c.name+".shadowMap",h.camera.updateProjectionMatrix()}e.setRenderTarget(h.map),e.clear();const g=h.getViewportCount();for(let e=0;e<g;e++){const t=h.getViewport(e);o.set(s.x*t.x,s.y*t.y,s.x*t.z,s.y*t.w),d.viewport(o),h.updateMatrices(c,e),i=h.getFrustum(),x(n,a,h.camera,c,this.type)}!0!==h.isPointLightShadow&&3===this.type&&v(h,a),h.needsUpdate=!1}y=this.type,g.needsUpdate=!1,e.setRenderTarget(l,c,h)}}const jg={[Pa]:1,[La]:6,[ka]:7,[Ia]:5,[Da]:0,[Ua]:2,[Fa]:4,[Oa]:3};function Hg(e,t){const n=new function(){let t=!1;const n=new nu;let i=null;const r=new nu(0,0,0,0);return{setMask:function(n){i===n||t||(e.colorMask(n,n,n,n),i=n)},setLocked:function(e){t=e},setClear:function(t,i,s,o,a){!0===a&&(t*=o,i*=o,s*=o),n.set(t,i,s,o),!1===r.equals(n)&&(e.clearColor(t,i,s,o),r.copy(n))},reset:function(){t=!1,i=null,r.set(-1,0,0,0)}}},i=new function(){let n=!1,i=!1,r=null,s=null,o=null;return{setReversed:function(e){if(i!==e){const n=t.get("EXT_clip_control");e?n.clipControlEXT(n.LOWER_LEFT_EXT,n.ZERO_TO_ONE_EXT):n.clipControlEXT(n.LOWER_LEFT_EXT,n.NEGATIVE_ONE_TO_ONE_EXT),i=e;const r=o;o=null,this.setClear(r)}},getReversed:function(){return i},setTest:function(t){t?z(e.DEPTH_TEST):V(e.DEPTH_TEST)},setMask:function(t){r===t||n||(e.depthMask(t),r=t)},setFunc:function(t){if(i&&(t=jg[t]),s!==t){switch(t){case 0:e.depthFunc(e.NEVER);break;case 1:e.depthFunc(e.ALWAYS);break;case 2:e.depthFunc(e.LESS);break;case 3:default:e.depthFunc(e.LEQUAL);break;case 4:e.depthFunc(e.EQUAL);break;case 5:e.depthFunc(e.GEQUAL);break;case 6:e.depthFunc(e.GREATER);break;case 7:e.depthFunc(e.NOTEQUAL)}s=t}},setLocked:function(e){n=e},setClear:function(t){o!==t&&(i&&(t=1-t),e.clearDepth(t),o=t)},reset:function(){n=!1,r=null,s=null,o=null,i=!1}}},r=new function(){let t=!1,n=null,i=null,r=null,s=null,o=null,a=null,l=null,c=null;return{setTest:function(n){t||(n?z(e.STENCIL_TEST):V(e.STENCIL_TEST))},setMask:function(i){n===i||t||(e.stencilMask(i),n=i)},setFunc:function(t,n,o){i===t&&r===n&&s===o||(e.stencilFunc(t,n,o),i=t,r=n,s=o)},setOp:function(t,n,i){o===t&&a===n&&l===i||(e.stencilOp(t,n,i),o=t,a=n,l=i)},setLocked:function(e){t=e},setClear:function(t){c!==t&&(e.clearStencil(t),c=t)},reset:function(){t=!1,n=null,i=null,r=null,s=null,o=null,a=null,l=null,c=null}}},s=new WeakMap,o=new WeakMap;let a={},l={},c=new WeakMap,u=[],h=null,d=!1,p=null,f=null,m=null,g=null,y=null,v=null,_=null,x=new Eh(0,0,0),b=0,w=!1,T=null,S=null,M=null,E=null,A=null;const C=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let R=!1,N=0;const P=e.getParameter(e.VERSION);-1!==P.indexOf("WebGL")?(N=parseFloat(/^WebGL (\d)/.exec(P)[1]),R=N>=1):-1!==P.indexOf("OpenGL ES")&&(N=parseFloat(/^OpenGL ES (\d)/.exec(P)[1]),R=N>=2);let D=null,L={};const I=e.getParameter(e.SCISSOR_BOX),k=e.getParameter(e.VIEWPORT),O=(new nu).fromArray(I),U=(new nu).fromArray(k);function F(t,n,i,r){const s=new Uint8Array(4),o=e.createTexture();e.bindTexture(t,o),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let o=0;o<i;o++)t===e.TEXTURE_3D||t===e.TEXTURE_2D_ARRAY?e.texImage3D(n,0,e.RGBA,1,1,r,0,e.RGBA,e.UNSIGNED_BYTE,s):e.texImage2D(n+o,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,s);return o}const B={};function z(t){!0!==a[t]&&(e.enable(t),a[t]=!0)}function V(t){!1!==a[t]&&(e.disable(t),a[t]=!1)}B[e.TEXTURE_2D]=F(e.TEXTURE_2D,e.TEXTURE_2D,1),B[e.TEXTURE_CUBE_MAP]=F(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),B[e.TEXTURE_2D_ARRAY]=F(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),B[e.TEXTURE_3D]=F(e.TEXTURE_3D,e.TEXTURE_3D,1,1),n.setClear(0,0,0,1),i.setClear(1),r.setClear(0),z(e.DEPTH_TEST),i.setFunc(3),W(!1),q(1),z(e.CULL_FACE),H(0);const G={[pa]:e.FUNC_ADD,[fa]:e.FUNC_SUBTRACT,[ma]:e.FUNC_REVERSE_SUBTRACT};G[103]=e.MIN,G[104]=e.MAX;const j={[ga]:e.ZERO,[ya]:e.ONE,[va]:e.SRC_COLOR,[xa]:e.SRC_ALPHA,[Ea]:e.SRC_ALPHA_SATURATE,[Sa]:e.DST_COLOR,[wa]:e.DST_ALPHA,[_a]:e.ONE_MINUS_SRC_COLOR,[ba]:e.ONE_MINUS_SRC_ALPHA,[Ma]:e.ONE_MINUS_DST_COLOR,[Ta]:e.ONE_MINUS_DST_ALPHA,[Aa]:e.CONSTANT_COLOR,[Ca]:e.ONE_MINUS_CONSTANT_COLOR,[Ra]:e.CONSTANT_ALPHA,[Na]:e.ONE_MINUS_CONSTANT_ALPHA};function H(t,n,i,r,s,o,a,l,c,u){if(0!==t){if(!1===d&&(z(e.BLEND),d=!0),5===t)s=s||n,o=o||i,a=a||r,n===f&&s===y||(e.blendEquationSeparate(G[n],G[s]),f=n,y=s),i===m&&r===g&&o===v&&a===_||(e.blendFuncSeparate(j[i],j[r],j[o],j[a]),m=i,g=r,v=o,_=a),!1!==l.equals(x)&&c===b||(e.blendColor(l.r,l.g,l.b,c),x.copy(l),b=c),p=t,w=!1;else if(t!==p||u!==w){if(f===pa&&y===pa||(e.blendEquation(e.FUNC_ADD),f=pa,y=pa),u)switch(t){case 1:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.ONE,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}else switch(t){case 1:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.SRC_ALPHA,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFunc(e.ZERO,e.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}m=null,g=null,v=null,_=null,x.set(0,0,0),b=0,p=t,w=u}}else!0===d&&(V(e.BLEND),d=!1)}function W(t){T!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),T=t)}function q(t){0!==t?(z(e.CULL_FACE),t!==S&&(1===t?e.cullFace(e.BACK):2===t?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):V(e.CULL_FACE),S=t}function X(t,n,i){t?(z(e.POLYGON_OFFSET_FILL),E===n&&A===i||(e.polygonOffset(n,i),E=n,A=i)):V(e.POLYGON_OFFSET_FILL)}return{buffers:{color:n,depth:i,stencil:r},enable:z,disable:V,bindFramebuffer:function(t,n){return l[t]!==n&&(e.bindFramebuffer(t,n),l[t]=n,t===e.DRAW_FRAMEBUFFER&&(l[e.FRAMEBUFFER]=n),t===e.FRAMEBUFFER&&(l[e.DRAW_FRAMEBUFFER]=n),!0)},drawBuffers:function(t,n){let i=u,r=!1;if(t){i=c.get(n),void 0===i&&(i=[],c.set(n,i));const s=t.textures;if(i.length!==s.length||i[0]!==e.COLOR_ATTACHMENT0){for(let t=0,n=s.length;t<n;t++)i[t]=e.COLOR_ATTACHMENT0+t;i.length=s.length,r=!0}}else i[0]!==e.BACK&&(i[0]=e.BACK,r=!0);r&&e.drawBuffers(i)},useProgram:function(t){return h!==t&&(e.useProgram(t),h=t,!0)},setBlending:H,setMaterial:function(t,s){2===t.side?V(e.CULL_FACE):z(e.CULL_FACE);let o=1===t.side;s&&(o=!o),W(o),1===t.blending&&!1===t.transparent?H(0):H(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.blendColor,t.blendAlpha,t.premultipliedAlpha),i.setFunc(t.depthFunc),i.setTest(t.depthTest),i.setMask(t.depthWrite),n.setMask(t.colorWrite);const a=t.stencilWrite;r.setTest(a),a&&(r.setMask(t.stencilWriteMask),r.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),r.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),X(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),!0===t.alphaToCoverage?z(e.SAMPLE_ALPHA_TO_COVERAGE):V(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:W,setCullFace:q,setLineWidth:function(t){t!==M&&(R&&e.lineWidth(t),M=t)},setPolygonOffset:X,setScissorTest:function(t){t?z(e.SCISSOR_TEST):V(e.SCISSOR_TEST)},activeTexture:function(t){void 0===t&&(t=e.TEXTURE0+C-1),D!==t&&(e.activeTexture(t),D=t)},bindTexture:function(t,n,i){void 0===i&&(i=null===D?e.TEXTURE0+C-1:D);let r=L[i];void 0===r&&(r={type:void 0,texture:void 0},L[i]=r),r.type===t&&r.texture===n||(D!==i&&(e.activeTexture(i),D=i),e.bindTexture(t,n||B[t]),r.type=t,r.texture=n)},unbindTexture:function(){const t=L[D];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexImage3D:function(){try{e.compressedTexImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function(){try{e.texImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage3D:function(){try{e.texImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},updateUBOMapping:function(t,n){let i=o.get(n);void 0===i&&(i=new WeakMap,o.set(n,i));let r=i.get(t);void 0===r&&(r=e.getUniformBlockIndex(n,t.name),i.set(t,r))},uniformBlockBinding:function(t,n){const i=o.get(n).get(t);s.get(n)!==i&&(e.uniformBlockBinding(n,i,t.__bindingPointIndex),s.set(n,i))},texStorage2D:function(){try{e.texStorage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texStorage3D:function(){try{e.texStorage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage2D:function(){try{e.texSubImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage3D:function(){try{e.texSubImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function(t){!1===O.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),O.copy(t))},viewport:function(t){!1===U.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),U.copy(t))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),i.setReversed(!1),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),a={},D=null,L={},l={},c=new WeakMap,u=[],h=null,d=!1,p=null,f=null,m=null,g=null,y=null,v=null,_=null,x=new Eh(0,0,0),b=0,w=!1,T=null,S=null,M=null,E=null,A=null,O.set(0,0,e.canvas.width,e.canvas.height),U.set(0,0,e.canvas.width,e.canvas.height),n.reset(),i.reset(),r.reset()}}}function Wg(e,t,n,i,r,s,o){const a=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,l="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),c=new Nc,u=new WeakMap;let h;const d=new WeakMap;let p=!1;try{p="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function f(e,t){return p?new OffscreenCanvas(e,t):Fc("canvas")}function m(e,t,n){let i=1;const r=j(e);if((r.width>n||r.height>n)&&(i=n/Math.max(r.width,r.height)),i<1){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame){const n=Math.floor(i*r.width),s=Math.floor(i*r.height);void 0===h&&(h=f(n,s));const o=t?f(n,s):h;o.width=n,o.height=s;return o.getContext("2d").drawImage(e,0,0,n,s),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+r.width+"x"+r.height+") to ("+n+"x"+s+")."),o}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+r.width+"x"+r.height+")."),e}return e}function g(e){return e.generateMipmaps}function y(t){e.generateMipmap(t)}function v(t){return t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:t.isWebGL3DRenderTarget?e.TEXTURE_3D:t.isWebGLArrayRenderTarget||t.isCompressedArrayTexture?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D}function _(n,i,r,s,o=!1){if(null!==n){if(void 0!==e[n])return e[n];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+n+"'")}let a=i;if(i===e.RED&&(r===e.FLOAT&&(a=e.R32F),r===e.HALF_FLOAT&&(a=e.R16F),r===e.UNSIGNED_BYTE&&(a=e.R8)),i===e.RED_INTEGER&&(r===e.UNSIGNED_BYTE&&(a=e.R8UI),r===e.UNSIGNED_SHORT&&(a=e.R16UI),r===e.UNSIGNED_INT&&(a=e.R32UI),r===e.BYTE&&(a=e.R8I),r===e.SHORT&&(a=e.R16I),r===e.INT&&(a=e.R32I)),i===e.RG&&(r===e.FLOAT&&(a=e.RG32F),r===e.HALF_FLOAT&&(a=e.RG16F),r===e.UNSIGNED_BYTE&&(a=e.RG8)),i===e.RG_INTEGER&&(r===e.UNSIGNED_BYTE&&(a=e.RG8UI),r===e.UNSIGNED_SHORT&&(a=e.RG16UI),r===e.UNSIGNED_INT&&(a=e.RG32UI),r===e.BYTE&&(a=e.RG8I),r===e.SHORT&&(a=e.RG16I),r===e.INT&&(a=e.RG32I)),i===e.RGB_INTEGER&&(r===e.UNSIGNED_BYTE&&(a=e.RGB8UI),r===e.UNSIGNED_SHORT&&(a=e.RGB16UI),r===e.UNSIGNED_INT&&(a=e.RGB32UI),r===e.BYTE&&(a=e.RGB8I),r===e.SHORT&&(a=e.RGB16I),r===e.INT&&(a=e.RGB32I)),i===e.RGBA_INTEGER&&(r===e.UNSIGNED_BYTE&&(a=e.RGBA8UI),r===e.UNSIGNED_SHORT&&(a=e.RGBA16UI),r===e.UNSIGNED_INT&&(a=e.RGBA32UI),r===e.BYTE&&(a=e.RGBA8I),r===e.SHORT&&(a=e.RGBA16I),r===e.INT&&(a=e.RGBA32I)),i===e.RGB&&r===e.UNSIGNED_INT_5_9_9_9_REV&&(a=e.RGB9_E5),i===e.RGBA){const t=o?nc:Wc.getTransfer(s);r===e.FLOAT&&(a=e.RGBA32F),r===e.HALF_FLOAT&&(a=e.RGBA16F),r===e.UNSIGNED_BYTE&&(a=t===ic?e.SRGB8_ALPHA8:e.RGBA8),r===e.UNSIGNED_SHORT_4_4_4_4&&(a=e.RGBA4),r===e.UNSIGNED_SHORT_5_5_5_1&&(a=e.RGB5_A1)}return a!==e.R16F&&a!==e.R32F&&a!==e.RG16F&&a!==e.RG32F&&a!==e.RGBA16F&&a!==e.RGBA32F||t.get("EXT_color_buffer_float"),a}function x(t,n){let i;return t?null===n||n===rl||n===cl?i=e.DEPTH24_STENCIL8:n===sl?i=e.DEPTH32F_STENCIL8:n===nl&&(i=e.DEPTH24_STENCIL8,console.warn("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):null===n||n===rl||n===cl?i=e.DEPTH_COMPONENT24:n===sl?i=e.DEPTH_COMPONENT32F:n===nl&&(i=e.DEPTH_COMPONENT16),i}function b(e,t){return!0===g(e)||e.isFramebufferTexture&&e.minFilter!==Xa&&e.minFilter!==Ka?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function w(e){const t=e.target;t.removeEventListener("dispose",w),function(e){const t=i.get(e);if(void 0===t.__webglInit)return;const n=e.source,r=d.get(n);if(r){const i=r[t.__cacheKey];i.usedTimes--,0===i.usedTimes&&S(e),0===Object.keys(r).length&&d.delete(n)}i.remove(e)}(t),t.isVideoTexture&&u.delete(t)}function T(t){const n=t.target;n.removeEventListener("dispose",T),function(t){const n=i.get(t);t.depthTexture&&(t.depthTexture.dispose(),i.remove(t.depthTexture));if(t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++){if(Array.isArray(n.__webglFramebuffer[t]))for(let i=0;i<n.__webglFramebuffer[t].length;i++)e.deleteFramebuffer(n.__webglFramebuffer[t][i]);else e.deleteFramebuffer(n.__webglFramebuffer[t]);n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer[t])}else{if(Array.isArray(n.__webglFramebuffer))for(let t=0;t<n.__webglFramebuffer.length;t++)e.deleteFramebuffer(n.__webglFramebuffer[t]);else e.deleteFramebuffer(n.__webglFramebuffer);if(n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer),n.__webglMultisampledFramebuffer&&e.deleteFramebuffer(n.__webglMultisampledFramebuffer),n.__webglColorRenderbuffer)for(let t=0;t<n.__webglColorRenderbuffer.length;t++)n.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(n.__webglColorRenderbuffer[t]);n.__webglDepthRenderbuffer&&e.deleteRenderbuffer(n.__webglDepthRenderbuffer)}const r=t.textures;for(let t=0,n=r.length;t<n;t++){const n=i.get(r[t]);n.__webglTexture&&(e.deleteTexture(n.__webglTexture),o.memory.textures--),i.remove(r[t])}i.remove(t)}(n)}function S(t){const n=i.get(t);e.deleteTexture(n.__webglTexture);const r=t.source;delete d.get(r)[n.__cacheKey],o.memory.textures--}let M=0;function E(t,r){const s=i.get(t);if(t.isVideoTexture&&function(e){const t=o.render.frame;u.get(e)!==t&&(u.set(e,t),e.update())}(t),!1===t.isRenderTargetTexture&&t.version>0&&s.__version!==t.version){const e=t.image;if(null===e)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==e.complete)return void L(s,t,r);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}n.bindTexture(e.TEXTURE_2D,s.__webglTexture,e.TEXTURE0+r)}const A={[Ha]:e.REPEAT,[Wa]:e.CLAMP_TO_EDGE,[qa]:e.MIRRORED_REPEAT},C={[Xa]:e.NEAREST,[$a]:e.NEAREST_MIPMAP_NEAREST,[Ya]:e.NEAREST_MIPMAP_LINEAR,[Ka]:e.LINEAR,[Za]:e.LINEAR_MIPMAP_NEAREST,[Ja]:e.LINEAR_MIPMAP_LINEAR},R={[sc]:e.NEVER,[dc]:e.ALWAYS,[oc]:e.LESS,[lc]:e.LEQUAL,[ac]:e.EQUAL,[hc]:e.GEQUAL,[cc]:e.GREATER,[uc]:e.NOTEQUAL};function N(n,s){if(s.type!==sl||!1!==t.has("OES_texture_float_linear")||s.magFilter!==Ka&&s.magFilter!==Za&&s.magFilter!==Ya&&s.magFilter!==Ja&&s.minFilter!==Ka&&s.minFilter!==Za&&s.minFilter!==Ya&&s.minFilter!==Ja||console.warn("THREE.WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),e.texParameteri(n,e.TEXTURE_WRAP_S,A[s.wrapS]),e.texParameteri(n,e.TEXTURE_WRAP_T,A[s.wrapT]),n!==e.TEXTURE_3D&&n!==e.TEXTURE_2D_ARRAY||e.texParameteri(n,e.TEXTURE_WRAP_R,A[s.wrapR]),e.texParameteri(n,e.TEXTURE_MAG_FILTER,C[s.magFilter]),e.texParameteri(n,e.TEXTURE_MIN_FILTER,C[s.minFilter]),s.compareFunction&&(e.texParameteri(n,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(n,e.TEXTURE_COMPARE_FUNC,R[s.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){if(s.magFilter===Xa)return;if(s.minFilter!==Ya&&s.minFilter!==Ja)return;if(s.type===sl&&!1===t.has("OES_texture_float_linear"))return;if(s.anisotropy>1||i.get(s).__currentAnisotropy){const o=t.get("EXT_texture_filter_anisotropic");e.texParameterf(n,o.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s.anisotropy,r.getMaxAnisotropy())),i.get(s).__currentAnisotropy=s.anisotropy}}}function P(t,n){let i=!1;void 0===t.__webglInit&&(t.__webglInit=!0,n.addEventListener("dispose",w));const r=n.source;let s=d.get(r);void 0===s&&(s={},d.set(r,s));const a=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(n);if(a!==t.__cacheKey){void 0===s[a]&&(s[a]={texture:e.createTexture(),usedTimes:0},o.memory.textures++,i=!0),s[a].usedTimes++;const r=s[t.__cacheKey];void 0!==r&&(s[t.__cacheKey].usedTimes--,0===r.usedTimes&&S(n)),t.__cacheKey=a,t.__webglTexture=s[a].texture}return i}function D(e,t,n){return Math.floor(Math.floor(e/n)/t)}function L(t,o,a){let l=e.TEXTURE_2D;(o.isDataArrayTexture||o.isCompressedArrayTexture)&&(l=e.TEXTURE_2D_ARRAY),o.isData3DTexture&&(l=e.TEXTURE_3D);const c=P(t,o),u=o.source;n.bindTexture(l,t.__webglTexture,e.TEXTURE0+a);const h=i.get(u);if(u.version!==h.__version||!0===c){n.activeTexture(e.TEXTURE0+a);const t=Wc.getPrimaries(Wc.workingColorSpace),i=o.colorSpace===Ql?null:Wc.getPrimaries(o.colorSpace),d=o.colorSpace===Ql||t===i?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,o.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,o.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,d);let p=m(o.image,!1,r.maxTextureSize);p=G(o,p);const f=s.convert(o.format,o.colorSpace),v=s.convert(o.type);let w,T=_(o.internalFormat,f,v,o.colorSpace,o.isVideoTexture);N(l,o);const S=o.mipmaps,M=!0!==o.isVideoTexture,E=void 0===h.__version||!0===c,A=u.dataReady,C=b(o,p);if(o.isDepthTexture)T=x(o.format===ml,o.type),E&&(M?n.texStorage2D(e.TEXTURE_2D,1,T,p.width,p.height):n.texImage2D(e.TEXTURE_2D,0,T,p.width,p.height,0,f,v,null));else if(o.isDataTexture)if(S.length>0){M&&E&&n.texStorage2D(e.TEXTURE_2D,C,T,S[0].width,S[0].height);for(let t=0,i=S.length;t<i;t++)w=S[t],M?A&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,w.width,w.height,f,v,w.data):n.texImage2D(e.TEXTURE_2D,t,T,w.width,w.height,0,f,v,w.data);o.generateMipmaps=!1}else M?(E&&n.texStorage2D(e.TEXTURE_2D,C,T,p.width,p.height),A&&function(t,i,r,s){const o=t.updateRanges;if(0===o.length)n.texSubImage2D(e.TEXTURE_2D,0,0,0,i.width,i.height,r,s,i.data);else{o.sort(((e,t)=>e.start-t.start));let a=0;for(let e=1;e<o.length;e++){const t=o[a],n=o[e],r=t.start+t.count,s=D(n.start,i.width,4),l=D(t.start,i.width,4);n.start<=r+1&&s===l&&D(n.start+n.count-1,i.width,4)===s?t.count=Math.max(t.count,n.start+n.count-t.start):(++a,o[a]=n)}o.length=a+1;const l=e.getParameter(e.UNPACK_ROW_LENGTH),c=e.getParameter(e.UNPACK_SKIP_PIXELS),u=e.getParameter(e.UNPACK_SKIP_ROWS);e.pixelStorei(e.UNPACK_ROW_LENGTH,i.width);for(let t=0,a=o.length;t<a;t++){const a=o[t],l=Math.floor(a.start/4),c=Math.ceil(a.count/4),u=l%i.width,h=Math.floor(l/i.width),d=c,p=1;e.pixelStorei(e.UNPACK_SKIP_PIXELS,u),e.pixelStorei(e.UNPACK_SKIP_ROWS,h),n.texSubImage2D(e.TEXTURE_2D,0,u,h,d,p,r,s,i.data)}t.clearUpdateRanges(),e.pixelStorei(e.UNPACK_ROW_LENGTH,l),e.pixelStorei(e.UNPACK_SKIP_PIXELS,c),e.pixelStorei(e.UNPACK_SKIP_ROWS,u)}}(o,p,f,v)):n.texImage2D(e.TEXTURE_2D,0,T,p.width,p.height,0,f,v,p.data);else if(o.isCompressedTexture)if(o.isCompressedArrayTexture){M&&E&&n.texStorage3D(e.TEXTURE_2D_ARRAY,C,T,S[0].width,S[0].height,p.depth);for(let t=0,i=S.length;t<i;t++)if(w=S[t],o.format!==pl)if(null!==f)if(M){if(A)if(o.layerUpdates.size>0){const i=gf(w.width,w.height,o.format,o.type);for(const r of o.layerUpdates){const s=w.data.subarray(r*i/w.data.BYTES_PER_ELEMENT,(r+1)*i/w.data.BYTES_PER_ELEMENT);n.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,r,w.width,w.height,1,f,s)}o.clearLayerUpdates()}else n.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,w.width,w.height,p.depth,f,w.data)}else n.compressedTexImage3D(e.TEXTURE_2D_ARRAY,t,T,w.width,w.height,p.depth,0,w.data,0,0);else console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else M?A&&n.texSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,w.width,w.height,p.depth,f,v,w.data):n.texImage3D(e.TEXTURE_2D_ARRAY,t,T,w.width,w.height,p.depth,0,f,v,w.data)}else{M&&E&&n.texStorage2D(e.TEXTURE_2D,C,T,S[0].width,S[0].height);for(let t=0,i=S.length;t<i;t++)w=S[t],o.format!==pl?null!==f?M?A&&n.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,w.width,w.height,f,w.data):n.compressedTexImage2D(e.TEXTURE_2D,t,T,w.width,w.height,0,w.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):M?A&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,w.width,w.height,f,v,w.data):n.texImage2D(e.TEXTURE_2D,t,T,w.width,w.height,0,f,v,w.data)}else if(o.isDataArrayTexture)if(M){if(E&&n.texStorage3D(e.TEXTURE_2D_ARRAY,C,T,p.width,p.height,p.depth),A)if(o.layerUpdates.size>0){const t=gf(p.width,p.height,o.format,o.type);for(const i of o.layerUpdates){const r=p.data.subarray(i*t/p.data.BYTES_PER_ELEMENT,(i+1)*t/p.data.BYTES_PER_ELEMENT);n.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,i,p.width,p.height,1,f,v,r)}o.clearLayerUpdates()}else n.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,p.width,p.height,p.depth,f,v,p.data)}else n.texImage3D(e.TEXTURE_2D_ARRAY,0,T,p.width,p.height,p.depth,0,f,v,p.data);else if(o.isData3DTexture)M?(E&&n.texStorage3D(e.TEXTURE_3D,C,T,p.width,p.height,p.depth),A&&n.texSubImage3D(e.TEXTURE_3D,0,0,0,0,p.width,p.height,p.depth,f,v,p.data)):n.texImage3D(e.TEXTURE_3D,0,T,p.width,p.height,p.depth,0,f,v,p.data);else if(o.isFramebufferTexture){if(E)if(M)n.texStorage2D(e.TEXTURE_2D,C,T,p.width,p.height);else{let t=p.width,i=p.height;for(let r=0;r<C;r++)n.texImage2D(e.TEXTURE_2D,r,T,t,i,0,f,v,null),t>>=1,i>>=1}}else if(S.length>0){if(M&&E){const t=j(S[0]);n.texStorage2D(e.TEXTURE_2D,C,T,t.width,t.height)}for(let t=0,i=S.length;t<i;t++)w=S[t],M?A&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,f,v,w):n.texImage2D(e.TEXTURE_2D,t,T,f,v,w);o.generateMipmaps=!1}else if(M){if(E){const t=j(p);n.texStorage2D(e.TEXTURE_2D,C,T,t.width,t.height)}A&&n.texSubImage2D(e.TEXTURE_2D,0,0,0,f,v,p)}else n.texImage2D(e.TEXTURE_2D,0,T,f,v,p);g(o)&&y(l),h.__version=u.version,o.onUpdate&&o.onUpdate(o)}t.__version=o.version}function I(t,r,o,l,c,u){const h=s.convert(o.format,o.colorSpace),d=s.convert(o.type),p=_(o.internalFormat,h,d,o.colorSpace),f=i.get(r),m=i.get(o);if(m.__renderTarget=r,!f.__hasExternalTextures){const t=Math.max(1,r.width>>u),i=Math.max(1,r.height>>u);c===e.TEXTURE_3D||c===e.TEXTURE_2D_ARRAY?n.texImage3D(c,u,p,t,i,r.depth,0,h,d,null):n.texImage2D(c,u,p,t,i,0,h,d,null)}n.bindFramebuffer(e.FRAMEBUFFER,t),V(r)?a.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,l,c,m.__webglTexture,0,z(r)):(c===e.TEXTURE_2D||c>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&c<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,l,c,m.__webglTexture,u),n.bindFramebuffer(e.FRAMEBUFFER,null)}function k(t,n,i){if(e.bindRenderbuffer(e.RENDERBUFFER,t),n.depthBuffer){const r=n.depthTexture,s=r&&r.isDepthTexture?r.type:null,o=x(n.stencilBuffer,s),l=n.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,c=z(n);V(n)?a.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,c,o,n.width,n.height):i?e.renderbufferStorageMultisample(e.RENDERBUFFER,c,o,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,o,n.width,n.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,l,e.RENDERBUFFER,t)}else{const t=n.textures;for(let r=0;r<t.length;r++){const o=t[r],l=s.convert(o.format,o.colorSpace),c=s.convert(o.type),u=_(o.internalFormat,l,c,o.colorSpace),h=z(n);i&&!1===V(n)?e.renderbufferStorageMultisample(e.RENDERBUFFER,h,u,n.width,n.height):V(n)?a.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,h,u,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,u,n.width,n.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function O(t,r){if(r&&r.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(n.bindFramebuffer(e.FRAMEBUFFER,t),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const s=i.get(r.depthTexture);s.__renderTarget=r,s.__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),E(r.depthTexture,0);const o=s.__webglTexture,l=z(r);if(r.depthTexture.format===fl)V(r)?a.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o,0);else{if(r.depthTexture.format!==ml)throw new Error("Unknown depthTexture format");V(r)?a.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,o,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,o,0)}}function U(t){const r=i.get(t),s=!0===t.isWebGLCubeRenderTarget;if(r.__boundDepthTexture!==t.depthTexture){const e=t.depthTexture;if(r.__depthDisposeCallback&&r.__depthDisposeCallback(),e){const t=()=>{delete r.__boundDepthTexture,delete r.__depthDisposeCallback,e.removeEventListener("dispose",t)};e.addEventListener("dispose",t),r.__depthDisposeCallback=t}r.__boundDepthTexture=e}if(t.depthTexture&&!r.__autoAllocateDepthBuffer){if(s)throw new Error("target.depthTexture not supported in Cube render targets");const e=t.texture.mipmaps;e&&e.length>0?O(r.__webglFramebuffer[0],t):O(r.__webglFramebuffer,t)}else if(s){r.__webglDepthbuffer=[];for(let i=0;i<6;i++)if(n.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer[i]),void 0===r.__webglDepthbuffer[i])r.__webglDepthbuffer[i]=e.createRenderbuffer(),k(r.__webglDepthbuffer[i],t,!1);else{const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,s=r.__webglDepthbuffer[i];e.bindRenderbuffer(e.RENDERBUFFER,s),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,s)}}else{const i=t.texture.mipmaps;if(i&&i.length>0?n.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer[0]):n.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer),void 0===r.__webglDepthbuffer)r.__webglDepthbuffer=e.createRenderbuffer(),k(r.__webglDepthbuffer,t,!1);else{const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,i=r.__webglDepthbuffer;e.bindRenderbuffer(e.RENDERBUFFER,i),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,i)}}n.bindFramebuffer(e.FRAMEBUFFER,null)}const F=[],B=[];function z(e){return Math.min(r.maxSamples,e.samples)}function V(e){const n=i.get(e);return e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==n.__useRenderToTexture}function G(e,t){const n=e.colorSpace,i=e.format,r=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||n!==tc&&n!==Ql&&(Wc.getTransfer(n)===ic?i===pl&&r===Qa||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",n)),t}function j(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?(c.width=e.naturalWidth||e.width,c.height=e.naturalHeight||e.height):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?(c.width=e.displayWidth,c.height=e.displayHeight):(c.width=e.width,c.height=e.height),c}this.allocateTextureUnit=function(){const e=M;return e>=r.maxTextures&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+r.maxTextures),M+=1,e},this.resetTextureUnits=function(){M=0},this.setTexture2D=E,this.setTexture2DArray=function(t,r){const s=i.get(t);t.version>0&&s.__version!==t.version?L(s,t,r):n.bindTexture(e.TEXTURE_2D_ARRAY,s.__webglTexture,e.TEXTURE0+r)},this.setTexture3D=function(t,r){const s=i.get(t);t.version>0&&s.__version!==t.version?L(s,t,r):n.bindTexture(e.TEXTURE_3D,s.__webglTexture,e.TEXTURE0+r)},this.setTextureCube=function(t,o){const a=i.get(t);t.version>0&&a.__version!==t.version?function(t,o,a){if(6!==o.image.length)return;const l=P(t,o),c=o.source;n.bindTexture(e.TEXTURE_CUBE_MAP,t.__webglTexture,e.TEXTURE0+a);const u=i.get(c);if(c.version!==u.__version||!0===l){n.activeTexture(e.TEXTURE0+a);const t=Wc.getPrimaries(Wc.workingColorSpace),i=o.colorSpace===Ql?null:Wc.getPrimaries(o.colorSpace),h=o.colorSpace===Ql||t===i?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,o.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,o.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,h);const d=o.isCompressedTexture||o.image[0].isCompressedTexture,p=o.image[0]&&o.image[0].isDataTexture,f=[];for(let e=0;e<6;e++)f[e]=d||p?p?o.image[e].image:o.image[e]:m(o.image[e],!0,r.maxCubemapSize),f[e]=G(o,f[e]);const v=f[0],x=s.convert(o.format,o.colorSpace),w=s.convert(o.type),T=_(o.internalFormat,x,w,o.colorSpace),S=!0!==o.isVideoTexture,M=void 0===u.__version||!0===l,E=c.dataReady;let A,C=b(o,v);if(N(e.TEXTURE_CUBE_MAP,o),d){S&&M&&n.texStorage2D(e.TEXTURE_CUBE_MAP,C,T,v.width,v.height);for(let t=0;t<6;t++){A=f[t].mipmaps;for(let i=0;i<A.length;i++){const r=A[i];o.format!==pl?null!==x?S?E&&n.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,0,0,r.width,r.height,x,r.data):n.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,T,r.width,r.height,0,r.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):S?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,0,0,r.width,r.height,x,w,r.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,T,r.width,r.height,0,x,w,r.data)}}}else{if(A=o.mipmaps,S&&M){A.length>0&&C++;const t=j(f[0]);n.texStorage2D(e.TEXTURE_CUBE_MAP,C,T,t.width,t.height)}for(let t=0;t<6;t++)if(p){S?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,f[t].width,f[t].height,x,w,f[t].data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,T,f[t].width,f[t].height,0,x,w,f[t].data);for(let i=0;i<A.length;i++){const r=A[i].image[t].image;S?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,0,0,r.width,r.height,x,w,r.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,T,r.width,r.height,0,x,w,r.data)}}else{S?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,x,w,f[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,T,x,w,f[t]);for(let i=0;i<A.length;i++){const r=A[i];S?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,0,0,x,w,r.image[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,T,x,w,r.image[t])}}}g(o)&&y(e.TEXTURE_CUBE_MAP),u.__version=c.version,o.onUpdate&&o.onUpdate(o)}t.__version=o.version}(a,t,o):n.bindTexture(e.TEXTURE_CUBE_MAP,a.__webglTexture,e.TEXTURE0+o)},this.rebindTextures=function(t,n,r){const s=i.get(t);void 0!==n&&I(s.__webglFramebuffer,t,t.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==r&&U(t)},this.setupRenderTarget=function(t){const r=t.texture,a=i.get(t),l=i.get(r);t.addEventListener("dispose",T);const c=t.textures,u=!0===t.isWebGLCubeRenderTarget,h=c.length>1;if(h||(void 0===l.__webglTexture&&(l.__webglTexture=e.createTexture()),l.__version=r.version,o.memory.textures++),u){a.__webglFramebuffer=[];for(let t=0;t<6;t++)if(r.mipmaps&&r.mipmaps.length>0){a.__webglFramebuffer[t]=[];for(let n=0;n<r.mipmaps.length;n++)a.__webglFramebuffer[t][n]=e.createFramebuffer()}else a.__webglFramebuffer[t]=e.createFramebuffer()}else{if(r.mipmaps&&r.mipmaps.length>0){a.__webglFramebuffer=[];for(let t=0;t<r.mipmaps.length;t++)a.__webglFramebuffer[t]=e.createFramebuffer()}else a.__webglFramebuffer=e.createFramebuffer();if(h)for(let t=0,n=c.length;t<n;t++){const n=i.get(c[t]);void 0===n.__webglTexture&&(n.__webglTexture=e.createTexture(),o.memory.textures++)}if(t.samples>0&&!1===V(t)){a.__webglMultisampledFramebuffer=e.createFramebuffer(),a.__webglColorRenderbuffer=[],n.bindFramebuffer(e.FRAMEBUFFER,a.__webglMultisampledFramebuffer);for(let n=0;n<c.length;n++){const i=c[n];a.__webglColorRenderbuffer[n]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,a.__webglColorRenderbuffer[n]);const r=s.convert(i.format,i.colorSpace),o=s.convert(i.type),l=_(i.internalFormat,r,o,i.colorSpace,!0===t.isXRRenderTarget),u=z(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,u,l,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n,e.RENDERBUFFER,a.__webglColorRenderbuffer[n])}e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(a.__webglDepthRenderbuffer=e.createRenderbuffer(),k(a.__webglDepthRenderbuffer,t,!0)),n.bindFramebuffer(e.FRAMEBUFFER,null)}}if(u){n.bindTexture(e.TEXTURE_CUBE_MAP,l.__webglTexture),N(e.TEXTURE_CUBE_MAP,r);for(let n=0;n<6;n++)if(r.mipmaps&&r.mipmaps.length>0)for(let i=0;i<r.mipmaps.length;i++)I(a.__webglFramebuffer[n][i],t,r,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,i);else I(a.__webglFramebuffer[n],t,r,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0);g(r)&&y(e.TEXTURE_CUBE_MAP),n.unbindTexture()}else if(h){for(let r=0,s=c.length;r<s;r++){const s=c[r],o=i.get(s);n.bindTexture(e.TEXTURE_2D,o.__webglTexture),N(e.TEXTURE_2D,s),I(a.__webglFramebuffer,t,s,e.COLOR_ATTACHMENT0+r,e.TEXTURE_2D,0),g(s)&&y(e.TEXTURE_2D)}n.unbindTexture()}else{let i=e.TEXTURE_2D;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(i=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),n.bindTexture(i,l.__webglTexture),N(i,r),r.mipmaps&&r.mipmaps.length>0)for(let n=0;n<r.mipmaps.length;n++)I(a.__webglFramebuffer[n],t,r,e.COLOR_ATTACHMENT0,i,n);else I(a.__webglFramebuffer,t,r,e.COLOR_ATTACHMENT0,i,0);g(r)&&y(i),n.unbindTexture()}t.depthBuffer&&U(t)},this.updateRenderTargetMipmap=function(e){const t=e.textures;for(let r=0,s=t.length;r<s;r++){const s=t[r];if(g(s)){const t=v(e),r=i.get(s).__webglTexture;n.bindTexture(t,r),y(t),n.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(t.samples>0)if(!1===V(t)){const r=t.textures,s=t.width,o=t.height;let a=e.COLOR_BUFFER_BIT;const c=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,u=i.get(t),h=r.length>1;if(h)for(let t=0;t<r.length;t++)n.bindFramebuffer(e.FRAMEBUFFER,u.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,null),n.bindFramebuffer(e.FRAMEBUFFER,u.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0);n.bindFramebuffer(e.READ_FRAMEBUFFER,u.__webglMultisampledFramebuffer);const d=t.texture.mipmaps;d&&d.length>0?n.bindFramebuffer(e.DRAW_FRAMEBUFFER,u.__webglFramebuffer[0]):n.bindFramebuffer(e.DRAW_FRAMEBUFFER,u.__webglFramebuffer);for(let n=0;n<r.length;n++){if(t.resolveDepthBuffer&&(t.depthBuffer&&(a|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&t.resolveStencilBuffer&&(a|=e.STENCIL_BUFFER_BIT)),h){e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,u.__webglColorRenderbuffer[n]);const t=i.get(r[n]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)}e.blitFramebuffer(0,0,s,o,0,0,s,o,a,e.NEAREST),!0===l&&(F.length=0,B.length=0,F.push(e.COLOR_ATTACHMENT0+n),t.depthBuffer&&!1===t.resolveDepthBuffer&&(F.push(c),B.push(c),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,B)),e.invalidateFramebuffer(e.READ_FRAMEBUFFER,F))}if(n.bindFramebuffer(e.READ_FRAMEBUFFER,null),n.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),h)for(let t=0;t<r.length;t++){n.bindFramebuffer(e.FRAMEBUFFER,u.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,u.__webglColorRenderbuffer[t]);const s=i.get(r[t]).__webglTexture;n.bindFramebuffer(e.FRAMEBUFFER,u.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,s,0)}n.bindFramebuffer(e.DRAW_FRAMEBUFFER,u.__webglMultisampledFramebuffer)}else if(t.depthBuffer&&!1===t.resolveDepthBuffer&&l){const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[n])}},this.setupDepthRenderbuffer=U,this.setupFrameBufferTexture=I,this.useMultisampledRTT=V}function qg(e,t){return{convert:function(n,i=""){let r;const s=Wc.getTransfer(i);if(n===Qa)return e.UNSIGNED_BYTE;if(n===al)return e.UNSIGNED_SHORT_4_4_4_4;if(n===ll)return e.UNSIGNED_SHORT_5_5_5_1;if(n===ul)return e.UNSIGNED_INT_5_9_9_9_REV;if(n===el)return e.BYTE;if(n===tl)return e.SHORT;if(n===nl)return e.UNSIGNED_SHORT;if(n===il)return e.INT;if(n===rl)return e.UNSIGNED_INT;if(n===sl)return e.FLOAT;if(n===ol)return e.HALF_FLOAT;if(n===hl)return e.ALPHA;if(n===dl)return e.RGB;if(n===pl)return e.RGBA;if(n===fl)return e.DEPTH_COMPONENT;if(n===ml)return e.DEPTH_STENCIL;if(n===gl)return e.RED;if(n===yl)return e.RED_INTEGER;if(n===vl)return e.RG;if(n===_l)return e.RG_INTEGER;if(n===xl)return e.RGBA_INTEGER;if(n===bl||n===wl||n===Tl||n===Sl)if(s===ic){if(r=t.get("WEBGL_compressed_texture_s3tc_srgb"),null===r)return null;if(n===bl)return r.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(n===wl)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(n===Tl)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(n===Sl)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(r=t.get("WEBGL_compressed_texture_s3tc"),null===r)return null;if(n===bl)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(n===wl)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(n===Tl)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(n===Sl)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(n===Ml||n===El||n===Al||n===Cl){if(r=t.get("WEBGL_compressed_texture_pvrtc"),null===r)return null;if(n===Ml)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(n===El)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(n===Al)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(n===Cl)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(n===Rl||n===Nl||n===Pl){if(r=t.get("WEBGL_compressed_texture_etc"),null===r)return null;if(n===Rl||n===Nl)return s===ic?r.COMPRESSED_SRGB8_ETC2:r.COMPRESSED_RGB8_ETC2;if(n===Pl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC}if(n===Dl||n===Ll||n===Il||n===kl||n===Ol||n===Ul||n===Fl||n===Bl||n===zl||n===Vl||n===Gl||n===jl||n===Hl||n===Wl){if(r=t.get("WEBGL_compressed_texture_astc"),null===r)return null;if(n===Dl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:r.COMPRESSED_RGBA_ASTC_4x4_KHR;if(n===Ll)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:r.COMPRESSED_RGBA_ASTC_5x4_KHR;if(n===Il)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:r.COMPRESSED_RGBA_ASTC_5x5_KHR;if(n===kl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:r.COMPRESSED_RGBA_ASTC_6x5_KHR;if(n===Ol)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:r.COMPRESSED_RGBA_ASTC_6x6_KHR;if(n===Ul)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:r.COMPRESSED_RGBA_ASTC_8x5_KHR;if(n===Fl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:r.COMPRESSED_RGBA_ASTC_8x6_KHR;if(n===Bl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:r.COMPRESSED_RGBA_ASTC_8x8_KHR;if(n===zl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:r.COMPRESSED_RGBA_ASTC_10x5_KHR;if(n===Vl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:r.COMPRESSED_RGBA_ASTC_10x6_KHR;if(n===Gl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:r.COMPRESSED_RGBA_ASTC_10x8_KHR;if(n===jl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:r.COMPRESSED_RGBA_ASTC_10x10_KHR;if(n===Hl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:r.COMPRESSED_RGBA_ASTC_12x10_KHR;if(n===Wl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:r.COMPRESSED_RGBA_ASTC_12x12_KHR}if(n===ql||n===Xl||n===$l){if(r=t.get("EXT_texture_compression_bptc"),null===r)return null;if(n===ql)return s===ic?r.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:r.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(n===Xl)return r.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(n===$l)return r.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(n===Yl||n===Kl||n===Zl||n===Jl){if(r=t.get("EXT_texture_compression_rgtc"),null===r)return null;if(n===ql)return r.COMPRESSED_RED_RGTC1_EXT;if(n===Kl)return r.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(n===Zl)return r.COMPRESSED_RED_GREEN_RGTC2_EXT;if(n===Jl)return r.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return n===cl?e.UNSIGNED_INT_24_8:void 0!==e[n]?e[n]:null}}}class Xg{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,t,n){if(null===this.texture){const i=new tu;e.properties.get(i).__webglTexture=t.texture,t.depthNear===n.depthNear&&t.depthFar===n.depthFar||(this.depthNear=t.depthNear,this.depthFar=t.depthFar),this.texture=i}}getMesh(e){if(null!==this.texture&&null===this.mesh){const t=e.cameras[0].viewport,n=new md({vertexShader:"\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}",fragmentShader:"\nuniform sampler2DArray depthColor;\nuniform float depthWidth;\nuniform float depthHeight;\n\nvoid main() {\n\n\tvec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );\n\n\tif ( coord.x >= 1.0 ) {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;\n\n\t} else {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;\n\n\t}\n\n}",uniforms:{depthColor:{value:this.texture},depthWidth:{value:t.z},depthHeight:{value:t.w}}});this.mesh=new ld(new _p(20,20),n)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class $g extends vc{constructor(e,t){super();const n=this;let i=null,r=1,s=null,o="local-floor",a=1,l=null,c=null,u=null,h=null,d=null,p=null;const f=new Xg,m=t.getContextAttributes();let g=null,y=null;const v=[],_=[],x=new Nc;let b=null;const w=new xd;w.viewport=new nu;const T=new xd;T.viewport=new nu;const S=[w,T],M=new sf;let E=null,A=null;function C(e){const t=_.indexOf(e.inputSource);if(-1===t)return;const n=v[t];void 0!==n&&(n.update(e.inputSource,e.frame,l||s),n.dispatchEvent({type:e.type,data:e.inputSource}))}function R(){i.removeEventListener("select",C),i.removeEventListener("selectstart",C),i.removeEventListener("selectend",C),i.removeEventListener("squeeze",C),i.removeEventListener("squeezestart",C),i.removeEventListener("squeezeend",C),i.removeEventListener("end",R),i.removeEventListener("inputsourceschange",N);for(let e=0;e<v.length;e++){const t=_[e];null!==t&&(_[e]=null,v[e].disconnect(t))}E=null,A=null,f.reset(),e.setRenderTarget(g),d=null,h=null,u=null,i=null,y=null,k.stop(),n.isPresenting=!1,e.setPixelRatio(b),e.setSize(x.width,x.height,!1),n.dispatchEvent({type:"sessionend"})}function N(e){for(let t=0;t<e.removed.length;t++){const n=e.removed[t],i=_.indexOf(n);i>=0&&(_[i]=null,v[i].disconnect(n))}for(let t=0;t<e.added.length;t++){const n=e.added[t];let i=_.indexOf(n);if(-1===i){for(let e=0;e<v.length;e++){if(e>=_.length){_.push(n),i=e;break}if(null===_[e]){_[e]=n,i=e;break}}if(-1===i)break}const r=v[i];r&&r.connect(n)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=v[e];return void 0===t&&(t=new Ad,v[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=v[e];return void 0===t&&(t=new Ad,v[e]=t),t.getGripSpace()},this.getHand=function(e){let t=v[e];return void 0===t&&(t=new Ad,v[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){r=e,!0===n.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){o=e,!0===n.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return l||s},this.setReferenceSpace=function(e){l=e},this.getBaseLayer=function(){return null!==h?h:d},this.getBinding=function(){return u},this.getFrame=function(){return p},this.getSession=function(){return i},this.setSession=async function(c){if(i=c,null!==i){g=e.getRenderTarget(),i.addEventListener("select",C),i.addEventListener("selectstart",C),i.addEventListener("selectend",C),i.addEventListener("squeeze",C),i.addEventListener("squeezestart",C),i.addEventListener("squeezeend",C),i.addEventListener("end",R),i.addEventListener("inputsourceschange",N),!0!==m.xrCompatible&&await t.makeXRCompatible(),b=e.getPixelRatio(),e.getSize(x);if("undefined"!=typeof XRWebGLBinding&&"createProjectionLayer"in XRWebGLBinding.prototype){let n=null,s=null,o=null;m.depth&&(o=m.stencil?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT24,n=m.stencil?ml:fl,s=m.stencil?cl:rl);const a={colorFormat:t.RGBA8,depthFormat:o,scaleFactor:r};u=new XRWebGLBinding(i,t),h=u.createProjectionLayer(a),i.updateRenderState({layers:[h]}),e.setPixelRatio(1),e.setSize(h.textureWidth,h.textureHeight,!1),y=new ru(h.textureWidth,h.textureHeight,{format:pl,type:Qa,depthTexture:new ip(h.textureWidth,h.textureHeight,s,void 0,void 0,void 0,void 0,void 0,void 0,n),stencilBuffer:m.stencil,colorSpace:e.outputColorSpace,samples:m.antialias?4:0,resolveDepthBuffer:!1===h.ignoreDepthValues,resolveStencilBuffer:!1===h.ignoreDepthValues})}else{const n={antialias:m.antialias,alpha:!0,depth:m.depth,stencil:m.stencil,framebufferScaleFactor:r};d=new XRWebGLLayer(i,t,n),i.updateRenderState({baseLayer:d}),e.setPixelRatio(1),e.setSize(d.framebufferWidth,d.framebufferHeight,!1),y=new ru(d.framebufferWidth,d.framebufferHeight,{format:pl,type:Qa,colorSpace:e.outputColorSpace,stencilBuffer:m.stencil,resolveDepthBuffer:!1===d.ignoreDepthValues,resolveStencilBuffer:!1===d.ignoreDepthValues})}y.isXRRenderTarget=!0,this.setFoveation(a),l=null,s=await i.requestReferenceSpace(o),k.setContext(i),k.start(),n.isPresenting=!0,n.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==i)return i.environmentBlendMode},this.getDepthTexture=function(){return f.getDepthTexture()};const P=new Dc,D=new Dc;function L(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===i)return;let t=e.near,n=e.far;null!==f.texture&&(f.depthNear>0&&(t=f.depthNear),f.depthFar>0&&(n=f.depthFar)),M.near=T.near=w.near=t,M.far=T.far=w.far=n,E===M.near&&A===M.far||(i.updateRenderState({depthNear:M.near,depthFar:M.far}),E=M.near,A=M.far),w.layers.mask=2|e.layers.mask,T.layers.mask=4|e.layers.mask,M.layers.mask=w.layers.mask|T.layers.mask;const r=e.parent,s=M.cameras;L(M,r);for(let e=0;e<s.length;e++)L(s[e],r);2===s.length?function(e,t,n){P.setFromMatrixPosition(t.matrixWorld),D.setFromMatrixPosition(n.matrixWorld);const i=P.distanceTo(D),r=t.projectionMatrix.elements,s=n.projectionMatrix.elements,o=r[14]/(r[10]-1),a=r[14]/(r[10]+1),l=(r[9]+1)/r[5],c=(r[9]-1)/r[5],u=(r[8]-1)/r[0],h=(s[8]+1)/s[0],d=o*u,p=o*h,f=i/(-u+h),m=f*-u;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(m),e.translateZ(f),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===r[10])e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{const t=o+f,n=a+f,r=d-m,s=p+(i-m),u=l*a/n*t,h=c*a/n*t;e.projectionMatrix.makePerspective(r,s,u,h,t,n),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(M,w,T):M.projectionMatrix.copy(w.projectionMatrix),function(e,t,n){null===n?e.matrix.copy(t.matrixWorld):(e.matrix.copy(n.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld));e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*wc*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,M,r)},this.getCamera=function(){return M},this.getFoveation=function(){if(null!==h||null!==d)return a},this.setFoveation=function(e){a=e,null!==h&&(h.fixedFoveation=e),null!==d&&void 0!==d.fixedFoveation&&(d.fixedFoveation=e)},this.hasDepthSensing=function(){return null!==f.texture},this.getDepthSensingMesh=function(){return f.getMesh(M)};let I=null;const k=new yf;k.setAnimationLoop((function(t,r){if(c=r.getViewerPose(l||s),p=r,null!==c){const t=c.views;null!==d&&(e.setRenderTargetFramebuffer(y,d.framebuffer),e.setRenderTarget(y));let n=!1;t.length!==M.cameras.length&&(M.cameras.length=0,n=!0);for(let i=0;i<t.length;i++){const r=t[i];let s=null;if(null!==d)s=d.getViewport(r);else{const t=u.getViewSubImage(h,r);s=t.viewport,0===i&&(e.setRenderTargetTextures(y,t.colorTexture,t.depthStencilTexture),e.setRenderTarget(y))}let o=S[i];void 0===o&&(o=new xd,o.layers.enable(i),o.viewport=new nu,S[i]=o),o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.quaternion,o.scale),o.projectionMatrix.fromArray(r.projectionMatrix),o.projectionMatrixInverse.copy(o.projectionMatrix).invert(),o.viewport.set(s.x,s.y,s.width,s.height),0===i&&(M.matrix.copy(o.matrix),M.matrix.decompose(M.position,M.quaternion,M.scale)),!0===n&&M.cameras.push(o)}const r=i.enabledFeatures;if(r&&r.includes("depth-sensing")&&"gpu-optimized"==i.depthUsage&&u){const n=u.getDepthInformation(t[0]);n&&n.isValid&&n.texture&&f.init(e,n,i.renderState)}}for(let e=0;e<v.length;e++){const t=_[e],n=v[e];null!==t&&void 0!==n&&n.update(t,r,l||s)}I&&I(t,r),r.detectedPlanes&&n.dispatchEvent({type:"planesdetected",data:r}),p=null})),this.setAnimationLoop=function(e){I=e},this.dispose=function(){}}}const Yg=new Hu,Kg=new Iu;function Zg(e,t){function n(e,t){!0===e.matrixAutoUpdate&&e.updateMatrix(),t.value.copy(e.matrix)}function i(e,i){e.opacity.value=i.opacity,i.color&&e.diffuse.value.copy(i.color),i.emissive&&e.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),i.map&&(e.map.value=i.map,n(i.map,e.mapTransform)),i.alphaMap&&(e.alphaMap.value=i.alphaMap,n(i.alphaMap,e.alphaMapTransform)),i.bumpMap&&(e.bumpMap.value=i.bumpMap,n(i.bumpMap,e.bumpMapTransform),e.bumpScale.value=i.bumpScale,1===i.side&&(e.bumpScale.value*=-1)),i.normalMap&&(e.normalMap.value=i.normalMap,n(i.normalMap,e.normalMapTransform),e.normalScale.value.copy(i.normalScale),1===i.side&&e.normalScale.value.negate()),i.displacementMap&&(e.displacementMap.value=i.displacementMap,n(i.displacementMap,e.displacementMapTransform),e.displacementScale.value=i.displacementScale,e.displacementBias.value=i.displacementBias),i.emissiveMap&&(e.emissiveMap.value=i.emissiveMap,n(i.emissiveMap,e.emissiveMapTransform)),i.specularMap&&(e.specularMap.value=i.specularMap,n(i.specularMap,e.specularMapTransform)),i.alphaTest>0&&(e.alphaTest.value=i.alphaTest);const r=t.get(i),s=r.envMap,o=r.envMapRotation;s&&(e.envMap.value=s,Yg.copy(o),Yg.x*=-1,Yg.y*=-1,Yg.z*=-1,s.isCubeTexture&&!1===s.isRenderTargetTexture&&(Yg.y*=-1,Yg.z*=-1),e.envMapRotation.value.setFromMatrix4(Kg.makeRotationFromEuler(Yg)),e.flipEnvMap.value=s.isCubeTexture&&!1===s.isRenderTargetTexture?-1:1,e.reflectivity.value=i.reflectivity,e.ior.value=i.ior,e.refractionRatio.value=i.refractionRatio),i.lightMap&&(e.lightMap.value=i.lightMap,e.lightMapIntensity.value=i.lightMapIntensity,n(i.lightMap,e.lightMapTransform)),i.aoMap&&(e.aoMap.value=i.aoMap,e.aoMapIntensity.value=i.aoMapIntensity,n(i.aoMap,e.aoMapTransform))}return{refreshFogUniforms:function(t,n){n.color.getRGB(t.fogColor.value,pd(e)),n.isFog?(t.fogNear.value=n.near,t.fogFar.value=n.far):n.isFogExp2&&(t.fogDensity.value=n.density)},refreshMaterialUniforms:function(e,r,s,o,a){r.isMeshBasicMaterial||r.isMeshLambertMaterial?i(e,r):r.isMeshToonMaterial?(i(e,r),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(e,r)):r.isMeshPhongMaterial?(i(e,r),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4)}(e,r)):r.isMeshStandardMaterial?(i(e,r),function(e,t){e.metalness.value=t.metalness,t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap,n(t.metalnessMap,e.metalnessMapTransform));e.roughness.value=t.roughness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap,n(t.roughnessMap,e.roughnessMapTransform));t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}(e,r),r.isMeshPhysicalMaterial&&function(e,t,i){e.ior.value=t.ior,t.sheen>0&&(e.sheenColor.value.copy(t.sheenColor).multiplyScalar(t.sheen),e.sheenRoughness.value=t.sheenRoughness,t.sheenColorMap&&(e.sheenColorMap.value=t.sheenColorMap,n(t.sheenColorMap,e.sheenColorMapTransform)),t.sheenRoughnessMap&&(e.sheenRoughnessMap.value=t.sheenRoughnessMap,n(t.sheenRoughnessMap,e.sheenRoughnessMapTransform)));t.clearcoat>0&&(e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap,n(t.clearcoatMap,e.clearcoatMapTransform)),t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap,n(t.clearcoatRoughnessMap,e.clearcoatRoughnessMapTransform)),t.clearcoatNormalMap&&(e.clearcoatNormalMap.value=t.clearcoatNormalMap,n(t.clearcoatNormalMap,e.clearcoatNormalMapTransform),e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),1===t.side&&e.clearcoatNormalScale.value.negate()));t.dispersion>0&&(e.dispersion.value=t.dispersion);t.iridescence>0&&(e.iridescence.value=t.iridescence,e.iridescenceIOR.value=t.iridescenceIOR,e.iridescenceThicknessMinimum.value=t.iridescenceThicknessRange[0],e.iridescenceThicknessMaximum.value=t.iridescenceThicknessRange[1],t.iridescenceMap&&(e.iridescenceMap.value=t.iridescenceMap,n(t.iridescenceMap,e.iridescenceMapTransform)),t.iridescenceThicknessMap&&(e.iridescenceThicknessMap.value=t.iridescenceThicknessMap,n(t.iridescenceThicknessMap,e.iridescenceThicknessMapTransform)));t.transmission>0&&(e.transmission.value=t.transmission,e.transmissionSamplerMap.value=i.texture,e.transmissionSamplerSize.value.set(i.width,i.height),t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap,n(t.transmissionMap,e.transmissionMapTransform)),e.thickness.value=t.thickness,t.thicknessMap&&(e.thicknessMap.value=t.thicknessMap,n(t.thicknessMap,e.thicknessMapTransform)),e.attenuationDistance.value=t.attenuationDistance,e.attenuationColor.value.copy(t.attenuationColor));t.anisotropy>0&&(e.anisotropyVector.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation)),t.anisotropyMap&&(e.anisotropyMap.value=t.anisotropyMap,n(t.anisotropyMap,e.anisotropyMapTransform)));e.specularIntensity.value=t.specularIntensity,e.specularColor.value.copy(t.specularColor),t.specularColorMap&&(e.specularColorMap.value=t.specularColorMap,n(t.specularColorMap,e.specularColorMapTransform));t.specularIntensityMap&&(e.specularIntensityMap.value=t.specularIntensityMap,n(t.specularIntensityMap,e.specularIntensityMapTransform))}(e,r,a)):r.isMeshMatcapMaterial?(i(e,r),function(e,t){t.matcap&&(e.matcap.value=t.matcap)}(e,r)):r.isMeshDepthMaterial?i(e,r):r.isMeshDistanceMaterial?(i(e,r),function(e,n){const i=t.get(n).light;e.referencePosition.value.setFromMatrixPosition(i.matrixWorld),e.nearDistance.value=i.shadow.camera.near,e.farDistance.value=i.shadow.camera.far}(e,r)):r.isMeshNormalMaterial?i(e,r):r.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform))}(e,r),r.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,r)):r.isPointsMaterial?function(e,t,i,r){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*i,e.scale.value=.5*r,t.map&&(e.map.value=t.map,n(t.map,e.uvTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,r,s,o):r.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,r):r.isShadowMaterial?(e.color.value.copy(r.color),e.opacity.value=r.opacity):r.isShaderMaterial&&(r.uniformsNeedUpdate=!1)}}}function Jg(e,t,n,i){let r={},s={},o=[];const a=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);function l(e,t,n,i){const r=e.value,s=t+"_"+n;if(void 0===i[s])return i[s]="number"==typeof r||"boolean"==typeof r?r:r.clone(),!0;{const e=i[s];if("number"==typeof r||"boolean"==typeof r){if(e!==r)return i[s]=r,!0}else if(!1===e.equals(r))return e.copy(r),!0}return!1}function c(e){const t={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",e),t}function u(t){const n=t.target;n.removeEventListener("dispose",u);const i=o.indexOf(n.__bindingPointIndex);o.splice(i,1),e.deleteBuffer(r[n.id]),delete r[n.id],delete s[n.id]}return{bind:function(e,t){const n=t.program;i.uniformBlockBinding(e,n)},update:function(n,h){let d=r[n.id];void 0===d&&(!function(e){const t=e.uniforms;let n=0;const i=16;for(let e=0,r=t.length;e<r;e++){const r=Array.isArray(t[e])?t[e]:[t[e]];for(let e=0,t=r.length;e<t;e++){const t=r[e],s=Array.isArray(t.value)?t.value:[t.value];for(let e=0,r=s.length;e<r;e++){const r=c(s[e]),o=n%i,a=o%r.boundary,l=o+a;n+=a,0!==l&&i-l<r.storage&&(n+=i-l),t.__data=new Float32Array(r.storage/Float32Array.BYTES_PER_ELEMENT),t.__offset=n,n+=r.storage}}}const r=n%i;r>0&&(n+=i-r);e.__size=n,e.__cache={}}(n),d=function(t){const n=function(){for(let e=0;e<a;e++)if(-1===o.indexOf(e))return o.push(e),e;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}();t.__bindingPointIndex=n;const i=e.createBuffer(),r=t.__size,s=t.usage;return e.bindBuffer(e.UNIFORM_BUFFER,i),e.bufferData(e.UNIFORM_BUFFER,r,s),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,n,i),i}(n),r[n.id]=d,n.addEventListener("dispose",u));const p=h.program;i.updateUBOMapping(n,p);const f=t.render.frame;s[n.id]!==f&&(!function(t){const n=r[t.id],i=t.uniforms,s=t.__cache;e.bindBuffer(e.UNIFORM_BUFFER,n);for(let t=0,n=i.length;t<n;t++){const n=Array.isArray(i[t])?i[t]:[i[t]];for(let i=0,r=n.length;i<r;i++){const r=n[i];if(!0===l(r,t,i,s)){const t=r.__offset,n=Array.isArray(r.value)?r.value:[r.value];let i=0;for(let s=0;s<n.length;s++){const o=n[s],a=c(o);"number"==typeof o||"boolean"==typeof o?(r.__data[0]=o,e.bufferSubData(e.UNIFORM_BUFFER,t+i,r.__data)):o.isMatrix3?(r.__data[0]=o.elements[0],r.__data[1]=o.elements[1],r.__data[2]=o.elements[2],r.__data[3]=0,r.__data[4]=o.elements[3],r.__data[5]=o.elements[4],r.__data[6]=o.elements[5],r.__data[7]=0,r.__data[8]=o.elements[6],r.__data[9]=o.elements[7],r.__data[10]=o.elements[8],r.__data[11]=0):(o.toArray(r.__data,i),i+=a.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,t,r.__data)}}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(n),s[n.id]=f)},dispose:function(){for(const t in r)e.deleteBuffer(r[t]);o=[],r={},s={}}}}let Qg=class{static roundNumber(e,t){const n=Math.pow(10,t);return Math.round(e*n)/n}static sample(e){return e[Math.floor(Math.random()*e.length)]}static distanceToSquared(e,t){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return n*n+i*i+r*r}static isPointInPoly(e,t){for(var n=!1,i=-1,r=e.length,s=r-1;++i<r;s=i)(e[i].z<=t.z&&t.z<e[s].z||e[s].z<=t.z&&t.z<e[i].z)&&t.x<(e[s].x-e[i].x)*(t.z-e[i].z)/(e[s].z-e[i].z)+e[i].x&&(n=!n);return n}static isVectorInPolygon(e,t,n){var i=1e5,r=-1e5,s=[];return t.vertexIds.forEach((e=>{i=Math.min(n[e].y,i),r=Math.max(n[e].y,r),s.push(n[e])})),!!(e.y<r+.5&&e.y>i-.5&&this.isPointInPoly(s,e))}static triarea2(e,t,n){return(n.x-e.x)*(t.z-e.z)-(t.x-e.x)*(n.z-e.z)}static vequal(e,t){return this.distanceToSquared(e,t)<1e-5}static mergeVertices(e,t=1e-4){t=Math.max(t,Number.EPSILON);for(var n={},i=e.getIndex(),r=e.getAttribute("position"),s=i?i.count:r.count,o=0,a=[],l=[],c=Math.log10(1/t),u=Math.pow(10,c),h=0;h<s;h++){var d=i?i.getX(h):h,p="";p+=~~(r.getX(d)*u)+",",p+=~~(r.getY(d)*u)+",",(p+=~~(r.getZ(d)*u)+",")in n?a.push(n[p]):(l.push(r.getX(d)),l.push(r.getY(d)),l.push(r.getZ(d)),n[p]=o,a.push(o),o++)}const f=new Fh(new Float32Array(l),r.itemSize,r.normalized),m=new Kh;return m.setAttribute("position",f),m.setIndex(a),m}},ey=class{constructor(e){this.content=[],this.scoreFunction=e}push(e){this.content.push(e),this.sinkDown(this.content.length-1)}pop(){const e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e}remove(e){const t=this.content.indexOf(e),n=this.content.pop();t!==this.content.length-1&&(this.content[t]=n,this.scoreFunction(n)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))}size(){return this.content.length}rescoreElement(e){this.sinkDown(this.content.indexOf(e))}sinkDown(e){const t=this.content[e];for(;e>0;){const n=(e+1>>1)-1,i=this.content[n];if(!(this.scoreFunction(t)<this.scoreFunction(i)))break;this.content[n]=t,this.content[e]=i,e=n}}bubbleUp(e){const t=this.content.length,n=this.content[e],i=this.scoreFunction(n);for(;;){const r=e+1<<1,s=r-1;let o,a=null;if(s<t&&(o=this.scoreFunction(this.content[s]),o<i&&(a=s)),r<t&&this.scoreFunction(this.content[r])<(null===a?i:o)&&(a=r),null===a)break;this.content[e]=this.content[a],this.content[a]=n,e=a}}},ty=class{constructor(){this.portals=[]}push(e,t){void 0===t&&(t=e),this.portals.push({left:e,right:t})}stringPull(){const e=this.portals,t=[];let n,i,r,s=0,o=0,a=0;n=e[0].left,i=e[0].left,r=e[0].right,t.push(n);for(let l=1;l<e.length;l++){const c=e[l].left,u=e[l].right;if(Qg.triarea2(n,r,u)<=0){if(!(Qg.vequal(n,r)||Qg.triarea2(n,i,u)>0)){t.push(i),n=i,s=o,i=n,r=n,o=s,a=s,l=s;continue}r=u,a=l}if(Qg.triarea2(n,i,c)>=0){if(!(Qg.vequal(n,i)||Qg.triarea2(n,r,c)<0)){t.push(r),n=r,s=a,i=n,r=n,o=s,a=s,l=s;continue}i=c,o=l}}return 0!==t.length&&Qg.vequal(t[t.length-1],e[e.length-1].left)||t.push(e[e.length-1].left),this.path=t,t}},ny=class{constructor(){this.zones={}}static createZone(e,t=1e-4){return class{static buildZone(e,t){const n=this._buildNavigationMesh(e,t),i={};n.vertices.forEach((e=>{e.x=Qg.roundNumber(e.x,2),e.y=Qg.roundNumber(e.y,2),e.z=Qg.roundNumber(e.z,2)})),i.vertices=n.vertices;const r=this._buildPolygonGroups(n);return i.groups=new Array(r.length),r.forEach(((e,t)=>{const n=new Map;e.forEach(((e,t)=>{n.set(e,t)}));const r=new Array(e.length);e.forEach(((e,t)=>{const s=[];e.neighbours.forEach((e=>s.push(n.get(e))));const o=[];e.neighbours.forEach((t=>o.push(this._getSharedVerticesInOrder(e,t))));const a=new Dc(0,0,0);a.add(i.vertices[e.vertexIds[0]]),a.add(i.vertices[e.vertexIds[1]]),a.add(i.vertices[e.vertexIds[2]]),a.divideScalar(3),a.x=Qg.roundNumber(a.x,2),a.y=Qg.roundNumber(a.y,2),a.z=Qg.roundNumber(a.z,2),r[t]={id:t,neighbours:s,vertexIds:e.vertexIds,centroid:a,portals:o}})),i.groups[t]=r})),i}static _buildNavigationMesh(e,t){return e=Qg.mergeVertices(e,t),this._buildPolygonsFromGeometry(e)}static _spreadGroupId(e){let t=new Set([e]);for(;t.size>0;){const n=t;t=new Set,n.forEach((n=>{n.group=e.group,n.neighbours.forEach((e=>{void 0===e.group&&t.add(e)}))}))}}static _buildPolygonGroups(e){const t=[];return e.polygons.forEach((e=>{void 0!==e.group?t[e.group].push(e):(e.group=t.length,this._spreadGroupId(e),t.push([e]))})),t}static _buildPolygonNeighbours(e,t){const n=new Set,i=t[e.vertexIds[1]],r=t[e.vertexIds[2]];return t[e.vertexIds[0]].forEach((t=>{t!==e&&(i.includes(t)||r.includes(t))&&n.add(t)})),i.forEach((t=>{t!==e&&r.includes(t)&&n.add(t)})),n}static _buildPolygonsFromGeometry(e){const t=[],n=[],i=e.attributes.position,r=e.index,s=[];for(let e=0;e<i.count;e++)n.push((new Dc).fromBufferAttribute(i,e)),s[e]=[];for(let n=0;n<e.index.count;n+=3){const e=r.getX(n),i=r.getX(n+1),o=r.getX(n+2),a={vertexIds:[e,i,o],neighbours:null};t.push(a),s[e].push(a),s[i].push(a),s[o].push(a)}return t.forEach((e=>{e.neighbours=this._buildPolygonNeighbours(e,s)})),{polygons:t,vertices:n}}static _getSharedVerticesInOrder(e,t){const n=e.vertexIds,i=n[0],r=n[1],s=n[2],o=t.vertexIds,a=o.includes(i),l=o.includes(r),c=o.includes(s);return a&&l&&c?Array.from(n):a&&l?[i,r]:l&&c?[r,s]:a&&c?[s,i]:(console.warn("Error processing navigation mesh neighbors; neighbors with <2 shared vertices found."),[])}}.buildZone(e,t)}setZoneData(e,t){this.zones[e]=t}getRandomNode(e,t,n,i){if(!this.zones[e])return new Dc;n=n||null,i=i||0;const r=[];return this.zones[e].groups[t].forEach((e=>{n&&i?Qg.distanceToSquared(n,e.centroid)<i*i&&r.push(e.centroid):r.push(e.centroid)})),Qg.sample(r)||new Dc}getClosestNode(e,t,n,i=!1){const r=this.zones[t].vertices;let s=null,o=1/0;return this.zones[t].groups[n].forEach((t=>{const n=Qg.distanceToSquared(t.centroid,e);n<o&&(!i||Qg.isVectorInPolygon(e,t,r))&&(s=t,o=n)})),s}findPath(e,t,n,i){const r=this.zones[n].groups[i],s=this.zones[n].vertices,o=this.getClosestNode(e,n,i,!0),a=this.getClosestNode(t,n,i,!0);if(!o||!a)return null;const l=class{static init(e){for(let t=0;t<e.length;t++){const n=e[t];n.f=0,n.g=0,n.h=0,n.cost=1,n.visited=!1,n.closed=!1,n.parent=null}}static cleanUp(e){for(let t=0;t<e.length;t++){const n=e[t];delete n.f,delete n.g,delete n.h,delete n.cost,delete n.visited,delete n.closed,delete n.parent}}static heap(){return new ey((function(e){return e.f}))}static search(e,t,n){this.init(e);const i=this.heap();for(i.push(t);i.size()>0;){const t=i.pop();if(t===n){let e=t;const n=[];for(;e.parent;)n.push(e),e=e.parent;return this.cleanUp(n),n.reverse()}t.closed=!0;const r=this.neighbours(e,t);for(let e=0,s=r.length;e<s;e++){const s=r[e];if(s.closed)continue;const o=t.g+s.cost,a=s.visited;if(!a||o<s.g){if(s.visited=!0,s.parent=t,!s.centroid||!n.centroid)throw new Error("Unexpected state");s.h=s.h||this.heuristic(s.centroid,n.centroid),s.g=o,s.f=s.g+s.h,a?i.rescoreElement(s):i.push(s)}}}return[]}static heuristic(e,t){return Qg.distanceToSquared(e,t)}static neighbours(e,t){const n=[];for(let i=0;i<t.neighbours.length;i++)n.push(e[t.neighbours[i]]);return n}}.search(r,o,a),c=function(e,t){for(var n=0;n<e.neighbours.length;n++)if(e.neighbours[n]===t.id)return e.portals[n]},u=new ty;u.push(e);for(let e=0;e<l.length;e++){const t=l[e],n=l[e+1];if(n){const e=c(t,n);u.push(s[e[0]],s[e[1]])}}u.push(t),u.stringPull();const h=u.path.map((e=>new Dc(e.x,e.y,e.z)));return h.shift(),h}};ny.prototype.getGroup=function(){const e=new Fd;return function(t,n,i=!1){if(!this.zones[t])return null;let r=null,s=Math.pow(50,2);const o=this.zones[t];for(let t=0;t<o.groups.length;t++){const a=o.groups[t];for(const l of a){if(i&&(e.setFromCoplanarPoints(o.vertices[l.vertexIds[0]],o.vertices[l.vertexIds[1]],o.vertices[l.vertexIds[2]]),Math.abs(e.distanceToPoint(n))<.01)&&Qg.isPointInPoly([o.vertices[l.vertexIds[0]],o.vertices[l.vertexIds[1]],o.vertices[l.vertexIds[2]]],n))return t;const a=Qg.distanceToSquared(l.centroid,n);a<s&&(r=t,s=a)}}return r}}(),ny.prototype.clampStep=function(){const e=new Dc,t=new Fd,n=new bh,i=new Dc;let r,s,o=new Dc;return function(a,l,c,u,h,d){const p=this.zones[u].vertices,f=this.zones[u].groups[h],m=[c],g={};g[c.id]=0,r=void 0,o.set(0,0,0),s=1/0,t.setFromCoplanarPoints(p[c.vertexIds[0]],p[c.vertexIds[1]],p[c.vertexIds[2]]),t.projectPoint(l,e),i.copy(e);for(let t=m.pop();t;t=m.pop()){n.set(p[t.vertexIds[0]],p[t.vertexIds[1]],p[t.vertexIds[2]]),n.closestPointToPoint(i,e),e.distanceToSquared(i)<s&&(r=t,o.copy(e),s=e.distanceToSquared(i));const a=g[t.id];if(!(a>2))for(let e=0;e<t.neighbours.length;e++){const n=f[t.neighbours[e]];n.id in g||(m.push(n),g[n.id]=a+1)}}return d.copy(o),r}}();var iy,ry,sy,oy=Object.freeze({__proto__:null,Pathfinding:ny,PathfindingHelper:class extends ah{constructor(){super(),this._playerMarker=new ld(new xp(.25,32,32),new Nh({color:15631215})),this._targetMarker=new ld(new ud(.3,.3,.3),new Nh({color:14469912})),this._nodeMarker=new ld(new ud(.1,.8,.1),new Nh({color:4417387})),this._stepMarker=new ld(new ud(.1,1,.1),new Nh({color:14472114})),this._pathMarker=new ah,this._pathLineMaterial=new Wd({color:41903,linewidth:2}),this._pathPointMaterial=new Nh({color:41903}),this._pathPointGeometry=new xp(.08),this._markers=[this._playerMarker,this._targetMarker,this._nodeMarker,this._stepMarker,this._pathMarker],this._markers.forEach((e=>{e.visible=!1,this.add(e)}))}setPath(e){for(;this._pathMarker.children.length;)this._pathMarker.children[0].visible=!1,this._pathMarker.remove(this._pathMarker.children[0]);e=[this._playerMarker.position].concat(e);const t=new Kh;t.setAttribute("position",new Fh(new Float32Array(3*e.length),3));for(let n=0;n<e.length;n++)t.attributes.position.setXYZ(n,e[n].x,e[n].y+.2,e[n].z);this._pathMarker.add(new Qd(t,this._pathLineMaterial));for(let t=0;t<e.length-1;t++){const n=new ld(this._pathPointGeometry,this._pathPointMaterial);n.position.copy(e[t]),n.position.y+=.2,this._pathMarker.add(n)}return this._pathMarker.visible=!0,this}setPlayerPosition(e){return this._playerMarker.position.copy(e),this._playerMarker.visible=!0,this}setTargetPosition(e){return this._targetMarker.position.copy(e),this._targetMarker.visible=!0,this}setNodePosition(e){return this._nodeMarker.position.copy(e),this._nodeMarker.visible=!0,this}setStepPosition(e){return this._stepMarker.position.copy(e),this._stepMarker.visible=!0,this}reset(){for(;this._pathMarker.children.length;)this._pathMarker.children[0].visible=!1,this._pathMarker.remove(this._pathMarker.children[0]);return this._markers.forEach((e=>{e.visible=!1})),this}}}),ay=m(oy);function ly(){return sy||(sy=1,Qo||(Qo=1,AFRAME.registerComponent("nav-mesh",{schema:{nodeName:{type:"string"}},init:function(){this.system=this.el.sceneEl.systems.nav,this.hasLoadedNavMesh=!1,this.nodeName=this.data.nodeName,this.el.addEventListener("object3dset",this.loadNavMesh.bind(this))},play:function(){this.hasLoadedNavMesh||this.loadNavMesh()},loadNavMesh:function(){var e=this;const t=this.el.getObject3D("mesh");if(this.el.sceneEl.object3D,!t)return;let n;if(t.traverse((t=>{!t.isMesh||e.nodeName&&t.name!==e.nodeName||(n=t)})),!n)return;const i=n.geometry.clone();n.updateWorldMatrix(!0,!1),i.applyMatrix4(n.matrixWorld),this.system.setNavMeshGeometry(i),this.hasLoadedNavMesh=!0}})),ea||(ea=1,AFRAME.registerComponent("nav-agent",{schema:{destination:{type:"vec3"},active:{default:!1},speed:{default:2}},init:function(){this.system=this.el.sceneEl.systems.nav,this.system.addAgent(this),this.group=null,this.path=[],this.raycaster=new THREE.Raycaster},remove:function(){this.system.removeAgent(this)},update:function(){this.path.length=0},updateNavLocation:function(){this.group=null,this.path=[]},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,n=new THREE.Vector3;return function(i,r){const s=this.el,o=this.data,a=this.raycaster,l=o.speed*r/1e3;if(!o.active)return;if(!this.path.length){const t=this.el.object3D.position;this.group=this.group||this.system.getGroup(t),this.path=this.system.getPath(t,e.copy(o.destination),this.group)||[],s.emit("navigation-start")}if(!this.path.length)return console.warn("[nav] Unable to find path to %o.",o.destination),this.el.setAttribute("nav-agent",{active:!1}),void s.emit("navigation-end");const c=s.object3D.position,u=this.path[0];let h;if(t.subVectors(u,c),t.length()<l){if(this.path.shift(),!this.path.length)return this.el.setAttribute("nav-agent",{active:!1}),void s.emit("navigation-end");n.copy(c),h=this.path[0]}else n.copy(t.setLength(l)).add(c),h=u;h.y=c.y,s.object3D.lookAt(h),a.ray.origin.copy(n),a.ray.origin.y+=1.5,a.ray.direction={x:0,y:-1,z:0};const d=a.intersectObject(this.system.getNavMesh());d.length?(t.subVectors(d[0].point,c),c.add(t.setLength(l))):c.copy(n)}}()})),function(){if(ry)return iy;ry=1;const{Pathfinding:e}=ay,t=new e,n="level";iy=AFRAME.registerSystem("nav",{init:function(){this.navMesh=null,this.agents=new Set},setNavMeshGeometry:function(i){this.navMesh=new THREE.Mesh(i),t.setZoneData(n,e.createZone(i)),Array.from(this.agents).forEach((e=>e.updateNavLocation()))},getNavMesh:function(){return this.navMesh},addAgent:function(e){this.agents.add(e)},removeAgent:function(e){this.agents.delete(e)},getPath:function(e,i,r){return this.navMesh?t.findPath(e,i,n,r):null},getGroup:function(e){return this.navMesh?t.getGroup(n,e):null},getNode:function(e,i){return this.navMesh?t.getClosestNode(e,n,i,!0):null},clampStep:function(e,i,r,s,o){return this.navMesh?s?t.clampStep(e,i,s,n,r,o):(o.copy(i),this.getNode(i,r)):(o.copy(i),null)}})}()),ta}var cy,uy={};var hy,dy={};var py,fy,my,gy={};function yy(){return fy||(fy=1,cy||(cy=1,AFRAME.registerPrimitive("a-grid",{defaultComponents:{geometry:{primitive:"plane",width:75,height:75},rotation:{x:-90,y:0,z:0},material:{src:"url(https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v1.16.3/assets/grid.png)",repeat:"75 75"}},mappings:{width:"geometry.width",height:"geometry.height",src:"material.src"}})),hy||(hy=1,dy.Primitive=AFRAME.registerPrimitive("a-ocean",{defaultComponents:{ocean:{},rotation:{x:-90,y:0,z:0}},mappings:{width:"ocean.width",depth:"ocean.depth",density:"ocean.density",amplitude:"ocean.amplitude",amplitudeVariance:"ocean.amplitudeVariance",speed:"ocean.speed",speedVariance:"ocean.speedVariance",color:"ocean.color",opacity:"ocean.opacity"}}),dy.Component=AFRAME.registerComponent("ocean",{schema:{width:{default:10,min:0},depth:{default:10,min:0},density:{default:10},amplitude:{default:.1},amplitudeVariance:{default:.3},speed:{default:1},speedVariance:{default:2},color:{default:"#7AD2F7",type:"color"},opacity:{default:.8}},play:function(){const e=this.el,t=this.data;let n=e.components.material;const i=new THREE.PlaneGeometry(t.width,t.depth,t.density,t.density);this.waves=[];const r=i.getAttribute("position");for(let e=0;e<r.count;e++)this.waves.push({z:r.getZ(e),ang:Math.random()*Math.PI*2,amp:t.amplitude+Math.random()*t.amplitudeVariance,speed:(t.speed+Math.random()*t.speedVariance)/1e3});n||(n={},n.material=new THREE.MeshPhongMaterial({color:t.color,transparent:t.opacity<1,opacity:t.opacity,flatShading:!0})),this.mesh=new THREE.Mesh(i,n.material),e.setObject3D("mesh",this.mesh)},remove:function(){this.el.removeObject3D("mesh")},tick:function(e,t){if(!t)return;const n=this.mesh.geometry.getAttribute("position");for(let e=0;e<n.count;e++){const i=this.waves[e],r=i.z+Math.sin(i.ang)*i.amp;n.setZ(e,r),i.ang+=i.speed*t}n.needsUpdate=!0}})),py||(py=1,gy.Primitive=AFRAME.registerPrimitive("a-tube",{defaultComponents:{tube:{}},mappings:{path:"tube.path",segments:"tube.segments",radius:"tube.radius","radial-segments":"tube.radialSegments",closed:"tube.closed"}}),gy.Component=AFRAME.registerComponent("tube",{schema:{path:{default:[]},segments:{default:64},radius:{default:1},radialSegments:{default:8},closed:{default:!1}},init:function(){const e=this.el,t=this.data;let n=e.components.material;if(!t.path.length)return void console.error("[a-tube] `path` property expected but not found.");const i=new THREE.CatmullRomCurve3(t.path.map((function(e){return e=e.split(" "),new THREE.Vector3(Number(e[0]),Number(e[1]),Number(e[2]))}))),r=new THREE.TubeGeometry(i,t.segments,t.radius,t.radialSegments,t.closed);n||(n={},n.material=new THREE.MeshPhongMaterial),this.mesh=new THREE.Mesh(r,n.material),this.el.setObject3D("mesh",this.mesh)},update:function(e){Object.keys(e).length&&(this.remove(),this.init())},remove:function(){this.mesh&&this.el.removeObject3D("mesh")}}))),uy}function vy(e,t,n){var i,r=1;function s(){var s,o,a=i.length,l=0,c=0,u=0;for(s=0;s<a;++s)l+=(o=i[s]).x||0,c+=o.y||0,u+=o.z||0;for(l=(l/a-e)*r,c=(c/a-t)*r,u=(u/a-n)*r,s=0;s<a;++s)o=i[s],l&&(o.x-=l),c&&(o.y-=c),u&&(o.z-=u)}return null==e&&(e=0),null==t&&(t=0),null==n&&(n=0),s.initialize=function(e){i=e},s.x=function(t){return arguments.length?(e=+t,s):e},s.y=function(e){return arguments.length?(t=+e,s):t},s.z=function(e){return arguments.length?(n=+e,s):n},s.strength=function(e){return arguments.length?(r=+e,s):r},s}function _y(e,t,n){if(isNaN(t))return e;var i,r,s,o,a,l,c=e._root,u={data:n},h=e._x0,d=e._x1;if(!c)return e._root=u,e;for(;c.length;)if((o=t>=(r=(h+d)/2))?h=r:d=r,i=c,!(c=c[a=+o]))return i[a]=u,e;if(t===(s=+e._x.call(null,c.data)))return u.next=c,i?i[a]=u:e._root=u,e;do{i=i?i[a]=new Array(2):e._root=new Array(2),(o=t>=(r=(h+d)/2))?h=r:d=r}while((a=+o)===(l=+(s>=r)));return i[l]=c,i[a]=u,e}function xy(e,t,n){this.node=e,this.x0=t,this.x1=n}function by(e){return e[0]}function wy(e,t){var n=new Ty(null==t?by:t,NaN,NaN);return null==e?n:n.addAll(e)}function Ty(e,t,n){this._x=e,this._x0=t,this._x1=n,this._root=void 0}function Sy(e){for(var t={data:e.data},n=t;e=e.next;)n=n.next={data:e.data};return t}my||(my=1,le(),Go(),Jo(),ly(),yy());var My=wy.prototype=Ty.prototype;function Ey(e,t,n,i){if(isNaN(t)||isNaN(n))return e;var r,s,o,a,l,c,u,h,d,p=e._root,f={data:i},m=e._x0,g=e._y0,y=e._x1,v=e._y1;if(!p)return e._root=f,e;for(;p.length;)if((c=t>=(s=(m+y)/2))?m=s:y=s,(u=n>=(o=(g+v)/2))?g=o:v=o,r=p,!(p=p[h=u<<1|c]))return r[h]=f,e;if(a=+e._x.call(null,p.data),l=+e._y.call(null,p.data),t===a&&n===l)return f.next=p,r?r[h]=f:e._root=f,e;do{r=r?r[h]=new Array(4):e._root=new Array(4),(c=t>=(s=(m+y)/2))?m=s:y=s,(u=n>=(o=(g+v)/2))?g=o:v=o}while((h=u<<1|c)==(d=(l>=o)<<1|a>=s));return r[d]=p,r[h]=f,e}function Ay(e,t,n,i,r){this.node=e,this.x0=t,this.y0=n,this.x1=i,this.y1=r}function Cy(e){return e[0]}function Ry(e){return e[1]}function Ny(e,t,n){var i=new Py(null==t?Cy:t,null==n?Ry:n,NaN,NaN,NaN,NaN);return null==e?i:i.addAll(e)}function Py(e,t,n,i,r,s){this._x=e,this._y=t,this._x0=n,this._y0=i,this._x1=r,this._y1=s,this._root=void 0}function Dy(e){for(var t={data:e.data},n=t;e=e.next;)n=n.next={data:e.data};return t}My.copy=function(){var e,t,n=new Ty(this._x,this._x0,this._x1),i=this._root;if(!i)return n;if(!i.length)return n._root=Sy(i),n;for(e=[{source:i,target:n._root=new Array(2)}];i=e.pop();)for(var r=0;r<2;++r)(t=i.source[r])&&(t.length?e.push({source:t,target:i.target[r]=new Array(2)}):i.target[r]=Sy(t));return n},My.add=function(e){const t=+this._x.call(null,e);return _y(this.cover(t),t,e)},My.addAll=function(e){Array.isArray(e)||(e=Array.from(e));const t=e.length,n=new Float64Array(t);let i=1/0,r=-1/0;for(let s,o=0;o<t;++o)isNaN(s=+this._x.call(null,e[o]))||(n[o]=s,s<i&&(i=s),s>r&&(r=s));if(i>r)return this;this.cover(i).cover(r);for(let i=0;i<t;++i)_y(this,n[i],e[i]);return this},My.cover=function(e){if(isNaN(e=+e))return this;var t=this._x0,n=this._x1;if(isNaN(t))n=(t=Math.floor(e))+1;else{for(var i,r,s=n-t||1,o=this._root;t>e||e>=n;)switch(r=+(e<t),(i=new Array(2))[r]=o,o=i,s*=2,r){case 0:n=t+s;break;case 1:t=n-s}this._root&&this._root.length&&(this._root=o)}return this._x0=t,this._x1=n,this},My.data=function(){var e=[];return this.visit((function(t){if(!t.length)do{e.push(t.data)}while(t=t.next)})),e},My.extent=function(e){return arguments.length?this.cover(+e[0][0]).cover(+e[1][0]):isNaN(this._x0)?void 0:[[this._x0],[this._x1]]},My.find=function(e,t){var n,i,r,s,o,a=this._x0,l=this._x1,c=[],u=this._root;for(u&&c.push(new xy(u,a,l)),null==t?t=1/0:(a=e-t,l=e+t);s=c.pop();)if(!(!(u=s.node)||(i=s.x0)>l||(r=s.x1)<a))if(u.length){var h=(i+r)/2;c.push(new xy(u[1],h,r),new xy(u[0],i,h)),(o=+(e>=h))&&(s=c[c.length-1],c[c.length-1]=c[c.length-1-o],c[c.length-1-o]=s)}else{var d=Math.abs(e-+this._x.call(null,u.data));d<t&&(t=d,a=e-d,l=e+d,n=u.data)}return n},My.remove=function(e){if(isNaN(s=+this._x.call(null,e)))return this;var t,n,i,r,s,o,a,l,c,u=this._root,h=this._x0,d=this._x1;if(!u)return this;if(u.length)for(;;){if((a=s>=(o=(h+d)/2))?h=o:d=o,t=u,!(u=u[l=+a]))return this;if(!u.length)break;t[l+1&1]&&(n=t,c=l)}for(;u.data!==e;)if(i=u,!(u=u.next))return this;return(r=u.next)&&delete u.next,i?(r?i.next=r:delete i.next,this):t?(r?t[l]=r:delete t[l],(u=t[0]||t[1])&&u===(t[1]||t[0])&&!u.length&&(n?n[c]=u:this._root=u),this):(this._root=r,this)},My.removeAll=function(e){for(var t=0,n=e.length;t<n;++t)this.remove(e[t]);return this},My.root=function(){return this._root},My.size=function(){var e=0;return this.visit((function(t){if(!t.length)do{++e}while(t=t.next)})),e},My.visit=function(e){var t,n,i,r,s=[],o=this._root;for(o&&s.push(new xy(o,this._x0,this._x1));t=s.pop();)if(!e(o=t.node,i=t.x0,r=t.x1)&&o.length){var a=(i+r)/2;(n=o[1])&&s.push(new xy(n,a,r)),(n=o[0])&&s.push(new xy(n,i,a))}return this},My.visitAfter=function(e){var t,n=[],i=[];for(this._root&&n.push(new xy(this._root,this._x0,this._x1));t=n.pop();){var r=t.node;if(r.length){var s,o=t.x0,a=t.x1,l=(o+a)/2;(s=r[0])&&n.push(new xy(s,o,l)),(s=r[1])&&n.push(new xy(s,l,a))}i.push(t)}for(;t=i.pop();)e(t.node,t.x0,t.x1);return this},My.x=function(e){return arguments.length?(this._x=e,this):this._x};var Ly=Ny.prototype=Py.prototype;function Iy(e,t,n,i,r){if(isNaN(t)||isNaN(n)||isNaN(i))return e;var s,o,a,l,c,u,h,d,p,f,m,g,y=e._root,v={data:r},_=e._x0,x=e._y0,b=e._z0,w=e._x1,T=e._y1,S=e._z1;if(!y)return e._root=v,e;for(;y.length;)if((d=t>=(o=(_+w)/2))?_=o:w=o,(p=n>=(a=(x+T)/2))?x=a:T=a,(f=i>=(l=(b+S)/2))?b=l:S=l,s=y,!(y=y[m=f<<2|p<<1|d]))return s[m]=v,e;if(c=+e._x.call(null,y.data),u=+e._y.call(null,y.data),h=+e._z.call(null,y.data),t===c&&n===u&&i===h)return v.next=y,s?s[m]=v:e._root=v,e;do{s=s?s[m]=new Array(8):e._root=new Array(8),(d=t>=(o=(_+w)/2))?_=o:w=o,(p=n>=(a=(x+T)/2))?x=a:T=a,(f=i>=(l=(b+S)/2))?b=l:S=l}while((m=f<<2|p<<1|d)==(g=(h>=l)<<2|(u>=a)<<1|c>=o));return s[g]=y,s[m]=v,e}function ky(e,t,n,i,r,s,o){this.node=e,this.x0=t,this.y0=n,this.z0=i,this.x1=r,this.y1=s,this.z1=o}Ly.copy=function(){var e,t,n=new Py(this._x,this._y,this._x0,this._y0,this._x1,this._y1),i=this._root;if(!i)return n;if(!i.length)return n._root=Dy(i),n;for(e=[{source:i,target:n._root=new Array(4)}];i=e.pop();)for(var r=0;r<4;++r)(t=i.source[r])&&(t.length?e.push({source:t,target:i.target[r]=new Array(4)}):i.target[r]=Dy(t));return n},Ly.add=function(e){const t=+this._x.call(null,e),n=+this._y.call(null,e);return Ey(this.cover(t,n),t,n,e)},Ly.addAll=function(e){var t,n,i,r,s=e.length,o=new Array(s),a=new Array(s),l=1/0,c=1/0,u=-1/0,h=-1/0;for(n=0;n<s;++n)isNaN(i=+this._x.call(null,t=e[n]))||isNaN(r=+this._y.call(null,t))||(o[n]=i,a[n]=r,i<l&&(l=i),i>u&&(u=i),r<c&&(c=r),r>h&&(h=r));if(l>u||c>h)return this;for(this.cover(l,c).cover(u,h),n=0;n<s;++n)Ey(this,o[n],a[n],e[n]);return this},Ly.cover=function(e,t){if(isNaN(e=+e)||isNaN(t=+t))return this;var n=this._x0,i=this._y0,r=this._x1,s=this._y1;if(isNaN(n))r=(n=Math.floor(e))+1,s=(i=Math.floor(t))+1;else{for(var o,a,l=r-n||1,c=this._root;n>e||e>=r||i>t||t>=s;)switch(a=(t<i)<<1|e<n,(o=new Array(4))[a]=c,c=o,l*=2,a){case 0:r=n+l,s=i+l;break;case 1:n=r-l,s=i+l;break;case 2:r=n+l,i=s-l;break;case 3:n=r-l,i=s-l}this._root&&this._root.length&&(this._root=c)}return this._x0=n,this._y0=i,this._x1=r,this._y1=s,this},Ly.data=function(){var e=[];return this.visit((function(t){if(!t.length)do{e.push(t.data)}while(t=t.next)})),e},Ly.extent=function(e){return arguments.length?this.cover(+e[0][0],+e[0][1]).cover(+e[1][0],+e[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]},Ly.find=function(e,t,n){var i,r,s,o,a,l,c,u=this._x0,h=this._y0,d=this._x1,p=this._y1,f=[],m=this._root;for(m&&f.push(new Ay(m,u,h,d,p)),null==n?n=1/0:(u=e-n,h=t-n,d=e+n,p=t+n,n*=n);l=f.pop();)if(!(!(m=l.node)||(r=l.x0)>d||(s=l.y0)>p||(o=l.x1)<u||(a=l.y1)<h))if(m.length){var g=(r+o)/2,y=(s+a)/2;f.push(new Ay(m[3],g,y,o,a),new Ay(m[2],r,y,g,a),new Ay(m[1],g,s,o,y),new Ay(m[0],r,s,g,y)),(c=(t>=y)<<1|e>=g)&&(l=f[f.length-1],f[f.length-1]=f[f.length-1-c],f[f.length-1-c]=l)}else{var v=e-+this._x.call(null,m.data),_=t-+this._y.call(null,m.data),x=v*v+_*_;if(x<n){var b=Math.sqrt(n=x);u=e-b,h=t-b,d=e+b,p=t+b,i=m.data}}return i},Ly.remove=function(e){if(isNaN(s=+this._x.call(null,e))||isNaN(o=+this._y.call(null,e)))return this;var t,n,i,r,s,o,a,l,c,u,h,d,p=this._root,f=this._x0,m=this._y0,g=this._x1,y=this._y1;if(!p)return this;if(p.length)for(;;){if((c=s>=(a=(f+g)/2))?f=a:g=a,(u=o>=(l=(m+y)/2))?m=l:y=l,t=p,!(p=p[h=u<<1|c]))return this;if(!p.length)break;(t[h+1&3]||t[h+2&3]||t[h+3&3])&&(n=t,d=h)}for(;p.data!==e;)if(i=p,!(p=p.next))return this;return(r=p.next)&&delete p.next,i?(r?i.next=r:delete i.next,this):t?(r?t[h]=r:delete t[h],(p=t[0]||t[1]||t[2]||t[3])&&p===(t[3]||t[2]||t[1]||t[0])&&!p.length&&(n?n[d]=p:this._root=p),this):(this._root=r,this)},Ly.removeAll=function(e){for(var t=0,n=e.length;t<n;++t)this.remove(e[t]);return this},Ly.root=function(){return this._root},Ly.size=function(){var e=0;return this.visit((function(t){if(!t.length)do{++e}while(t=t.next)})),e},Ly.visit=function(e){var t,n,i,r,s,o,a=[],l=this._root;for(l&&a.push(new Ay(l,this._x0,this._y0,this._x1,this._y1));t=a.pop();)if(!e(l=t.node,i=t.x0,r=t.y0,s=t.x1,o=t.y1)&&l.length){var c=(i+s)/2,u=(r+o)/2;(n=l[3])&&a.push(new Ay(n,c,u,s,o)),(n=l[2])&&a.push(new Ay(n,i,u,c,o)),(n=l[1])&&a.push(new Ay(n,c,r,s,u)),(n=l[0])&&a.push(new Ay(n,i,r,c,u))}return this},Ly.visitAfter=function(e){var t,n=[],i=[];for(this._root&&n.push(new Ay(this._root,this._x0,this._y0,this._x1,this._y1));t=n.pop();){var r=t.node;if(r.length){var s,o=t.x0,a=t.y0,l=t.x1,c=t.y1,u=(o+l)/2,h=(a+c)/2;(s=r[0])&&n.push(new Ay(s,o,a,u,h)),(s=r[1])&&n.push(new Ay(s,u,a,l,h)),(s=r[2])&&n.push(new Ay(s,o,h,u,c)),(s=r[3])&&n.push(new Ay(s,u,h,l,c))}i.push(t)}for(;t=i.pop();)e(t.node,t.x0,t.y0,t.x1,t.y1);return this},Ly.x=function(e){return arguments.length?(this._x=e,this):this._x},Ly.y=function(e){return arguments.length?(this._y=e,this):this._y};const Oy=(e,t,n,i,r,s)=>Math.sqrt((e-i)**2+(t-r)**2+(n-s)**2);function Uy(e){return e[0]}function Fy(e){return e[1]}function By(e){return e[2]}function zy(e,t,n,i){var r=new Vy(null==t?Uy:t,null==n?Fy:n,null==i?By:i,NaN,NaN,NaN,NaN,NaN,NaN);return null==e?r:r.addAll(e)}function Vy(e,t,n,i,r,s,o,a,l){this._x=e,this._y=t,this._z=n,this._x0=i,this._y0=r,this._z0=s,this._x1=o,this._y1=a,this._z1=l,this._root=void 0}function Gy(e){for(var t={data:e.data},n=t;e=e.next;)n=n.next={data:e.data};return t}var jy=zy.prototype=Vy.prototype;function Hy(e){return function(){return e}}function Wy(e){return 1e-6*(e()-.5)}function qy(e){return e.index}function Xy(e,t){var n=e.get(t);if(!n)throw new Error("node not found: "+t);return n}function $y(e){var t,n,i,r,s,o,a,l=qy,c=function(e){return 1/Math.min(s[e.source.index],s[e.target.index])},u=Hy(30),h=1;function d(i){for(var s=0,l=e.length;s<h;++s)for(var c,u,d,p,f,m=0,g=0,y=0,v=0;m<l;++m)u=(c=e[m]).source,g=(d=c.target).x+d.vx-u.x-u.vx||Wy(a),r>1&&(y=d.y+d.vy-u.y-u.vy||Wy(a)),r>2&&(v=d.z+d.vz-u.z-u.vz||Wy(a)),g*=p=((p=Math.sqrt(g*g+y*y+v*v))-n[m])/p*i*t[m],y*=p,v*=p,d.vx-=g*(f=o[m]),r>1&&(d.vy-=y*f),r>2&&(d.vz-=v*f),u.vx+=g*(f=1-f),r>1&&(u.vy+=y*f),r>2&&(u.vz+=v*f)}function p(){if(i){var r,a,c=i.length,u=e.length,h=new Map(i.map(((e,t)=>[l(e,t,i),e])));for(r=0,s=new Array(c);r<u;++r)(a=e[r]).index=r,"object"!=typeof a.source&&(a.source=Xy(h,a.source)),"object"!=typeof a.target&&(a.target=Xy(h,a.target)),s[a.source.index]=(s[a.source.index]||0)+1,s[a.target.index]=(s[a.target.index]||0)+1;for(r=0,o=new Array(u);r<u;++r)a=e[r],o[r]=s[a.source.index]/(s[a.source.index]+s[a.target.index]);t=new Array(u),f(),n=new Array(u),m()}}function f(){if(i)for(var n=0,r=e.length;n<r;++n)t[n]=+c(e[n],n,e)}function m(){if(i)for(var t=0,r=e.length;t<r;++t)n[t]=+u(e[t],t,e)}return null==e&&(e=[]),d.initialize=function(e,...t){i=e,a=t.find((e=>"function"==typeof e))||Math.random,r=t.find((e=>[1,2,3].includes(e)))||2,p()},d.links=function(t){return arguments.length?(e=t,p(),d):e},d.id=function(e){return arguments.length?(l=e,d):l},d.iterations=function(e){return arguments.length?(h=+e,d):h},d.strength=function(e){return arguments.length?(c="function"==typeof e?e:Hy(+e),f(),d):c},d.distance=function(e){return arguments.length?(u="function"==typeof e?e:Hy(+e),m(),d):u},d}jy.copy=function(){var e,t,n=new Vy(this._x,this._y,this._z,this._x0,this._y0,this._z0,this._x1,this._y1,this._z1),i=this._root;if(!i)return n;if(!i.length)return n._root=Gy(i),n;for(e=[{source:i,target:n._root=new Array(8)}];i=e.pop();)for(var r=0;r<8;++r)(t=i.source[r])&&(t.length?e.push({source:t,target:i.target[r]=new Array(8)}):i.target[r]=Gy(t));return n},jy.add=function(e){const t=+this._x.call(null,e),n=+this._y.call(null,e),i=+this._z.call(null,e);return Iy(this.cover(t,n,i),t,n,i,e)},jy.addAll=function(e){Array.isArray(e)||(e=Array.from(e));const t=e.length,n=new Float64Array(t),i=new Float64Array(t),r=new Float64Array(t);let s=1/0,o=1/0,a=1/0,l=-1/0,c=-1/0,u=-1/0;for(let h,d,p,f,m=0;m<t;++m)isNaN(d=+this._x.call(null,h=e[m]))||isNaN(p=+this._y.call(null,h))||isNaN(f=+this._z.call(null,h))||(n[m]=d,i[m]=p,r[m]=f,d<s&&(s=d),d>l&&(l=d),p<o&&(o=p),p>c&&(c=p),f<a&&(a=f),f>u&&(u=f));if(s>l||o>c||a>u)return this;this.cover(s,o,a).cover(l,c,u);for(let s=0;s<t;++s)Iy(this,n[s],i[s],r[s],e[s]);return this},jy.cover=function(e,t,n){if(isNaN(e=+e)||isNaN(t=+t)||isNaN(n=+n))return this;var i=this._x0,r=this._y0,s=this._z0,o=this._x1,a=this._y1,l=this._z1;if(isNaN(i))o=(i=Math.floor(e))+1,a=(r=Math.floor(t))+1,l=(s=Math.floor(n))+1;else{for(var c,u,h=o-i||1,d=this._root;i>e||e>=o||r>t||t>=a||s>n||n>=l;)switch(u=(n<s)<<2|(t<r)<<1|e<i,(c=new Array(8))[u]=d,d=c,h*=2,u){case 0:o=i+h,a=r+h,l=s+h;break;case 1:i=o-h,a=r+h,l=s+h;break;case 2:o=i+h,r=a-h,l=s+h;break;case 3:i=o-h,r=a-h,l=s+h;break;case 4:o=i+h,a=r+h,s=l-h;break;case 5:i=o-h,a=r+h,s=l-h;break;case 6:o=i+h,r=a-h,s=l-h;break;case 7:i=o-h,r=a-h,s=l-h}this._root&&this._root.length&&(this._root=d)}return this._x0=i,this._y0=r,this._z0=s,this._x1=o,this._y1=a,this._z1=l,this},jy.data=function(){var e=[];return this.visit((function(t){if(!t.length)do{e.push(t.data)}while(t=t.next)})),e},jy.extent=function(e){return arguments.length?this.cover(+e[0][0],+e[0][1],+e[0][2]).cover(+e[1][0],+e[1][1],+e[1][2]):isNaN(this._x0)?void 0:[[this._x0,this._y0,this._z0],[this._x1,this._y1,this._z1]]},jy.find=function(e,t,n,i){var r,s,o,a,l,c,u,h,d,p=this._x0,f=this._y0,m=this._z0,g=this._x1,y=this._y1,v=this._z1,_=[],x=this._root;for(x&&_.push(new ky(x,p,f,m,g,y,v)),null==i?i=1/0:(p=e-i,f=t-i,m=n-i,g=e+i,y=t+i,v=n+i,i*=i);h=_.pop();)if(!(!(x=h.node)||(s=h.x0)>g||(o=h.y0)>y||(a=h.z0)>v||(l=h.x1)<p||(c=h.y1)<f||(u=h.z1)<m))if(x.length){var b=(s+l)/2,w=(o+c)/2,T=(a+u)/2;_.push(new ky(x[7],b,w,T,l,c,u),new ky(x[6],s,w,T,b,c,u),new ky(x[5],b,o,T,l,w,u),new ky(x[4],s,o,T,b,w,u),new ky(x[3],b,w,a,l,c,T),new ky(x[2],s,w,a,b,c,T),new ky(x[1],b,o,a,l,w,T),new ky(x[0],s,o,a,b,w,T)),(d=(n>=T)<<2|(t>=w)<<1|e>=b)&&(h=_[_.length-1],_[_.length-1]=_[_.length-1-d],_[_.length-1-d]=h)}else{var S=e-+this._x.call(null,x.data),M=t-+this._y.call(null,x.data),E=n-+this._z.call(null,x.data),A=S*S+M*M+E*E;if(A<i){var C=Math.sqrt(i=A);p=e-C,f=t-C,m=n-C,g=e+C,y=t+C,v=n+C,r=x.data}}return r},jy.findAllWithinRadius=function(e,t,n,i){const r=[],s=e-i,o=t-i,a=n-i,l=e+i,c=t+i,u=n+i;return this.visit(((h,d,p,f,m,g,y)=>{if(!h.length)do{const s=h.data;Oy(e,t,n,this._x(s),this._y(s),this._z(s))<=i&&r.push(s)}while(h=h.next);return d>l||p>c||f>u||m<s||g<o||y<a})),r},jy.remove=function(e){if(isNaN(s=+this._x.call(null,e))||isNaN(o=+this._y.call(null,e))||isNaN(a=+this._z.call(null,e)))return this;var t,n,i,r,s,o,a,l,c,u,h,d,p,f,m,g=this._root,y=this._x0,v=this._y0,_=this._z0,x=this._x1,b=this._y1,w=this._z1;if(!g)return this;if(g.length)for(;;){if((h=s>=(l=(y+x)/2))?y=l:x=l,(d=o>=(c=(v+b)/2))?v=c:b=c,(p=a>=(u=(_+w)/2))?_=u:w=u,t=g,!(g=g[f=p<<2|d<<1|h]))return this;if(!g.length)break;(t[f+1&7]||t[f+2&7]||t[f+3&7]||t[f+4&7]||t[f+5&7]||t[f+6&7]||t[f+7&7])&&(n=t,m=f)}for(;g.data!==e;)if(i=g,!(g=g.next))return this;return(r=g.next)&&delete g.next,i?(r?i.next=r:delete i.next,this):t?(r?t[f]=r:delete t[f],(g=t[0]||t[1]||t[2]||t[3]||t[4]||t[5]||t[6]||t[7])&&g===(t[7]||t[6]||t[5]||t[4]||t[3]||t[2]||t[1]||t[0])&&!g.length&&(n?n[m]=g:this._root=g),this):(this._root=r,this)},jy.removeAll=function(e){for(var t=0,n=e.length;t<n;++t)this.remove(e[t]);return this},jy.root=function(){return this._root},jy.size=function(){var e=0;return this.visit((function(t){if(!t.length)do{++e}while(t=t.next)})),e},jy.visit=function(e){var t,n,i,r,s,o,a,l,c=[],u=this._root;for(u&&c.push(new ky(u,this._x0,this._y0,this._z0,this._x1,this._y1,this._z1));t=c.pop();)if(!e(u=t.node,i=t.x0,r=t.y0,s=t.z0,o=t.x1,a=t.y1,l=t.z1)&&u.length){var h=(i+o)/2,d=(r+a)/2,p=(s+l)/2;(n=u[7])&&c.push(new ky(n,h,d,p,o,a,l)),(n=u[6])&&c.push(new ky(n,i,d,p,h,a,l)),(n=u[5])&&c.push(new ky(n,h,r,p,o,d,l)),(n=u[4])&&c.push(new ky(n,i,r,p,h,d,l)),(n=u[3])&&c.push(new ky(n,h,d,s,o,a,p)),(n=u[2])&&c.push(new ky(n,i,d,s,h,a,p)),(n=u[1])&&c.push(new ky(n,h,r,s,o,d,p)),(n=u[0])&&c.push(new ky(n,i,r,s,h,d,p))}return this},jy.visitAfter=function(e){var t,n=[],i=[];for(this._root&&n.push(new ky(this._root,this._x0,this._y0,this._z0,this._x1,this._y1,this._z1));t=n.pop();){var r=t.node;if(r.length){var s,o=t.x0,a=t.y0,l=t.z0,c=t.x1,u=t.y1,h=t.z1,d=(o+c)/2,p=(a+u)/2,f=(l+h)/2;(s=r[0])&&n.push(new ky(s,o,a,l,d,p,f)),(s=r[1])&&n.push(new ky(s,d,a,l,c,p,f)),(s=r[2])&&n.push(new ky(s,o,p,l,d,u,f)),(s=r[3])&&n.push(new ky(s,d,p,l,c,u,f)),(s=r[4])&&n.push(new ky(s,o,a,f,d,p,h)),(s=r[5])&&n.push(new ky(s,d,a,f,c,p,h)),(s=r[6])&&n.push(new ky(s,o,p,f,d,u,h)),(s=r[7])&&n.push(new ky(s,d,p,f,c,u,h))}i.push(t)}for(;t=i.pop();)e(t.node,t.x0,t.y0,t.z0,t.x1,t.y1,t.z1);return this},jy.x=function(e){return arguments.length?(this._x=e,this):this._x},jy.y=function(e){return arguments.length?(this._y=e,this):this._y},jy.z=function(e){return arguments.length?(this._z=e,this):this._z};var Yy={value:()=>{}};function Ky(){for(var e,t=0,n=arguments.length,i={};t<n;++t){if(!(e=arguments[t]+"")||e in i||/[\s.]/.test(e))throw new Error("illegal type: "+e);i[e]=[]}return new Zy(i)}function Zy(e){this._=e}function Jy(e,t){for(var n,i=0,r=e.length;i<r;++i)if((n=e[i]).name===t)return n.value}function Qy(e,t,n){for(var i=0,r=e.length;i<r;++i)if(e[i].name===t){e[i]=Yy,e=e.slice(0,i).concat(e.slice(i+1));break}return null!=n&&e.push({name:t,value:n}),e}Zy.prototype=Ky.prototype={constructor:Zy,on:function(e,t){var n,i,r=this._,s=(i=r,(e+"").trim().split(/^|\s+/).map((function(e){var t="",n=e.indexOf(".");if(n>=0&&(t=e.slice(n+1),e=e.slice(0,n)),e&&!i.hasOwnProperty(e))throw new Error("unknown type: "+e);return{type:e,name:t}}))),o=-1,a=s.length;if(!(arguments.length<2)){if(null!=t&&"function"!=typeof t)throw new Error("invalid callback: "+t);for(;++o<a;)if(n=(e=s[o]).type)r[n]=Qy(r[n],e.name,t);else if(null==t)for(n in r)r[n]=Qy(r[n],e.name,null);return this}for(;++o<a;)if((n=(e=s[o]).type)&&(n=Jy(r[n],e.name)))return n},copy:function(){var e={},t=this._;for(var n in t)e[n]=t[n].slice();return new Zy(e)},call:function(e,t){if((n=arguments.length-2)>0)for(var n,i,r=new Array(n),s=0;s<n;++s)r[s]=arguments[s+2];if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(s=0,n=(i=this._[e]).length;s<n;++s)i[s].value.apply(t,r)},apply:function(e,t,n){if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(var i=this._[e],r=0,s=i.length;r<s;++r)i[r].value.apply(t,n)}};var ev,tv,nv=0,iv=0,rv=0,sv=0,ov=0,av=0,lv="object"==typeof performance&&performance.now?performance:Date,cv="object"==typeof window&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(e){setTimeout(e,17)};function uv(){return ov||(cv(hv),ov=lv.now()+av)}function hv(){ov=0}function dv(){this._call=this._time=this._next=null}function pv(e,t,n){var i=new dv;return i.restart(e,t,n),i}function fv(){ov=(sv=lv.now())+av,nv=iv=0;try{!function(){uv(),++nv;for(var e,t=ev;t;)(e=ov-t._time)>=0&&t._call.call(void 0,e),t=t._next;--nv}()}finally{nv=0,function(){var e,t,n=ev,i=1/0;for(;n;)n._call?(i>n._time&&(i=n._time),e=n,n=n._next):(t=n._next,n._next=null,n=e?e._next=t:ev=t);tv=e,gv(i)}(),ov=0}}function mv(){var e=lv.now(),t=e-sv;t>1e3&&(av-=t,sv=e)}function gv(e){nv||(iv&&(iv=clearTimeout(iv)),e-ov>24?(e<1/0&&(iv=setTimeout(fv,e-lv.now()-av)),rv&&(rv=clearInterval(rv))):(rv||(sv=lv.now(),rv=setInterval(mv,1e3)),nv=1,cv(fv)))}function yv(e,t,n){var i=new dv;return t=null==t?0:+t,i.restart((n=>{i.stop(),e(n+t)}),t,n),i}dv.prototype=pv.prototype={constructor:dv,restart:function(e,t,n){if("function"!=typeof e)throw new TypeError("callback is not a function");n=(null==n?uv():+n)+(null==t?0:+t),this._next||tv===this||(tv?tv._next=this:ev=this,tv=this),this._call=e,this._time=n,gv()},stop:function(){this._call&&(this._call=null,this._time=1/0,gv())}};const vv=4294967296;function _v(e){return e.x}function xv(e){return e.y}function bv(e){return e.z}var wv,Tv,Sv,Mv,Ev=Math.PI*(3-Math.sqrt(5)),Av=20*Math.PI/(9+Math.sqrt(221));function Cv(e,t){t=t||2;var n,i=Math.min(3,Math.max(1,Math.round(t))),r=1,s=.001,o=1-Math.pow(s,1/300),a=0,l=.6,c=new Map,u=pv(p),h=Ky("tick","end"),d=function(){let e=1;return()=>(e=(1664525*e+1013904223)%vv)/vv}();function p(){f(),h.call("tick",n),r<s&&(u.stop(),h.call("end",n))}function f(t){var s,u,h=e.length;void 0===t&&(t=1);for(var d=0;d<t;++d)for(r+=(a-r)*o,c.forEach((function(e){e(r)})),s=0;s<h;++s)null==(u=e[s]).fx?u.x+=u.vx*=l:(u.x=u.fx,u.vx=0),i>1&&(null==u.fy?u.y+=u.vy*=l:(u.y=u.fy,u.vy=0)),i>2&&(null==u.fz?u.z+=u.vz*=l:(u.z=u.fz,u.vz=0));return n}function m(){for(var t,n=0,r=e.length;n<r;++n){if((t=e[n]).index=n,null!=t.fx&&(t.x=t.fx),null!=t.fy&&(t.y=t.fy),null!=t.fz&&(t.z=t.fz),isNaN(t.x)||i>1&&isNaN(t.y)||i>2&&isNaN(t.z)){var s=10*(i>2?Math.cbrt(.5+n):i>1?Math.sqrt(.5+n):n),o=n*Ev,a=n*Av;1===i?t.x=s:2===i?(t.x=s*Math.cos(o),t.y=s*Math.sin(o)):(t.x=s*Math.sin(o)*Math.cos(a),t.y=s*Math.cos(o),t.z=s*Math.sin(o)*Math.sin(a))}(isNaN(t.vx)||i>1&&isNaN(t.vy)||i>2&&isNaN(t.vz))&&(t.vx=0,i>1&&(t.vy=0),i>2&&(t.vz=0))}}function g(t){return t.initialize&&t.initialize(e,d,i),t}return null==e&&(e=[]),m(),n={tick:f,restart:function(){return u.restart(p),n},stop:function(){return u.stop(),n},numDimensions:function(e){return arguments.length?(i=Math.min(3,Math.max(1,Math.round(e))),c.forEach(g),n):i},nodes:function(t){return arguments.length?(e=t,m(),c.forEach(g),n):e},alpha:function(e){return arguments.length?(r=+e,n):r},alphaMin:function(e){return arguments.length?(s=+e,n):s},alphaDecay:function(e){return arguments.length?(o=+e,n):+o},alphaTarget:function(e){return arguments.length?(a=+e,n):a},velocityDecay:function(e){return arguments.length?(l=1-e,n):1-l},randomSource:function(e){return arguments.length?(d=e,c.forEach(g),n):d},force:function(e,t){return arguments.length>1?(null==t?c.delete(e):c.set(e,g(t)),n):c.get(e)},find:function(){var t,n,r,s,o,a,l=Array.prototype.slice.call(arguments),c=l.shift()||0,u=(i>1?l.shift():null)||0,h=(i>2?l.shift():null)||0,d=l.shift()||1/0,p=0,f=e.length;for(d*=d,p=0;p<f;++p)(s=(t=c-(o=e[p]).x)*t+(n=u-(o.y||0))*n+(r=h-(o.z||0))*r)<d&&(a=o,d=s);return a},on:function(e,t){return arguments.length>1?(h.on(e,t),n):h.on(e)}}}function Rv(){var e,t,n,i,r,s,o=Hy(-30),a=1,l=1/0,c=.81;function u(i){var s,o=e.length,a=(1===t?wy(e,_v):2===t?Ny(e,_v,xv):3===t?zy(e,_v,xv,bv):null).visitAfter(d);for(r=i,s=0;s<o;++s)n=e[s],a.visit(p)}function h(){if(e){var t,n,i=e.length;for(s=new Array(i),t=0;t<i;++t)n=e[t],s[n.index]=+o(n,t,e)}}function d(e){var n,i,r,o,a,l,c=0,u=0,h=e.length;if(h){for(r=o=a=l=0;l<h;++l)(n=e[l])&&(i=Math.abs(n.value))&&(c+=n.value,u+=i,r+=i*(n.x||0),o+=i*(n.y||0),a+=i*(n.z||0));c*=Math.sqrt(4/h),e.x=r/u,t>1&&(e.y=o/u),t>2&&(e.z=a/u)}else{(n=e).x=n.data.x,t>1&&(n.y=n.data.y),t>2&&(n.z=n.data.z);do{c+=s[n.data.index]}while(n=n.next)}e.value=c}function p(e,o,u,h,d){if(!e.value)return!0;var p=[u,h,d][t-1],f=e.x-n.x,m=t>1?e.y-n.y:0,g=t>2?e.z-n.z:0,y=p-o,v=f*f+m*m+g*g;if(y*y/c<v)return v<l&&(0===f&&(v+=(f=Wy(i))*f),t>1&&0===m&&(v+=(m=Wy(i))*m),t>2&&0===g&&(v+=(g=Wy(i))*g),v<a&&(v=Math.sqrt(a*v)),n.vx+=f*e.value*r/v,t>1&&(n.vy+=m*e.value*r/v),t>2&&(n.vz+=g*e.value*r/v)),!0;if(!(e.length||v>=l)){(e.data!==n||e.next)&&(0===f&&(v+=(f=Wy(i))*f),t>1&&0===m&&(v+=(m=Wy(i))*m),t>2&&0===g&&(v+=(g=Wy(i))*g),v<a&&(v=Math.sqrt(a*v)));do{e.data!==n&&(y=s[e.data.index]*r/v,n.vx+=f*y,t>1&&(n.vy+=m*y),t>2&&(n.vz+=g*y))}while(e=e.next)}}return u.initialize=function(n,...r){e=n,i=r.find((e=>"function"==typeof e))||Math.random,t=r.find((e=>[1,2,3].includes(e)))||2,h()},u.strength=function(e){return arguments.length?(o="function"==typeof e?e:Hy(+e),h(),u):o},u.distanceMin=function(e){return arguments.length?(a=e*e,u):Math.sqrt(a)},u.distanceMax=function(e){return arguments.length?(l=e*e,u):Math.sqrt(l)},u.theta=function(e){return arguments.length?(c=e*e,u):Math.sqrt(c)},u}function Nv(e,t,n,i){var r,s,o,a,l=Hy(.1);function c(e){for(var l=0,c=r.length;l<c;++l){var u=r[l],h=u.x-t||1e-6,d=(u.y||0)-n||1e-6,p=(u.z||0)-i||1e-6,f=Math.sqrt(h*h+d*d+p*p),m=(a[l]-f)*o[l]*e/f;u.vx+=h*m,s>1&&(u.vy+=d*m),s>2&&(u.vz+=p*m)}}function u(){if(r){var t,n=r.length;for(o=new Array(n),a=new Array(n),t=0;t<n;++t)a[t]=+e(r[t],t,r),o[t]=isNaN(a[t])?0:+l(r[t],t,r)}}return"function"!=typeof e&&(e=Hy(+e)),null==t&&(t=0),null==n&&(n=0),null==i&&(i=0),c.initialize=function(e,...t){r=e,s=t.find((e=>[1,2,3].includes(e)))||2,u()},c.strength=function(e){return arguments.length?(l="function"==typeof e?e:Hy(+e),u(),c):l},c.radius=function(t){return arguments.length?(e="function"==typeof t?t:Hy(+t),u(),c):e},c.x=function(e){return arguments.length?(t=+e,c):t},c.y=function(e){return arguments.length?(n=+e,c):n},c.z=function(e){return arguments.length?(i=+e,c):i},c}function Pv(){if(Tv)return wv;return Tv=1,wv=function(e){!function(e){if(!e)throw new Error("Eventify cannot use falsy object as events subject");for(var t=["on","fire","off"],n=0;n<t.length;++n)if(e.hasOwnProperty(t[n]))throw new Error("Subject cannot be eventified, since it already has property '"+t[n]+"'")}(e);var t=function(e){var t=Object.create(null);return{on:function(n,i,r){if("function"!=typeof i)throw new Error("callback is expected to be a function");var s=t[n];return s||(s=t[n]=[]),s.push({callback:i,ctx:r}),e},off:function(n,i){if(void 0===n)return t=Object.create(null),e;if(t[n])if("function"!=typeof i)delete t[n];else for(var r=t[n],s=0;s<r.length;++s)r[s].callback===i&&r.splice(s,1);return e},fire:function(n){var i,r=t[n];if(!r)return e;arguments.length>1&&(i=Array.prototype.splice.call(arguments,1));for(var s=0;s<r.length;++s){var o=r[s];o.callback.apply(o.ctx,i)}return e}}}(e);return e.on=t.on,e.off=t.off,e.fire=t.fire,e},wv}var Dv,Lv,Iv,kv,Ov,Uv=function(){if(Mv)return Sv;Mv=1,Sv=function(s){"uniqueLinkId"in(s=s||{})&&(console.warn("ngraph.graph: Starting from version 0.14 `uniqueLinkId` is deprecated.\nUse `multigraph` option instead\n","\n","Note: there is also change in default behavior: From now on each graph\nis considered to be not a multigraph by default (each edge is unique)."),s.multigraph=s.uniqueLinkId);void 0===s.multigraph&&(s.multigraph=!1);if("function"!=typeof Map)throw new Error("ngraph.graph requires `Map` to be defined. Please polyfill it before using ngraph");var o=new Map,a=new Map,l={},c=0,u=s.multigraph?function(e,t,n){var s=r(e,t),o=l.hasOwnProperty(s);if(o||M(e,t)){o||(l[s]=0);var a="@"+ ++l[s];s=r(e+a,t+a)}return new i(e,t,n,s)}:function(e,t,n){var s=r(e,t),o=a.get(s);if(o)return o.data=n,o;return new i(e,t,n,s)},h=[],d=E,p=E,f=E,m=E,g={version:20,addNode:_,addLink:function(e,t,i){f();var r=x(e)||_(e),s=x(t)||_(t),o=u(e,t,i),l=a.has(o.id);a.set(o.id,o),n(r,o),e!==t&&n(s,o);return d(o,l?"update":"add"),m(),o},removeLink:function(e,t){void 0!==t&&(e=M(e,t));return S(e)},removeNode:b,getNode:x,getNodeCount:w,getLinkCount:T,getEdgeCount:T,getLinksCount:T,getNodesCount:w,getLinks:function(e){var t=x(e);return t?t.links:null},forEachNode:R,forEachLinkedNode:function(e,t,n){var i=x(e);if(i&&i.links&&"function"==typeof t)return n?function(e,t,n){var i=e.values(),r=i.next();for(;!r.done;){var s=r.value;if(s.fromId===t&&n(o.get(s.toId),s))return!0;r=i.next()}}(i.links,e,t):function(e,t,n){var i=e.values(),r=i.next();for(;!r.done;){var s=r.value,a=s.fromId===t?s.toId:s.fromId;if(n(o.get(a),s))return!0;r=i.next()}}(i.links,e,t)},forEachLink:function(e){if("function"==typeof e)for(var t=a.values(),n=t.next();!n.done;){if(e(n.value))return!0;n=t.next()}},beginUpdate:f,endUpdate:m,clear:function(){f(),R((function(e){b(e.id)})),m()},hasLink:M,hasNode:x,getLink:M};return e(g),function(){var e=g.on;function t(){return g.beginUpdate=f=A,g.endUpdate=m=C,d=y,p=v,g.on=e,e.apply(g,arguments)}g.on=t}(),g;function y(e,t){h.push({link:e,changeType:t})}function v(e,t){h.push({node:e,changeType:t})}function _(e,n){if(void 0===e)throw new Error("Invalid node identifier");f();var i=x(e);return i?(i.data=n,p(i,"update")):(i=new t(e,n),p(i,"add")),o.set(e,i),m(),i}function x(e){return o.get(e)}function b(e){var t=x(e);if(!t)return!1;f();var n=t.links;return n&&(n.forEach(S),t.links=null),o.delete(e),p(t,"remove"),m(),!0}function w(){return o.size}function T(){return a.size}function S(e){if(!e)return!1;if(!a.get(e.id))return!1;f(),a.delete(e.id);var t=x(e.fromId),n=x(e.toId);return t&&t.links.delete(e),n&&n.links.delete(e),d(e,"remove"),m(),!0}function M(e,t){if(void 0!==e&&void 0!==t)return a.get(r(e,t))}function E(){}function A(){c+=1}function C(){0===(c-=1)&&h.length>0&&(g.fire("changed",h),h.length=0)}function R(e){if("function"!=typeof e)throw new Error("Function is expected to iterate over graph nodes. You passed "+e);for(var t=o.values(),n=t.next();!n.done;){if(e(n.value))return!0;n=t.next()}}};var e=Pv();function t(e,t){this.id=e,this.links=null,this.data=t}function n(e,t){e.links?e.links.add(t):e.links=new Set([t])}function i(e,t,n,i){this.fromId=e,this.toId=t,this.data=n,this.id=i}function r(e,t){return e.toString()+"👉 "+t.toString()}return Sv}(),Fv=f(Uv),Bv={exports:{}},zv={exports:{}};function Vv(){return Lv||(Lv=1,Dv=function(e){return 0===e?"x":1===e?"y":2===e?"z":"c"+(e+1)}),Dv}function Gv(){if(kv)return Iv;kv=1;const e=Vv();return Iv=function(t){return function(n,i){let r=i&&i.indent||0,s=i&&void 0!==i.join?i.join:"\n",o=Array(r+1).join(" "),a=[];for(let i=0;i<t;++i){let t=e(i),r=0===i?"":o;a.push(r+n.replace(/{var}/g,t))}return a.join(s)}},Iv}var jv,Hv={exports:{}};var Wv,qv={exports:{}};var Xv,$v={exports:{}};var Yv,Kv={exports:{}};var Zv,Jv,Qv,e_,t_,n_={exports:{}};var i_,r_,s_,o_,a_={exports:{}};function l_(){if(s_)return r_;s_=1,r_=function(l){var c=(Qv||(Qv=1,Jv=function(e,t,n,i){this.from=e,this.to=t,this.length=n,this.coefficient=i}),Jv),u=(t_||(t_=1,e_=function e(t,n){var i;if(t||(t={}),n)for(i in n)if(n.hasOwnProperty(i)){var r=t.hasOwnProperty(i),s=typeof n[i];r&&typeof t[i]===s?"object"===s&&(t[i]=e(t[i],n[i])):t[i]=n[i]}return t}),e_),h=Pv();if(l){if(void 0!==l.springCoeff)throw new Error("springCoeff was renamed to springCoefficient");if(void 0!==l.dragCoeff)throw new Error("dragCoeff was renamed to dragCoefficient")}l=u(l,{springLength:10,springCoefficient:.8,gravity:-12,theta:.8,dragCoefficient:.9,timeStep:.5,adaptiveTimeStepWeight:0,dimensions:2,debug:!1});var d=o[l.dimensions];if(!d){var p=l.dimensions;d={Body:e(p,l.debug),createQuadTree:t(p),createBounds:n(p),createDragForce:i(p),createSpringForce:r(p),integrate:s(p)},o[p]=d}var f=d.Body,m=d.createQuadTree,g=d.createBounds,y=d.createDragForce,v=d.createSpringForce,_=d.integrate,x=function(){if(i_)return a_.exports;function e(e){return new t("number"==typeof e?e:+new Date)}function t(e){this.seed=e}function n(e){return Math.sqrt(2*Math.PI/e)*Math.pow(1/Math.E*(e+1/(12*e-1/(10*e))),e)}function i(){var e=this.seed;return e=4294967295&(3042594569^(e=4251993797+(e=4294967295&(3550635116+(e=374761393+(e=4294967295&(3345072700^(e=e+2127912214+(e<<12)&4294967295)^e>>>19))+(e<<5)&4294967295)^e<<9))+(e<<3)&4294967295)^e>>>16),this.seed=e,(268435455&e)/268435456}return i_=1,a_.exports=e,a_.exports.random=e,a_.exports.randomIterator=function(t,n){var i=n||e();if("function"!=typeof i.next)throw new Error("customRandom does not match expected API: next() function is missing");return{forEach:function(e){var n,r,s;for(n=t.length-1;n>0;--n)r=i.next(n+1),s=t[r],t[r]=t[n],t[n]=s,e(s);t.length&&e(t[0])},shuffle:function(){var e,n,r;for(e=t.length-1;e>0;--e)n=i.next(e+1),r=t[n],t[n]=t[e],t[e]=r;return t}}},t.prototype.next=function(e){return Math.floor(this.nextDouble()*e)},t.prototype.nextDouble=i,t.prototype.uniform=i,t.prototype.gaussian=function(){var e,t,n;do{e=(t=2*this.nextDouble()-1)*t+(n=2*this.nextDouble()-1)*n}while(e>=1||0===e);return t*Math.sqrt(-2*Math.log(e)/e)},t.prototype.random=i,t.prototype.levy=function(){var e=1.5,t=Math.pow(n(2.5)*Math.sin(Math.PI*e/2)/(n(1.25)*e*Math.pow(2,.25)),1/e);return this.gaussian()*t/Math.pow(Math.abs(this.gaussian()),1/e)},a_.exports}().random(42),b=[],w=[],T=m(l,x),S=g(b,l,x),M=v(l,x),E=y(l),A=[],C=new Map,R=0;D("nbody",(function(){if(0===b.length)return;T.insertBodies(b);var e=b.length;for(;e--;){var t=b[e];t.isPinned||(t.reset(),T.updateBodyForce(t),E.update(t))}})),D("spring",(function(){var e=w.length;for(;e--;)M.update(w[e])}));var N={bodies:b,quadTree:T,springs:w,settings:l,addForce:D,removeForce:function(e){var t=A.indexOf(C.get(e));if(t<0)return;A.splice(t,1),C.delete(e)},getForces:function(){return C},step:function(){for(var e=0;e<A.length;++e)A[e](R);var t=_(b,l.timeStep,l.adaptiveTimeStepWeight);return R+=1,t},addBody:function(e){if(!e)throw new Error("Body is required");return b.push(e),e},addBodyAt:function(e){if(!e)throw new Error("Body position is required");var t=(e=>new f(e))(e);return b.push(t),t},removeBody:function(e){if(e){var t=b.indexOf(e);if(!(t<0))return b.splice(t,1),0===b.length&&S.reset(),!0}},addSpring:function(e,t,n,i){if(!e||!t)throw new Error("Cannot add null spring to force simulator");"number"!=typeof n&&(n=-1);var r=new c(e,t,n,i>=0?i:-1);return w.push(r),r},getTotalMovement:function(){return 0},removeSpring:function(e){if(e){var t=w.indexOf(e);return t>-1?(w.splice(t,1),!0):void 0}},getBestNewBodyPosition:function(e){return S.getBestNewPosition(e)},getBBox:P,getBoundingBox:P,invalidateBBox:function(){console.warn("invalidateBBox() is deprecated, bounds always recomputed on `getBBox()` call")},gravity:function(e){return void 0!==e?(l.gravity=e,T.options({gravity:e}),this):l.gravity},theta:function(e){return void 0!==e?(l.theta=e,T.options({theta:e}),this):l.theta},random:x};return function(e,t){for(var n in e)a(e,t,n)}(l,N),h(N),N;function P(){return S.update(),S.box}function D(e,t){if(C.has(e))throw new Error("Force "+e+" is already added");C.set(e,t),A.push(t)}};var e=function(){if(Ov)return zv.exports;Ov=1;const e=Gv();function t(e,t){return`\n${i(e,t)}\n${n(e)}\nreturn {Body: Body, Vector: Vector};\n`}function n(t){let n=e(t),i=n("{var}",{join:", "});return`\nfunction Body(${i}) {\n  this.isPinned = false;\n  this.pos = new Vector(${i});\n  this.force = new Vector();\n  this.velocity = new Vector();\n  this.mass = 1;\n\n  this.springCount = 0;\n  this.springLength = 0;\n}\n\nBody.prototype.reset = function() {\n  this.force.reset();\n  this.springCount = 0;\n  this.springLength = 0;\n}\n\nBody.prototype.setPosition = function (${i}) {\n  ${n("this.pos.{var} = {var} || 0;",{indent:2})}\n};`}function i(t,n){let i=e(t),r="";return n&&(r=`${i("\n\t   var v{var};\n\tObject.defineProperty(this, '{var}', {\n\t  set: function(v) { \n\t    if (!Number.isFinite(v)) throw new Error('Cannot set non-numbers to {var}');\n\t    v{var} = v; \n\t  },\n\t  get: function() { return v{var}; }\n\t});")}`),`function Vector(${i("{var}",{join:", "})}) {\n  ${r}\n    if (typeof arguments[0] === 'object') {\n      // could be another vector\n      let v = arguments[0];\n      ${i('if (!Number.isFinite(v.{var})) throw new Error("Expected value is not a finite number at Vector constructor ({var})");',{indent:4})}\n      ${i("this.{var} = v.{var};",{indent:4})}\n    } else {\n      ${i('this.{var} = typeof {var} === "number" ? {var} : 0;',{indent:4})}\n    }\n  }\n  \n  Vector.prototype.reset = function () {\n    ${i("this.{var} = ",{join:""})}0;\n  };`}return zv.exports=function(e,n){let i=t(e,n),{Body:r}=new Function(i)();return r},zv.exports.generateCreateBodyFunctionBody=t,zv.exports.getVectorCode=i,zv.exports.getBodyCode=n,zv.exports}(),t=function(){if(jv)return Hv.exports;jv=1;const e=Gv(),t=Vv();function n(n){let l=e(n),c=Math.pow(2,n),u=`\n${a()}\n${o(n)}\n${i(n)}\n${s(n)}\n${r(n)}\n\nfunction createQuadTree(options, random) {\n  options = options || {};\n  options.gravity = typeof options.gravity === 'number' ? options.gravity : -1;\n  options.theta = typeof options.theta === 'number' ? options.theta : 0.8;\n\n  var gravity = options.gravity;\n  var updateQueue = [];\n  var insertStack = new InsertStack();\n  var theta = options.theta;\n\n  var nodesCache = [];\n  var currentInCache = 0;\n  var root = newNode();\n\n  return {\n    insertBodies: insertBodies,\n\n    /**\n     * Gets root node if it is present\n     */\n    getRoot: function() {\n      return root;\n    },\n\n    updateBodyForce: update,\n\n    options: function(newOptions) {\n      if (newOptions) {\n        if (typeof newOptions.gravity === 'number') {\n          gravity = newOptions.gravity;\n        }\n        if (typeof newOptions.theta === 'number') {\n          theta = newOptions.theta;\n        }\n\n        return this;\n      }\n\n      return {\n        gravity: gravity,\n        theta: theta\n      };\n    }\n  };\n\n  function newNode() {\n    // To avoid pressure on GC we reuse nodes.\n    var node = nodesCache[currentInCache];\n    if (node) {\n${function(e){let t=[];for(let n=0;n<c;++n)t.push(`${e}quad${n} = null;`);return t.join("\n")}("      node.")}\n      node.body = null;\n      node.mass = ${l("node.mass_{var} = ",{join:""})}0;\n      ${l("node.min_{var} = node.max_{var} = ",{join:""})}0;\n    } else {\n      node = new QuadNode();\n      nodesCache[currentInCache] = node;\n    }\n\n    ++currentInCache;\n    return node;\n  }\n\n  function update(sourceBody) {\n    var queue = updateQueue;\n    var v;\n    ${l("var d{var};",{indent:4})}\n    var r; \n    ${l("var f{var} = 0;",{indent:4})}\n    var queueLength = 1;\n    var shiftIdx = 0;\n    var pushIdx = 1;\n\n    queue[0] = root;\n\n    while (queueLength) {\n      var node = queue[shiftIdx];\n      var body = node.body;\n\n      queueLength -= 1;\n      shiftIdx += 1;\n      var differentBody = (body !== sourceBody);\n      if (body && differentBody) {\n        // If the current node is a leaf node (and it is not source body),\n        // calculate the force exerted by the current node on body, and add this\n        // amount to body's net force.\n        ${l("d{var} = body.pos.{var} - sourceBody.pos.{var};",{indent:8})}\n        r = Math.sqrt(${l("d{var} * d{var}",{join:" + "})});\n\n        if (r === 0) {\n          // Poor man's protection against zero distance.\n          ${l("d{var} = (random.nextDouble() - 0.5) / 50;",{indent:10})}\n          r = Math.sqrt(${l("d{var} * d{var}",{join:" + "})});\n        }\n\n        // This is standard gravitation force calculation but we divide\n        // by r^3 to save two operations when normalizing force vector.\n        v = gravity * body.mass * sourceBody.mass / (r * r * r);\n        ${l("f{var} += v * d{var};",{indent:8})}\n      } else if (differentBody) {\n        // Otherwise, calculate the ratio s / r,  where s is the width of the region\n        // represented by the internal node, and r is the distance between the body\n        // and the node's center-of-mass\n        ${l("d{var} = node.mass_{var} / node.mass - sourceBody.pos.{var};",{indent:8})}\n        r = Math.sqrt(${l("d{var} * d{var}",{join:" + "})});\n\n        if (r === 0) {\n          // Sorry about code duplication. I don't want to create many functions\n          // right away. Just want to see performance first.\n          ${l("d{var} = (random.nextDouble() - 0.5) / 50;",{indent:10})}\n          r = Math.sqrt(${l("d{var} * d{var}",{join:" + "})});\n        }\n        // If s / r < θ, treat this internal node as a single body, and calculate the\n        // force it exerts on sourceBody, and add this amount to sourceBody's net force.\n        if ((node.max_${t(0)} - node.min_${t(0)}) / r < theta) {\n          // in the if statement above we consider node's width only\n          // because the region was made into square during tree creation.\n          // Thus there is no difference between using width or height.\n          v = gravity * node.mass * sourceBody.mass / (r * r * r);\n          ${l("f{var} += v * d{var};",{indent:10})}\n        } else {\n          // Otherwise, run the procedure recursively on each of the current node's children.\n\n          // I intentionally unfolded this loop, to save several CPU cycles.\n${function(){let e=Array(11).join(" "),t=[];for(let n=0;n<c;++n)t.push(e+`if (node.quad${n}) {`),t.push(e+`  queue[pushIdx] = node.quad${n};`),t.push(e+"  queueLength += 1;"),t.push(e+"  pushIdx += 1;"),t.push(e+"}");return t.join("\n")}()}\n        }\n      }\n    }\n\n    ${l("sourceBody.force.{var} += f{var};",{indent:4})}\n  }\n\n  function insertBodies(bodies) {\n    ${l("var {var}min = Number.MAX_VALUE;",{indent:4})}\n    ${l("var {var}max = Number.MIN_VALUE;",{indent:4})}\n    var i = bodies.length;\n\n    // To reduce quad tree depth we are looking for exact bounding box of all particles.\n    while (i--) {\n      var pos = bodies[i].pos;\n      ${l("if (pos.{var} < {var}min) {var}min = pos.{var};",{indent:6})}\n      ${l("if (pos.{var} > {var}max) {var}max = pos.{var};",{indent:6})}\n    }\n\n    // Makes the bounds square.\n    var maxSideLength = -Infinity;\n    ${l("if ({var}max - {var}min > maxSideLength) maxSideLength = {var}max - {var}min ;",{indent:4})}\n\n    currentInCache = 0;\n    root = newNode();\n    ${l("root.min_{var} = {var}min;",{indent:4})}\n    ${l("root.max_{var} = {var}min + maxSideLength;",{indent:4})}\n\n    i = bodies.length - 1;\n    if (i >= 0) {\n      root.body = bodies[i];\n    }\n    while (i--) {\n      insert(bodies[i], root);\n    }\n  }\n\n  function insert(newBody) {\n    insertStack.reset();\n    insertStack.push(root, newBody);\n\n    while (!insertStack.isEmpty()) {\n      var stackItem = insertStack.pop();\n      var node = stackItem.node;\n      var body = stackItem.body;\n\n      if (!node.body) {\n        // This is internal node. Update the total mass of the node and center-of-mass.\n        ${l("var {var} = body.pos.{var};",{indent:8})}\n        node.mass += body.mass;\n        ${l("node.mass_{var} += body.mass * {var};",{indent:8})}\n\n        // Recursively insert the body in the appropriate quadrant.\n        // But first find the appropriate quadrant.\n        var quadIdx = 0; // Assume we are in the 0's quad.\n        ${l("var min_{var} = node.min_{var};",{indent:8})}\n        ${l("var max_{var} = (min_{var} + node.max_{var}) / 2;",{indent:8})}\n\n${function(){let e=[],i=Array(8+1).join(" ");for(let r=0;r<n;++r)e.push(i+`if (${t(r)} > max_${t(r)}) {`),e.push(i+`  quadIdx = quadIdx + ${Math.pow(2,r)};`),e.push(i+`  min_${t(r)} = max_${t(r)};`),e.push(i+`  max_${t(r)} = node.max_${t(r)};`),e.push(i+"}");return e.join("\n")}()}\n\n        var child = getChild(node, quadIdx);\n\n        if (!child) {\n          // The node is internal but this quadrant is not taken. Add\n          // subnode to it.\n          child = newNode();\n          ${l("child.min_{var} = min_{var};",{indent:10})}\n          ${l("child.max_{var} = max_{var};",{indent:10})}\n          child.body = body;\n\n          setChild(node, quadIdx, child);\n        } else {\n          // continue searching in this quadrant.\n          insertStack.push(child, body);\n        }\n      } else {\n        // We are trying to add to the leaf node.\n        // We have to convert current leaf into internal node\n        // and continue adding two nodes.\n        var oldBody = node.body;\n        node.body = null; // internal nodes do not cary bodies\n\n        if (isSamePosition(oldBody.pos, body.pos)) {\n          // Prevent infinite subdivision by bumping one node\n          // anywhere in this quadrant\n          var retriesCount = 3;\n          do {\n            var offset = random.nextDouble();\n            ${l("var d{var} = (node.max_{var} - node.min_{var}) * offset;",{indent:12})}\n\n            ${l("oldBody.pos.{var} = node.min_{var} + d{var};",{indent:12})}\n            retriesCount -= 1;\n            // Make sure we don't bump it out of the box. If we do, next iteration should fix it\n          } while (retriesCount > 0 && isSamePosition(oldBody.pos, body.pos));\n\n          if (retriesCount === 0 && isSamePosition(oldBody.pos, body.pos)) {\n            // This is very bad, we ran out of precision.\n            // if we do not return from the method we'll get into\n            // infinite loop here. So we sacrifice correctness of layout, and keep the app running\n            // Next layout iteration should get larger bounding box in the first step and fix this\n            return;\n          }\n        }\n        // Next iteration should subdivide node further.\n        insertStack.push(node, oldBody);\n        insertStack.push(node, body);\n      }\n    }\n  }\n}\nreturn createQuadTree;\n\n`;return u}function i(t){let n=e(t);return`\n  function isSamePosition(point1, point2) {\n    ${n("var d{var} = Math.abs(point1.{var} - point2.{var});",{indent:2})}\n  \n    return ${n("d{var} < 1e-8",{join:" && "})};\n  }  \n`}function r(e){var t=Math.pow(2,e);return`\nfunction setChild(node, idx, child) {\n  ${function(){let e=[];for(let n=0;n<t;++n){let t=0===n?"  ":"  else ";e.push(`${t}if (idx === ${n}) node.quad${n} = child;`)}return e.join("\n")}()}\n}`}function s(e){return`function getChild(node, idx) {\n${function(){let t=[],n=Math.pow(2,e);for(let e=0;e<n;++e)t.push(`  if (idx === ${e}) return node.quad${e};`);return t.join("\n")}()}\n  return null;\n}`}function o(t){let n=e(t),i=Math.pow(2,t);var r=`\nfunction QuadNode() {\n  // body stored inside this node. In quad tree only leaf nodes (by construction)\n  // contain bodies:\n  this.body = null;\n\n  // Child nodes are stored in quads. Each quad is presented by number:\n  // 0 | 1\n  // -----\n  // 2 | 3\n${function(e){let t=[];for(let n=0;n<i;++n)t.push(`${e}quad${n} = null;`);return t.join("\n")}("  this.")}\n\n  // Total mass of current node\n  this.mass = 0;\n\n  // Center of mass coordinates\n  ${n("this.mass_{var} = 0;",{indent:2})}\n\n  // bounding box coordinates\n  ${n("this.min_{var} = 0;",{indent:2})}\n  ${n("this.max_{var} = 0;",{indent:2})}\n}\n`;return r}function a(){return"\n/**\n * Our implementation of QuadTree is non-recursive to avoid GC hit\n * This data structure represent stack of elements\n * which we are trying to insert into quad tree.\n */\nfunction InsertStack () {\n    this.stack = [];\n    this.popIdx = 0;\n}\n\nInsertStack.prototype = {\n    isEmpty: function() {\n        return this.popIdx === 0;\n    },\n    push: function (node, body) {\n        var item = this.stack[this.popIdx];\n        if (!item) {\n            // we are trying to avoid memory pressure: create new element\n            // only when absolutely necessary\n            this.stack[this.popIdx] = new InsertStackElement(node, body);\n        } else {\n            item.node = node;\n            item.body = body;\n        }\n        ++this.popIdx;\n    },\n    pop: function () {\n        if (this.popIdx > 0) {\n            return this.stack[--this.popIdx];\n        }\n    },\n    reset: function () {\n        this.popIdx = 0;\n    }\n};\n\nfunction InsertStackElement(node, body) {\n    this.node = node; // QuadTree node\n    this.body = body; // physical body which needs to be inserted to node\n}\n"}return Hv.exports=function(e){let t=n(e);return new Function(t)()},Hv.exports.generateQuadTreeFunctionBody=n,Hv.exports.getInsertStackCode=a,Hv.exports.getQuadNodeCode=o,Hv.exports.isSamePosition=i,Hv.exports.getChildBodyCode=s,Hv.exports.setChildBodyCode=r,Hv.exports}(),n=function(){if(Wv)return qv.exports;Wv=1,qv.exports=function(e){let n=t(e);return new Function("bodies","settings","random",n)},qv.exports.generateFunctionBody=t;const e=Gv();function t(t){let n=e(t);return`\n  var boundingBox = {\n    ${n("min_{var}: 0, max_{var}: 0,",{indent:4})}\n  };\n\n  return {\n    box: boundingBox,\n\n    update: updateBoundingBox,\n\n    reset: resetBoundingBox,\n\n    getBestNewPosition: function (neighbors) {\n      var ${n("base_{var} = 0",{join:", "})};\n\n      if (neighbors.length) {\n        for (var i = 0; i < neighbors.length; ++i) {\n          let neighborPos = neighbors[i].pos;\n          ${n("base_{var} += neighborPos.{var};",{indent:10})}\n        }\n\n        ${n("base_{var} /= neighbors.length;",{indent:8})}\n      } else {\n        ${n("base_{var} = (boundingBox.min_{var} + boundingBox.max_{var}) / 2;",{indent:8})}\n      }\n\n      var springLength = settings.springLength;\n      return {\n        ${n("{var}: base_{var} + (random.nextDouble() - 0.5) * springLength,",{indent:8})}\n      };\n    }\n  };\n\n  function updateBoundingBox() {\n    var i = bodies.length;\n    if (i === 0) return; // No bodies - no borders.\n\n    ${n("var max_{var} = -Infinity;",{indent:4})}\n    ${n("var min_{var} = Infinity;",{indent:4})}\n\n    while(i--) {\n      // this is O(n), it could be done faster with quadtree, if we check the root node bounds\n      var bodyPos = bodies[i].pos;\n      ${n("if (bodyPos.{var} < min_{var}) min_{var} = bodyPos.{var};",{indent:6})}\n      ${n("if (bodyPos.{var} > max_{var}) max_{var} = bodyPos.{var};",{indent:6})}\n    }\n\n    ${n("boundingBox.min_{var} = min_{var};",{indent:4})}\n    ${n("boundingBox.max_{var} = max_{var};",{indent:4})}\n  }\n\n  function resetBoundingBox() {\n    ${n("boundingBox.min_{var} = boundingBox.max_{var} = 0;",{indent:4})}\n  }\n`}return qv.exports}(),i=function(){if(Xv)return $v.exports;Xv=1;const e=Gv();function t(t){return`\n  if (!Number.isFinite(options.dragCoefficient)) throw new Error('dragCoefficient is not a finite number');\n\n  return {\n    update: function(body) {\n      ${e(t)("body.force.{var} -= options.dragCoefficient * body.velocity.{var};",{indent:6})}\n    }\n  };\n`}return $v.exports=function(e){let n=t(e);return new Function("options",n)},$v.exports.generateCreateDragForceFunctionBody=t,$v.exports}(),r=function(){if(Yv)return Kv.exports;Yv=1;const e=Gv();function t(t){let n=e(t);return`\n  if (!Number.isFinite(options.springCoefficient)) throw new Error('Spring coefficient is not a number');\n  if (!Number.isFinite(options.springLength)) throw new Error('Spring length is not a number');\n\n  return {\n    /**\n     * Updates forces acting on a spring\n     */\n    update: function (spring) {\n      var body1 = spring.from;\n      var body2 = spring.to;\n      var length = spring.length < 0 ? options.springLength : spring.length;\n      ${n("var d{var} = body2.pos.{var} - body1.pos.{var};",{indent:6})}\n      var r = Math.sqrt(${n("d{var} * d{var}",{join:" + "})});\n\n      if (r === 0) {\n        ${n("d{var} = (random.nextDouble() - 0.5) / 50;",{indent:8})}\n        r = Math.sqrt(${n("d{var} * d{var}",{join:" + "})});\n      }\n\n      var d = r - length;\n      var coefficient = ((spring.coefficient > 0) ? spring.coefficient : options.springCoefficient) * d / r;\n\n      ${n("body1.force.{var} += coefficient * d{var}",{indent:6})};\n      body1.springCount += 1;\n      body1.springLength += r;\n\n      ${n("body2.force.{var} -= coefficient * d{var}",{indent:6})};\n      body2.springCount += 1;\n      body2.springLength += r;\n    }\n  };\n`}return Kv.exports=function(e){let n=t(e);return new Function("options","random",n)},Kv.exports.generateCreateSpringForceFunctionBody=t,Kv.exports}(),s=function(){if(Zv)return n_.exports;Zv=1;const e=Gv();function t(t){let n=e(t);return`\n  var length = bodies.length;\n  if (length === 0) return 0;\n\n  ${n("var d{var} = 0, t{var} = 0;",{indent:2})}\n\n  for (var i = 0; i < length; ++i) {\n    var body = bodies[i];\n    if (body.isPinned) continue;\n\n    if (adaptiveTimeStepWeight && body.springCount) {\n      timeStep = (adaptiveTimeStepWeight * body.springLength/body.springCount);\n    }\n\n    var coeff = timeStep / body.mass;\n\n    ${n("body.velocity.{var} += coeff * body.force.{var};",{indent:4})}\n    ${n("var v{var} = body.velocity.{var};",{indent:4})}\n    var v = Math.sqrt(${n("v{var} * v{var}",{join:" + "})});\n\n    if (v > 1) {\n      // We normalize it so that we move within timeStep range. \n      // for the case when v <= 1 - we let velocity to fade out.\n      ${n("body.velocity.{var} = v{var} / v;",{indent:6})}\n    }\n\n    ${n("d{var} = timeStep * body.velocity.{var};",{indent:4})}\n\n    ${n("body.pos.{var} += d{var};",{indent:4})}\n\n    ${n("t{var} += Math.abs(d{var});",{indent:4})}\n  }\n\n  return (${n("t{var} * t{var}",{join:" + "})})/length;\n`}return n_.exports=function(e){let n=t(e);return new Function("bodies","timeStep","adaptiveTimeStepWeight",n)},n_.exports.generateIntegratorFunctionBody=t,n_.exports}(),o={};function a(e,t,n){if(e.hasOwnProperty(n)&&"function"!=typeof t[n]){var i=Number.isFinite(e[n]);t[n]=i?function(i){if(void 0!==i){if(!Number.isFinite(i))throw new Error("Value of "+n+" should be a valid number.");return e[n]=i,t}return e[n]}:function(i){return void 0!==i?(e[n]=i,t):e[n]}}}return r_}var c_=function(){if(o_)return Bv.exports;o_=1,Bv.exports=function(n,i){if(!n)throw new Error("Graph structure cannot be undefined");var r=(i&&i.createSimulator||l_())(i);if(Array.isArray(i))throw new Error("Physics settings is expected to be an object");var s=n.version>19?function(e){var t=n.getLinks(e);return t?1+t.size/3:1}:function(e){var t=n.getLinks(e);return t?1+t.length/3:1};i&&"function"==typeof i.nodeMass&&(s=i.nodeMass);var o=new Map,a={},l=0,c=r.settings.springTransform||t;l=0,n.forEachNode((function(e){m(e.id),l+=1})),n.forEachLink(y),n.on("changed",f);var u=!1,h={step:function(){if(0===l)return d(!0),!0;var e=r.step();h.lastMove=e,h.fire("step");var t=e/l<=.01;return d(t),t},getNodePosition:function(e){return x(e).pos},setNodePosition:function(e){var t=x(e);t.setPosition.apply(t,Array.prototype.slice.call(arguments,1))},getLinkPosition:function(e){var t=a[e];if(t)return{from:t.from.pos,to:t.to.pos}},getGraphRect:function(){return r.getBBox()},forEachBody:p,pinNode:function(e,t){x(e.id).isPinned=!!t},isNodePinned:function(e){return x(e.id).isPinned},dispose:function(){n.off("changed",f),h.fire("disposed")},getBody:function(e){return o.get(e)},getSpring:function(e,t){var i;if(void 0===t)i="object"!=typeof e?e:e.id;else{var r=n.hasLink(e,t);if(!r)return;i=r.id}return a[i]},getForceVectorLength:function(){var e=0,t=0;return p((function(n){e+=Math.abs(n.force.x),t+=Math.abs(n.force.y)})),Math.sqrt(e*e+t*t)},simulator:r,graph:n,lastMove:0};return e(h),h;function d(e){var t;u!==e&&(u=e,t=e,h.fire("stable",t))}function p(e){o.forEach(e)}function f(e){for(var t=0;t<e.length;++t){var i=e[t];"add"===i.changeType?(i.node&&m(i.node.id),i.link&&y(i.link)):"remove"===i.changeType&&(i.node&&g(i.node),i.link&&v(i.link))}l=n.getNodesCount()}function m(e){var t=o.get(e);if(!t){var i=n.getNode(e);if(!i)throw new Error("initBody() was called with unknown node id");var s=i.position;if(!s){var a=function(e){var t=[];if(!e.links)return t;for(var n=Math.min(e.links.length,2),i=0;i<n;++i){var r=e.links[i],s=r.fromId!==e.id?o.get(r.fromId):o.get(r.toId);s&&s.pos&&t.push(s)}return t}(i);s=r.getBestNewBodyPosition(a)}(t=r.addBodyAt(s)).id=e,o.set(e,t),_(e),function(e){return e&&(e.isPinned||e.data&&e.data.isPinned)}(i)&&(t.isPinned=!0)}}function g(e){var t=e.id,n=o.get(t);n&&(o.delete(t),r.removeBody(n))}function y(e){_(e.fromId),_(e.toId);var t=o.get(e.fromId),n=o.get(e.toId),i=r.addSpring(t,n,e.length);c(e,i),a[e.id]=i}function v(e){var t=a[e.id];if(t){var i=n.getNode(e.fromId),s=n.getNode(e.toId);i&&_(i.id),s&&_(s.id),delete a[e.id],r.removeSpring(t)}}function _(e){var t=o.get(e);if(t.mass=s(e),Number.isNaN(t.mass))throw new Error("Node mass should be a number")}function x(e){var t=o.get(e);return t||(m(e),t=o.get(e)),t}},Bv.exports.simulator=l_();var e=Pv();function t(){}return Bv.exports}(),u_=f(c_);function h_(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var d_="object"==typeof global&&global&&global.Object===Object&&global,p_="object"==typeof self&&self&&self.Object===Object&&self,f_=d_||p_||Function("return this")(),m_=function(){return f_.Date.now()},g_=/\s/;var y_=/^\s+/;function v_(e){return e?e.slice(0,function(e){for(var t=e.length;t--&&g_.test(e.charAt(t)););return t}(e)+1).replace(y_,""):e}var __=f_.Symbol,x_=Object.prototype,b_=x_.hasOwnProperty,w_=x_.toString,T_=__?__.toStringTag:void 0;var S_=Object.prototype.toString;var M_=__?__.toStringTag:void 0;function E_(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":M_&&M_ in Object(e)?function(e){var t=b_.call(e,T_),n=e[T_];try{e[T_]=void 0;var i=!0}catch(e){}var r=w_.call(e);return i&&(t?e[T_]=n:delete e[T_]),r}(e):function(e){return S_.call(e)}(e)}var A_=/^[-+]0x[0-9a-f]+$/i,C_=/^0b[01]+$/i,R_=/^0o[0-7]+$/i,N_=parseInt;function P_(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return null!=e&&"object"==typeof e}(e)&&"[object Symbol]"==E_(e)}(e))return NaN;if(h_(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=h_(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=v_(e);var n=C_.test(e);return n||R_.test(e)?N_(e.slice(2),n?2:8):A_.test(e)?NaN:+e}var D_=Math.max,L_=Math.min;function I_(e,t,n){var i,r,s,o,a,l,c=0,u=!1,h=!1,d=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function p(t){var n=i,s=r;return i=r=void 0,c=t,o=e.apply(s,n)}function f(e){var n=e-l;return void 0===l||n>=t||n<0||h&&e-c>=s}function m(){var e=m_();if(f(e))return g(e);a=setTimeout(m,function(e){var n=t-(e-l);return h?L_(n,s-(e-c)):n}(e))}function g(e){return a=void 0,d&&i?p(e):(i=r=void 0,o)}function y(){var e=m_(),n=f(e);if(i=arguments,r=this,l=e,n){if(void 0===a)return function(e){return c=e,a=setTimeout(m,t),u?p(e):o}(l);if(h)return clearTimeout(a),a=setTimeout(m,t),p(l)}return void 0===a&&(a=setTimeout(m,t)),o}return t=P_(t)||0,h_(n)&&(u=!!n.leading,s=(h="maxWait"in n)?D_(P_(n.maxWait)||0,t):s,d="trailing"in n?!!n.trailing:d),y.cancel=function(){void 0!==a&&clearTimeout(a),c=0,i=l=r=a=void 0},y.flush=function(){return void 0===a?o:g(m_())},y}function k_(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function O_(e,t,n){return Object.defineProperty(e,"prototype",{writable:!1}),e}function U_(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,s,o,a=[],l=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t);else for(;!(l=(i=s.call(n)).done)&&(a.push(i.value),a.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return k_(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?k_(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var F_=O_((function e(t,n){var i=n.default,r=void 0===i?null:i,s=n.triggerUpdate,o=void 0===s||s,a=n.onChange,l=void 0===a?function(e,t){}:a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=t,this.defaultVal=r,this.triggerUpdate=o,this.onChange=l}));function B_(e){var t=e.stateInit,n=void 0===t?function(){return{}}:t,i=e.props,r=void 0===i?{}:i,s=e.methods,o=void 0===s?{}:s,a=e.aliases,l=void 0===a?{}:a,c=e.init,u=void 0===c?function(){}:c,h=e.update,d=void 0===h?function(){}:h,p=Object.keys(r).map((function(e){return new F_(e,r[e])}));return function e(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];var s=!!(this instanceof e?this.constructor:void 0),a=s?i.shift():void 0,c=i[0],h=void 0===c?{}:c,f=Object.assign({},n instanceof Function?n(h):n,{initialised:!1}),m={};function g(e){return y(e,h),v(),g}var y=function(e,t){u.call(g,e,f,t),f.initialised=!0},v=I_((function(){f.initialised&&(d.call(g,f,m),m={})}),1);return p.forEach((function(e){g[e.name]=function(e){var t=e.name,n=e.triggerUpdate,i=void 0!==n&&n,r=e.onChange,s=void 0===r?function(e,t){}:r,o=e.defaultVal,a=void 0===o?null:o;return function(e){var n=f[t];if(!arguments.length)return n;var r=void 0===e?a:e;return f[t]=r,s.call(g,r,f,n),!m.hasOwnProperty(t)&&(m[t]=n),i&&v(),g}}(e)})),Object.keys(o).forEach((function(e){g[e]=function(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=o[e]).call.apply(t,[g,f].concat(i))}})),Object.entries(l).forEach((function(e){var t=U_(e,2),n=t[0],i=t[1];return g[n]=g[i]})),g.resetProps=function(){return p.forEach((function(e){g[e.name](e.defaultVal)})),g},g.resetProps(),f._rerender=v,s&&a&&g(a),g}}var z_=function(e){return"function"==typeof e?e:"string"==typeof e?function(t){return t[e]}:function(t){return e}};class V_ extends Map{constructor(e,t=j_){if(super(),Object.defineProperties(this,{_intern:{value:new Map},_key:{value:t}}),null!=e)for(const[t,n]of e)this.set(t,n)}get(e){return super.get(G_(this,e))}has(e){return super.has(G_(this,e))}set(e,t){return super.set(function({_intern:e,_key:t},n){const i=t(n);return e.has(i)?e.get(i):(e.set(i,n),n)}(this,e),t)}delete(e){return super.delete(function({_intern:e,_key:t},n){const i=t(n);e.has(i)&&(n=e.get(i),e.delete(i));return n}(this,e))}}function G_({_intern:e,_key:t},n){const i=t(n);return e.has(i)?e.get(i):n}function j_(e){return null!==e&&"object"==typeof e?e.valueOf():e}function H_(e,t){let n;if(void 0===t)for(const t of e)null!=t&&(n<t||void 0===n&&t>=t)&&(n=t);else{let i=-1;for(let r of e)null!=(r=t(r,++i,e))&&(n<r||void 0===n&&r>=r)&&(n=r)}return n}function W_(e,t){let n;if(void 0===t)for(const t of e)null!=t&&(n>t||void 0===n&&t>=t)&&(n=t);else{let i=-1;for(let r of e)null!=(r=t(r,++i,e))&&(n>r||void 0===n&&r>=r)&&(n=r)}return n}function q_(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function X_(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}function $_(e,t){return e.get(X_(e,t))}function Y_(e,t,n){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.set(e,n)}function K_(e,t,n){return e.set(X_(e,t),n),n}function Z_(e,t,n){return t&&function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,ex(i.key),i)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function J_(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,s,o,a=[],l=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t);else for(;!(l=(i=s.call(n)).done)&&(a.push(i.value),a.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return a}}(e,t)||tx(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Q_(e){return function(e){if(Array.isArray(e))return q_(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||tx(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ex(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}function tx(e,t){if(e){if("string"==typeof e)return q_(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?q_(e,t):void 0}}var nx=new WeakMap,ix=new WeakMap,rx=new WeakMap,sx=new WeakMap,ox=new WeakMap,ax=new WeakMap,lx=function(){return Z_((function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Y_(this,nx,new Map),Y_(this,ix,new Map),Y_(this,rx,(function(e){return e})),Y_(this,sx,(function(){return{}})),Y_(this,ox,(function(){})),Y_(this,ax,(function(){}))}),[{key:"getObj",value:function(e){return $_(nx,this).get($_(rx,this).call(this,e))}},{key:"getData",value:function(e){return $_(ix,this).get(e)}},{key:"entries",value:function(){return Q_($_(ix,this).entries()).map((function(e){var t=J_(e,2),n=t[0];return[t[1],n]}))}},{key:"id",value:function(e){return K_(rx,this,z_(e)),this}},{key:"onCreateObj",value:function(e){return K_(sx,this,e),this}},{key:"onUpdateObj",value:function(e){return K_(ox,this,e),this}},{key:"onRemoveObj",value:function(e){return K_(ax,this,e),this}},{key:"digest",value:function(e){var t=this;e.filter((function(e){return!$_(nx,t).has($_(rx,t).call(t,e))})).forEach((function(e){var n=$_(sx,t).call(t,e);$_(nx,t).set($_(rx,t).call(t,e),n),$_(ix,t).set(n,e)}));var n=new Map(e.map((function(e){return[$_(rx,t).call(t,e),e]})));return $_(nx,this).forEach((function(e,i){n.has(i)?$_(ox,t).call(t,e,n.get(i)):($_(ax,t).call(t,e,i),$_(nx,t).delete(i),$_(ix,t).delete(e))})),this}},{key:"clear",value:function(){return this.digest([]),this}}])}();function cx(e,t){switch(arguments.length){case 0:break;case 1:this.range(e);break;default:this.range(t).domain(e)}return this}const ux=Symbol("implicit");function hx(){var e=new V_,t=[],n=[],i=ux;function r(r){let s=e.get(r);if(void 0===s){if(i!==ux)return i;e.set(r,s=t.push(r)-1)}return n[s%n.length]}return r.domain=function(n){if(!arguments.length)return t.slice();t=[],e=new V_;for(const i of n)e.has(i)||e.set(i,t.push(i)-1);return r},r.range=function(e){return arguments.length?(n=Array.from(e),r):n.slice()},r.unknown=function(e){return arguments.length?(i=e,r):i},r.copy=function(){return hx(t,n).unknown(i)},cx.apply(r,arguments),r}function dx(e,t,n){e.prototype=t.prototype=n,n.constructor=e}function px(e,t){var n=Object.create(e.prototype);for(var i in t)n[i]=t[i];return n}function fx(){}var mx=.7,gx=1/mx,yx="\\s*([+-]?\\d+)\\s*",vx="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",_x="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",xx=/^#([0-9a-f]{3,8})$/,bx=new RegExp(`^rgb\\(${yx},${yx},${yx}\\)$`),wx=new RegExp(`^rgb\\(${_x},${_x},${_x}\\)$`),Tx=new RegExp(`^rgba\\(${yx},${yx},${yx},${vx}\\)$`),Sx=new RegExp(`^rgba\\(${_x},${_x},${_x},${vx}\\)$`),Mx=new RegExp(`^hsl\\(${vx},${_x},${_x}\\)$`),Ex=new RegExp(`^hsla\\(${vx},${_x},${_x},${vx}\\)$`),Ax={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function Cx(){return this.rgb().formatHex()}function Rx(){return this.rgb().formatRgb()}function Nx(e){var t,n;return e=(e+"").trim().toLowerCase(),(t=xx.exec(e))?(n=t[1].length,t=parseInt(t[1],16),6===n?Px(t):3===n?new Ix(t>>8&15|t>>4&240,t>>4&15|240&t,(15&t)<<4|15&t,1):8===n?Dx(t>>24&255,t>>16&255,t>>8&255,(255&t)/255):4===n?Dx(t>>12&15|t>>8&240,t>>8&15|t>>4&240,t>>4&15|240&t,((15&t)<<4|15&t)/255):null):(t=bx.exec(e))?new Ix(t[1],t[2],t[3],1):(t=wx.exec(e))?new Ix(255*t[1]/100,255*t[2]/100,255*t[3]/100,1):(t=Tx.exec(e))?Dx(t[1],t[2],t[3],t[4]):(t=Sx.exec(e))?Dx(255*t[1]/100,255*t[2]/100,255*t[3]/100,t[4]):(t=Mx.exec(e))?zx(t[1],t[2]/100,t[3]/100,1):(t=Ex.exec(e))?zx(t[1],t[2]/100,t[3]/100,t[4]):Ax.hasOwnProperty(e)?Px(Ax[e]):"transparent"===e?new Ix(NaN,NaN,NaN,0):null}function Px(e){return new Ix(e>>16&255,e>>8&255,255&e,1)}function Dx(e,t,n,i){return i<=0&&(e=t=n=NaN),new Ix(e,t,n,i)}function Lx(e,t,n,i){return 1===arguments.length?function(e){return e instanceof fx||(e=Nx(e)),e?new Ix((e=e.rgb()).r,e.g,e.b,e.opacity):new Ix}(e):new Ix(e,t,n,null==i?1:i)}function Ix(e,t,n,i){this.r=+e,this.g=+t,this.b=+n,this.opacity=+i}function kx(){return`#${Bx(this.r)}${Bx(this.g)}${Bx(this.b)}`}function Ox(){const e=Ux(this.opacity);return`${1===e?"rgb(":"rgba("}${Fx(this.r)}, ${Fx(this.g)}, ${Fx(this.b)}${1===e?")":`, ${e})`}`}function Ux(e){return isNaN(e)?1:Math.max(0,Math.min(1,e))}function Fx(e){return Math.max(0,Math.min(255,Math.round(e)||0))}function Bx(e){return((e=Fx(e))<16?"0":"")+e.toString(16)}function zx(e,t,n,i){return i<=0?e=t=n=NaN:n<=0||n>=1?e=t=NaN:t<=0&&(e=NaN),new Gx(e,t,n,i)}function Vx(e){if(e instanceof Gx)return new Gx(e.h,e.s,e.l,e.opacity);if(e instanceof fx||(e=Nx(e)),!e)return new Gx;if(e instanceof Gx)return e;var t=(e=e.rgb()).r/255,n=e.g/255,i=e.b/255,r=Math.min(t,n,i),s=Math.max(t,n,i),o=NaN,a=s-r,l=(s+r)/2;return a?(o=t===s?(n-i)/a+6*(n<i):n===s?(i-t)/a+2:(t-n)/a+4,a/=l<.5?s+r:2-s-r,o*=60):a=l>0&&l<1?0:o,new Gx(o,a,l,e.opacity)}function Gx(e,t,n,i){this.h=+e,this.s=+t,this.l=+n,this.opacity=+i}function jx(e){return(e=(e||0)%360)<0?e+360:e}function Hx(e){return Math.max(0,Math.min(1,e||0))}function Wx(e,t,n){return 255*(e<60?t+(n-t)*e/60:e<180?n:e<240?t+(n-t)*(240-e)/60:t)}dx(fx,Nx,{copy(e){return Object.assign(new this.constructor,this,e)},displayable(){return this.rgb().displayable()},hex:Cx,formatHex:Cx,formatHex8:function(){return this.rgb().formatHex8()},formatHsl:function(){return Vx(this).formatHsl()},formatRgb:Rx,toString:Rx}),dx(Ix,Lx,px(fx,{brighter(e){return e=null==e?gx:Math.pow(gx,e),new Ix(this.r*e,this.g*e,this.b*e,this.opacity)},darker(e){return e=null==e?mx:Math.pow(mx,e),new Ix(this.r*e,this.g*e,this.b*e,this.opacity)},rgb(){return this},clamp(){return new Ix(Fx(this.r),Fx(this.g),Fx(this.b),Ux(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:kx,formatHex:kx,formatHex8:function(){return`#${Bx(this.r)}${Bx(this.g)}${Bx(this.b)}${Bx(255*(isNaN(this.opacity)?1:this.opacity))}`},formatRgb:Ox,toString:Ox})),dx(Gx,(function(e,t,n,i){return 1===arguments.length?Vx(e):new Gx(e,t,n,null==i?1:i)}),px(fx,{brighter(e){return e=null==e?gx:Math.pow(gx,e),new Gx(this.h,this.s,this.l*e,this.opacity)},darker(e){return e=null==e?mx:Math.pow(mx,e),new Gx(this.h,this.s,this.l*e,this.opacity)},rgb(){var e=this.h%360+360*(this.h<0),t=isNaN(e)||isNaN(this.s)?0:this.s,n=this.l,i=n+(n<.5?n:1-n)*t,r=2*n-i;return new Ix(Wx(e>=240?e-240:e+120,r,i),Wx(e,r,i),Wx(e<120?e+240:e-120,r,i),this.opacity)},clamp(){return new Gx(jx(this.h),Hx(this.s),Hx(this.l),Ux(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const e=Ux(this.opacity);return`${1===e?"hsl(":"hsla("}${jx(this.h)}, ${100*Hx(this.s)}%, ${100*Hx(this.l)}%${1===e?")":`, ${e})`}`}}));var qx=e=>()=>e;function Xx(e){return 1===(e=+e)?$x:function(t,n){return n-t?function(e,t,n){return e=Math.pow(e,n),t=Math.pow(t,n)-e,n=1/n,function(i){return Math.pow(e+i*t,n)}}(t,n,e):qx(isNaN(t)?n:t)}}function $x(e,t){var n=t-e;return n?function(e,t){return function(n){return e+n*t}}(e,n):qx(isNaN(e)?t:e)}var Yx=function e(t){var n=Xx(t);function i(e,t){var i=n((e=Lx(e)).r,(t=Lx(t)).r),r=n(e.g,t.g),s=n(e.b,t.b),o=$x(e.opacity,t.opacity);return function(t){return e.r=i(t),e.g=r(t),e.b=s(t),e.opacity=o(t),e+""}}return i.gamma=e,i}(1);function Kx(e,t){return e=+e,t=+t,function(n){return e*(1-n)+t*n}}var Zx=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Jx=new RegExp(Zx.source,"g");function Qx(e,t){var n,i,r,s=Zx.lastIndex=Jx.lastIndex=0,o=-1,a=[],l=[];for(e+="",t+="";(n=Zx.exec(e))&&(i=Jx.exec(t));)(r=i.index)>s&&(r=t.slice(s,r),a[o]?a[o]+=r:a[++o]=r),(n=n[0])===(i=i[0])?a[o]?a[o]+=i:a[++o]=i:(a[++o]=null,l.push({i:o,x:Kx(n,i)})),s=Jx.lastIndex;return s<t.length&&(r=t.slice(s),a[o]?a[o]+=r:a[++o]=r),a.length<2?l[0]?function(e){return function(t){return e(t)+""}}(l[0].x):function(e){return function(){return e}}(t):(t=l.length,function(e){for(var n,i=0;i<t;++i)a[(n=l[i]).i]=n.x(e);return a.join("")})}var eb,tb=180/Math.PI,nb={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function ib(e,t,n,i,r,s){var o,a,l;return(o=Math.sqrt(e*e+t*t))&&(e/=o,t/=o),(l=e*n+t*i)&&(n-=e*l,i-=t*l),(a=Math.sqrt(n*n+i*i))&&(n/=a,i/=a,l/=a),e*i<t*n&&(e=-e,t=-t,l=-l,o=-o),{translateX:r,translateY:s,rotate:Math.atan2(t,e)*tb,skewX:Math.atan(l)*tb,scaleX:o,scaleY:a}}function rb(e,t,n,i){function r(e){return e.length?e.pop()+" ":""}return function(s,o){var a=[],l=[];return s=e(s),o=e(o),function(e,i,r,s,o,a){if(e!==r||i!==s){var l=o.push("translate(",null,t,null,n);a.push({i:l-4,x:Kx(e,r)},{i:l-2,x:Kx(i,s)})}else(r||s)&&o.push("translate("+r+t+s+n)}(s.translateX,s.translateY,o.translateX,o.translateY,a,l),function(e,t,n,s){e!==t?(e-t>180?t+=360:t-e>180&&(e+=360),s.push({i:n.push(r(n)+"rotate(",null,i)-2,x:Kx(e,t)})):t&&n.push(r(n)+"rotate("+t+i)}(s.rotate,o.rotate,a,l),function(e,t,n,s){e!==t?s.push({i:n.push(r(n)+"skewX(",null,i)-2,x:Kx(e,t)}):t&&n.push(r(n)+"skewX("+t+i)}(s.skewX,o.skewX,a,l),function(e,t,n,i,s,o){if(e!==n||t!==i){var a=s.push(r(s)+"scale(",null,",",null,")");o.push({i:a-4,x:Kx(e,n)},{i:a-2,x:Kx(t,i)})}else 1===n&&1===i||s.push(r(s)+"scale("+n+","+i+")")}(s.scaleX,s.scaleY,o.scaleX,o.scaleY,a,l),s=o=null,function(e){for(var t,n=-1,i=l.length;++n<i;)a[(t=l[n]).i]=t.x(e);return a.join("")}}}var sb=rb((function(e){const t=new("function"==typeof DOMMatrix?DOMMatrix:WebKitCSSMatrix)(e+"");return t.isIdentity?nb:ib(t.a,t.b,t.c,t.d,t.e,t.f)}),"px, ","px)","deg)"),ob=rb((function(e){return null==e?nb:(eb||(eb=document.createElementNS("http://www.w3.org/2000/svg","g")),eb.setAttribute("transform",e),(e=eb.transform.baseVal.consolidate())?ib((e=e.matrix).a,e.b,e.c,e.d,e.e,e.f):nb)}),", ",")",")");function ab(e){return((e=Math.exp(e))+1/e)/2}var lb=function e(t,n,i){function r(e,r){var s,o,a=e[0],l=e[1],c=e[2],u=r[0],h=r[1],d=r[2],p=u-a,f=h-l,m=p*p+f*f;if(m<1e-12)o=Math.log(d/c)/t,s=function(e){return[a+e*p,l+e*f,c*Math.exp(t*e*o)]};else{var g=Math.sqrt(m),y=(d*d-c*c+i*m)/(2*c*n*g),v=(d*d-c*c-i*m)/(2*d*n*g),_=Math.log(Math.sqrt(y*y+1)-y),x=Math.log(Math.sqrt(v*v+1)-v);o=(x-_)/t,s=function(e){var i=e*o,r=ab(_),s=c/(n*g)*(r*function(e){return((e=Math.exp(2*e))-1)/(e+1)}(t*i+_)-function(e){return((e=Math.exp(e))-1/e)/2}(_));return[a+s*p,l+s*f,c*r/ab(t*i+_)]}}return s.duration=1e3*o*t/Math.SQRT2,s}return r.rho=function(t){var n=Math.max(.001,+t),i=n*n;return e(n,i,i*i)},r}(Math.SQRT2,2,4);var cb=function(e){for(var t=e.length/6|0,n=new Array(t),i=0;i<t;)n[i]="#"+e.slice(6*i,6*++i);return n}("a6cee31f78b4b2df8a33a02cfb9a99e31a1cfdbf6fff7f00cab2d66a3d9affff99b15928");function ub(e){return ub="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ub(e)}var hb=/^\s+/,db=/\s+$/;function pb(e,t){if(t=t||{},(e=e||"")instanceof pb)return e;if(!(this instanceof pb))return new pb(e,t);var n=function(e){var t={r:0,g:0,b:0},n=1,i=null,r=null,s=null,o=!1,a=!1;"string"==typeof e&&(e=function(e){e=e.replace(hb,"").replace(db,"").toLowerCase();var t,n=!1;if(Nb[e])e=Nb[e],n=!0;else if("transparent"==e)return{r:0,g:0,b:0,a:0,format:"name"};if(t=jb.rgb.exec(e))return{r:t[1],g:t[2],b:t[3]};if(t=jb.rgba.exec(e))return{r:t[1],g:t[2],b:t[3],a:t[4]};if(t=jb.hsl.exec(e))return{h:t[1],s:t[2],l:t[3]};if(t=jb.hsla.exec(e))return{h:t[1],s:t[2],l:t[3],a:t[4]};if(t=jb.hsv.exec(e))return{h:t[1],s:t[2],v:t[3]};if(t=jb.hsva.exec(e))return{h:t[1],s:t[2],v:t[3],a:t[4]};if(t=jb.hex8.exec(e))return{r:kb(t[1]),g:kb(t[2]),b:kb(t[3]),a:Bb(t[4]),format:n?"name":"hex8"};if(t=jb.hex6.exec(e))return{r:kb(t[1]),g:kb(t[2]),b:kb(t[3]),format:n?"name":"hex"};if(t=jb.hex4.exec(e))return{r:kb(t[1]+""+t[1]),g:kb(t[2]+""+t[2]),b:kb(t[3]+""+t[3]),a:Bb(t[4]+""+t[4]),format:n?"name":"hex8"};if(t=jb.hex3.exec(e))return{r:kb(t[1]+""+t[1]),g:kb(t[2]+""+t[2]),b:kb(t[3]+""+t[3]),format:n?"name":"hex"};return!1}(e));"object"==ub(e)&&(Hb(e.r)&&Hb(e.g)&&Hb(e.b)?(t=function(e,t,n){return{r:255*Lb(e,255),g:255*Lb(t,255),b:255*Lb(n,255)}}(e.r,e.g,e.b),o=!0,a="%"===String(e.r).substr(-1)?"prgb":"rgb"):Hb(e.h)&&Hb(e.s)&&Hb(e.v)?(i=Ub(e.s),r=Ub(e.v),t=function(e,t,n){e=6*Lb(e,360),t=Lb(t,100),n=Lb(n,100);var i=Math.floor(e),r=e-i,s=n*(1-t),o=n*(1-r*t),a=n*(1-(1-r)*t),l=i%6,c=[n,o,s,s,a,n][l],u=[a,n,n,o,s,s][l],h=[s,s,a,n,n,o][l];return{r:255*c,g:255*u,b:255*h}}(e.h,i,r),o=!0,a="hsv"):Hb(e.h)&&Hb(e.s)&&Hb(e.l)&&(i=Ub(e.s),s=Ub(e.l),t=function(e,t,n){var i,r,s;function o(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}if(e=Lb(e,360),t=Lb(t,100),n=Lb(n,100),0===t)i=r=s=n;else{var a=n<.5?n*(1+t):n+t-n*t,l=2*n-a;i=o(l,a,e+1/3),r=o(l,a,e),s=o(l,a,e-1/3)}return{r:255*i,g:255*r,b:255*s}}(e.h,i,s),o=!0,a="hsl"),e.hasOwnProperty("a")&&(n=e.a));return n=Db(n),{ok:o,format:e.format||a,r:Math.min(255,Math.max(t.r,0)),g:Math.min(255,Math.max(t.g,0)),b:Math.min(255,Math.max(t.b,0)),a:n}}(e);this._originalInput=e,this._r=n.r,this._g=n.g,this._b=n.b,this._a=n.a,this._roundA=Math.round(100*this._a)/100,this._format=t.format||n.format,this._gradientType=t.gradientType,this._r<1&&(this._r=Math.round(this._r)),this._g<1&&(this._g=Math.round(this._g)),this._b<1&&(this._b=Math.round(this._b)),this._ok=n.ok}function fb(e,t,n){e=Lb(e,255),t=Lb(t,255),n=Lb(n,255);var i,r,s=Math.max(e,t,n),o=Math.min(e,t,n),a=(s+o)/2;if(s==o)i=r=0;else{var l=s-o;switch(r=a>.5?l/(2-s-o):l/(s+o),s){case e:i=(t-n)/l+(t<n?6:0);break;case t:i=(n-e)/l+2;break;case n:i=(e-t)/l+4}i/=6}return{h:i,s:r,l:a}}function mb(e,t,n){e=Lb(e,255),t=Lb(t,255),n=Lb(n,255);var i,r,s=Math.max(e,t,n),o=Math.min(e,t,n),a=s,l=s-o;if(r=0===s?0:l/s,s==o)i=0;else{switch(s){case e:i=(t-n)/l+(t<n?6:0);break;case t:i=(n-e)/l+2;break;case n:i=(e-t)/l+4}i/=6}return{h:i,s:r,v:a}}function gb(e,t,n,i){var r=[Ob(Math.round(e).toString(16)),Ob(Math.round(t).toString(16)),Ob(Math.round(n).toString(16))];return i&&r[0].charAt(0)==r[0].charAt(1)&&r[1].charAt(0)==r[1].charAt(1)&&r[2].charAt(0)==r[2].charAt(1)?r[0].charAt(0)+r[1].charAt(0)+r[2].charAt(0):r.join("")}function yb(e,t,n,i){return[Ob(Fb(i)),Ob(Math.round(e).toString(16)),Ob(Math.round(t).toString(16)),Ob(Math.round(n).toString(16))].join("")}function vb(e,t){t=0===t?0:t||10;var n=pb(e).toHsl();return n.s-=t/100,n.s=Ib(n.s),pb(n)}function _b(e,t){t=0===t?0:t||10;var n=pb(e).toHsl();return n.s+=t/100,n.s=Ib(n.s),pb(n)}function xb(e){return pb(e).desaturate(100)}function bb(e,t){t=0===t?0:t||10;var n=pb(e).toHsl();return n.l+=t/100,n.l=Ib(n.l),pb(n)}function wb(e,t){t=0===t?0:t||10;var n=pb(e).toRgb();return n.r=Math.max(0,Math.min(255,n.r-Math.round(-t/100*255))),n.g=Math.max(0,Math.min(255,n.g-Math.round(-t/100*255))),n.b=Math.max(0,Math.min(255,n.b-Math.round(-t/100*255))),pb(n)}function Tb(e,t){t=0===t?0:t||10;var n=pb(e).toHsl();return n.l-=t/100,n.l=Ib(n.l),pb(n)}function Sb(e,t){var n=pb(e).toHsl(),i=(n.h+t)%360;return n.h=i<0?360+i:i,pb(n)}function Mb(e){var t=pb(e).toHsl();return t.h=(t.h+180)%360,pb(t)}function Eb(e,t){if(isNaN(t)||t<=0)throw new Error("Argument to polyad must be a positive number");for(var n=pb(e).toHsl(),i=[pb(e)],r=360/t,s=1;s<t;s++)i.push(pb({h:(n.h+s*r)%360,s:n.s,l:n.l}));return i}function Ab(e){var t=pb(e).toHsl(),n=t.h;return[pb(e),pb({h:(n+72)%360,s:t.s,l:t.l}),pb({h:(n+216)%360,s:t.s,l:t.l})]}function Cb(e,t,n){t=t||6,n=n||30;var i=pb(e).toHsl(),r=360/n,s=[pb(e)];for(i.h=(i.h-(r*t>>1)+720)%360;--t;)i.h=(i.h+r)%360,s.push(pb(i));return s}function Rb(e,t){t=t||6;for(var n=pb(e).toHsv(),i=n.h,r=n.s,s=n.v,o=[],a=1/t;t--;)o.push(pb({h:i,s:r,v:s})),s=(s+a)%1;return o}pb.prototype={isDark:function(){return this.getBrightness()<128},isLight:function(){return!this.isDark()},isValid:function(){return this._ok},getOriginalInput:function(){return this._originalInput},getFormat:function(){return this._format},getAlpha:function(){return this._a},getBrightness:function(){var e=this.toRgb();return(299*e.r+587*e.g+114*e.b)/1e3},getLuminance:function(){var e,t,n,i=this.toRgb();return e=i.r/255,t=i.g/255,n=i.b/255,.2126*(e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4))+.7152*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.0722*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))},setAlpha:function(e){return this._a=Db(e),this._roundA=Math.round(100*this._a)/100,this},toHsv:function(){var e=mb(this._r,this._g,this._b);return{h:360*e.h,s:e.s,v:e.v,a:this._a}},toHsvString:function(){var e=mb(this._r,this._g,this._b),t=Math.round(360*e.h),n=Math.round(100*e.s),i=Math.round(100*e.v);return 1==this._a?"hsv("+t+", "+n+"%, "+i+"%)":"hsva("+t+", "+n+"%, "+i+"%, "+this._roundA+")"},toHsl:function(){var e=fb(this._r,this._g,this._b);return{h:360*e.h,s:e.s,l:e.l,a:this._a}},toHslString:function(){var e=fb(this._r,this._g,this._b),t=Math.round(360*e.h),n=Math.round(100*e.s),i=Math.round(100*e.l);return 1==this._a?"hsl("+t+", "+n+"%, "+i+"%)":"hsla("+t+", "+n+"%, "+i+"%, "+this._roundA+")"},toHex:function(e){return gb(this._r,this._g,this._b,e)},toHexString:function(e){return"#"+this.toHex(e)},toHex8:function(e){return function(e,t,n,i,r){var s=[Ob(Math.round(e).toString(16)),Ob(Math.round(t).toString(16)),Ob(Math.round(n).toString(16)),Ob(Fb(i))];if(r&&s[0].charAt(0)==s[0].charAt(1)&&s[1].charAt(0)==s[1].charAt(1)&&s[2].charAt(0)==s[2].charAt(1)&&s[3].charAt(0)==s[3].charAt(1))return s[0].charAt(0)+s[1].charAt(0)+s[2].charAt(0)+s[3].charAt(0);return s.join("")}(this._r,this._g,this._b,this._a,e)},toHex8String:function(e){return"#"+this.toHex8(e)},toRgb:function(){return{r:Math.round(this._r),g:Math.round(this._g),b:Math.round(this._b),a:this._a}},toRgbString:function(){return 1==this._a?"rgb("+Math.round(this._r)+", "+Math.round(this._g)+", "+Math.round(this._b)+")":"rgba("+Math.round(this._r)+", "+Math.round(this._g)+", "+Math.round(this._b)+", "+this._roundA+")"},toPercentageRgb:function(){return{r:Math.round(100*Lb(this._r,255))+"%",g:Math.round(100*Lb(this._g,255))+"%",b:Math.round(100*Lb(this._b,255))+"%",a:this._a}},toPercentageRgbString:function(){return 1==this._a?"rgb("+Math.round(100*Lb(this._r,255))+"%, "+Math.round(100*Lb(this._g,255))+"%, "+Math.round(100*Lb(this._b,255))+"%)":"rgba("+Math.round(100*Lb(this._r,255))+"%, "+Math.round(100*Lb(this._g,255))+"%, "+Math.round(100*Lb(this._b,255))+"%, "+this._roundA+")"},toName:function(){return 0===this._a?"transparent":!(this._a<1)&&(Pb[gb(this._r,this._g,this._b,!0)]||!1)},toFilter:function(e){var t="#"+yb(this._r,this._g,this._b,this._a),n=t,i=this._gradientType?"GradientType = 1, ":"";if(e){var r=pb(e);n="#"+yb(r._r,r._g,r._b,r._a)}return"progid:DXImageTransform.Microsoft.gradient("+i+"startColorstr="+t+",endColorstr="+n+")"},toString:function(e){var t=!!e;e=e||this._format;var n=!1,i=this._a<1&&this._a>=0;return t||!i||"hex"!==e&&"hex6"!==e&&"hex3"!==e&&"hex4"!==e&&"hex8"!==e&&"name"!==e?("rgb"===e&&(n=this.toRgbString()),"prgb"===e&&(n=this.toPercentageRgbString()),"hex"!==e&&"hex6"!==e||(n=this.toHexString()),"hex3"===e&&(n=this.toHexString(!0)),"hex4"===e&&(n=this.toHex8String(!0)),"hex8"===e&&(n=this.toHex8String()),"name"===e&&(n=this.toName()),"hsl"===e&&(n=this.toHslString()),"hsv"===e&&(n=this.toHsvString()),n||this.toHexString()):"name"===e&&0===this._a?this.toName():this.toRgbString()},clone:function(){return pb(this.toString())},_applyModification:function(e,t){var n=e.apply(null,[this].concat([].slice.call(t)));return this._r=n._r,this._g=n._g,this._b=n._b,this.setAlpha(n._a),this},lighten:function(){return this._applyModification(bb,arguments)},brighten:function(){return this._applyModification(wb,arguments)},darken:function(){return this._applyModification(Tb,arguments)},desaturate:function(){return this._applyModification(vb,arguments)},saturate:function(){return this._applyModification(_b,arguments)},greyscale:function(){return this._applyModification(xb,arguments)},spin:function(){return this._applyModification(Sb,arguments)},_applyCombination:function(e,t){return e.apply(null,[this].concat([].slice.call(t)))},analogous:function(){return this._applyCombination(Cb,arguments)},complement:function(){return this._applyCombination(Mb,arguments)},monochromatic:function(){return this._applyCombination(Rb,arguments)},splitcomplement:function(){return this._applyCombination(Ab,arguments)},triad:function(){return this._applyCombination(Eb,[3])},tetrad:function(){return this._applyCombination(Eb,[4])}},pb.fromRatio=function(e,t){if("object"==ub(e)){var n={};for(var i in e)e.hasOwnProperty(i)&&(n[i]="a"===i?e[i]:Ub(e[i]));e=n}return pb(e,t)},pb.equals=function(e,t){return!(!e||!t)&&pb(e).toRgbString()==pb(t).toRgbString()},pb.random=function(){return pb.fromRatio({r:Math.random(),g:Math.random(),b:Math.random()})},pb.mix=function(e,t,n){n=0===n?0:n||50;var i=pb(e).toRgb(),r=pb(t).toRgb(),s=n/100;return pb({r:(r.r-i.r)*s+i.r,g:(r.g-i.g)*s+i.g,b:(r.b-i.b)*s+i.b,a:(r.a-i.a)*s+i.a})},
// <http://www.w3.org/TR/2008/REC-WCAG20-20081211/#contrast-ratiodef (WCAG Version 2)
// Analyze the 2 colors and returns the color contrast defined by (WCAG Version 2)
pb.readability=function(e,t){var n=pb(e),i=pb(t);return(Math.max(n.getLuminance(),i.getLuminance())+.05)/(Math.min(n.getLuminance(),i.getLuminance())+.05)},pb.isReadable=function(e,t,n){var i,r,s=pb.readability(e,t);switch(r=!1,(i=function(e){var t,n;t=((e=e||{level:"AA",size:"small"}).level||"AA").toUpperCase(),n=(e.size||"small").toLowerCase(),"AA"!==t&&"AAA"!==t&&(t="AA");"small"!==n&&"large"!==n&&(n="small");return{level:t,size:n}}(n)).level+i.size){case"AAsmall":case"AAAlarge":r=s>=4.5;break;case"AAlarge":r=s>=3;break;case"AAAsmall":r=s>=7}return r},pb.mostReadable=function(e,t,n){var i,r,s,o,a=null,l=0;r=(n=n||{}).includeFallbackColors,s=n.level,o=n.size;for(var c=0;c<t.length;c++)(i=pb.readability(e,t[c]))>l&&(l=i,a=pb(t[c]));return pb.isReadable(e,a,{level:s,size:o})||!r?a:(n.includeFallbackColors=!1,pb.mostReadable(e,["#fff","#000"],n))};var Nb=pb.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"},Pb=pb.hexNames=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[e[n]]=n);return t}(Nb);function Db(e){return e=parseFloat(e),(isNaN(e)||e<0||e>1)&&(e=1),e}function Lb(e,t){(function(e){return"string"==typeof e&&-1!=e.indexOf(".")&&1===parseFloat(e)})(e)&&(e="100%");var n=function(e){return"string"==typeof e&&-1!=e.indexOf("%")}(e);return e=Math.min(t,Math.max(0,parseFloat(e))),n&&(e=parseInt(e*t,10)/100),Math.abs(e-t)<1e-6?1:e%t/parseFloat(t)}function Ib(e){return Math.min(1,Math.max(0,e))}function kb(e){return parseInt(e,16)}function Ob(e){return 1==e.length?"0"+e:""+e}function Ub(e){return e<=1&&(e=100*e+"%"),e}function Fb(e){return Math.round(255*parseFloat(e)).toString(16)}function Bb(e){return kb(e)/255}var zb,Vb,Gb,jb=(Vb="[\\s|\\(]+("+(zb="(?:[-\\+]?\\d*\\.\\d+%?)|(?:[-\\+]?\\d+%?)")+")[,|\\s]+("+zb+")[,|\\s]+("+zb+")\\s*\\)?",Gb="[\\s|\\(]+("+zb+")[,|\\s]+("+zb+")[,|\\s]+("+zb+")[,|\\s]+("+zb+")\\s*\\)?",{CSS_UNIT:new RegExp(zb),rgb:new RegExp("rgb"+Vb),rgba:new RegExp("rgba"+Gb),hsl:new RegExp("hsl"+Vb),hsla:new RegExp("hsla"+Gb),hsv:new RegExp("hsv"+Vb),hsva:new RegExp("hsva"+Gb),hex3:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex4:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex8:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/});function Hb(e){return!!jb.CSS_UNIT.exec(e)}function Wb(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function qb(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}function Xb(e,t,n){return t=nw(t),function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,rw()?Reflect.construct(t,n||[],nw(e).constructor):t.apply(e,n))}function $b(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Yb(e,t){return e.get(qb(e,t))}function Kb(e,t,n){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.set(e,n)}function Zb(e,t,n){return e.set(qb(e,t),n),n}function Jb(e,t,n){if(rw())return Reflect.construct.apply(null,arguments);var i=[null];return i.push.apply(i,t),new(e.bind.apply(e,i))}function Qb(e,t,n){return t&&function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,uw(i.key),i)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function ew(e,t,n){return(t=uw(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function tw(){return tw="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var i=function(e,t){for(;!{}.hasOwnProperty.call(e,t)&&null!==(e=nw(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(arguments.length<3?e:n):r.value}},tw.apply(null,arguments)}function nw(e){return nw=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},nw(e)}function iw(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ow(e,t)}function rw(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(rw=function(){return!!e})()}function sw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function ow(e,t){return ow=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ow(e,t)}function aw(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,s,o,a=[],l=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t);else for(;!(l=(i=s.call(n)).done)&&(a.push(i.value),a.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return a}}(e,t)||dw(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function lw(e,t,n,i){var r=tw(nw(e.prototype),t,n);return"function"==typeof r?function(e){return r.apply(n,e)}:r}function cw(e){return function(e){if(Array.isArray(e))return Wb(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||dw(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function uw(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function hw(e){return hw="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},hw(e)}function dw(e,t){if(e){if("string"==typeof e)return Wb(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Wb(e,t):void 0}}var pw=function(e){e instanceof Array?e.forEach(pw):(e.map&&e.map.dispose(),e.dispose())},fw=function(e){e.geometry&&e.geometry.dispose(),e.material&&pw(e.material),e.texture&&e.texture.dispose(),e.children&&e.children.forEach(fw)},mw=function(e){for(;e.children.length;){var t=e.children[0];e.remove(t),fw(t)}},gw=new WeakMap,yw=new WeakMap,vw=function(e){function t(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=i.dataBindAttr,s=void 0===r?"__data":r,o=i.objBindAttr,a=void 0===o?"__threeObj":o;return $b(this,t),ew(n=Xb(this,t),"scene",void 0),Kb(n,gw,void 0),Kb(n,yw,void 0),n.scene=e,Zb(gw,n,s),Zb(yw,n,a),n.onRemoveObj((function(){})),n}return iw(t,e),Qb(t,[{key:"onCreateObj",value:function(e){var n=this;return lw(t,"onCreateObj",this)([function(t){var i=e(t);return t[Yb(yw,n)]=i,i[Yb(gw,n)]=t,n.scene.add(i),i}]),this}},{key:"onRemoveObj",value:function(e){var n=this;return lw(t,"onRemoveObj",this)([function(i,r){var s=lw(t,"getData",n)([i]);e(i,r),n.scene.remove(i),mw(i),delete s[Yb(yw,n)]}]),this}}])}(lx),_w=function(e){return isNaN(e)?parseInt(pb(e).toHex(),16):e},xw=function(e){return isNaN(e)?pb(e).getAlpha():1},bw=hx(cb);function ww(e,t,n){t&&"string"==typeof n&&e.filter((function(e){return!e[n]})).forEach((function(e){e[n]=bw(t(e))}))}var Tw=window.THREE?window.THREE:{Group:Md,Mesh:ld,MeshLambertMaterial:Cp,Color:Eh,BufferGeometry:Kh,BufferAttribute:Fh,Matrix4:Iu,Vector3:Dc,SphereGeometry:xp,CylinderGeometry:rp,TubeGeometry:bp,ConeGeometry:sp,Line:Qd,LineBasicMaterial:Wd,QuadraticBezierCurve3:yp,CubicBezierCurve3:gp,Box3:au},Sw={graph:Fv,forcelayout:u_},Mw=(new Tw.BufferGeometry).setAttribute?"setAttribute":"addAttribute",Ew=(new Tw.BufferGeometry).applyMatrix4?"applyMatrix4":"applyMatrix",Aw=B_({props:{jsonUrl:{onChange:function(e,t){var n=this;e&&!t.fetchingJson&&(t.fetchingJson=!0,t.onLoading(),fetch(e).then((function(e){return e.json()})).then((function(e){t.fetchingJson=!1,t.onFinishLoading(e),n.graphData(e)})))},triggerUpdate:!1},graphData:{default:{nodes:[],links:[]},onChange:function(e,t){t.engineRunning=!1}},numDimensions:{default:3,onChange:function(e,t){var n=t.d3ForceLayout.force("charge");function i(e,t){e.forEach((function(e){delete e[t],delete e["v".concat(t)]}))}n&&n.strength(e>2?-60:-30),e<3&&i(t.graphData.nodes,"z"),e<2&&i(t.graphData.nodes,"y")}},dagMode:{onChange:function(e,t){!e&&"d3"===t.forceEngine&&(t.graphData.nodes||[]).forEach((function(e){return e.fx=e.fy=e.fz=void 0}))}},dagLevelDistance:{},dagNodeFilter:{default:function(e){return!0}},onDagError:{triggerUpdate:!1},nodeRelSize:{default:4},nodeId:{default:"id"},nodeVal:{default:"val"},nodeResolution:{default:8},nodeColor:{default:"color"},nodeAutoColorBy:{},nodeOpacity:{default:.75},nodeVisibility:{default:!0},nodeThreeObject:{},nodeThreeObjectExtend:{default:!1},nodePositionUpdate:{triggerUpdate:!1},linkSource:{default:"source"},linkTarget:{default:"target"},linkVisibility:{default:!0},linkColor:{default:"color"},linkAutoColorBy:{},linkOpacity:{default:.2},linkWidth:{},linkResolution:{default:6},linkCurvature:{default:0,triggerUpdate:!1},linkCurveRotation:{default:0,triggerUpdate:!1},linkMaterial:{},linkThreeObject:{},linkThreeObjectExtend:{default:!1},linkPositionUpdate:{triggerUpdate:!1},linkDirectionalArrowLength:{default:0},linkDirectionalArrowColor:{},linkDirectionalArrowRelPos:{default:.5,triggerUpdate:!1},linkDirectionalArrowResolution:{default:8},linkDirectionalParticles:{default:0},linkDirectionalParticleSpeed:{default:.01,triggerUpdate:!1},linkDirectionalParticleWidth:{default:.5},linkDirectionalParticleColor:{},linkDirectionalParticleResolution:{default:4},forceEngine:{default:"d3"},d3AlphaMin:{default:0},d3AlphaDecay:{default:.0228,triggerUpdate:!1,onChange:function(e,t){t.d3ForceLayout.alphaDecay(e)}},d3AlphaTarget:{default:0,triggerUpdate:!1,onChange:function(e,t){t.d3ForceLayout.alphaTarget(e)}},d3VelocityDecay:{default:.4,triggerUpdate:!1,onChange:function(e,t){t.d3ForceLayout.velocityDecay(e)}},ngraphPhysics:{default:{timeStep:20,gravity:-1.2,theta:.8,springLength:30,springCoefficient:8e-4,dragCoefficient:.02}},warmupTicks:{default:0,triggerUpdate:!1},cooldownTicks:{default:1/0,triggerUpdate:!1},cooldownTime:{default:15e3,triggerUpdate:!1},onLoading:{default:function(){},triggerUpdate:!1},onFinishLoading:{default:function(){},triggerUpdate:!1},onUpdate:{default:function(){},triggerUpdate:!1},onFinishUpdate:{default:function(){},triggerUpdate:!1},onEngineTick:{default:function(){},triggerUpdate:!1},onEngineStop:{default:function(){},triggerUpdate:!1}},methods:{refresh:function(e){return e._flushObjects=!0,e._rerender(),this},d3Force:function(e,t,n){return void 0===n?e.d3ForceLayout.force(t):(e.d3ForceLayout.force(t,n),this)},d3ReheatSimulation:function(e){return e.d3ForceLayout.alpha(1),this.resetCountdown(),this},resetCountdown:function(e){return e.cntTicks=0,e.startTickTime=new Date,e.engineRunning=!0,this},tickFrame:function(e){var t,n,i,r,s="ngraph"!==e.forceEngine;return e.engineRunning&&function(){++e.cntTicks>e.cooldownTicks||new Date-e.startTickTime>e.cooldownTime||s&&e.d3AlphaMin>0&&e.d3ForceLayout.alpha()<e.d3AlphaMin?(e.engineRunning=!1,e.onEngineStop()):(e.layout[s?"tick":"step"](),e.onEngineTick());var t=z_(e.nodeThreeObjectExtend);e.nodeDataMapper.entries().forEach((function(n){var i=aw(n,2),r=i[0],o=i[1];if(o){var a=s?r:e.layout.getNodePosition(r[e.nodeId]),l=t(r);e.nodePositionUpdate&&e.nodePositionUpdate(l?o.children[0]:o,{x:a.x,y:a.y,z:a.z},r)&&!l||(o.position.x=a.x,o.position.y=a.y||0,o.position.z=a.z||0)}}));var n=z_(e.linkWidth),i=z_(e.linkCurvature),r=z_(e.linkCurveRotation),o=z_(e.linkThreeObjectExtend);function a(t){var n=s?t:e.layout.getLinkPosition(e.layout.graph.getLink(t.source,t.target).id),o=n[s?"source":"from"],a=n[s?"target":"to"];if(o&&a&&o.hasOwnProperty("x")&&a.hasOwnProperty("x")){var l=i(t);if(l){var c,u=new Tw.Vector3(o.x,o.y||0,o.z||0),h=new Tw.Vector3(a.x,a.y||0,a.z||0),d=u.distanceTo(h),p=r(t);if(d>0){var f=a.x-o.x,m=a.y-o.y||0,g=(new Tw.Vector3).subVectors(h,u),y=g.clone().multiplyScalar(l).cross(0!==f||0!==m?new Tw.Vector3(0,0,1):new Tw.Vector3(0,1,0)).applyAxisAngle(g.normalize(),p).add((new Tw.Vector3).addVectors(u,h).divideScalar(2));c=new Tw.QuadraticBezierCurve3(u,y,h)}else{var v=70*l,_=-p,x=_+Math.PI/2;c=new Tw.CubicBezierCurve3(u,new Tw.Vector3(v*Math.cos(x),v*Math.sin(x),0).add(u),new Tw.Vector3(v*Math.cos(_),v*Math.sin(_),0).add(u),h)}t.__curve=c}else t.__curve=null}}e.linkDataMapper.entries().forEach((function(t){var i=aw(t,2),r=i[0],l=i[1];if(l){var c=s?r:e.layout.getLinkPosition(e.layout.graph.getLink(r.source,r.target).id),u=c[s?"source":"from"],h=c[s?"target":"to"];if(u&&h&&u.hasOwnProperty("x")&&h.hasOwnProperty("x")){a(r);var d=o(r);if(!e.linkPositionUpdate||!e.linkPositionUpdate(d?l.children[1]:l,{start:{x:u.x,y:u.y,z:u.z},end:{x:h.x,y:h.y,z:h.z}},r)||d){var p=30,f=r.__curve,m=l.children.length?l.children[0]:l;if("Line"===m.type){if(f){var g=f.getPoints(p);m.geometry.getAttribute("position").array.length!==3*g.length&&m.geometry[Mw]("position",new Tw.BufferAttribute(new Float32Array(3*g.length),3)),m.geometry.setFromPoints(g)}else{var y=m.geometry.getAttribute("position");y&&y.array&&6===y.array.length||m.geometry[Mw]("position",y=new Tw.BufferAttribute(new Float32Array(6),3)),y.array[0]=u.x,y.array[1]=u.y||0,y.array[2]=u.z||0,y.array[3]=h.x,y.array[4]=h.y||0,y.array[5]=h.z||0,y.needsUpdate=!0}m.geometry.computeBoundingSphere()}else if("Mesh"===m.type)if(f){m.geometry.type.match(/^Tube(Buffer)?Geometry$/)||(m.position.set(0,0,0),m.rotation.set(0,0,0),m.scale.set(1,1,1));var v=Math.ceil(10*n(r))/10/2,_=new Tw.TubeGeometry(f,p,v,e.linkResolution,!1);m.geometry.dispose(),m.geometry=_}else{if(!m.geometry.type.match(/^Cylinder(Buffer)?Geometry$/)){var x=Math.ceil(10*n(r))/10/2,b=new Tw.CylinderGeometry(x,x,1,e.linkResolution,1,!1);b[Ew]((new Tw.Matrix4).makeTranslation(0,.5,0)),b[Ew]((new Tw.Matrix4).makeRotationX(Math.PI/2)),m.geometry.dispose(),m.geometry=b}var w=new Tw.Vector3(u.x,u.y||0,u.z||0),T=new Tw.Vector3(h.x,h.y||0,h.z||0),S=w.distanceTo(T);m.position.x=w.x,m.position.y=w.y,m.position.z=w.z,m.scale.z=S,m.parent.localToWorld(T),m.lookAt(T)}}}}}))}(),t=z_(e.linkDirectionalArrowRelPos),n=z_(e.linkDirectionalArrowLength),i=z_(e.nodeVal),e.arrowDataMapper.entries().forEach((function(r){var o=aw(r,2),a=o[0],l=o[1];if(l){var c=s?a:e.layout.getLinkPosition(e.layout.graph.getLink(a.source,a.target).id),u=c[s?"source":"from"],h=c[s?"target":"to"];if(u&&h&&u.hasOwnProperty("x")&&h.hasOwnProperty("x")){var d=Math.cbrt(Math.max(0,i(u)||1))*e.nodeRelSize,p=Math.cbrt(Math.max(0,i(h)||1))*e.nodeRelSize,f=n(a),m=t(a),g=a.__curve?function(e){return a.__curve.getPoint(e)}:function(e){var t=function(e,t,n,i){return t[e]+(n[e]-t[e])*i||0};return{x:t("x",u,h,e),y:t("y",u,h,e),z:t("z",u,h,e)}},y=a.__curve?a.__curve.getLength():Math.sqrt(["x","y","z"].map((function(e){return Math.pow((h[e]||0)-(u[e]||0),2)})).reduce((function(e,t){return e+t}),0)),v=d+f+(y-d-p-f)*m,_=g(v/y),x=g((v-f)/y);["x","y","z"].forEach((function(e){return l.position[e]=x[e]}));var b=Jb(Tw.Vector3,cw(["x","y","z"].map((function(e){return _[e]}))));l.parent.localToWorld(b),l.lookAt(b)}}})),r=z_(e.linkDirectionalParticleSpeed),e.graphData.links.forEach((function(t){var n=e.particlesDataMapper.getObj(t),i=n&&n.children,o=t.__singleHopPhotonsObj&&t.__singleHopPhotonsObj.children;if(o&&o.length||i&&i.length){var a=s?t:e.layout.getLinkPosition(e.layout.graph.getLink(t.source,t.target).id),l=a[s?"source":"from"],c=a[s?"target":"to"];if(l&&c&&l.hasOwnProperty("x")&&c.hasOwnProperty("x")){var u=r(t),h=t.__curve?function(e){return t.__curve.getPoint(e)}:function(e){var t=function(e,t,n,i){return t[e]+(n[e]-t[e])*i||0};return{x:t("x",l,c,e),y:t("y",l,c,e),z:t("z",l,c,e)}};[].concat(cw(i||[]),cw(o||[])).forEach((function(e,t){var n="singleHopPhotons"===e.parent.__linkThreeObjType;if(e.hasOwnProperty("__progressRatio")||(e.__progressRatio=n?0:t/i.length),e.__progressRatio+=u,e.__progressRatio>=1){if(n)return e.parent.remove(e),void mw(e);e.__progressRatio=e.__progressRatio%1}var r=e.__progressRatio,s=h(r);["x","y","z"].forEach((function(t){return e.position[t]=s[t]}))}))}}})),this},emitParticle:function(e,t){if(t&&e.graphData.links.includes(t)){if(!t.__singleHopPhotonsObj){var n=new Tw.Group;n.__linkThreeObjType="singleHopPhotons",t.__singleHopPhotonsObj=n,e.graphScene.add(n)}var i=z_(e.linkDirectionalParticleWidth),r=Math.ceil(10*i(t))/10/2,s=e.linkDirectionalParticleResolution,o=new Tw.SphereGeometry(r,s,s),a=z_(e.linkColor),l=z_(e.linkDirectionalParticleColor)(t)||a(t)||"#f0f0f0",c=new Tw.Color(_w(l)),u=3*e.linkOpacity,h=new Tw.MeshLambertMaterial({color:c,transparent:!0,opacity:u});t.__singleHopPhotonsObj.add(new Tw.Mesh(o,h))}return this},getGraphBbox:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!0};if(!e.initialised)return null;var n=function e(n){var i=[];if(n.geometry){n.geometry.computeBoundingBox();var r=new Tw.Box3;r.copy(n.geometry.boundingBox).applyMatrix4(n.matrixWorld),i.push(r)}return i.concat.apply(i,cw((n.children||[]).filter((function(e){return!e.hasOwnProperty("__graphObjType")||"node"===e.__graphObjType&&t(e.__data)})).map(e)))}(e.graphScene);return n.length?Object.assign.apply(Object,cw(["x","y","z"].map((function(e){return ew({},e,[W_(n,(function(t){return t.min[e]})),H_(n,(function(t){return t.max[e]}))])})))):null}},stateInit:function(){return{d3ForceLayout:Cv().force("link",$y()).force("charge",Rv()).force("center",vy()).force("dagRadial",null).stop(),engineRunning:!1}},init:function(e,t){t.graphScene=e,t.nodeDataMapper=new vw(e,{objBindAttr:"__threeObj"}),t.linkDataMapper=new vw(e,{objBindAttr:"__lineObj"}),t.arrowDataMapper=new vw(e,{objBindAttr:"__arrowObj"}),t.particlesDataMapper=new vw(e,{objBindAttr:"__photonsObj"})},update:function(e,t){var n=function(e){return e.some((function(e){return t.hasOwnProperty(e)}))};if(e.engineRunning=!1,"function"==typeof e.onUpdate&&e.onUpdate(),null!==e.nodeAutoColorBy&&n(["nodeAutoColorBy","graphData","nodeColor"])&&ww(e.graphData.nodes,z_(e.nodeAutoColorBy),e.nodeColor),null!==e.linkAutoColorBy&&n(["linkAutoColorBy","graphData","linkColor"])&&ww(e.graphData.links,z_(e.linkAutoColorBy),e.linkColor),e._flushObjects||n(["graphData","nodeThreeObject","nodeThreeObjectExtend","nodeVal","nodeColor","nodeVisibility","nodeRelSize","nodeResolution","nodeOpacity"])){var i=z_(e.nodeThreeObject),r=z_(e.nodeThreeObjectExtend),s=z_(e.nodeVal),o=z_(e.nodeColor),a=z_(e.nodeVisibility),l={},c={};(e._flushObjects||n(["nodeThreeObject","nodeThreeObjectExtend"]))&&e.nodeDataMapper.clear(),e.nodeDataMapper.onCreateObj((function(t){var n,s=i(t),o=r(t);return s&&e.nodeThreeObject===s&&(s=s.clone()),s&&!o?n=s:((n=new Tw.Mesh).__graphDefaultObj=!0,s&&o&&n.add(s)),n.__graphObjType="node",n})).onUpdateObj((function(t,n){if(t.__graphDefaultObj){var i=s(n)||1,r=Math.cbrt(i)*e.nodeRelSize,a=e.nodeResolution;t.geometry.type.match(/^Sphere(Buffer)?Geometry$/)&&t.geometry.parameters.radius===r&&t.geometry.parameters.widthSegments===a||(l.hasOwnProperty(i)||(l[i]=new Tw.SphereGeometry(r,a,a)),t.geometry.dispose(),t.geometry=l[i]);var u=o(n),h=new Tw.Color(_w(u||"#ffffaa")),d=e.nodeOpacity*xw(u);"MeshLambertMaterial"===t.material.type&&t.material.color.equals(h)&&t.material.opacity===d||(c.hasOwnProperty(u)||(c[u]=new Tw.MeshLambertMaterial({color:h,transparent:!0,opacity:d})),t.material.dispose(),t.material=c[u])}})).digest(e.graphData.nodes.filter(a))}if(e._flushObjects||n(["graphData","linkThreeObject","linkThreeObjectExtend","linkMaterial","linkColor","linkWidth","linkVisibility","linkResolution","linkOpacity","linkDirectionalArrowLength","linkDirectionalArrowColor","linkDirectionalArrowResolution","linkDirectionalParticles","linkDirectionalParticleWidth","linkDirectionalParticleColor","linkDirectionalParticleResolution"])){var u=z_(e.linkThreeObject),h=z_(e.linkThreeObjectExtend),d=z_(e.linkMaterial),p=z_(e.linkVisibility),f=z_(e.linkColor),m=z_(e.linkWidth),g={},y={},v={},_=e.graphData.links.filter(p);if((e._flushObjects||n(["linkThreeObject","linkThreeObjectExtend","linkWidth"]))&&e.linkDataMapper.clear(),e.linkDataMapper.onRemoveObj((function(e){var t=e.__data&&e.__data.__singleHopPhotonsObj;t&&(t.parent.remove(t),mw(t),delete e.__data.__singleHopPhotonsObj)})).onCreateObj((function(t){var n,i,r=u(t),s=h(t);if(r&&e.linkThreeObject===r&&(r=r.clone()),!r||s)if(!!m(t))n=new Tw.Mesh;else{var o=new Tw.BufferGeometry;o[Mw]("position",new Tw.BufferAttribute(new Float32Array(6),3)),n=new Tw.Line(o)}return r?s?((i=new Tw.Group).__graphDefaultObj=!0,i.add(n),i.add(r)):i=r:(i=n).__graphDefaultObj=!0,i.renderOrder=10,i.__graphObjType="link",i})).onUpdateObj((function(t,n){if(t.__graphDefaultObj){var i=t.children.length?t.children[0]:t,r=Math.ceil(10*m(n))/10,s=!!r;if(s){var o=r/2,a=e.linkResolution;if(!i.geometry.type.match(/^Cylinder(Buffer)?Geometry$/)||i.geometry.parameters.radiusTop!==o||i.geometry.parameters.radialSegments!==a){if(!g.hasOwnProperty(r)){var l=new Tw.CylinderGeometry(o,o,1,a,1,!1);l[Ew]((new Tw.Matrix4).makeTranslation(0,.5,0)),l[Ew]((new Tw.Matrix4).makeRotationX(Math.PI/2)),g[r]=l}i.geometry.dispose(),i.geometry=g[r]}}var c=d(n);if(c)i.material=c;else{var u=f(n),h=new Tw.Color(_w(u||"#f0f0f0")),p=e.linkOpacity*xw(u),_=s?"MeshLambertMaterial":"LineBasicMaterial";if(i.material.type!==_||!i.material.color.equals(h)||i.material.opacity!==p){var x=s?y:v;x.hasOwnProperty(u)||(x[u]=new Tw[_]({color:h,transparent:p<1,opacity:p,depthWrite:p>=1})),i.material.dispose(),i.material=x[u]}}}})).digest(_),e.linkDirectionalArrowLength||t.hasOwnProperty("linkDirectionalArrowLength")){var x=z_(e.linkDirectionalArrowLength),b=z_(e.linkDirectionalArrowColor);e.arrowDataMapper.onCreateObj((function(){var e=new Tw.Mesh(void 0,new Tw.MeshLambertMaterial({transparent:!0}));return e.__linkThreeObjType="arrow",e})).onUpdateObj((function(t,n){var i=x(n),r=e.linkDirectionalArrowResolution;if(!t.geometry.type.match(/^Cone(Buffer)?Geometry$/)||t.geometry.parameters.height!==i||t.geometry.parameters.radialSegments!==r){var s=new Tw.ConeGeometry(.25*i,i,r);s.translate(0,i/2,0),s.rotateX(Math.PI/2),t.geometry.dispose(),t.geometry=s}var o=b(n)||f(n)||"#f0f0f0";t.material.color=new Tw.Color(_w(o)),t.material.opacity=3*e.linkOpacity*xw(o)})).digest(_.filter(x))}if(e.linkDirectionalParticles||t.hasOwnProperty("linkDirectionalParticles")){var w=z_(e.linkDirectionalParticles),T=z_(e.linkDirectionalParticleWidth),S=z_(e.linkDirectionalParticleColor),M={},E={};e.particlesDataMapper.onCreateObj((function(){var e=new Tw.Group;return e.__linkThreeObjType="photons",e.__photonDataMapper=new vw(e),e})).onUpdateObj((function(t,n){var i,r=Math.round(Math.abs(w(n))),s=!!t.children.length&&t.children[0],o=Math.ceil(10*T(n))/10/2,a=e.linkDirectionalParticleResolution;s&&s.geometry.parameters.radius===o&&s.geometry.parameters.widthSegments===a?i=s.geometry:(E.hasOwnProperty(o)||(E[o]=new Tw.SphereGeometry(o,a,a)),i=E[o],s&&s.geometry.dispose());var l,c=S(n)||f(n)||"#f0f0f0",u=new Tw.Color(_w(c)),h=3*e.linkOpacity;s&&s.material.color.equals(u)&&s.material.opacity===h?l=s.material:(M.hasOwnProperty(c)||(M[c]=new Tw.MeshLambertMaterial({color:u,transparent:!0,opacity:h})),l=M[c],s&&s.material.dispose()),t.__photonDataMapper.id((function(e){return e.idx})).onCreateObj((function(){return new Tw.Mesh(i,l)})).onUpdateObj((function(e){e.geometry=i,e.material=l})).digest(cw(new Array(r)).map((function(e,t){return{idx:t}})))})).digest(_.filter(w))}}if(e._flushObjects=!1,n(["graphData","nodeId","linkSource","linkTarget","numDimensions","forceEngine","dagMode","dagNodeFilter","dagLevelDistance"])){e.engineRunning=!1,e.graphData.links.forEach((function(t){t.source=t[e.linkSource],t.target=t[e.linkTarget]}));var A,C="ngraph"!==e.forceEngine;if(C){(A=e.d3ForceLayout).stop().alpha(1).numDimensions(e.numDimensions).nodes(e.graphData.nodes);var R=e.d3ForceLayout.force("link");R&&R.id((function(t){return t[e.nodeId]})).links(e.graphData.links);var N=e.dagMode&&function(e,t){var n=e.nodes,i=e.links,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=r.nodeFilter,o=void 0===s?function(){return!0}:s,a=r.onLoopError,l=void 0===a?function(e){throw"Invalid DAG structure! Found cycle in node path: ".concat(e.join(" -> "),".")}:a,c={};n.forEach((function(e){return c[t(e)]={data:e,out:[],depth:-1,skip:!o(e)}})),i.forEach((function(e){var n=e.source,i=e.target,r=l(n),s=l(i);if(!c.hasOwnProperty(r))throw"Missing source node with id: ".concat(r);if(!c.hasOwnProperty(s))throw"Missing target node with id: ".concat(s);var o=c[r],a=c[s];function l(e){return"object"===hw(e)?t(e):e}o.out.push(a)}));var u=[];return function e(n){for(var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=function(){var s=n[o];if(-1!==i.indexOf(s)){var a=[].concat(cw(i.slice(i.indexOf(s))),[s]).map((function(e){return t(e.data)}));return u.some((function(e){return e.length===a.length&&e.every((function(e,t){return e===a[t]}))}))||(u.push(a),l(a)),1}r>s.depth&&(s.depth=r,e(s.out,[].concat(cw(i),[s]),r+(s.skip?0:1)))},o=0,a=n.length;o<a;o++)s()}(Object.values(c)),Object.assign.apply(Object,[{}].concat(cw(Object.entries(c).filter((function(e){return!aw(e,2)[1].skip})).map((function(e){var t=aw(e,2);return ew({},t[0],t[1].depth)})))))}(e.graphData,(function(t){return t[e.nodeId]}),{nodeFilter:e.dagNodeFilter,onLoopError:e.onDagError||void 0}),P=Math.max.apply(Math,cw(Object.values(N||[]))),D=e.dagLevelDistance||e.graphData.nodes.length/(P||1)*2*(-1!==["radialin","radialout"].indexOf(e.dagMode)?.7:1);if(["lr","rl","td","bu","zin","zout"].includes(t.dagMode)){var L=["lr","rl"].includes(t.dagMode)?"fx":["td","bu"].includes(t.dagMode)?"fy":"fz";e.graphData.nodes.filter(e.dagNodeFilter).forEach((function(e){return delete e[L]}))}if(["lr","rl","td","bu","zin","zout"].includes(e.dagMode)){var I=["rl","td","zout"].includes(e.dagMode),k=["lr","rl"].includes(e.dagMode)?"fx":["td","bu"].includes(e.dagMode)?"fy":"fz";e.graphData.nodes.filter(e.dagNodeFilter).forEach((function(t){return t[k]=function(t){return(N[t[e.nodeId]]-P/2)*D*(I?-1:1)}(t)}))}e.d3ForceLayout.force("dagRadial",-1!==["radialin","radialout"].indexOf(e.dagMode)?Nv((function(t){var n=N[t[e.nodeId]]||-1;return("radialin"===e.dagMode?P-n:n)*D})).strength((function(t){return e.dagNodeFilter(t)?1:0})):null)}else{var O=Sw.graph();e.graphData.nodes.forEach((function(t){O.addNode(t[e.nodeId])})),e.graphData.links.forEach((function(e){O.addLink(e.source,e.target)})),A=Sw.forcelayout(O,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sw(Object(n),!0).forEach((function(t){ew(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sw(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({dimensions:e.numDimensions},e.ngraphPhysics)),A.graph=O}for(var U=0;U<e.warmupTicks&&!(C&&e.d3AlphaMin>0&&e.d3ForceLayout.alpha()<e.d3AlphaMin);U++)A[C?"tick":"step"]();e.layout=A,this.resetCountdown()}e.engineRunning=!0,e.onFinishUpdate()}});var Cw=function(e){var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=function(n){function i(){var n;$b(this,i);for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];return(n=Xb(this,i,[].concat(s))).__kapsuleInstance=Jb(e,[].concat(cw(t?[n]:[]),s)),n}return iw(i,n),Qb(i)}(arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object);return Object.keys(e()).forEach((function(e){return n.prototype[e]=function(){var t,n=(t=this.__kapsuleInstance)[e].apply(t,arguments);return n===this.__kapsuleInstance?this:n}})),n}(Aw,(window.THREE?window.THREE:{Group:Md}).Group,!0);if("undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");var Rw=function(e){return"string"==typeof e?JSON.parse(e):e},Nw=function(e){if("function"==typeof e)return e;var t=eval;try{return t("("+e+")")}catch(e){}return null},Pw=function(e){return isNaN(parseFloat(e))?Nw(e)?Nw(e):e:parseFloat(e)};function Dw(){return Dw=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Dw.apply(null,arguments)}function Lw(e,t){return Lw=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Lw(e,t)}function Iw(e){return Iw=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Iw(e)}function kw(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(kw=function(){return!!e})()}function Ow(e){var t="function"==typeof Map?new Map:void 0;return Ow=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return function(e,t,n){if(kw())return Reflect.construct.apply(null,arguments);var i=[null];i.push.apply(i,t);var r=new(e.bind.apply(e,i));return n&&Lw(r,n.prototype),r}(e,arguments,Iw(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Lw(n,e)},Ow(e)}AFRAME.components.hasOwnProperty("forcegraph")||AFRAME.registerComponent("forcegraph",{schema:{jsonUrl:{type:"string",default:""},nodes:{parse:Rw,default:[]},links:{parse:Rw,default:[]},numDimensions:{type:"number",default:3},dagMode:{type:"string",default:""},dagLevelDistance:{type:"number",default:0},dagNodeFilter:{parse:Nw,default:function(){return!0}},onDagError:{parse:Nw,default:void 0},nodeRelSize:{type:"number",default:4},nodeId:{type:"string",default:"id"},nodeVal:{parse:Pw,default:"val"},nodeResolution:{type:"number",default:8},nodeVisibility:{parse:Pw,default:!0},nodeColor:{parse:Pw,default:"color"},nodeAutoColorBy:{parse:Pw,default:""},nodeOpacity:{type:"number",default:.75},nodeThreeObject:{parse:Pw,default:null},nodeThreeObjectExtend:{parse:Pw,default:!1},linkSource:{type:"string",default:"source"},linkTarget:{type:"string",default:"target"},linkVisibility:{parse:Pw,default:!0},linkColor:{parse:Pw,default:"color"},linkAutoColorBy:{parse:Pw,default:""},linkOpacity:{type:"number",default:.2},linkWidth:{parse:Pw,default:0},linkResolution:{type:"number",default:6},linkCurvature:{parse:Pw,default:0},linkCurveRotation:{parse:Pw,default:0},linkMaterial:{parse:Pw,default:null},linkThreeObject:{parse:Pw,default:null},linkThreeObjectExtend:{parse:Pw,default:!1},linkPositionUpdate:{parse:Nw,default:null},linkDirectionalArrowLength:{parse:Pw,default:0},linkDirectionalArrowColor:{parse:Pw,default:null},linkDirectionalArrowRelPos:{parse:Pw,default:.5},linkDirectionalArrowResolution:{type:"number",default:8},linkDirectionalParticles:{parse:Pw,default:0},linkDirectionalParticleSpeed:{parse:Pw,default:.01},linkDirectionalParticleWidth:{parse:Pw,default:.5},linkDirectionalParticleColor:{parse:Pw,default:null},linkDirectionalParticleResolution:{type:"number",default:4},onNodeHover:{parse:Nw,default:function(){}},onLinkHover:{parse:Nw,default:function(){}},onNodeClick:{parse:Nw,default:function(){}},onLinkClick:{parse:Nw,default:function(){}},forceEngine:{type:"string",default:"d3"},d3AlphaMin:{type:"number",default:0},d3AlphaDecay:{type:"number",default:.0228},d3VelocityDecay:{type:"number",default:.4},ngraphPhysics:{parse:Rw,default:null},warmupTicks:{type:"int",default:0},cooldownTicks:{type:"int",default:1e18},cooldownTime:{type:"int",default:15e3},onEngineTick:{parse:Nw,default:function(){}},onEngineStop:{parse:Nw,default:function(){}}},getGraphBbox:function(e){return this.forceGraph||(this.forceGraph=new Cw),this.forceGraph.getGraphBbox(e)},emitParticle:function(){this.forceGraph||(this.forceGraph=new Cw);var e=this.forceGraph,t=e.emitParticle.apply(e,arguments);return t===e?this:t},d3Force:function(){this.forceGraph||(this.forceGraph=new Cw);var e=this.forceGraph,t=e.d3Force.apply(e,arguments);return t===e?this:t},d3ReheatSimulation:function(){return this.forceGraph&&this.forceGraph.d3ReheatSimulation(),this},refresh:function(){return this.forceGraph&&this.forceGraph.refresh(),this},init:function(){var e=this,t=this.state={};t.infoEl=document.createElement("a-text"),t.infoEl.setAttribute("position","0 -0.1 -1"),t.infoEl.setAttribute("width",1),t.infoEl.setAttribute("align","center"),t.infoEl.setAttribute("color","lavender");var n=document.querySelector("a-entity[camera], a-camera");n.appendChild(t.infoEl),t.cameraObj=n.object3D.children.filter((function(e){return"PerspectiveCamera"===e.type}))[0],this.el.sceneEl.addEventListener("camera-set-active",(function(e){t.cameraObj=e.detail.cameraEl.components.camera.camera})),this.forceGraph||(this.forceGraph=new Cw),this.forceGraph.onFinishUpdate((function(){return e.el.setObject3D("forcegraphGroup",e.forceGraph)})).onLoading((function(){return t.infoEl.setAttribute("value","Loading...")})).onFinishLoading((function(){return t.infoEl.setAttribute("value","")})),this.el.addEventListener("raycaster-intersected",(function(e){return t.hoverDetail=e.detail})),this.el.addEventListener("raycaster-intersected-cleared",(function(e){return t.hoverDetail=e.detail})),this.el.addEventListener("click",(function(){return t.hoverObj&&e.data["on"+("node"===t.hoverObj.__graphObjType?"Node":"Link")+"Click"](t.hoverObj.__data)}))},remove:function(){this.state.infoEl.remove(),this.el.removeObject3D("forcegraphGroup")},update:function(e){var t=this,n=this.data,i=AFRAME.utils.diff(n,e);["jsonUrl","numDimensions","dagMode","dagLevelDistance","dagNodeFilter","onDagError","nodeRelSize","nodeId","nodeVal","nodeResolution","nodeVisibility","nodeColor","nodeAutoColorBy","nodeOpacity","nodeThreeObject","nodeThreeObjectExtend","linkSource","linkTarget","linkVisibility","linkColor","linkAutoColorBy","linkOpacity","linkWidth","linkResolution","linkCurvature","linkCurveRotation","linkMaterial","linkThreeObject","linkThreeObjectExtend","linkPositionUpdate","linkDirectionalArrowLength","linkDirectionalArrowColor","linkDirectionalArrowRelPos","linkDirectionalArrowResolution","linkDirectionalParticles","linkDirectionalParticleSpeed","linkDirectionalParticleWidth","linkDirectionalParticleColor","linkDirectionalParticleResolution","forceEngine","d3AlphaMin","d3AphaDecay","d3VelocityDecay","ngraphPhysics","warmupTicks","cooldownTicks","cooldownTime","onEngineTick","onEngineStop"].filter((function(e){return e in i})).forEach((function(e){t.forceGraph[e](""!==n[e]?n[e]:null)})),("nodes"in i||"links"in i)&&t.forceGraph.graphData({nodes:n.nodes,links:n.links})},tick:function(e,t){for(var n=this.state,i=this.data,r=n.hoverDetail?n.hoverDetail.getIntersection?n.hoverDetail.getIntersection(this.el):n.hoverDetail.intersection||void 0:void 0,s=r?r.object:void 0;s&&!s.hasOwnProperty("__graphObjType");)s=s.parent;if(s!==n.hoverObj){var o=n.hoverObj?n.hoverObj.__graphObjType:null,a=n.hoverObj?n.hoverObj.__data:null,l=s?s.__graphObjType:null,c=s?s.__data:null;o&&o!==l&&i["on"+("node"===o?"Node":"Link")+"Hover"](null,a),l&&i["on"+("node"===l?"Node":"Link")+"Hover"](c,o===l?a:null),n.hoverObj=s}this.forceGraph.tickFrame()}});var Uw={1:"Passed invalid arguments to hsl, please pass multiple numbers e.g. hsl(360, 0.75, 0.4) or an object e.g. rgb({ hue: 255, saturation: 0.4, lightness: 0.75 }).\n\n",2:"Passed invalid arguments to hsla, please pass multiple numbers e.g. hsla(360, 0.75, 0.4, 0.7) or an object e.g. rgb({ hue: 255, saturation: 0.4, lightness: 0.75, alpha: 0.7 }).\n\n",3:"Passed an incorrect argument to a color function, please pass a string representation of a color.\n\n",4:"Couldn't generate valid rgb string from %s, it returned %s.\n\n",5:"Couldn't parse the color string. Please provide the color as a string in hex, rgb, rgba, hsl or hsla notation.\n\n",6:"Passed invalid arguments to rgb, please pass multiple numbers e.g. rgb(255, 205, 100) or an object e.g. rgb({ red: 255, green: 205, blue: 100 }).\n\n",7:"Passed invalid arguments to rgba, please pass multiple numbers e.g. rgb(255, 205, 100, 0.75) or an object e.g. rgb({ red: 255, green: 205, blue: 100, alpha: 0.75 }).\n\n",8:"Passed invalid argument to toColorString, please pass a RgbColor, RgbaColor, HslColor or HslaColor object.\n\n",9:"Please provide a number of steps to the modularScale helper.\n\n",10:"Please pass a number or one of the predefined scales to the modularScale helper as the ratio.\n\n",11:'Invalid value passed as base to modularScale, expected number or em string but got "%s"\n\n',12:'Expected a string ending in "px" or a number passed as the first argument to %s(), got "%s" instead.\n\n',13:'Expected a string ending in "px" or a number passed as the second argument to %s(), got "%s" instead.\n\n',14:'Passed invalid pixel value ("%s") to %s(), please pass a value like "12px" or 12.\n\n',15:'Passed invalid base value ("%s") to %s(), please pass a value like "12px" or 12.\n\n',16:"You must provide a template to this method.\n\n",17:"You passed an unsupported selector state to this method.\n\n",18:"minScreen and maxScreen must be provided as stringified numbers with the same units.\n\n",19:"fromSize and toSize must be provided as stringified numbers with the same units.\n\n",20:"expects either an array of objects or a single object with the properties prop, fromSize, and toSize.\n\n",21:"expects the objects in the first argument array to have the properties `prop`, `fromSize`, and `toSize`.\n\n",22:"expects the first argument object to have the properties `prop`, `fromSize`, and `toSize`.\n\n",23:"fontFace expects a name of a font-family.\n\n",24:"fontFace expects either the path to the font file(s) or a name of a local copy.\n\n",25:"fontFace expects localFonts to be an array.\n\n",26:"fontFace expects fileFormats to be an array.\n\n",27:"radialGradient requries at least 2 color-stops to properly render.\n\n",28:"Please supply a filename to retinaImage() as the first argument.\n\n",29:"Passed invalid argument to triangle, please pass correct pointingDirection e.g. 'right'.\n\n",30:"Passed an invalid value to `height` or `width`. Please provide a pixel based unit.\n\n",31:"The animation shorthand only takes 8 arguments. See the specification for more information: http://mdn.io/animation\n\n",32:"To pass multiple animations please supply them in arrays, e.g. animation(['rotate', '2s'], ['move', '1s'])\nTo pass a single animation please supply them in simple values, e.g. animation('rotate', '2s')\n\n",33:"The animation shorthand arrays can only have 8 elements. See the specification for more information: http://mdn.io/animation\n\n",34:"borderRadius expects a radius value as a string or number as the second argument.\n\n",35:'borderRadius expects one of "top", "bottom", "left" or "right" as the first argument.\n\n',36:"Property must be a string value.\n\n",37:"Syntax Error at %s.\n\n",38:"Formula contains a function that needs parentheses at %s.\n\n",39:"Formula is missing closing parenthesis at %s.\n\n",40:"Formula has too many closing parentheses at %s.\n\n",41:"All values in a formula must have the same unit or be unitless.\n\n",42:"Please provide a number of steps to the modularScale helper.\n\n",43:"Please pass a number or one of the predefined scales to the modularScale helper as the ratio.\n\n",44:"Invalid value passed as base to modularScale, expected number or em/rem string but got %s.\n\n",45:"Passed invalid argument to hslToColorString, please pass a HslColor or HslaColor object.\n\n",46:"Passed invalid argument to rgbToColorString, please pass a RgbColor or RgbaColor object.\n\n",47:"minScreen and maxScreen must be provided as stringified numbers with the same units.\n\n",48:"fromSize and toSize must be provided as stringified numbers with the same units.\n\n",49:"Expects either an array of objects or a single object with the properties prop, fromSize, and toSize.\n\n",50:"Expects the objects in the first argument array to have the properties prop, fromSize, and toSize.\n\n",51:"Expects the first argument object to have the properties prop, fromSize, and toSize.\n\n",52:"fontFace expects either the path to the font file(s) or a name of a local copy.\n\n",53:"fontFace expects localFonts to be an array.\n\n",54:"fontFace expects fileFormats to be an array.\n\n",55:"fontFace expects a name of a font-family.\n\n",56:"linearGradient requries at least 2 color-stops to properly render.\n\n",57:"radialGradient requries at least 2 color-stops to properly render.\n\n",58:"Please supply a filename to retinaImage() as the first argument.\n\n",59:"Passed invalid argument to triangle, please pass correct pointingDirection e.g. 'right'.\n\n",60:"Passed an invalid value to `height` or `width`. Please provide a pixel based unit.\n\n",61:"Property must be a string value.\n\n",62:"borderRadius expects a radius value as a string or number as the second argument.\n\n",63:'borderRadius expects one of "top", "bottom", "left" or "right" as the first argument.\n\n',64:"The animation shorthand only takes 8 arguments. See the specification for more information: http://mdn.io/animation.\n\n",65:"To pass multiple animations please supply them in arrays, e.g. animation(['rotate', '2s'], ['move', '1s'])\\nTo pass a single animation please supply them in simple values, e.g. animation('rotate', '2s').\n\n",66:"The animation shorthand arrays can only have 8 elements. See the specification for more information: http://mdn.io/animation.\n\n",67:"You must provide a template to this method.\n\n",68:"You passed an unsupported selector state to this method.\n\n",69:'Expected a string ending in "px" or a number passed as the first argument to %s(), got %s instead.\n\n',70:'Expected a string ending in "px" or a number passed as the second argument to %s(), got %s instead.\n\n',71:'Passed invalid pixel value %s to %s(), please pass a value like "12px" or 12.\n\n',72:'Passed invalid base value %s to %s(), please pass a value like "12px" or 12.\n\n',73:"Please provide a valid CSS variable.\n\n",74:"CSS variable not found and no default was provided.\n\n",75:"important requires a valid style object, got a %s instead.\n\n",76:"fromSize and toSize must be provided as stringified numbers with the same units as minScreen and maxScreen.\n\n",77:'remToPx expects a value in "rem" but you provided it in "%s".\n\n',78:'base must be set in "px" or "%" but you set it in "%s".\n'};function Fw(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i,r=t[0],s=[];for(i=1;i<t.length;i+=1)s.push(t[i]);return s.forEach((function(e){r=r.replace(/%[a-z]/,e)})),r}var Bw=function(e){function t(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e.call(this,Fw.apply(void 0,[Uw[t]].concat(i)))||this)}return function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Lw(e,t)}(t,e),t}(Ow(Error));function zw(e){return Math.round(255*e)}function Vw(e,t,n){return zw(e)+","+zw(t)+","+zw(n)}function Gw(e,t,n,i){if(void 0===i&&(i=Vw),0===t)return i(n,n,n);var r=(e%360+360)%360/60,s=(1-Math.abs(2*n-1))*t,o=s*(1-Math.abs(r%2-1)),a=0,l=0,c=0;r>=0&&r<1?(a=s,l=o):r>=1&&r<2?(a=o,l=s):r>=2&&r<3?(l=s,c=o):r>=3&&r<4?(l=o,c=s):r>=4&&r<5?(a=o,c=s):r>=5&&r<6&&(a=s,c=o);var u=n-s/2;return i(a+u,l+u,c+u)}var jw={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"639",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"};var Hw=/^#[a-fA-F0-9]{6}$/,Ww=/^#[a-fA-F0-9]{8}$/,qw=/^#[a-fA-F0-9]{3}$/,Xw=/^#[a-fA-F0-9]{4}$/,$w=/^rgb\(\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*\)$/i,Yw=/^rgb(?:a)?\(\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*(?:,|\/)\s*([-+]?\d*[.]?\d+[%]?)\s*\)$/i,Kw=/^hsl\(\s*(\d{0,3}[.]?[0-9]+(?:deg)?)\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*\)$/i,Zw=/^hsl(?:a)?\(\s*(\d{0,3}[.]?[0-9]+(?:deg)?)\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*(?:,|\/)\s*([-+]?\d*[.]?\d+[%]?)\s*\)$/i;function Jw(e){if("string"!=typeof e)throw new Bw(3);var t=function(e){if("string"!=typeof e)return e;var t=e.toLowerCase();return jw[t]?"#"+jw[t]:e}(e);if(t.match(Hw))return{red:parseInt(""+t[1]+t[2],16),green:parseInt(""+t[3]+t[4],16),blue:parseInt(""+t[5]+t[6],16)};if(t.match(Ww)){var n=parseFloat((parseInt(""+t[7]+t[8],16)/255).toFixed(2));return{red:parseInt(""+t[1]+t[2],16),green:parseInt(""+t[3]+t[4],16),blue:parseInt(""+t[5]+t[6],16),alpha:n}}if(t.match(qw))return{red:parseInt(""+t[1]+t[1],16),green:parseInt(""+t[2]+t[2],16),blue:parseInt(""+t[3]+t[3],16)};if(t.match(Xw)){var i=parseFloat((parseInt(""+t[4]+t[4],16)/255).toFixed(2));return{red:parseInt(""+t[1]+t[1],16),green:parseInt(""+t[2]+t[2],16),blue:parseInt(""+t[3]+t[3],16),alpha:i}}var r=$w.exec(t);if(r)return{red:parseInt(""+r[1],10),green:parseInt(""+r[2],10),blue:parseInt(""+r[3],10)};var s=Yw.exec(t.substring(0,50));if(s)return{red:parseInt(""+s[1],10),green:parseInt(""+s[2],10),blue:parseInt(""+s[3],10),alpha:parseFloat(""+s[4])>1?parseFloat(""+s[4])/100:parseFloat(""+s[4])};var o=Kw.exec(t);if(o){var a="rgb("+Gw(parseInt(""+o[1],10),parseInt(""+o[2],10)/100,parseInt(""+o[3],10)/100)+")",l=$w.exec(a);if(!l)throw new Bw(4,t,a);return{red:parseInt(""+l[1],10),green:parseInt(""+l[2],10),blue:parseInt(""+l[3],10)}}var c=Zw.exec(t.substring(0,50));if(c){var u="rgb("+Gw(parseInt(""+c[1],10),parseInt(""+c[2],10)/100,parseInt(""+c[3],10)/100)+")",h=$w.exec(u);if(!h)throw new Bw(4,t,u);return{red:parseInt(""+h[1],10),green:parseInt(""+h[2],10),blue:parseInt(""+h[3],10),alpha:parseFloat(""+c[4])>1?parseFloat(""+c[4])/100:parseFloat(""+c[4])}}throw new Bw(5)}function Qw(e){return function(e){var t,n=e.red/255,i=e.green/255,r=e.blue/255,s=Math.max(n,i,r),o=Math.min(n,i,r),a=(s+o)/2;if(s===o)return void 0!==e.alpha?{hue:0,saturation:0,lightness:a,alpha:e.alpha}:{hue:0,saturation:0,lightness:a};var l=s-o,c=a>.5?l/(2-s-o):l/(s+o);switch(s){case n:t=(i-r)/l+(i<r?6:0);break;case i:t=(r-n)/l+2;break;default:t=(n-i)/l+4}return t*=60,void 0!==e.alpha?{hue:t,saturation:c,lightness:a,alpha:e.alpha}:{hue:t,saturation:c,lightness:a}}(Jw(e))}var eT=function(e){return 7===e.length&&e[1]===e[2]&&e[3]===e[4]&&e[5]===e[6]?"#"+e[1]+e[3]+e[5]:e};function tT(e){var t=e.toString(16);return 1===t.length?"0"+t:t}function nT(e){return tT(Math.round(255*e))}function iT(e,t,n){return eT("#"+nT(e)+nT(t)+nT(n))}function rT(e,t,n){return Gw(e,t,n,iT)}function sT(e,t,n){if("number"==typeof e&&"number"==typeof t&&"number"==typeof n)return eT("#"+tT(e)+tT(t)+tT(n));if("object"==typeof e&&void 0===t&&void 0===n)return eT("#"+tT(e.red)+tT(e.green)+tT(e.blue));throw new Bw(6)}function oT(e,t,n,i){if("object"==typeof e&&void 0===t&&void 0===n&&void 0===i)return e.alpha>=1?sT(e.red,e.green,e.blue):"rgba("+e.red+","+e.green+","+e.blue+","+e.alpha+")";throw new Bw(7)}function aT(e){if("object"!=typeof e)throw new Bw(8);if(function(e){return"number"==typeof e.red&&"number"==typeof e.green&&"number"==typeof e.blue&&"number"==typeof e.alpha}(e))return oT(e);if(function(e){return"number"==typeof e.red&&"number"==typeof e.green&&"number"==typeof e.blue&&("number"!=typeof e.alpha||void 0===e.alpha)}(e))return sT(e);if(function(e){return"number"==typeof e.hue&&"number"==typeof e.saturation&&"number"==typeof e.lightness&&"number"==typeof e.alpha}(e))return function(e,t,n,i){if("object"==typeof e&&void 0===t&&void 0===n&&void 0===i)return e.alpha>=1?rT(e.hue,e.saturation,e.lightness):"rgba("+Gw(e.hue,e.saturation,e.lightness)+","+e.alpha+")";throw new Bw(2)}(e);if(function(e){return"number"==typeof e.hue&&"number"==typeof e.saturation&&"number"==typeof e.lightness&&("number"!=typeof e.alpha||void 0===e.alpha)}(e))return function(e,t,n){if("object"==typeof e&&void 0===t&&void 0===n)return rT(e.hue,e.saturation,e.lightness);throw new Bw(1)}(e);throw new Bw(8)}function lT(e,t,n){return function(){var i=n.concat(Array.prototype.slice.call(arguments));return i.length>=t?e.apply(this,i):lT(e,t,i)}}function cT(e){return lT(e,e.length,[])}function uT(e,t,n){return Math.max(e,Math.min(t,n))}cT((function(e,t){if("transparent"===t)return t;var n=Qw(t);return aT(Dw({},n,{hue:n.hue+parseFloat(e)}))})),cT((function(e,t){if("transparent"===t)return t;var n=Qw(t);return aT(Dw({},n,{lightness:uT(0,1,n.lightness-parseFloat(e))}))})),cT((function(e,t){if("transparent"===t)return t;var n=Qw(t);return aT(Dw({},n,{saturation:uT(0,1,n.saturation-parseFloat(e))}))})),cT((function(e,t){if("transparent"===t)return t;var n=Qw(t);return aT(Dw({},n,{lightness:uT(0,1,n.lightness+parseFloat(e))}))}));var hT=cT((function(e,t,n){if("transparent"===t)return n;if("transparent"===n)return t;if(0===e)return n;var i=Jw(t),r=Dw({},i,{alpha:"number"==typeof i.alpha?i.alpha:1}),s=Jw(n),o=Dw({},s,{alpha:"number"==typeof s.alpha?s.alpha:1}),a=r.alpha-o.alpha,l=2*parseFloat(e)-1,c=((l*a===-1?l:l+a)/(1+l*a)+1)/2,u=1-c;return oT({red:Math.floor(r.red*c+o.red*u),green:Math.floor(r.green*c+o.green*u),blue:Math.floor(r.blue*c+o.blue*u),alpha:r.alpha*parseFloat(e)+o.alpha*(1-parseFloat(e))})})),dT=hT;var pT=cT((function(e,t){if("transparent"===t)return t;var n=Jw(t);return oT(Dw({},n,{alpha:uT(0,1,(100*("number"==typeof n.alpha?n.alpha:1)+100*parseFloat(e))/100)}))})),fT=pT;cT((function(e,t){if("transparent"===t)return t;var n=Qw(t);return aT(Dw({},n,{saturation:uT(0,1,n.saturation+parseFloat(e))}))})),cT((function(e,t){return"transparent"===t?t:aT(Dw({},Qw(t),{hue:parseFloat(e)}))})),cT((function(e,t){return"transparent"===t?t:aT(Dw({},Qw(t),{lightness:parseFloat(e)}))})),cT((function(e,t){return"transparent"===t?t:aT(Dw({},Qw(t),{saturation:parseFloat(e)}))})),cT((function(e,t){return"transparent"===t?t:dT(parseFloat(e),"rgb(0, 0, 0)",t)})),cT((function(e,t){return"transparent"===t?t:dT(parseFloat(e),"rgb(255, 255, 255)",t)})),cT((function(e,t){if("transparent"===t)return t;var n=Jw(t);return oT(Dw({},n,{alpha:uT(0,1,+(100*("number"==typeof n.alpha?n.alpha:1)-100*parseFloat(e)).toFixed(2)/100)}))}));function mT(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function gT(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function yT(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function vT(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?yT(Object(n),!0).forEach((function(t){gT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):yT(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _T(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,s,o,a=[],l=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t);else for(;!(l=(i=s.call(n)).done)&&(a.push(i.value),a.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return a}}(e,t)||bT(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function xT(e){return function(e){if(Array.isArray(e))return mT(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||bT(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function bT(e,t){if(e){if("string"==typeof e)return mT(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?mT(e,t):void 0}}!function(e,t){void 0===t&&(t={});var n=t.insertAt;if("undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===n&&i.firstChild?i.insertBefore(r,i.firstChild):i.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}(".graph-nav-info {\n  position: absolute;\n  bottom: 5px;\n  width: 100%;\n  text-align: center;\n  color: slategrey;\n  opacity: 0.7;\n  font-size: 10px;\n  font-family: Sans-serif;\n  z-index: 1000;\n}");var wT,TT,ST,MT,ET,AT,CT,RT,NT,PT,DT,LT,IT,kT=B_({props:{width:{default:window.innerWidth,triggerUpdate:!1,onChange:function(e,t){t.container&&(t.container.style.width="".concat(e,"px"))}},height:{default:window.innerHeight,triggerUpdate:!1,onChange:function(e,t){t.container&&(t.container.style.height="".concat(e,"px"))}},jsonUrl:{},graphData:{default:{nodes:[],links:[]}},numDimensions:{default:3},dagMode:{},dagLevelDistance:{},dagNodeFilter:{default:function(){return!0}},onDagError:{default:void 0},backgroundColor:{default:"#002"},showNavInfo:{default:!0},nodeRelSize:{default:4},nodeId:{default:"id"},nodeLabel:{default:"name"},nodeDesc:{default:"desc"},onNodeHover:{},onNodeClick:{},nodeVal:{default:"val"},nodeResolution:{default:8},nodeVisibility:{default:!0},nodeColor:{default:"color"},nodeAutoColorBy:{},nodeOpacity:{default:.75},nodeThreeObject:{},nodeThreeObjectExtend:{default:!1},linkSource:{default:"source"},linkTarget:{default:"target"},linkLabel:{default:"name"},linkDesc:{default:"desc"},onLinkHover:{},onLinkClick:{},linkVisibility:{default:!0},linkColor:{default:"color"},linkAutoColorBy:{},linkOpacity:{default:.2},linkWidth:{default:0},linkResolution:{default:6},linkCurvature:{default:0},linkCurveRotation:{default:0},linkMaterial:{},linkThreeObject:{},linkThreeObjectExtend:{default:!1},linkPositionUpdate:{},linkDirectionalArrowLength:{default:0},linkDirectionalArrowColor:{},linkDirectionalArrowRelPos:{default:.5},linkDirectionalArrowResolution:{default:8},linkDirectionalParticles:{default:0},linkDirectionalParticleSpeed:{default:.01},linkDirectionalParticleWidth:{default:.5},linkDirectionalParticleColor:{},linkDirectionalParticleResolution:{default:4},forceEngine:{default:"d3"},d3AlphaMin:{default:0},d3AlphaDecay:{default:.0228},d3VelocityDecay:{default:.4},ngraphPhysics:{},warmupTicks:{default:0},cooldownTicks:{},cooldownTime:{default:15e3},onEngineTick:{},onEngineStop:{}},methods:vT(vT({},Object.assign.apply(Object,[{}].concat(xT(["getGraphBbox","emitParticle","d3Force","d3ReheatSimulation","refresh"].map((function(e){return gT({},e,(function(t){for(var n=t.forcegraph.components.forcegraph,i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];var o=n[e].apply(n,r);return o===n?this:o}))})))))),{},{_destructor:function(){this.graphData({nodes:[],links:[]})}}),init:function(e,t){e.innerHTML="",t.container=document.createElement("div"),e.appendChild(t.container),t.container.style.position="relative",t.container.style.width="".concat(t.width,"px"),t.container.style.height="".concat(t.height,"px"),t.container.appendChild(t.navInfo=document.createElement("div")),t.navInfo.className="graph-nav-info",t.navInfo.textContent="Mouse drag: look, gamepad/arrow/wasd keys: move";var n,i,r,s,o,a=document.createElement("a-scene");a.setAttribute("embedded",""),a.appendChild(t.sky=document.createElement("a-sky")),t.sky.setAttribute("radius",3e3),a.appendChild(n=document.createElement("a-entity")),n.setAttribute("position","0 0 300"),n.setAttribute("movement-controls","controls: gamepad, touch; fly: true; speed: 7"),n.appendChild(i=document.createElement("a-entity")),i.setAttribute("camera",""),i.setAttribute("position","0 0 0"),i.setAttribute("look-controls","pointerLockEnabled: false"),i.setAttribute("wasd-controls","fly: true; acceleration: 700"),i.appendChild(r=document.createElement("a-text")),r.setAttribute("position","0 -0.3 -1"),r.setAttribute("width",2),r.setAttribute("align","center"),r.setAttribute("color","lavender"),r.setAttribute("value",""),i.appendChild(s=document.createElement("a-text")),s.setAttribute("position","0 -0.4 -1"),s.setAttribute("width",1.3),s.setAttribute("align","center"),s.setAttribute("color","lavender"),s.setAttribute("value",""),t.raycasterEls=[],a.appendChild(o=document.createElement("a-entity")),o.setAttribute("cursor","rayOrigin: mouse; mouseCursorStylesEnabled: true"),o.setAttribute("raycaster","objects: [forcegraph]; interval: 100"),t.raycasterEls.push(o),["left","right"].forEach((function(e){var i;n.appendChild(i=document.createElement("a-entity")),i.setAttribute("laser-controls","hand: ".concat(e,"; model: false;")),i.setAttribute("raycaster","objects: [forcegraph]; interval: 100; lineColor: steelblue; lineOpacity: 0.85"),t.raycasterEls.push(i)})),a.appendChild(t.forcegraph=document.createElement("a-entity")),t.forcegraph.setAttribute("forcegraph",null),t.container.appendChild(a),t.forcegraph.setAttribute("forcegraph",Object.assign.apply(Object,xT(["node","link"].map((function(e){var n={node:"Node",link:"Link"}[e];return gT({},"on".concat(n,"Hover"),(function(i,o){var a=i&&z_(t["".concat(e,"Label")])(i)||"",l=i&&z_(t["".concat(e,"Desc")])(i)||"";r.setAttribute("value",a),s.setAttribute("value",l),t["on".concat(n,"Hover")]&&t["on".concat(n,"Hover")](i,o)}))})))))},update:function(e,t){if(t.hasOwnProperty("backgroundColor")){var n=Jw(e.backgroundColor).alpha;void 0===n&&(n=1),e.sky.setAttribute("color",fT(1,e.backgroundColor)),e.sky.setAttribute("opacity",n)}t.hasOwnProperty("showNavInfo")&&(e.navInfo.style.display=e.showNavInfo?null:"none");var i=["onNodeHover","onLinkHover","onNodeClick","onLinkClick"].some((function(t){return e[t]}))||["nodeLabel","linkLabel"].some((function(t){return"name"!==e[t]}))||["nodeDesc","linkDesc"].some((function(t){return"desc"!==e[t]}));e.raycasterEls.forEach((function(e){return e.setAttribute("raycaster",i?"objects: [forcegraph]; interval: 100":"objects: __none__")}));var r=["jsonUrl","numDimensions","dagMode","dagLevelDistance","dagNodeFilter","onDagError","nodeRelSize","nodeId","onNodeClick","nodeVal","nodeResolution","nodeVisibility","nodeColor","nodeAutoColorBy","nodeOpacity","nodeThreeObject","nodeThreeObjectExtend","linkSource","linkTarget","onLinkClick","linkVisibility","linkColor","linkAutoColorBy","linkOpacity","linkWidth","linkResolution","linkCurvature","linkCurveRotation","linkMaterial","linkThreeObject","linkThreeObjectExtend","linkPositionUpdate","linkDirectionalArrowLength","linkDirectionalArrowColor","linkDirectionalArrowRelPos","linkDirectionalArrowResolution","linkDirectionalParticles","linkDirectionalParticleSpeed","linkDirectionalParticleWidth","linkDirectionalParticleColor","linkDirectionalParticleResolution","forceEngine","d3AlphaMin","d3AlphaDecay","d3VelocityDecay","ngraphPhysics","warmupTicks","cooldownTicks","cooldownTime","onEngineTick","onEngineStop"],s=Object.assign.apply(Object,[{}].concat(xT(Object.entries(e).filter((function(e){var n=_T(e,2),i=n[0],s=n[1];return t.hasOwnProperty(i)&&-1!==r.indexOf(i)&&null!=s})).map((function(e){var t=_T(e,2);return gT({},t[0],t[1])}))),xT(Object.entries(e.graphData).map((function(e){var t=_T(e,2);return gT({},t[0],t[1])})))));e.forcegraph.setAttribute("forcegraph",s)}}),OT={exports:{}},UT={exports:{}},FT={};function BT(){return TT||(TT=1,UT.exports=(wT||(wT=1,function(){var e="function"==typeof Symbol&&Symbol.for,t=e?Symbol.for("react.element"):60103,n=e?Symbol.for("react.portal"):60106,i=e?Symbol.for("react.fragment"):60107,r=e?Symbol.for("react.strict_mode"):60108,s=e?Symbol.for("react.profiler"):60114,o=e?Symbol.for("react.provider"):60109,a=e?Symbol.for("react.context"):60110,l=e?Symbol.for("react.async_mode"):60111,c=e?Symbol.for("react.concurrent_mode"):60111,u=e?Symbol.for("react.forward_ref"):60112,h=e?Symbol.for("react.suspense"):60113,d=e?Symbol.for("react.suspense_list"):60120,p=e?Symbol.for("react.memo"):60115,f=e?Symbol.for("react.lazy"):60116,m=e?Symbol.for("react.block"):60121,g=e?Symbol.for("react.fundamental"):60117,y=e?Symbol.for("react.responder"):60118,v=e?Symbol.for("react.scope"):60119;function _(e){if("object"==typeof e&&null!==e){var d=e.$$typeof;switch(d){case t:var m=e.type;switch(m){case l:case c:case i:case s:case r:case h:return m;default:var g=m&&m.$$typeof;switch(g){case a:case u:case f:case p:case o:return g;default:return d}}case n:return d}}}var x=l,b=c,w=a,T=o,S=t,M=u,E=i,A=f,C=p,R=n,N=s,P=r,D=h,L=!1;function I(e){return _(e)===c}FT.AsyncMode=x,FT.ConcurrentMode=b,FT.ContextConsumer=w,FT.ContextProvider=T,FT.Element=S,FT.ForwardRef=M,FT.Fragment=E,FT.Lazy=A,FT.Memo=C,FT.Portal=R,FT.Profiler=N,FT.StrictMode=P,FT.Suspense=D,FT.isAsyncMode=function(e){return L||(L=!0,console.warn("The ReactIs.isAsyncMode() alias has been deprecated, and will be removed in React 17+. Update your code to use ReactIs.isConcurrentMode() instead. It has the exact same API.")),I(e)||_(e)===l},FT.isConcurrentMode=I,FT.isContextConsumer=function(e){return _(e)===a},FT.isContextProvider=function(e){return _(e)===o},FT.isElement=function(e){return"object"==typeof e&&null!==e&&e.$$typeof===t},FT.isForwardRef=function(e){return _(e)===u},FT.isFragment=function(e){return _(e)===i},FT.isLazy=function(e){return _(e)===f},FT.isMemo=function(e){return _(e)===p},FT.isPortal=function(e){return _(e)===n},FT.isProfiler=function(e){return _(e)===s},FT.isStrictMode=function(e){return _(e)===r},FT.isSuspense=function(e){return _(e)===h},FT.isValidElementType=function(e){return"string"==typeof e||"function"==typeof e||e===i||e===c||e===s||e===r||e===h||e===d||"object"==typeof e&&null!==e&&(e.$$typeof===f||e.$$typeof===p||e.$$typeof===o||e.$$typeof===a||e.$$typeof===u||e.$$typeof===g||e.$$typeof===y||e.$$typeof===v||e.$$typeof===m)},FT.typeOf=_}()),FT)),UT.exports}function zT(){if(MT)return ST;MT=1;var e=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable;return ST=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;var i=Object.getOwnPropertyNames(t).map((function(e){return t[e]}));if("0123456789"!==i.join(""))return!1;var r={};return"abcdefghijklmnopqrst".split("").forEach((function(e){r[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},r)).join("")}catch(e){return!1}}()?Object.assign:function(i,r){for(var s,o,a=function(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}(i),l=1;l<arguments.length;l++){for(var c in s=Object(arguments[l]))t.call(s,c)&&(a[c]=s[c]);if(e){o=e(s);for(var u=0;u<o.length;u++)n.call(s,o[u])&&(a[o[u]]=s[o[u]])}}return a},ST}function VT(){if(AT)return ET;AT=1;return ET="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"}function GT(){return RT?CT:(RT=1,CT=Function.call.bind(Object.prototype.hasOwnProperty))}function jT(){if(PT)return NT;PT=1;var e,t=VT(),n={},i=GT();function r(r,s,o,a,l){for(var c in r)if(i(r,c)){var u;try{if("function"!=typeof r[c]){var h=Error((a||"React class")+": "+o+" type `"+c+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof r[c]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw h.name="Invariant Violation",h}u=r[c](s,c,a,o,null,t)}catch(e){u=e}if(!u||u instanceof Error||e((a||"React class")+": type specification of "+o+" `"+c+"` is invalid; the type checker function must return `null` or an `Error` but returned a "+typeof u+". You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument)."),u instanceof Error&&!(u.message in n)){n[u.message]=!0;var d=l?l():"";e("Failed "+o+" type: "+u.message+(null!=d?d:""))}}}return e=function(e){var t="Warning: "+e;"undefined"!=typeof console&&console.error(t);try{throw new Error(t)}catch(e){}},r.resetWarningCache=function(){n={}},NT=r}function HT(){if(LT)return DT;LT=1;var e,t=BT(),n=zT(),i=VT(),r=GT(),s=jT();function o(){return null}return e=function(e){var t="Warning: "+e;"undefined"!=typeof console&&console.error(t);try{throw new Error(t)}catch(e){}},DT=function(a,l){var c="function"==typeof Symbol&&Symbol.iterator;var u="<<anonymous>>",h={array:m("array"),bigint:m("bigint"),bool:m("boolean"),func:m("function"),number:m("number"),object:m("object"),string:m("string"),symbol:m("symbol"),any:f(o),arrayOf:function(e){return f((function(t,n,r,s,o){if("function"!=typeof e)return new p("Property `"+o+"` of component `"+r+"` has invalid PropType notation inside arrayOf.");var a=t[n];if(!Array.isArray(a))return new p("Invalid "+s+" `"+o+"` of type `"+v(a)+"` supplied to `"+r+"`, expected an array.");for(var l=0;l<a.length;l++){var c=e(a,l,r,s,o+"["+l+"]",i);if(c instanceof Error)return c}return null}))},element:f((function(e,t,n,i,r){var s=e[t];return a(s)?null:new p("Invalid "+i+" `"+r+"` of type `"+v(s)+"` supplied to `"+n+"`, expected a single ReactElement.")})),elementType:f((function(e,n,i,r,s){var o=e[n];return t.isValidElementType(o)?null:new p("Invalid "+r+" `"+s+"` of type `"+v(o)+"` supplied to `"+i+"`, expected a single ReactElement type.")})),instanceOf:function(e){return f((function(t,n,i,r,s){if(!(t[n]instanceof e)){var o=e.name||u;return new p("Invalid "+r+" `"+s+"` of type `"+(((a=t[n]).constructor&&a.constructor.name?a.constructor.name:u)+"` supplied to `")+i+"`, expected instance of `"+o+"`.")}var a;return null}))},node:f((function(e,t,n,i,r){return y(e[t])?null:new p("Invalid "+i+" `"+r+"` supplied to `"+n+"`, expected a ReactNode.")})),objectOf:function(e){return f((function(t,n,s,o,a){if("function"!=typeof e)return new p("Property `"+a+"` of component `"+s+"` has invalid PropType notation inside objectOf.");var l=t[n],c=v(l);if("object"!==c)return new p("Invalid "+o+" `"+a+"` of type `"+c+"` supplied to `"+s+"`, expected an object.");for(var u in l)if(r(l,u)){var h=e(l,u,s,o,a+"."+u,i);if(h instanceof Error)return h}return null}))},oneOf:function(t){if(!Array.isArray(t))return e(arguments.length>1?"Invalid arguments supplied to oneOf, expected an array, got "+arguments.length+" arguments. A common mistake is to write oneOf(x, y, z) instead of oneOf([x, y, z]).":"Invalid argument supplied to oneOf, expected an array."),o;return f((function(e,n,i,r,s){for(var o=e[n],a=0;a<t.length;a++)if(d(o,t[a]))return null;var l=JSON.stringify(t,(function(e,t){return"symbol"===_(t)?String(t):t}));return new p("Invalid "+r+" `"+s+"` of value `"+String(o)+"` supplied to `"+i+"`, expected one of "+l+".")}))},oneOfType:function(t){if(!Array.isArray(t))return e("Invalid argument supplied to oneOfType, expected an instance of array."),o;for(var n=0;n<t.length;n++){var s=t[n];if("function"!=typeof s)return e("Invalid argument supplied to oneOfType. Expected an array of check functions, but received "+x(s)+" at index "+n+"."),o}return f((function(e,n,s,o,a){for(var l=[],c=0;c<t.length;c++){var u=(0,t[c])(e,n,s,o,a,i);if(null==u)return null;u.data&&r(u.data,"expectedType")&&l.push(u.data.expectedType)}return new p("Invalid "+o+" `"+a+"` supplied to `"+s+"`"+(l.length>0?", expected one of type ["+l.join(", ")+"]":"")+".")}))},shape:function(e){return f((function(t,n,r,s,o){var a=t[n],l=v(a);if("object"!==l)return new p("Invalid "+s+" `"+o+"` of type `"+l+"` supplied to `"+r+"`, expected `object`.");for(var c in e){var u=e[c];if("function"!=typeof u)return g(r,s,o,c,_(u));var h=u(a,c,r,s,o+"."+c,i);if(h)return h}return null}))},exact:function(e){return f((function(t,s,o,a,l){var c=t[s],u=v(c);if("object"!==u)return new p("Invalid "+a+" `"+l+"` of type `"+u+"` supplied to `"+o+"`, expected `object`.");var h=n({},t[s],e);for(var d in h){var f=e[d];if(r(e,d)&&"function"!=typeof f)return g(o,a,l,d,_(f));if(!f)return new p("Invalid "+a+" `"+l+"` key `"+d+"` supplied to `"+o+"`.\nBad object: "+JSON.stringify(t[s],null,"  ")+"\nValid keys: "+JSON.stringify(Object.keys(e),null,"  "));var m=f(c,d,o,a,l+"."+d,i);if(m)return m}return null}))}};function d(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function p(e,t){this.message=e,this.data=t&&"object"==typeof t?t:{},this.stack=""}function f(t){var n={},r=0;function s(s,o,a,c,h,d,f){if(c=c||u,d=d||a,f!==i){if(l){var m=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use `PropTypes.checkPropTypes()` to call them. Read more at http://fb.me/use-check-prop-types");throw m.name="Invariant Violation",m}if("undefined"!=typeof console){var g=c+":"+a;!n[g]&&r<3&&(e("You are manually calling a React.PropTypes validation function for the `"+d+"` prop on `"+c+"`. This is deprecated and will throw in the standalone `prop-types` package. You may be seeing this warning due to a third-party PropTypes library. See https://fb.me/react-warning-dont-call-proptypes for details."),n[g]=!0,r++)}}return null==o[a]?s?null===o[a]?new p("The "+h+" `"+d+"` is marked as required in `"+c+"`, but its value is `null`."):new p("The "+h+" `"+d+"` is marked as required in `"+c+"`, but its value is `undefined`."):null:t(o,a,c,h,d)}var o=s.bind(null,!1);return o.isRequired=s.bind(null,!0),o}function m(e){return f((function(t,n,i,r,s,o){var a=t[n];return v(a)!==e?new p("Invalid "+r+" `"+s+"` of type `"+_(a)+"` supplied to `"+i+"`, expected `"+e+"`.",{expectedType:e}):null}))}function g(e,t,n,i,r){return new p((e||"React class")+": "+t+" type `"+n+"."+i+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+r+"`.")}function y(e){switch(typeof e){case"number":case"string":case"undefined":return!0;case"boolean":return!e;case"object":if(Array.isArray(e))return e.every(y);if(null===e||a(e))return!0;var t=function(e){var t=e&&(c&&e[c]||e["@@iterator"]);if("function"==typeof t)return t}(e);if(!t)return!1;var n,i=t.call(e);if(t!==e.entries){for(;!(n=i.next()).done;)if(!y(n.value))return!1}else for(;!(n=i.next()).done;){var r=n.value;if(r&&!y(r[1]))return!1}return!0;default:return!1}}function v(e){var t=typeof e;return Array.isArray(e)?"array":e instanceof RegExp?"object":function(e,t){return"symbol"===e||!!t&&("Symbol"===t["@@toStringTag"]||"function"==typeof Symbol&&t instanceof Symbol)}(t,e)?"symbol":t}function _(e){if(null==e)return""+e;var t=v(e);if("object"===t){if(e instanceof Date)return"date";if(e instanceof RegExp)return"regexp"}return t}function x(e){var t=_(e);switch(t){case"array":case"object":return"an "+t;case"boolean":case"date":case"regexp":return"a "+t;default:return t}}return p.prototype=Error.prototype,h.checkPropTypes=s,h.resetWarningCache=s.resetWarningCache,h.PropTypes=h,h},DT}function WT(){if(IT)return OT.exports;IT=1;var e=BT();return OT.exports=HT()(e.isElement,true),OT.exports}var qT=f(WT()),XT={width:qT.number,height:qT.number,graphData:qT.shape({nodes:qT.arrayOf(qT.object).isRequired,links:qT.arrayOf(qT.object).isRequired}),backgroundColor:qT.string,nodeRelSize:qT.number,nodeId:qT.string,nodeLabel:qT.oneOfType([qT.string,qT.func]),nodeVal:qT.oneOfType([qT.number,qT.string,qT.func]),nodeVisibility:qT.oneOfType([qT.bool,qT.string,qT.func]),nodeColor:qT.oneOfType([qT.string,qT.func]),nodeAutoColorBy:qT.oneOfType([qT.string,qT.func]),onNodeHover:qT.func,onNodeClick:qT.func,linkSource:qT.string,linkTarget:qT.string,linkLabel:qT.oneOfType([qT.string,qT.func]),linkVisibility:qT.oneOfType([qT.bool,qT.string,qT.func]),linkColor:qT.oneOfType([qT.string,qT.func]),linkAutoColorBy:qT.oneOfType([qT.string,qT.func]),linkWidth:qT.oneOfType([qT.number,qT.string,qT.func]),linkCurvature:qT.oneOfType([qT.number,qT.string,qT.func]),linkDirectionalArrowLength:qT.oneOfType([qT.number,qT.string,qT.func]),linkDirectionalArrowColor:qT.oneOfType([qT.string,qT.func]),linkDirectionalArrowRelPos:qT.oneOfType([qT.number,qT.string,qT.func]),linkDirectionalParticles:qT.oneOfType([qT.number,qT.string,qT.func]),linkDirectionalParticleSpeed:qT.oneOfType([qT.number,qT.string,qT.func]),linkDirectionalParticleWidth:qT.oneOfType([qT.number,qT.string,qT.func]),linkDirectionalParticleColor:qT.oneOfType([qT.string,qT.func]),onLinkHover:qT.func,onLinkClick:qT.func,dagMode:qT.oneOf(["td","bu","lr","rl","zin","zout","radialin","radialout"]),dagLevelDistance:qT.number,dagNodeFilter:qT.func,onDagError:qT.func,d3AlphaMin:qT.number,d3AlphaDecay:qT.number,d3VelocityDecay:qT.number,warmupTicks:qT.number,cooldownTicks:qT.number,cooldownTime:qT.number,onEngineTick:qT.func,onEngineStop:qT.func,getGraphBbox:qT.func},$T={zoomToFit:qT.func,onNodeRightClick:qT.func,onNodeDrag:qT.func,onNodeDragEnd:qT.func,onLinkRightClick:qT.func,linkHoverPrecision:qT.number,onBackgroundClick:qT.func,onBackgroundRightClick:qT.func,enablePointerInteraction:qT.bool,enableNodeDrag:qT.bool},YT={showNavInfo:qT.bool,nodeOpacity:qT.number,nodeResolution:qT.number,nodeThreeObject:qT.oneOfType([qT.object,qT.string,qT.func]),nodeThreeObjectExtend:qT.oneOfType([qT.bool,qT.string,qT.func]),nodePositionUpdate:qT.func,linkOpacity:qT.number,linkResolution:qT.number,linkCurveRotation:qT.oneOfType([qT.number,qT.string,qT.func]),linkMaterial:qT.oneOfType([qT.object,qT.string,qT.func]),linkThreeObject:qT.oneOfType([qT.object,qT.string,qT.func]),linkThreeObjectExtend:qT.oneOfType([qT.bool,qT.string,qT.func]),linkPositionUpdate:qT.func,linkDirectionalArrowResolution:qT.number,linkDirectionalParticleResolution:qT.number,forceEngine:qT.oneOf(["d3","ngraph"]),ngraphPhysics:qT.object,numDimensions:qT.oneOf([1,2,3])},KT=Object.assign({},XT,$T,{linkLineDash:qT.oneOfType([qT.arrayOf(qT.number),qT.string,qT.func]),nodeCanvasObjectMode:qT.oneOfType([qT.string,qT.func]),nodeCanvasObject:qT.func,nodePointerAreaPaint:qT.func,linkCanvasObjectMode:qT.oneOfType([qT.string,qT.func]),linkCanvasObject:qT.func,linkPointerAreaPaint:qT.func,autoPauseRedraw:qT.bool,minZoom:qT.number,maxZoom:qT.number,enableZoomInteraction:qT.oneOfType([qT.bool,qT.func]),enablePanInteraction:qT.oneOfType([qT.bool,qT.func]),onZoom:qT.func,onZoomEnd:qT.func,onRenderFramePre:qT.func,onRenderFramePost:qT.func}),ZT=Object.assign({},XT,$T,YT,{enableNavigationControls:qT.bool,controlType:qT.oneOf(["trackball","orbit","fly"]),rendererConfig:qT.object,extraRenderers:qT.arrayOf(qT.shape({render:qT.func.isRequired}))}),JT=Object.assign({},XT,YT,{nodeDesc:qT.oneOfType([qT.string,qT.func]),linkDesc:qT.oneOfType([qT.string,qT.func])}),QT=Object.assign({},XT,YT,{markerAttrs:qT.object,yOffset:qT.number,glScale:qT.number});const eS=d(kT,{methodNames:["getGraphBbox","emitParticle","d3Force","d3ReheatSimulation","refresh"]});function tS(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function nS(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function iS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function rS(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?iS(Object(n),!0).forEach((function(t){nS(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):iS(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function sS(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,s,o,a=[],l=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t);else for(;!(l=(i=s.call(n)).done)&&(a.push(i.value),a.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return a}}(e,t)||aS(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function oS(e){return function(e){if(Array.isArray(e))return tS(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||aS(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function aS(e,t){if(e){if("string"==typeof e)return tS(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?tS(e,t):void 0}}eS.displayName="ForceGraphVR",eS.propTypes=JT;var lS=B_({props:{width:{},height:{},yOffset:{default:1.5},glScale:{default:200},jsonUrl:{},graphData:{default:{nodes:[],links:[]}},numDimensions:{default:3},dagMode:{},dagLevelDistance:{},dagNodeFilter:{default:function(){return!0}},onDagError:{default:void 0},nodeRelSize:{default:4},nodeId:{default:"id"},nodeVal:{default:"val"},nodeResolution:{default:8},nodeVisibility:{default:!0},nodeColor:{default:"color"},nodeAutoColorBy:{},nodeOpacity:{default:.75},nodeThreeObject:{},nodeThreeObjectExtend:{default:!1},linkSource:{default:"source"},linkTarget:{default:"target"},linkVisibility:{default:!0},linkColor:{default:"color"},linkAutoColorBy:{},linkOpacity:{default:.2},linkWidth:{default:0},linkResolution:{default:6},linkCurvature:{default:0},linkCurveRotation:{default:0},linkMaterial:{},linkThreeObject:{},linkThreeObjectExtend:{default:!1},linkPositionUpdate:{},linkDirectionalArrowLength:{default:0},linkDirectionalArrowColor:{},linkDirectionalArrowRelPos:{default:.5},linkDirectionalArrowResolution:{default:8},linkDirectionalParticles:{default:0},linkDirectionalParticleSpeed:{default:.01},linkDirectionalParticleWidth:{default:.5},linkDirectionalParticleColor:{},linkDirectionalParticleResolution:{default:4},onNodeHover:{},onNodeClick:{},onLinkHover:{},onLinkClick:{},forceEngine:{default:"d3"},d3AlphaMin:{default:0},d3AlphaDecay:{default:.0228},d3VelocityDecay:{default:.4},ngraphPhysics:{},warmupTicks:{default:0},cooldownTicks:{},cooldownTime:{default:15e3},onEngineTick:{},onEngineStop:{}},methods:rS(rS({},Object.assign.apply(Object,[{}].concat(oS(["getGraphBbox","emitParticle","d3Force","d3ReheatSimulation","refresh"].map((function(e){return nS({},e,(function(t){for(var n=t.forcegraph.components.forcegraph,i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];var o=n[e].apply(n,r);return o===n?this:o}))})))))),{},{_destructor:function(){this.graphData({nodes:[],links:[]})}}),init:function(e,t){var n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}).markerAttrs,i=void 0===n?{preset:"hiro"}:n;e.innerHTML="",t.container=document.createElement("div"),e.appendChild(t.container);var r=document.createElement("a-scene");r.setAttribute("embedded",""),r.setAttribute("vr-mode-ui","enabled: false"),r.setAttribute("arjs","debugUIEnabled: false;");var s,o=document.createElement("a-marker");Object.entries(i).forEach((function(e){var t=sS(e,2),n=t[0],i=t[1];return o.setAttribute(n,i)})),r.appendChild(o),r.appendChild(s=document.createElement("a-entity")),s.setAttribute("cursor"),s.setAttribute("raycaster","objects: [forcegraph]"),t.forcegraph=document.createElement("a-entity"),t.forcegraph.setAttribute("forcegraph",null),o.appendChild(t.forcegraph);var a=document.createElement("a-entity");a.setAttribute("camera",""),r.appendChild(a),t.container.appendChild(r)},update:function(e,t){t.hasOwnProperty("width")&&e.width&&(e.container.style.width="".concat(e.width,"px")),t.hasOwnProperty("height")&&e.height&&(e.container.style.height="".concat(e.height,"px")),t.hasOwnProperty("glScale")&&e.forcegraph.setAttribute("scale",oS(new Array(3)).map((function(){return 1/e.glScale})).join(" ")),t.hasOwnProperty("yOffset")&&e.forcegraph.setAttribute("position","0 ".concat(e.yOffset," 0"));var n=["jsonUrl","numDimensions","dagMode","dagLevelDistance","dagNodeFilter","onDagError","nodeRelSize","nodeId","nodeVal","nodeResolution","nodeVisibility","nodeColor","nodeAutoColorBy","nodeOpacity","nodeThreeObject","nodeThreeObjectExtend","linkSource","linkTarget","linkVisibility","linkColor","linkAutoColorBy","linkOpacity","linkWidth","linkResolution","linkCurvature","linkCurveRotation","linkMaterial","linkThreeObject","linkThreeObjectExtend","linkPositionUpdate","linkDirectionalArrowLength","linkDirectionalArrowColor","linkDirectionalArrowRelPos","linkDirectionalArrowResolution","linkDirectionalParticles","linkDirectionalParticleSpeed","linkDirectionalParticleWidth","linkDirectionalParticleColor","linkDirectionalParticleResolution","onNodeHover","onNodeClick","onLinkHover","onLinkClick","forceEngine","d3AlphaMin","d3AlphaDecay","d3VelocityDecay","ngraphPhysics","warmupTicks","cooldownTicks","cooldownTime","onEngineTick","onEngineStop"],i=Object.assign.apply(Object,[{}].concat(oS(Object.entries(e).filter((function(e){var i=sS(e,2),r=i[0],s=i[1];return t.hasOwnProperty(r)&&-1!==n.indexOf(r)&&null!=s})).map((function(e){var t=sS(e,2);return nS({},t[0],t[1])}))),oS(Object.entries(e.graphData).map((function(e){var t=sS(e,2);return nS({},t[0],t[1])})))));e.forcegraph.setAttribute("forcegraph",i)}});const cS=d(lS,{methodNames:["getGraphBbox","emitParticle","d3Force","d3ReheatSimulation","refresh"],initPropNames:["markerAttrs"]});cS.displayName="ForceGraphAR",cS.propTypes=QT;const uS=new Fd,hS=new Nc,dS=new Dc,pS=new Nc,fS=new Nc,mS=new Dc,gS=new Dc,yS=new Iu,vS=new Dc,_S=new Dc;let xS=null,bS=null;const wS=[],TS=-1,SS=0,MS=1;class ES extends mf{constructor(e,t,n=null){super(t,n),this.objects=e,this.recursive=!0,this.transformGroup=!1,this.rotateSpeed=1,this.raycaster=new uf,this.mouseButtons={LEFT:sa,MIDDLE:sa,RIGHT:ia},this.touches={ONE:aa},this._onPointerMove=AS.bind(this),this._onPointerDown=CS.bind(this),this._onPointerCancel=RS.bind(this),this._onContextMenu=NS.bind(this),null!==n&&this.connect(n)}connect(e){super.connect(e),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointerup",this._onPointerCancel),this.domElement.addEventListener("pointerleave",this._onPointerCancel),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointerup",this._onPointerCancel),this.domElement.removeEventListener("pointerleave",this._onPointerCancel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="auto",this.domElement.style.cursor=""}dispose(){this.disconnect()}_updatePointer(e){const t=this.domElement.getBoundingClientRect();hS.x=(e.clientX-t.left)/t.width*2-1,hS.y=-(e.clientY-t.top)/t.height*2+1}_updateState(e){let t;if("touch"===e.pointerType)t=this.touches.ONE;else switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=null}switch(t){case sa:case aa:this.state=SS;break;case ia:case oa:this.state=MS;break;default:this.state=TS}}getRaycaster(){return console.warn("THREE.DragControls: getRaycaster() has been deprecated. Use controls.raycaster instead."),this.raycaster}setObjects(e){console.warn("THREE.DragControls: setObjects() has been deprecated. Use controls.objects instead."),this.objects=e}getObjects(){return console.warn("THREE.DragControls: getObjects() has been deprecated. Use controls.objects instead."),this.objects}activate(){console.warn("THREE.DragControls: activate() has been renamed to connect()."),this.connect()}deactivate(){console.warn("THREE.DragControls: deactivate() has been renamed to disconnect()."),this.disconnect()}set mode(e){console.warn("THREE.DragControls: The .mode property has been removed. Define the type of transformation via the .mouseButtons or .touches properties.")}get mode(){console.warn("THREE.DragControls: The .mode property has been removed. Define the type of transformation via the .mouseButtons or .touches properties.")}}function AS(e){const t=this.object,n=this.domElement,i=this.raycaster;if(!1!==this.enabled){if(this._updatePointer(e),i.setFromCamera(hS,t),xS)this.state===SS?i.ray.intersectPlane(uS,mS)&&xS.position.copy(mS.sub(dS).applyMatrix4(yS)):this.state===MS&&(pS.subVectors(hS,fS).multiplyScalar(this.rotateSpeed),xS.rotateOnWorldAxis(vS,pS.x),xS.rotateOnWorldAxis(_S.normalize(),-pS.y)),this.dispatchEvent({type:"drag",object:xS}),fS.copy(hS);else if("mouse"===e.pointerType||"pen"===e.pointerType)if(wS.length=0,i.setFromCamera(hS,t),i.intersectObjects(this.objects,this.recursive,wS),wS.length>0){const e=wS[0].object;uS.setFromNormalAndCoplanarPoint(t.getWorldDirection(uS.normal),gS.setFromMatrixPosition(e.matrixWorld)),bS!==e&&null!==bS&&(this.dispatchEvent({type:"hoveroff",object:bS}),n.style.cursor="auto",bS=null),bS!==e&&(this.dispatchEvent({type:"hoveron",object:e}),n.style.cursor="pointer",bS=e)}else null!==bS&&(this.dispatchEvent({type:"hoveroff",object:bS}),n.style.cursor="auto",bS=null);fS.copy(hS)}}function CS(e){const t=this.object,n=this.domElement,i=this.raycaster;!1!==this.enabled&&(this._updatePointer(e),this._updateState(e),wS.length=0,i.setFromCamera(hS,t),i.intersectObjects(this.objects,this.recursive,wS),wS.length>0&&(xS=!0===this.transformGroup?PS(wS[0].object):wS[0].object,uS.setFromNormalAndCoplanarPoint(t.getWorldDirection(uS.normal),gS.setFromMatrixPosition(xS.matrixWorld)),i.ray.intersectPlane(uS,mS)&&(this.state===SS?(yS.copy(xS.parent.matrixWorld).invert(),dS.copy(mS).sub(gS.setFromMatrixPosition(xS.matrixWorld))):this.state===MS&&(vS.set(0,1,0).applyQuaternion(t.quaternion).normalize(),_S.set(1,0,0).applyQuaternion(t.quaternion).normalize())),n.style.cursor="move",this.dispatchEvent({type:"dragstart",object:xS})),fS.copy(hS))}function RS(){!1!==this.enabled&&(xS&&(this.dispatchEvent({type:"dragend",object:xS}),xS=null),this.domElement.style.cursor=bS?"pointer":"auto",this.state=TS)}function NS(e){!1!==this.enabled&&e.preventDefault()}function PS(e,t=null){return e.isGroup&&(t=e),null===e.parent?t:PS(e.parent,t)}const DS=["alphaMap","alphaTest","anisotropy","anisotropyMap","anisotropyRotation","aoMap","aoMapIntensity","attenuationColor","attenuationDistance","bumpMap","clearcoat","clearcoatMap","clearcoatNormalMap","clearcoatNormalScale","clearcoatRoughness","color","dispersion","displacementMap","emissive","emissiveIntensity","emissiveMap","envMap","envMapIntensity","gradientMap","ior","iridescence","iridescenceIOR","iridescenceMap","iridescenceThicknessMap","lightMap","lightMapIntensity","map","matcap","metalness","metalnessMap","normalMap","normalScale","opacity","roughness","roughnessMap","sheen","sheenColor","sheenColorMap","sheenRoughnessMap","shininess","specular","specularColor","specularColorMap","specularIntensity","specularIntensityMap","specularMap","thickness","transmission","transmissionMap"];class LS{constructor(e){this.renderObjects=new WeakMap,this.hasNode=this.containsNode(e),this.hasAnimation=!0===e.object.isSkinnedMesh,this.refreshUniforms=DS,this.renderId=0}firstInitialization(e){return!1===this.renderObjects.has(e)&&(this.getRenderObjectData(e),!0)}needsVelocity(e){const t=e.getMRT();return null!==t&&t.has("velocity")}getRenderObjectData(e){let t=this.renderObjects.get(e);if(void 0===t){const{geometry:n,material:i,object:r}=e;if(t={material:this.getMaterialData(i),geometry:{id:n.id,attributes:this.getAttributesData(n.attributes),indexVersion:n.index?n.index.version:null,drawRange:{start:n.drawRange.start,count:n.drawRange.count}},worldMatrix:r.matrixWorld.clone()},r.center&&(t.center=r.center.clone()),r.morphTargetInfluences&&(t.morphTargetInfluences=r.morphTargetInfluences.slice()),null!==e.bundle&&(t.version=e.bundle.version),t.material.transmission>0){const{width:n,height:i}=e.context;t.bufferWidth=n,t.bufferHeight=i}this.renderObjects.set(e,t)}return t}getAttributesData(e){const t={};for(const n in e){const i=e[n];t[n]={version:i.version}}return t}containsNode(e){const t=e.material;for(const e in t)if(t[e]&&t[e].isNode)return!0;return null!==e.renderer.overrideNodes.modelViewMatrix||null!==e.renderer.overrideNodes.modelNormalViewMatrix}getMaterialData(e){const t={};for(const n of this.refreshUniforms){const i=e[n];null!=i&&("object"==typeof i&&void 0!==i.clone?!0===i.isTexture?t[n]={id:i.id,version:i.version}:t[n]=i.clone():t[n]=i)}return t}equals(e){const{object:t,material:n,geometry:i}=e,r=this.getRenderObjectData(e);if(!0!==r.worldMatrix.equals(t.matrixWorld))return r.worldMatrix.copy(t.matrixWorld),!1;const s=r.material;for(const e in s){const t=s[e],i=n[e];if(void 0!==t.equals){if(!1===t.equals(i))return t.copy(i),!1}else if(!0===i.isTexture){if(t.id!==i.id||t.version!==i.version)return t.id=i.id,t.version=i.version,!1}else if(t!==i)return s[e]=i,!1}if(s.transmission>0){const{width:t,height:n}=e.context;if(r.bufferWidth!==t||r.bufferHeight!==n)return r.bufferWidth=t,r.bufferHeight=n,!1}const o=r.geometry,a=i.attributes,l=o.attributes,c=Object.keys(l),u=Object.keys(a);if(o.id!==i.id)return o.id=i.id,!1;if(c.length!==u.length)return r.geometry.attributes=this.getAttributesData(a),!1;for(const e of c){const t=l[e],n=a[e];if(void 0===n)return delete l[e],!1;if(t.version!==n.version)return t.version=n.version,!1}const h=i.index,d=o.indexVersion,p=h?h.version:null;if(d!==p)return o.indexVersion=p,!1;if(o.drawRange.start!==i.drawRange.start||o.drawRange.count!==i.drawRange.count)return o.drawRange.start=i.drawRange.start,o.drawRange.count=i.drawRange.count,!1;if(r.morphTargetInfluences){let e=!1;for(let n=0;n<r.morphTargetInfluences.length;n++)r.morphTargetInfluences[n]!==t.morphTargetInfluences[n]&&(e=!0);if(e)return!0}return r.center&&!1===r.center.equals(t.center)?(r.center.copy(t.center),!0):(null!==e.bundle&&(r.version=e.bundle.version),!0)}needsRefresh(e,t){if(this.hasNode||this.hasAnimation||this.firstInitialization(e)||this.needsVelocity(t.renderer))return!0;const{renderId:n}=t;if(this.renderId!==n)return this.renderId=n,!0;const i=!0===e.object.static,r=null!==e.bundle&&!0===e.bundle.static&&this.getRenderObjectData(e).version===e.bundle.version;if(i||r)return!1;return!0!==this.equals(e)}}function IS(e,t=0){let n=3735928559^t,i=1103547991^t;if(e instanceof Array)for(let t,r=0;r<e.length;r++)t=e[r],n=Math.imul(n^t,2654435761),i=Math.imul(i^t,1597334677);else for(let t,r=0;r<e.length;r++)t=e.charCodeAt(r),n=Math.imul(n^t,2654435761),i=Math.imul(i^t,1597334677);return n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(n^n>>>13,3266489909),4294967296*(2097151&i)+(n>>>0)}const kS=e=>IS(e),OS=(...e)=>IS(e);function US(e,t=!1){const n=[];!0===e.isNode&&(n.push(e.id),e=e.getSelf());for(const{property:i,childNode:r}of FS(e))n.push(IS(i.slice(0,-4)),r.getCacheKey(t));return IS(n)}function*FS(e,t=!1){for(const n in e){if(!0===n.startsWith("_"))continue;const i=e[n];if(!0===Array.isArray(i))for(let e=0;e<i.length;e++){const r=i[e];r&&(!0===r.isNode||t&&"function"==typeof r.toJSON)&&(yield{property:n,index:e,childNode:r})}else if(i&&!0===i.isNode)yield{property:n,childNode:i};else if("object"==typeof i)for(const e in i){const r=i[e];r&&(!0===r.isNode||t&&"function"==typeof r.toJSON)&&(yield{property:n,index:e,childNode:r})}}}const BS=new Map([[1,"float"],[2,"vec2"],[3,"vec3"],[4,"vec4"],[9,"mat3"],[16,"mat4"]]),zS=new WeakMap;function VS(e){if(null==e)return null;const t=typeof e;return!0===e.isNode?"node":"number"===t?"float":"boolean"===t?"bool":"string"===t?"string":"function"===t?"shader":!0===e.isVector2?"vec2":!0===e.isVector3?"vec3":!0===e.isVector4?"vec4":!0===e.isMatrix2?"mat2":!0===e.isMatrix3?"mat3":!0===e.isMatrix4?"mat4":!0===e.isColor?"color":e instanceof ArrayBuffer?"ArrayBuffer":null}function GS(e,...t){const n=e?e.slice(-4):void 0;return 1===t.length&&("vec2"===n?t=[t[0],t[0]]:"vec3"===n?t=[t[0],t[0],t[0]]:"vec4"===n&&(t=[t[0],t[0],t[0],t[0]])),"color"===e?new Eh(...t):"vec2"===n?new Nc(...t):"vec3"===n?new Dc(...t):"vec4"===n?new nu(...t):"mat2"===n?new ff(...t):"mat3"===n?new kc(...t):"mat4"===n?new Iu(...t):"bool"===e?t[0]||!1:"float"===e||"int"===e||"uint"===e?t[0]||0:"string"===e?t[0]||"":"ArrayBuffer"===e?(i=t[0],Uint8Array.from(atob(i),(e=>e.charCodeAt(0))).buffer):null;var i}function jS(e){let t=zS.get(e);return void 0===t&&(t={},zS.set(e,t)),t}const HS="vertex",WS="none",qS="frame",XS="render",$S="object",YS="readOnly",KS="writeOnly",ZS="readWrite",JS=["setup","analyze","generate"],QS=["fragment","vertex","compute"],eM=["x","y","z","w"],tM={analyze:"setup",generate:"analyze"};let nM=0,iM=class extends vc{static get type(){return"Node"}constructor(e=null){super(),this.nodeType=e,this.updateType=WS,this.updateBeforeType=WS,this.updateAfterType=WS,this.uuid=Rc.generateUUID(),this.version=0,this.global=!1,this.parents=!1,this.isNode=!0,this._cacheKey=null,this._cacheKeyVersion=0,Object.defineProperty(this,"id",{value:nM++})}set needsUpdate(e){!0===e&&this.version++}get type(){return this.constructor.type}onUpdate(e,t){return this.updateType=t,this.update=e.bind(this.getSelf()),this}onFrameUpdate(e){return this.onUpdate(e,qS)}onRenderUpdate(e){return this.onUpdate(e,XS)}onObjectUpdate(e){return this.onUpdate(e,$S)}onReference(e){return this.updateReference=e.bind(this.getSelf()),this}getSelf(){return this.self||this}updateReference(){return this}isGlobal(){return this.global}*getChildren(){for(const{childNode:e}of FS(this))yield e}dispose(){this.dispatchEvent({type:"dispose"})}traverse(e){e(this);for(const t of this.getChildren())t.traverse(e)}getCacheKey(e=!1){return!0!==(e=e||this.version!==this._cacheKeyVersion)&&null!==this._cacheKey||(this._cacheKey=OS(US(this,e),this.customCacheKey()),this._cacheKeyVersion=this.version),this._cacheKey}customCacheKey(){return 0}getScope(){return this}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getUpdateAfterType(){return this.updateAfterType}getElementType(e){const t=this.getNodeType(e);return e.getElementType(t)}getMemberType(){return"void"}getNodeType(e){const t=e.getNodeProperties(this);return t.outputNode?t.outputNode.getNodeType(e):this.nodeType}getShared(e){const t=this.getHash(e);return e.getNodeFromHash(t)||this}setup(e){const t=e.getNodeProperties(this);let n=0;for(const e of this.getChildren())t["node"+n++]=e;return t.outputNode||null}analyze(e,t=null){const n=e.increaseUsage(this);if(!0===this.parents){const n=e.getDataFromNode(this,"any");n.stages=n.stages||{},n.stages[e.shaderStage]=n.stages[e.shaderStage]||[],n.stages[e.shaderStage].push(t)}if(1===n){const t=e.getNodeProperties(this);for(const n of Object.values(t))n&&!0===n.isNode&&n.build(e,this)}}generate(e,t){const{outputNode:n}=e.getNodeProperties(this);if(n&&!0===n.isNode)return n.build(e,t)}updateBefore(){console.warn("Abstract function.")}updateAfter(){console.warn("Abstract function.")}update(){console.warn("Abstract function.")}build(e,t=null){const n=this.getShared(e);if(this!==n)return n.build(e,t);const i=e.getDataFromNode(this);i.buildStages=i.buildStages||{},i.buildStages[e.buildStage]=!0;const r=tM[e.buildStage];if(r&&!0!==i.buildStages[r]){const t=e.getBuildStage();e.setBuildStage(r),this.build(e),e.setBuildStage(t)}e.addNode(this),e.addChain(this);let s=null;const o=e.getBuildStage();if("setup"===o){this.updateReference(e);const t=e.getNodeProperties(this);if(!0!==t.initialized){t.initialized=!0,t.outputNode=this.setup(e)||t.outputNode||null;for(const n of Object.values(t))if(n&&!0===n.isNode){if(!0===n.parents){const t=e.getNodeProperties(n);t.parents=t.parents||[],t.parents.push(this)}n.build(e)}}s=t.outputNode}else if("analyze"===o)this.analyze(e,t);else if("generate"===o){if(1===this.generate.length){const n=this.getNodeType(e),i=e.getDataFromNode(this);s=i.snippet,void 0===s?void 0===i.generated?(i.generated=!0,s=this.generate(e)||"",i.snippet=s):(console.warn("THREE.Node: Recursion detected.",this),s=""):void 0!==i.flowCodes&&void 0!==e.context.nodeBlock&&e.addFlowCodeHierarchy(this,e.context.nodeBlock),s=e.format(s,n,t)}else s=this.generate(e,t)||""}return e.removeChain(this),e.addSequentialNode(this),s}getSerializeChildren(){return FS(this)}serialize(e){const t=this.getSerializeChildren(),n={};for(const{property:i,index:r,childNode:s}of t)void 0!==r?(void 0===n[i]&&(n[i]=Number.isInteger(r)?[]:{}),n[i][r]=s.toJSON(e.meta).uuid):n[i]=s.toJSON(e.meta).uuid;Object.keys(n).length>0&&(e.inputNodes=n)}deserialize(e){if(void 0!==e.inputNodes){const t=e.meta.nodes;for(const n in e.inputNodes)if(Array.isArray(e.inputNodes[n])){const i=[];for(const r of e.inputNodes[n])i.push(t[r]);this[n]=i}else if("object"==typeof e.inputNodes[n]){const i={};for(const r in e.inputNodes[n]){const s=e.inputNodes[n][r];i[r]=t[s]}this[n]=i}else{const i=e.inputNodes[n];this[n]=t[i]}}}toJSON(e){const{uuid:t,type:n}=this,i=void 0===e||"string"==typeof e;i&&(e={textures:{},images:{},nodes:{}});let r=e.nodes[t];function s(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}if(void 0===r&&(r={uuid:t,type:n,meta:e,metadata:{version:4.7,type:"Node",generator:"Node.toJSON"}},!0!==i&&(e.nodes[r.uuid]=r),this.serialize(r),delete r.meta),i){const t=s(e.textures),n=s(e.images),i=s(e.nodes);t.length>0&&(r.textures=t),n.length>0&&(r.images=n),i.length>0&&(r.nodes=i)}return r}};class rM extends iM{static get type(){return"ArrayElementNode"}constructor(e,t){super(),this.node=e,this.indexNode=t,this.isArrayElementNode=!0}getNodeType(e){return this.node.getElementType(e)}generate(e){const t=this.indexNode.getNodeType(e);return`${this.node.build(e)}[ ${this.indexNode.build(e,!e.isVector(t)&&e.isInteger(t)?t:"uint")} ]`}}class sM extends iM{static get type(){return"ConvertNode"}constructor(e,t){super(),this.node=e,this.convertTo=t}getNodeType(e){const t=this.node.getNodeType(e);let n=null;for(const i of this.convertTo.split("|"))null!==n&&e.getTypeLength(t)!==e.getTypeLength(i)||(n=i);return n}serialize(e){super.serialize(e),e.convertTo=this.convertTo}deserialize(e){super.deserialize(e),this.convertTo=e.convertTo}generate(e,t){const n=this.node,i=this.getNodeType(e),r=n.build(e,i);return e.format(r,i,t)}}class oM extends iM{static get type(){return"TempNode"}constructor(e=null){super(e),this.isTempNode=!0}hasDependencies(e){return e.getDataFromNode(this).usageCount>1}build(e,t){if("generate"===e.getBuildStage()){const n=e.getVectorType(this.getNodeType(e,t)),i=e.getDataFromNode(this);if(void 0!==i.propertyName)return e.format(i.propertyName,n,t);if("void"!==n&&"void"!==t&&this.hasDependencies(e)){const r=super.build(e,n),s=e.getVarFromNode(this,null,n),o=e.getPropertyName(s);return e.addLineFlowCode(`${o} = ${r}`,this),i.snippet=r,i.propertyName=o,e.format(i.propertyName,n,t)}}return super.build(e,t)}}class aM extends oM{static get type(){return"JoinNode"}constructor(e=[],t=null){super(t),this.nodes=e}getNodeType(e){return null!==this.nodeType?e.getVectorType(this.nodeType):e.getTypeFromLength(this.nodes.reduce(((t,n)=>t+e.getTypeLength(n.getNodeType(e))),0))}generate(e,t){const n=this.getNodeType(e),i=e.getTypeLength(n),r=this.nodes,s=e.getComponentType(n),o=[];let a=0;for(const t of r){if(a>=i){console.error(`THREE.TSL: Length of parameters exceeds maximum length of function '${n}()' type.`);break}let r,l=t.getNodeType(e),c=e.getTypeLength(l);a+c>i&&(console.error(`THREE.TSL: Length of '${n}()' data exceeds maximum length of output type.`),c=i-a,l=e.getTypeFromLength(c)),a+=c,r=t.build(e,l);const u=e.getComponentType(l);u!==s&&(r=e.format(r,u,s)),o.push(r)}const l=`${e.getType(n)}( ${o.join(", ")} )`;return e.format(l,n,t)}}const lM=eM.join("");class cM extends iM{static get type(){return"SplitNode"}constructor(e,t="x"){super(),this.node=e,this.components=t,this.isSplitNode=!0}getVectorLength(){let e=this.components.length;for(const t of this.components)e=Math.max(eM.indexOf(t)+1,e);return e}getComponentType(e){return e.getComponentType(this.node.getNodeType(e))}getNodeType(e){return e.getTypeFromLength(this.components.length,this.getComponentType(e))}generate(e,t){const n=this.node,i=e.getTypeLength(n.getNodeType(e));let r=null;if(i>1){let s=null;this.getVectorLength()>=i&&(s=e.getTypeFromLength(this.getVectorLength(),this.getComponentType(e)));const o=n.build(e,s);r=this.components.length===i&&this.components===lM.slice(0,this.components.length)?e.format(o,s,t):e.format(`${o}.${this.components}`,this.getNodeType(e),t)}else r=n.build(e,t);return r}serialize(e){super.serialize(e),e.components=this.components}deserialize(e){super.deserialize(e),this.components=e.components}}class uM extends oM{static get type(){return"SetNode"}constructor(e,t,n){super(),this.sourceNode=e,this.components=t,this.targetNode=n}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{sourceNode:t,components:n,targetNode:i}=this,r=this.getNodeType(e),s=e.getComponentType(i.getNodeType(e)),o=e.getTypeFromLength(n.length,s),a=i.build(e,o),l=t.build(e,r),c=e.getTypeLength(r),u=[];for(let e=0;e<c;e++){const t=eM[e];t===n[0]?(u.push(a),e+=n.length-1):u.push(l+"."+t)}return`${e.getType(r)}( ${u.join(", ")} )`}}class hM extends oM{static get type(){return"FlipNode"}constructor(e,t){super(),this.sourceNode=e,this.components=t}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{components:t,sourceNode:n}=this,i=this.getNodeType(e),r=n.build(e),s=e.getVarFromNode(this),o=e.getPropertyName(s);e.addLineFlowCode(o+" = "+r,this);const a=e.getTypeLength(i),l=[];let c=0;for(let e=0;e<a;e++){const n=eM[e];n===t[c]?(l.push("1.0 - "+o+"."+n),c++):l.push(o+"."+n)}return`${e.getType(i)}( ${l.join(", ")} )`}}class dM extends iM{static get type(){return"InputNode"}constructor(e,t=null){super(t),this.isInputNode=!0,this.value=e,this.precision=null}getNodeType(){return null===this.nodeType?VS(this.value):this.nodeType}getInputType(e){return this.getNodeType(e)}setPrecision(e){return this.precision=e,this}serialize(e){super.serialize(e),e.value=this.value,this.value&&this.value.toArray&&(e.value=this.value.toArray()),e.valueType=VS(this.value),e.nodeType=this.nodeType,"ArrayBuffer"===e.valueType&&(e.value=function(e){let t="";const n=new Uint8Array(e);for(let e=0;e<n.length;e++)t+=String.fromCharCode(n[e]);return btoa(t)}(e.value)),e.precision=this.precision}deserialize(e){super.deserialize(e),this.nodeType=e.nodeType,this.value=Array.isArray(e.value)?GS(e.valueType,...e.value):e.value,this.precision=e.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(e.value))}generate(){console.warn("Abstract function.")}}const pM=/float|u?int/;class fM extends dM{static get type(){return"ConstNode"}constructor(e,t=null){super(e,t),this.isConstNode=!0}generateConst(e){return e.generateConst(this.getNodeType(e),this.value)}generate(e,t){const n=this.getNodeType(e);return pM.test(n)&&pM.test(t)?e.generateConst(t,this.value):e.format(this.generateConst(e),n,t)}}class mM extends iM{static get type(){return"MemberNode"}constructor(e,t){super(),this.node=e,this.property=t,this.isMemberNode=!0}getNodeType(e){return this.node.getMemberType(e,this.property)}generate(e){return this.node.build(e)+"."+this.property}}let gM=null;const yM=new Map;function vM(e,t){if(yM.has(e))console.warn(`THREE.TSL: Redefinition of method chaining '${e}'.`);else{if("function"!=typeof t)throw new Error(`THREE.TSL: Node element ${e} is not a function`);yM.set(e,t)}}const _M=e=>e.replace(/r|s/g,"x").replace(/g|t/g,"y").replace(/b|p/g,"z").replace(/a|q/g,"w"),xM=e=>_M(e).split("").sort().join(""),bM={setup(e,t){const n=t.shift();return e(WM(n),...t)},get(e,t,n){if("string"==typeof t&&void 0===e[t]){if(!0!==e.isStackNode&&"assign"===t)return(...e)=>(gM.assign(n,...e),n);if(yM.has(t)){const i=yM.get(t);return e.isStackNode?(...e)=>n.add(i(...e)):(...e)=>i(n,...e)}if("self"===t)return e;if(t.endsWith("Assign")&&yM.has(t.slice(0,t.length-6))){const i=yM.get(t.slice(0,t.length-6));return e.isStackNode?(...e)=>n.assign(e[0],i(...e)):(...e)=>n.assign(i(n,...e))}if(!0===/^[xyzwrgbastpq]{1,4}$/.test(t))return t=_M(t),HM(new cM(n,t));if(!0===/^set[XYZWRGBASTPQ]{1,4}$/.test(t))return t=xM(t.slice(3).toLowerCase()),n=>HM(new uM(e,t,HM(n)));if(!0===/^flip[XYZWRGBASTPQ]{1,4}$/.test(t))return t=xM(t.slice(4).toLowerCase()),()=>HM(new hM(HM(e),t));if("width"===t||"height"===t||"depth"===t)return"width"===t?t="x":"height"===t?t="y":"depth"===t&&(t="z"),HM(new cM(e,t));if(!0===/^\d+$/.test(t))return HM(new rM(n,new fM(Number(t),"uint")));if(!0===/^get$/.test(t))return e=>HM(new mM(n,e))}return Reflect.get(e,t,n)},set:(e,t,n,i)=>"string"!=typeof t||void 0!==e[t]||!0!==/^[xyzwrgbastpq]{1,4}$/.test(t)&&"width"!==t&&"height"!==t&&"depth"!==t&&!0!==/^\d+$/.test(t)?Reflect.set(e,t,n,i):(i[t].assign(n),!0)},wM=new WeakMap,TM=new WeakMap,SM=function(e,t=null){for(const n in e)e[n]=HM(e[n],t);return e},MM=function(e,t=null){const n=e.length;for(let i=0;i<n;i++)e[i]=HM(e[i],t);return e},EM=function(e,t=null,n=null,i=null){const r=e=>HM(null!==i?Object.assign(e,i):e);let s,o,a,l=t;function c(t){let n;return n=l?/[a-z]/i.test(l)?l+"()":l:e.type,void 0!==o&&t.length<o?(console.error(`THREE.TSL: "${n}" parameter length is less than minimum required.`),t.concat(new Array(o-t.length).fill(0))):void 0!==a&&t.length>a?(console.error(`THREE.TSL: "${n}" parameter length exceeds limit.`),t.slice(0,a)):t}return null===t?s=(...t)=>r(new e(...qM(c(t)))):null!==n?(n=HM(n),s=(...i)=>r(new e(t,...qM(c(i)),n))):s=(...n)=>r(new e(t,...qM(c(n)))),s.setParameterLength=(...e)=>(1===e.length?o=a=e[0]:2===e.length&&([o,a]=e),s),s.setName=e=>(l=e,s),s},AM=function(e,...t){return HM(new e(...qM(t)))};class CM extends iM{constructor(e,t){super(),this.shaderNode=e,this.inputNodes=t,this.isShaderCallNodeInternal=!0}getNodeType(e){return this.shaderNode.nodeType||this.getOutputNode(e).getNodeType(e)}getMemberType(e,t){return this.getOutputNode(e).getMemberType(e,t)}call(e){const{shaderNode:t,inputNodes:n}=this,i=e.getNodeProperties(t),r=t.namespace&&t.namespace===e.namespace?e.getNamespace("once"):"once";if(i[r])return i[r];let s=null;if(t.layout){let i=TM.get(e.constructor);void 0===i&&(i=new WeakMap,TM.set(e.constructor,i));let r=i.get(t);void 0===r&&(r=HM(e.buildFunctionNode(t)),i.set(t,r)),e.addInclude(r),s=HM(r.call(n))}else{const i=t.jsFunc,r=null!==n||i.length>1?i(n||[],e):i(e);s=HM(r)}return t.once&&(i[r]=s),s}setupOutput(e){return e.addStack(),e.stack.outputNode=this.call(e),e.removeStack()}getOutputNode(e){const t=e.getNodeProperties(this),n=e.getOutputNamespace();return t[n]=t[n]||this.setupOutput(e),t[n]}build(e,t=null){let n=null;const i=e.getBuildStage(),r=e.getNodeProperties(this),s=e.getOutputNamespace(),o=this.getOutputNode(e);if("setup"===i){const t=e.getNamespace("initialized");!0!==r[t]&&(r[t]=!0,r[s]=this.getOutputNode(e),r[s].build(e)),n=r[s]}else"analyze"===i?o.build(e,t):"generate"===i&&(n=o.build(e,t)||"");return n}}class RM extends iM{constructor(e,t){super(t),this.jsFunc=e,this.layout=null,this.global=!0,this.once=!1,this.namespace=null}setLayout(e){return this.layout=e,this}call(e=null){return WM(e),HM(new CM(this,e))}setup(){return this.call()}}const NM=[!1,!0],PM=[0,1,2,3],DM=[-1,-2],LM=[.5,1.5,1/3,1e-6,1e6,Math.PI,2*Math.PI,1/Math.PI,2/Math.PI,1/(2*Math.PI),Math.PI/2],IM=new Map;for(const e of NM)IM.set(e,new fM(e));const kM=new Map;for(const e of PM)kM.set(e,new fM(e,"uint"));const OM=new Map([...kM].map((e=>new fM(e.value,"int"))));for(const e of DM)OM.set(e,new fM(e,"int"));const UM=new Map([...OM].map((e=>new fM(e.value))));for(const e of LM)UM.set(e,new fM(e));for(const e of LM)UM.set(-e,new fM(-e));const FM={bool:IM,uint:kM,ints:OM,float:UM},BM=new Map([...IM,...UM]),zM=(e,t)=>BM.has(e)?BM.get(e):!0===e.isNode?e:new fM(e,t),VM=function(e,t=null){return(...n)=>{if((0===n.length||!["bool","float","int","uint"].includes(e)&&n.every((e=>"object"!=typeof e)))&&(n=[GS(e,...n)]),1===n.length&&null!==t&&t.has(n[0]))return HM(t.get(n[0]));if(1===n.length){const t=zM(n[0],e);return(e=>{try{return e.getNodeType()}catch(e){return}})(t)===e?HM(t):HM(new sM(t,e))}const i=n.map((e=>zM(e)));return HM(new aM(i,e))}},GM=e=>"object"==typeof e&&null!==e?e.value:e;function jM(e,t){return new Proxy(new RM(e,t),bM)}const HM=(e,t=null)=>function(e,t=null){const n=VS(e);if("node"===n){let t=wM.get(e);return void 0===t&&(t=new Proxy(e,bM),wM.set(e,t),wM.set(t,t)),t}return null===t&&("float"===n||"boolean"===n)||n&&"shader"!==n&&"string"!==n?HM(zM(e,t)):"shader"===n?KM(e):e}(e,t),WM=(e,t=null)=>new SM(e,t),qM=(e,t=null)=>new MM(e,t),XM=(...e)=>new EM(...e),$M=(...e)=>new AM(...e);let YM=0;const KM=(e,t=null)=>{let n=null;null!==t&&("object"==typeof t?n=t.return:("string"==typeof t?n=t:console.error("THREE.TSL: Invalid layout type."),t=null));const i=new jM(e,n),r=(...e)=>{let t;WM(e);t=e[0]&&(e[0].isNode||Object.getPrototypeOf(e[0])!==Object.prototype)?[...e]:e[0];const r=i.call(t);return"void"===n&&r.toStack(),r};if(r.shaderNode=i,r.id=i.id,r.getNodeType=(...e)=>i.getNodeType(...e),r.getCacheKey=(...e)=>i.getCacheKey(...e),r.setLayout=e=>(i.setLayout(e),r),r.once=(e=null)=>(i.once=!0,i.namespace=e,r),null!==t){if("object"!=typeof t.inputs){const e={name:"fn"+YM++,type:n,inputs:[]};for(const n in t)"return"!==n&&e.inputs.push({name:n,type:t[n]});t=e}r.setLayout(t)}return r},ZM=e=>{gM=e},JM=()=>gM,QM=(...e)=>gM.If(...e);function eE(e){return gM&&gM.add(e),e}vM("toStack",eE);const tE=new VM("color"),nE=new VM("float",FM.float),iE=new VM("int",FM.ints),rE=new VM("uint",FM.uint),sE=new VM("bool",FM.bool),oE=new VM("vec2"),aE=new VM("ivec2"),lE=new VM("uvec2"),cE=new VM("bvec2"),uE=new VM("vec3"),hE=new VM("ivec3"),dE=new VM("uvec3"),pE=new VM("bvec3"),fE=new VM("vec4"),mE=new VM("ivec4"),gE=new VM("uvec4"),yE=new VM("bvec4"),vE=new VM("mat2"),_E=new VM("mat3"),xE=new VM("mat4");vM("toColor",tE),vM("toFloat",nE),vM("toInt",iE),vM("toUint",rE),vM("toBool",sE),vM("toVec2",oE),vM("toIVec2",aE),vM("toUVec2",lE),vM("toBVec2",cE),vM("toVec3",uE),vM("toIVec3",hE),vM("toUVec3",dE),vM("toBVec3",pE),vM("toVec4",fE),vM("toIVec4",mE),vM("toUVec4",gE),vM("toBVec4",yE),vM("toMat2",vE),vM("toMat3",_E),vM("toMat4",xE);vM("element",XM(rM).setParameterLength(2)),vM("convert",((e,t)=>HM(new sM(HM(e),t)))),vM("append",(e=>(console.warn("THREE.TSL: .append() has been renamed to .toStack()."),eE(e))));class bE extends iM{static get type(){return"PropertyNode"}constructor(e,t=null,n=!1){super(e),this.name=t,this.varying=n,this.isPropertyNode=!0,this.global=!0}getHash(e){return this.name||super.getHash(e)}generate(e){let t;return!0===this.varying?(t=e.getVaryingFromNode(this,this.name),t.needsInterpolation=!0):t=e.getVarFromNode(this,this.name),e.getPropertyName(t)}}const wE=(e,t)=>HM(new bE(e,t)),TE=(e,t)=>HM(new bE(e,t,!0)),SE=$M(bE,"vec4","DiffuseColor"),ME=$M(bE,"vec3","EmissiveColor"),EE=$M(bE,"float","Roughness"),AE=$M(bE,"float","Metalness"),CE=$M(bE,"float","Clearcoat"),RE=$M(bE,"float","ClearcoatRoughness"),NE=$M(bE,"vec3","Sheen"),PE=$M(bE,"float","SheenRoughness"),DE=$M(bE,"float","Iridescence"),LE=$M(bE,"float","IridescenceIOR"),IE=$M(bE,"float","IridescenceThickness"),kE=$M(bE,"float","AlphaT"),OE=$M(bE,"float","Anisotropy"),UE=$M(bE,"vec3","AnisotropyT"),FE=$M(bE,"vec3","AnisotropyB"),BE=$M(bE,"color","SpecularColor"),zE=$M(bE,"float","SpecularF90"),VE=$M(bE,"float","Shininess"),GE=$M(bE,"vec4","Output"),jE=$M(bE,"float","dashSize"),HE=$M(bE,"float","gapSize"),WE=$M(bE,"float","IOR"),qE=$M(bE,"float","Transmission"),XE=$M(bE,"float","Thickness"),$E=$M(bE,"float","AttenuationDistance"),YE=$M(bE,"color","AttenuationColor"),KE=$M(bE,"float","Dispersion");class ZE extends iM{static get type(){return"UniformGroupNode"}constructor(e,t=!1,n=1){super("string"),this.name=e,this.shared=t,this.order=n,this.isUniformGroup=!0}serialize(e){super.serialize(e),e.name=this.name,e.version=this.version,e.shared=this.shared}deserialize(e){super.deserialize(e),this.name=e.name,this.version=e.version,this.shared=e.shared}}const JE=e=>new ZE(e),QE=(e,t=0)=>new ZE(e,!0,t),eA=QE("frame"),tA=QE("render"),nA=JE("object");class iA extends dM{static get type(){return"UniformNode"}constructor(e,t=null){super(e,t),this.isUniformNode=!0,this.name="",this.groupNode=nA}label(e){return this.name=e,this}setGroup(e){return this.groupNode=e,this}getGroup(){return this.groupNode}getUniformHash(e){return this.getHash(e)}onUpdate(e,t){const n=this.getSelf();return e=e.bind(n),super.onUpdate((t=>{const i=e(t,n);void 0!==i&&(this.value=i)}),t)}generate(e,t){const n=this.getNodeType(e),i=this.getUniformHash(e);let r=e.getNodeFromHash(i);void 0===r&&(e.setHashNode(this,i),r=this);const s=r.getInputType(e),o=e.getUniformFromNode(r,s,e.shaderStage,this.name||e.context.label),a=e.getPropertyName(o);return void 0!==e.context.label&&delete e.context.label,e.format(a,n,t)}}const rA=(e,t)=>{const n=(e=>null!=e?e.nodeType||e.convertTo||("string"==typeof e?e:null):null)(t||e),i=e&&!0===e.isNode?e.node&&e.node.value||e.value:e;return HM(new iA(i,n))};class sA extends oM{static get type(){return"ArrayNode"}constructor(e,t,n=null){super(e),this.count=t,this.values=n,this.isArrayNode=!0}getNodeType(e){return null===this.nodeType&&(this.nodeType=this.values[0].getNodeType(e)),this.nodeType}getElementType(e){return this.getNodeType(e)}generate(e){const t=this.getNodeType(e);return e.generateArray(t,this.count,this.values)}}vM("toArray",((e,t)=>((...e)=>{let t;if(1===e.length){const n=e[0];t=new sA(null,n.length,n)}else{const n=e[0],i=e[1];t=new sA(n,i)}return HM(t)})(Array(t).fill(e))));class oA extends oM{static get type(){return"AssignNode"}constructor(e,t){super(),this.targetNode=e,this.sourceNode=t,this.isAssignNode=!0}hasDependencies(){return!1}getNodeType(e,t){return"void"!==t?this.targetNode.getNodeType(e):"void"}needsSplitAssign(e){const{targetNode:t}=this;if(!1===e.isAvailable("swizzleAssign")&&t.isSplitNode&&t.components.length>1){const n=e.getTypeLength(t.node.getNodeType(e));return eM.join("").slice(0,n)!==t.components}return!1}setup(e){const{targetNode:t,sourceNode:n}=this,i=e.getNodeProperties(this);i.sourceNode=n,i.targetNode=t.context({assign:!0})}generate(e,t){const{targetNode:n,sourceNode:i}=e.getNodeProperties(this),r=this.needsSplitAssign(e),s=n.getNodeType(e),o=n.build(e),a=i.build(e,s),l=i.getNodeType(e),c=e.getDataFromNode(this);let u;if(!0===c.initialized)"void"!==t&&(u=o);else if(r){const i=e.getVarFromNode(this,null,s),r=e.getPropertyName(i);e.addLineFlowCode(`${r} = ${a}`,this);const l=n.node,c=l.node.context({assign:!0}).build(e);for(let t=0;t<l.components.length;t++){const n=l.components[t];e.addLineFlowCode(`${c}.${n} = ${r}[ ${t} ]`,this)}"void"!==t&&(u=o)}else u=`${o} = ${a}`,"void"!==t&&"void"!==l||(e.addLineFlowCode(u,this),"void"!==t&&(u=o));return c.initialized=!0,e.format(u,s,t)}}vM("assign",XM(oA).setParameterLength(2));class aA extends oM{static get type(){return"FunctionCallNode"}constructor(e=null,t={}){super(),this.functionNode=e,this.parameters=t}setParameters(e){return this.parameters=e,this}getParameters(){return this.parameters}getNodeType(e){return this.functionNode.getNodeType(e)}generate(e){const t=[],n=this.functionNode,i=n.getInputs(e),r=this.parameters,s=(t,n)=>{const i=n.type;let r;return r="pointer"===i?"&"+t.build(e):t.build(e,i),r};if(Array.isArray(r)){if(r.length>i.length)console.error("THREE.TSL: The number of provided parameters exceeds the expected number of inputs in 'Fn()'."),r.length=i.length;else if(r.length<i.length)for(console.error("THREE.TSL: The number of provided parameters is less than the expected number of inputs in 'Fn()'.");r.length<i.length;)r.push(nE(0));for(let e=0;e<r.length;e++)t.push(s(r[e],i[e]))}else for(const e of i){const n=r[e.name];void 0!==n?t.push(s(n,e)):(console.error(`THREE.TSL: Input '${e.name}' not found in 'Fn()'.`),t.push(s(nE(0),e)))}return`${n.build(e,"property")}( ${t.join(", ")} )`}}vM("call",((e,...t)=>(t=t.length>1||t[0]&&!0===t[0].isNode?qM(t):WM(t[0]),HM(new aA(HM(e),t)))));const lA={"==":"equal","!=":"notEqual","<":"lessThan",">":"greaterThan","<=":"lessThanEqual",">=":"greaterThanEqual","%":"mod"};class cA extends oM{static get type(){return"OperatorNode"}constructor(e,t,n,...i){if(super(),i.length>0){let r=new cA(e,t,n);for(let t=0;t<i.length-1;t++)r=new cA(e,r,i[t]);t=r,n=i[i.length-1]}this.op=e,this.aNode=t,this.bNode=n,this.isOperatorNode=!0}getOperatorMethod(e,t){return e.getMethod(lA[this.op],t)}getNodeType(e){const t=this.op,n=this.aNode,i=this.bNode,r=n.getNodeType(e),s=i?i.getNodeType(e):null;if("void"===r||"void"===s)return"void";if("%"===t)return r;if("~"===t||"&"===t||"|"===t||"^"===t||">>"===t||"<<"===t)return e.getIntegerType(r);if("!"===t||"&&"===t||"||"===t||"^^"===t)return"bool";if("=="===t||"!="===t||"<"===t||">"===t||"<="===t||">="===t){const t=Math.max(e.getTypeLength(r),e.getTypeLength(s));return t>1?`bvec${t}`:"bool"}if(e.isMatrix(r)){if("float"===s)return r;if(e.isVector(s))return e.getVectorFromMatrix(r);if(e.isMatrix(s))return r}else if(e.isMatrix(s)){if("float"===r)return s;if(e.isVector(r))return e.getVectorFromMatrix(s)}return e.getTypeLength(s)>e.getTypeLength(r)?s:r}generate(e,t){const n=this.op,{aNode:i,bNode:r}=this,s=this.getNodeType(e);let o=null,a=null;"void"!==s?(o=i.getNodeType(e),a=r?r.getNodeType(e):null,"<"===n||">"===n||"<="===n||">="===n||"=="===n||"!="===n?e.isVector(o)?a=o:e.isVector(a)?o=a:o!==a&&(o=a="float"):">>"===n||"<<"===n?(o=s,a=e.changeComponentType(a,"uint")):"%"===n?(o=s,a=e.isInteger(o)&&e.isInteger(a)?a:o):e.isMatrix(o)?"float"===a?a="float":e.isVector(a)?a=e.getVectorFromMatrix(o):e.isMatrix(a)||(o=a=s):o=e.isMatrix(a)?"float"===o?"float":e.isVector(o)?e.getVectorFromMatrix(a):a=s:a=s):o=a=s;const l=i.build(e,o),c=r?r.build(e,a):null,u=e.getFunctionOperator(n);if("void"!==t){const i=e.renderer.coordinateSystem===gc;if("=="===n||"!="===n||"<"===n||">"===n||"<="===n||">="===n)return i&&e.isVector(o)?e.format(`${this.getOperatorMethod(e,t)}( ${l}, ${c} )`,s,t):e.format(`( ${l} ${n} ${c} )`,s,t);if("%"===n)return e.isInteger(a)?e.format(`( ${l} % ${c} )`,s,t):e.format(`${this.getOperatorMethod(e,s)}( ${l}, ${c} )`,s,t);if("!"===n||"~"===n)return e.format(`(${n}${l})`,o,t);if(u)return e.format(`${u}( ${l}, ${c} )`,s,t);if(e.isMatrix(o)&&"float"===a)return e.format(`( ${c} ${n} ${l} )`,s,t);if("float"===o&&e.isMatrix(a))return e.format(`${l} ${n} ${c}`,s,t);{let r=`( ${l} ${n} ${c} )`;return!i&&"bool"===s&&e.isVector(o)&&e.isVector(a)&&(r=`all${r}`),e.format(r,s,t)}}if("void"!==o)return u?e.format(`${u}( ${l}, ${c} )`,s,t):e.isMatrix(o)&&"float"===a?e.format(`${c} ${n} ${l}`,s,t):e.format(`${l} ${n} ${c}`,s,t)}serialize(e){super.serialize(e),e.op=this.op}deserialize(e){super.deserialize(e),this.op=e.op}}const uA=XM(cA,"+").setParameterLength(2,1/0).setName("add"),hA=XM(cA,"-").setParameterLength(2,1/0).setName("sub"),dA=XM(cA,"*").setParameterLength(2,1/0).setName("mul"),pA=XM(cA,"/").setParameterLength(2,1/0).setName("div"),fA=XM(cA,"%").setParameterLength(2).setName("mod"),mA=XM(cA,"==").setParameterLength(2).setName("equal"),gA=XM(cA,"!=").setParameterLength(2).setName("notEqual"),yA=XM(cA,"<").setParameterLength(2).setName("lessThan"),vA=XM(cA,">").setParameterLength(2).setName("greaterThan"),_A=XM(cA,"<=").setParameterLength(2).setName("lessThanEqual"),xA=XM(cA,">=").setParameterLength(2).setName("greaterThanEqual"),bA=XM(cA,"&&").setParameterLength(2,1/0).setName("and"),wA=XM(cA,"||").setParameterLength(2,1/0).setName("or"),TA=XM(cA,"!").setParameterLength(1).setName("not"),SA=XM(cA,"^^").setParameterLength(2).setName("xor"),MA=XM(cA,"&").setParameterLength(2).setName("bitAnd"),EA=XM(cA,"~").setParameterLength(2).setName("bitNot"),AA=XM(cA,"|").setParameterLength(2).setName("bitOr"),CA=XM(cA,"^").setParameterLength(2).setName("bitXor"),RA=XM(cA,"<<").setParameterLength(2).setName("shiftLeft"),NA=XM(cA,">>").setParameterLength(2).setName("shiftRight"),PA=KM((([e])=>(e.addAssign(1),e))),DA=KM((([e])=>(e.subAssign(1),e))),LA=KM((([e])=>{const t=iE(e).toConst();return e.addAssign(1),t})),IA=KM((([e])=>{const t=iE(e).toConst();return e.subAssign(1),t}));vM("add",uA),vM("sub",hA),vM("mul",dA),vM("div",pA),vM("mod",fA),vM("equal",mA),vM("notEqual",gA),vM("lessThan",yA),vM("greaterThan",vA),vM("lessThanEqual",_A),vM("greaterThanEqual",xA),vM("and",bA),vM("or",wA),vM("not",TA),vM("xor",SA),vM("bitAnd",MA),vM("bitNot",EA),vM("bitOr",AA),vM("bitXor",CA),vM("shiftLeft",RA),vM("shiftRight",NA),vM("incrementBefore",PA),vM("decrementBefore",DA),vM("increment",LA),vM("decrement",IA);vM("remainder",((e,t)=>(console.warn('THREE.TSL: "remainder()" is deprecated. Use "mod( int( ... ) )" instead.'),fA(e,t)))),vM("modInt",((e,t)=>(console.warn('THREE.TSL: "modInt()" is deprecated. Use "mod( int( ... ) )" instead.'),fA(iE(e),iE(t)))));class kA extends oM{static get type(){return"MathNode"}constructor(e,t,n=null,i=null){if(super(),(e===kA.MAX||e===kA.MIN)&&arguments.length>3){let r=new kA(e,t,n);for(let t=2;t<arguments.length-1;t++)r=new kA(e,r,arguments[t]);t=r,n=arguments[arguments.length-1],i=null}this.method=e,this.aNode=t,this.bNode=n,this.cNode=i,this.isMathNode=!0}getInputType(e){const t=this.aNode.getNodeType(e),n=this.bNode?this.bNode.getNodeType(e):null,i=this.cNode?this.cNode.getNodeType(e):null,r=e.isMatrix(t)?0:e.getTypeLength(t),s=e.isMatrix(n)?0:e.getTypeLength(n),o=e.isMatrix(i)?0:e.getTypeLength(i);return r>s&&r>o?t:s>o?n:o>r?i:t}getNodeType(e){const t=this.method;return t===kA.LENGTH||t===kA.DISTANCE||t===kA.DOT?"float":t===kA.CROSS?"vec3":t===kA.ALL||t===kA.ANY?"bool":t===kA.EQUALS?e.changeComponentType(this.aNode.getNodeType(e),"bool"):this.getInputType(e)}setup(e){const{aNode:t,bNode:n,method:i}=this;let r=null;if(i===kA.ONE_MINUS)r=hA(1,t);else if(i===kA.RECIPROCAL)r=pA(1,t);else if(i===kA.DIFFERENCE)r=rC(hA(t,n));else if(i===kA.TRANSFORM_DIRECTION){let i=t,s=n;e.isMatrix(i.getNodeType(e))?s=fE(uE(s),0):i=fE(uE(i),0);const o=dA(i,s).xyz;r=KA(o)}return null!==r?r:super.setup(e)}generate(e,t){if(e.getNodeProperties(this).outputNode)return super.generate(e,t);let n=this.method;const i=this.getNodeType(e),r=this.getInputType(e),s=this.aNode,o=this.bNode,a=this.cNode,l=e.renderer.coordinateSystem;if(n===kA.NEGATE)return e.format("( - "+s.build(e,r)+" )",i,t);{const c=[];return n===kA.CROSS?c.push(s.build(e,i),o.build(e,i)):l===gc&&n===kA.STEP?c.push(s.build(e,1===e.getTypeLength(s.getNodeType(e))?"float":r),o.build(e,r)):l!==gc||n!==kA.MIN&&n!==kA.MAX?n===kA.REFRACT?c.push(s.build(e,r),o.build(e,r),a.build(e,"float")):n===kA.MIX?c.push(s.build(e,r),o.build(e,r),a.build(e,1===e.getTypeLength(a.getNodeType(e))?"float":r)):(l===yc&&n===kA.ATAN&&null!==o&&(n="atan2"),"fragment"===e.shaderStage||n!==kA.DFDX&&n!==kA.DFDY||(console.warn(`THREE.TSL: '${n}' is not supported in the ${e.shaderStage} stage.`),n="/*"+n+"*/"),c.push(s.build(e,r)),null!==o&&c.push(o.build(e,r)),null!==a&&c.push(a.build(e,r))):c.push(s.build(e,r),o.build(e,1===e.getTypeLength(o.getNodeType(e))?"float":r)),e.format(`${e.getMethod(n,i)}( ${c.join(", ")} )`,i,t)}}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}}kA.ALL="all",kA.ANY="any",kA.RADIANS="radians",kA.DEGREES="degrees",kA.EXP="exp",kA.EXP2="exp2",kA.LOG="log",kA.LOG2="log2",kA.SQRT="sqrt",kA.INVERSE_SQRT="inversesqrt",kA.FLOOR="floor",kA.CEIL="ceil",kA.NORMALIZE="normalize",kA.FRACT="fract",kA.SIN="sin",kA.COS="cos",kA.TAN="tan",kA.ASIN="asin",kA.ACOS="acos",kA.ATAN="atan",kA.ABS="abs",kA.SIGN="sign",kA.LENGTH="length",kA.NEGATE="negate",kA.ONE_MINUS="oneMinus",kA.DFDX="dFdx",kA.DFDY="dFdy",kA.ROUND="round",kA.RECIPROCAL="reciprocal",kA.TRUNC="trunc",kA.FWIDTH="fwidth",kA.TRANSPOSE="transpose",kA.BITCAST="bitcast",kA.EQUALS="equals",kA.MIN="min",kA.MAX="max",kA.STEP="step",kA.REFLECT="reflect",kA.DISTANCE="distance",kA.DIFFERENCE="difference",kA.DOT="dot",kA.CROSS="cross",kA.POW="pow",kA.TRANSFORM_DIRECTION="transformDirection",kA.MIX="mix",kA.CLAMP="clamp",kA.REFRACT="refract",kA.SMOOTHSTEP="smoothstep",kA.FACEFORWARD="faceforward";const OA=nE(1e-6),UA=nE(Math.PI),FA=XM(kA,kA.ALL).setParameterLength(1),BA=XM(kA,kA.ANY).setParameterLength(1),zA=XM(kA,kA.RADIANS).setParameterLength(1),VA=XM(kA,kA.DEGREES).setParameterLength(1),GA=XM(kA,kA.EXP).setParameterLength(1),jA=XM(kA,kA.EXP2).setParameterLength(1),HA=XM(kA,kA.LOG).setParameterLength(1),WA=XM(kA,kA.LOG2).setParameterLength(1),qA=XM(kA,kA.SQRT).setParameterLength(1),XA=XM(kA,kA.INVERSE_SQRT).setParameterLength(1),$A=XM(kA,kA.FLOOR).setParameterLength(1),YA=XM(kA,kA.CEIL).setParameterLength(1),KA=XM(kA,kA.NORMALIZE).setParameterLength(1),ZA=XM(kA,kA.FRACT).setParameterLength(1),JA=XM(kA,kA.SIN).setParameterLength(1),QA=XM(kA,kA.COS).setParameterLength(1),eC=XM(kA,kA.TAN).setParameterLength(1),tC=XM(kA,kA.ASIN).setParameterLength(1),nC=XM(kA,kA.ACOS).setParameterLength(1),iC=XM(kA,kA.ATAN).setParameterLength(1,2),rC=XM(kA,kA.ABS).setParameterLength(1),sC=XM(kA,kA.SIGN).setParameterLength(1),oC=XM(kA,kA.LENGTH).setParameterLength(1),aC=XM(kA,kA.NEGATE).setParameterLength(1),lC=XM(kA,kA.ONE_MINUS).setParameterLength(1),cC=XM(kA,kA.DFDX).setParameterLength(1),uC=XM(kA,kA.DFDY).setParameterLength(1),hC=XM(kA,kA.ROUND).setParameterLength(1),dC=XM(kA,kA.RECIPROCAL).setParameterLength(1),pC=XM(kA,kA.TRUNC).setParameterLength(1),fC=XM(kA,kA.FWIDTH).setParameterLength(1),mC=XM(kA,kA.TRANSPOSE).setParameterLength(1),gC=XM(kA,kA.MIN).setParameterLength(2,1/0),yC=XM(kA,kA.MAX).setParameterLength(2,1/0),vC=XM(kA,kA.STEP).setParameterLength(2),_C=XM(kA,kA.REFLECT).setParameterLength(2),xC=XM(kA,kA.DISTANCE).setParameterLength(2),bC=XM(kA,kA.DIFFERENCE).setParameterLength(2),wC=XM(kA,kA.DOT).setParameterLength(2),TC=XM(kA,kA.CROSS).setParameterLength(2),SC=XM(kA,kA.POW).setParameterLength(2),MC=XM(kA,kA.POW,2).setParameterLength(1),EC=XM(kA,kA.POW,3).setParameterLength(1),AC=XM(kA,kA.POW,4).setParameterLength(1),CC=XM(kA,kA.TRANSFORM_DIRECTION).setParameterLength(2),RC=e=>wC(e,e),NC=XM(kA,kA.MIX).setParameterLength(3),PC=(e,t=0,n=1)=>HM(new kA(kA.CLAMP,HM(e),HM(t),HM(n))),DC=e=>PC(e),LC=XM(kA,kA.REFRACT).setParameterLength(3),IC=XM(kA,kA.SMOOTHSTEP).setParameterLength(3),kC=XM(kA,kA.FACEFORWARD).setParameterLength(3),OC=KM((([e])=>{const t=wC(e.xy,oE(12.9898,78.233)),n=fA(t,UA);return ZA(JA(n).mul(43758.5453))}));vM("all",FA),vM("any",BA),vM("equals",((e,t)=>(console.warn('THREE.TSL: "equals" is deprecated. Use "equal" inside a vector instead, like: "bvec*( equal( ... ) )"'),mA(e,t)))),vM("radians",zA),vM("degrees",VA),vM("exp",GA),vM("exp2",jA),vM("log",HA),vM("log2",WA),vM("sqrt",qA),vM("inverseSqrt",XA),vM("floor",$A),vM("ceil",YA),vM("normalize",KA),vM("fract",ZA),vM("sin",JA),vM("cos",QA),vM("tan",eC),vM("asin",tC),vM("acos",nC),vM("atan",iC),vM("abs",rC),vM("sign",sC),vM("length",oC),vM("lengthSq",RC),vM("negate",aC),vM("oneMinus",lC),vM("dFdx",cC),vM("dFdy",uC),vM("round",hC),vM("reciprocal",dC),vM("trunc",pC),vM("fwidth",fC),vM("atan2",((e,t)=>(console.warn('THREE.TSL: "atan2" is overloaded. Use "atan" instead.'),iC(e,t)))),vM("min",gC),vM("max",yC),vM("step",vC),vM("reflect",_C),vM("distance",xC),vM("dot",wC),vM("cross",TC),vM("pow",SC),vM("pow2",MC),vM("pow3",EC),vM("pow4",AC),vM("transformDirection",CC),vM("mix",((e,t,n)=>NC(t,n,e))),vM("clamp",PC),vM("refract",LC),vM("smoothstep",((e,t,n)=>IC(t,n,e))),vM("faceForward",kC),vM("difference",bC),vM("saturate",DC),vM("cbrt",(e=>dA(sC(e),SC(rC(e),1/3)))),vM("transpose",mC),vM("rand",OC);class UC extends iM{static get type(){return"ConditionalNode"}constructor(e,t,n=null){super(),this.condNode=e,this.ifNode=t,this.elseNode=n}getNodeType(e){const{ifNode:t,elseNode:n}=e.getNodeProperties(this);if(void 0===t)return this.setup(e),this.getNodeType(e);const i=t.getNodeType(e);if(null!==n){const t=n.getNodeType(e);if(e.getTypeLength(t)>e.getTypeLength(i))return t}return i}setup(e){const t=this.condNode.cache(),n=this.ifNode.cache(),i=this.elseNode?this.elseNode.cache():null,r=e.context.nodeBlock;e.getDataFromNode(n).parentNodeBlock=r,null!==i&&(e.getDataFromNode(i).parentNodeBlock=r);const s=e.getNodeProperties(this);s.condNode=t,s.ifNode=n.context({nodeBlock:n}),s.elseNode=i?i.context({nodeBlock:i}):null}generate(e,t){const n=this.getNodeType(e),i=e.getDataFromNode(this);if(void 0!==i.nodeProperty)return i.nodeProperty;const{condNode:r,ifNode:s,elseNode:o}=e.getNodeProperties(this),a=e.currentFunctionNode,l="void"!==t,c=l?wE(n).build(e):"";i.nodeProperty=c;const u=r.build(e,"bool");e.addFlowCode(`\n${e.tab}if ( ${u} ) {\n\n`).addFlowTab();let h=s.build(e,n);if(h&&(l?h=c+" = "+h+";":(h="return "+h+";",null===a&&(console.warn("THREE.TSL: Return statement used in an inline 'Fn()'. Define a layout struct to allow return values."),h="// "+h))),e.removeFlowTab().addFlowCode(e.tab+"\t"+h+"\n\n"+e.tab+"}"),null!==o){e.addFlowCode(" else {\n\n").addFlowTab();let t=o.build(e,n);t&&(l?t=c+" = "+t+";":(t="return "+t+";",null===a&&(console.warn("THREE.TSL: Return statement used in an inline 'Fn()'. Define a layout struct to allow return values."),t="// "+t))),e.removeFlowTab().addFlowCode(e.tab+"\t"+t+"\n\n"+e.tab+"}\n\n")}else e.addFlowCode("\n\n");return e.format(c,n,t)}}const FC=XM(UC).setParameterLength(2,3);vM("select",FC);vM("cond",((...e)=>(console.warn("THREE.TSL: cond() has been renamed to select()."),FC(...e))));class BC extends iM{static get type(){return"ContextNode"}constructor(e,t={}){super(),this.isContextNode=!0,this.node=e,this.value=t}getScope(){return this.node.getScope()}getNodeType(e){return this.node.getNodeType(e)}analyze(e){const t=e.getContext();e.setContext({...e.context,...this.value}),this.node.build(e),e.setContext(t)}setup(e){const t=e.getContext();e.setContext({...e.context,...this.value}),this.node.build(e),e.setContext(t)}generate(e,t){const n=e.getContext();e.setContext({...e.context,...this.value});const i=this.node.build(e,t);return e.setContext(n),i}}const zC=XM(BC).setParameterLength(1,2);vM("context",zC),vM("label",((e,t)=>zC(e,{label:t})));class VC extends iM{static get type(){return"VarNode"}constructor(e,t=null,n=!1){super(),this.node=e,this.name=t,this.global=!0,this.isVarNode=!0,this.readOnly=n,this.parents=!0}getMemberType(e,t){return this.node.getMemberType(e,t)}getElementType(e){return this.node.getElementType(e)}getNodeType(e){return this.node.getNodeType(e)}generate(e){const{node:t,name:n,readOnly:i}=this,{renderer:r}=e,s=!0===r.backend.isWebGPUBackend;let o=!1,a=!1;i&&(o=e.isDeterministic(t),a=s?i:o);const l=e.getVectorType(this.getNodeType(e)),c=t.build(e,l),u=e.getVarFromNode(this,n,l,void 0,a),h=e.getPropertyName(u);let d=h;if(a)if(s)d=o?`const ${h}`:`let ${h}`;else{const n=e.getArrayCount(t);d=`const ${e.getVar(u.type,h,n)}`}return e.addLineFlowCode(`${d} = ${c}`,this),h}}const GC=XM(VC);vM("toVar",((e,t=null)=>GC(e,t).toStack())),vM("toConst",((e,t=null)=>GC(e,t,!0).toStack()));vM("temp",(e=>(console.warn('TSL: "temp( node )" is deprecated. Use "Var( node )" or "node.toVar()" instead.'),GC(e))));class jC extends iM{static get type(){return"VaryingNode"}constructor(e,t=null){super(),this.node=e,this.name=t,this.isVaryingNode=!0,this.interpolationType=null,this.interpolationSampling=null,this.global=!0}setInterpolation(e,t=null){return this.interpolationType=e,this.interpolationSampling=t,this}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}setupVarying(e){const t=e.getNodeProperties(this);let n=t.varying;if(void 0===n){const i=this.name,r=this.getNodeType(e),s=this.interpolationType,o=this.interpolationSampling;t.varying=n=e.getVaryingFromNode(this,i,r,s,o),t.node=this.node}return n.needsInterpolation||(n.needsInterpolation="fragment"===e.shaderStage),n}setup(e){this.setupVarying(e),e.flowNodeFromShaderStage(HS,this.node)}analyze(e){this.setupVarying(e),e.flowNodeFromShaderStage(HS,this.node)}generate(e){const t=e.getNodeProperties(this),n=this.setupVarying(e);if(void 0===t.propertyName){const i=this.getNodeType(e),r=e.getPropertyName(n,HS);e.flowNodeFromShaderStage(HS,this.node,i,r),t.propertyName=r}return e.getPropertyName(n)}}const HC=XM(jC).setParameterLength(1,2);vM("toVarying",HC),vM("toVertexStage",(e=>HC(e))),vM("varying",((...e)=>(console.warn("THREE.TSL: .varying() has been renamed to .toVarying()."),HC(...e)))),vM("vertexStage",((...e)=>(console.warn("THREE.TSL: .vertexStage() has been renamed to .toVertexStage()."),HC(...e))));const WC=KM((([e])=>{const t=e.mul(.9478672986).add(.0521327014).pow(2.4),n=e.mul(.0773993808),i=e.lessThanEqual(.04045);return NC(t,n,i)})).setLayout({name:"sRGBTransferEOTF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),qC=KM((([e])=>{const t=e.pow(.41666).mul(1.055).sub(.055),n=e.mul(12.92),i=e.lessThanEqual(.0031308);return NC(t,n,i)})).setLayout({name:"sRGBTransferOETF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),XC="WorkingColorSpace";class $C extends oM{static get type(){return"ColorSpaceNode"}constructor(e,t,n){super("vec4"),this.colorNode=e,this.source=t,this.target=n}resolveColorSpace(e,t){return t===XC?Wc.workingColorSpace:"OutputColorSpace"===t?e.context.outputColorSpace||e.renderer.outputColorSpace:t}setup(e){const{colorNode:t}=this,n=this.resolveColorSpace(e,this.source),i=this.resolveColorSpace(e,this.target);let r=t;return!1!==Wc.enabled&&n!==i&&n&&i?(Wc.getTransfer(n)===ic&&(r=fE(WC(r.rgb),r.a)),Wc.getPrimaries(n)!==Wc.getPrimaries(i)&&(r=fE(_E(Wc._getMatrix(new kc,n,i)).mul(r.rgb),r.a)),Wc.getTransfer(i)===ic&&(r=fE(qC(r.rgb),r.a)),r):r}}const YC=(e,t)=>HM(new $C(HM(e),t,XC));vM("workingToColorSpace",((e,t)=>HM(new $C(HM(e),XC,t)))),vM("colorSpaceToWorking",YC);let KC=class extends rM{static get type(){return"ReferenceElementNode"}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){const t=super.generate(e),n=this.referenceNode.getNodeType(),i=this.getNodeType();return e.format(t,n,i)}};class ZC extends iM{static get type(){return"ReferenceBaseNode"}constructor(e,t,n=null,i=null){super(),this.property=e,this.uniformType=t,this.object=n,this.count=i,this.properties=e.split("."),this.reference=n,this.node=null,this.group=null,this.updateType=$S}setGroup(e){return this.group=e,this}element(e){return HM(new KC(this,HM(e)))}setNodeType(e){const t=rA(null,e).getSelf();null!==this.group&&t.setGroup(this.group),this.node=t}getNodeType(e){return null===this.node&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){const{properties:t}=this;let n=e[t[0]];for(let e=1;e<t.length;e++)n=n[t[e]];return n}updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}}class JC extends ZC{static get type(){return"RendererReferenceNode"}constructor(e,t,n=null){super(e,t,n),this.renderer=n,this.setGroup(tA)}updateReference(e){return this.reference=null!==this.renderer?this.renderer:e.renderer,this.reference}}const QC=(e,t,n=null)=>HM(new JC(e,t,n));class eR extends oM{static get type(){return"ToneMappingNode"}constructor(e,t=tR,n=null){super("vec3"),this.toneMapping=e,this.exposureNode=t,this.colorNode=n}customCacheKey(){return OS(this.toneMapping)}setup(e){const t=this.colorNode||e.context.color,n=this.toneMapping;if(0===n)return t;let i=null;const r=e.renderer.library.getToneMappingFunction(n);return null!==r?i=fE(r(t.rgb,this.exposureNode),t.a):(console.error("ToneMappingNode: Unsupported Tone Mapping configuration.",n),i=t),i}}const tR=QC("toneMappingExposure","float");vM("toneMapping",((e,t,n)=>((e,t,n)=>HM(new eR(e,HM(t),HM(n))))(t,n,e)));class nR extends dM{static get type(){return"BufferAttributeNode"}constructor(e,t=null,n=0,i=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferStride=n,this.bufferOffset=i,this.usage=pc,this.instanced=!1,this.attribute=null,this.global=!0,e&&!0===e.isBufferAttribute&&(this.attribute=e,this.usage=e.usage,this.instanced=e.isInstancedBufferAttribute)}getHash(e){if(0===this.bufferStride&&0===this.bufferOffset){let t=e.globalCache.getData(this.value);return void 0===t&&(t={node:this},e.globalCache.setData(this.value,t)),t.node.uuid}return this.uuid}getNodeType(e){return null===this.bufferType&&(this.bufferType=e.getTypeFromAttribute(this.attribute)),this.bufferType}setup(e){if(null!==this.attribute)return;const t=this.getNodeType(e),n=this.value,i=e.getTypeLength(t),r=this.bufferStride||i,s=this.bufferOffset,o=!0===n.isInterleavedBuffer?n:new Rd(n,r),a=new Pd(o,i,s);o.setUsage(this.usage),this.attribute=a,this.attribute.isInstancedBufferAttribute=this.instanced}generate(e){const t=this.getNodeType(e),n=e.getBufferAttributeFromNode(this,t),i=e.getPropertyName(n);let r=null;if("vertex"===e.shaderStage||"compute"===e.shaderStage)this.name=i,r=i;else{r=HC(this).build(e,t)}return r}getInputType(){return"bufferAttribute"}setUsage(e){return this.usage=e,this.attribute&&!0===this.attribute.isBufferAttribute&&(this.attribute.usage=e),this}setInstanced(e){return this.instanced=e,this}}const iR=(e,t=null,n=0,i=0)=>HM(new nR(e,t,n,i)),rR=(e,t=null,n=0,i=0)=>iR(e,t,n,i).setInstanced(!0),sR=(e,t=null,n=0,i=0)=>((e,t=null,n=0,i=0)=>iR(e,t,n,i).setUsage(fc))(e,t,n,i).setInstanced(!0);vM("toAttribute",(e=>iR(e.value)));class oR extends iM{static get type(){return"ComputeNode"}constructor(e,t,n=[64]){super("void"),this.isComputeNode=!0,this.computeNode=e,this.count=t,this.workgroupSize=n,this.dispatchCount=0,this.version=1,this.name="",this.updateBeforeType=$S,this.onInitFunction=null,this.updateDispatchCount()}dispose(){this.dispatchEvent({type:"dispose"})}label(e){return this.name=e,this}updateDispatchCount(){const{count:e,workgroupSize:t}=this;let n=t[0];for(let e=1;e<t.length;e++)n*=t[e];this.dispatchCount=Math.ceil(e/n)}onInit(e){return this.onInitFunction=e,this}updateBefore({renderer:e}){e.compute(this)}setup(e){const t=this.computeNode.build(e);if(t){e.getNodeProperties(this).outputComputeNode=t.outputNode,t.outputNode=null}return t}generate(e,t){const{shaderStage:n}=e;if("compute"===n){const t=this.computeNode.build(e,"void");""!==t&&e.addLineFlowCode(t,this)}else{const n=e.getNodeProperties(this).outputComputeNode;if(n)return n.build(e,t)}}}vM("compute",((e,t,n)=>HM(new oR(HM(e),t,n))));class aR extends iM{static get type(){return"CacheNode"}constructor(e,t=!0){super(),this.node=e,this.parent=t,this.isCacheNode=!0}getNodeType(e){const t=e.getCache(),n=e.getCacheFromNode(this,this.parent);e.setCache(n);const i=this.node.getNodeType(e);return e.setCache(t),i}build(e,...t){const n=e.getCache(),i=e.getCacheFromNode(this,this.parent);e.setCache(i);const r=this.node.build(e,...t);return e.setCache(n),r}}const lR=(e,t)=>HM(new aR(HM(e),t));vM("cache",lR);class cR extends iM{static get type(){return"BypassNode"}constructor(e,t){super(),this.isBypassNode=!0,this.outputNode=e,this.callNode=t}getNodeType(e){return this.outputNode.getNodeType(e)}generate(e){const t=this.callNode.build(e,"void");return""!==t&&e.addLineFlowCode(t,this),this.outputNode.build(e)}}vM("bypass",XM(cR).setParameterLength(2));class uR extends iM{static get type(){return"RemapNode"}constructor(e,t,n,i=nE(0),r=nE(1)){super(),this.node=e,this.inLowNode=t,this.inHighNode=n,this.outLowNode=i,this.outHighNode=r,this.doClamp=!0}setup(){const{node:e,inLowNode:t,inHighNode:n,outLowNode:i,outHighNode:r,doClamp:s}=this;let o=e.sub(t).div(n.sub(t));return!0===s&&(o=o.clamp()),o.mul(r.sub(i)).add(i)}}const hR=XM(uR,null,null,{doClamp:!1}).setParameterLength(3,5),dR=XM(uR).setParameterLength(3,5);vM("remap",hR),vM("remapClamp",dR);class pR extends iM{static get type(){return"ExpressionNode"}constructor(e="",t="void"){super(t),this.snippet=e}generate(e,t){const n=this.getNodeType(e),i=this.snippet;if("void"!==n)return e.format(i,n,t);e.addLineFlowCode(i,this)}}const fR=XM(pR).setParameterLength(1,2);vM("discard",(e=>(e?FC(e,fR("discard")):fR("discard")).toStack()));class mR extends oM{static get type(){return"RenderOutputNode"}constructor(e,t,n){super("vec4"),this.colorNode=e,this.toneMapping=t,this.outputColorSpace=n,this.isRenderOutputNode=!0}setup({context:e}){let t=this.colorNode||e.color;const n=(null!==this.toneMapping?this.toneMapping:e.toneMapping)||0,i=(null!==this.outputColorSpace?this.outputColorSpace:e.outputColorSpace)||Ql;return 0!==n&&(t=t.toneMapping(n)),i!==Ql&&i!==Wc.workingColorSpace&&(t=t.workingToColorSpace(i)),t}}vM("renderOutput",((e,t=null,n=null)=>HM(new mR(HM(e),t,n))));class gR extends oM{static get type(){return"DebugNode"}constructor(e,t=null){super(),this.node=e,this.callback=t}getNodeType(e){return this.node.getNodeType(e)}setup(e){return this.node.build(e)}analyze(e){return this.node.build(e)}generate(e){const t=this.callback,n=this.node.build(e),i="--- TSL debug - "+e.shaderStage+" shader ---",r="-".repeat(i.length);let s="";return s+="// #"+i+"#\n",s+=e.flow.code.replace(/^\t/gm,"")+"\n",s+="/* ... */ "+n+" /* ... */\n",s+="// #"+r+"#\n",null!==t?t(e,s):console.log(s),n}}vM("debug",((e,t=null)=>HM(new gR(HM(e),t))));class yR extends iM{static get type(){return"AttributeNode"}constructor(e,t=null){super(t),this.global=!0,this._attributeName=e}getHash(e){return this.getAttributeName(e)}getNodeType(e){let t=this.nodeType;if(null===t){const n=this.getAttributeName(e);if(e.hasGeometryAttribute(n)){const i=e.geometry.getAttribute(n);t=e.getTypeFromAttribute(i)}else t="float"}return t}setAttributeName(e){return this._attributeName=e,this}getAttributeName(){return this._attributeName}generate(e){const t=this.getAttributeName(e),n=this.getNodeType(e);if(!0===e.hasGeometryAttribute(t)){const i=e.geometry.getAttribute(t),r=e.getTypeFromAttribute(i),s=e.getAttribute(t,r);if("vertex"===e.shaderStage)return e.format(s.name,r,n);return HC(this).build(e,n)}return console.warn(`AttributeNode: Vertex attribute "${t}" not found on geometry.`),e.generateConst(n)}serialize(e){super.serialize(e),e.global=this.global,e._attributeName=this._attributeName}deserialize(e){super.deserialize(e),this.global=e.global,this._attributeName=e._attributeName}}const vR=(e,t=null)=>HM(new yR(e,t)),_R=(e=0)=>vR("uv"+(e>0?e:""),"vec2");class xR extends iM{static get type(){return"TextureSizeNode"}constructor(e,t=null){super("uvec2"),this.isTextureSizeNode=!0,this.textureNode=e,this.levelNode=t}generate(e,t){const n=this.textureNode.build(e,"property"),i=null===this.levelNode?"0":this.levelNode.build(e,"int");return e.format(`${e.getMethod("textureDimensions")}( ${n}, ${i} )`,this.getNodeType(e),t)}}const bR=XM(xR).setParameterLength(1,2);class wR extends iA{static get type(){return"MaxMipLevelNode"}constructor(e){super(0),this._textureNode=e,this.updateType=qS}get textureNode(){return this._textureNode}get texture(){return this._textureNode.value}update(){const e=this.texture,t=e.images,n=t&&t.length>0?t[0]&&t[0].image||t[0]:e.image;if(n&&void 0!==n.width){const{width:e,height:t}=n;this.value=Math.log2(Math.max(e,t))}}}const TR=XM(wR).setParameterLength(1),SR=new tu;class MR extends iA{static get type(){return"TextureNode"}constructor(e=SR,t=null,n=null,i=null){super(e),this.isTextureNode=!0,this.uvNode=t,this.levelNode=n,this.biasNode=i,this.compareNode=null,this.depthNode=null,this.gradNode=null,this.sampler=!0,this.updateMatrix=!1,this.updateType=WS,this.referenceNode=null,this._value=e,this._matrixUniform=null,this.setUpdateMatrix(null===t)}set value(e){this.referenceNode?this.referenceNode.value=e:this._value=e}get value(){return this.referenceNode?this.referenceNode.value:this._value}getUniformHash(){return this.value.uuid}getNodeType(){return!0===this.value.isDepthTexture?"float":this.value.type===rl?"uvec4":this.value.type===il?"ivec4":"vec4"}getInputType(){return"texture"}getDefaultUV(){return _R(this.value.channel)}updateReference(){return this.value}getTransformedUV(e){return null===this._matrixUniform&&(this._matrixUniform=rA(this.value.matrix)),this._matrixUniform.mul(uE(e,1)).xy}setUpdateMatrix(e){return this.updateMatrix=e,this.updateType=e?$S:WS,this}setupUV(e,t){const n=this.value;return e.isFlipY()&&(n.image instanceof ImageBitmap&&!0===n.flipY||!0===n.isRenderTargetTexture||!0===n.isFramebufferTexture||!0===n.isDepthTexture)&&(t=this.sampler?t.flipY():t.setY(iE(bR(this,this.levelNode).y).sub(t.y).sub(1))),t}setup(e){const t=e.getNodeProperties(this);t.referenceNode=this.referenceNode;const n=this.value;if(!n||!0!==n.isTexture)throw new Error("THREE.TSL: `texture( value )` function expects a valid instance of THREE.Texture().");let i=this.uvNode;null!==i&&!0!==e.context.forceUVContext||!e.context.getUV||(i=e.context.getUV(this,e)),i||(i=this.getDefaultUV()),!0===this.updateMatrix&&(i=this.getTransformedUV(i)),i=this.setupUV(e,i);let r=this.levelNode;null===r&&e.context.getTextureLevel&&(r=e.context.getTextureLevel(this)),t.uvNode=i,t.levelNode=r,t.biasNode=this.biasNode,t.compareNode=this.compareNode,t.gradNode=this.gradNode,t.depthNode=this.depthNode}generateUV(e,t){return t.build(e,!0===this.sampler?"vec2":"ivec2")}generateSnippet(e,t,n,i,r,s,o,a){const l=this.value;let c;return c=i?e.generateTextureLevel(l,t,n,i,s):r?e.generateTextureBias(l,t,n,r,s):a?e.generateTextureGrad(l,t,n,a,s):o?e.generateTextureCompare(l,t,n,o,s):!1===this.sampler?e.generateTextureLoad(l,t,n,s):e.generateTexture(l,t,n,s),c}generate(e,t){const n=this.value,i=e.getNodeProperties(this),r=super.generate(e,"property");if(/^sampler/.test(t))return r+"_sampler";if(e.isReference(t))return r;{const s=e.getDataFromNode(this);let o=s.propertyName;if(void 0===o){const{uvNode:t,levelNode:n,biasNode:a,compareNode:l,depthNode:c,gradNode:u}=i,h=this.generateUV(e,t),d=n?n.build(e,"float"):null,p=a?a.build(e,"float"):null,f=c?c.build(e,"int"):null,m=l?l.build(e,"float"):null,g=u?[u[0].build(e,"vec2"),u[1].build(e,"vec2")]:null,y=e.getVarFromNode(this);o=e.getPropertyName(y);const v=this.generateSnippet(e,r,h,d,p,f,m,g);e.addLineFlowCode(`${o} = ${v}`,this),s.snippet=v,s.propertyName=o}let a=o;const l=this.getNodeType(e);return e.needsToWorkingColorSpace(n)&&(a=YC(fR(a,l),n.colorSpace).setup(e).build(e,l)),e.format(a,l,t)}}setSampler(e){return this.sampler=e,this}getSampler(){return this.sampler}uv(e){return console.warn("THREE.TextureNode: .uv() has been renamed. Use .sample() instead."),this.sample(e)}sample(e){const t=this.clone();return t.uvNode=HM(e),t.referenceNode=this.getSelf(),HM(t)}blur(e){const t=this.clone();t.biasNode=HM(e).mul(TR(t)),t.referenceNode=this.getSelf();const n=t.value;return!1===t.generateMipmaps&&(n&&!1===n.generateMipmaps||n.minFilter===Xa||n.magFilter===Xa)&&(console.warn("THREE.TSL: texture().blur() requires mipmaps and sampling. Use .generateMipmaps=true and .minFilter/.magFilter=THREE.LinearFilter in the Texture."),t.biasNode=null),HM(t)}level(e){const t=this.clone();return t.levelNode=HM(e),t.referenceNode=this.getSelf(),HM(t)}size(e){return bR(this,e)}bias(e){const t=this.clone();return t.biasNode=HM(e),t.referenceNode=this.getSelf(),HM(t)}compare(e){const t=this.clone();return t.compareNode=HM(e),t.referenceNode=this.getSelf(),HM(t)}grad(e,t){const n=this.clone();return n.gradNode=[HM(e),HM(t)],n.referenceNode=this.getSelf(),HM(n)}depth(e){const t=this.clone();return t.depthNode=HM(e),t.referenceNode=this.getSelf(),HM(t)}serialize(e){super.serialize(e),e.value=this.value.toJSON(e.meta).uuid,e.sampler=this.sampler,e.updateMatrix=this.updateMatrix,e.updateType=this.updateType}deserialize(e){super.deserialize(e),this.value=e.meta.textures[e.value],this.sampler=e.sampler,this.updateMatrix=e.updateMatrix,this.updateType=e.updateType}update(){const e=this.value,t=this._matrixUniform;null!==t&&(t.value=e.matrix),!0===e.matrixAutoUpdate&&e.updateMatrix()}clone(){const e=new this.constructor(this.value,this.uvNode,this.levelNode,this.biasNode);return e.sampler=this.sampler,e.depthNode=this.depthNode,e.compareNode=this.compareNode,e.gradNode=this.gradNode,e}}const ER=XM(MR).setParameterLength(1,4).setName("texture"),AR=(e=SR,t=null,n=null,i=null)=>{let r;return e&&!0===e.isTextureNode?(r=HM(e.clone()),r.referenceNode=e.getSelf(),null!==t&&(r.uvNode=HM(t)),null!==n&&(r.levelNode=HM(n)),null!==i&&(r.biasNode=HM(i))):r=ER(e,t,n,i),r},CR=(...e)=>AR(...e).setSampler(!1);class RR extends iA{static get type(){return"BufferNode"}constructor(e,t,n=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferCount=n}getElementType(e){return this.getNodeType(e)}getInputType(){return"buffer"}}const NR=(e,t,n)=>HM(new RR(e,t,n));class PR extends rM{static get type(){return"UniformArrayElementNode"}constructor(e,t){super(e,t),this.isArrayBufferElementNode=!0}generate(e){const t=super.generate(e),n=this.getNodeType(),i=this.node.getPaddedType();return e.format(t,i,n)}}class DR extends RR{static get type(){return"UniformArrayNode"}constructor(e,t=null){super(null),this.array=e,this.elementType=null===t?VS(e[0]):t,this.paddedType=this.getPaddedType(),this.updateType=XS,this.isArrayBufferNode=!0}getNodeType(){return this.paddedType}getElementType(){return this.elementType}getPaddedType(){const e=this.elementType;let t="vec4";return"mat2"===e?t="mat2":!0===/mat/.test(e)?t="mat4":"i"===e.charAt(0)?t="ivec4":"u"===e.charAt(0)&&(t="uvec4"),t}update(){const{array:e,value:t}=this,n=this.elementType;if("float"===n||"int"===n||"uint"===n)for(let n=0;n<e.length;n++){t[4*n]=e[n]}else if("color"===n)for(let n=0;n<e.length;n++){const i=4*n,r=e[n];t[i]=r.r,t[i+1]=r.g,t[i+2]=r.b||0}else if("mat2"===n)for(let n=0;n<e.length;n++){const i=4*n,r=e[n];t[i]=r.elements[0],t[i+1]=r.elements[1],t[i+2]=r.elements[2],t[i+3]=r.elements[3]}else if("mat3"===n)for(let n=0;n<e.length;n++){const i=16*n,r=e[n];t[i]=r.elements[0],t[i+1]=r.elements[1],t[i+2]=r.elements[2],t[i+4]=r.elements[3],t[i+5]=r.elements[4],t[i+6]=r.elements[5],t[i+8]=r.elements[6],t[i+9]=r.elements[7],t[i+10]=r.elements[8],t[i+15]=1}else if("mat4"===n)for(let n=0;n<e.length;n++){const i=16*n,r=e[n];for(let e=0;e<r.elements.length;e++)t[i+e]=r.elements[e]}else for(let n=0;n<e.length;n++){const i=4*n,r=e[n];t[i]=r.x,t[i+1]=r.y,t[i+2]=r.z||0,t[i+3]=r.w||0}}setup(e){const t=this.array.length,n=this.elementType;let i=Float32Array;const r=this.paddedType,s=e.getTypeLength(r);return"i"===n.charAt(0)&&(i=Int32Array),"u"===n.charAt(0)&&(i=Uint32Array),this.value=new i(t*s),this.bufferCount=t,this.bufferType=r,super.setup(e)}element(e){return HM(new PR(this,HM(e)))}}const LR=(e,t)=>HM(new DR(e,t));const IR=XM(class extends iM{constructor(e){super("float"),this.name=e,this.isBuiltinNode=!0}generate(){return this.name}}).setParameterLength(1),kR=rA(0,"uint").label("u_cameraIndex").setGroup(QE("cameraIndex")).toVarying("v_cameraIndex"),OR=rA("float").label("cameraNear").setGroup(tA).onRenderUpdate((({camera:e})=>e.near)),UR=rA("float").label("cameraFar").setGroup(tA).onRenderUpdate((({camera:e})=>e.far)),FR=KM((({camera:e})=>{let t;if(e.isArrayCamera&&e.cameras.length>0){const n=[];for(const t of e.cameras)n.push(t.projectionMatrix);t=LR(n).setGroup(tA).label("cameraProjectionMatrices").element(e.isMultiViewCamera?IR("gl_ViewID_OVR"):kR).toVar("cameraProjectionMatrix")}else t=rA("mat4").label("cameraProjectionMatrix").setGroup(tA).onRenderUpdate((({camera:e})=>e.projectionMatrix));return t})).once()(),BR=KM((({camera:e})=>{let t;if(e.isArrayCamera&&e.cameras.length>0){const n=[];for(const t of e.cameras)n.push(t.matrixWorldInverse);t=LR(n).setGroup(tA).label("cameraViewMatrices").element(e.isMultiViewCamera?IR("gl_ViewID_OVR"):kR).toVar("cameraViewMatrix")}else t=rA("mat4").label("cameraViewMatrix").setGroup(tA).onRenderUpdate((({camera:e})=>e.matrixWorldInverse));return t})).once()(),zR=rA(new Dc).label("cameraPosition").setGroup(tA).onRenderUpdate((({camera:e},t)=>t.value.setFromMatrixPosition(e.matrixWorld))),VR=new Mu;class GR extends iM{static get type(){return"Object3DNode"}constructor(e,t=null){super(),this.scope=e,this.object3d=t,this.updateType=$S,this.uniformNode=new iA(null)}getNodeType(){const e=this.scope;return e===GR.WORLD_MATRIX?"mat4":e===GR.POSITION||e===GR.VIEW_POSITION||e===GR.DIRECTION||e===GR.SCALE?"vec3":e===GR.RADIUS?"float":void 0}update(e){const t=this.object3d,n=this.uniformNode,i=this.scope;if(i===GR.WORLD_MATRIX)n.value=t.matrixWorld;else if(i===GR.POSITION)n.value=n.value||new Dc,n.value.setFromMatrixPosition(t.matrixWorld);else if(i===GR.SCALE)n.value=n.value||new Dc,n.value.setFromMatrixScale(t.matrixWorld);else if(i===GR.DIRECTION)n.value=n.value||new Dc,t.getWorldDirection(n.value);else if(i===GR.VIEW_POSITION){const i=e.camera;n.value=n.value||new Dc,n.value.setFromMatrixPosition(t.matrixWorld),n.value.applyMatrix4(i.matrixWorldInverse)}else if(i===GR.RADIUS){const i=e.object.geometry;null===i.boundingSphere&&i.computeBoundingSphere(),VR.copy(i.boundingSphere).applyMatrix4(t.matrixWorld),n.value=VR.radius}}generate(e){const t=this.scope;return t===GR.WORLD_MATRIX?this.uniformNode.nodeType="mat4":t===GR.POSITION||t===GR.VIEW_POSITION||t===GR.DIRECTION||t===GR.SCALE?this.uniformNode.nodeType="vec3":t===GR.RADIUS&&(this.uniformNode.nodeType="float"),this.uniformNode.build(e)}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}GR.WORLD_MATRIX="worldMatrix",GR.POSITION="position",GR.SCALE="scale",GR.VIEW_POSITION="viewPosition",GR.DIRECTION="direction",GR.RADIUS="radius";const jR=XM(GR,GR.POSITION).setParameterLength(1);class HR extends GR{static get type(){return"ModelNode"}constructor(e){super(e)}update(e){this.object3d=e.object,super.update(e)}}const WR=$M(HR,HR.WORLD_MATRIX),qR=rA(new kc).onObjectUpdate((({object:e},t)=>t.value.getNormalMatrix(e.matrixWorld))),XR=KM((e=>e.renderer.overrideNodes.modelViewMatrix||$R)).once()().toVar("modelViewMatrix"),$R=BR.mul(WR),YR=KM((e=>(e.context.isHighPrecisionModelViewMatrix=!0,rA("mat4").onObjectUpdate((({object:e,camera:t})=>e.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,e.matrixWorld)))))).once()().toVar("highpModelViewMatrix"),KR=KM((e=>{const t=e.context.isHighPrecisionModelViewMatrix;return rA("mat3").onObjectUpdate((({object:e,camera:n})=>(!0!==t&&e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix))))})).once()().toVar("highpModelNormalViewMatrix"),ZR=vR("position","vec3"),JR=ZR.toVarying("positionLocal"),QR=ZR.toVarying("positionPrevious"),eN=KM((e=>WR.mul(JR).xyz.toVarying(e.getNamespace("v_positionWorld"))),"vec3").once("POSITION")(),tN=KM((e=>JR.transformDirection(WR).toVarying(e.getNamespace("v_positionWorldDirection")).normalize().toVar("positionWorldDirection")),"vec3").once("POSITION")(),nN=KM((e=>e.context.setupPositionView().toVarying(e.getNamespace("v_positionView"))),"vec3").once("POSITION")(),iN=nN.negate().toVarying("v_positionViewDirection").normalize().toVar("positionViewDirection");class rN extends iM{static get type(){return"FrontFacingNode"}constructor(){super("bool"),this.isFrontFacingNode=!0}generate(e){const{renderer:t,material:n}=e;return t.coordinateSystem===gc&&1===n.side?"false":e.getFrontFacing()}}const sN=nE($M(rN)).mul(2).sub(1),oN=vR("normal","vec3"),aN=KM((e=>!1===e.geometry.hasAttribute("normal")?(console.warn('THREE.TSL: Vertex attribute "normal" not found on geometry.'),uE(0,1,0)):oN),"vec3").once()().toVar("normalLocal"),lN=nN.dFdx().cross(nN.dFdy()).normalize().toVar("normalFlat"),cN=KM((e=>{let t;return t=!0===e.material.flatShading?lN:HC(mN(aN),"v_normalView").normalize(),t}),"vec3").once()().toVar("normalView"),uN=KM((e=>{let t=cN.transformDirection(BR);return!0!==e.material.flatShading&&(t=HC(t,"v_normalWorld")),t}),"vec3").once()().normalize().toVar("normalWorld"),hN=KM((e=>{let t=e.context.setupNormal().context({getUV:null});return!0!==e.material.flatShading&&(t=t.mul(sN)),t}),"vec3").once()().toVar("transformedNormalView"),dN=hN.transformDirection(BR).toVar("transformedNormalWorld"),pN=KM((e=>{let t=e.context.setupClearcoatNormal().context({getUV:null});return!0!==e.material.flatShading&&(t=t.mul(sN)),t}),"vec3").once()().toVar("transformedClearcoatNormalView"),fN=KM((([e,t=WR])=>{const n=_E(t),i=e.div(uE(n[0].dot(n[0]),n[1].dot(n[1]),n[2].dot(n[2])));return n.mul(i).xyz})),mN=KM((([e],t)=>{const n=t.renderer.overrideNodes.modelNormalViewMatrix;if(null!==n)return n.transformDirection(e);const i=qR.mul(e);return BR.transformDirection(i)})),gN=new Hu,yN=new Iu,vN=rA(0).onReference((({material:e})=>e)).onObjectUpdate((({material:e})=>e.refractionRatio)),_N=rA(1).onReference((({material:e})=>e)).onObjectUpdate((function({material:e,scene:t}){return e.envMap?e.envMapIntensity:t.environmentIntensity})),xN=rA(new Iu).onReference((function(e){return e.material})).onObjectUpdate((function({material:e,scene:t}){const n=null!==t.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation;return n?(gN.copy(n),yN.makeRotationFromEuler(gN)):yN.identity(),yN})),bN=iN.negate().reflect(hN),wN=iN.negate().refract(hN,vN),TN=bN.transformDirection(BR).toVar("reflectVector"),SN=wN.transformDirection(BR).toVar("reflectVector"),MN=new Td;class EN extends MR{static get type(){return"CubeTextureNode"}constructor(e,t=null,n=null,i=null){super(e,t,n,i),this.isCubeTextureNode=!0}getInputType(){return"cubeTexture"}getDefaultUV(){const e=this.value;return e.mapping===Ba?TN:e.mapping===za?SN:(console.error('THREE.CubeTextureNode: Mapping "%s" not supported.',e.mapping),uE(0,0,0))}setUpdateMatrix(){}setupUV(e,t){const n=this.value;return e.renderer.coordinateSystem!==yc&&n.isRenderTargetTexture||(t=uE(t.x.negate(),t.yz)),xN.mul(t)}generateUV(e,t){return t.build(e,"vec3")}}const AN=XM(EN).setParameterLength(1,4).setName("cubeTexture"),CN=(e=MN,t=null,n=null,i=null)=>{let r;return e&&!0===e.isCubeTextureNode?(r=HM(e.clone()),r.referenceNode=e.getSelf(),null!==t&&(r.uvNode=HM(t)),null!==n&&(r.levelNode=HM(n)),null!==i&&(r.biasNode=HM(i))):r=AN(e,t,n,i),r};class RN extends rM{static get type(){return"ReferenceElementNode"}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){const t=super.generate(e),n=this.referenceNode.getNodeType(),i=this.getNodeType();return e.format(t,n,i)}}class NN extends iM{static get type(){return"ReferenceNode"}constructor(e,t,n=null,i=null){super(),this.property=e,this.uniformType=t,this.object=n,this.count=i,this.properties=e.split("."),this.reference=n,this.node=null,this.group=null,this.name=null,this.updateType=$S}element(e){return HM(new RN(this,HM(e)))}setGroup(e){return this.group=e,this}label(e){return this.name=e,this}setNodeType(e){let t=null;t=null!==this.count?NR(null,e,this.count):Array.isArray(this.getValueFromReference())?LR(null,e):"texture"===e?AR(null):"cubeTexture"===e?CN(null):rA(null,e),null!==this.group&&t.setGroup(this.group),null!==this.name&&t.label(this.name),this.node=t.getSelf()}getNodeType(e){return null===this.node&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){const{properties:t}=this;let n=e[t[0]];for(let e=1;e<t.length;e++)n=n[t[e]];return n}updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}}const PN=(e,t,n)=>HM(new NN(e,t,n)),DN=(e,t,n,i)=>HM(new NN(e,t,i,n));class LN extends NN{static get type(){return"MaterialReferenceNode"}constructor(e,t,n=null){super(e,t,n),this.material=n,this.isMaterialReferenceNode=!0}updateReference(e){return this.reference=null!==this.material?this.material:e.material,this.reference}}const IN=(e,t,n=null)=>HM(new LN(e,t,n)),kN=KM((e=>(!1===e.geometry.hasAttribute("tangent")&&e.geometry.computeTangents(),vR("tangent","vec4"))))(),ON=kN.xyz.toVar("tangentLocal"),UN=XR.mul(fE(ON,0)).xyz.toVarying("v_tangentView").normalize().toVar("tangentView"),FN=KM((([e,t],n)=>{let i=e.mul(kN.w).xyz;return!0!==n.material.flatShading&&(i=HC(i,t)),i})).once()(cN.cross(UN),"v_bitangentView").normalize().toVar("bitangentView"),BN=_E(UN,FN,cN),zN=(()=>{let e=FE.cross(iN);return e=e.cross(FE).normalize(),e=NC(e,hN,OE.mul(EE.oneMinus()).oneMinus().pow2().pow2()).normalize(),e})(),VN=KM((e=>{const{eye_pos:t,surf_norm:n,mapN:i,uv:r}=e,s=t.dFdx(),o=t.dFdy(),a=r.dFdx(),l=r.dFdy(),c=n,u=o.cross(c),h=c.cross(s),d=u.mul(a.x).add(h.mul(l.x)),p=u.mul(a.y).add(h.mul(l.y)),f=d.dot(d).max(p.dot(p)),m=sN.mul(f.inverseSqrt());return uA(d.mul(i.x,m),p.mul(i.y,m),c.mul(i.z)).normalize()}));class GN extends oM{static get type(){return"NormalMapNode"}constructor(e,t=null){super("vec3"),this.node=e,this.scaleNode=t,this.normalMapType=0}setup(e){const{normalMapType:t,scaleNode:n}=this;let i=this.node.mul(2).sub(1);null!==n&&(i=uE(i.xy.mul(n),i.z));let r=null;if(1===t)r=mN(i);else if(0===t){r=!0===e.hasGeometryAttribute("tangent")?BN.mul(i).normalize():VN({eye_pos:nN,surf_norm:cN,mapN:i,uv:_R()})}return r}}const jN=XM(GN).setParameterLength(1,2),HN=KM((({textureNode:e,bumpScale:t})=>{const n=t=>e.cache().context({getUV:e=>t(e.uvNode||_R()),forceUVContext:!0}),i=nE(n((e=>e)));return oE(nE(n((e=>e.add(e.dFdx())))).sub(i),nE(n((e=>e.add(e.dFdy())))).sub(i)).mul(t)})),WN=KM((e=>{const{surf_pos:t,surf_norm:n,dHdxy:i}=e,r=t.dFdx().normalize(),s=n,o=t.dFdy().normalize().cross(s),a=s.cross(r),l=r.dot(o).mul(sN),c=l.sign().mul(i.x.mul(o).add(i.y.mul(a)));return l.abs().mul(n).sub(c).normalize()}));class qN extends oM{static get type(){return"BumpMapNode"}constructor(e,t=null){super("vec3"),this.textureNode=e,this.scaleNode=t}setup(){const e=null!==this.scaleNode?this.scaleNode:1,t=HN({textureNode:this.textureNode,bumpScale:e});return WN({surf_pos:nN,surf_norm:cN,dHdxy:t})}}const XN=XM(qN).setParameterLength(1,2),$N=new Map;class YN extends iM{static get type(){return"MaterialNode"}constructor(e){super(),this.scope=e}getCache(e,t){let n=$N.get(e);return void 0===n&&(n=IN(e,t),$N.set(e,n)),n}getFloat(e){return this.getCache(e,"float")}getColor(e){return this.getCache(e,"color")}getTexture(e){return this.getCache("map"===e?"map":e+"Map","texture")}setup(e){const t=e.context.material,n=this.scope;let i=null;if(n===YN.COLOR){const e=void 0!==t.color?this.getColor(n):uE();i=t.map&&!0===t.map.isTexture?e.mul(this.getTexture("map")):e}else if(n===YN.OPACITY){const e=this.getFloat(n);i=t.alphaMap&&!0===t.alphaMap.isTexture?e.mul(this.getTexture("alpha")):e}else if(n===YN.SPECULAR_STRENGTH)i=t.specularMap&&!0===t.specularMap.isTexture?this.getTexture("specular").r:nE(1);else if(n===YN.SPECULAR_INTENSITY){const e=this.getFloat(n);i=t.specularIntensityMap&&!0===t.specularIntensityMap.isTexture?e.mul(this.getTexture(n).a):e}else if(n===YN.SPECULAR_COLOR){const e=this.getColor(n);i=t.specularColorMap&&!0===t.specularColorMap.isTexture?e.mul(this.getTexture(n).rgb):e}else if(n===YN.ROUGHNESS){const e=this.getFloat(n);i=t.roughnessMap&&!0===t.roughnessMap.isTexture?e.mul(this.getTexture(n).g):e}else if(n===YN.METALNESS){const e=this.getFloat(n);i=t.metalnessMap&&!0===t.metalnessMap.isTexture?e.mul(this.getTexture(n).b):e}else if(n===YN.EMISSIVE){const e=this.getFloat("emissiveIntensity"),r=this.getColor(n).mul(e);i=t.emissiveMap&&!0===t.emissiveMap.isTexture?r.mul(this.getTexture(n)):r}else if(n===YN.NORMAL)t.normalMap?(i=jN(this.getTexture("normal"),this.getCache("normalScale","vec2")),i.normalMapType=t.normalMapType):i=t.bumpMap?XN(this.getTexture("bump").r,this.getFloat("bumpScale")):cN;else if(n===YN.CLEARCOAT){const e=this.getFloat(n);i=t.clearcoatMap&&!0===t.clearcoatMap.isTexture?e.mul(this.getTexture(n).r):e}else if(n===YN.CLEARCOAT_ROUGHNESS){const e=this.getFloat(n);i=t.clearcoatRoughnessMap&&!0===t.clearcoatRoughnessMap.isTexture?e.mul(this.getTexture(n).r):e}else if(n===YN.CLEARCOAT_NORMAL)i=t.clearcoatNormalMap?jN(this.getTexture(n),this.getCache(n+"Scale","vec2")):cN;else if(n===YN.SHEEN){const e=this.getColor("sheenColor").mul(this.getFloat("sheen"));i=t.sheenColorMap&&!0===t.sheenColorMap.isTexture?e.mul(this.getTexture("sheenColor").rgb):e}else if(n===YN.SHEEN_ROUGHNESS){const e=this.getFloat(n);i=t.sheenRoughnessMap&&!0===t.sheenRoughnessMap.isTexture?e.mul(this.getTexture(n).a):e,i=i.clamp(.07,1)}else if(n===YN.ANISOTROPY)if(t.anisotropyMap&&!0===t.anisotropyMap.isTexture){const e=this.getTexture(n);i=vE(DP.x,DP.y,DP.y.negate(),DP.x).mul(e.rg.mul(2).sub(oE(1)).normalize().mul(e.b))}else i=DP;else if(n===YN.IRIDESCENCE_THICKNESS){const e=PN("1","float",t.iridescenceThicknessRange);if(t.iridescenceThicknessMap){const r=PN("0","float",t.iridescenceThicknessRange);i=e.sub(r).mul(this.getTexture(n).g).add(r)}else i=e}else if(n===YN.TRANSMISSION){const e=this.getFloat(n);i=t.transmissionMap?e.mul(this.getTexture(n).r):e}else if(n===YN.THICKNESS){const e=this.getFloat(n);i=t.thicknessMap?e.mul(this.getTexture(n).g):e}else if(n===YN.IOR)i=this.getFloat(n);else if(n===YN.LIGHT_MAP)i=this.getTexture(n).rgb.mul(this.getFloat("lightMapIntensity"));else if(n===YN.AO)i=this.getTexture(n).r.sub(1).mul(this.getFloat("aoMapIntensity")).add(1);else if(n===YN.LINE_DASH_OFFSET)i=t.dashOffset?this.getFloat(n):nE(0);else{const t=this.getNodeType(e);i=this.getCache(n,t)}return i}}YN.ALPHA_TEST="alphaTest",YN.COLOR="color",YN.OPACITY="opacity",YN.SHININESS="shininess",YN.SPECULAR="specular",YN.SPECULAR_STRENGTH="specularStrength",YN.SPECULAR_INTENSITY="specularIntensity",YN.SPECULAR_COLOR="specularColor",YN.REFLECTIVITY="reflectivity",YN.ROUGHNESS="roughness",YN.METALNESS="metalness",YN.NORMAL="normal",YN.CLEARCOAT="clearcoat",YN.CLEARCOAT_ROUGHNESS="clearcoatRoughness",YN.CLEARCOAT_NORMAL="clearcoatNormal",YN.EMISSIVE="emissive",YN.ROTATION="rotation",YN.SHEEN="sheen",YN.SHEEN_ROUGHNESS="sheenRoughness",YN.ANISOTROPY="anisotropy",YN.IRIDESCENCE="iridescence",YN.IRIDESCENCE_IOR="iridescenceIOR",YN.IRIDESCENCE_THICKNESS="iridescenceThickness",YN.IOR="ior",YN.TRANSMISSION="transmission",YN.THICKNESS="thickness",YN.ATTENUATION_DISTANCE="attenuationDistance",YN.ATTENUATION_COLOR="attenuationColor",YN.LINE_SCALE="scale",YN.LINE_DASH_SIZE="dashSize",YN.LINE_GAP_SIZE="gapSize",YN.LINE_WIDTH="linewidth",YN.LINE_DASH_OFFSET="dashOffset",YN.POINT_SIZE="size",YN.DISPERSION="dispersion",YN.LIGHT_MAP="light",YN.AO="ao";const KN=$M(YN,YN.ALPHA_TEST),ZN=$M(YN,YN.COLOR),JN=$M(YN,YN.SHININESS),QN=$M(YN,YN.EMISSIVE),eP=$M(YN,YN.OPACITY),tP=$M(YN,YN.SPECULAR),nP=$M(YN,YN.SPECULAR_INTENSITY),iP=$M(YN,YN.SPECULAR_COLOR),rP=$M(YN,YN.SPECULAR_STRENGTH),sP=$M(YN,YN.REFLECTIVITY),oP=$M(YN,YN.ROUGHNESS),aP=$M(YN,YN.METALNESS),lP=$M(YN,YN.NORMAL),cP=$M(YN,YN.CLEARCOAT),uP=$M(YN,YN.CLEARCOAT_ROUGHNESS),hP=$M(YN,YN.CLEARCOAT_NORMAL),dP=$M(YN,YN.ROTATION),pP=$M(YN,YN.SHEEN),fP=$M(YN,YN.SHEEN_ROUGHNESS),mP=$M(YN,YN.ANISOTROPY),gP=$M(YN,YN.IRIDESCENCE),yP=$M(YN,YN.IRIDESCENCE_IOR),vP=$M(YN,YN.IRIDESCENCE_THICKNESS),_P=$M(YN,YN.TRANSMISSION),xP=$M(YN,YN.THICKNESS),bP=$M(YN,YN.IOR),wP=$M(YN,YN.ATTENUATION_DISTANCE),TP=$M(YN,YN.ATTENUATION_COLOR),SP=$M(YN,YN.LINE_SCALE),MP=$M(YN,YN.LINE_DASH_SIZE),EP=$M(YN,YN.LINE_GAP_SIZE);YN.LINE_WIDTH;const AP=$M(YN,YN.LINE_DASH_OFFSET),CP=$M(YN,YN.POINT_SIZE),RP=$M(YN,YN.DISPERSION),NP=$M(YN,YN.LIGHT_MAP),PP=$M(YN,YN.AO),DP=rA(new Nc).onReference((function(e){return e.material})).onRenderUpdate((function({material:e}){this.value.set(e.anisotropy*Math.cos(e.anisotropyRotation),e.anisotropy*Math.sin(e.anisotropyRotation))})),LP=KM((e=>e.context.setupModelViewProjection()),"vec4").once()().toVarying("v_modelViewProjection");class IP extends iM{static get type(){return"IndexNode"}constructor(e){super("uint"),this.scope=e,this.isIndexNode=!0}generate(e){const t=this.getNodeType(e),n=this.scope;let i,r;if(n===IP.VERTEX)i=e.getVertexIndex();else if(n===IP.INSTANCE)i=e.getInstanceIndex();else if(n===IP.DRAW)i=e.getDrawIndex();else if(n===IP.INVOCATION_LOCAL)i=e.getInvocationLocalIndex();else if(n===IP.INVOCATION_SUBGROUP)i=e.getInvocationSubgroupIndex();else{if(n!==IP.SUBGROUP)throw new Error("THREE.IndexNode: Unknown scope: "+n);i=e.getSubgroupIndex()}if("vertex"===e.shaderStage||"compute"===e.shaderStage)r=i;else{r=HC(this).build(e,t)}return r}}IP.VERTEX="vertex",IP.INSTANCE="instance",IP.SUBGROUP="subgroup",IP.INVOCATION_LOCAL="invocationLocal",IP.INVOCATION_SUBGROUP="invocationSubgroup",IP.DRAW="draw";const kP=$M(IP,IP.VERTEX),OP=$M(IP,IP.INSTANCE);IP.SUBGROUP,IP.INVOCATION_SUBGROUP,IP.INVOCATION_LOCAL;const UP=$M(IP,IP.DRAW);class FP extends iM{static get type(){return"InstanceNode"}constructor(e,t,n=null){super("void"),this.count=e,this.instanceMatrix=t,this.instanceColor=n,this.instanceMatrixNode=null,this.instanceColorNode=null,this.updateType=qS,this.buffer=null,this.bufferColor=null}setup(e){const{count:t,instanceMatrix:n,instanceColor:i}=this;let{instanceMatrixNode:r,instanceColorNode:s}=this;if(null===r){if(t<=1e3)r=NR(n.array,"mat4",Math.max(t,1)).element(OP);else{const e=new lf(n.array,16,1);this.buffer=e;const t=n.usage===fc?sR:rR,i=[t(e,"vec4",16,0),t(e,"vec4",16,4),t(e,"vec4",16,8),t(e,"vec4",16,12)];r=xE(...i)}this.instanceMatrixNode=r}if(i&&null===s){const e=new Id(i.array,3),t=i.usage===fc?sR:rR;this.bufferColor=e,s=uE(t(e,"vec3",3,0)),this.instanceColorNode=s}const o=r.mul(JR).xyz;if(JR.assign(o),e.hasGeometryAttribute("normal")){const e=fN(aN,r);aN.assign(e)}null!==this.instanceColorNode&&TE("vec3","vInstanceColor").assign(this.instanceColorNode)}update(){this.instanceMatrix.usage!==fc&&null!==this.buffer&&this.instanceMatrix.version!==this.buffer.version&&(this.buffer.version=this.instanceMatrix.version),this.instanceColor&&this.instanceColor.usage!==fc&&null!==this.bufferColor&&this.instanceColor.version!==this.bufferColor.version&&(this.bufferColor.version=this.instanceColor.version)}}class BP extends FP{static get type(){return"InstancedMeshNode"}constructor(e){const{count:t,instanceMatrix:n,instanceColor:i}=e;super(t,n,i),this.instancedMesh=e}}const zP=XM(BP).setParameterLength(1);class VP extends iM{static get type(){return"BatchNode"}constructor(e){super("void"),this.batchMesh=e,this.batchingIdNode=null}setup(e){null===this.batchingIdNode&&(null===e.getDrawIndex()?this.batchingIdNode=OP:this.batchingIdNode=UP);const t=KM((([e])=>{const t=iE(bR(CR(this.batchMesh._indirectTexture),0).x),n=iE(e).mod(t),i=iE(e).div(t);return CR(this.batchMesh._indirectTexture,aE(n,i)).x})).setLayout({name:"getIndirectIndex",type:"uint",inputs:[{name:"id",type:"int"}]}),n=t(iE(this.batchingIdNode)),i=this.batchMesh._matricesTexture,r=iE(bR(CR(i),0).x),s=nE(n).mul(4).toInt().toVar(),o=s.mod(r),a=s.div(r),l=xE(CR(i,aE(o,a)),CR(i,aE(o.add(1),a)),CR(i,aE(o.add(2),a)),CR(i,aE(o.add(3),a))),c=this.batchMesh._colorsTexture;if(null!==c){const e=KM((([e])=>{const t=iE(bR(CR(c),0).x),n=e,i=n.mod(t),r=n.div(t);return CR(c,aE(i,r)).rgb})).setLayout({name:"getBatchingColor",type:"vec3",inputs:[{name:"id",type:"int"}]}),t=e(n);TE("vec3","vBatchColor").assign(t)}const u=_E(l);JR.assign(l.mul(JR));const h=aN.div(uE(u[0].dot(u[0]),u[1].dot(u[1]),u[2].dot(u[2]))),d=u.mul(h).xyz;aN.assign(d),e.hasGeometryAttribute("tangent")&&ON.mulAssign(u)}}const GP=XM(VP).setParameterLength(1),jP=new WeakMap;class HP extends iM{static get type(){return"SkinningNode"}constructor(e){super("void"),this.skinnedMesh=e,this.updateType=$S,this.skinIndexNode=vR("skinIndex","uvec4"),this.skinWeightNode=vR("skinWeight","vec4"),this.bindMatrixNode=PN("bindMatrix","mat4"),this.bindMatrixInverseNode=PN("bindMatrixInverse","mat4"),this.boneMatricesNode=DN("skeleton.boneMatrices","mat4",e.skeleton.bones.length),this.positionNode=JR,this.toPositionNode=JR,this.previousBoneMatricesNode=null}getSkinnedPosition(e=this.boneMatricesNode,t=this.positionNode){const{skinIndexNode:n,skinWeightNode:i,bindMatrixNode:r,bindMatrixInverseNode:s}=this,o=e.element(n.x),a=e.element(n.y),l=e.element(n.z),c=e.element(n.w),u=r.mul(t),h=uA(o.mul(i.x).mul(u),a.mul(i.y).mul(u),l.mul(i.z).mul(u),c.mul(i.w).mul(u));return s.mul(h).xyz}getSkinnedNormal(e=this.boneMatricesNode,t=aN){const{skinIndexNode:n,skinWeightNode:i,bindMatrixNode:r,bindMatrixInverseNode:s}=this,o=e.element(n.x),a=e.element(n.y),l=e.element(n.z),c=e.element(n.w);let u=uA(i.x.mul(o),i.y.mul(a),i.z.mul(l),i.w.mul(c));return u=s.mul(u).mul(r),u.transformDirection(t).xyz}getPreviousSkinnedPosition(e){const t=e.object;return null===this.previousBoneMatricesNode&&(t.skeleton.previousBoneMatrices=new Float32Array(t.skeleton.boneMatrices),this.previousBoneMatricesNode=DN("skeleton.previousBoneMatrices","mat4",t.skeleton.bones.length)),this.getSkinnedPosition(this.previousBoneMatricesNode,QR)}needsPreviousBoneMatrices(e){const t=e.renderer.getMRT();return t&&t.has("velocity")||!0===jS(e.object).useVelocity}setup(e){this.needsPreviousBoneMatrices(e)&&QR.assign(this.getPreviousSkinnedPosition(e));const t=this.getSkinnedPosition();if(this.toPositionNode&&this.toPositionNode.assign(t),e.hasGeometryAttribute("normal")){const t=this.getSkinnedNormal();aN.assign(t),e.hasGeometryAttribute("tangent")&&ON.assign(t)}return t}generate(e,t){if("void"!==t)return super.generate(e,t)}update(e){const t=e.object&&e.object.skeleton?e.object.skeleton:this.skinnedMesh.skeleton;jP.get(t)!==e.frameId&&(jP.set(t,e.frameId),null!==this.previousBoneMatricesNode&&t.previousBoneMatrices.set(t.boneMatrices),t.update())}}class WP extends iM{static get type(){return"LoopNode"}constructor(e=[]){super(),this.params=e}getVarName(e){return String.fromCharCode("i".charCodeAt(0)+e)}getProperties(e){const t=e.getNodeProperties(this);if(void 0!==t.stackNode)return t;const n={};for(let e=0,t=this.params.length-1;e<t;e++){const t=this.params[e],i=!0!==t.isNode&&t.name||this.getVarName(e),r=!0!==t.isNode&&t.type||"int";n[i]=fR(i,r)}const i=e.addStack();t.returnsNode=this.params[this.params.length-1](n,e),t.stackNode=i;const r=this.params[0];return!0!==r.isNode&&"function"==typeof r.update&&(t.updateNode=KM(this.params[0].update)(n)),e.removeStack(),t}getNodeType(e){const{returnsNode:t}=this.getProperties(e);return t?t.getNodeType(e):"void"}setup(e){this.getProperties(e)}generate(e){const t=this.getProperties(e),n=this.params,i=t.stackNode;for(let i=0,r=n.length-1;i<r;i++){const r=n[i];let s,o=!1,a=null,l=null,c=null,u=null,h=null,d=null;if(r.isNode?"bool"===r.getNodeType(e)?(o=!0,u="bool",l=r.build(e,u)):(u="int",c=this.getVarName(i),a="0",l=r.build(e,u),h="<"):(u=r.type||"int",c=r.name||this.getVarName(i),a=r.start,l=r.end,h=r.condition,d=r.update,"number"==typeof a?a=e.generateConst(u,a):a&&a.isNode&&(a=a.build(e,u)),"number"==typeof l?l=e.generateConst(u,l):l&&l.isNode&&(l=l.build(e,u)),void 0!==a&&void 0===l?(a+=" - 1",l="0",h=">="):void 0!==l&&void 0===a&&(a="0",h="<"),void 0===h&&(h=Number(a)>Number(l)?">=":"<")),o)s=`while ( ${l} )`;else{const n={start:a,end:l},i=n.start,r=n.end;let o;const p=()=>h.includes("<")?"+=":"-=";if(null!=d)switch(typeof d){case"function":o=e.flowStagesNode(t.updateNode,"void").code.replace(/\t|;/g,"");break;case"number":o=c+" "+p()+" "+e.generateConst(u,d);break;case"string":o=c+" "+d;break;default:d.isNode?o=c+" "+p()+" "+d.build(e):(console.error("THREE.TSL: 'Loop( { update: ... } )' is not a function, string or number."),o="break /* invalid update */")}else d="int"===u||"uint"===u?h.includes("<")?"++":"--":p()+" 1.",o=c+" "+d;s=`for ( ${e.getVar(u,c)+" = "+i}; ${c+" "+h+" "+r}; ${o} )`}e.addFlowCode((0===i?"\n":"")+e.tab+s+" {\n\n").addFlowTab()}const r=i.build(e,"void"),s=t.returnsNode?t.returnsNode.build(e):"";e.removeFlowTab().addFlowCode("\n"+e.tab+r);for(let t=0,n=this.params.length-1;t<n;t++)e.addFlowCode((0===t?"":e.tab)+"}\n\n").removeFlowTab();return e.addFlowTab(),s}}const qP=(...e)=>HM(new WP(qM(e,"int"))).toStack(),XP=new WeakMap,$P=new nu,YP=KM((({bufferMap:e,influence:t,stride:n,width:i,depth:r,offset:s})=>{const o=iE(kP).mul(n).add(s),a=o.div(i),l=o.sub(a.mul(i));return CR(e,aE(l,a)).depth(r).xyz.mul(t)}));class KP extends iM{static get type(){return"MorphNode"}constructor(e){super("void"),this.mesh=e,this.morphBaseInfluence=rA(1),this.updateType=$S}setup(e){const{geometry:t}=e,n=void 0!==t.morphAttributes.position,i=t.hasAttribute("normal")&&void 0!==t.morphAttributes.normal,r=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,s=void 0!==r?r.length:0,{texture:o,stride:a,size:l}=function(e){const t=void 0!==e.morphAttributes.position,n=void 0!==e.morphAttributes.normal,i=void 0!==e.morphAttributes.color,r=e.morphAttributes.position||e.morphAttributes.normal||e.morphAttributes.color,s=void 0!==r?r.length:0;let o=XP.get(e);if(void 0===o||o.count!==s){void 0!==o&&o.texture.dispose();const a=e.morphAttributes.position||[],l=e.morphAttributes.normal||[],c=e.morphAttributes.color||[];let u=0;!0===t&&(u=1),!0===n&&(u=2),!0===i&&(u=3);let h=e.attributes.position.count*u,d=1;const p=4096;h>p&&(d=Math.ceil(h/p),h=p);const f=new Float32Array(h*d*4*s),m=new su(f,h,d,s);m.type=sl,m.needsUpdate=!0;const g=4*u;for(let v=0;v<s;v++){const _=a[v],x=l[v],b=c[v],w=h*d*4*v;for(let T=0;T<_.count;T++){const S=T*g;!0===t&&($P.fromBufferAttribute(_,T),f[w+S+0]=$P.x,f[w+S+1]=$P.y,f[w+S+2]=$P.z,f[w+S+3]=0),!0===n&&($P.fromBufferAttribute(x,T),f[w+S+4]=$P.x,f[w+S+5]=$P.y,f[w+S+6]=$P.z,f[w+S+7]=0),!0===i&&($P.fromBufferAttribute(b,T),f[w+S+8]=$P.x,f[w+S+9]=$P.y,f[w+S+10]=$P.z,f[w+S+11]=4===b.itemSize?$P.w:1)}}function y(){m.dispose(),XP.delete(e),e.removeEventListener("dispose",y)}o={count:s,texture:m,stride:u,size:new Nc(h,d)},XP.set(e,o),e.addEventListener("dispose",y)}return o}(t);!0===n&&JR.mulAssign(this.morphBaseInfluence),!0===i&&aN.mulAssign(this.morphBaseInfluence);const c=iE(l.width);qP(s,(({i:e})=>{const t=nE(0).toVar();this.mesh.count>1&&null!==this.mesh.morphTexture&&void 0!==this.mesh.morphTexture?t.assign(CR(this.mesh.morphTexture,aE(iE(e).add(1),iE(OP))).r):t.assign(PN("morphTargetInfluences","float").element(e).toVar()),QM(t.notEqual(0),(()=>{!0===n&&JR.addAssign(YP({bufferMap:o,influence:t,stride:a,width:c,depth:e,offset:iE(0)})),!0===i&&aN.addAssign(YP({bufferMap:o,influence:t,stride:a,width:c,depth:e,offset:iE(1)}))}))}))}update(){const e=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?e.value=1:e.value=1-this.mesh.morphTargetInfluences.reduce(((e,t)=>e+t),0)}}const ZP=XM(KP).setParameterLength(1);class JP extends iM{static get type(){return"LightingNode"}constructor(){super("vec3"),this.isLightingNode=!0}}class QP extends JP{static get type(){return"AONode"}constructor(e=null){super(),this.aoNode=e}setup(e){e.context.ambientOcclusion.mulAssign(this.aoNode)}}class eD extends BC{static get type(){return"LightingContextNode"}constructor(e,t=null,n=null,i=null){super(e),this.lightingModel=t,this.backdropNode=n,this.backdropAlphaNode=i,this._value=null}getContext(){const{backdropNode:e,backdropAlphaNode:t}=this,n={directDiffuse:uE().toVar("directDiffuse"),directSpecular:uE().toVar("directSpecular"),indirectDiffuse:uE().toVar("indirectDiffuse"),indirectSpecular:uE().toVar("indirectSpecular")};return{radiance:uE().toVar("radiance"),irradiance:uE().toVar("irradiance"),iblIrradiance:uE().toVar("iblIrradiance"),ambientOcclusion:nE(1).toVar("ambientOcclusion"),reflectedLight:n,backdrop:e,backdropAlpha:t}}setup(e){return this.value=this._value||(this._value=this.getContext()),this.value.lightingModel=this.lightingModel||e.context.lightingModel,super.setup(e)}}const tD=XM(eD);class nD extends JP{static get type(){return"IrradianceNode"}constructor(e){super(),this.node=e}setup(e){e.context.irradiance.addAssign(this.node)}}let iD,rD;class sD extends iM{static get type(){return"ScreenNode"}constructor(e){super(),this.scope=e,this.isViewportNode=!0}getNodeType(){return this.scope===sD.VIEWPORT?"vec4":"vec2"}getUpdateType(){let e=WS;return this.scope!==sD.SIZE&&this.scope!==sD.VIEWPORT||(e=XS),this.updateType=e,e}update({renderer:e}){const t=e.getRenderTarget();this.scope===sD.VIEWPORT?null!==t?rD.copy(t.viewport):(e.getViewport(rD),rD.multiplyScalar(e.getPixelRatio())):null!==t?(iD.width=t.width,iD.height=t.height):e.getDrawingBufferSize(iD)}setup(){const e=this.scope;let t=null;return t=e===sD.SIZE?rA(iD||(iD=new Nc)):e===sD.VIEWPORT?rA(rD||(rD=new nu)):oE(lD.div(aD)),t}generate(e){if(this.scope===sD.COORDINATE){let t=e.getFragCoord();if(e.isFlipY()){const n=e.getNodeProperties(aD).outputNode.build(e);t=`${e.getType("vec2")}( ${t}.x, ${n}.y - ${t}.y )`}return t}return super.generate(e)}}sD.COORDINATE="coordinate",sD.VIEWPORT="viewport",sD.SIZE="size",sD.UV="uv";const oD=$M(sD,sD.UV),aD=$M(sD,sD.SIZE),lD=$M(sD,sD.COORDINATE),cD=$M(sD,sD.VIEWPORT);cD.zw,cD.xy;const uD=new Nc;class hD extends MR{static get type(){return"ViewportTextureNode"}constructor(e=oD,t=null,n=null){null===n&&((n=new np).minFilter=Ja),super(n,e,t),this.generateMipmaps=!1,this.isOutputTextureNode=!0,this.updateBeforeType=qS}updateBefore(e){const t=e.renderer;t.getDrawingBufferSize(uD);const n=this.value;n.image.width===uD.width&&n.image.height===uD.height||(n.image.width=uD.width,n.image.height=uD.height,n.needsUpdate=!0);const i=n.generateMipmaps;n.generateMipmaps=this.generateMipmaps,t.copyFramebufferToTexture(n),n.generateMipmaps=i}clone(){const e=new this.constructor(this.uvNode,this.levelNode,this.value);return e.generateMipmaps=this.generateMipmaps,e}}const dD=XM(hD,null,null,{generateMipmaps:!0}).setParameterLength(0,3);let pD=null;class fD extends hD{static get type(){return"ViewportDepthTextureNode"}constructor(e=oD,t=null){null===pD&&(pD=new ip),super(e,t,pD)}}const mD=XM(fD).setParameterLength(0,2);class gD extends iM{static get type(){return"ViewportDepthNode"}constructor(e,t=null){super("float"),this.scope=e,this.valueNode=t,this.isViewportDepthNode=!0}generate(e){const{scope:t}=this;return t===gD.DEPTH_BASE?e.getFragDepth():super.generate(e)}setup({camera:e}){const{scope:t}=this,n=this.valueNode;let i=null;if(t===gD.DEPTH_BASE)null!==n&&(i=bD().assign(n));else if(t===gD.DEPTH)i=e.isPerspectiveCamera?vD(nN.z,OR,UR):yD(nN.z,OR,UR);else if(t===gD.LINEAR_DEPTH)if(null!==n)if(e.isPerspectiveCamera){const e=_D(n,OR,UR);i=yD(e,OR,UR)}else i=n;else i=yD(nN.z,OR,UR);return i}}gD.DEPTH_BASE="depthBase",gD.DEPTH="depth",gD.LINEAR_DEPTH="linearDepth";const yD=(e,t,n)=>e.add(t).div(t.sub(n)),vD=(e,t,n)=>t.add(e).mul(n).div(n.sub(t).mul(e)),_D=(e,t,n)=>t.mul(n).div(n.sub(t).mul(e).sub(n)),xD=(e,t,n)=>{t=t.max(1e-6).toVar();const i=WA(e.negate().div(t)),r=WA(n.div(t));return i.div(r)},bD=XM(gD,gD.DEPTH_BASE),wD=$M(gD,gD.DEPTH);mD(),wD.assign=e=>bD(e);class TD extends iM{static get type(){return"ClippingNode"}constructor(e=TD.DEFAULT){super(),this.scope=e}setup(e){super.setup(e);const t=e.clippingContext,{intersectionPlanes:n,unionPlanes:i}=t;return this.hardwareClipping=e.material.hardwareClipping,this.scope===TD.ALPHA_TO_COVERAGE?this.setupAlphaToCoverage(n,i):this.scope===TD.HARDWARE?this.setupHardwareClipping(i,e):this.setupDefault(n,i)}setupAlphaToCoverage(e,t){return KM((()=>{const n=nE().toVar("distanceToPlane"),i=nE().toVar("distanceToGradient"),r=nE(1).toVar("clipOpacity"),s=t.length;if(!1===this.hardwareClipping&&s>0){const e=LR(t);qP(s,(({i:t})=>{const s=e.element(t);n.assign(nN.dot(s.xyz).negate().add(s.w)),i.assign(n.fwidth().div(2)),r.mulAssign(IC(i.negate(),i,n))}))}const o=e.length;if(o>0){const t=LR(e),s=nE(1).toVar("intersectionClipOpacity");qP(o,(({i:e})=>{const r=t.element(e);n.assign(nN.dot(r.xyz).negate().add(r.w)),i.assign(n.fwidth().div(2)),s.mulAssign(IC(i.negate(),i,n).oneMinus())})),r.mulAssign(s.oneMinus())}SE.a.mulAssign(r),SE.a.equal(0).discard()}))()}setupDefault(e,t){return KM((()=>{const n=t.length;if(!1===this.hardwareClipping&&n>0){const e=LR(t);qP(n,(({i:t})=>{const n=e.element(t);nN.dot(n.xyz).greaterThan(n.w).discard()}))}const i=e.length;if(i>0){const t=LR(e),n=sE(!0).toVar("clipped");qP(i,(({i:e})=>{const i=t.element(e);n.assign(nN.dot(i.xyz).greaterThan(i.w).and(n))})),n.discard()}}))()}setupHardwareClipping(e,t){const n=e.length;return t.enableHardwareClipping(n),KM((()=>{const i=LR(e),r=IR(t.getClipDistance());qP(n,(({i:e})=>{const t=i.element(e),n=nN.dot(t.xyz).sub(t.w).negate();r.element(e).assign(n)}))}))()}}TD.ALPHA_TO_COVERAGE="alphaToCoverage",TD.DEFAULT="default",TD.HARDWARE="hardware";const SD=KM((([e])=>ZA(dA(1e4,JA(dA(17,e.x).add(dA(.1,e.y)))).mul(uA(.1,rC(JA(dA(13,e.y).add(e.x)))))))),MD=KM((([e])=>SD(oE(SD(e.xy),e.z)))),ED=KM((([e])=>{const t=yC(oC(cC(e.xyz)),oC(uC(e.xyz))),n=nE(1).div(nE(.05).mul(t)).toVar("pixScale"),i=oE(jA($A(WA(n))),jA(YA(WA(n)))),r=oE(MD($A(i.x.mul(e.xyz))),MD($A(i.y.mul(e.xyz)))),s=ZA(WA(n)),o=uA(dA(s.oneMinus(),r.x),dA(s,r.y)),a=gC(s,s.oneMinus()),l=uE(o.mul(o).div(dA(2,a).mul(hA(1,a))),o.sub(dA(.5,a)).div(hA(1,a)),hA(1,hA(1,o).mul(hA(1,o)).div(dA(2,a).mul(hA(1,a))))),c=o.lessThan(a.oneMinus()).select(o.lessThan(a).select(l.x,l.y),l.z);return PC(c,1e-6,1)})).setLayout({name:"getAlphaHashThreshold",type:"float",inputs:[{name:"position",type:"vec3"}]});class AD extends yR{static get type(){return"VertexColorNode"}constructor(e){super(null,"vec4"),this.isVertexColorNode=!0,this.index=e}getAttributeName(){const e=this.index;return"color"+(e>0?e:"")}generate(e){const t=this.getAttributeName(e);let n;return n=!0===e.hasGeometryAttribute(t)?super.generate(e):e.generateConst(this.nodeType,new nu(1,1,1,1)),n}serialize(e){super.serialize(e),e.index=this.index}deserialize(e){super.deserialize(e),this.index=e.index}}class CD extends Rh{static get type(){return"NodeMaterial"}get type(){return this.constructor.type}set type(e){}constructor(){super(),this.isNodeMaterial=!0,this.fog=!0,this.lights=!1,this.hardwareClipping=!1,this.lightsNode=null,this.envNode=null,this.aoNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.maskNode=null,this.positionNode=null,this.geometryNode=null,this.depthNode=null,this.receivedShadowPositionNode=null,this.castShadowPositionNode=null,this.receivedShadowNode=null,this.castShadowNode=null,this.outputNode=null,this.mrtNode=null,this.fragmentNode=null,this.vertexNode=null,Object.defineProperty(this,"shadowPositionNode",{get:()=>this.receivedShadowPositionNode,set:e=>{console.warn('THREE.NodeMaterial: ".shadowPositionNode" was renamed to ".receivedShadowPositionNode".'),this.receivedShadowPositionNode=e}})}customProgramCacheKey(){return this.type+US(this)}build(e){this.setup(e)}setupObserver(e){return new LS(e)}setup(e){e.context.setupNormal=()=>this.setupNormal(e),e.context.setupPositionView=()=>this.setupPositionView(e),e.context.setupModelViewProjection=()=>this.setupModelViewProjection(e);const t=e.renderer,n=t.getRenderTarget();e.addStack();const i=this.setupVertex(e),r=this.vertexNode||i;let s;e.stack.outputNode=r,this.setupHardwareClipping(e),null!==this.geometryNode&&(e.stack.outputNode=e.stack.outputNode.bypass(this.geometryNode)),e.addFlow("vertex",e.removeStack()),e.addStack();const o=this.setupClipping(e);if(!0!==this.depthWrite&&!0!==this.depthTest||(null!==n?!0===n.depthBuffer&&this.setupDepth(e):!0===t.depth&&this.setupDepth(e)),null===this.fragmentNode){this.setupDiffuseColor(e),this.setupVariants(e);const i=this.setupLighting(e);null!==o&&e.stack.add(o);const r=fE(i,SE.a).max(0);s=this.setupOutput(e,r),GE.assign(s);const a=null!==this.outputNode;if(a&&(s=this.outputNode),null!==n){const e=t.getMRT(),n=this.mrtNode;null!==e?(a&&GE.assign(s),s=e,null!==n&&(s=e.merge(n))):null!==n&&(s=n)}}else{let t=this.fragmentNode;!0!==t.isOutputStructNode&&(t=fE(t)),s=this.setupOutput(e,t)}e.stack.outputNode=s,e.addFlow("fragment",e.removeStack()),e.observer=this.setupObserver(e)}setupClipping(e){if(null===e.clippingContext)return null;const{unionPlanes:t,intersectionPlanes:n}=e.clippingContext;let i=null;if(t.length>0||n.length>0){const t=e.renderer.samples;this.alphaToCoverage&&t>1?i=HM(new TD(TD.ALPHA_TO_COVERAGE)):e.stack.add(HM(new TD))}return i}setupHardwareClipping(e){if(this.hardwareClipping=!1,null===e.clippingContext)return;const t=e.clippingContext.unionPlanes.length;t>0&&t<=8&&e.isAvailable("clipDistance")&&(e.stack.add(HM(new TD(TD.HARDWARE))),this.hardwareClipping=!0)}setupDepth(e){const{renderer:t,camera:n}=e;let i=this.depthNode;if(null===i){const e=t.getMRT();e&&e.has("depth")?i=e.get("depth"):!0===t.logarithmicDepthBuffer&&(i=n.isPerspectiveCamera?xD(nN.z,OR,UR):yD(nN.z,OR,UR))}null!==i&&wD.assign(i).toStack()}setupPositionView(){return XR.mul(JR).xyz}setupModelViewProjection(){return FR.mul(nN)}setupVertex(e){return e.addStack(),this.setupPosition(e),e.context.vertex=e.removeStack(),LP}setupPosition(e){const{object:t,geometry:n}=e;var i;if((n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color)&&ZP(t).toStack(),!0===t.isSkinnedMesh&&(i=t,HM(new HP(i))).toStack(),this.displacementMap){const e=IN("displacementMap","texture"),t=IN("displacementScale","float"),n=IN("displacementBias","float");JR.addAssign(aN.normalize().mul(e.x.mul(t).add(n)))}return t.isBatchedMesh&&GP(t).toStack(),t.isInstancedMesh&&t.instanceMatrix&&!0===t.instanceMatrix.isInstancedBufferAttribute&&zP(t).toStack(),null!==this.positionNode&&JR.assign(((e,t)=>e.context({namespace:t}))(this.positionNode,"POSITION")),JR}setupDiffuseColor({object:e,geometry:t}){null!==this.maskNode&&sE(this.maskNode).not().discard();let n=this.colorNode?fE(this.colorNode):ZN;if(!0===this.vertexColors&&t.hasAttribute("color")&&(n=n.mul(((e=0)=>HM(new AD(e)))())),e.instanceColor){n=TE("vec3","vInstanceColor").mul(n)}if(e.isBatchedMesh&&e._colorsTexture){n=TE("vec3","vBatchColor").mul(n)}SE.assign(n);const i=this.opacityNode?nE(this.opacityNode):eP;SE.a.assign(SE.a.mul(i));let r=null;(null!==this.alphaTestNode||this.alphaTest>0)&&(r=null!==this.alphaTestNode?nE(this.alphaTestNode):KN,SE.a.lessThanEqual(r).discard()),!0===this.alphaHash&&SE.a.lessThan(ED(JR)).discard();!1===this.transparent&&1===this.blending&&!1===this.alphaToCoverage?SE.a.assign(1):null===r&&SE.a.lessThanEqual(0).discard()}setupVariants(){}setupOutgoingLight(){return!0===this.lights?uE(0):SE.rgb}setupNormal(){return this.normalNode?uE(this.normalNode):lP}setupEnvironment(){let e=null;return this.envNode?e=this.envNode:this.envMap&&(e=this.envMap.isCubeTexture?IN("envMap","cubeTexture"):IN("envMap","texture")),e}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new nD(NP)),t}setupLights(e){const t=[],n=this.setupEnvironment(e);n&&n.isLightingNode&&t.push(n);const i=this.setupLightMap(e);if(i&&i.isLightingNode&&t.push(i),null!==this.aoNode||e.material.aoMap){const e=null!==this.aoNode?this.aoNode:PP;t.push(new QP(e))}let r=this.lightsNode||e.lightsNode;return t.length>0&&(r=e.renderer.lighting.createNode([...r.getLights(),...t])),r}setupLightingModel(){}setupLighting(e){const{material:t}=e,{backdropNode:n,backdropAlphaNode:i,emissiveNode:r}=this,s=!0===this.lights||null!==this.lightsNode?this.setupLights(e):null;let o=this.setupOutgoingLight(e);if(s&&s.getScope().hasLights){const t=this.setupLightingModel(e)||null;o=tD(s,t,n,i)}else null!==n&&(o=uE(null!==i?NC(o,n,i):n));return(r&&!0===r.isNode||t.emissive&&!0===t.emissive.isColor)&&(ME.assign(uE(r||QN)),o=o.add(ME)),o}setupFog(e,t){const n=e.fogNode;return n&&(GE.assign(t),t=fE(n)),t}setupOutput(e,t){return!0===this.fog&&(t=this.setupFog(e,t)),t}setDefaultValues(e){for(const t in e){const n=e[t];void 0===this[t]&&(this[t]=n,n&&n.clone&&(this[t]=n.clone()))}const t=Object.getOwnPropertyDescriptors(e.constructor.prototype);for(const e in t)void 0===Object.getOwnPropertyDescriptor(this.constructor.prototype,e)&&void 0!==t[e].get&&Object.defineProperty(this.constructor.prototype,e,t[e])}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{},nodes:{}});const n=Rh.prototype.toJSON.call(this,e),i=FS(this);n.inputNodes={};for(const{property:t,childNode:r}of i)n.inputNodes[t]=r.toJSON(e).uuid;function r(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}if(t){const t=r(e.textures),i=r(e.images),s=r(e.nodes);t.length>0&&(n.textures=t),i.length>0&&(n.images=i),s.length>0&&(n.nodes=s)}return n}copy(e){return this.lightsNode=e.lightsNode,this.envNode=e.envNode,this.colorNode=e.colorNode,this.normalNode=e.normalNode,this.opacityNode=e.opacityNode,this.backdropNode=e.backdropNode,this.backdropAlphaNode=e.backdropAlphaNode,this.alphaTestNode=e.alphaTestNode,this.maskNode=e.maskNode,this.positionNode=e.positionNode,this.geometryNode=e.geometryNode,this.depthNode=e.depthNode,this.receivedShadowPositionNode=e.receivedShadowPositionNode,this.castShadowPositionNode=e.castShadowPositionNode,this.receivedShadowNode=e.receivedShadowNode,this.castShadowNode=e.castShadowNode,this.outputNode=e.outputNode,this.mrtNode=e.mrtNode,this.fragmentNode=e.fragmentNode,this.vertexNode=e.vertexNode,super.copy(e)}}const RD=new Wd;class ND extends CD{static get type(){return"LineBasicNodeMaterial"}constructor(e){super(),this.isLineBasicNodeMaterial=!0,this.setDefaultValues(RD),this.setValues(e)}}const PD=new Dp;class DD extends CD{static get type(){return"LineDashedNodeMaterial"}constructor(e){super(),this.isLineDashedNodeMaterial=!0,this.setDefaultValues(PD),this.dashOffset=0,this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setValues(e)}setupVariants(){const e=this.offsetNode?nE(this.offsetNode):AP,t=this.dashScaleNode?nE(this.dashScaleNode):SP,n=this.dashSizeNode?nE(this.dashSizeNode):MP,i=this.gapSizeNode?nE(this.gapSizeNode):EP;jE.assign(n),HE.assign(i);const r=HC(vR("lineDistance").mul(t));(e?r.add(e):r).mod(jE.add(HE)).greaterThan(jE).discard()}}const LD=new Ap;class ID extends CD{static get type(){return"MeshNormalNodeMaterial"}constructor(e){super(),this.isMeshNormalNodeMaterial=!0,this.setDefaultValues(LD),this.setValues(e)}setupDiffuseColor(){const e=this.opacityNode?nE(this.opacityNode):eP;SE.assign(YC(fE(HM(hN).mul(.5).add(.5),e),ec))}}class kD extends oM{static get type(){return"EquirectUVNode"}constructor(e=tN){super("vec2"),this.dirNode=e}setup(){const e=this.dirNode,t=e.z.atan(e.x).mul(1/(2*Math.PI)).add(.5),n=e.y.clamp(-1,1).asin().mul(1/Math.PI).add(.5);return oE(t,n)}}const OD=XM(kD).setParameterLength(0,1);class UD extends Sd{constructor(e=1,t={}){super(e,t),this.isCubeRenderTarget=!0}fromEquirectangularTexture(e,t){const n=t.minFilter,i=t.generateMipmaps;t.generateMipmaps=!0,this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const r=new ud(5,5,5),s=OD(tN),o=new CD;o.colorNode=AR(t,s,0),o.side=1,o.blending=0;const a=new ld(r,o),l=new Cd;l.add(a),t.minFilter===Ja&&(t.minFilter=Ka);const c=new wd(1,10,this),u=e.getMRT();return e.setMRT(null),c.update(e,l),e.setMRT(u),t.minFilter=n,t.currentGenerateMipmaps=i,a.geometry.dispose(),a.material.dispose(),this}}const FD=new WeakMap;class BD extends oM{static get type(){return"CubeMapNode"}constructor(e){super("vec3"),this.envNode=e,this._cubeTexture=null,this._cubeTextureNode=CN(null);const t=new Td;t.isRenderTargetTexture=!0,this._defaultTexture=t,this.updateBeforeType=XS}updateBefore(e){const{renderer:t,material:n}=e,i=this.envNode;if(i.isTextureNode||i.isMaterialReferenceNode){const e=i.isTextureNode?i.value:n[i.property];if(e&&e.isTexture){const n=e.mapping;if(n===Va||n===Ga){if(FD.has(e)){const t=FD.get(e);VD(t,e.mapping),this._cubeTexture=t}else{const n=e.image;if(function(e){return null!=e&&e.height>0}(n)){const i=new UD(n.height);i.fromEquirectangularTexture(t,e),VD(i.texture,e.mapping),this._cubeTexture=i.texture,FD.set(e,i.texture),e.addEventListener("dispose",zD)}else this._cubeTexture=this._defaultTexture}this._cubeTextureNode.value=this._cubeTexture}else this._cubeTextureNode=this.envNode}}}setup(e){return this.updateBefore(e),this._cubeTextureNode}}function zD(e){const t=e.target;t.removeEventListener("dispose",zD);const n=FD.get(t);void 0!==n&&(FD.delete(t),n.dispose())}function VD(e,t){t===Va?e.mapping=Ba:t===Ga&&(e.mapping=za)}const GD=XM(BD).setParameterLength(1);class jD extends JP{static get type(){return"BasicEnvironmentNode"}constructor(e=null){super(),this.envNode=e}setup(e){e.context.environment=GD(this.envNode)}}class HD extends JP{static get type(){return"BasicLightMapNode"}constructor(e=null){super(),this.lightMapNode=e}setup(e){const t=nE(1/Math.PI);e.context.irradianceLightMap=this.lightMapNode.mul(t)}}class WD{start(e){e.lightsNode.setupLights(e,e.lightsNode.getLightNodes(e)),this.indirect(e)}finish(){}direct(){}directRectArea(){}indirect(){}ambientOcclusion(){}}class qD extends WD{constructor(){super()}indirect({context:e}){const t=e.ambientOcclusion,n=e.reflectedLight,i=e.irradianceLightMap;n.indirectDiffuse.assign(fE(0)),i?n.indirectDiffuse.addAssign(i):n.indirectDiffuse.addAssign(fE(1,1,1,0)),n.indirectDiffuse.mulAssign(t),n.indirectDiffuse.mulAssign(SE.rgb)}finish(e){const{material:t,context:n}=e,i=n.outgoingLight,r=e.context.environment;if(r)switch(t.combine){case 0:i.rgb.assign(NC(i.rgb,i.rgb.mul(r.rgb),rP.mul(sP)));break;case 1:i.rgb.assign(NC(i.rgb,r.rgb,rP.mul(sP)));break;case 2:i.rgb.addAssign(r.rgb.mul(rP.mul(sP)));break;default:console.warn("THREE.BasicLightingModel: Unsupported .combine value:",t.combine)}}}const XD=new Nh;class $D extends CD{static get type(){return"MeshBasicNodeMaterial"}constructor(e){super(),this.isMeshBasicNodeMaterial=!0,this.lights=!0,this.setDefaultValues(XD),this.setValues(e)}setupNormal(){return cN}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new jD(t):null}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new HD(NP)),t}setupOutgoingLight(){return SE.rgb}setupLightingModel(){return new qD}}const YD=KM((({f0:e,f90:t,dotVH:n})=>{const i=n.mul(-5.55473).sub(6.98316).mul(n).exp2();return e.mul(i.oneMinus()).add(t.mul(i))})),KD=KM((e=>e.diffuseColor.mul(1/Math.PI))),ZD=KM((({dotNH:e})=>VE.mul(nE(.5)).add(1).mul(nE(1/Math.PI)).mul(e.pow(VE)))),JD=KM((({lightDirection:e})=>{const t=e.add(iN).normalize(),n=hN.dot(t).clamp(),i=iN.dot(t).clamp(),r=YD({f0:BE,f90:1,dotVH:i}),s=nE(.25),o=ZD({dotNH:n});return r.mul(s).mul(o)}));class QD extends qD{constructor(e=!0){super(),this.specular=e}direct({lightDirection:e,lightColor:t,reflectedLight:n}){const i=hN.dot(e).clamp().mul(t);n.directDiffuse.addAssign(i.mul(KD({diffuseColor:SE.rgb}))),!0===this.specular&&n.directSpecular.addAssign(i.mul(JD({lightDirection:e})).mul(rP))}indirect(e){const{ambientOcclusion:t,irradiance:n,reflectedLight:i}=e.context;i.indirectDiffuse.addAssign(n.mul(KD({diffuseColor:SE}))),i.indirectDiffuse.mulAssign(t)}}const eL=new Cp;class tL extends CD{static get type(){return"MeshLambertNodeMaterial"}constructor(e){super(),this.isMeshLambertNodeMaterial=!0,this.lights=!0,this.setDefaultValues(eL),this.setValues(e)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new jD(t):null}setupLightingModel(){return new QD(!1)}}const nL=new Mp;class iL extends CD{static get type(){return"MeshPhongNodeMaterial"}constructor(e){super(),this.isMeshPhongNodeMaterial=!0,this.lights=!0,this.shininessNode=null,this.specularNode=null,this.setDefaultValues(nL),this.setValues(e)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new jD(t):null}setupLightingModel(){return new QD}setupVariants(){const e=(this.shininessNode?nE(this.shininessNode):JN).max(1e-4);VE.assign(e);const t=this.specularNode||tP;BE.assign(t)}copy(e){return this.shininessNode=e.shininessNode,this.specularNode=e.specularNode,super.copy(e)}}const rL=KM((e=>{if(!1===e.geometry.hasAttribute("normal"))return nE(0);const t=cN.dFdx().abs().max(cN.dFdy().abs());return t.x.max(t.y).max(t.z)})),sL=KM((e=>{const{roughness:t}=e,n=rL();let i=t.max(.0525);return i=i.add(n),i=i.min(1),i})),oL=KM((({alpha:e,dotNL:t,dotNV:n})=>{const i=e.pow2(),r=t.mul(i.add(i.oneMinus().mul(n.pow2())).sqrt()),s=n.mul(i.add(i.oneMinus().mul(t.pow2())).sqrt());return pA(.5,r.add(s).max(OA))})).setLayout({name:"V_GGX_SmithCorrelated",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNL",type:"float"},{name:"dotNV",type:"float"}]}),aL=KM((({alphaT:e,alphaB:t,dotTV:n,dotBV:i,dotTL:r,dotBL:s,dotNV:o,dotNL:a})=>{const l=a.mul(uE(e.mul(n),t.mul(i),o).length()),c=o.mul(uE(e.mul(r),t.mul(s),a).length());return pA(.5,l.add(c)).saturate()})).setLayout({name:"V_GGX_SmithCorrelated_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotTV",type:"float",qualifier:"in"},{name:"dotBV",type:"float",qualifier:"in"},{name:"dotTL",type:"float",qualifier:"in"},{name:"dotBL",type:"float",qualifier:"in"},{name:"dotNV",type:"float",qualifier:"in"},{name:"dotNL",type:"float",qualifier:"in"}]}),lL=KM((({alpha:e,dotNH:t})=>{const n=e.pow2(),i=t.pow2().mul(n.oneMinus()).oneMinus();return n.div(i.pow2()).mul(1/Math.PI)})).setLayout({name:"D_GGX",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNH",type:"float"}]}),cL=nE(1/Math.PI),uL=KM((({alphaT:e,alphaB:t,dotNH:n,dotTH:i,dotBH:r})=>{const s=e.mul(t),o=uE(t.mul(i),e.mul(r),s.mul(n)),a=o.dot(o),l=s.div(a);return cL.mul(s.mul(l.pow2()))})).setLayout({name:"D_GGX_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotNH",type:"float",qualifier:"in"},{name:"dotTH",type:"float",qualifier:"in"},{name:"dotBH",type:"float",qualifier:"in"}]}),hL=KM((e=>{const{lightDirection:t,f0:n,f90:i,roughness:r,f:s,USE_IRIDESCENCE:o,USE_ANISOTROPY:a}=e,l=e.normalView||hN,c=r.pow2(),u=t.add(iN).normalize(),h=l.dot(t).clamp(),d=l.dot(iN).clamp(),p=l.dot(u).clamp(),f=iN.dot(u).clamp();let m,g,y=YD({f0:n,f90:i,dotVH:f});if(GM(o)&&(y=DE.mix(y,s)),GM(a)){const e=UE.dot(t),n=UE.dot(iN),i=UE.dot(u),r=FE.dot(t),s=FE.dot(iN),o=FE.dot(u);m=aL({alphaT:kE,alphaB:c,dotTV:n,dotBV:s,dotTL:e,dotBL:r,dotNV:d,dotNL:h}),g=uL({alphaT:kE,alphaB:c,dotNH:p,dotTH:i,dotBH:o})}else m=oL({alpha:c,dotNL:h,dotNV:d}),g=lL({alpha:c,dotNH:p});return y.mul(m).mul(g)})),dL=KM((({roughness:e,dotNV:t})=>{const n=fE(-1,-.0275,-.572,.022),i=fE(1,.0425,1.04,-.04),r=e.mul(n).add(i),s=r.x.mul(r.x).min(t.mul(-9.28).exp2()).mul(r.x).add(r.y);return oE(-1.04,1.04).mul(s).add(r.zw)})).setLayout({name:"DFGApprox",type:"vec2",inputs:[{name:"roughness",type:"float"},{name:"dotNV",type:"vec3"}]}),pL=KM((e=>{const{dotNV:t,specularColor:n,specularF90:i,roughness:r}=e,s=dL({dotNV:t,roughness:r});return n.mul(s.x).add(i.mul(s.y))})),fL=KM((({f:e,f90:t,dotVH:n})=>{const i=n.oneMinus().saturate(),r=i.mul(i),s=i.mul(r,r).clamp(0,.9999);return e.sub(uE(t).mul(s)).div(s.oneMinus())})).setLayout({name:"Schlick_to_F0",type:"vec3",inputs:[{name:"f",type:"vec3"},{name:"f90",type:"float"},{name:"dotVH",type:"float"}]}),mL=KM((({roughness:e,dotNH:t})=>{const n=e.pow2(),i=nE(1).div(n),r=t.pow2().oneMinus().max(.0078125);return nE(2).add(i).mul(r.pow(i.mul(.5))).div(2*Math.PI)})).setLayout({name:"D_Charlie",type:"float",inputs:[{name:"roughness",type:"float"},{name:"dotNH",type:"float"}]}),gL=KM((({dotNV:e,dotNL:t})=>nE(1).div(nE(4).mul(t.add(e).sub(t.mul(e)))))).setLayout({name:"V_Neubelt",type:"float",inputs:[{name:"dotNV",type:"float"},{name:"dotNL",type:"float"}]}),yL=KM((({lightDirection:e})=>{const t=e.add(iN).normalize(),n=hN.dot(e).clamp(),i=hN.dot(iN).clamp(),r=hN.dot(t).clamp(),s=mL({roughness:PE,dotNH:r}),o=gL({dotNV:i,dotNL:n});return NE.mul(s).mul(o)})),vL=KM((({N:e,V:t,roughness:n})=>{const i=e.dot(t).saturate(),r=oE(n,i.oneMinus().sqrt());return r.assign(r.mul(.984375).add(.0078125)),r})).setLayout({name:"LTC_Uv",type:"vec2",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"roughness",type:"float"}]}),_L=KM((({f:e})=>{const t=e.length();return yC(t.mul(t).add(e.z).div(t.add(1)),0)})).setLayout({name:"LTC_ClippedSphereFormFactor",type:"float",inputs:[{name:"f",type:"vec3"}]}),xL=KM((({v1:e,v2:t})=>{const n=e.dot(t),i=n.abs().toVar(),r=i.mul(.0145206).add(.4965155).mul(i).add(.8543985).toVar(),s=i.add(4.1616724).mul(i).add(3.417594).toVar(),o=r.div(s),a=n.greaterThan(0).select(o,yC(n.mul(n).oneMinus(),1e-7).inverseSqrt().mul(.5).sub(o));return e.cross(t).mul(a)})).setLayout({name:"LTC_EdgeVectorFormFactor",type:"vec3",inputs:[{name:"v1",type:"vec3"},{name:"v2",type:"vec3"}]}),bL=KM((({N:e,V:t,P:n,mInv:i,p0:r,p1:s,p2:o,p3:a})=>{const l=s.sub(r).toVar(),c=a.sub(r).toVar(),u=l.cross(c),h=uE().toVar();return QM(u.dot(n.sub(r)).greaterThanEqual(0),(()=>{const l=t.sub(e.mul(t.dot(e))).normalize(),c=e.cross(l).negate(),u=i.mul(_E(l,c,e).transpose()).toVar(),d=u.mul(r.sub(n)).normalize().toVar(),p=u.mul(s.sub(n)).normalize().toVar(),f=u.mul(o.sub(n)).normalize().toVar(),m=u.mul(a.sub(n)).normalize().toVar(),g=uE(0).toVar();g.addAssign(xL({v1:d,v2:p})),g.addAssign(xL({v1:p,v2:f})),g.addAssign(xL({v1:f,v2:m})),g.addAssign(xL({v1:m,v2:d})),h.assign(uE(_L({f:g})))})),h})).setLayout({name:"LTC_Evaluate",type:"vec3",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"P",type:"vec3"},{name:"mInv",type:"mat3"},{name:"p0",type:"vec3"},{name:"p1",type:"vec3"},{name:"p2",type:"vec3"},{name:"p3",type:"vec3"}]}),wL=1/6,TL=e=>dA(wL,dA(e,dA(e,e.negate().add(3)).sub(3)).add(1)),SL=e=>dA(wL,dA(e,dA(e,dA(3,e).sub(6))).add(4)),ML=e=>dA(wL,dA(e,dA(e,dA(-3,e).add(3)).add(3)).add(1)),EL=e=>dA(wL,SC(e,3)),AL=e=>TL(e).add(SL(e)),CL=e=>ML(e).add(EL(e)),RL=e=>uA(-1,SL(e).div(TL(e).add(SL(e)))),NL=e=>uA(1,EL(e).div(ML(e).add(EL(e)))),PL=(e,t,n)=>{const i=e.uvNode,r=dA(i,t.zw).add(.5),s=$A(r),o=ZA(r),a=AL(o.x),l=CL(o.x),c=RL(o.x),u=NL(o.x),h=RL(o.y),d=NL(o.y),p=oE(s.x.add(c),s.y.add(h)).sub(.5).mul(t.xy),f=oE(s.x.add(u),s.y.add(h)).sub(.5).mul(t.xy),m=oE(s.x.add(c),s.y.add(d)).sub(.5).mul(t.xy),g=oE(s.x.add(u),s.y.add(d)).sub(.5).mul(t.xy),y=AL(o.y).mul(uA(a.mul(e.sample(p).level(n)),l.mul(e.sample(f).level(n)))),v=CL(o.y).mul(uA(a.mul(e.sample(m).level(n)),l.mul(e.sample(g).level(n))));return y.add(v)},DL=KM((([e,t=nE(3)])=>{const n=oE(e.size(iE(t))),i=oE(e.size(iE(t.add(1)))),r=pA(1,n),s=pA(1,i),o=PL(e,fE(r,n),$A(t)),a=PL(e,fE(s,i),YA(t));return ZA(t).mix(o,a)})),LL=KM((([e,t,n,i,r])=>{const s=uE(LC(t.negate(),KA(e),pA(1,i))),o=uE(oC(r[0].xyz),oC(r[1].xyz),oC(r[2].xyz));return KA(s).mul(n.mul(o))})).setLayout({name:"getVolumeTransmissionRay",type:"vec3",inputs:[{name:"n",type:"vec3"},{name:"v",type:"vec3"},{name:"thickness",type:"float"},{name:"ior",type:"float"},{name:"modelMatrix",type:"mat4"}]}),IL=KM((([e,t])=>e.mul(PC(t.mul(2).sub(2),0,1)))).setLayout({name:"applyIorToRoughness",type:"float",inputs:[{name:"roughness",type:"float"},{name:"ior",type:"float"}]}),kL=dD(),OL=dD(),UL=KM((([e,t,n],{material:i})=>{const r=(1===i.side?kL:OL).sample(e),s=WA(aD.x).mul(IL(t,n));return DL(r,s)})),FL=KM((([e,t,n])=>(QM(n.notEqual(0),(()=>{const i=HA(t).negate().div(n);return GA(i.negate().mul(e))})),uE(1)))).setLayout({name:"volumeAttenuation",type:"vec3",inputs:[{name:"transmissionDistance",type:"float"},{name:"attenuationColor",type:"vec3"},{name:"attenuationDistance",type:"float"}]}),BL=KM((([e,t,n,i,r,s,o,a,l,c,u,h,d,p,f])=>{let m,g;if(f){m=fE().toVar(),g=uE().toVar();const r=u.sub(1).mul(f.mul(.025)),s=uE(u.sub(r),u,u.add(r));qP({start:0,end:3},(({i:r})=>{const u=s.element(r),f=LL(e,t,h,u,a),y=o.add(f),v=c.mul(l.mul(fE(y,1))),_=oE(v.xy.div(v.w)).toVar();_.addAssign(1),_.divAssign(2),_.assign(oE(_.x,_.y.oneMinus()));const x=UL(_,n,u);m.element(r).assign(x.element(r)),m.a.addAssign(x.a),g.element(r).assign(i.element(r).mul(FL(oC(f),d,p).element(r)))})),m.a.divAssign(3)}else{const r=LL(e,t,h,u,a),s=o.add(r),f=c.mul(l.mul(fE(s,1))),y=oE(f.xy.div(f.w)).toVar();y.addAssign(1),y.divAssign(2),y.assign(oE(y.x,y.y.oneMinus())),m=UL(y,n,u),g=i.mul(FL(oC(r),d,p))}const y=g.rgb.mul(m.rgb),v=e.dot(t).clamp(),_=uE(pL({dotNV:v,specularColor:r,specularF90:s,roughness:n})),x=g.r.add(g.g,g.b).div(3);return fE(_.oneMinus().mul(y),m.a.oneMinus().mul(x).oneMinus())})),zL=_E(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),VL=(e,t)=>e.sub(t).div(e.add(t)).pow2(),GL=KM((({outsideIOR:e,eta2:t,cosTheta1:n,thinFilmThickness:i,baseF0:r})=>{const s=NC(e,t,IC(0,.03,i)),o=e.div(s).pow2().mul(n.pow2().oneMinus()).oneMinus();QM(o.lessThan(0),(()=>uE(1)));const a=o.sqrt(),l=VL(s,e),c=YD({f0:l,f90:1,dotVH:n}),u=c.oneMinus(),h=s.lessThan(e).select(Math.PI,0),d=nE(Math.PI).sub(h),p=(e=>{const t=e.sqrt();return uE(1).add(t).div(uE(1).sub(t))})(r.clamp(0,.9999)),f=VL(p,s.toVec3()),m=YD({f0:f,f90:1,dotVH:a}),g=uE(p.x.lessThan(s).select(Math.PI,0),p.y.lessThan(s).select(Math.PI,0),p.z.lessThan(s).select(Math.PI,0)),y=s.mul(i,a,2),v=uE(d).add(g),_=c.mul(m).clamp(1e-5,.9999),x=_.sqrt(),b=u.pow2().mul(m).div(uE(1).sub(_)),w=c.add(b).toVar(),T=b.sub(u).toVar();return qP({start:1,end:2,condition:"<=",name:"m"},(({m:e})=>{T.mulAssign(x);const t=((e,t)=>{const n=e.mul(2*Math.PI*1e-9),i=uE(54856e-17,44201e-17,52481e-17),r=uE(1681e3,1795300,2208400),s=uE(43278e5,93046e5,66121e5),o=nE(9747e-17*Math.sqrt(2*Math.PI*45282e5)).mul(n.mul(2239900).add(t.x).cos()).mul(n.pow2().mul(-45282e5).exp());let a=i.mul(s.mul(2*Math.PI).sqrt()).mul(r.mul(n).add(t).cos()).mul(n.pow2().negate().mul(s).exp());return a=uE(a.x.add(o),a.y,a.z).div(1.0685e-7),zL.mul(a)})(nE(e).mul(y),nE(e).mul(v)).mul(2);w.addAssign(T.mul(t))})),w.max(uE(0))})).setLayout({name:"evalIridescence",type:"vec3",inputs:[{name:"outsideIOR",type:"float"},{name:"eta2",type:"float"},{name:"cosTheta1",type:"float"},{name:"thinFilmThickness",type:"float"},{name:"baseF0",type:"vec3"}]}),jL=KM((({normal:e,viewDir:t,roughness:n})=>{const i=e.dot(t).saturate(),r=n.pow2(),s=FC(n.lessThan(.25),nE(-339.2).mul(r).add(nE(161.4).mul(n)).sub(25.9),nE(-8.48).mul(r).add(nE(14.3).mul(n)).sub(9.95)),o=FC(n.lessThan(.25),nE(44).mul(r).sub(nE(23.7).mul(n)).add(3.26),nE(1.97).mul(r).sub(nE(3.27).mul(n)).add(.72));return FC(n.lessThan(.25),0,nE(.1).mul(n).sub(.025)).add(s.mul(i).add(o).exp()).mul(1/Math.PI).saturate()})),HL=uE(.04),WL=nE(1);class qL extends WD{constructor(e=!1,t=!1,n=!1,i=!1,r=!1,s=!1){super(),this.clearcoat=e,this.sheen=t,this.iridescence=n,this.anisotropy=i,this.transmission=r,this.dispersion=s,this.clearcoatRadiance=null,this.clearcoatSpecularDirect=null,this.clearcoatSpecularIndirect=null,this.sheenSpecularDirect=null,this.sheenSpecularIndirect=null,this.iridescenceFresnel=null,this.iridescenceF0=null}start(e){if(!0===this.clearcoat&&(this.clearcoatRadiance=uE().toVar("clearcoatRadiance"),this.clearcoatSpecularDirect=uE().toVar("clearcoatSpecularDirect"),this.clearcoatSpecularIndirect=uE().toVar("clearcoatSpecularIndirect")),!0===this.sheen&&(this.sheenSpecularDirect=uE().toVar("sheenSpecularDirect"),this.sheenSpecularIndirect=uE().toVar("sheenSpecularIndirect")),!0===this.iridescence){const e=hN.dot(iN).clamp();this.iridescenceFresnel=GL({outsideIOR:nE(1),eta2:LE,cosTheta1:e,thinFilmThickness:IE,baseF0:BE}),this.iridescenceF0=fL({f:this.iridescenceFresnel,f90:1,dotVH:e})}if(!0===this.transmission){const t=eN,n=zR.sub(eN).normalize(),i=dN,r=e.context;r.backdrop=BL(i,n,EE,SE,BE,zE,t,WR,BR,FR,WE,XE,YE,$E,this.dispersion?KE:null),r.backdropAlpha=qE,SE.a.mulAssign(NC(1,r.backdrop.a,qE))}super.start(e)}computeMultiscattering(e,t,n){const i=hN.dot(iN).clamp(),r=dL({roughness:EE,dotNV:i}),s=(this.iridescenceF0?DE.mix(BE,this.iridescenceF0):BE).mul(r.x).add(n.mul(r.y)),o=r.x.add(r.y).oneMinus(),a=BE.add(BE.oneMinus().mul(.047619)),l=s.mul(a).div(o.mul(a).oneMinus());e.addAssign(s),t.addAssign(l.mul(o))}direct({lightDirection:e,lightColor:t,reflectedLight:n}){const i=hN.dot(e).clamp().mul(t);if(!0===this.sheen&&this.sheenSpecularDirect.addAssign(i.mul(yL({lightDirection:e}))),!0===this.clearcoat){const n=pN.dot(e).clamp().mul(t);this.clearcoatSpecularDirect.addAssign(n.mul(hL({lightDirection:e,f0:HL,f90:WL,roughness:RE,normalView:pN})))}n.directDiffuse.addAssign(i.mul(KD({diffuseColor:SE.rgb}))),n.directSpecular.addAssign(i.mul(hL({lightDirection:e,f0:BE,f90:1,roughness:EE,iridescence:this.iridescence,f:this.iridescenceFresnel,USE_IRIDESCENCE:this.iridescence,USE_ANISOTROPY:this.anisotropy})))}directRectArea({lightColor:e,lightPosition:t,halfWidth:n,halfHeight:i,reflectedLight:r,ltc_1:s,ltc_2:o}){const a=t.add(n).sub(i),l=t.sub(n).sub(i),c=t.sub(n).add(i),u=t.add(n).add(i),h=hN,d=iN,p=nN.toVar(),f=vL({N:h,V:d,roughness:EE}),m=s.sample(f).toVar(),g=o.sample(f).toVar(),y=_E(uE(m.x,0,m.y),uE(0,1,0),uE(m.z,0,m.w)).toVar(),v=BE.mul(g.x).add(BE.oneMinus().mul(g.y)).toVar();r.directSpecular.addAssign(e.mul(v).mul(bL({N:h,V:d,P:p,mInv:y,p0:a,p1:l,p2:c,p3:u}))),r.directDiffuse.addAssign(e.mul(SE).mul(bL({N:h,V:d,P:p,mInv:_E(1,0,0,0,1,0,0,0,1),p0:a,p1:l,p2:c,p3:u})))}indirect(e){this.indirectDiffuse(e),this.indirectSpecular(e),this.ambientOcclusion(e)}indirectDiffuse(e){const{irradiance:t,reflectedLight:n}=e.context;n.indirectDiffuse.addAssign(t.mul(KD({diffuseColor:SE})))}indirectSpecular(e){const{radiance:t,iblIrradiance:n,reflectedLight:i}=e.context;if(!0===this.sheen&&this.sheenSpecularIndirect.addAssign(n.mul(NE,jL({normal:hN,viewDir:iN,roughness:PE}))),!0===this.clearcoat){const e=pN.dot(iN).clamp(),t=pL({dotNV:e,specularColor:HL,specularF90:WL,roughness:RE});this.clearcoatSpecularIndirect.addAssign(this.clearcoatRadiance.mul(t))}const r=uE().toVar("singleScattering"),s=uE().toVar("multiScattering"),o=n.mul(1/Math.PI);this.computeMultiscattering(r,s,zE);const a=r.add(s),l=SE.mul(a.r.max(a.g).max(a.b).oneMinus());i.indirectSpecular.addAssign(t.mul(r)),i.indirectSpecular.addAssign(s.mul(o)),i.indirectDiffuse.addAssign(l.mul(o))}ambientOcclusion(e){const{ambientOcclusion:t,reflectedLight:n}=e.context,i=hN.dot(iN).clamp().add(t),r=EE.mul(-16).oneMinus().negate().exp2(),s=t.sub(i.pow(r).oneMinus()).clamp();!0===this.clearcoat&&this.clearcoatSpecularIndirect.mulAssign(t),!0===this.sheen&&this.sheenSpecularIndirect.mulAssign(t),n.indirectDiffuse.mulAssign(t),n.indirectSpecular.mulAssign(s)}finish({context:e}){const{outgoingLight:t}=e;if(!0===this.clearcoat){const e=pN.dot(iN).clamp(),n=YD({dotVH:e,f0:HL,f90:WL}),i=t.mul(CE.mul(n).oneMinus()).add(this.clearcoatSpecularDirect.add(this.clearcoatSpecularIndirect).mul(CE));t.assign(i)}if(!0===this.sheen){const e=NE.r.max(NE.g).max(NE.b).mul(.157).oneMinus(),n=t.mul(e).add(this.sheenSpecularDirect,this.sheenSpecularIndirect);t.assign(n)}}}const XL=nE(1),$L=nE(-2),YL=nE(.8),KL=nE(-1),ZL=nE(.4),JL=nE(2),QL=nE(.305),eI=nE(3),tI=nE(.21),nI=nE(4),iI=nE(4),rI=nE(16),sI=KM((([e])=>{const t=uE(rC(e)).toVar(),n=nE(-1).toVar();return QM(t.x.greaterThan(t.z),(()=>{QM(t.x.greaterThan(t.y),(()=>{n.assign(FC(e.x.greaterThan(0),0,3))})).Else((()=>{n.assign(FC(e.y.greaterThan(0),1,4))}))})).Else((()=>{QM(t.z.greaterThan(t.y),(()=>{n.assign(FC(e.z.greaterThan(0),2,5))})).Else((()=>{n.assign(FC(e.y.greaterThan(0),1,4))}))})),n})).setLayout({name:"getFace",type:"float",inputs:[{name:"direction",type:"vec3"}]}),oI=KM((([e,t])=>{const n=oE().toVar();return QM(t.equal(0),(()=>{n.assign(oE(e.z,e.y).div(rC(e.x)))})).ElseIf(t.equal(1),(()=>{n.assign(oE(e.x.negate(),e.z.negate()).div(rC(e.y)))})).ElseIf(t.equal(2),(()=>{n.assign(oE(e.x.negate(),e.y).div(rC(e.z)))})).ElseIf(t.equal(3),(()=>{n.assign(oE(e.z.negate(),e.y).div(rC(e.x)))})).ElseIf(t.equal(4),(()=>{n.assign(oE(e.x.negate(),e.z).div(rC(e.y)))})).Else((()=>{n.assign(oE(e.x,e.y).div(rC(e.z)))})),dA(.5,n.add(1))})).setLayout({name:"getUV",type:"vec2",inputs:[{name:"direction",type:"vec3"},{name:"face",type:"float"}]}),aI=KM((([e])=>{const t=nE(0).toVar();return QM(e.greaterThanEqual(YL),(()=>{t.assign(XL.sub(e).mul(KL.sub($L)).div(XL.sub(YL)).add($L))})).ElseIf(e.greaterThanEqual(ZL),(()=>{t.assign(YL.sub(e).mul(JL.sub(KL)).div(YL.sub(ZL)).add(KL))})).ElseIf(e.greaterThanEqual(QL),(()=>{t.assign(ZL.sub(e).mul(eI.sub(JL)).div(ZL.sub(QL)).add(JL))})).ElseIf(e.greaterThanEqual(tI),(()=>{t.assign(QL.sub(e).mul(nI.sub(eI)).div(QL.sub(tI)).add(eI))})).Else((()=>{t.assign(nE(-2).mul(WA(dA(1.16,e))))})),t})).setLayout({name:"roughnessToMip",type:"float",inputs:[{name:"roughness",type:"float"}]}),lI=KM((([e,t])=>{const n=e.toVar();n.assign(dA(2,n).sub(1));const i=uE(n,1).toVar();return QM(t.equal(0),(()=>{i.assign(i.zyx)})).ElseIf(t.equal(1),(()=>{i.assign(i.xzy),i.xz.mulAssign(-1)})).ElseIf(t.equal(2),(()=>{i.x.mulAssign(-1)})).ElseIf(t.equal(3),(()=>{i.assign(i.zyx),i.xz.mulAssign(-1)})).ElseIf(t.equal(4),(()=>{i.assign(i.xzy),i.xy.mulAssign(-1)})).ElseIf(t.equal(5),(()=>{i.z.mulAssign(-1)})),i})).setLayout({name:"getDirection",type:"vec3",inputs:[{name:"uv",type:"vec2"},{name:"face",type:"float"}]}),cI=KM((([e,t,n,i,r,s])=>{const o=nE(n),a=uE(t),l=PC(aI(o),$L,s),c=ZA(l),u=$A(l),h=uE(uI(e,a,u,i,r,s)).toVar();return QM(c.notEqual(0),(()=>{const t=uE(uI(e,a,u.add(1),i,r,s)).toVar();h.assign(NC(h,t,c))})),h})),uI=KM((([e,t,n,i,r,s])=>{const o=nE(n).toVar(),a=uE(t),l=nE(sI(a)).toVar(),c=nE(yC(iI.sub(o),0)).toVar();o.assign(yC(o,iI));const u=nE(jA(o)).toVar(),h=oE(oI(a,l).mul(u.sub(2)).add(1)).toVar();return QM(l.greaterThan(2),(()=>{h.y.addAssign(u),l.subAssign(3)})),h.x.addAssign(l.mul(u)),h.x.addAssign(c.mul(dA(3,rI))),h.y.addAssign(dA(4,jA(s).sub(u))),h.x.mulAssign(i),h.y.mulAssign(r),e.sample(h).grad(oE(),oE())})),hI=KM((({envMap:e,mipInt:t,outputDirection:n,theta:i,axis:r,CUBEUV_TEXEL_WIDTH:s,CUBEUV_TEXEL_HEIGHT:o,CUBEUV_MAX_MIP:a})=>{const l=QA(i),c=n.mul(l).add(r.cross(n).mul(JA(i))).add(r.mul(r.dot(n).mul(l.oneMinus())));return uI(e,c,t,s,o,a)})),dI=KM((({n:e,latitudinal:t,poleAxis:n,outputDirection:i,weights:r,samples:s,dTheta:o,mipInt:a,envMap:l,CUBEUV_TEXEL_WIDTH:c,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:h})=>{const d=uE(FC(t,n,TC(n,i))).toVar();QM(d.equal(uE(0)),(()=>{d.assign(uE(i.z,0,i.x.negate()))})),d.assign(KA(d));const p=uE().toVar();return p.addAssign(r.element(0).mul(hI({theta:0,axis:d,outputDirection:i,mipInt:a,envMap:l,CUBEUV_TEXEL_WIDTH:c,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:h}))),qP({start:iE(1),end:e},(({i:e})=>{QM(e.greaterThanEqual(s),(()=>{fR("break").toStack()}));const t=nE(o.mul(nE(e))).toVar();p.addAssign(r.element(e).mul(hI({theta:t.mul(-1),axis:d,outputDirection:i,mipInt:a,envMap:l,CUBEUV_TEXEL_WIDTH:c,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:h}))),p.addAssign(r.element(e).mul(hI({theta:t,axis:d,outputDirection:i,mipInt:a,envMap:l,CUBEUV_TEXEL_WIDTH:c,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:h})))})),fE(p,1)})),pI=[.125,.215,.35,.446,.526,.582],fI=20,mI=new Zp(-1,1,1,-1,0,1),gI=new xd(90,1),yI=new Eh;let vI=null,_I=0,xI=0;const bI=(1+Math.sqrt(5))/2,wI=1/bI,TI=[new Dc(-bI,wI,0),new Dc(bI,wI,0),new Dc(-wI,0,bI),new Dc(wI,0,bI),new Dc(0,bI,-wI),new Dc(0,bI,wI),new Dc(-1,1,-1),new Dc(1,1,-1),new Dc(-1,1,1),new Dc(1,1,1)],SI=new Dc,MI=new WeakMap,EI=[3,1,5,0,4,2],AI=lI(_R(),vR("faceIndex")).normalize(),CI=uE(AI.x,AI.y,AI.z);class RI{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._backgroundBox=null}get _hasInitialized(){return this._renderer.hasInitialized()}fromScene(e,t=0,n=.1,i=100,r={}){const{size:s=256,position:o=SI,renderTarget:a=null}=r;if(this._setSize(s),!1===this._hasInitialized){console.warn("THREE.PMREMGenerator: .fromScene() called before the backend is initialized. Try using .fromSceneAsync() instead.");const s=a||this._allocateTarget();return r.renderTarget=s,this.fromSceneAsync(e,t,n,i,r),s}vI=this._renderer.getRenderTarget(),_I=this._renderer.getActiveCubeFace(),xI=this._renderer.getActiveMipmapLevel();const l=a||this._allocateTarget();return l.depthBuffer=!0,this._init(l),this._sceneToCubeUV(e,n,i,l,o),t>0&&this._blur(l,0,0,t),this._applyPMREM(l),this._cleanup(l),l}async fromSceneAsync(e,t=0,n=.1,i=100,r={}){return!1===this._hasInitialized&&await this._renderer.init(),this.fromScene(e,t,n,i,r)}fromEquirectangular(e,t=null){if(!1===this._hasInitialized){console.warn("THREE.PMREMGenerator: .fromEquirectangular() called before the backend is initialized. Try using .fromEquirectangularAsync() instead."),this._setSizeFromTexture(e);const n=t||this._allocateTarget();return this.fromEquirectangularAsync(e,n),n}return this._fromTexture(e,t)}async fromEquirectangularAsync(e,t=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(e,t)}fromCubemap(e,t=null){if(!1===this._hasInitialized){console.warn("THREE.PMREMGenerator: .fromCubemap() called before the backend is initialized. Try using .fromCubemapAsync() instead."),this._setSizeFromTexture(e);const n=t||this._allocateTarget();return this.fromCubemapAsync(e,t),n}return this._fromTexture(e,t)}async fromCubemapAsync(e,t=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(e,t)}async compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=LI(),await this._compileMaterial(this._cubemapMaterial))}async compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=II(),await this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose(),null!==this._backgroundBox&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSizeFromTexture(e){e.mapping===Ba||e.mapping===za?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4)}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(vI,_I,xI),e.scissorTest=!1,PI(e,0,0,e.width,e.height)}_fromTexture(e,t){this._setSizeFromTexture(e),vI=this._renderer.getRenderTarget(),_I=this._renderer.getActiveCubeFace(),xI=this._renderer.getActiveMipmapLevel();const n=t||this._allocateTarget();return this._init(n),this._textureToCubeUV(e,n),this._applyPMREM(n),this._cleanup(n),n}_allocateTarget(){return NI(3*Math.max(this._cubeSize,112),4*this._cubeSize)}_init(e){if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e.width||this._pingPongRenderTarget.height!==e.height){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=NI(e.width,e.height);const{_lodMax:t}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas,lodMeshes:this._lodMeshes}=function(e){const t=[],n=[],i=[],r=[];let s=e;const o=e-4+1+pI.length;for(let a=0;a<o;a++){const o=Math.pow(2,s);n.push(o);let l=1/o;a>e-4?l=pI[a-e+4-1]:0===a&&(l=0),i.push(l);const c=1/(o-2),u=-c,h=1+c,d=[u,u,h,u,h,h,u,u,h,h,u,h],p=6,f=6,m=3,g=2,y=1,v=new Float32Array(m*f*p),_=new Float32Array(g*f*p),x=new Float32Array(y*f*p);for(let e=0;e<p;e++){const t=e%3*2/3-1,n=e>2?0:-1,i=[t,n,0,t+2/3,n,0,t+2/3,n+1,0,t,n,0,t+2/3,n+1,0,t,n+1,0],r=EI[e];v.set(i,m*f*r),_.set(d,g*f*r);const s=[r,r,r,r,r,r];x.set(s,y*f*r)}const b=new Kh;b.setAttribute("position",new Fh(v,m)),b.setAttribute("uv",new Fh(_,g)),b.setAttribute("faceIndex",new Fh(x,y)),t.push(b),r.push(new ld(b,null)),s>4&&s--}return{lodPlanes:t,sizeLods:n,sigmas:i,lodMeshes:r}}(t)),this._blurMaterial=function(e,t,n){const i=LR(new Array(fI).fill(0)),r=rA(new Dc(0,1,0)),s=rA(0),o=nE(fI),a=rA(0),l=rA(1),c=AR(null),u=rA(0),h=nE(1/t),d=nE(1/n),p=nE(e),f={n:o,latitudinal:a,weights:i,poleAxis:r,outputDirection:CI,dTheta:s,samples:l,envMap:c,mipInt:u,CUBEUV_TEXEL_WIDTH:h,CUBEUV_TEXEL_HEIGHT:d,CUBEUV_MAX_MIP:p},m=DI("blur");return m.fragmentNode=dI({...f,latitudinal:a.equal(1)}),MI.set(m,f),m}(t,e.width,e.height)}}async _compileMaterial(e){const t=new ld(this._lodPlanes[0],e);await this._renderer.compile(t,mI)}_sceneToCubeUV(e,t,n,i,r){const s=gI;s.near=t,s.far=n;const o=[1,1,1,1,-1,1],a=[1,-1,1,-1,1,-1],l=this._renderer,c=l.autoClear;l.getClearColor(yI),l.autoClear=!1;let u=this._backgroundBox;if(null===u){const e=new Nh({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1});u=new ld(new ud,e)}let h=!1;const d=e.background;d?d.isColor&&(u.material.color.copy(d),e.background=null,h=!0):(u.material.color.copy(yI),h=!0),l.setRenderTarget(i),l.clear(),h&&l.render(u,s);for(let t=0;t<6;t++){const n=t%3;0===n?(s.up.set(0,o[t],0),s.position.set(r.x,r.y,r.z),s.lookAt(r.x+a[t],r.y,r.z)):1===n?(s.up.set(0,0,o[t]),s.position.set(r.x,r.y,r.z),s.lookAt(r.x,r.y+a[t],r.z)):(s.up.set(0,o[t],0),s.position.set(r.x,r.y,r.z),s.lookAt(r.x,r.y,r.z+a[t]));const c=this._cubeSize;PI(i,n*c,t>2?c:0,c,c),l.render(e,s)}l.autoClear=c,e.background=d}_textureToCubeUV(e,t){const n=this._renderer,i=e.mapping===Ba||e.mapping===za;i?null===this._cubemapMaterial&&(this._cubemapMaterial=LI(e)):null===this._equirectMaterial&&(this._equirectMaterial=II(e));const r=i?this._cubemapMaterial:this._equirectMaterial;r.fragmentNode.value=e;const s=this._lodMeshes[0];s.material=r;const o=this._cubeSize;PI(t,0,0,3*o,2*o),n.setRenderTarget(t),n.render(s,mI)}_applyPMREM(e){const t=this._renderer,n=t.autoClear;t.autoClear=!1;const i=this._lodPlanes.length;for(let t=1;t<i;t++){const n=Math.sqrt(this._sigmas[t]*this._sigmas[t]-this._sigmas[t-1]*this._sigmas[t-1]),r=TI[(i-t-1)%TI.length];this._blur(e,t-1,t,n,r)}t.autoClear=n}_blur(e,t,n,i,r){const s=this._pingPongRenderTarget;this._halfBlur(e,s,t,n,i,"latitudinal",r),this._halfBlur(s,e,n,n,i,"longitudinal",r)}_halfBlur(e,t,n,i,r,s,o){const a=this._renderer,l=this._blurMaterial;"latitudinal"!==s&&"longitudinal"!==s&&console.error("blur direction must be either latitudinal or longitudinal!");const c=this._lodMeshes[i];c.material=l;const u=MI.get(l),h=this._sizeLods[n]-1,d=isFinite(r)?Math.PI/(2*h):2*Math.PI/39,p=r/d,f=isFinite(r)?1+Math.floor(3*p):fI;f>fI&&console.warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${f} samples when the maximum is set to 20`);const m=[];let g=0;for(let e=0;e<fI;++e){const t=e/p,n=Math.exp(-t*t/2);m.push(n),0===e?g+=n:e<f&&(g+=2*n)}for(let e=0;e<m.length;e++)m[e]=m[e]/g;e.texture.frame=(e.texture.frame||0)+1,u.envMap.value=e.texture,u.samples.value=f,u.weights.array=m,u.latitudinal.value="latitudinal"===s?1:0,o&&(u.poleAxis.value=o);const{_lodMax:y}=this;u.dTheta.value=d,u.mipInt.value=y-n;const v=this._sizeLods[i];PI(t,3*v*(i>y-4?i-y+4:0),4*(this._cubeSize-v),3*v,2*v),a.setRenderTarget(t),a.render(c,mI)}}function NI(e,t){const n=new iu(e,t,{magFilter:Ka,minFilter:Ka,generateMipmaps:!1,type:ol,format:pl,colorSpace:tc});return n.texture.mapping=ja,n.texture.name="PMREM.cubeUv",n.texture.isPMREMTexture=!0,n.scissorTest=!0,n}function PI(e,t,n,i,r){e.viewport.set(t,n,i,r),e.scissor.set(t,n,i,r)}function DI(e){const t=new CD;return t.depthTest=!1,t.depthWrite=!1,t.blending=0,t.name=`PMREM_${e}`,t}function LI(e){const t=DI("cubemap");return t.fragmentNode=CN(e,CI),t}function II(e){const t=DI("equirect");return t.fragmentNode=AR(e,OD(CI),0),t}const kI=new WeakMap;function OI(e,t,n){const i=function(e){let t=kI.get(e);void 0===t&&(t=new WeakMap,kI.set(e,t));return t}(t);let r=i.get(e);if((void 0!==r?r.pmremVersion:-1)!==e.pmremVersion){const t=e.image;if(e.isCubeTexture){if(!function(e){if(null==e)return!1;let t=0;const n=6;for(let i=0;i<n;i++)void 0!==e[i]&&t++;return t===n}(t))return null;r=n.fromCubemap(e,r)}else{if(!function(e){return null!=e&&e.height>0}(t))return null;r=n.fromEquirectangular(e,r)}r.pmremVersion=e.pmremVersion,i.set(e,r)}return r.texture}class UI extends oM{static get type(){return"PMREMNode"}constructor(e,t=null,n=null){super("vec3"),this._value=e,this._pmrem=null,this.uvNode=t,this.levelNode=n,this._generator=null;const i=new tu;i.isRenderTargetTexture=!0,this._texture=AR(i),this._width=rA(0),this._height=rA(0),this._maxMip=rA(0),this.updateBeforeType=XS}set value(e){this._value=e,this._pmrem=null}get value(){return this._value}updateFromTexture(e){const t=function(e){const t=Math.log2(e)-2,n=1/e;return{texelWidth:1/(3*Math.max(Math.pow(2,t),112)),texelHeight:n,maxMip:t}}(e.image.height);this._texture.value=e,this._width.value=t.texelWidth,this._height.value=t.texelHeight,this._maxMip.value=t.maxMip}updateBefore(e){let t=this._pmrem;const n=t?t.pmremVersion:-1,i=this._value;n!==i.pmremVersion&&(t=!0===i.isPMREMTexture?i:OI(i,e.renderer,this._generator),null!==t&&(this._pmrem=t,this.updateFromTexture(t)))}setup(e){null===this._generator&&(this._generator=new RI(e.renderer)),this.updateBefore(e);let t=this.uvNode;null===t&&e.context.getUV&&(t=e.context.getUV(this)),t=xN.mul(uE(t.x,t.y.negate(),t.z));let n=this.levelNode;return null===n&&e.context.getTextureLevel&&(n=e.context.getTextureLevel(this)),cI(this._texture,t,n,this._width,this._height,this._maxMip)}dispose(){super.dispose(),null!==this._generator&&this._generator.dispose()}}const FI=XM(UI).setParameterLength(1,3),BI=new WeakMap;class zI extends JP{static get type(){return"EnvironmentNode"}constructor(e=null){super(),this.envNode=e}setup(e){const{material:t}=e;let n=this.envNode;if(n.isTextureNode||n.isMaterialReferenceNode){const e=n.isTextureNode?n.value:t[n.property];let i=BI.get(e);void 0===i&&(i=FI(e),BI.set(e,i)),n=i}const i=!0===t.useAnisotropy||t.anisotropy>0?zN:hN,r=n.context(VI(EE,i)).mul(_N),s=n.context(GI(dN)).mul(Math.PI).mul(_N),o=lR(r),a=lR(s);e.context.radiance.addAssign(o),e.context.iblIrradiance.addAssign(a);const l=e.context.lightingModel.clearcoatRadiance;if(l){const e=n.context(VI(RE,pN)).mul(_N),t=lR(e);l.addAssign(t)}}}const VI=(e,t)=>{let n=null;return{getUV:()=>(null===n&&(n=iN.negate().reflect(t),n=e.mul(e).mix(n,t).normalize(),n=n.transformDirection(BR)),n),getTextureLevel:()=>e}},GI=e=>({getUV:()=>e,getTextureLevel:()=>nE(1)}),jI=new Tp;class HI extends CD{static get type(){return"MeshStandardNodeMaterial"}constructor(e){super(),this.isMeshStandardNodeMaterial=!0,this.lights=!0,this.emissiveNode=null,this.metalnessNode=null,this.roughnessNode=null,this.setDefaultValues(jI),this.setValues(e)}setupEnvironment(e){let t=super.setupEnvironment(e);return null===t&&e.environmentNode&&(t=e.environmentNode),t?new zI(t):null}setupLightingModel(){return new qL}setupSpecular(){const e=NC(uE(.04),SE.rgb,AE);BE.assign(e),zE.assign(1)}setupVariants(){const e=this.metalnessNode?nE(this.metalnessNode):aP;AE.assign(e);let t=this.roughnessNode?nE(this.roughnessNode):oP;t=sL({roughness:t}),EE.assign(t),this.setupSpecular(),SE.assign(fE(SE.rgb.mul(e.oneMinus()),SE.a))}copy(e){return this.emissiveNode=e.emissiveNode,this.metalnessNode=e.metalnessNode,this.roughnessNode=e.roughnessNode,super.copy(e)}}const WI=new Sp;class qI extends HI{static get type(){return"MeshPhysicalNodeMaterial"}constructor(e){super(),this.isMeshPhysicalNodeMaterial=!0,this.clearcoatNode=null,this.clearcoatRoughnessNode=null,this.clearcoatNormalNode=null,this.sheenNode=null,this.sheenRoughnessNode=null,this.iridescenceNode=null,this.iridescenceIORNode=null,this.iridescenceThicknessNode=null,this.specularIntensityNode=null,this.specularColorNode=null,this.iorNode=null,this.transmissionNode=null,this.thicknessNode=null,this.attenuationDistanceNode=null,this.attenuationColorNode=null,this.dispersionNode=null,this.anisotropyNode=null,this.setDefaultValues(WI),this.setValues(e)}get useClearcoat(){return this.clearcoat>0||null!==this.clearcoatNode}get useIridescence(){return this.iridescence>0||null!==this.iridescenceNode}get useSheen(){return this.sheen>0||null!==this.sheenNode}get useAnisotropy(){return this.anisotropy>0||null!==this.anisotropyNode}get useTransmission(){return this.transmission>0||null!==this.transmissionNode}get useDispersion(){return this.dispersion>0||null!==this.dispersionNode}setupSpecular(){const e=this.iorNode?nE(this.iorNode):bP;WE.assign(e),BE.assign(NC(gC(MC(WE.sub(1).div(WE.add(1))).mul(iP),uE(1)).mul(nP),SE.rgb,AE)),zE.assign(NC(nP,1,AE))}setupLightingModel(){return new qL(this.useClearcoat,this.useSheen,this.useIridescence,this.useAnisotropy,this.useTransmission,this.useDispersion)}setupVariants(e){if(super.setupVariants(e),this.useClearcoat){const e=this.clearcoatNode?nE(this.clearcoatNode):cP,t=this.clearcoatRoughnessNode?nE(this.clearcoatRoughnessNode):uP;CE.assign(e),RE.assign(sL({roughness:t}))}if(this.useSheen){const e=this.sheenNode?uE(this.sheenNode):pP,t=this.sheenRoughnessNode?nE(this.sheenRoughnessNode):fP;NE.assign(e),PE.assign(t)}if(this.useIridescence){const e=this.iridescenceNode?nE(this.iridescenceNode):gP,t=this.iridescenceIORNode?nE(this.iridescenceIORNode):yP,n=this.iridescenceThicknessNode?nE(this.iridescenceThicknessNode):vP;DE.assign(e),LE.assign(t),IE.assign(n)}if(this.useAnisotropy){const e=(this.anisotropyNode?oE(this.anisotropyNode):mP).toVar();OE.assign(e.length()),QM(OE.equal(0),(()=>{e.assign(oE(1,0))})).Else((()=>{e.divAssign(oE(OE)),OE.assign(OE.saturate())})),kE.assign(OE.pow2().mix(EE.pow2(),1)),UE.assign(BN[0].mul(e.x).add(BN[1].mul(e.y))),FE.assign(BN[1].mul(e.x).sub(BN[0].mul(e.y)))}if(this.useTransmission){const e=this.transmissionNode?nE(this.transmissionNode):_P,t=this.thicknessNode?nE(this.thicknessNode):xP,n=this.attenuationDistanceNode?nE(this.attenuationDistanceNode):wP,i=this.attenuationColorNode?uE(this.attenuationColorNode):TP;if(qE.assign(e),XE.assign(t),$E.assign(n),YE.assign(i),this.useDispersion){const e=this.dispersionNode?nE(this.dispersionNode):RP;KE.assign(e)}}}setupClearcoatNormal(){return this.clearcoatNormalNode?uE(this.clearcoatNormalNode):hP}setup(e){e.context.setupClearcoatNormal=()=>this.setupClearcoatNormal(e),super.setup(e)}copy(e){return this.clearcoatNode=e.clearcoatNode,this.clearcoatRoughnessNode=e.clearcoatRoughnessNode,this.clearcoatNormalNode=e.clearcoatNormalNode,this.sheenNode=e.sheenNode,this.sheenRoughnessNode=e.sheenRoughnessNode,this.iridescenceNode=e.iridescenceNode,this.iridescenceIORNode=e.iridescenceIORNode,this.iridescenceThicknessNode=e.iridescenceThicknessNode,this.specularIntensityNode=e.specularIntensityNode,this.specularColorNode=e.specularColorNode,this.transmissionNode=e.transmissionNode,this.thicknessNode=e.thicknessNode,this.attenuationDistanceNode=e.attenuationDistanceNode,this.attenuationColorNode=e.attenuationColorNode,this.dispersionNode=e.dispersionNode,this.anisotropyNode=e.anisotropyNode,super.copy(e)}}const XI=KM((({normal:e,lightDirection:t,builder:n})=>{const i=e.dot(t),r=oE(i.mul(.5).add(.5),0);if(n.material.gradientMap){const e=IN("gradientMap","texture").context({getUV:()=>r});return uE(e.r)}{const e=r.fwidth().mul(.5);return NC(uE(.7),uE(1),IC(nE(.7).sub(e.x),nE(.7).add(e.x),r.x))}}));class $I extends WD{direct({lightDirection:e,lightColor:t,reflectedLight:n},i){const r=XI({normal:oN,lightDirection:e,builder:i}).mul(t);n.directDiffuse.addAssign(r.mul(KD({diffuseColor:SE.rgb})))}indirect(e){const{ambientOcclusion:t,irradiance:n,reflectedLight:i}=e.context;i.indirectDiffuse.addAssign(n.mul(KD({diffuseColor:SE}))),i.indirectDiffuse.mulAssign(t)}}const YI=new Ep;class KI extends CD{static get type(){return"MeshToonNodeMaterial"}constructor(e){super(),this.isMeshToonNodeMaterial=!0,this.lights=!0,this.setDefaultValues(YI),this.setValues(e)}setupLightingModel(){return new $I}}class ZI extends oM{static get type(){return"MatcapUVNode"}constructor(){super("vec2")}setup(){const e=uE(iN.z,0,iN.x.negate()).normalize(),t=iN.cross(e);return oE(e.dot(hN),t.dot(hN)).mul(.495).add(.5)}}const JI=$M(ZI),QI=new Pp;class ek extends CD{static get type(){return"MeshMatcapNodeMaterial"}constructor(e){super(),this.isMeshMatcapNodeMaterial=!0,this.setDefaultValues(QI),this.setValues(e)}setupVariants(e){const t=JI;let n;n=e.material.matcap?IN("matcap","texture").context({getUV:()=>t}):uE(NC(.2,.8,t.y)),SE.rgb.mulAssign(n.rgb)}}class tk extends oM{static get type(){return"RotateNode"}constructor(e,t){super(),this.positionNode=e,this.rotationNode=t}getNodeType(e){return this.positionNode.getNodeType(e)}setup(e){const{rotationNode:t,positionNode:n}=this;if("vec2"===this.getNodeType(e)){const e=t.cos(),i=t.sin();return vE(e,i,i.negate(),e).mul(n)}{const e=t,i=xE(fE(1,0,0,0),fE(0,QA(e.x),JA(e.x).negate(),0),fE(0,JA(e.x),QA(e.x),0),fE(0,0,0,1)),r=xE(fE(QA(e.y),0,JA(e.y),0),fE(0,1,0,0),fE(JA(e.y).negate(),0,QA(e.y),0),fE(0,0,0,1)),s=xE(fE(QA(e.z),JA(e.z).negate(),0,0),fE(JA(e.z),QA(e.z),0,0),fE(0,0,1,0),fE(0,0,0,1));return i.mul(r).mul(s).mul(fE(n,1)).xyz}}}const nk=XM(tk).setParameterLength(2),ik=new Dd;class rk extends CD{static get type(){return"SpriteNodeMaterial"}constructor(e){super(),this.isSpriteNodeMaterial=!0,this._useSizeAttenuation=!0,this.positionNode=null,this.rotationNode=null,this.scaleNode=null,this.transparent=!0,this.setDefaultValues(ik),this.setValues(e)}setupPositionView(e){const{object:t,camera:n}=e,i=this.sizeAttenuation,{positionNode:r,rotationNode:s,scaleNode:o}=this,a=XR.mul(uE(r||0));let l=oE(WR[0].xyz.length(),WR[1].xyz.length());if(null!==o&&(l=l.mul(oE(o))),!1===i)if(n.isPerspectiveCamera)l=l.mul(a.z.negate());else{const e=nE(2).div(FR.element(1).element(1));l=l.mul(e.mul(2))}let c=ZR.xy;if(t.center&&!0===t.center.isVector2){const e=((e,t,n)=>HM(new ZC(e,t,n)))("center","vec2",t);c=c.sub(e.sub(.5))}c=c.mul(l);const u=nE(s||dP),h=nk(c,u);return fE(a.xy.add(h),a.zw)}copy(e){return this.positionNode=e.positionNode,this.rotationNode=e.rotationNode,this.scaleNode=e.scaleNode,super.copy(e)}get sizeAttenuation(){return this._useSizeAttenuation}set sizeAttenuation(e){this._useSizeAttenuation!==e&&(this._useSizeAttenuation=e,this.needsUpdate=!0)}}const sk=new tp;class ok extends rk{static get type(){return"PointsNodeMaterial"}constructor(e){super(),this.sizeNode=null,this.isPointsNodeMaterial=!0,this.setDefaultValues(sk),this.setValues(e)}setupPositionView(){const{positionNode:e}=this;return XR.mul(uE(e||JR)).xyz}setupVertex(e){const t=super.setupVertex(e);if(!0!==e.material.isNodeMaterial)return t;const{rotationNode:n,scaleNode:i,sizeNode:r}=this,s=ZR.xy.toVar(),o=cD.z.div(cD.w);if(n&&n.isNode){const e=nE(n);s.assign(nk(s,e))}let a=null!==r?oE(r):CP;return!0===this.sizeAttenuation&&(a=a.mul(a.div(nN.z.negate()))),i&&i.isNode&&(a=a.mul(oE(i))),s.mulAssign(a.mul(2)),s.assign(s.div(cD.z)),s.y.assign(s.y.mul(o)),s.assign(s.mul(t.w)),t.addAssign(fE(s,0,0)),t}get alphaToCoverage(){return this._useAlphaToCoverage}set alphaToCoverage(e){this._useAlphaToCoverage!==e&&(this._useAlphaToCoverage=e,this.needsUpdate=!0)}}class ak extends WD{constructor(){super(),this.shadowNode=nE(1).toVar("shadowMask")}direct({lightNode:e}){null!==e.shadowNode&&this.shadowNode.mulAssign(e.shadowNode)}finish({context:e}){SE.a.mulAssign(this.shadowNode.oneMinus()),e.outgoingLight.rgb.assign(SE.rgb)}}const lk=new wp;class ck extends CD{static get type(){return"ShadowNodeMaterial"}constructor(e){super(),this.isShadowNodeMaterial=!0,this.lights=!0,this.transparent=!0,this.setDefaultValues(lk),this.setValues(e)}setupLightingModel(){return new ak}}wE("vec3"),wE("vec3"),wE("vec3");class uk{constructor(e,t){this.nodes=e,this.info=t,this._context="undefined"!=typeof self?self:null,this._animationLoop=null,this._requestId=null}start(){const e=(t,n)=>{this._requestId=this._context.requestAnimationFrame(e),!0===this.info.autoReset&&this.info.reset(),this.nodes.nodeFrame.update(),this.info.frame=this.nodes.nodeFrame.frameId,null!==this._animationLoop&&this._animationLoop(t,n)};e()}stop(){this._context.cancelAnimationFrame(this._requestId),this._requestId=null}getAnimationLoop(){return this._animationLoop}setAnimationLoop(e){this._animationLoop=e}getContext(){return this._context}setContext(e){this._context=e}dispose(){this.stop()}}class hk{constructor(){this.weakMap=new WeakMap}get(e){let t=this.weakMap;for(let n=0;n<e.length-1;n++)if(t=t.get(e[n]),void 0===t)return;return t.get(e[e.length-1])}set(e,t){let n=this.weakMap;for(let t=0;t<e.length-1;t++){const i=e[t];!1===n.has(i)&&n.set(i,new WeakMap),n=n.get(i)}return n.set(e[e.length-1],t),this}delete(e){let t=this.weakMap;for(let n=0;n<e.length-1;n++)if(t=t.get(e[n]),void 0===t)return!1;return t.delete(e[e.length-1])}}let dk=0;class pk{constructor(e,t,n,i,r,s,o,a,l,c){this.id=dk++,this._nodes=e,this._geometries=t,this.renderer=n,this.object=i,this.material=r,this.scene=s,this.camera=o,this.lightsNode=a,this.context=l,this.geometry=i.geometry,this.version=r.version,this.drawRange=null,this.attributes=null,this.pipeline=null,this.group=null,this.vertexBuffers=null,this.drawParams=null,this.bundle=null,this.clippingContext=c,this.clippingContextCacheKey=null!==c?c.cacheKey:"",this.initialNodesCacheKey=this.getDynamicCacheKey(),this.initialCacheKey=this.getCacheKey(),this._nodeBuilderState=null,this._bindings=null,this._monitor=null,this.onDispose=null,this.isRenderObject=!0,this.onMaterialDispose=()=>{this.dispose()},this.material.addEventListener("dispose",this.onMaterialDispose)}updateClipping(e){this.clippingContext=e}get clippingNeedsUpdate(){return null!==this.clippingContext&&this.clippingContext.cacheKey!==this.clippingContextCacheKey&&(this.clippingContextCacheKey=this.clippingContext.cacheKey,!0)}get hardwareClippingPlanes(){return!0===this.material.hardwareClipping?this.clippingContext.unionClippingCount:0}getNodeBuilderState(){return this._nodeBuilderState||(this._nodeBuilderState=this._nodes.getForRender(this))}getMonitor(){return this._monitor||(this._monitor=this.getNodeBuilderState().observer)}getBindings(){return this._bindings||(this._bindings=this.getNodeBuilderState().createBindings())}getBindingGroup(e){for(const t of this.getBindings())if(t.name===e)return t}getIndex(){return this._geometries.getIndex(this)}getIndirect(){return this._geometries.getIndirect(this)}getChainArray(){return[this.object,this.material,this.context,this.lightsNode]}setGeometry(e){this.geometry=e,this.attributes=null}getAttributes(){if(null!==this.attributes)return this.attributes;const e=this.getNodeBuilderState().nodeAttributes,t=this.geometry,n=[],i=new Set;for(const r of e){const e=r.node&&r.node.attribute?r.node.attribute:t.getAttribute(r.name);if(void 0===e)continue;n.push(e);const s=e.isInterleavedBufferAttribute?e.data:e;i.add(s)}return this.attributes=n,this.vertexBuffers=Array.from(i.values()),n}getVertexBuffers(){return null===this.vertexBuffers&&this.getAttributes(),this.vertexBuffers}getDrawParameters(){const{object:e,material:t,geometry:n,group:i,drawRange:r}=this,s=this.drawParams||(this.drawParams={vertexCount:0,firstVertex:0,instanceCount:0,firstInstance:0}),o=this.getIndex(),a=null!==o;let l=1;if(!0===n.isInstancedBufferGeometry?l=n.instanceCount:void 0!==e.count&&(l=Math.max(0,e.count)),0===l)return null;if(s.instanceCount=l,!0===e.isBatchedMesh)return s;let c=1;!0!==t.wireframe||e.isPoints||e.isLineSegments||e.isLine||e.isLineLoop||(c=2);let u=r.start*c,h=(r.start+r.count)*c;null!==i&&(u=Math.max(u,i.start*c),h=Math.min(h,(i.start+i.count)*c));const d=n.attributes.position;let p=1/0;a?p=o.count:null!=d&&(p=d.count),u=Math.max(u,0),h=Math.min(h,p);const f=h-u;return f<0||f===1/0?null:(s.vertexCount=f,s.firstVertex=u,s)}getGeometryCacheKey(){const{geometry:e}=this;let t="";for(const n of Object.keys(e.attributes).sort()){const i=e.attributes[n];t+=n+",",i.data&&(t+=i.data.stride+","),i.offset&&(t+=i.offset+","),i.itemSize&&(t+=i.itemSize+","),i.normalized&&(t+="n,")}for(const n of Object.keys(e.morphAttributes).sort()){const i=e.morphAttributes[n];t+="morph-"+n+",";for(let e=0,n=i.length;e<n;e++){t+=i[e].id+","}}return e.index&&(t+="index,"),t}getMaterialCacheKey(){const{object:e,material:t}=this;let n=t.customProgramCacheKey();for(const e of function(e){const t=Object.keys(e);let n=Object.getPrototypeOf(e);for(;n;){const e=Object.getOwnPropertyDescriptors(n);for(const n in e)if(void 0!==e[n]){const i=e[n];i&&"function"==typeof i.get&&t.push(n)}n=Object.getPrototypeOf(n)}return t}(t)){if(/^(is[A-Z]|_)|^(visible|version|uuid|name|opacity|userData)$/.test(e))continue;const i=t[e];let r;if(null!==i){const e=typeof i;"number"===e?r=0!==i?"1":"0":"object"===e?(r="{",i.isTexture&&(r+=i.mapping),r+="}"):r=String(i)}else r=String(i);n+=r+","}return n+=this.clippingContextCacheKey+",",e.geometry&&(n+=this.getGeometryCacheKey()),e.skeleton&&(n+=e.skeleton.bones.length+","),e.isBatchedMesh&&(n+=e._matricesTexture.uuid+",",null!==e._colorsTexture&&(n+=e._colorsTexture.uuid+",")),e.count>1&&(n+=e.uuid+","),n+=e.receiveShadow+",",IS(n)}get needsGeometryUpdate(){return this.geometry.id!==this.object.geometry.id}get needsUpdate(){return this.initialNodesCacheKey!==this.getDynamicCacheKey()||this.clippingNeedsUpdate}getDynamicCacheKey(){let e=0;return!0!==this.material.isShadowPassMaterial&&(e=this._nodes.getCacheKey(this.scene,this.lightsNode)),this.camera.isArrayCamera&&(e=OS(e,this.camera.cameras.length)),this.object.receiveShadow&&(e=OS(e,1)),e}getCacheKey(){return this.getMaterialCacheKey()+this.getDynamicCacheKey()}dispose(){this.material.removeEventListener("dispose",this.onMaterialDispose),this.onDispose()}}const fk=[];class mk{constructor(e,t,n,i,r,s){this.renderer=e,this.nodes=t,this.geometries=n,this.pipelines=i,this.bindings=r,this.info=s,this.chainMaps={}}get(e,t,n,i,r,s,o,a){const l=this.getChainMap(a);fk[0]=e,fk[1]=t,fk[2]=s,fk[3]=r;let c=l.get(fk);return void 0===c?(c=this.createRenderObject(this.nodes,this.geometries,this.renderer,e,t,n,i,r,s,o,a),l.set(fk,c)):(c.updateClipping(o),c.needsGeometryUpdate&&c.setGeometry(e.geometry),(c.version!==t.version||c.needsUpdate)&&(c.initialCacheKey!==c.getCacheKey()?(c.dispose(),c=this.get(e,t,n,i,r,s,o,a)):c.version=t.version)),fk.length=0,c}getChainMap(e="default"){return this.chainMaps[e]||(this.chainMaps[e]=new hk)}dispose(){this.chainMaps={}}createRenderObject(e,t,n,i,r,s,o,a,l,c,u){const h=this.getChainMap(u),d=new pk(e,t,n,i,r,s,o,a,l,c);return d.onDispose=()=>{this.pipelines.delete(d),this.bindings.delete(d),this.nodes.delete(d),h.delete(d.getChainArray())},d}}class gk{constructor(){this.data=new WeakMap}get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}delete(e){let t=null;return this.data.has(e)&&(t=this.data.get(e),this.data.delete(e)),t}has(e){return this.data.has(e)}dispose(){this.data=new WeakMap}}const yk=1,vk=2,_k=3,xk=4,bk=16;class wk extends gk{constructor(e){super(),this.backend=e}delete(e){const t=super.delete(e);return null!==t&&this.backend.destroyAttribute(e),t}update(e,t){const n=this.get(e);if(void 0===n.version)t===yk?this.backend.createAttribute(e):t===vk?this.backend.createIndexAttribute(e):t===_k?this.backend.createStorageAttribute(e):t===xk&&this.backend.createIndirectStorageAttribute(e),n.version=this._getBufferAttribute(e).version;else{const t=this._getBufferAttribute(e);(n.version<t.version||t.usage===fc)&&(this.backend.updateAttribute(e),n.version=t.version)}}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}}function Tk(e){return null!==e.index?e.index.version:e.attributes.position.version}function Sk(e){const t=[],n=e.index,i=e.attributes.position;if(null!==n){const e=n.array;for(let n=0,i=e.length;n<i;n+=3){const i=e[n+0],r=e[n+1],s=e[n+2];t.push(i,r,r,s,s,i)}}else{for(let e=0,n=i.array.length/3-1;e<n;e+=3){const n=e+0,i=e+1,r=e+2;t.push(n,i,i,r,r,n)}}const r=new(Uc(t)?zh:Bh)(t,1);return r.version=Tk(e),r}class Mk extends gk{constructor(e,t){super(),this.attributes=e,this.info=t,this.wireframes=new WeakMap,this.attributeCall=new WeakMap}has(e){const t=e.geometry;return super.has(t)&&!0===this.get(t).initialized}updateForRender(e){!1===this.has(e)&&this.initGeometry(e),this.updateAttributes(e)}initGeometry(e){const t=e.geometry;this.get(t).initialized=!0,this.info.memory.geometries++;const n=()=>{this.info.memory.geometries--;const i=t.index,r=e.getAttributes();null!==i&&this.attributes.delete(i);for(const e of r)this.attributes.delete(e);const s=this.wireframes.get(t);void 0!==s&&this.attributes.delete(s),t.removeEventListener("dispose",n)};t.addEventListener("dispose",n)}updateAttributes(e){const t=e.getAttributes();for(const e of t)e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute?this.updateAttribute(e,_k):this.updateAttribute(e,yk);const n=this.getIndex(e);null!==n&&this.updateAttribute(n,vk);const i=e.geometry.indirect;null!==i&&this.updateAttribute(i,xk)}updateAttribute(e,t){const n=this.info.render.calls;e.isInterleavedBufferAttribute?void 0===this.attributeCall.get(e)?(this.attributes.update(e,t),this.attributeCall.set(e,n)):this.attributeCall.get(e.data)!==n&&(this.attributes.update(e,t),this.attributeCall.set(e.data,n),this.attributeCall.set(e,n)):this.attributeCall.get(e)!==n&&(this.attributes.update(e,t),this.attributeCall.set(e,n))}getIndirect(e){return e.geometry.indirect}getIndex(e){const{geometry:t,material:n}=e;let i=t.index;if(!0===n.wireframe){const e=this.wireframes;let n=e.get(t);void 0===n?(n=Sk(t),e.set(t,n)):n.version!==Tk(t)&&(this.attributes.delete(n),n=Sk(t),e.set(t,n)),i=n}return i}}class Ek{constructor(){this.autoReset=!0,this.frame=0,this.calls=0,this.render={calls:0,frameCalls:0,drawCalls:0,triangles:0,points:0,lines:0,timestamp:0},this.compute={calls:0,frameCalls:0,timestamp:0},this.memory={geometries:0,textures:0}}update(e,t,n){this.render.drawCalls++,e.isMesh||e.isSprite?this.render.triangles+=n*(t/3):e.isPoints?this.render.points+=n*t:e.isLineSegments?this.render.lines+=n*(t/2):e.isLine?this.render.lines+=n*(t-1):console.error("THREE.WebGPUInfo: Unknown object type.")}reset(){this.render.drawCalls=0,this.render.frameCalls=0,this.compute.frameCalls=0,this.render.triangles=0,this.render.points=0,this.render.lines=0}dispose(){this.reset(),this.calls=0,this.render.calls=0,this.compute.calls=0,this.render.timestamp=0,this.compute.timestamp=0,this.memory.geometries=0,this.memory.textures=0}}class Ak{constructor(e){this.cacheKey=e,this.usedTimes=0}}class Ck extends Ak{constructor(e,t,n){super(e),this.vertexProgram=t,this.fragmentProgram=n}}class Rk extends Ak{constructor(e,t){super(e),this.computeProgram=t,this.isComputePipeline=!0}}let Nk=0;class Pk{constructor(e,t,n,i=null,r=null){this.id=Nk++,this.code=e,this.stage=t,this.name=n,this.transforms=i,this.attributes=r,this.usedTimes=0}}class Dk extends gk{constructor(e,t){super(),this.backend=e,this.nodes=t,this.bindings=null,this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}getForCompute(e,t){const{backend:n}=this,i=this.get(e);if(this._needsComputeUpdate(e)){const r=i.pipeline;r&&(r.usedTimes--,r.computeProgram.usedTimes--);const s=this.nodes.getForCompute(e);let o=this.programs.compute.get(s.computeShader);void 0===o&&(r&&0===r.computeProgram.usedTimes&&this._releaseProgram(r.computeProgram),o=new Pk(s.computeShader,"compute",e.name,s.transforms,s.nodeAttributes),this.programs.compute.set(s.computeShader,o),n.createProgram(o));const a=this._getComputeCacheKey(e,o);let l=this.caches.get(a);void 0===l&&(r&&0===r.usedTimes&&this._releasePipeline(r),l=this._getComputePipeline(e,o,a,t)),l.usedTimes++,o.usedTimes++,i.version=e.version,i.pipeline=l}return i.pipeline}getForRender(e,t=null){const{backend:n}=this,i=this.get(e);if(this._needsRenderUpdate(e)){const r=i.pipeline;r&&(r.usedTimes--,r.vertexProgram.usedTimes--,r.fragmentProgram.usedTimes--);const s=e.getNodeBuilderState(),o=e.material?e.material.name:"";let a=this.programs.vertex.get(s.vertexShader);void 0===a&&(r&&0===r.vertexProgram.usedTimes&&this._releaseProgram(r.vertexProgram),a=new Pk(s.vertexShader,"vertex",o),this.programs.vertex.set(s.vertexShader,a),n.createProgram(a));let l=this.programs.fragment.get(s.fragmentShader);void 0===l&&(r&&0===r.fragmentProgram.usedTimes&&this._releaseProgram(r.fragmentProgram),l=new Pk(s.fragmentShader,"fragment",o),this.programs.fragment.set(s.fragmentShader,l),n.createProgram(l));const c=this._getRenderCacheKey(e,a,l);let u=this.caches.get(c);void 0===u?(r&&0===r.usedTimes&&this._releasePipeline(r),u=this._getRenderPipeline(e,a,l,c,t)):e.pipeline=u,u.usedTimes++,a.usedTimes++,l.usedTimes++,i.pipeline=u}return i.pipeline}delete(e){const t=this.get(e).pipeline;return t&&(t.usedTimes--,0===t.usedTimes&&this._releasePipeline(t),t.isComputePipeline?(t.computeProgram.usedTimes--,0===t.computeProgram.usedTimes&&this._releaseProgram(t.computeProgram)):(t.fragmentProgram.usedTimes--,t.vertexProgram.usedTimes--,0===t.vertexProgram.usedTimes&&this._releaseProgram(t.vertexProgram),0===t.fragmentProgram.usedTimes&&this._releaseProgram(t.fragmentProgram))),super.delete(e)}dispose(){super.dispose(),this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}updateForRender(e){this.getForRender(e)}_getComputePipeline(e,t,n,i){n=n||this._getComputeCacheKey(e,t);let r=this.caches.get(n);return void 0===r&&(r=new Rk(n,t),this.caches.set(n,r),this.backend.createComputePipeline(r,i)),r}_getRenderPipeline(e,t,n,i,r){i=i||this._getRenderCacheKey(e,t,n);let s=this.caches.get(i);return void 0===s&&(s=new Ck(i,t,n),this.caches.set(i,s),e.pipeline=s,this.backend.createRenderPipeline(e,r)),s}_getComputeCacheKey(e,t){return e.id+","+t.id}_getRenderCacheKey(e,t,n){return t.id+","+n.id+","+this.backend.getRenderCacheKey(e)}_releasePipeline(e){this.caches.delete(e.cacheKey)}_releaseProgram(e){const t=e.code,n=e.stage;this.programs[n].delete(t)}_needsComputeUpdate(e){const t=this.get(e);return void 0===t.pipeline||t.version!==e.version}_needsRenderUpdate(e){return void 0===this.get(e).pipeline||this.backend.needsRenderUpdate(e)}}class Lk extends gk{constructor(e,t,n,i,r,s){super(),this.backend=e,this.textures=n,this.pipelines=r,this.attributes=i,this.nodes=t,this.info=s,this.pipelines.bindings=this}getForRender(e){const t=e.getBindings();for(const e of t){const n=this.get(e);void 0===n.bindGroup&&(this._init(e),this.backend.createBindings(e,t,0),n.bindGroup=e)}return t}getForCompute(e){const t=this.nodes.getForCompute(e).bindings;for(const e of t){const n=this.get(e);void 0===n.bindGroup&&(this._init(e),this.backend.createBindings(e,t,0),n.bindGroup=e)}return t}updateForCompute(e){this._updateBindings(this.getForCompute(e))}updateForRender(e){this._updateBindings(this.getForRender(e))}_updateBindings(e){for(const t of e)this._update(t,e)}_init(e){for(const t of e.bindings)if(t.isSampledTexture)this.textures.updateTexture(t.texture);else if(t.isStorageBuffer){const e=t.attribute,n=e.isIndirectStorageBufferAttribute?xk:_k;this.attributes.update(e,n)}}_update(e,t){const{backend:n}=this;let i=!1,r=!0,s=0,o=0;for(const t of e.bindings){if(t.isNodeUniformsGroup){if(!1===this.nodes.updateGroup(t))continue}if(t.isStorageBuffer){const e=t.attribute,n=e.isIndirectStorageBufferAttribute?xk:_k;this.attributes.update(e,n)}if(t.isUniformBuffer){t.update()&&n.updateBinding(t)}else if(t.isSampler)t.update();else if(t.isSampledTexture){const e=this.textures.get(t.texture);t.needsBindingsUpdate(e.generation)&&(i=!0);const a=t.update(),l=t.texture;a&&this.textures.updateTexture(l);const c=n.get(l);if(void 0!==c.externalTexture||e.isDefaultTexture?r=!1:(s=10*s+l.id,o+=l.version),!0===n.isWebGPUBackend&&void 0===c.texture&&void 0===c.externalTexture&&(console.error("Bindings._update: binding should be available:",t,a,l,t.textureNode.value,i),this.textures.updateTexture(l),i=!0),!0===l.isStorageTexture){const e=this.get(l);!0===t.store?e.needsMipmap=!0:this.textures.needsMipmaps(l)&&!0===e.needsMipmap&&(this.backend.generateMipmaps(l),e.needsMipmap=!1)}}}!0===i&&this.backend.updateBindings(e,t,r?s:0,o)}}function Ik(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?e.z-t.z:e.id-t.id}function kk(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Ok(e){return(e.transmission>0||e.transmissionNode)&&2===e.side&&!1===e.forceSinglePass}class Uk{constructor(e,t,n){this.renderItems=[],this.renderItemsIndex=0,this.opaque=[],this.transparentDoublePass=[],this.transparent=[],this.bundles=[],this.lightsNode=e.getNode(t,n),this.lightsArray=[],this.scene=t,this.camera=n,this.occlusionQueryCount=0}begin(){return this.renderItemsIndex=0,this.opaque.length=0,this.transparentDoublePass.length=0,this.transparent.length=0,this.bundles.length=0,this.lightsArray.length=0,this.occlusionQueryCount=0,this}getNextRenderItem(e,t,n,i,r,s,o){let a=this.renderItems[this.renderItemsIndex];return void 0===a?(a={id:e.id,object:e,geometry:t,material:n,groupOrder:i,renderOrder:e.renderOrder,z:r,group:s,clippingContext:o},this.renderItems[this.renderItemsIndex]=a):(a.id=e.id,a.object=e,a.geometry=t,a.material=n,a.groupOrder=i,a.renderOrder=e.renderOrder,a.z=r,a.group=s,a.clippingContext=o),this.renderItemsIndex++,a}push(e,t,n,i,r,s,o){const a=this.getNextRenderItem(e,t,n,i,r,s,o);!0===e.occlusionTest&&this.occlusionQueryCount++,!0===n.transparent||n.transmission>0?(Ok(n)&&this.transparentDoublePass.push(a),this.transparent.push(a)):this.opaque.push(a)}unshift(e,t,n,i,r,s,o){const a=this.getNextRenderItem(e,t,n,i,r,s,o);!0===n.transparent||n.transmission>0?(Ok(n)&&this.transparentDoublePass.unshift(a),this.transparent.unshift(a)):this.opaque.unshift(a)}pushBundle(e){this.bundles.push(e)}pushLight(e){this.lightsArray.push(e)}sort(e,t){this.opaque.length>1&&this.opaque.sort(e||Ik),this.transparentDoublePass.length>1&&this.transparentDoublePass.sort(t||kk),this.transparent.length>1&&this.transparent.sort(t||kk)}finish(){this.lightsNode.setLights(this.lightsArray);for(let e=this.renderItemsIndex,t=this.renderItems.length;e<t;e++){const t=this.renderItems[e];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.groupOrder=null,t.renderOrder=null,t.z=null,t.group=null,t.clippingContext=null}}}const Fk=[];class Bk{constructor(e){this.lighting=e,this.lists=new hk}get(e,t){const n=this.lists;Fk[0]=e,Fk[1]=t;let i=n.get(Fk);return void 0===i&&(i=new Uk(this.lighting,e,t),n.set(Fk,i)),Fk.length=0,i}dispose(){this.lists=new hk}}let zk=0;class Vk{constructor(){this.id=zk++,this.color=!0,this.clearColor=!0,this.clearColorValue={r:0,g:0,b:0,a:1},this.depth=!0,this.clearDepth=!0,this.clearDepthValue=1,this.stencil=!1,this.clearStencil=!0,this.clearStencilValue=1,this.viewport=!1,this.viewportValue=new nu,this.scissor=!1,this.scissorValue=new nu,this.renderTarget=null,this.textures=null,this.depthTexture=null,this.activeCubeFace=0,this.activeMipmapLevel=0,this.sampleCount=1,this.width=0,this.height=0,this.occlusionQueryCount=0,this.clippingContext=null,this.isRenderContext=!0}getCacheKey(){return Gk(this)}}function Gk(e){const{textures:t,activeCubeFace:n}=e,i=[n];for(const e of t)i.push(e.id);return kS(i)}const jk=[],Hk=new Cd,Wk=new gd;class qk{constructor(){this.chainMaps={}}get(e,t,n=null){let i;if(jk[0]=e,jk[1]=t,null===n)i="default";else{const e=n.texture.format;i=`${n.textures.length}:${e}:${n.samples}:${n.depthBuffer}:${n.stencilBuffer}`}const r=this._getChainMap(i);let s=r.get(jk);return void 0===s&&(s=new Vk,r.set(jk,s)),jk.length=0,null!==n&&(s.sampleCount=0===n.samples?1:n.samples),s}getForClear(e=null){return this.get(Hk,Wk,e)}_getChainMap(e){return this.chainMaps[e]||(this.chainMaps[e]=new hk)}dispose(){this.chainMaps={}}}const Xk=new Dc;class $k extends gk{constructor(e,t,n){super(),this.renderer=e,this.backend=t,this.info=n}updateRenderTarget(e,t=0){const n=this.get(e),i=0===e.samples?1:e.samples,r=n.depthTextureMips||(n.depthTextureMips={}),s=e.textures,o=this.getSize(s[0]),a=o.width>>t,l=o.height>>t;let c=e.depthTexture||r[t];const u=!0===e.depthBuffer||!0===e.stencilBuffer;let h=!1;void 0===c&&u&&(c=new ip,c.format=e.stencilBuffer?ml:fl,c.type=e.stencilBuffer?cl:rl,c.image.width=a,c.image.height=l,c.image.depth=o.depth,c.isArrayTexture=!0===e.multiview&&o.depth>1,r[t]=c),n.width===o.width&&o.height===n.height||(h=!0,c&&(c.needsUpdate=!0,c.image.width=a,c.image.height=l,c.image.depth=c.isArrayTexture?c.image.depth:1)),n.width=o.width,n.height=o.height,n.textures=s,n.depthTexture=c||null,n.depth=e.depthBuffer,n.stencil=e.stencilBuffer,n.renderTarget=e,n.sampleCount!==i&&(h=!0,c&&(c.needsUpdate=!0),n.sampleCount=i);const d={sampleCount:i};if(!0!==e.isXRRenderTarget){for(let e=0;e<s.length;e++){const t=s[e];h&&(t.needsUpdate=!0),this.updateTexture(t,d)}c&&this.updateTexture(c,d)}if(!0!==n.initialized){n.initialized=!0;const t=()=>{e.removeEventListener("dispose",t);for(let e=0;e<s.length;e++)this._destroyTexture(s[e]);c&&this._destroyTexture(c),this.delete(e)};e.addEventListener("dispose",t)}}updateTexture(e,t={}){const n=this.get(e);if(!0===n.initialized&&n.version===e.version)return;const i=e.isRenderTargetTexture||e.isDepthTexture||e.isFramebufferTexture,r=this.backend;if(i&&!0===n.initialized&&(r.destroySampler(e),r.destroyTexture(e)),e.isFramebufferTexture){const t=this.renderer.getRenderTarget();e.type=t?t.texture.type:Qa}const{width:s,height:o,depth:a}=this.getSize(e);if(t.width=s,t.height=o,t.depth=a,t.needsMipmaps=this.needsMipmaps(e),t.levels=t.needsMipmaps?this.getMipLevels(e,s,o):1,i||!0===e.isStorageTexture)r.createSampler(e),r.createTexture(e,t),n.generation=e.version;else{if(!0!==n.initialized&&r.createSampler(e),e.version>0){const i=e.image;if(void 0===i)console.warn("THREE.Renderer: Texture marked for update but image is undefined.");else if(!1===i.complete)console.warn("THREE.Renderer: Texture marked for update but image is incomplete.");else{if(e.images){const n=[];for(const t of e.images)n.push(t);t.images=n}else t.image=i;void 0!==n.isDefaultTexture&&!0!==n.isDefaultTexture||(r.createTexture(e,t),n.isDefaultTexture=!1,n.generation=e.version),!0===e.source.dataReady&&r.updateTexture(e,t),t.needsMipmaps&&0===e.mipmaps.length&&r.generateMipmaps(e)}}else r.createDefaultTexture(e),n.isDefaultTexture=!0,n.generation=e.version}if(!0!==n.initialized){n.initialized=!0,n.generation=e.version,this.info.memory.textures++;const t=()=>{e.removeEventListener("dispose",t),this._destroyTexture(e)};e.addEventListener("dispose",t)}n.version=e.version}getSize(e,t=Xk){let n=e.images?e.images[0]:e.image;return n?(void 0!==n.image&&(n=n.image),t.width=n.width||1,t.height=n.height||1,t.depth=e.isCubeTexture?6:n.depth||1):t.width=t.height=t.depth=1,t}getMipLevels(e,t,n){let i;return i=e.isCompressedTexture?e.mipmaps?e.mipmaps.length:1:Math.floor(Math.log2(Math.max(t,n)))+1,i}needsMipmaps(e){return!0===e.isCompressedTexture||e.generateMipmaps}_destroyTexture(e){!0===this.has(e)&&(this.backend.destroySampler(e),this.backend.destroyTexture(e),this.delete(e),this.info.memory.textures--)}}class Yk extends Eh{constructor(e,t,n,i=1){super(e,t,n),this.a=i}set(e,t,n,i=1){return this.a=i,super.set(e,t,n)}copy(e){return void 0!==e.a&&(this.a=e.a),super.copy(e)}clone(){return new this.constructor(this.r,this.g,this.b,this.a)}}class Kk extends bE{static get type(){return"ParameterNode"}constructor(e,t=null){super(e,t),this.isParameterNode=!0}getHash(){return this.uuid}generate(){return this.name}}class Zk extends iM{static get type(){return"StackNode"}constructor(e=null){super(),this.nodes=[],this.outputNode=null,this.parent=e,this._currentCond=null,this._expressionNode=null,this.isStackNode=!0}getNodeType(e){return this.outputNode?this.outputNode.getNodeType(e):"void"}getMemberType(e,t){return this.outputNode?this.outputNode.getMemberType(e,t):"void"}add(e){return this.nodes.push(e),this}If(e,t){const n=new jM(t);return this._currentCond=FC(e,n),this.add(this._currentCond)}ElseIf(e,t){const n=new jM(t),i=FC(e,n);return this._currentCond.elseNode=i,this._currentCond=i,this}Else(e){return this._currentCond.elseNode=new jM(e),this}Switch(e){return this._expressionNode=HM(e),this}Case(...e){const t=[];if(!(e.length>=2))throw new Error("TSL: Invalid parameter length. Case() requires at least two parameters.");for(let n=0;n<e.length-1;n++)t.push(this._expressionNode.equal(HM(e[n])));const n=new jM(e[e.length-1]);let i=t[0];for(let e=1;e<t.length;e++)i=i.or(t[e]);const r=FC(i,n);return null===this._currentCond?(this._currentCond=r,this.add(this._currentCond)):(this._currentCond.elseNode=r,this._currentCond=r,this)}Default(e){return this.Else(e),this}build(e,...t){const n=JM();ZM(this);const i=e.buildStage;for(const t of this.nodes)if("setup"===i)t.build(e);else if("analyze"===i)t.build(e,this);else if("generate"===i){const n=e.getDataFromNode(t,"any").stages,i=n&&n[e.shaderStage];if(t.isVarNode&&i&&1===i.length&&i[0]&&i[0].isStackNode)continue;t.build(e,"void")}return ZM(n),this.outputNode?this.outputNode.build(e,...t):super.build(e,...t)}else(...e){return console.warn("THREE.TSL: .else() has been renamed to .Else()."),this.Else(...e)}elseif(...e){return console.warn("THREE.TSL: .elseif() has been renamed to .ElseIf()."),this.ElseIf(...e)}}const Jk=XM(Zk).setParameterLength(0,1);new Fd,new Dc,new Dc,new Dc,new Iu,new Dc(0,0,-1),new nu,new Dc,new Dc,new nu,new Nc;const Qk=new iu;oD.flipX(),Qk.depthTexture=new ip(1,1);const eO=new Zp(-1,1,1,-1,0,1);class tO extends Kh{constructor(e=!1){super();const t=!1===e?[0,-1,0,1,2,1]:[0,2,0,0,2,0];this.setAttribute("position",new Gh([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Gh(t,2))}}const nO=new tO;class iO extends ld{constructor(e=null){super(nO,e),this.camera=eO,this.isQuadMesh=!0}async renderAsync(e){return e.renderAsync(this,eO)}render(e){e.render(this,eO)}}const rO=new Hu,sO=new Iu;class oO extends iM{static get type(){return"SceneNode"}constructor(e=oO.BACKGROUND_BLURRINESS,t=null){super(),this.scope=e,this.scene=t}setup(e){const t=this.scope,n=null!==this.scene?this.scene:e.scene;let i;return t===oO.BACKGROUND_BLURRINESS?i=PN("backgroundBlurriness","float",n):t===oO.BACKGROUND_INTENSITY?i=PN("backgroundIntensity","float",n):t===oO.BACKGROUND_ROTATION?i=rA("mat4").label("backgroundRotation").setGroup(tA).onRenderUpdate((()=>{const e=n.background;return null!==e&&e.isTexture&&300!==e.mapping?(rO.copy(n.backgroundRotation),rO.x*=-1,rO.y*=-1,rO.z*=-1,sO.makeRotationFromEuler(rO)):sO.identity(),sO})):console.error("THREE.SceneNode: Unknown scope:",t),i}}oO.BACKGROUND_BLURRINESS="backgroundBlurriness",oO.BACKGROUND_INTENSITY="backgroundIntensity",oO.BACKGROUND_ROTATION="backgroundRotation";const aO=$M(oO,oO.BACKGROUND_BLURRINESS),lO=$M(oO,oO.BACKGROUND_INTENSITY),cO=$M(oO,oO.BACKGROUND_ROTATION),uO=KM((({texture:e,uv:t})=>{const n=1e-4,i=uE().toVar();return QM(t.x.lessThan(n),(()=>{i.assign(uE(1,0,0))})).ElseIf(t.y.lessThan(n),(()=>{i.assign(uE(0,1,0))})).ElseIf(t.z.lessThan(n),(()=>{i.assign(uE(0,0,1))})).ElseIf(t.x.greaterThan(.9999),(()=>{i.assign(uE(-1,0,0))})).ElseIf(t.y.greaterThan(.9999),(()=>{i.assign(uE(0,-1,0))})).ElseIf(t.z.greaterThan(.9999),(()=>{i.assign(uE(0,0,-1))})).Else((()=>{const n=.01,r=e.sample(t.add(uE(-.01,0,0))).r.sub(e.sample(t.add(uE(n,0,0))).r),s=e.sample(t.add(uE(0,-.01,0))).r.sub(e.sample(t.add(uE(0,n,0))).r),o=e.sample(t.add(uE(0,0,-.01))).r.sub(e.sample(t.add(uE(0,0,n))).r);i.assign(uE(r,s,o))})),i.normalize()}));class hO extends MR{static get type(){return"Texture3DNode"}constructor(e,t=null,n=null){super(e,t,n),this.isTexture3DNode=!0}getInputType(){return"texture3D"}getDefaultUV(){return uE(.5,.5,.5)}setUpdateMatrix(){}setupUV(e,t){const n=this.value;return!e.isFlipY()||!0!==n.isRenderTargetTexture&&!0!==n.isFramebufferTexture||(t=this.sampler?t.flipY():t.setY(iE(bR(this,this.levelNode).y).sub(t.y).sub(1))),t}generateUV(e,t){return t.build(e,"vec3")}normal(e){return uO({texture:this,uv:e})}}const dO=XM(hO).setParameterLength(1,3),pO=new Nc;class fO extends MR{static get type(){return"PassTextureNode"}constructor(e,t){super(t),this.passNode=e,this.setUpdateMatrix(!1)}setup(e){return e.object.isQuadMesh&&this.passNode.build(e),super.setup(e)}clone(){return new this.constructor(this.passNode,this.value)}}class mO extends fO{static get type(){return"PassMultipleTextureNode"}constructor(e,t,n=!1){super(e,null),this.textureName=t,this.previousTexture=n}updateTexture(){this.value=this.previousTexture?this.passNode.getPreviousTexture(this.textureName):this.passNode.getTexture(this.textureName)}setup(e){return this.updateTexture(),super.setup(e)}clone(){return new this.constructor(this.passNode,this.textureName,this.previousTexture)}}class gO extends oM{static get type(){return"PassNode"}constructor(e,t,n,i={}){super("vec4"),this.scope=e,this.scene=t,this.camera=n,this.options=i,this._pixelRatio=1,this._width=1,this._height=1;const r=new ip;r.isRenderTargetTexture=!0,r.name="depth";const s=new iu(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:ol,...i});s.texture.name="output",s.depthTexture=r,this.renderTarget=s,this._textures={output:s.texture,depth:r},this._textureNodes={},this._linearDepthNodes={},this._viewZNodes={},this._previousTextures={},this._previousTextureNodes={},this._cameraNear=rA(0),this._cameraFar=rA(0),this._mrt=null,this._layers=null,this._resolution=1,this.isPassNode=!0,this.updateBeforeType=qS,this.global=!0}setResolution(e){return this._resolution=e,this}getResolution(){return this._resolution}setLayers(e){return this._layers=e,this}getLayers(){return this._layers}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}getTexture(e){let t=this._textures[e];if(void 0===t){t=this.renderTarget.texture.clone(),t.name=e,this._textures[e]=t,this.renderTarget.textures.push(t)}return t}getPreviousTexture(e){let t=this._previousTextures[e];return void 0===t&&(t=this.getTexture(e).clone(),this._previousTextures[e]=t),t}toggleTexture(e){const t=this._previousTextures[e];if(void 0!==t){const n=this._textures[e],i=this.renderTarget.textures.indexOf(n);this.renderTarget.textures[i]=t,this._textures[e]=t,this._previousTextures[e]=n,this._textureNodes[e].updateTexture(),this._previousTextureNodes[e].updateTexture()}}getTextureNode(e="output"){let t=this._textureNodes[e];return void 0===t&&(t=HM(new mO(this,e)),t.updateTexture(),this._textureNodes[e]=t),t}getPreviousTextureNode(e="output"){let t=this._previousTextureNodes[e];return void 0===t&&(void 0===this._textureNodes[e]&&this.getTextureNode(e),t=HM(new mO(this,e,!0)),t.updateTexture(),this._previousTextureNodes[e]=t),t}getViewZNode(e="depth"){let t=this._viewZNodes[e];if(void 0===t){const n=this._cameraNear,i=this._cameraFar;this._viewZNodes[e]=t=_D(this.getTextureNode(e),n,i)}return t}getLinearDepthNode(e="depth"){let t=this._linearDepthNodes[e];if(void 0===t){const n=this._cameraNear,i=this._cameraFar,r=this.getViewZNode(e);this._linearDepthNodes[e]=t=yD(r,n,i)}return t}setup({renderer:e}){return this.renderTarget.samples=void 0===this.options.samples?e.samples:this.options.samples,!0===e.backend.isWebGLBackend&&(this.renderTarget.samples=0),this.renderTarget.texture.type=e.getColorBufferType(),this.scope===gO.COLOR?this.getTextureNode():this.getLinearDepthNode()}updateBefore(e){const{renderer:t}=e,{scene:n}=this;let i,r;const s=t.getOutputRenderTarget();s&&!0===s.isXRRenderTarget?(r=1,i=t.xr.getCamera(),t.xr.updateCamera(i),pO.set(s.width,s.height)):(i=this.camera,r=t.getPixelRatio(),t.getSize(pO)),this._pixelRatio=r,this.setSize(pO.width,pO.height);const o=t.getRenderTarget(),a=t.getMRT(),l=i.layers.mask;this._cameraNear.value=i.near,this._cameraFar.value=i.far,null!==this._layers&&(i.layers.mask=this._layers.mask);for(const e in this._previousTextures)this.toggleTexture(e);t.setRenderTarget(this.renderTarget),t.setMRT(this._mrt),t.render(n,i),t.setRenderTarget(o),t.setMRT(a),i.layers.mask=l}setSize(e,t){this._width=e,this._height=t;const n=this._width*this._pixelRatio*this._resolution,i=this._height*this._pixelRatio*this._resolution;this.renderTarget.setSize(n,i)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget.dispose()}}gO.COLOR="color",gO.DEPTH="depth";const yO=KM((([e,t])=>e.mul(t).clamp())).setLayout({name:"linearToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),vO=KM((([e,t])=>(e=e.mul(t)).div(e.add(1)).clamp())).setLayout({name:"reinhardToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),_O=KM((([e,t])=>{const n=(e=(e=e.mul(t)).sub(.004).max(0)).mul(e.mul(6.2).add(.5)),i=e.mul(e.mul(6.2).add(1.7)).add(.06);return n.div(i).pow(2.2)})).setLayout({name:"cineonToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),xO=KM((([e])=>{const t=e.mul(e.add(.0245786)).sub(90537e-9),n=e.mul(e.add(.432951).mul(.983729)).add(.238081);return t.div(n)})),bO=KM((([e,t])=>{const n=_E(.59719,.35458,.04823,.076,.90834,.01566,.0284,.13383,.83777),i=_E(1.60475,-.53108,-.07367,-.10208,1.10813,-.00605,-.00327,-.07276,1.07602);return e=e.mul(t).div(.6),e=n.mul(e),e=xO(e),(e=i.mul(e)).clamp()})).setLayout({name:"acesFilmicToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),wO=_E(uE(1.6605,-.1246,-.0182),uE(-.5876,1.1329,-.1006),uE(-.0728,-.0083,1.1187)),TO=_E(uE(.6274,.0691,.0164),uE(.3293,.9195,.088),uE(.0433,.0113,.8956)),SO=KM((([e])=>{const t=uE(e).toVar(),n=uE(t.mul(t)).toVar(),i=uE(n.mul(n)).toVar();return nE(15.5).mul(i.mul(n)).sub(dA(40.14,i.mul(t))).add(dA(31.96,i).sub(dA(6.868,n.mul(t))).add(dA(.4298,n).add(dA(.1191,t).sub(.00232))))})),MO=KM((([e,t])=>{const n=uE(e).toVar(),i=_E(uE(.856627153315983,.137318972929847,.11189821299995),uE(.0951212405381588,.761241990602591,.0767994186031903),uE(.0482516061458583,.101439036467562,.811302368396859)),r=_E(uE(1.1271005818144368,-.1413297634984383,-.14132976349843826),uE(-.11060664309660323,1.157823702216272,-.11060664309660294),uE(-.016493938717834573,-.016493938717834257,1.2519364065950405)),s=nE(-12.47393),o=nE(4.026069);return n.mulAssign(t),n.assign(TO.mul(n)),n.assign(i.mul(n)),n.assign(yC(n,1e-10)),n.assign(WA(n)),n.assign(n.sub(s).div(o.sub(s))),n.assign(PC(n,0,1)),n.assign(SO(n)),n.assign(r.mul(n)),n.assign(SC(yC(uE(0),n),uE(2.2))),n.assign(wO.mul(n)),n.assign(PC(n,0,1)),n})).setLayout({name:"agxToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),EO=KM((([e,t])=>{const n=nE(.76),i=nE(.15);e=e.mul(t);const r=gC(e.r,gC(e.g,e.b)),s=FC(r.lessThan(.08),r.sub(dA(6.25,r.mul(r))),.04);e.subAssign(s);const o=yC(e.r,yC(e.g,e.b));QM(o.lessThan(n),(()=>e));const a=hA(1,n),l=hA(1,a.mul(a).div(o.add(a.sub(n))));e.mulAssign(l.div(o));const c=hA(1,pA(1,i.mul(o.sub(l)).add(1)));return NC(e,uE(l),c)})).setLayout({name:"neutralToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]});class AO extends iM{static get type(){return"CodeNode"}constructor(e="",t=[],n=""){super("code"),this.isCodeNode=!0,this.global=!0,this.code=e,this.includes=t,this.language=n}setIncludes(e){return this.includes=e,this}getIncludes(){return this.includes}generate(e){const t=this.getIncludes(e);for(const n of t)n.build(e);const n=e.getCodeFromNode(this,this.getNodeType(e));return n.code=this.code,n.code}serialize(e){super.serialize(e),e.code=this.code,e.language=this.language}deserialize(e){super.deserialize(e),this.code=e.code,this.language=e.language}}class CO extends AO{static get type(){return"FunctionNode"}constructor(e="",t=[],n=""){super(e,t,n)}getNodeType(e){return this.getNodeFunction(e).type}getInputs(e){return this.getNodeFunction(e).inputs}getNodeFunction(e){const t=e.getDataFromNode(this);let n=t.nodeFunction;return void 0===n&&(n=e.parser.parseFunction(this.code),t.nodeFunction=n),n}generate(e,t){super.generate(e);const n=this.getNodeFunction(e),i=n.name,r=n.type,s=e.getCodeFromNode(this,r);""!==i&&(s.name=i);const o=e.getPropertyName(s),a=this.getNodeFunction(e).getCode(o);return s.code=a+"\n","property"===t?o:e.format(`${o}()`,r,t)}}function RO(e){let t;const n=e.context.getViewZ;return void 0!==n&&(t=n(this)),(t||nN.z).negate()}const NO=KM((([e,t],n)=>{const i=RO(n);return IC(e,t,i)})),PO=KM((([e],t)=>{const n=RO(t);return e.mul(e,n,n).negate().exp().oneMinus()})),DO=KM((([e,t])=>fE(t.toFloat().mix(GE.rgb,e.toVec3()),GE.a)));XM(class extends iM{constructor(e){super(),this.scope=e}generate(e){const{scope:t}=this,{renderer:n}=e;!0===n.backend.isWebGLBackend?e.addFlowCode(`\t// ${t}Barrier \n`):e.addLineFlowCode(`${t}Barrier()`,this)}});class LO extends iM{static get type(){return"AtomicFunctionNode"}constructor(e,t,n){super("uint"),this.method=e,this.pointerNode=t,this.valueNode=n,this.parents=!0}getInputType(e){return this.pointerNode.getNodeType(e)}getNodeType(e){return this.getInputType(e)}generate(e){const t=e.getNodeProperties(this),n=t.parents,i=this.method,r=this.getNodeType(e),s=this.getInputType(e),o=this.pointerNode,a=this.valueNode,l=[];l.push(`&${o.build(e,s)}`),null!==a&&l.push(a.build(e,s));const c=`${e.getMethod(i,r)}( ${l.join(", ")} )`;if(!(1===n.length&&!0===n[0].isStackNode))return void 0===t.constNode&&(t.constNode=fR(c,r).toConst()),t.constNode.build(e);e.addLineFlowCode(c,this)}}let IO;function kO(e){IO=IO||new WeakMap;let t=IO.get(e);return void 0===t&&IO.set(e,t={}),t}function OO(e){const t=kO(e);return t.shadowMatrix||(t.shadowMatrix=rA("mat4").setGroup(tA).onRenderUpdate((t=>(!0===e.castShadow&&!1!==t.renderer.shadowMap.enabled||e.shadow.updateMatrices(e),e.shadow.matrix))))}function UO(e){const t=kO(e);return t.position||(t.position=rA(new Dc).setGroup(tA).onRenderUpdate(((t,n)=>n.value.setFromMatrixPosition(e.matrixWorld))))}function FO(e){const t=kO(e);return t.viewPosition||(t.viewPosition=rA(new Dc).setGroup(tA).onRenderUpdate((({camera:t},n)=>{n.value=n.value||new Dc,n.value.setFromMatrixPosition(e.matrixWorld),n.value.applyMatrix4(t.matrixWorldInverse)})))}LO.ATOMIC_LOAD="atomicLoad",LO.ATOMIC_STORE="atomicStore",LO.ATOMIC_ADD="atomicAdd",LO.ATOMIC_SUB="atomicSub",LO.ATOMIC_MAX="atomicMax",LO.ATOMIC_MIN="atomicMin",LO.ATOMIC_AND="atomicAnd",LO.ATOMIC_OR="atomicOr",LO.ATOMIC_XOR="atomicXor",XM(LO);const BO=e=>BR.transformDirection(UO(e).sub(function(e){const t=kO(e);return t.targetPosition||(t.targetPosition=rA(new Dc).setGroup(tA).onRenderUpdate(((t,n)=>n.value.setFromMatrixPosition(e.target.matrixWorld))))}(e))),zO=(e,t)=>{for(const n of t)if(n.isAnalyticLightNode&&n.light.id===e)return n;return null},VO=new WeakMap,GO=[];class jO extends iM{static get type(){return"LightsNode"}constructor(){super("vec3"),this.totalDiffuseNode=uE().toVar(),this.totalSpecularNode=uE().toVar(),this.outgoingLightNode=uE().toVar(),this._lights=[],this._lightNodes=null,this._lightNodesHash=null,this.global=!0}customCacheKey(){const e=this._lights;for(let t=0;t<e.length;t++){const n=e[t];if(GO.push(n.id),GO.push(n.castShadow?1:0),!0===n.isSpotLight){const e=null!==n.map?n.map.id:-1,t=n.colorNode?n.colorNode.getCacheKey():-1;GO.push(e,t)}}const t=kS(GO);return GO.length=0,t}getHash(e){if(null===this._lightNodesHash){null===this._lightNodes&&this.setupLightsNode(e);const t=[];for(const e of this._lightNodes)t.push(e.getSelf().getHash());this._lightNodesHash="lights-"+t.join(",")}return this._lightNodesHash}analyze(e){const t=e.getNodeProperties(this);for(const n of t.nodes)n.build(e);t.outputNode.build(e)}setupLightsNode(e){const t=[],n=this._lightNodes,i=(e=>e.sort(((e,t)=>e.id-t.id)))(this._lights),r=e.renderer.library;for(const e of i)if(e.isNode)t.push(HM(e));else{let i=null;if(null!==n&&(i=zO(e.id,n)),null===i){const n=r.getLightNodeClass(e.constructor);if(null===n){console.warn(`LightsNode.setupNodeLights: Light node not found for ${e.constructor.name}`);continue}let i=null;VO.has(e)?i=VO.get(e):(i=HM(new n(e)),VO.set(e,i)),t.push(i)}}this._lightNodes=t}setupDirectLight(e,t,n){const{lightingModel:i,reflectedLight:r}=e.context;i.direct({...n,lightNode:t,reflectedLight:r},e)}setupDirectRectAreaLight(e,t,n){const{lightingModel:i,reflectedLight:r}=e.context;i.directRectArea({...n,lightNode:t,reflectedLight:r},e)}setupLights(e,t){for(const n of t)n.build(e)}getLightNodes(e){return null===this._lightNodes&&this.setupLightsNode(e),this._lightNodes}setup(e){const t=e.lightsNode;e.lightsNode=this;let n=this.outgoingLightNode;const i=e.context,r=i.lightingModel,s=e.getNodeProperties(this);if(r){const{totalDiffuseNode:t,totalSpecularNode:o}=this;i.outgoingLight=n;const a=e.addStack();s.nodes=a.nodes,r.start(e);const{backdrop:l,backdropAlpha:c}=i,{directDiffuse:u,directSpecular:h,indirectDiffuse:d,indirectSpecular:p}=i.reflectedLight;let f=u.add(d);null!==l&&(f=uE(null!==c?c.mix(f,l):l),i.material.transparent=!0),t.assign(f),o.assign(h.add(p)),n.assign(t.add(o)),r.finish(e),n=n.bypass(e.removeStack())}else s.nodes=[];return e.lightsNode=t,n}setLights(e){return this._lights=e,this._lightNodes=null,this._lightNodesHash=null,this}getLights(){return this._lights}get hasLights(){return this._lights.length>0}}class HO extends iM{static get type(){return"ShadowBaseNode"}constructor(e){super(),this.light=e,this.updateBeforeType=XS,this.isShadowBaseNode=!0}setupShadowPosition({context:e,material:t}){WO.assign(t.receivedShadowPositionNode||e.shadowPositionWorld||eN)}}const WO=wE("vec3","shadowPositionWorld");function qO(e,t){return t=function(e,t={}){return t.toneMapping=e.toneMapping,t.toneMappingExposure=e.toneMappingExposure,t.outputColorSpace=e.outputColorSpace,t.renderTarget=e.getRenderTarget(),t.activeCubeFace=e.getActiveCubeFace(),t.activeMipmapLevel=e.getActiveMipmapLevel(),t.renderObjectFunction=e.getRenderObjectFunction(),t.pixelRatio=e.getPixelRatio(),t.mrt=e.getMRT(),t.clearColor=e.getClearColor(t.clearColor||new Eh),t.clearAlpha=e.getClearAlpha(),t.autoClear=e.autoClear,t.scissorTest=e.getScissorTest(),t}(e,t),e.setMRT(null),e.setRenderObjectFunction(null),e.setClearColor(0,1),e.autoClear=!0,t}const XO=new WeakMap,$O=KM((({depthTexture:e,shadowCoord:t,depthLayer:n})=>{let i=AR(e,t.xy).label("t_basic");return e.isArrayTexture&&(i=i.depth(n)),i.compare(t.z)})),YO=KM((({depthTexture:e,shadowCoord:t,shadow:n,depthLayer:i})=>{const r=(t,n)=>{let r=AR(e,t);return e.isArrayTexture&&(r=r.depth(i)),r.compare(n)},s=PN("mapSize","vec2",n).setGroup(tA),o=PN("radius","float",n).setGroup(tA),a=oE(1).div(s),l=a.x.negate().mul(o),c=a.y.negate().mul(o),u=a.x.mul(o),h=a.y.mul(o),d=l.div(2),p=c.div(2),f=u.div(2),m=h.div(2);return uA(r(t.xy.add(oE(l,c)),t.z),r(t.xy.add(oE(0,c)),t.z),r(t.xy.add(oE(u,c)),t.z),r(t.xy.add(oE(d,p)),t.z),r(t.xy.add(oE(0,p)),t.z),r(t.xy.add(oE(f,p)),t.z),r(t.xy.add(oE(l,0)),t.z),r(t.xy.add(oE(d,0)),t.z),r(t.xy,t.z),r(t.xy.add(oE(f,0)),t.z),r(t.xy.add(oE(u,0)),t.z),r(t.xy.add(oE(d,m)),t.z),r(t.xy.add(oE(0,m)),t.z),r(t.xy.add(oE(f,m)),t.z),r(t.xy.add(oE(l,h)),t.z),r(t.xy.add(oE(0,h)),t.z),r(t.xy.add(oE(u,h)),t.z)).mul(1/17)})),KO=KM((({depthTexture:e,shadowCoord:t,shadow:n,depthLayer:i})=>{const r=(t,n)=>{let r=AR(e,t);return e.isArrayTexture&&(r=r.depth(i)),r.compare(n)},s=PN("mapSize","vec2",n).setGroup(tA),o=oE(1).div(s),a=o.x,l=o.y,c=t.xy,u=ZA(c.mul(s).add(.5));return c.subAssign(u.mul(o)),uA(r(c,t.z),r(c.add(oE(a,0)),t.z),r(c.add(oE(0,l)),t.z),r(c.add(o),t.z),NC(r(c.add(oE(a.negate(),0)),t.z),r(c.add(oE(a.mul(2),0)),t.z),u.x),NC(r(c.add(oE(a.negate(),l)),t.z),r(c.add(oE(a.mul(2),l)),t.z),u.x),NC(r(c.add(oE(0,l.negate())),t.z),r(c.add(oE(0,l.mul(2))),t.z),u.y),NC(r(c.add(oE(a,l.negate())),t.z),r(c.add(oE(a,l.mul(2))),t.z),u.y),NC(NC(r(c.add(oE(a.negate(),l.negate())),t.z),r(c.add(oE(a.mul(2),l.negate())),t.z),u.x),NC(r(c.add(oE(a.negate(),l.mul(2))),t.z),r(c.add(oE(a.mul(2),l.mul(2))),t.z),u.x),u.y)).mul(1/9)})),ZO=KM((({depthTexture:e,shadowCoord:t,depthLayer:n})=>{const i=nE(1).toVar();let r=AR(e).sample(t.xy);e.isArrayTexture&&(r=r.depth(n)),r=r.rg;const s=vC(t.z,r.x);return QM(s.notEqual(nE(1)),(()=>{const e=t.z.sub(r.x),n=yC(0,r.y.mul(r.y));let o=n.div(n.add(e.mul(e)));o=PC(hA(o,.3).div(.95-.3)),i.assign(PC(yC(s,o)))})),i})),JO=KM((([e,t,n])=>{let i=eN.sub(e).length();return i=i.sub(t).div(n.sub(t)),i=i.saturate(),i})),QO=e=>{let t=XO.get(e);if(void 0===t){const n=e.isPointLight?(e=>{const t=e.shadow.camera,n=PN("near","float",t).setGroup(tA),i=PN("far","float",t).setGroup(tA),r=jR(e);return JO(r,n,i)})(e):null;t=new CD,t.colorNode=fE(0,0,0,1),t.depthNode=n,t.isShadowPassMaterial=!0,t.name="ShadowMaterial",t.fog=!1,XO.set(e,t)}return t},eU=new hk,tU=[],nU=KM((({samples:e,radius:t,size:n,shadowPass:i,depthLayer:r})=>{const s=nE(0).toVar("meanVertical"),o=nE(0).toVar("squareMeanVertical"),a=e.lessThanEqual(nE(1)).select(nE(0),nE(2).div(e.sub(1))),l=e.lessThanEqual(nE(1)).select(nE(0),nE(-1));qP({start:iE(0),end:iE(e),type:"int",condition:"<"},(({i:e})=>{const c=l.add(nE(e).mul(a));let u=i.sample(uA(lD.xy,oE(0,c).mul(t)).div(n));i.value.isArrayTexture&&(u=u.depth(r)),u=u.x,s.addAssign(u),o.addAssign(u.mul(u))})),s.divAssign(e),o.divAssign(e);const c=qA(o.sub(s.mul(s)));return oE(s,c)})),iU=KM((({samples:e,radius:t,size:n,shadowPass:i,depthLayer:r})=>{const s=nE(0).toVar("meanHorizontal"),o=nE(0).toVar("squareMeanHorizontal"),a=e.lessThanEqual(nE(1)).select(nE(0),nE(2).div(e.sub(1))),l=e.lessThanEqual(nE(1)).select(nE(0),nE(-1));qP({start:iE(0),end:iE(e),type:"int",condition:"<"},(({i:e})=>{const c=l.add(nE(e).mul(a));let u=i.sample(uA(lD.xy,oE(c,0).mul(t)).div(n));i.value.isArrayTexture&&(u=u.depth(r)),s.addAssign(u.x),o.addAssign(uA(u.y.mul(u.y),u.x.mul(u.x)))})),s.divAssign(e),o.divAssign(e);const c=qA(o.sub(s.mul(s)));return oE(s,c)})),rU=[$O,YO,KO,ZO];let sU;const oU=new iO;class aU extends HO{static get type(){return"ShadowNode"}constructor(e,t=null){super(e),this.shadow=t||e.shadow,this.shadowMap=null,this.vsmShadowMapVertical=null,this.vsmShadowMapHorizontal=null,this.vsmMaterialVertical=null,this.vsmMaterialHorizontal=null,this._node=null,this._cameraFrameId=new WeakMap,this.isShadowNode=!0,this.depthLayer=0}setupShadowFilter(e,{filterFn:t,depthTexture:n,shadowCoord:i,shadow:r,depthLayer:s}){const o=i.x.greaterThanEqual(0).and(i.x.lessThanEqual(1)).and(i.y.greaterThanEqual(0)).and(i.y.lessThanEqual(1)).and(i.z.lessThanEqual(1)),a=t({depthTexture:n,shadowCoord:i,shadow:r,depthLayer:s});return o.select(a,nE(1))}setupShadowCoord(e,t){const{shadow:n}=this,{renderer:i}=e,r=PN("bias","float",n).setGroup(tA);let s,o=t;if(n.camera.isOrthographicCamera||!0!==i.logarithmicDepthBuffer)o=o.xyz.div(o.w),s=o.z,i.coordinateSystem===yc&&(s=s.mul(2).sub(1));else{const e=o.w;o=o.xy.div(e);const t=PN("near","float",n.camera).setGroup(tA),i=PN("far","float",n.camera).setGroup(tA);s=xD(e.negate(),t,i)}return o=uE(o.x,o.y.oneMinus(),s.add(r)),o}getShadowFilterFn(e){return rU[e]}setupRenderTarget(e,t){const n=new ip(e.mapSize.width,e.mapSize.height);n.name="ShadowDepthTexture",n.compareFunction=oc;const i=t.createRenderTarget(e.mapSize.width,e.mapSize.height);return i.texture.name="ShadowMap",i.texture.type=e.mapType,i.depthTexture=n,{shadowMap:i,depthTexture:n}}setupShadow(e){const{renderer:t}=e,{light:n,shadow:i}=this,r=t.shadowMap.type,{depthTexture:s,shadowMap:o}=this.setupRenderTarget(i,e);if(i.camera.updateProjectionMatrix(),3===r&&!0!==i.isPointLightShadow){s.compareFunction=null,o.depth>1?(o._vsmShadowMapVertical||(o._vsmShadowMapVertical=e.createRenderTarget(i.mapSize.width,i.mapSize.height,{format:vl,type:ol,depth:o.depth,depthBuffer:!1}),o._vsmShadowMapVertical.texture.name="VSMVertical"),this.vsmShadowMapVertical=o._vsmShadowMapVertical,o._vsmShadowMapHorizontal||(o._vsmShadowMapHorizontal=e.createRenderTarget(i.mapSize.width,i.mapSize.height,{format:vl,type:ol,depth:o.depth,depthBuffer:!1}),o._vsmShadowMapHorizontal.texture.name="VSMHorizontal"),this.vsmShadowMapHorizontal=o._vsmShadowMapHorizontal):(this.vsmShadowMapVertical=e.createRenderTarget(i.mapSize.width,i.mapSize.height,{format:vl,type:ol,depthBuffer:!1}),this.vsmShadowMapHorizontal=e.createRenderTarget(i.mapSize.width,i.mapSize.height,{format:vl,type:ol,depthBuffer:!1}));let t=AR(s);s.isArrayTexture&&(t=t.depth(this.depthLayer));let n=AR(this.vsmShadowMapVertical.texture);s.isArrayTexture&&(n=n.depth(this.depthLayer));const r=PN("blurSamples","float",i).setGroup(tA),a=PN("radius","float",i).setGroup(tA),l=PN("mapSize","vec2",i).setGroup(tA);let c=this.vsmMaterialVertical||(this.vsmMaterialVertical=new CD);c.fragmentNode=nU({samples:r,radius:a,size:l,shadowPass:t,depthLayer:this.depthLayer}).context(e.getSharedContext()),c.name="VSMVertical",c=this.vsmMaterialHorizontal||(this.vsmMaterialHorizontal=new CD),c.fragmentNode=iU({samples:r,radius:a,size:l,shadowPass:n,depthLayer:this.depthLayer}).context(e.getSharedContext()),c.name="VSMHorizontal"}const a=PN("intensity","float",i).setGroup(tA),l=PN("normalBias","float",i).setGroup(tA),c=OO(n).mul(WO.add(dN.mul(l))),u=this.setupShadowCoord(e,c),h=i.filterNode||this.getShadowFilterFn(t.shadowMap.type)||null;if(null===h)throw new Error("THREE.WebGPURenderer: Shadow map type not supported yet.");const d=3===r&&!0!==i.isPointLightShadow?this.vsmShadowMapHorizontal.texture:s,p=this.setupShadowFilter(e,{filterFn:h,shadowTexture:o.texture,depthTexture:d,shadowCoord:u,shadow:i,depthLayer:this.depthLayer});let f=AR(o.texture,u);s.isArrayTexture&&(f=f.depth(this.depthLayer));const m=NC(1,p.rgb.mix(f,1),a.mul(f.a)).toVar();return this.shadowMap=o,this.shadow.map=o,m}setup(e){if(!1!==e.renderer.shadowMap.enabled)return KM((()=>{let t=this._node;return this.setupShadowPosition(e),null===t&&(this._node=t=this.setupShadow(e)),e.material.shadowNode&&console.warn('THREE.NodeMaterial: ".shadowNode" is deprecated. Use ".castShadowNode" instead.'),e.material.receivedShadowNode&&(t=e.material.receivedShadowNode(t)),t}))()}renderShadow(e){const{shadow:t,shadowMap:n,light:i}=this,{renderer:r,scene:s}=e;t.updateMatrices(i),n.setSize(t.mapSize.width,t.mapSize.height,n.depth),r.render(s,t.camera)}updateShadow(e){const{shadowMap:t,light:n,shadow:i}=this,{renderer:r,scene:s,camera:o}=e,a=r.shadowMap.type,l=t.depthTexture.version;this._depthVersionCached=l;const c=i.camera.layers.mask;4294967294&i.camera.layers.mask||(i.camera.layers.mask=o.layers.mask);const u=r.getRenderObjectFunction(),h=r.getMRT(),d=!!h&&h.has("velocity");sU=function(e,t,n){return n=function(e,t){return t=function(e,t={}){return t.background=e.background,t.backgroundNode=e.backgroundNode,t.overrideMaterial=e.overrideMaterial,t}(e,t),e.background=null,e.backgroundNode=null,e.overrideMaterial=null,t}(t,n=qO(e,n)),n}(r,s,sU),s.overrideMaterial=QO(n),r.setRenderObjectFunction(((e,t,n,i)=>{tU[0]=e,tU[1]=t;let r=eU.get(tU);return void 0!==r&&r.shadowType===n&&r.useVelocity===i||(r=(r,s,o,a,l,c,...u)=>{(!0===r.castShadow||r.receiveShadow&&3===n)&&(i&&(jS(r).useVelocity=!0),r.onBeforeShadow(e,r,o,t.camera,a,s.overrideMaterial,c),e.renderObject(r,s,o,a,l,c,...u),r.onAfterShadow(e,r,o,t.camera,a,s.overrideMaterial,c))},r.shadowType=n,r.useVelocity=i,eU.set(tU,r)),tU[0]=null,tU[1]=null,r})(r,i,a,d)),r.setClearColor(0,0),r.setRenderTarget(t),this.renderShadow(e),r.setRenderObjectFunction(u),3===a&&!0!==i.isPointLightShadow&&this.vsmPass(r),i.camera.layers.mask=c,function(e,t,n){!function(e,t){e.toneMapping=t.toneMapping,e.toneMappingExposure=t.toneMappingExposure,e.outputColorSpace=t.outputColorSpace,e.setRenderTarget(t.renderTarget,t.activeCubeFace,t.activeMipmapLevel),e.setRenderObjectFunction(t.renderObjectFunction),e.setPixelRatio(t.pixelRatio),e.setMRT(t.mrt),e.setClearColor(t.clearColor,t.clearAlpha),e.autoClear=t.autoClear,e.setScissorTest(t.scissorTest)}(e,n),function(e,t){e.background=t.background,e.backgroundNode=t.backgroundNode,e.overrideMaterial=t.overrideMaterial}(t,n)}(r,s,sU)}vsmPass(e){const{shadow:t}=this,n=this.shadowMap.depth;this.vsmShadowMapVertical.setSize(t.mapSize.width,t.mapSize.height,n),this.vsmShadowMapHorizontal.setSize(t.mapSize.width,t.mapSize.height,n),e.setRenderTarget(this.vsmShadowMapVertical),oU.material=this.vsmMaterialVertical,oU.render(e),e.setRenderTarget(this.vsmShadowMapHorizontal),oU.material=this.vsmMaterialHorizontal,oU.render(e)}dispose(){this.shadowMap.dispose(),this.shadowMap=null,null!==this.vsmShadowMapVertical&&(this.vsmShadowMapVertical.dispose(),this.vsmShadowMapVertical=null,this.vsmMaterialVertical.dispose(),this.vsmMaterialVertical=null),null!==this.vsmShadowMapHorizontal&&(this.vsmShadowMapHorizontal.dispose(),this.vsmShadowMapHorizontal=null,this.vsmMaterialHorizontal.dispose(),this.vsmMaterialHorizontal=null),super.dispose()}updateBefore(e){const{shadow:t}=this;let n=t.needsUpdate||t.autoUpdate;n&&(this._cameraFrameId[e.camera]===e.frameId&&(n=!1),this._cameraFrameId[e.camera]=e.frameId),n&&(this.updateShadow(e),this.shadowMap.depthTexture.version===this._depthVersionCached&&(t.needsUpdate=!1))}}const lU=new Eh,cU=KM((([e,t])=>{const n=e.toVar(),i=rC(n),r=pA(1,yC(i.x,yC(i.y,i.z)));i.mulAssign(r),n.mulAssign(r.mul(t.mul(2).oneMinus()));const s=oE(n.xy).toVar(),o=t.mul(1.5).oneMinus();return QM(i.z.greaterThanEqual(o),(()=>{QM(n.z.greaterThan(0),(()=>{s.x.assign(hA(4,n.x))}))})).ElseIf(i.x.greaterThanEqual(o),(()=>{const e=sC(n.x);s.x.assign(n.z.mul(e).add(e.mul(2)))})).ElseIf(i.y.greaterThanEqual(o),(()=>{const e=sC(n.y);s.x.assign(n.x.add(e.mul(2)).add(2)),s.y.assign(n.z.mul(e).sub(2))})),oE(.125,.25).mul(s).add(oE(.375,.75)).flipY()})).setLayout({name:"cubeToUV",type:"vec2",inputs:[{name:"pos",type:"vec3"},{name:"texelSizeY",type:"float"}]}),uU=KM((({depthTexture:e,bd3D:t,dp:n,texelSize:i})=>AR(e,cU(t,i.y)).compare(n))),hU=KM((({depthTexture:e,bd3D:t,dp:n,texelSize:i,shadow:r})=>{const s=PN("radius","float",r).setGroup(tA),o=oE(-1,1).mul(s).mul(i.y);return AR(e,cU(t.add(o.xyy),i.y)).compare(n).add(AR(e,cU(t.add(o.yyy),i.y)).compare(n)).add(AR(e,cU(t.add(o.xyx),i.y)).compare(n)).add(AR(e,cU(t.add(o.yyx),i.y)).compare(n)).add(AR(e,cU(t,i.y)).compare(n)).add(AR(e,cU(t.add(o.xxy),i.y)).compare(n)).add(AR(e,cU(t.add(o.yxy),i.y)).compare(n)).add(AR(e,cU(t.add(o.xxx),i.y)).compare(n)).add(AR(e,cU(t.add(o.yxx),i.y)).compare(n)).mul(1/9)})),dU=KM((({filterFn:e,depthTexture:t,shadowCoord:n,shadow:i})=>{const r=n.xyz.toVar(),s=r.length(),o=rA("float").setGroup(tA).onRenderUpdate((()=>i.camera.near)),a=rA("float").setGroup(tA).onRenderUpdate((()=>i.camera.far)),l=PN("bias","float",i).setGroup(tA),c=rA(i.mapSize).setGroup(tA),u=nE(1).toVar();return QM(s.sub(a).lessThanEqual(0).and(s.sub(o).greaterThanEqual(0)),(()=>{const n=s.sub(o).div(a.sub(o)).toVar();n.addAssign(l);const h=r.normalize(),d=oE(1).div(c.mul(oE(4,2)));u.assign(e({depthTexture:t,bd3D:h,dp:n,texelSize:d,shadow:i}))})),u})),pU=new nu,fU=new Nc,mU=new Nc;class gU extends aU{static get type(){return"PointShadowNode"}constructor(e,t=null){super(e,t)}getShadowFilterFn(e){return 0===e?uU:hU}setupShadowCoord(e,t){return t}setupShadowFilter(e,{filterFn:t,shadowTexture:n,depthTexture:i,shadowCoord:r,shadow:s}){return dU({filterFn:t,shadowTexture:n,depthTexture:i,shadowCoord:r,shadow:s})}renderShadow(e){const{shadow:t,shadowMap:n,light:i}=this,{renderer:r,scene:s}=e,o=t.getFrameExtents();mU.copy(t.mapSize),mU.multiply(o),n.setSize(mU.width,mU.height),fU.copy(t.mapSize);const a=r.autoClear,l=r.getClearColor(lU),c=r.getClearAlpha();r.autoClear=!1,r.setClearColor(t.clearColor,t.clearAlpha),r.clear();const u=t.getViewportCount();for(let e=0;e<u;e++){const o=t.getViewport(e),a=fU.x*o.x,l=mU.y-fU.y-fU.y*o.y;pU.set(a,l,fU.x*o.z,fU.y*o.w),n.viewport.copy(pU),t.updateMatrices(i,e),r.render(s,t.camera)}r.autoClear=a,r.setClearColor(l,c)}}class yU extends JP{static get type(){return"AnalyticLightNode"}constructor(e=null){super(),this.light=e,this.color=new Eh,this.colorNode=e&&e.colorNode||rA(this.color).setGroup(tA),this.baseColorNode=null,this.shadowNode=null,this.shadowColorNode=null,this.isAnalyticLightNode=!0,this.updateType=qS}getHash(){return this.light.uuid}getLightVector(e){return FO(this.light).sub(e.context.positionView||nN)}setupDirect(){}setupDirectRectArea(){}setupShadowNode(){return((e,t)=>HM(new aU(e,t)))(this.light)}setupShadow(e){const{renderer:t}=e;if(!1===t.shadowMap.enabled)return;let n=this.shadowColorNode;if(null===n){const e=this.light.shadow.shadowNode;let t;t=void 0!==e?HM(e):this.setupShadowNode(),this.shadowNode=t,this.shadowColorNode=n=this.colorNode.mul(t),this.baseColorNode=this.colorNode}this.colorNode=n}setup(e){this.colorNode=this.baseColorNode||this.colorNode,this.light.castShadow?e.object.receiveShadow&&this.setupShadow(e):null!==this.shadowNode&&(this.shadowNode.dispose(),this.shadowNode=null,this.shadowColorNode=null);const t=this.setupDirect(e),n=this.setupDirectRectArea(e);t&&e.lightsNode.setupDirectLight(e,this,t),n&&e.lightsNode.setupDirectRectAreaLight(e,this,n)}update(){const{light:e}=this;this.color.copy(e.color).multiplyScalar(e.intensity)}}const vU=KM((({lightDistance:e,cutoffDistance:t,decayExponent:n})=>{const i=e.pow(n).max(.01).reciprocal();return t.greaterThan(0).select(i.mul(e.div(t).pow4().oneMinus().clamp().pow2()),i)}));class _U extends yU{static get type(){return"PointLightNode"}constructor(e=null){super(e),this.cutoffDistanceNode=rA(0).setGroup(tA),this.decayExponentNode=rA(2).setGroup(tA)}update(e){const{light:t}=this;super.update(e),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}setupShadowNode(){return((e,t)=>HM(new gU(e,t)))(this.light)}setupDirect(e){return(({color:e,lightVector:t,cutoffDistance:n,decayExponent:i})=>{const r=t.normalize(),s=t.length(),o=vU({lightDistance:s,cutoffDistance:n,decayExponent:i});return{lightDirection:r,lightColor:e.mul(o)}})({color:this.colorNode,lightVector:this.getLightVector(e),cutoffDistance:this.cutoffDistanceNode,decayExponent:this.decayExponentNode})}}KM((([e=_R()],{renderer:t,material:n})=>{const i=RC(e.mul(2).sub(1));let r;if(n.alphaToCoverage&&t.samples>1){const e=nE(i.fwidth()).toVar();r=IC(e.oneMinus(),e.add(1),i).oneMinus()}else r=FC(i.greaterThan(1),0,1);return r}));const xU=KM((([e,t])=>{const n=e.x,i=e.y,r=e.z;let s=t.element(0).mul(.886227);return s=s.add(t.element(1).mul(1.023328).mul(i)),s=s.add(t.element(2).mul(1.023328).mul(r)),s=s.add(t.element(3).mul(1.023328).mul(n)),s=s.add(t.element(4).mul(.858086).mul(n).mul(i)),s=s.add(t.element(5).mul(.858086).mul(i).mul(r)),s=s.add(t.element(6).mul(r.mul(r).mul(.743125).sub(.247708))),s=s.add(t.element(7).mul(.858086).mul(n).mul(r)),s=s.add(t.element(8).mul(.429043).mul(dA(n,n).sub(dA(i,i)))),s})),bU=new Yk;class wU extends gk{constructor(e,t){super(),this.renderer=e,this.nodes=t}update(e,t,n){const i=this.renderer,r=this.nodes.getBackgroundNode(e)||e.background;let s=!1;if(null===r)i._clearColor.getRGB(bU),bU.a=i._clearColor.a;else if(!0===r.isColor)r.getRGB(bU),bU.a=1,s=!0;else if(!0===r.isNode){const a=this.get(e),l=r;bU.copy(i._clearColor);let c=a.backgroundMesh;if(void 0===c){const h=zC(fE(l).mul(lO),{getUV:()=>cO.mul(uN),getTextureLevel:()=>aO});let d=LP;d=d.setZ(d.w);const p=new CD;function f(){r.removeEventListener("dispose",f),c.material.dispose(),c.geometry.dispose()}p.name="Background.material",p.side=1,p.depthTest=!1,p.depthWrite=!1,p.allowOverride=!1,p.fog=!1,p.lights=!1,p.vertexNode=d,p.colorNode=h,a.backgroundMeshNode=h,a.backgroundMesh=c=new ld(new xp(1,32,32),p),c.frustumCulled=!1,c.name="Background.mesh",c.onBeforeRender=function(e,t,n){this.matrixWorld.copyPosition(n.matrixWorld)},r.addEventListener("dispose",f)}const u=l.getCacheKey();a.backgroundCacheKey!==u&&(a.backgroundMeshNode.node=fE(l).mul(lO),a.backgroundMeshNode.needsUpdate=!0,c.material.needsUpdate=!0,a.backgroundCacheKey=u),t.unshift(c,c.geometry,c.material,0,0,null,null)}else console.error("THREE.Renderer: Unsupported background configuration.",r);const o=i.xr.getEnvironmentBlendMode();if("additive"===o?bU.set(0,0,0,1):"alpha-blend"===o&&bU.set(0,0,0,0),!0===i.autoClear||!0===s){const m=n.clearColorValue;m.r=bU.r,m.g=bU.g,m.b=bU.b,m.a=bU.a,!0!==i.backend.isWebGLBackend&&!0!==i.alpha||(m.r*=m.a,m.g*=m.a,m.b*=m.a),n.depthClearValue=i._clearDepth,n.stencilClearValue=i._clearStencil,n.clearColor=!0===i.autoClearColor,n.clearDepth=!0===i.autoClearDepth,n.clearStencil=!0===i.autoClearStencil}else n.clearColor=!1,n.clearDepth=!1,n.clearStencil=!1}}let TU=0;class SU{constructor(e="",t=[],n=0,i=[]){this.name=e,this.bindings=t,this.index=n,this.bindingsReference=i,this.id=TU++}}class MU{constructor(e,t,n,i,r,s,o,a,l,c=[]){this.vertexShader=e,this.fragmentShader=t,this.computeShader=n,this.transforms=c,this.nodeAttributes=i,this.bindings=r,this.updateNodes=s,this.updateBeforeNodes=o,this.updateAfterNodes=a,this.observer=l,this.usedTimes=0}createBindings(){const e=[];for(const t of this.bindings){if(!0!==t.bindings[0].groupNode.shared){const n=new SU(t.name,[],t.index,t);e.push(n);for(const e of t.bindings)n.bindings.push(e.clone())}else e.push(t)}return e}}class EU{constructor(e,t,n=null){this.isNodeAttribute=!0,this.name=e,this.type=t,this.node=n}}class AU{constructor(e,t,n){this.isNodeUniform=!0,this.name=e,this.type=t,this.node=n.getSelf()}get value(){return this.node.value}set value(e){this.node.value=e}get id(){return this.node.id}get groupNode(){return this.node.groupNode}}class CU{constructor(e,t,n=!1,i=null){this.isNodeVar=!0,this.name=e,this.type=t,this.readOnly=n,this.count=i}}class RU extends CU{constructor(e,t,n=null,i=null){super(e,t),this.needsInterpolation=!1,this.isNodeVarying=!0,this.interpolationType=n,this.interpolationSampling=i}}class NU{constructor(e,t,n=""){this.name=e,this.type=t,this.code=n,Object.defineProperty(this,"isNodeCode",{value:!0})}}let PU=0;class DU{constructor(e=null){this.id=PU++,this.nodesData=new WeakMap,this.parent=e}getData(e){let t=this.nodesData.get(e);return void 0===t&&null!==this.parent&&(t=this.parent.getData(e)),t}setData(e,t){this.nodesData.set(e,t)}}class LU{constructor(e,t){this.name=e,this.members=t,this.output=!1}}class IU{constructor(e,t){this.name=e,this.value=t,this.boundary=0,this.itemSize=0,this.offset=0}setValue(e){this.value=e}getValue(){return this.value}}class kU extends IU{constructor(e,t=0){super(e,t),this.isNumberUniform=!0,this.boundary=4,this.itemSize=1}}class OU extends IU{constructor(e,t=new Nc){super(e,t),this.isVector2Uniform=!0,this.boundary=8,this.itemSize=2}}class UU extends IU{constructor(e,t=new Dc){super(e,t),this.isVector3Uniform=!0,this.boundary=16,this.itemSize=3}}class FU extends IU{constructor(e,t=new nu){super(e,t),this.isVector4Uniform=!0,this.boundary=16,this.itemSize=4}}class BU extends IU{constructor(e,t=new Eh){super(e,t),this.isColorUniform=!0,this.boundary=16,this.itemSize=3}}class zU extends IU{constructor(e,t=new ff){super(e,t),this.isMatrix2Uniform=!0,this.boundary=8,this.itemSize=4}}class VU extends IU{constructor(e,t=new kc){super(e,t),this.isMatrix3Uniform=!0,this.boundary=48,this.itemSize=12}}class GU extends IU{constructor(e,t=new Iu){super(e,t),this.isMatrix4Uniform=!0,this.boundary=64,this.itemSize=16}}class jU extends kU{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class HU extends OU{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class WU extends UU{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class qU extends FU{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class XU extends BU{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class $U extends zU{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class YU extends VU{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class KU extends GU{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}const ZU=new WeakMap,JU=new Map([[Int8Array,"int"],[Int16Array,"int"],[Int32Array,"int"],[Uint8Array,"uint"],[Uint16Array,"uint"],[Uint32Array,"uint"],[Float32Array,"float"]]),QU=e=>/e/g.test(e)?String(e).replace(/\+/g,""):(e=Number(e))+(e%1?"":".0");class eF{constructor(e,t,n){this.object=e,this.material=e&&e.material||null,this.geometry=e&&e.geometry||null,this.renderer=t,this.parser=n,this.scene=null,this.camera=null,this.nodes=[],this.sequentialNodes=[],this.updateNodes=[],this.updateBeforeNodes=[],this.updateAfterNodes=[],this.hashNodes={},this.observer=null,this.lightsNode=null,this.environmentNode=null,this.fogNode=null,this.clippingContext=null,this.vertexShader=null,this.fragmentShader=null,this.computeShader=null,this.flowNodes={vertex:[],fragment:[],compute:[]},this.flowCode={vertex:"",fragment:"",compute:""},this.uniforms={vertex:[],fragment:[],compute:[],index:0},this.structs={vertex:[],fragment:[],compute:[],index:0},this.bindings={vertex:{},fragment:{},compute:{}},this.bindingsIndexes={},this.bindGroups=null,this.attributes=[],this.bufferAttributes=[],this.varyings=[],this.codes={},this.vars={},this.declarations={},this.flow={code:""},this.chaining=[],this.stack=Jk(),this.stacks=[],this.tab="\t",this.currentFunctionNode=null,this.context={material:this.material},this.cache=new DU,this.globalCache=this.cache,this.flowsData=new WeakMap,this.shaderStage=null,this.buildStage=null}getBindGroupsCache(){let e=ZU.get(this.renderer);return void 0===e&&(e=new hk,ZU.set(this.renderer,e)),e}createRenderTarget(e,t,n){return new iu(e,t,n)}createCubeRenderTarget(e,t){return new UD(e,t)}includes(e){return this.nodes.includes(e)}getOutputStructName(){}_getBindGroup(e,t){const n=this.getBindGroupsCache(),i=[];let r,s=!0;for(const e of t)i.push(e),s=s&&!0!==e.groupNode.shared;return s?(r=n.get(i),void 0===r&&(r=new SU(e,i,this.bindingsIndexes[e].group,i),n.set(i,r))):r=new SU(e,i,this.bindingsIndexes[e].group,i),r}getBindGroupArray(e,t){const n=this.bindings[t];let i=n[e];return void 0===i&&(void 0===this.bindingsIndexes[e]&&(this.bindingsIndexes[e]={binding:0,group:Object.keys(this.bindingsIndexes).length}),n[e]=i=[]),i}getBindings(){let e=this.bindGroups;if(null===e){const t={},n=this.bindings;for(const e of QS)for(const i in n[e]){const r=n[e][i];(t[i]||(t[i]=[])).push(...r)}e=[];for(const n in t){const i=t[n],r=this._getBindGroup(n,i);e.push(r)}this.bindGroups=e}return e}sortBindingGroups(){const e=this.getBindings();e.sort(((e,t)=>e.bindings[0].groupNode.order-t.bindings[0].groupNode.order));for(let t=0;t<e.length;t++){const n=e[t];this.bindingsIndexes[n.name].group=t,n.index=t}}setHashNode(e,t){this.hashNodes[t]=e}addNode(e){!1===this.nodes.includes(e)&&(this.nodes.push(e),this.setHashNode(e,e.getHash(this)))}addSequentialNode(e){!1===this.sequentialNodes.includes(e)&&this.sequentialNodes.push(e)}buildUpdateNodes(){for(const e of this.nodes){e.getUpdateType()!==WS&&this.updateNodes.push(e.getSelf())}for(const e of this.sequentialNodes){const t=e.getUpdateBeforeType(),n=e.getUpdateAfterType();t!==WS&&this.updateBeforeNodes.push(e.getSelf()),n!==WS&&this.updateAfterNodes.push(e.getSelf())}}get currentNode(){return this.chaining[this.chaining.length-1]}isFilteredTexture(e){return e.magFilter===Ka||e.magFilter===Za||e.magFilter===Ya||e.magFilter===Ja||e.minFilter===Ka||e.minFilter===Za||e.minFilter===Ya||e.minFilter===Ja}addChain(e){this.chaining.push(e)}removeChain(e){if(this.chaining.pop()!==e)throw new Error("NodeBuilder: Invalid node chaining!")}getMethod(e){return e}getNodeFromHash(e){return this.hashNodes[e]}addFlow(e,t){return this.flowNodes[e].push(t),t}setContext(e){this.context=e}getContext(){return this.context}getSharedContext(){return this.context,this.context}setCache(e){this.cache=e}getCache(){return this.cache}getCacheFromNode(e,t=!0){const n=this.getDataFromNode(e);return void 0===n.cache&&(n.cache=new DU(t?this.getCache():null)),n.cache}isAvailable(){return!1}getVertexIndex(){console.warn("Abstract function.")}getInstanceIndex(){console.warn("Abstract function.")}getDrawIndex(){console.warn("Abstract function.")}getFrontFacing(){console.warn("Abstract function.")}getFragCoord(){console.warn("Abstract function.")}isFlipY(){return!1}increaseUsage(e){const t=this.getDataFromNode(e);return t.usageCount=void 0===t.usageCount?1:t.usageCount+1,t.usageCount}generateTexture(){console.warn("Abstract function.")}generateTextureLod(){console.warn("Abstract function.")}generateArrayDeclaration(e,t){return this.getType(e)+"[ "+t+" ]"}generateArray(e,t,n=null){let i=this.generateArrayDeclaration(e,t)+"( ";for(let r=0;r<t;r++){const s=n?n[r]:null;i+=null!==s?s.build(this,e):this.generateConst(e),r<t-1&&(i+=", ")}return i+=" )",i}generateStruct(e,t,n=null){const i=[];for(const e of t){const{name:t,type:r}=e;n&&n[t]&&n[t].isNode?i.push(n[t].build(this,r)):i.push(this.generateConst(r))}return e+"( "+i.join(", ")+" )"}generateConst(e,t=null){if(null===t&&("float"===e||"int"===e||"uint"===e?t=0:"bool"===e?t=!1:"color"===e?t=new Eh:"vec2"===e?t=new Nc:"vec3"===e?t=new Dc:"vec4"===e&&(t=new nu)),"float"===e)return QU(t);if("int"===e)return`${Math.round(t)}`;if("uint"===e)return t>=0?`${Math.round(t)}u`:"0u";if("bool"===e)return t?"true":"false";if("color"===e)return`${this.getType("vec3")}( ${QU(t.r)}, ${QU(t.g)}, ${QU(t.b)} )`;const n=this.getTypeLength(e),i=this.getComponentType(e),r=e=>this.generateConst(i,e);if(2===n)return`${this.getType(e)}( ${r(t.x)}, ${r(t.y)} )`;if(3===n)return`${this.getType(e)}( ${r(t.x)}, ${r(t.y)}, ${r(t.z)} )`;if(4===n&&"mat2"!==e)return`${this.getType(e)}( ${r(t.x)}, ${r(t.y)}, ${r(t.z)}, ${r(t.w)} )`;if(n>=4&&t&&(t.isMatrix2||t.isMatrix3||t.isMatrix4))return`${this.getType(e)}( ${t.elements.map(r).join(", ")} )`;if(n>4)return`${this.getType(e)}()`;throw new Error(`NodeBuilder: Type '${e}' not found in generate constant attempt.`)}getType(e){return"color"===e?"vec3":e}hasGeometryAttribute(e){return this.geometry&&void 0!==this.geometry.getAttribute(e)}getAttribute(e,t){const n=this.attributes;for(const t of n)if(t.name===e)return t;const i=new EU(e,t);return this.registerDeclaration(i),n.push(i),i}getPropertyName(e){return e.name}isVector(e){return/vec\d/.test(e)}isMatrix(e){return/mat\d/.test(e)}isReference(e){return"void"===e||"property"===e||"sampler"===e||"samplerComparison"===e||"texture"===e||"cubeTexture"===e||"storageTexture"===e||"depthTexture"===e||"texture3D"===e}needsToWorkingColorSpace(){return!1}getComponentTypeFromTexture(e){const t=e.type;if(e.isDataTexture){if(t===il)return"int";if(t===rl)return"uint"}return"float"}getElementType(e){return"mat2"===e?"vec2":"mat3"===e?"vec3":"mat4"===e?"vec4":this.getComponentType(e)}getComponentType(e){if("float"===(e=this.getVectorType(e))||"bool"===e||"int"===e||"uint"===e)return e;const t=/(b|i|u|)(vec|mat)([2-4])/.exec(e);return null===t?null:"b"===t[1]?"bool":"i"===t[1]?"int":"u"===t[1]?"uint":"float"}getVectorType(e){return"color"===e?"vec3":"texture"===e||"cubeTexture"===e||"storageTexture"===e||"texture3D"===e?"vec4":e}getTypeFromLength(e,t="float"){if(1===e)return t;let n=function(e){return BS.get(e)}(e);const i="float"===t?"":t[0];return!0===/mat2/.test(t)&&(n=n.replace("vec","mat")),i+n}getTypeFromArray(e){return JU.get(e.constructor)}isInteger(e){return/int|uint|(i|u)vec/.test(e)}getTypeFromAttribute(e){let t=e;e.isInterleavedBufferAttribute&&(t=e.data);const n=t.array,i=e.itemSize,r=e.normalized;let s;return e instanceof Vh||!0===r||(s=this.getTypeFromArray(n)),this.getTypeFromLength(i,s)}getTypeLength(e){const t=this.getVectorType(e),n=/vec([2-4])/.exec(t);return null!==n?Number(n[1]):"float"===t||"bool"===t||"int"===t||"uint"===t?1:!0===/mat2/.test(e)?4:!0===/mat3/.test(e)?9:!0===/mat4/.test(e)?16:0}getVectorFromMatrix(e){return e.replace("mat","vec")}changeComponentType(e,t){return this.getTypeFromLength(this.getTypeLength(e),t)}getIntegerType(e){const t=this.getComponentType(e);return"int"===t||"uint"===t?e:this.changeComponentType(e,"int")}addStack(){return this.stack=Jk(this.stack),this.stacks.push(JM()||this.stack),ZM(this.stack),this.stack}removeStack(){const e=this.stack;return this.stack=e.parent,ZM(this.stacks.pop()),e}getDataFromNode(e,t=this.shaderStage,n=null){let i=(n=null===n?e.isGlobal(this)?this.globalCache:this.cache:n).getData(e);return void 0===i&&(i={},n.setData(e,i)),void 0===i[t]&&(i[t]={}),i[t]}getNodeProperties(e,t="any"){const n=this.getDataFromNode(e,t);return n.properties||(n.properties={outputNode:null})}getBufferAttributeFromNode(e,t){const n=this.getDataFromNode(e);let i=n.bufferAttribute;if(void 0===i){const r=this.uniforms.index++;i=new EU("nodeAttribute"+r,t,e),this.bufferAttributes.push(i),n.bufferAttribute=i}return i}getStructTypeFromNode(e,t,n=null,i=this.shaderStage){const r=this.getDataFromNode(e,i,this.globalCache);let s=r.structType;if(void 0===s){const e=this.structs.index++;null===n&&(n="StructType"+e),s=new LU(n,t),this.structs[i].push(s),r.structType=s}return s}getOutputStructTypeFromNode(e,t){const n=this.getStructTypeFromNode(e,t,"OutputType","fragment");return n.output=!0,n}getUniformFromNode(e,t,n=this.shaderStage,i=null){const r=this.getDataFromNode(e,n,this.globalCache);let s=r.uniform;if(void 0===s){const o=this.uniforms.index++;s=new AU(i||"nodeUniform"+o,t,e),this.uniforms[n].push(s),this.registerDeclaration(s),r.uniform=s}return s}getArrayCount(e){let t=null;return e.isArrayNode?t=e.count:e.isVarNode&&e.node.isArrayNode&&(t=e.node.count),t}getVarFromNode(e,t=null,n=e.getNodeType(this),i=this.shaderStage,r=!1){const s=this.getDataFromNode(e,i);let o=s.variable;if(void 0===o){const a=r?"_const":"_var",l=this.vars[i]||(this.vars[i]=[]),c=this.vars[a]||(this.vars[a]=0);null===t&&(t=(r?"nodeConst":"nodeVar")+c,this.vars[a]++);const u=this.getArrayCount(e);o=new CU(t,n,r,u),r||l.push(o),this.registerDeclaration(o),s.variable=o}return o}isDeterministic(e){if(e.isMathNode)return this.isDeterministic(e.aNode)&&(!e.bNode||this.isDeterministic(e.bNode))&&(!e.cNode||this.isDeterministic(e.cNode));if(e.isOperatorNode)return this.isDeterministic(e.aNode)&&(!e.bNode||this.isDeterministic(e.bNode));if(e.isArrayNode){if(null!==e.values)for(const t of e.values)if(!this.isDeterministic(t))return!1;return!0}return!!e.isConstNode}getVaryingFromNode(e,t=null,n=e.getNodeType(this),i=null,r=null){const s=this.getDataFromNode(e,"any");let o=s.varying;if(void 0===o){const e=this.varyings,a=e.length;null===t&&(t="nodeVarying"+a),o=new RU(t,n,i,r),e.push(o),this.registerDeclaration(o),s.varying=o}return o}get namespace(){return this.context.namespace}getOutputNamespace(){return this.getNamespace("outputNode")}getNamespace(e=""){const t=this.namespace;let n;return n=t?e?t+"_"+e:t:e,n}registerDeclaration(e){const t=this.shaderStage,n=this.declarations[t]||(this.declarations[t]={}),i=this.getPropertyName(e);let r=1,s=i;for(;void 0!==n[s];)s=i+"_"+r++;r>1&&(e.name=s,console.warn(`THREE.TSL: Declaration name '${i}' of '${e.type}' already in use. Renamed to '${s}'.`)),n[s]=e}getCodeFromNode(e,t,n=this.shaderStage){const i=this.getDataFromNode(e);let r=i.code;if(void 0===r){const e=this.codes[n]||(this.codes[n]=[]),s=e.length;r=new NU("nodeCode"+s,t),e.push(r),i.code=r}return r}addFlowCodeHierarchy(e,t){const{flowCodes:n,flowCodeBlock:i}=this.getDataFromNode(e);let r=!0,s=t;for(;s;){if(!0===i.get(s)){r=!1;break}s=this.getDataFromNode(s).parentNodeBlock}if(r)for(const e of n)this.addLineFlowCode(e)}addLineFlowCodeBlock(e,t,n){const i=this.getDataFromNode(e),r=i.flowCodes||(i.flowCodes=[]),s=i.flowCodeBlock||(i.flowCodeBlock=new WeakMap);r.push(t),s.set(n,!0)}addLineFlowCode(e,t=null){return""===e||(null!==t&&this.context.nodeBlock&&this.addLineFlowCodeBlock(t,e,this.context.nodeBlock),e=this.tab+e,/;\s*$/.test(e)||(e+=";\n"),this.flow.code+=e),this}addFlowCode(e){return this.flow.code+=e,this}addFlowTab(){return this.tab+="\t",this}removeFlowTab(){return this.tab=this.tab.slice(0,-1),this}getFlowData(e){return this.flowsData.get(e)}flowNode(e){const t=e.getNodeType(this),n=this.flowChildNode(e,t);return this.flowsData.set(e,n),n}addInclude(e){null!==this.currentFunctionNode&&this.currentFunctionNode.includes.push(e)}buildFunctionNode(e){const t=new CO,n=this.currentFunctionNode;return this.currentFunctionNode=t,t.code=this.buildFunctionCode(e),this.currentFunctionNode=n,t}flowShaderNode(e){const t=e.layout,n={[Symbol.iterator](){let e=0;const t=Object.values(this);return{next:()=>({value:t[e],done:e++>=t.length})}}};for(const e of t.inputs)n[e.name]=new Kk(e.type,e.name);e.layout=null;const i=e.call(n),r=this.flowStagesNode(i,t.type);return e.layout=t,r}flowStagesNode(e,t=null){const n=this.flow,i=this.vars,r=this.declarations,s=this.cache,o=this.buildStage,a=this.stack,l={code:""};this.flow=l,this.vars={},this.declarations={},this.cache=new DU,this.stack=Jk();for(const n of JS)this.setBuildStage(n),l.result=e.build(this,t);return l.vars=this.getVars(this.shaderStage),this.flow=n,this.vars=i,this.declarations=r,this.cache=s,this.stack=a,this.setBuildStage(o),l}getFunctionOperator(){return null}buildFunctionCode(){console.warn("Abstract function.")}flowChildNode(e,t=null){const n=this.flow,i={code:""};return this.flow=i,i.result=e.build(this,t),this.flow=n,i}flowNodeFromShaderStage(e,t,n=null,i=null){const r=this.tab,s=this.cache,o=this.shaderStage,a=this.context;this.setShaderStage(e);const l={...this.context};delete l.nodeBlock,this.cache=this.globalCache,this.tab="\t",this.context=l;let c=null;if("generate"===this.buildStage){const r=this.flowChildNode(t,n);null!==i&&(r.code+=`${this.tab+i} = ${r.result};\n`),this.flowCode[e]=this.flowCode[e]+r.code,c=r}else c=t.build(this);return this.setShaderStage(o),this.cache=s,this.tab=r,this.context=a,c}getAttributesArray(){return this.attributes.concat(this.bufferAttributes)}getAttributes(){console.warn("Abstract function.")}getVaryings(){console.warn("Abstract function.")}getVar(e,t,n=null){return`${null!==n?this.generateArrayDeclaration(e,n):this.getType(e)} ${t}`}getVars(e){let t="";const n=this.vars[e];if(void 0!==n)for(const e of n)t+=`${this.getVar(e.type,e.name)}; `;return t}getUniforms(){console.warn("Abstract function.")}getCodes(e){const t=this.codes[e];let n="";if(void 0!==t)for(const e of t)n+=e.code+"\n";return n}getHash(){return this.vertexShader+this.fragmentShader+this.computeShader}setShaderStage(e){this.shaderStage=e}getShaderStage(){return this.shaderStage}setBuildStage(e){this.buildStage=e}getBuildStage(){return this.buildStage}buildCode(){console.warn("Abstract function.")}build(){const{object:e,material:t,renderer:n}=this;if(null!==t){let e=n.library.fromMaterial(t);null===e&&(console.error(`NodeMaterial: Material "${t.type}" is not compatible.`),e=new CD),e.build(this)}else this.addFlow("compute",e);for(const e of JS){this.setBuildStage(e),this.context.vertex&&this.context.vertex.isNode&&this.flowNodeFromShaderStage("vertex",this.context.vertex);for(const t of QS){this.setShaderStage(t);const n=this.flowNodes[t];for(const t of n)"generate"===e?this.flowNode(t):t.build(this)}}return this.setBuildStage(null),this.setShaderStage(null),this.buildCode(),this.buildUpdateNodes(),this}getNodeUniform(e,t){if("float"===t||"int"===t||"uint"===t)return new jU(e);if("vec2"===t||"ivec2"===t||"uvec2"===t)return new HU(e);if("vec3"===t||"ivec3"===t||"uvec3"===t)return new WU(e);if("vec4"===t||"ivec4"===t||"uvec4"===t)return new qU(e);if("color"===t)return new XU(e);if("mat2"===t)return new $U(e);if("mat3"===t)return new YU(e);if("mat4"===t)return new KU(e);throw new Error(`Uniform "${t}" not declared.`)}format(e,t,n){if((t=this.getVectorType(t))===(n=this.getVectorType(n))||null===n||this.isReference(n))return e;const i=this.getTypeLength(t),r=this.getTypeLength(n);return 16===i&&9===r?`${this.getType(n)}( ${e}[ 0 ].xyz, ${e}[ 1 ].xyz, ${e}[ 2 ].xyz )`:9===i&&4===r?`${this.getType(n)}( ${e}[ 0 ].xy, ${e}[ 1 ].xy )`:i>4||r>4||0===r?e:i===r?`${this.getType(n)}( ${e} )`:i>r?(e="bool"===n?`all( ${e} )`:`${e}.${"xyz".slice(0,r)}`,this.format(e,this.getTypeFromLength(r,this.getComponentType(t)),n)):4===r&&i>1?`${this.getType(n)}( ${this.format(e,t,"vec3")}, 1.0 )`:2===i?`${this.getType(n)}( ${this.format(e,t,"vec2")}, 0.0 )`:(1===i&&r>1&&t!==this.getComponentType(n)&&(e=`${this.getType(this.getComponentType(n))}( ${e} )`),`${this.getType(n)}( ${e} )`)}getSignature(){return`// Three.js r${na} - Node System\n`}*[Symbol.iterator](){}createNodeMaterial(e="NodeMaterial"){throw new Error(`THREE.NodeBuilder: createNodeMaterial() was deprecated. Use new ${e}() instead.`)}}class tF{constructor(){this.time=0,this.deltaTime=0,this.frameId=0,this.renderId=0,this.updateMap=new WeakMap,this.updateBeforeMap=new WeakMap,this.updateAfterMap=new WeakMap,this.renderer=null,this.material=null,this.camera=null,this.object=null,this.scene=null}_getMaps(e,t){let n=e.get(t);return void 0===n&&(n={renderMap:new WeakMap,frameMap:new WeakMap},e.set(t,n)),n}updateBeforeNode(e){const t=e.getUpdateBeforeType(),n=e.updateReference(this);if(t===qS){const{frameMap:t}=this._getMaps(this.updateBeforeMap,n);t.get(n)!==this.frameId&&!1!==e.updateBefore(this)&&t.set(n,this.frameId)}else if(t===XS){const{renderMap:t}=this._getMaps(this.updateBeforeMap,n);t.get(n)!==this.renderId&&!1!==e.updateBefore(this)&&t.set(n,this.renderId)}else t===$S&&e.updateBefore(this)}updateAfterNode(e){const t=e.getUpdateAfterType(),n=e.updateReference(this);if(t===qS){const{frameMap:t}=this._getMaps(this.updateAfterMap,n);t.get(n)!==this.frameId&&!1!==e.updateAfter(this)&&t.set(n,this.frameId)}else if(t===XS){const{renderMap:t}=this._getMaps(this.updateAfterMap,n);t.get(n)!==this.renderId&&!1!==e.updateAfter(this)&&t.set(n,this.renderId)}else t===$S&&e.updateAfter(this)}updateNode(e){const t=e.getUpdateType(),n=e.updateReference(this);if(t===qS){const{frameMap:t}=this._getMaps(this.updateMap,n);t.get(n)!==this.frameId&&!1!==e.update(this)&&t.set(n,this.frameId)}else if(t===XS){const{renderMap:t}=this._getMaps(this.updateMap,n);t.get(n)!==this.renderId&&!1!==e.update(this)&&t.set(n,this.renderId)}else t===$S&&e.update(this)}update(){this.frameId++,void 0===this.lastTime&&(this.lastTime=performance.now()),this.deltaTime=(performance.now()-this.lastTime)/1e3,this.lastTime=performance.now(),this.time+=this.deltaTime}}class nF{constructor(e,t,n=null,i="",r=!1){this.type=e,this.name=t,this.count=n,this.qualifier=i,this.isConst=r}}nF.isNodeFunctionInput=!0;class iF extends yU{static get type(){return"DirectionalLightNode"}constructor(e=null){super(e)}setupDirect(){const e=this.colorNode;return{lightDirection:BO(this.light),lightColor:e}}}const rF=new Iu,sF=new Iu;let oF=null;class aF extends yU{static get type(){return"RectAreaLightNode"}constructor(e=null){super(e),this.halfHeight=rA(new Dc).setGroup(tA),this.halfWidth=rA(new Dc).setGroup(tA),this.updateType=XS}update(e){super.update(e);const{light:t}=this,n=e.camera.matrixWorldInverse;sF.identity(),rF.copy(t.matrixWorld),rF.premultiply(n),sF.extractRotation(rF),this.halfWidth.value.set(.5*t.width,0,0),this.halfHeight.value.set(0,.5*t.height,0),this.halfWidth.value.applyMatrix4(sF),this.halfHeight.value.applyMatrix4(sF)}setupDirectRectArea(e){let t,n;e.isAvailable("float32Filterable")?(t=AR(oF.LTC_FLOAT_1),n=AR(oF.LTC_FLOAT_2)):(t=AR(oF.LTC_HALF_1),n=AR(oF.LTC_HALF_2));const{colorNode:i,light:r}=this;return{lightColor:i,lightPosition:FO(r),halfWidth:this.halfWidth,halfHeight:this.halfHeight,ltc_1:t,ltc_2:n}}static setLTC(e){oF=e}}class lF extends yU{static get type(){return"SpotLightNode"}constructor(e=null){super(e),this.coneCosNode=rA(0).setGroup(tA),this.penumbraCosNode=rA(0).setGroup(tA),this.cutoffDistanceNode=rA(0).setGroup(tA),this.decayExponentNode=rA(0).setGroup(tA),this.colorNode=rA(this.color).setGroup(tA)}update(e){super.update(e);const{light:t}=this;this.coneCosNode.value=Math.cos(t.angle),this.penumbraCosNode.value=Math.cos(t.angle*(1-t.penumbra)),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}getSpotAttenuation(e,t){const{coneCosNode:n,penumbraCosNode:i}=this;return IC(n,i,t)}getLightCoord(e){const t=e.getNodeProperties(this);let n=t.projectionUV;return void 0===n&&(n=function(e,t=eN){const n=OO(e).mul(t);return n.xyz.div(n.w)}(this.light,e.context.positionWorld),t.projectionUV=n),n}setupDirect(e){const{colorNode:t,cutoffDistanceNode:n,decayExponentNode:i,light:r}=this,s=this.getLightVector(e),o=s.normalize(),a=o.dot(BO(r)),l=this.getSpotAttenuation(e,a),c=s.length(),u=vU({lightDistance:c,cutoffDistance:n,decayExponent:i});let h,d,p=t.mul(l).mul(u);if(r.colorNode?(d=this.getLightCoord(e),h=r.colorNode(d)):r.map&&(d=this.getLightCoord(e),h=AR(r.map,d.xy).onRenderUpdate((()=>r.map))),h){p=d.mul(2).sub(1).abs().lessThan(1).all().select(p.mul(h),p)}return{lightColor:p,lightDirection:o}}}class cF extends lF{static get type(){return"IESSpotLightNode"}getSpotAttenuation(e,t){const n=this.light.iesMap;let i=null;if(n&&!0===n.isTexture){const e=t.acos().mul(1/Math.PI);i=AR(n,oE(e,0),0).r}else i=super.getSpotAttenuation(t);return i}}const uF=KM((([e,t])=>{const n=e.abs().sub(t);return oC(yC(n,0)).add(gC(yC(n.x,n.y),0))}));class hF extends lF{static get type(){return"ProjectorLightNode"}update(e){super.update(e);const t=this.light;if(this.penumbraCosNode.value=Math.min(Math.cos(t.angle*(1-t.penumbra)),.99999),null===t.aspect){let e=1;null!==t.map&&(e=t.map.width/t.map.height),t.shadow.aspect=e}else t.shadow.aspect=t.aspect}getSpotAttenuation(e){const t=this.penumbraCosNode,n=this.getLightCoord(e),i=n.xyz.div(n.w),r=uF(i.xy.sub(oE(.5)),oE(.5)),s=pA(-1,hA(1,nC(t)).sub(1));return DC(r.mul(-2).mul(s))}}class dF extends yU{static get type(){return"AmbientLightNode"}constructor(e=null){super(e)}setup({context:e}){e.irradiance.addAssign(this.colorNode)}}class pF extends yU{static get type(){return"HemisphereLightNode"}constructor(e=null){super(e),this.lightPositionNode=UO(e),this.lightDirectionNode=this.lightPositionNode.normalize(),this.groundColorNode=rA(new Eh).setGroup(tA)}update(e){const{light:t}=this;super.update(e),this.lightPositionNode.object3d=t,this.groundColorNode.value.copy(t.groundColor).multiplyScalar(t.intensity)}setup(e){const{colorNode:t,groundColorNode:n,lightDirectionNode:i}=this,r=uN.dot(i).mul(.5).add(.5),s=NC(n,t,r);e.context.irradiance.addAssign(s)}}class fF extends yU{static get type(){return"LightProbeNode"}constructor(e=null){super(e);const t=[];for(let e=0;e<9;e++)t.push(new Dc);this.lightProbe=LR(t)}update(e){const{light:t}=this;super.update(e);for(let e=0;e<9;e++)this.lightProbe.array[e].copy(t.sh.coefficients[e]).multiplyScalar(t.intensity)}setup(e){const t=xU(uN,this.lightProbe);e.context.irradiance.addAssign(t)}}class mF{parseFunction(){console.warn("Abstract function.")}}class gF{constructor(e,t,n="",i=""){this.type=e,this.inputs=t,this.name=n,this.precision=i}getCode(){console.warn("Abstract function.")}}gF.isNodeFunction=!0;const yF=/^\s*(highp|mediump|lowp)?\s*([a-z_0-9]+)\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)/i,vF=/[a-z_0-9]+/gi,_F="#pragma main";class xF extends gF{constructor(e){const{type:t,inputs:n,name:i,precision:r,inputsCode:s,blockCode:o,headerCode:a}=(e=>{const t=(e=e.trim()).indexOf(_F),n=-1!==t?e.slice(t+12):e,i=n.match(yF);if(null!==i&&5===i.length){const r=i[4],s=[];let o=null;for(;null!==(o=vF.exec(r));)s.push(o);const a=[];let l=0;for(;l<s.length;){const e="const"===s[l][0];!0===e&&l++;let t=s[l][0];"in"===t||"out"===t||"inout"===t?l++:t="";const n=s[l++][0];let i=Number.parseInt(s[l][0]);!1===Number.isNaN(i)?l++:i=null;const r=s[l++][0];a.push(new nF(n,r,i,t,e))}const c=n.substring(i[0].length),u=void 0!==i[3]?i[3]:"";return{type:i[2],inputs:a,name:u,precision:void 0!==i[1]?i[1]:"",inputsCode:r,blockCode:c,headerCode:-1!==t?e.slice(0,t):""}}throw new Error("FunctionNode: Function is not a GLSL code.")})(e);super(t,n,i,r),this.inputsCode=s,this.blockCode=o,this.headerCode=a}getCode(e=this.name){let t;const n=this.blockCode;if(""!==n){const{type:i,inputsCode:r,headerCode:s,precision:o}=this;let a=`${i} ${e} ( ${r.trim()} )`;""!==o&&(a=`${o} ${a}`),t=s+a+n}else t="";return t}}class bF extends mF{parseFunction(e){return new xF(e)}}const wF=new WeakMap,TF=[],SF=[];class MF extends gk{constructor(e,t){super(),this.renderer=e,this.backend=t,this.nodeFrame=new tF,this.nodeBuilderCache=new Map,this.callHashCache=new hk,this.groupsData=new hk,this.cacheLib={}}updateGroup(e){const t=e.groupNode,n=t.name;if(n===nA.name)return!0;if(n===tA.name){const t=this.get(e),n=this.nodeFrame.renderId;return t.renderId!==n&&(t.renderId=n,!0)}if(n===eA.name){const t=this.get(e),n=this.nodeFrame.frameId;return t.frameId!==n&&(t.frameId=n,!0)}TF[0]=t,TF[1]=e;let i=this.groupsData.get(TF);return void 0===i&&this.groupsData.set(TF,i={}),TF.length=0,i.version!==t.version&&(i.version=t.version,!0)}getForRenderCacheKey(e){return e.initialCacheKey}getForRender(e){const t=this.get(e);let n=t.nodeBuilderState;if(void 0===n){const{nodeBuilderCache:i}=this,r=this.getForRenderCacheKey(e);if(n=i.get(r),void 0===n){const t=this.backend.createNodeBuilder(e.object,this.renderer);t.scene=e.scene,t.material=e.material,t.camera=e.camera,t.context.material=e.material,t.lightsNode=e.lightsNode,t.environmentNode=this.getEnvironmentNode(e.scene),t.fogNode=this.getFogNode(e.scene),t.clippingContext=e.clippingContext,this.renderer.getOutputRenderTarget()&&this.renderer.getOutputRenderTarget().multiview&&t.enableMultiview(),t.build(),n=this._createNodeBuilderState(t),i.set(r,n)}n.usedTimes++,t.nodeBuilderState=n}return n}delete(e){if(e.isRenderObject){const t=this.get(e).nodeBuilderState;t.usedTimes--,0===t.usedTimes&&this.nodeBuilderCache.delete(this.getForRenderCacheKey(e))}return super.delete(e)}getForCompute(e){const t=this.get(e);let n=t.nodeBuilderState;if(void 0===n){const i=this.backend.createNodeBuilder(e,this.renderer);i.build(),n=this._createNodeBuilderState(i),t.nodeBuilderState=n}return n}_createNodeBuilderState(e){return new MU(e.vertexShader,e.fragmentShader,e.computeShader,e.getAttributesArray(),e.getBindings(),e.updateNodes,e.updateBeforeNodes,e.updateAfterNodes,e.observer,e.transforms)}getEnvironmentNode(e){this.updateEnvironment(e);let t=null;if(e.environmentNode&&e.environmentNode.isNode)t=e.environmentNode;else{const n=this.get(e);n.environmentNode&&(t=n.environmentNode)}return t}getBackgroundNode(e){this.updateBackground(e);let t=null;if(e.backgroundNode&&e.backgroundNode.isNode)t=e.backgroundNode;else{const n=this.get(e);n.backgroundNode&&(t=n.backgroundNode)}return t}getFogNode(e){return this.updateFog(e),e.fogNode||this.get(e).fogNode||null}getCacheKey(e,t){TF[0]=e,TF[1]=t;const n=this.renderer.info.calls,i=this.callHashCache.get(TF)||{};if(i.callId!==n){const r=this.getEnvironmentNode(e),s=this.getFogNode(e);t&&SF.push(t.getCacheKey(!0)),r&&SF.push(r.getCacheKey()),s&&SF.push(s.getCacheKey()),SF.push(this.renderer.getOutputRenderTarget()&&this.renderer.getOutputRenderTarget().multiview?1:0),SF.push(this.renderer.shadowMap.enabled?1:0),i.callId=n,i.cacheKey=kS(SF),this.callHashCache.set(TF,i),SF.length=0}return TF.length=0,i.cacheKey}get isToneMappingState(){return!this.renderer.getRenderTarget()}updateBackground(e){const t=this.get(e),n=e.background;if(n){const i=0===e.backgroundBlurriness&&t.backgroundBlurriness>0||e.backgroundBlurriness>0&&0===t.backgroundBlurriness;if(t.background!==n||i){const r=this.getCacheNode("background",n,(()=>{if(!0===n.isCubeTexture||n.mapping===Va||n.mapping===Ga||n.mapping===ja){if(e.backgroundBlurriness>0||n.mapping===ja)return FI(n);{let e;return e=!0===n.isCubeTexture?CN(n):AR(n),GD(e)}}if(!0===n.isTexture)return AR(n,oD.flipY()).setUpdateMatrix(!0);!0!==n.isColor&&console.error("WebGPUNodes: Unsupported background configuration.",n)}),i);t.backgroundNode=r,t.background=n,t.backgroundBlurriness=e.backgroundBlurriness}}else t.backgroundNode&&(delete t.backgroundNode,delete t.background)}getCacheNode(e,t,n,i=!1){const r=this.cacheLib[e]||(this.cacheLib[e]=new WeakMap);let s=r.get(t);return(void 0===s||i)&&(s=n(),r.set(t,s)),s}updateFog(e){const t=this.get(e),n=e.fog;if(n){if(t.fog!==n){const e=this.getCacheNode("fog",n,(()=>{if(n.isFogExp2){const e=PN("color","color",n).setGroup(tA),t=PN("density","float",n).setGroup(tA);return DO(e,PO(t))}if(n.isFog){const e=PN("color","color",n).setGroup(tA),t=PN("near","float",n).setGroup(tA),i=PN("far","float",n).setGroup(tA);return DO(e,NO(t,i))}console.error("THREE.Renderer: Unsupported fog configuration.",n)}));t.fogNode=e,t.fog=n}}else delete t.fogNode,delete t.fog}updateEnvironment(e){const t=this.get(e),n=e.environment;if(n){if(t.environment!==n){const e=this.getCacheNode("environment",n,(()=>!0===n.isCubeTexture?CN(n):!0===n.isTexture?AR(n):void console.error("Nodes: Unsupported environment configuration.",n)));t.environmentNode=e,t.environment=n}}else t.environmentNode&&(delete t.environmentNode,delete t.environment)}getNodeFrame(e=this.renderer,t=null,n=null,i=null,r=null){const s=this.nodeFrame;return s.renderer=e,s.scene=t,s.object=n,s.camera=i,s.material=r,s}getNodeFrameForRender(e){return this.getNodeFrame(e.renderer,e.scene,e.object,e.camera,e.material)}getOutputCacheKey(){const e=this.renderer;return e.toneMapping+","+e.currentColorSpace+","+e.xr.isPresenting}hasOutputChange(e){return wF.get(e)!==this.getOutputCacheKey()}getOutputNode(e){const t=this.renderer,n=this.getOutputCacheKey(),i=e.isArrayTexture?dO(e,uE(oD,IR("gl_ViewID_OVR"))).renderOutput(t.toneMapping,t.currentColorSpace):AR(e,oD).renderOutput(t.toneMapping,t.currentColorSpace);return wF.set(e,n),i}updateBefore(e){const t=e.getNodeBuilderState();for(const n of t.updateBeforeNodes)this.getNodeFrameForRender(e).updateBeforeNode(n)}updateAfter(e){const t=e.getNodeBuilderState();for(const n of t.updateAfterNodes)this.getNodeFrameForRender(e).updateAfterNode(n)}updateForCompute(e){const t=this.getNodeFrame(),n=this.getForCompute(e);for(const e of n.updateNodes)t.updateNode(e)}updateForRender(e){const t=this.getNodeFrameForRender(e),n=e.getNodeBuilderState();for(const e of n.updateNodes)t.updateNode(e)}needsRefresh(e){const t=this.getNodeFrameForRender(e);return e.getMonitor().needsRefresh(e,t)}dispose(){super.dispose(),this.nodeFrame=new tF,this.nodeBuilderCache=new Map,this.cacheLib={}}}const EF=new Fd;class AF{constructor(e=null){this.version=0,this.clipIntersection=null,this.cacheKey="",this.shadowPass=!1,this.viewNormalMatrix=new kc,this.clippingGroupContexts=new WeakMap,this.intersectionPlanes=[],this.unionPlanes=[],this.parentVersion=null,null!==e&&(this.viewNormalMatrix=e.viewNormalMatrix,this.clippingGroupContexts=e.clippingGroupContexts,this.shadowPass=e.shadowPass,this.viewMatrix=e.viewMatrix)}projectPlanes(e,t,n){const i=e.length;for(let r=0;r<i;r++){EF.copy(e[r]).applyMatrix4(this.viewMatrix,this.viewNormalMatrix);const i=t[n+r],s=EF.normal;i.x=-s.x,i.y=-s.y,i.z=-s.z,i.w=EF.constant}}updateGlobal(e,t){this.shadowPass=null!==e.overrideMaterial&&e.overrideMaterial.isShadowPassMaterial,this.viewMatrix=t.matrixWorldInverse,this.viewNormalMatrix.getNormalMatrix(this.viewMatrix)}update(e,t){let n=!1;e.version!==this.parentVersion&&(this.intersectionPlanes=Array.from(e.intersectionPlanes),this.unionPlanes=Array.from(e.unionPlanes),this.parentVersion=e.version),this.clipIntersection!==t.clipIntersection&&(this.clipIntersection=t.clipIntersection,this.clipIntersection?this.unionPlanes.length=e.unionPlanes.length:this.intersectionPlanes.length=e.intersectionPlanes.length);const i=t.clippingPlanes,r=i.length;let s,o;if(this.clipIntersection?(s=this.intersectionPlanes,o=e.intersectionPlanes.length):(s=this.unionPlanes,o=e.unionPlanes.length),s.length!==o+r){s.length=o+r;for(let e=0;e<r;e++)s[o+e]=new nu;n=!0}this.projectPlanes(i,s,o),n&&(this.version++,this.cacheKey=`${this.intersectionPlanes.length}:${this.unionPlanes.length}`)}getGroupContext(e){if(this.shadowPass&&!e.clipShadows)return this;let t=this.clippingGroupContexts.get(e);return void 0===t&&(t=new AF(this),this.clippingGroupContexts.set(e,t)),t.update(this,e),t}get unionClippingCount(){return this.unionPlanes.length}}class CF{constructor(e,t){this.bundleGroup=e,this.camera=t}}const RF=[];class NF{constructor(){this.bundles=new hk}get(e,t){const n=this.bundles;RF[0]=e,RF[1]=t;let i=n.get(RF);return void 0===i&&(i=new CF(e,t),n.set(RF,i)),RF.length=0,i}dispose(){this.bundles=new hk}}class PF{constructor(){this.lightNodes=new WeakMap,this.materialNodes=new Map,this.toneMappingNodes=new Map}fromMaterial(e){if(e.isNodeMaterial)return e;let t=null;const n=this.getMaterialNodeClass(e.type);if(null!==n){t=new n;for(const n in e)t[n]=e[n]}return t}addToneMapping(e,t){this.addType(e,t,this.toneMappingNodes)}getToneMappingFunction(e){return this.toneMappingNodes.get(e)||null}getMaterialNodeClass(e){return this.materialNodes.get(e)||null}addMaterial(e,t){this.addType(e,t,this.materialNodes)}getLightNodeClass(e){return this.lightNodes.get(e)||null}addLight(e,t){this.addClass(e,t,this.lightNodes)}addType(e,t,n){if(n.has(t))console.warn(`Redefinition of node ${t}`);else{if("function"!=typeof e)throw new Error(`Node class ${e.name} is not a class.`);if("function"==typeof t||"object"==typeof t)throw new Error(`Base class ${t} is not a class.`);n.set(t,e)}}addClass(e,t,n){if(n.has(t))console.warn(`Redefinition of node ${t.name}`);else{if("function"!=typeof e)throw new Error(`Node class ${e.name} is not a class.`);if("function"!=typeof t)throw new Error(`Base class ${t.name} is not a class.`);n.set(t,e)}}}const DF=new jO,LF=[];class IF extends hk{constructor(){super()}createNode(e=[]){return(new jO).setLights(e)}getNode(e,t){if(e.isQuadMesh)return DF;LF[0]=e,LF[1]=t;let n=this.get(LF);return void 0===n&&(n=this.createNode(),this.set(LF,n)),LF.length=0,n}}class kF extends iu{constructor(e=1,t=1,n={}){super(e,t,n),this.isXRRenderTarget=!0,this.hasExternalTextures=!1,this.autoAllocateDepthBuffer=!0}copy(e){return super.copy(e),this.hasExternalTextures=e.hasExternalTextures,this.autoAllocateDepthBuffer=e.autoAllocateDepthBuffer,this}}const OF=new Dc,UF=new Dc;class FF extends vc{constructor(e,t=!1){super(),this.enabled=!1,this.isPresenting=!1,this.cameraAutoUpdate=!0,this._renderer=e,this._cameraL=new xd,this._cameraL.viewport=new nu,this._cameraR=new xd,this._cameraR.viewport=new nu,this._cameras=[this._cameraL,this._cameraR],this._cameraXR=new sf,this._currentDepthNear=null,this._currentDepthFar=null,this._controllers=[],this._controllerInputSources=[],this._xrRenderTarget=null,this._layers=[],this._supportsLayers=!1,this._frameBufferTargets=null,this._createXRLayer=jF.bind(this),this._gl=null,this._currentAnimationContext=null,this._currentAnimationLoop=null,this._currentPixelRatio=null,this._currentSize=new Nc,this._onSessionEvent=zF.bind(this),this._onSessionEnd=VF.bind(this),this._onInputSourcesChange=GF.bind(this),this._onAnimationFrame=HF.bind(this),this._referenceSpace=null,this._referenceSpaceType="local-floor",this._customReferenceSpace=null,this._framebufferScaleFactor=1,this._foveation=1,this._session=null,this._glBaseLayer=null,this._glBinding=null,this._glProjLayer=null,this._xrFrame=null,this._useLayers="undefined"!=typeof XRWebGLBinding&&"createProjectionLayer"in XRWebGLBinding.prototype,this._useMultiviewIfPossible=t,this._useMultiview=!1}getController(e){return this._getController(e).getTargetRaySpace()}getControllerGrip(e){return this._getController(e).getGripSpace()}getHand(e){return this._getController(e).getHandSpace()}getFoveation(){if(null!==this._glProjLayer||null!==this._glBaseLayer)return this._foveation}setFoveation(e){this._foveation=e,null!==this._glProjLayer&&(this._glProjLayer.fixedFoveation=e),null!==this._glBaseLayer&&void 0!==this._glBaseLayer.fixedFoveation&&(this._glBaseLayer.fixedFoveation=e)}getFramebufferScaleFactor(){return this._framebufferScaleFactor}setFramebufferScaleFactor(e){this._framebufferScaleFactor=e,!0===this.isPresenting&&console.warn("THREE.XRManager: Cannot change framebuffer scale while presenting.")}getReferenceSpaceType(){return this._referenceSpaceType}setReferenceSpaceType(e){this._referenceSpaceType=e,!0===this.isPresenting&&console.warn("THREE.XRManager: Cannot change reference space type while presenting.")}getReferenceSpace(){return this._customReferenceSpace||this._referenceSpace}setReferenceSpace(e){this._customReferenceSpace=e}getCamera(){return this._cameraXR}getEnvironmentBlendMode(){if(null!==this._session)return this._session.environmentBlendMode}getFrame(){return this._xrFrame}useMultiview(){return this._useMultiview}createQuadLayer(e,t,n,i,r,s,o,a={}){const l=new _p(e,t),c=new kF(r,s,{format:pl,type:Qa,depthTexture:new ip(r,s,a.stencil?cl:rl,void 0,void 0,void 0,void 0,void 0,void 0,a.stencil?ml:fl),stencilBuffer:a.stencil,resolveDepthBuffer:!1,resolveStencilBuffer:!1});c.autoAllocateDepthBuffer=!0;const u=new Nh({color:16777215,side:0});u.map=c.texture,u.map.offset.y=1,u.map.repeat.y=-1;const h=new ld(l,u);h.position.copy(n),h.quaternion.copy(i);const d={type:"quad",width:e,height:t,translation:n,quaternion:i,pixelwidth:r,pixelheight:s,plane:h,material:u,rendercall:o,renderTarget:c};if(this._layers.push(d),null!==this._session){d.plane.material=new Nh({color:16777215,side:0}),d.plane.material.blending=5,d.plane.material.blendEquation=pa,d.plane.material.blendSrc=ga,d.plane.material.blendDst=ga,d.xrlayer=this._createXRLayer(d);const e=this._session.renderState.layers;e.unshift(d.xrlayer),this._session.updateRenderState({layers:e})}else c.isXRRenderTarget=!1;return h}createCylinderLayer(e,t,n,i,r,s,o,a,l={}){const c=new rp(e,e,e*t/n,64,64,!0,Math.PI-t/2,t),u=new kF(s,o,{format:pl,type:Qa,depthTexture:new ip(s,o,l.stencil?cl:rl,void 0,void 0,void 0,void 0,void 0,void 0,l.stencil?ml:fl),stencilBuffer:l.stencil,resolveDepthBuffer:!1,resolveStencilBuffer:!1});u.autoAllocateDepthBuffer=!0;const h=new Nh({color:16777215,side:1});h.map=u.texture,h.map.offset.y=1,h.map.repeat.y=-1;const d=new ld(c,h);d.position.copy(i),d.quaternion.copy(r);const p={type:"cylinder",radius:e,centralAngle:t,aspectratio:n,translation:i,quaternion:r,pixelwidth:s,pixelheight:o,plane:d,material:h,rendercall:a,renderTarget:u};if(this._layers.push(p),null!==this._session){p.plane.material=new Nh({color:16777215,side:1}),p.plane.material.blending=5,p.plane.material.blendEquation=pa,p.plane.material.blendSrc=ga,p.plane.material.blendDst=ga,p.xrlayer=this._createXRLayer(p);const e=this._session.renderState.layers;e.unshift(p.xrlayer),this._session.updateRenderState({layers:e})}else u.isXRRenderTarget=!1;return d}renderLayers(){const e=new Dc,t=new Pc,n=this._renderer,i=this.isPresenting,r=n.getOutputRenderTarget(),s=n._frameBufferTarget;this.isPresenting=!1;const o=new Nc;n.getSize(o);const a=n._quad;for(const i of this._layers)if(i.renderTarget.isXRRenderTarget=null!==this._session,i.renderTarget.hasExternalTextures=i.renderTarget.isXRRenderTarget,i.renderTarget.isXRRenderTarget&&this._supportsLayers){i.xrlayer.transform=new XRRigidTransform(i.plane.getWorldPosition(e),i.plane.getWorldQuaternion(t));const r=this._glBinding.getSubImage(i.xrlayer,this._xrFrame);n.backend.setXRRenderTargetTextures(i.renderTarget,r.colorTexture,void 0),n._setXRLayerSize(i.renderTarget.width,i.renderTarget.height),n.setOutputRenderTarget(i.renderTarget),n.setRenderTarget(null),n._frameBufferTarget=null,this._frameBufferTargets||(this._frameBufferTargets=new WeakMap);const{frameBufferTarget:s,quad:o}=this._frameBufferTargets.get(i.renderTarget)||{frameBufferTarget:null,quad:null};s?(n._frameBufferTarget=s,n._quad=o):(n._quad=new iO(new CD),this._frameBufferTargets.set(i.renderTarget,{frameBufferTarget:n._getFrameBufferTarget(),quad:n._quad})),i.rendercall(),n._frameBufferTarget=null}else n.setRenderTarget(i.renderTarget),i.rendercall();n.setRenderTarget(null),n.setOutputRenderTarget(r),n._frameBufferTarget=s,n._setXRLayerSize(o.x,o.y),n._quad=a,this.isPresenting=i}getSession(){return this._session}async setSession(e){const t=this._renderer,n=t.backend;this._gl=t.getContext();const i=this._gl,r=i.getContextAttributes();if(this._session=e,null!==e){if(!0===n.isWebGPUBackend)throw new Error('THREE.XRManager: XR is currently not supported with a WebGPU backend. Use WebGL by passing "{ forceWebGL: true }" to the constructor of the renderer.');if(e.addEventListener("select",this._onSessionEvent),e.addEventListener("selectstart",this._onSessionEvent),e.addEventListener("selectend",this._onSessionEvent),e.addEventListener("squeeze",this._onSessionEvent),e.addEventListener("squeezestart",this._onSessionEvent),e.addEventListener("squeezeend",this._onSessionEvent),e.addEventListener("end",this._onSessionEnd),e.addEventListener("inputsourceschange",this._onInputSourcesChange),await n.makeXRCompatible(),this._currentPixelRatio=t.getPixelRatio(),t.getSize(this._currentSize),this._currentAnimationContext=t._animation.getContext(),this._currentAnimationLoop=t._animation.getAnimationLoop(),t._animation.stop(),!0===this._useLayers){let n=null,s=null,o=null;t.depth&&(o=t.stencil?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT24,n=t.stencil?ml:fl,s=t.stencil?cl:rl);const a={colorFormat:i.RGBA8,depthFormat:o,scaleFactor:this._framebufferScaleFactor,clearOnAccess:!1};this._useMultiviewIfPossible&&t.hasFeature("OVR_multiview2")&&(a.textureType="texture-array",this._useMultiview=!0);const l=new XRWebGLBinding(e,i),c=l.createProjectionLayer(a),u=[c];this._glBinding=l,this._glProjLayer=c,t.setPixelRatio(1),t._setXRLayerSize(c.textureWidth,c.textureHeight);const h=this._useMultiview?2:1,d=new ip(c.textureWidth,c.textureHeight,s,void 0,void 0,void 0,void 0,void 0,void 0,n,h);if(this._xrRenderTarget=new kF(c.textureWidth,c.textureHeight,{format:pl,type:Qa,colorSpace:t.outputColorSpace,depthTexture:d,stencilBuffer:t.stencil,samples:r.antialias?4:0,resolveDepthBuffer:!1===c.ignoreDepthValues,resolveStencilBuffer:!1===c.ignoreDepthValues,depth:this._useMultiview?2:1,multiview:this._useMultiview}),this._xrRenderTarget.hasExternalTextures=!0,this._xrRenderTarget.depth=this._useMultiview?2:1,this._supportsLayers=e.enabledFeatures.includes("layers"),this._referenceSpace=await e.requestReferenceSpace(this.getReferenceSpaceType()),this._supportsLayers)for(const e of this._layers)e.plane.material=new Nh({color:16777215,side:"cylinder"===e.type?1:0}),e.plane.material.blending=5,e.plane.material.blendEquation=pa,e.plane.material.blendSrc=ga,e.plane.material.blendDst=ga,e.xrlayer=this._createXRLayer(e),u.unshift(e.xrlayer);e.updateRenderState({layers:u})}else{const n={antialias:t.samples>0,alpha:!0,depth:t.depth,stencil:t.stencil,framebufferScaleFactor:this.getFramebufferScaleFactor()},r=new XRWebGLLayer(e,i,n);this._glBaseLayer=r,e.updateRenderState({baseLayer:r}),t.setPixelRatio(1),t._setXRLayerSize(r.framebufferWidth,r.framebufferHeight),this._xrRenderTarget=new kF(r.framebufferWidth,r.framebufferHeight,{format:pl,type:Qa,colorSpace:t.outputColorSpace,stencilBuffer:t.stencil,resolveDepthBuffer:!1===r.ignoreDepthValues,resolveStencilBuffer:!1===r.ignoreDepthValues}),this._referenceSpace=await e.requestReferenceSpace(this.getReferenceSpaceType())}this.setFoveation(this.getFoveation()),t._animation.setAnimationLoop(this._onAnimationFrame),t._animation.setContext(e),t._animation.start(),this.isPresenting=!0,this.dispatchEvent({type:"sessionstart"})}}updateCamera(e){const t=this._session;if(null===t)return;const n=e.near,i=e.far,r=this._cameraXR,s=this._cameraL,o=this._cameraR;r.near=o.near=s.near=n,r.far=o.far=s.far=i,r.isMultiViewCamera=this._useMultiview,this._currentDepthNear===r.near&&this._currentDepthFar===r.far||(t.updateRenderState({depthNear:r.near,depthFar:r.far}),this._currentDepthNear=r.near,this._currentDepthFar=r.far),s.layers.mask=2|e.layers.mask,o.layers.mask=4|e.layers.mask,r.layers.mask=s.layers.mask|o.layers.mask;const a=e.parent,l=r.cameras;BF(r,a);for(let e=0;e<l.length;e++)BF(l[e],a);2===l.length?function(e,t,n){OF.setFromMatrixPosition(t.matrixWorld),UF.setFromMatrixPosition(n.matrixWorld);const i=OF.distanceTo(UF),r=t.projectionMatrix.elements,s=n.projectionMatrix.elements,o=r[14]/(r[10]-1),a=r[14]/(r[10]+1),l=(r[9]+1)/r[5],c=(r[9]-1)/r[5],u=(r[8]-1)/r[0],h=(s[8]+1)/s[0],d=o*u,p=o*h,f=i/(-u+h),m=f*-u;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(m),e.translateZ(f),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===r[10])e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{const t=o+f,n=a+f,r=d-m,s=p+(i-m),u=l*a/n*t,h=c*a/n*t;e.projectionMatrix.makePerspective(r,s,u,h,t,n),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(r,s,o):r.projectionMatrix.copy(s.projectionMatrix),function(e,t,n){null===n?e.matrix.copy(t.matrixWorld):(e.matrix.copy(n.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld));e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*wc*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,r,a)}_getController(e){let t=this._controllers[e];return void 0===t&&(t=new Ad,this._controllers[e]=t),t}}function BF(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}function zF(e){const t=this._controllerInputSources.indexOf(e.inputSource);if(-1===t)return;const n=this._controllers[t];if(void 0!==n){const t=this.getReferenceSpace();n.update(e.inputSource,e.frame,t),n.dispatchEvent({type:e.type,data:e.inputSource})}}function VF(){const e=this._session,t=this._renderer;e.removeEventListener("select",this._onSessionEvent),e.removeEventListener("selectstart",this._onSessionEvent),e.removeEventListener("selectend",this._onSessionEvent),e.removeEventListener("squeeze",this._onSessionEvent),e.removeEventListener("squeezestart",this._onSessionEvent),e.removeEventListener("squeezeend",this._onSessionEvent),e.removeEventListener("end",this._onSessionEnd),e.removeEventListener("inputsourceschange",this._onInputSourcesChange);for(let e=0;e<this._controllers.length;e++){const t=this._controllerInputSources[e];null!==t&&(this._controllerInputSources[e]=null,this._controllers[e].disconnect(t))}if(this._currentDepthNear=null,this._currentDepthFar=null,t._resetXRState(),this._session=null,this._xrRenderTarget=null,!0===this._supportsLayers)for(const e of this._layers)e.renderTarget=new kF(e.pixelwidth,e.pixelheight,{format:pl,type:Qa,depthTexture:new ip(e.pixelwidth,e.pixelheight,e.stencilBuffer?cl:rl,void 0,void 0,void 0,void 0,void 0,void 0,e.stencilBuffer?ml:fl),stencilBuffer:e.stencilBuffer,resolveDepthBuffer:!1,resolveStencilBuffer:!1}),e.renderTarget.isXRRenderTarget=!1,e.plane.material=e.material,e.material.map=e.renderTarget.texture,e.material.map.offset.y=1,e.material.map.repeat.y=-1,delete e.xrlayer;this.isPresenting=!1,this._useMultiview=!1,t._animation.stop(),t._animation.setAnimationLoop(this._currentAnimationLoop),t._animation.setContext(this._currentAnimationContext),t._animation.start(),t.setPixelRatio(this._currentPixelRatio),t.setSize(this._currentSize.width,this._currentSize.height,!1),this.dispatchEvent({type:"sessionend"})}function GF(e){const t=this._controllers,n=this._controllerInputSources;for(let i=0;i<e.removed.length;i++){const r=e.removed[i],s=n.indexOf(r);s>=0&&(n[s]=null,t[s].disconnect(r))}for(let i=0;i<e.added.length;i++){const r=e.added[i];let s=n.indexOf(r);if(-1===s){for(let e=0;e<t.length;e++){if(e>=n.length){n.push(r),s=e;break}if(null===n[e]){n[e]=r,s=e;break}}if(-1===s)break}const o=t[s];o&&o.connect(r)}}function jF(e){return"quad"===e.type?this._glBinding.createQuadLayer({transform:new XRRigidTransform(e.translation,e.quaternion),width:e.width/2,height:e.height/2,space:this._referenceSpace,viewPixelWidth:e.pixelwidth,viewPixelHeight:e.pixelheight,clearOnAccess:!1}):this._glBinding.createCylinderLayer({transform:new XRRigidTransform(e.translation,e.quaternion),radius:e.radius,centralAngle:e.centralAngle,aspectRatio:e.aspectRatio,space:this._referenceSpace,viewPixelWidth:e.pixelwidth,viewPixelHeight:e.pixelheight,clearOnAccess:!1})}function HF(e,t){if(void 0===t)return;const n=this._cameraXR,i=this._renderer,r=i.backend,s=this._glBaseLayer,o=this.getReferenceSpace(),a=t.getViewerPose(o);if(this._xrFrame=t,null!==a){const e=a.views;null!==this._glBaseLayer&&r.setXRTarget(s.framebuffer);let t=!1;e.length!==n.cameras.length&&(n.cameras.length=0,t=!0);for(let i=0;i<e.length;i++){const o=e[i];let a;if(!0===this._useLayers){const e=this._glBinding.getViewSubImage(this._glProjLayer,o);a=e.viewport,0===i&&r.setXRRenderTargetTextures(this._xrRenderTarget,e.colorTexture,this._glProjLayer.ignoreDepthValues&&!this._useMultiview?void 0:e.depthStencilTexture)}else a=s.getViewport(o);let l=this._cameras[i];void 0===l&&(l=new xd,l.layers.enable(i),l.viewport=new nu,this._cameras[i]=l),l.matrix.fromArray(o.transform.matrix),l.matrix.decompose(l.position,l.quaternion,l.scale),l.projectionMatrix.fromArray(o.projectionMatrix),l.projectionMatrixInverse.copy(l.projectionMatrix).invert(),l.viewport.set(a.x,a.y,a.width,a.height),0===i&&(n.matrix.copy(l.matrix),n.matrix.decompose(n.position,n.quaternion,n.scale)),!0===t&&n.cameras.push(l)}i.setOutputRenderTarget(this._xrRenderTarget)}for(let e=0;e<this._controllers.length;e++){const n=this._controllerInputSources[e],i=this._controllers[e];null!==n&&void 0!==i&&i.update(n,t,o)}this._currentAnimationLoop&&this._currentAnimationLoop(e,t),t.detectedPlanes&&this.dispatchEvent({type:"planesdetected",data:t}),this._xrFrame=null}const WF=new Cd,qF=new Nc,XF=new nu,$F=new Vd,YF=new Hd,KF=new Iu,ZF=new nu;class JF{constructor(e,t={}){this.isRenderer=!0;const{logarithmicDepthBuffer:n=!1,alpha:i=!0,depth:r=!0,stencil:s=!1,antialias:o=!1,samples:a=0,getFallback:l=null,colorBufferType:c=ol,multiview:u=!1}=t;this.domElement=e.getDomElement(),this.backend=e,this.samples=a||!0===o?4:0,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.alpha=i,this.logarithmicDepthBuffer=n,this.outputColorSpace=ec,this.toneMapping=0,this.toneMappingExposure=1,this.sortObjects=!0,this.depth=r,this.stencil=s,this.info=new Ek,this.overrideNodes={modelViewMatrix:null,modelNormalViewMatrix:null},this.library=new PF,this.lighting=new IF,this._getFallback=l,this._pixelRatio=1,this._width=this.domElement.width,this._height=this.domElement.height,this._viewport=new nu(0,0,this._width,this._height),this._scissor=new nu(0,0,this._width,this._height),this._scissorTest=!1,this._attributes=null,this._geometries=null,this._nodes=null,this._animation=null,this._bindings=null,this._objects=null,this._pipelines=null,this._bundles=null,this._renderLists=null,this._renderContexts=null,this._textures=null,this._background=null,this._quad=new iO(new CD),this._quad.material.name="Renderer_output",this._currentRenderContext=null,this._opaqueSort=null,this._transparentSort=null,this._frameBufferTarget=null;const h=!0===this.alpha?0:1;this._clearColor=new Yk(0,0,0,h),this._clearDepth=1,this._clearStencil=0,this._renderTarget=null,this._activeCubeFace=0,this._activeMipmapLevel=0,this._outputRenderTarget=null,this._mrt=null,this._renderObjectFunction=null,this._currentRenderObjectFunction=null,this._currentRenderBundle=null,this._handleObjectFunction=this._renderObjectDirect,this._isDeviceLost=!1,this.onDeviceLost=this._onDeviceLost,this._colorBufferType=c,this._initialized=!1,this._initPromise=null,this._compilationPromises=null,this.transparent=!0,this.opaque=!0,this.shadowMap={enabled:!1,type:1},this.xr=new FF(this,u),this.debug={checkShaderErrors:!0,onShaderError:null,getShaderAsync:async(e,t,n)=>{await this.compileAsync(e,t);const i=this._renderLists.get(e,t),r=this._renderContexts.get(e,t,this._renderTarget),s=e.overrideMaterial||n.material,o=this._objects.get(n,s,e,t,i.lightsNode,r,r.clippingContext),{fragmentShader:a,vertexShader:l}=o.getNodeBuilderState();return{fragmentShader:a,vertexShader:l}}}}async init(){if(this._initialized)throw new Error("Renderer: Backend has already been initialized.");return null!==this._initPromise||(this._initPromise=new Promise((async(e,t)=>{let n=this.backend;try{await n.init(this)}catch(e){if(null===this._getFallback)return void t(e);try{this.backend=n=this._getFallback(e),await n.init(this)}catch(e){return void t(e)}}this._nodes=new MF(this,n),this._animation=new uk(this._nodes,this.info),this._attributes=new wk(n),this._background=new wU(this,this._nodes),this._geometries=new Mk(this._attributes,this.info),this._textures=new $k(this,n,this.info),this._pipelines=new Dk(n,this._nodes),this._bindings=new Lk(n,this._nodes,this._textures,this._attributes,this._pipelines,this.info),this._objects=new mk(this,this._nodes,this._geometries,this._pipelines,this._bindings,this.info),this._renderLists=new Bk(this.lighting),this._bundles=new NF,this._renderContexts=new qk,this._animation.start(),this._initialized=!0,e(this)}))),this._initPromise}get coordinateSystem(){return this.backend.coordinateSystem}async compileAsync(e,t,n=null){if(!0===this._isDeviceLost)return;!1===this._initialized&&await this.init();const i=this._nodes.nodeFrame,r=i.renderId,s=this._currentRenderContext,o=this._currentRenderObjectFunction,a=this._compilationPromises,l=!0===e.isScene?e:WF;null===n&&(n=e);const c=this._renderTarget,u=this._renderContexts.get(n,t,c),h=this._activeMipmapLevel,d=[];this._currentRenderContext=u,this._currentRenderObjectFunction=this.renderObject,this._handleObjectFunction=this._createObjectPipeline,this._compilationPromises=d,i.renderId++,i.update(),u.depth=this.depth,u.stencil=this.stencil,u.clippingContext||(u.clippingContext=new AF),u.clippingContext.updateGlobal(l,t),l.onBeforeRender(this,e,t,c);const p=this._renderLists.get(e,t);if(p.begin(),this._projectObject(e,t,0,p,u.clippingContext),n!==e&&n.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&p.pushLight(e)})),p.finish(),null!==c){this._textures.updateRenderTarget(c,h);const e=this._textures.get(c);u.textures=e.textures,u.depthTexture=e.depthTexture}else u.textures=null,u.depthTexture=null;this._background.update(l,p,u);const f=p.opaque,m=p.transparent,g=p.transparentDoublePass,y=p.lightsNode;!0===this.opaque&&f.length>0&&this._renderObjects(f,t,l,y),!0===this.transparent&&m.length>0&&this._renderTransparents(m,g,t,l,y),i.renderId=r,this._currentRenderContext=s,this._currentRenderObjectFunction=o,this._compilationPromises=a,this._handleObjectFunction=this._renderObjectDirect,await Promise.all(d)}async renderAsync(e,t){!1===this._initialized&&await this.init(),this._renderScene(e,t)}async waitForGPU(){await this.backend.waitForGPU()}set highPrecision(e){!0===e?(this.overrideNodes.modelViewMatrix=YR,this.overrideNodes.modelNormalViewMatrix=KR):this.highPrecision&&(this.overrideNodes.modelViewMatrix=null,this.overrideNodes.modelNormalViewMatrix=null)}get highPrecision(){return this.overrideNodes.modelViewMatrix===YR&&this.overrideNodes.modelNormalViewMatrix===KR}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}getColorBufferType(){return this._colorBufferType}_onDeviceLost(e){let t=`THREE.WebGPURenderer: ${e.api} Device Lost:\n\nMessage: ${e.message}`;e.reason&&(t+=`\nReason: ${e.reason}`),console.error(t),this._isDeviceLost=!0}_renderBundle(e,t,n){const{bundleGroup:i,camera:r,renderList:s}=e,o=this._currentRenderContext,a=this._bundles.get(i,r),l=this.backend.get(a);void 0===l.renderContexts&&(l.renderContexts=new Set);const c=i.version!==l.version,u=!1===l.renderContexts.has(o)||c;if(l.renderContexts.add(o),u){this.backend.beginBundle(o),(void 0===l.renderObjects||c)&&(l.renderObjects=[]),this._currentRenderBundle=a;const{transparentDoublePass:e,transparent:u,opaque:h}=s;!0===this.opaque&&h.length>0&&this._renderObjects(h,r,t,n),!0===this.transparent&&u.length>0&&this._renderTransparents(u,e,r,t,n),this._currentRenderBundle=null,this.backend.finishBundle(o,a),l.version=i.version}else{const{renderObjects:e}=l;for(let t=0,n=e.length;t<n;t++){const n=e[t];this._nodes.needsRefresh(n)&&(this._nodes.updateBefore(n),this._nodes.updateForRender(n),this._bindings.updateForRender(n),this._nodes.updateAfter(n))}}this.backend.addBundle(o,a)}render(e,t){if(!1===this._initialized)return console.warn("THREE.Renderer: .render() called before the backend is initialized. Try using .renderAsync() instead."),this.renderAsync(e,t);this._renderScene(e,t)}_getFrameBufferTarget(){const{currentToneMapping:e,currentColorSpace:t}=this;if(!1===(0!==e)&&!1===(t!==tc))return null;const{width:n,height:i}=this.getDrawingBufferSize(qF),{depth:r,stencil:s}=this;let o=this._frameBufferTarget;null===o&&(o=new iu(n,i,{depthBuffer:r,stencilBuffer:s,type:this._colorBufferType,format:pl,colorSpace:tc,generateMipmaps:!1,minFilter:Ka,magFilter:Ka,samples:this.samples}),o.isPostProcessingRenderTarget=!0,this._frameBufferTarget=o);const a=this.getOutputRenderTarget();return o.depthBuffer=r,o.stencilBuffer=s,null!==a?o.setSize(a.width,a.height,a.depth):o.setSize(n,i,1),o.viewport.copy(this._viewport),o.scissor.copy(this._scissor),o.viewport.multiplyScalar(this._pixelRatio),o.scissor.multiplyScalar(this._pixelRatio),o.scissorTest=this._scissorTest,o.multiview=null!==a&&a.multiview,o.resolveDepthBuffer=null===a||a.resolveDepthBuffer,o.autoAllocateDepthBuffer=null!==a&&a.autoAllocateDepthBuffer,o}_renderScene(e,t,n=!0){if(!0===this._isDeviceLost)return;const i=n?this._getFrameBufferTarget():null,r=this._nodes.nodeFrame,s=r.renderId,o=this._currentRenderContext,a=this._currentRenderObjectFunction,l=!0===e.isScene?e:WF,c=this._renderTarget||this._outputRenderTarget,u=this._activeCubeFace,h=this._activeMipmapLevel;let d;null!==i?(d=i,this.setRenderTarget(d)):d=c;const p=this._renderContexts.get(e,t,d);this._currentRenderContext=p,this._currentRenderObjectFunction=this._renderObjectFunction||this.renderObject,this.info.calls++,this.info.render.calls++,this.info.render.frameCalls++,r.renderId=this.info.calls;const f=this.coordinateSystem,m=this.xr;if(t.coordinateSystem!==f&&!1===m.isPresenting&&(t.coordinateSystem=f,t.updateProjectionMatrix(),t.isArrayCamera))for(const e of t.cameras)e.coordinateSystem=f,e.updateProjectionMatrix();!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===m.enabled&&!0===m.isPresenting&&(!0===m.cameraAutoUpdate&&m.updateCamera(t),t=m.getCamera());let g=this._viewport,y=this._scissor,v=this._pixelRatio;null!==d&&(g=d.viewport,y=d.scissor,v=1),this.getDrawingBufferSize(qF),XF.set(0,0,qF.width,qF.height);const _=void 0===g.minDepth?0:g.minDepth,x=void 0===g.maxDepth?1:g.maxDepth;p.viewportValue.copy(g).multiplyScalar(v).floor(),p.viewportValue.width>>=h,p.viewportValue.height>>=h,p.viewportValue.minDepth=_,p.viewportValue.maxDepth=x,p.viewport=!1===p.viewportValue.equals(XF),p.scissorValue.copy(y).multiplyScalar(v).floor(),p.scissor=this._scissorTest&&!1===p.scissorValue.equals(XF),p.scissorValue.width>>=h,p.scissorValue.height>>=h,p.clippingContext||(p.clippingContext=new AF),p.clippingContext.updateGlobal(l,t),l.onBeforeRender(this,e,t,d);const b=t.isArrayCamera?YF:$F;t.isArrayCamera||(KF.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),b.setFromProjectionMatrix(KF,f));const w=this._renderLists.get(e,t);if(w.begin(),this._projectObject(e,t,0,w,p.clippingContext),w.finish(),!0===this.sortObjects&&w.sort(this._opaqueSort,this._transparentSort),null!==d){this._textures.updateRenderTarget(d,h);const e=this._textures.get(d);p.textures=e.textures,p.depthTexture=e.depthTexture,p.width=e.width,p.height=e.height,p.renderTarget=d,p.depth=d.depthBuffer,p.stencil=d.stencilBuffer}else p.textures=null,p.depthTexture=null,p.width=this.domElement.width,p.height=this.domElement.height,p.depth=this.depth,p.stencil=this.stencil;p.width>>=h,p.height>>=h,p.activeCubeFace=u,p.activeMipmapLevel=h,p.occlusionQueryCount=w.occlusionQueryCount,this._background.update(l,w,p),p.camera=t,this.backend.beginRender(p);const{bundles:T,lightsNode:S,transparentDoublePass:M,transparent:E,opaque:A}=w;return T.length>0&&this._renderBundles(T,l,S),!0===this.opaque&&A.length>0&&this._renderObjects(A,t,l,S),!0===this.transparent&&E.length>0&&this._renderTransparents(E,M,t,l,S),this.backend.finishRender(p),r.renderId=s,this._currentRenderContext=o,this._currentRenderObjectFunction=a,null!==i&&(this.setRenderTarget(c,u,h),this._renderOutput(d)),l.onAfterRender(this,e,t,d),p}_setXRLayerSize(e,t){this._width=e,this._height=t,this.setViewport(0,0,e,t)}_renderOutput(e){const t=this._quad;this._nodes.hasOutputChange(e.texture)&&(t.material.fragmentNode=this._nodes.getOutputNode(e.texture),t.material.needsUpdate=!0);const n=this.autoClear,i=this.xr.enabled;this.autoClear=!1,this.xr.enabled=!1,this._renderScene(t,t.camera,!1),this.autoClear=n,this.xr.enabled=i}getMaxAnisotropy(){return this.backend.getMaxAnisotropy()}getActiveCubeFace(){return this._activeCubeFace}getActiveMipmapLevel(){return this._activeMipmapLevel}async setAnimationLoop(e){!1===this._initialized&&await this.init(),this._animation.setAnimationLoop(e)}async getArrayBufferAsync(e){return await this.backend.getArrayBufferAsync(e)}getContext(){return this.backend.getContext()}getPixelRatio(){return this._pixelRatio}getDrawingBufferSize(e){return e.set(this._width*this._pixelRatio,this._height*this._pixelRatio).floor()}getSize(e){return e.set(this._width,this._height)}setPixelRatio(e=1){this._pixelRatio!==e&&(this._pixelRatio=e,this.setSize(this._width,this._height,!1))}setDrawingBufferSize(e,t,n){this.xr&&this.xr.isPresenting||(this._width=e,this._height=t,this._pixelRatio=n,this.domElement.width=Math.floor(e*n),this.domElement.height=Math.floor(t*n),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize())}setSize(e,t,n=!0){this.xr&&this.xr.isPresenting||(this._width=e,this._height=t,this.domElement.width=Math.floor(e*this._pixelRatio),this.domElement.height=Math.floor(t*this._pixelRatio),!0===n&&(this.domElement.style.width=e+"px",this.domElement.style.height=t+"px"),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize())}setOpaqueSort(e){this._opaqueSort=e}setTransparentSort(e){this._transparentSort=e}getScissor(e){const t=this._scissor;return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e}setScissor(e,t,n,i){const r=this._scissor;e.isVector4?r.copy(e):r.set(e,t,n,i)}getScissorTest(){return this._scissorTest}setScissorTest(e){this._scissorTest=e,this.backend.setScissorTest(e)}getViewport(e){return e.copy(this._viewport)}setViewport(e,t,n,i,r=0,s=1){const o=this._viewport;e.isVector4?o.copy(e):o.set(e,t,n,i),o.minDepth=r,o.maxDepth=s}getClearColor(e){return e.copy(this._clearColor)}setClearColor(e,t=1){this._clearColor.set(e),this._clearColor.a=t}getClearAlpha(){return this._clearColor.a}setClearAlpha(e){this._clearColor.a=e}getClearDepth(){return this._clearDepth}setClearDepth(e){this._clearDepth=e}getClearStencil(){return this._clearStencil}setClearStencil(e){this._clearStencil=e}isOccluded(e){const t=this._currentRenderContext;return t&&this.backend.isOccluded(t,e)}clear(e=!0,t=!0,n=!0){if(!1===this._initialized)return console.warn("THREE.Renderer: .clear() called before the backend is initialized. Try using .clearAsync() instead."),this.clearAsync(e,t,n);const i=this._renderTarget||this._getFrameBufferTarget();let r=null;if(null!==i){this._textures.updateRenderTarget(i);const e=this._textures.get(i);r=this._renderContexts.getForClear(i),r.textures=e.textures,r.depthTexture=e.depthTexture,r.width=e.width,r.height=e.height,r.renderTarget=i,r.depth=i.depthBuffer,r.stencil=i.stencilBuffer,r.clearColorValue=this.backend.getClearColor(),r.activeCubeFace=this.getActiveCubeFace(),r.activeMipmapLevel=this.getActiveMipmapLevel()}this.backend.clear(e,t,n,r),null!==i&&null===this._renderTarget&&this._renderOutput(i)}clearColor(){return this.clear(!0,!1,!1)}clearDepth(){return this.clear(!1,!0,!1)}clearStencil(){return this.clear(!1,!1,!0)}async clearAsync(e=!0,t=!0,n=!0){!1===this._initialized&&await this.init(),this.clear(e,t,n)}async clearColorAsync(){this.clearAsync(!0,!1,!1)}async clearDepthAsync(){this.clearAsync(!1,!0,!1)}async clearStencilAsync(){this.clearAsync(!1,!1,!0)}get currentToneMapping(){return this.isOutputTarget?this.toneMapping:0}get currentColorSpace(){return this.isOutputTarget?this.outputColorSpace:tc}get isOutputTarget(){return this._renderTarget===this._outputRenderTarget||null===this._renderTarget}dispose(){this.info.dispose(),this.backend.dispose(),this._animation.dispose(),this._objects.dispose(),this._pipelines.dispose(),this._nodes.dispose(),this._bindings.dispose(),this._renderLists.dispose(),this._renderContexts.dispose(),this._textures.dispose(),null!==this._frameBufferTarget&&this._frameBufferTarget.dispose(),Object.values(this.backend.timestampQueryPool).forEach((e=>{null!==e&&e.dispose()})),this.setRenderTarget(null),this.setAnimationLoop(null)}setRenderTarget(e,t=0,n=0){this._renderTarget=e,this._activeCubeFace=t,this._activeMipmapLevel=n}getRenderTarget(){return this._renderTarget}setOutputRenderTarget(e){this._outputRenderTarget=e}getOutputRenderTarget(){return this._outputRenderTarget}_resetXRState(){this.backend.setXRTarget(null),this.setOutputRenderTarget(null),this.setRenderTarget(null),this._frameBufferTarget.dispose(),this._frameBufferTarget=null}setRenderObjectFunction(e){this._renderObjectFunction=e}getRenderObjectFunction(){return this._renderObjectFunction}compute(e){if(!0===this._isDeviceLost)return;if(!1===this._initialized)return console.warn("THREE.Renderer: .compute() called before the backend is initialized. Try using .computeAsync() instead."),this.computeAsync(e);const t=this._nodes.nodeFrame,n=t.renderId;this.info.calls++,this.info.compute.calls++,this.info.compute.frameCalls++,t.renderId=this.info.calls;const i=this.backend,r=this._pipelines,s=this._bindings,o=this._nodes,a=Array.isArray(e)?e:[e];if(void 0===a[0]||!0!==a[0].isComputeNode)throw new Error("THREE.Renderer: .compute() expects a ComputeNode.");i.beginCompute(e);for(const t of a){if(!1===r.has(t)){const e=()=>{t.removeEventListener("dispose",e),r.delete(t),s.delete(t),o.delete(t)};t.addEventListener("dispose",e);const n=t.onInitFunction;null!==n&&n.call(t,{renderer:this})}o.updateForCompute(t),s.updateForCompute(t);const n=s.getForCompute(t),a=r.getForCompute(t,n);i.compute(e,t,n,a)}i.finishCompute(e),t.renderId=n}async computeAsync(e){!1===this._initialized&&await this.init(),this.compute(e)}async hasFeatureAsync(e){return!1===this._initialized&&await this.init(),this.backend.hasFeature(e)}async resolveTimestampsAsync(e="render"){return!1===this._initialized&&await this.init(),this.backend.resolveTimestampsAsync(e)}hasFeature(e){return!1===this._initialized?(console.warn("THREE.Renderer: .hasFeature() called before the backend is initialized. Try using .hasFeatureAsync() instead."),!1):this.backend.hasFeature(e)}hasInitialized(){return this._initialized}async initTextureAsync(e){!1===this._initialized&&await this.init(),this._textures.updateTexture(e)}initTexture(e){!1===this._initialized&&console.warn("THREE.Renderer: .initTexture() called before the backend is initialized. Try using .initTextureAsync() instead."),this._textures.updateTexture(e)}copyFramebufferToTexture(e,t=null){if(null!==t)if(t.isVector2)t=ZF.set(t.x,t.y,e.image.width,e.image.height).floor();else{if(!t.isVector4)return void console.error("THREE.Renderer.copyFramebufferToTexture: Invalid rectangle.");t=ZF.copy(t).floor()}else t=ZF.set(0,0,e.image.width,e.image.height);let n,i=this._currentRenderContext;null!==i?n=i.renderTarget:(n=this._renderTarget||this._getFrameBufferTarget(),null!==n&&(this._textures.updateRenderTarget(n),i=this._textures.get(n))),this._textures.updateTexture(e,{renderTarget:n}),this.backend.copyFramebufferToTexture(e,i,t)}copyTextureToTexture(e,t,n=null,i=null,r=0,s=0){this._textures.updateTexture(e),this._textures.updateTexture(t),this.backend.copyTextureToTexture(e,t,n,i,r,s)}async readRenderTargetPixelsAsync(e,t,n,i,r,s=0,o=0){return this.backend.copyTextureToBuffer(e.textures[s],t,n,i,r,o)}_projectObject(e,t,n,i,r){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)n=e.renderOrder,e.isClippingGroup&&e.enabled&&(r=r.getGroupContext(e));else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)i.pushLight(e);else if(e.isSprite){const s=t.isArrayCamera?YF:$F;if(!e.frustumCulled||s.intersectsSprite(e,t)){!0===this.sortObjects&&ZF.setFromMatrixPosition(e.matrixWorld).applyMatrix4(KF);const{geometry:t,material:s}=e;s.visible&&i.push(e,t,s,n,ZF.z,null,r)}}else if(e.isLineLoop)console.error("THREE.Renderer: Objects of type THREE.LineLoop are not supported. Please use THREE.Line or THREE.LineSegments.");else if(e.isMesh||e.isLine||e.isPoints){const s=t.isArrayCamera?YF:$F;if(!e.frustumCulled||s.intersectsObject(e,t)){const{geometry:t,material:s}=e;if(!0===this.sortObjects&&(null===t.boundingSphere&&t.computeBoundingSphere(),ZF.copy(t.boundingSphere.center).applyMatrix4(e.matrixWorld).applyMatrix4(KF)),Array.isArray(s)){const o=t.groups;for(let a=0,l=o.length;a<l;a++){const l=o[a],c=s[l.materialIndex];c&&c.visible&&i.push(e,t,c,n,ZF.z,l,r)}}else s.visible&&i.push(e,t,s,n,ZF.z,null,r)}}if(!0===e.isBundleGroup&&void 0!==this.backend.beginBundle){const n=i;(i=this._renderLists.get(e,t)).begin(),n.pushBundle({bundleGroup:e,camera:t,renderList:i}),i.finish()}const s=e.children;for(let e=0,o=s.length;e<o;e++)this._projectObject(s[e],t,n,i,r)}_renderBundles(e,t,n){for(const i of e)this._renderBundle(i,t,n)}_renderTransparents(e,t,n,i,r){if(t.length>0){for(const{material:e}of t)e.side=1;this._renderObjects(t,n,i,r,"backSide");for(const{material:e}of t)e.side=0;this._renderObjects(e,n,i,r);for(const{material:e}of t)e.side=2}else this._renderObjects(e,n,i,r)}_renderObjects(e,t,n,i,r=null){for(let s=0,o=e.length;s<o;s++){const{object:o,geometry:a,material:l,group:c,clippingContext:u}=e[s];this._currentRenderObjectFunction(o,n,t,a,l,c,i,u,r)}}renderObject(e,t,n,i,r,s,o,a=null,l=null){let c,u,h;if(e.onBeforeRender(this,t,n,i,r,s),!0===r.allowOverride&&null!==t.overrideMaterial){const e=t.overrideMaterial;r.positionNode&&r.positionNode.isNode&&(c=e.positionNode,e.positionNode=r.positionNode),e.alphaTest=r.alphaTest,e.alphaMap=r.alphaMap,e.transparent=r.transparent||r.transmission>0,e.isShadowPassMaterial&&(e.side=null===r.shadowSide?r.side:r.shadowSide,r.depthNode&&r.depthNode.isNode&&(h=e.depthNode,e.depthNode=r.depthNode),r.castShadowNode&&r.castShadowNode.isNode&&(u=e.colorNode,e.colorNode=r.castShadowNode),r.castShadowPositionNode&&r.castShadowPositionNode.isNode&&(c=e.positionNode,e.positionNode=r.castShadowPositionNode)),r=e}!0===r.transparent&&2===r.side&&!1===r.forceSinglePass?(r.side=1,this._handleObjectFunction(e,r,t,n,o,s,a,"backSide"),r.side=0,this._handleObjectFunction(e,r,t,n,o,s,a,l),r.side=2):this._handleObjectFunction(e,r,t,n,o,s,a,l),void 0!==c&&(t.overrideMaterial.positionNode=c),void 0!==h&&(t.overrideMaterial.depthNode=h),void 0!==u&&(t.overrideMaterial.colorNode=u),e.onAfterRender(this,t,n,i,r,s)}_renderObjectDirect(e,t,n,i,r,s,o,a){const l=this._objects.get(e,t,n,i,r,this._currentRenderContext,o,a);l.drawRange=e.geometry.drawRange,l.group=s;const c=this._nodes.needsRefresh(l);if(c&&(this._nodes.updateBefore(l),this._geometries.updateForRender(l),this._nodes.updateForRender(l),this._bindings.updateForRender(l)),this._pipelines.updateForRender(l),null!==this._currentRenderBundle){this.backend.get(this._currentRenderBundle).renderObjects.push(l),l.bundle=this._currentRenderBundle.bundleGroup}this.backend.draw(l,this.info),c&&this._nodes.updateAfter(l)}_createObjectPipeline(e,t,n,i,r,s,o,a){const l=this._objects.get(e,t,n,i,r,this._currentRenderContext,o,a);l.drawRange=e.geometry.drawRange,l.group=s,this._nodes.updateBefore(l),this._geometries.updateForRender(l),this._nodes.updateForRender(l),this._bindings.updateForRender(l),this._pipelines.getForRender(l,this._compilationPromises),this._nodes.updateAfter(l)}get compile(){return this.compileAsync}}class QF{constructor(e=""){this.name=e,this.visibility=0}setVisibility(e){this.visibility|=e}clone(){return Object.assign(new this.constructor,this)}}class eB extends QF{constructor(e,t=null){super(e),this.isBuffer=!0,this.bytesPerElement=Float32Array.BYTES_PER_ELEMENT,this._buffer=t}get byteLength(){return(e=this._buffer.byteLength)+(bk-e%bk)%bk;var e}get buffer(){return this._buffer}update(){return!0}}class tB extends eB{constructor(e,t=null){super(e,t),this.isUniformBuffer=!0}}let nB=0;class iB extends tB{constructor(e,t){super("UniformBuffer_"+nB++,e?e.value:null),this.nodeUniform=e,this.groupNode=t}get buffer(){return this.nodeUniform.value}}class rB extends tB{constructor(e){super(e),this.isUniformsGroup=!0,this._values=null,this.uniforms=[]}addUniform(e){return this.uniforms.push(e),this}removeUniform(e){const t=this.uniforms.indexOf(e);return-1!==t&&this.uniforms.splice(t,1),this}get values(){return null===this._values&&(this._values=Array.from(this.buffer)),this._values}get buffer(){let e=this._buffer;if(null===e){const t=this.byteLength;e=new Float32Array(new ArrayBuffer(t)),this._buffer=e}return e}get byteLength(){const e=this.bytesPerElement;let t=0;for(let n=0,i=this.uniforms.length;n<i;n++){const i=this.uniforms[n],r=i.boundary,s=i.itemSize*e,o=t%bk,a=o%r,l=o+a;t+=a,0!==l&&bk-l<s&&(t+=bk-l),i.offset=t/e,t+=s}return Math.ceil(t/bk)*bk}update(){let e=!1;for(const t of this.uniforms)!0===this.updateByType(t)&&(e=!0);return e}updateByType(e){return e.isNumberUniform?this.updateNumber(e):e.isVector2Uniform?this.updateVector2(e):e.isVector3Uniform?this.updateVector3(e):e.isVector4Uniform?this.updateVector4(e):e.isColorUniform?this.updateColor(e):e.isMatrix3Uniform?this.updateMatrix3(e):e.isMatrix4Uniform?this.updateMatrix4(e):void console.error("THREE.WebGPUUniformsGroup: Unsupported uniform type.",e)}updateNumber(e){let t=!1;const n=this.values,i=e.getValue(),r=e.offset,s=e.getType();if(n[r]!==i){this._getBufferForType(s)[r]=n[r]=i,t=!0}return t}updateVector2(e){let t=!1;const n=this.values,i=e.getValue(),r=e.offset,s=e.getType();if(n[r+0]!==i.x||n[r+1]!==i.y){const e=this._getBufferForType(s);e[r+0]=n[r+0]=i.x,e[r+1]=n[r+1]=i.y,t=!0}return t}updateVector3(e){let t=!1;const n=this.values,i=e.getValue(),r=e.offset,s=e.getType();if(n[r+0]!==i.x||n[r+1]!==i.y||n[r+2]!==i.z){const e=this._getBufferForType(s);e[r+0]=n[r+0]=i.x,e[r+1]=n[r+1]=i.y,e[r+2]=n[r+2]=i.z,t=!0}return t}updateVector4(e){let t=!1;const n=this.values,i=e.getValue(),r=e.offset,s=e.getType();if(n[r+0]!==i.x||n[r+1]!==i.y||n[r+2]!==i.z||n[r+4]!==i.w){const e=this._getBufferForType(s);e[r+0]=n[r+0]=i.x,e[r+1]=n[r+1]=i.y,e[r+2]=n[r+2]=i.z,e[r+3]=n[r+3]=i.w,t=!0}return t}updateColor(e){let t=!1;const n=this.values,i=e.getValue(),r=e.offset;if(n[r+0]!==i.r||n[r+1]!==i.g||n[r+2]!==i.b){const e=this.buffer;e[r+0]=n[r+0]=i.r,e[r+1]=n[r+1]=i.g,e[r+2]=n[r+2]=i.b,t=!0}return t}updateMatrix3(e){let t=!1;const n=this.values,i=e.getValue().elements,r=e.offset;if(n[r+0]!==i[0]||n[r+1]!==i[1]||n[r+2]!==i[2]||n[r+4]!==i[3]||n[r+5]!==i[4]||n[r+6]!==i[5]||n[r+8]!==i[6]||n[r+9]!==i[7]||n[r+10]!==i[8]){const e=this.buffer;e[r+0]=n[r+0]=i[0],e[r+1]=n[r+1]=i[1],e[r+2]=n[r+2]=i[2],e[r+4]=n[r+4]=i[3],e[r+5]=n[r+5]=i[4],e[r+6]=n[r+6]=i[5],e[r+8]=n[r+8]=i[6],e[r+9]=n[r+9]=i[7],e[r+10]=n[r+10]=i[8],t=!0}return t}updateMatrix4(e){let t=!1;const n=this.values,i=e.getValue().elements,r=e.offset;if(!1===function(e,t,n){for(let i=0,r=t.length;i<r;i++)if(e[n+i]!==t[i])return!1;return!0}(n,i,r)){this.buffer.set(i,r),function(e,t,n){for(let i=0,r=t.length;i<r;i++)e[n+i]=t[i]}(n,i,r),t=!0}return t}_getBufferForType(e){return"int"===e||"ivec2"===e||"ivec3"===e||"ivec4"===e?new Int32Array(this.buffer.buffer):"uint"===e||"uvec2"===e||"uvec3"===e||"uvec4"===e?new Uint32Array(this.buffer.buffer):this.buffer}}let sB=0;class oB extends rB{constructor(e,t){super(e),this.id=sB++,this.groupNode=t,this.isNodeUniformsGroup=!0}}let aB=0;class lB extends QF{constructor(e,t){super(e),this.id=aB++,this.texture=t,this.version=t?t.version:0,this.store=!1,this.generation=null,this.isSampledTexture=!0}needsBindingsUpdate(e){const{texture:t}=this;return e!==this.generation?(this.generation=e,!0):t.isVideoTexture}update(){const{texture:e,version:t}=this;return t!==e.version&&(this.version=e.version,!0)}}class cB extends lB{constructor(e,t,n,i=null){super(e,t?t.value:null),this.textureNode=t,this.groupNode=n,this.access=i}needsBindingsUpdate(e){return this.textureNode.value!==this.texture||super.needsBindingsUpdate(e)}update(){const{textureNode:e}=this;return this.texture!==e.value?(this.texture=e.value,!0):super.update()}}class uB extends cB{constructor(e,t,n,i=null){super(e,t,n,i),this.isSampledCubeTexture=!0}}class hB extends cB{constructor(e,t,n,i=null){super(e,t,n,i),this.isSampledTexture3D=!0}}const dB={textureDimensions:"textureSize",equals:"equal"},pB={low:"lowp",medium:"mediump",high:"highp"},fB={swizzleAssign:!0,storageBuffer:!1},mB={perspective:"smooth",linear:"noperspective"},gB={centroid:"centroid","flat first":"flat","flat either":"flat"},yB="\nprecision highp float;\nprecision highp int;\nprecision highp sampler2D;\nprecision highp sampler3D;\nprecision highp samplerCube;\nprecision highp sampler2DArray;\n\nprecision highp usampler2D;\nprecision highp usampler3D;\nprecision highp usamplerCube;\nprecision highp usampler2DArray;\n\nprecision highp isampler2D;\nprecision highp isampler3D;\nprecision highp isamplerCube;\nprecision highp isampler2DArray;\n\nprecision lowp sampler2DShadow;\nprecision lowp sampler2DArrayShadow;\nprecision lowp samplerCubeShadow;\n";class vB extends eF{constructor(e,t){super(e,t,new bF),this.uniformGroups={},this.transforms=[],this.extensions={},this.builtins={vertex:[],fragment:[],compute:[]}}needsToWorkingColorSpace(e){return!0===e.isVideoTexture&&e.colorSpace!==Ql}getMethod(e){return dB[e]||e}getOutputStructName(){return""}buildFunctionCode(e){const t=e.layout,n=this.flowShaderNode(e),i=[];for(const e of t.inputs)i.push(this.getType(e.type)+" "+e.name);return`${this.getType(t.type)} ${t.name}( ${i.join(", ")} ) {\n\n\t${n.vars}\n\n${n.code}\n\treturn ${n.result};\n\n}`}setupPBO(e){const t=e.value;if(void 0===t.pbo){const e=t.array,n=t.count*t.itemSize,{itemSize:i}=t,r=t.array.constructor.name.toLowerCase().includes("int");let s=r?yl:gl;2===i?s=r?_l:vl:3===i?s=r?1032:dl:4===i&&(s=r?xl:pl);const o={Float32Array:sl,Uint8Array:Qa,Uint16Array:nl,Uint32Array:rl,Int8Array:el,Int16Array:tl,Int32Array:il,Uint8ClampedArray:Qa},a=Math.pow(2,Math.ceil(Math.log2(Math.sqrt(n/i))));let l=Math.ceil(n/i/a);a*l*i<n&&l++;const c=a*l*i,u=new e.constructor(c);u.set(e,0),t.array=u;const h=new Ld(t.array,a,l,s,o[t.array.constructor.name]||sl);h.needsUpdate=!0,h.isPBOTexture=!0;const d=new MR(h,null,null);d.setPrecision("high"),t.pboNode=d,t.pbo=d.value,this.getUniformFromNode(t.pboNode,"texture",this.shaderStage,this.context.label)}}getPropertyName(e,t=this.shaderStage){return e.isNodeUniform&&!0!==e.node.isTextureNode&&!0!==e.node.isBufferNode?t.charAt(0)+"_"+e.name:super.getPropertyName(e,t)}generatePBO(e){const{node:t,indexNode:n}=e,i=t.value;if(this.renderer.backend.has(i)){this.renderer.backend.get(i).pbo=i.pbo}const r=this.getUniformFromNode(i.pboNode,"texture",this.shaderStage,this.context.label),s=this.getPropertyName(r);this.increaseUsage(n);const o=n.build(this,"uint"),a=this.getDataFromNode(e);let l=a.propertyName;if(void 0===l){const n=this.getVarFromNode(e);l=this.getPropertyName(n);const r=this.getDataFromNode(t);let c=r.propertySizeName;void 0===c&&(c=l+"Size",this.getVarFromNode(t,c,"uint"),this.addLineFlowCode(`${c} = uint( textureSize( ${s}, 0 ).x )`,e),r.propertySizeName=c);const{itemSize:u}=i,h="."+eM.join("").slice(0,u),d=`ivec2(${o} % ${c}, ${o} / ${c})`,p=this.generateTextureLoad(null,s,d,null,"0");let f="vec4";i.pbo.type===rl?f="uvec4":i.pbo.type===il&&(f="ivec4"),this.addLineFlowCode(`${l} = ${f}(${p})${h}`,e),a.propertyName=l}return l}generateTextureLoad(e,t,n,i,r="0"){return i?`texelFetch( ${t}, ivec3( ${n}, ${i} ), ${r} )`:`texelFetch( ${t}, ${n}, ${r} )`}generateTexture(e,t,n,i){return e.isDepthTexture?(i&&(n=`vec4( ${n}, ${i} )`),`texture( ${t}, ${n} ).x`):(i&&(n=`vec3( ${n}, ${i} )`),`texture( ${t}, ${n} )`)}generateTextureLevel(e,t,n,i){return`textureLod( ${t}, ${n}, ${i} )`}generateTextureBias(e,t,n,i){return`texture( ${t}, ${n}, ${i} )`}generateTextureGrad(e,t,n,i){return`textureGrad( ${t}, ${n}, ${i[0]}, ${i[1]} )`}generateTextureCompare(e,t,n,i,r,s=this.shaderStage){if("fragment"===s)return r?`texture( ${t}, vec4( ${n}, ${r}, ${i} ) )`:`texture( ${t}, vec3( ${n}, ${i} ) )`;console.error(`WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ${s} shader.`)}getVars(e){const t=[],n=this.vars[e];if(void 0!==n)for(const e of n)t.push(`${this.getVar(e.type,e.name,e.count)};`);return t.join("\n\t")}getUniforms(e){const t=this.uniforms[e],n=[],i={};for(const r of t){let t=null,s=!1;if("texture"===r.type||"texture3D"===r.type){const e=r.node.value;let n="";!0!==e.isDataTexture&&!0!==e.isData3DTexture||(e.type===rl?n="u":e.type===il&&(n="i")),t="texture3D"===r.type&&!1===e.isArrayTexture?`${n}sampler3D ${r.name};`:e.compareFunction?!0===e.isArrayTexture?`sampler2DArrayShadow ${r.name};`:`sampler2DShadow ${r.name};`:!0===e.isArrayTexture||!0===e.isDataArrayTexture||!0===e.isCompressedArrayTexture?`${n}sampler2DArray ${r.name};`:`${n}sampler2D ${r.name};`}else if("cubeTexture"===r.type)t=`samplerCube ${r.name};`;else if("buffer"===r.type){const e=r.node,n=this.getType(e.bufferType),i=e.bufferCount,s=i>0?i:"";t=`${e.name} {\n\t${n} ${r.name}[${s}];\n};\n`}else{t=`${this.getVectorType(r.type)} ${this.getPropertyName(r,e)};`,s=!0}const o=r.node.precision;if(null!==o&&(t=pB[o]+" "+t),s){t="\t"+t;const e=r.groupNode.name;(i[e]||(i[e]=[])).push(t)}else t="uniform "+t,n.push(t)}let r="";for(const t in i){const n=i[t];r+=this._getGLSLUniformStruct(e+"_"+t,n.join("\n"))+"\n"}return r+=n.join("\n"),r}getTypeFromAttribute(e){let t=super.getTypeFromAttribute(e);if(/^[iu]/.test(t)&&e.gpuType!==il){let n=e;e.isInterleavedBufferAttribute&&(n=e.data);const i=n.array;!1==(i instanceof Uint32Array||i instanceof Int32Array)&&(t=t.slice(1))}return t}getAttributes(e){let t="";if("vertex"===e||"compute"===e){const e=this.getAttributesArray();let n=0;for(const i of e)t+=`layout( location = ${n++} ) in ${i.type} ${i.name};\n`}return t}getStructMembers(e){const t=[];for(const n of e.members)t.push(`\t${n.type} ${n.name};`);return t.join("\n")}getStructs(e){const t=[],n=this.structs[e],i=[];for(const e of n)if(e.output)for(const t of e.members)i.push(`layout( location = ${t.index} ) out ${t.type} ${t.name};`);else{let n="struct "+e.name+" {\n";n+=this.getStructMembers(e),n+="\n};\n",t.push(n)}return 0===i.length&&i.push("layout( location = 0 ) out vec4 fragColor;"),"\n"+i.join("\n")+"\n\n"+t.join("\n")}getVaryings(e){let t="";const n=this.varyings;if("vertex"===e||"compute"===e)for(const i of n){"compute"===e&&(i.needsInterpolation=!0);const n=this.getType(i.type);if(i.needsInterpolation)if(i.interpolationType){t+=`${mB[i.interpolationType]||i.interpolationType} ${gB[i.interpolationSampling]||""} out ${n} ${i.name};\n`}else{t+=`${n.includes("int")||n.includes("uv")||n.includes("iv")?"flat ":""}out ${n} ${i.name};\n`}else t+=`${n} ${i.name};\n`}else if("fragment"===e)for(const e of n)if(e.needsInterpolation){const n=this.getType(e.type);if(e.interpolationType){t+=`${mB[e.interpolationType]||e.interpolationType} ${gB[e.interpolationSampling]||""} in ${n} ${e.name};\n`}else{t+=`${n.includes("int")||n.includes("uv")||n.includes("iv")?"flat ":""}in ${n} ${e.name};\n`}}for(const n of this.builtins[e])t+=`${n};\n`;return t}getVertexIndex(){return"uint( gl_VertexID )"}getInstanceIndex(){return"uint( gl_InstanceID )"}getInvocationLocalIndex(){return`uint( gl_InstanceID ) % ${this.object.workgroupSize.reduce(((e,t)=>e*t),1)}u`}getDrawIndex(){return this.renderer.backend.extensions.has("WEBGL_multi_draw")?"uint( gl_DrawID )":null}getFrontFacing(){return"gl_FrontFacing"}getFragCoord(){return"gl_FragCoord.xy"}getFragDepth(){return"gl_FragDepth"}enableExtension(e,t,n=this.shaderStage){const i=this.extensions[n]||(this.extensions[n]=new Map);!1===i.has(e)&&i.set(e,{name:e,behavior:t})}getExtensions(e){const t=[];if("vertex"===e){const t=this.renderer.backend.extensions;this.object.isBatchedMesh&&t.has("WEBGL_multi_draw")&&this.enableExtension("GL_ANGLE_multi_draw","require",e)}const n=this.extensions[e];if(void 0!==n)for(const{name:e,behavior:i}of n.values())t.push(`#extension ${e} : ${i}`);return t.join("\n")}getClipDistance(){return"gl_ClipDistance"}isAvailable(e){let t=fB[e];if(void 0===t){let n;switch(t=!1,e){case"float32Filterable":n="OES_texture_float_linear";break;case"clipDistance":n="WEBGL_clip_cull_distance"}if(void 0!==n){const e=this.renderer.backend.extensions;e.has(n)&&(e.get(n),t=!0)}fB[e]=t}return t}isFlipY(){return!0}enableHardwareClipping(e){this.enableExtension("GL_ANGLE_clip_cull_distance","require"),this.builtins.vertex.push(`out float gl_ClipDistance[ ${e} ]`)}enableMultiview(){this.enableExtension("GL_OVR_multiview2","require","fragment"),this.enableExtension("GL_OVR_multiview2","require","vertex"),this.builtins.vertex.push("layout(num_views = 2) in")}registerTransform(e,t){this.transforms.push({varyingName:e,attributeNode:t})}getTransforms(){const e=this.transforms;let t="";for(let n=0;n<e.length;n++){const i=e[n],r=this.getPropertyName(i.attributeNode);r&&(t+=`${i.varyingName} = ${r};\n\t`)}return t}_getGLSLUniformStruct(e,t){return`\nlayout( std140 ) uniform ${e} {\n${t}\n};`}_getGLSLVertexCode(e){return`#version 300 es\n\n${this.getSignature()}\n\n// extensions\n${e.extensions}\n\n// precision\n${yB}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\n\n// attributes\n${e.attributes}\n\n// codes\n${e.codes}\n\nvoid main() {\n\n\t// vars\n\t${e.vars}\n\n\t// transforms\n\t${e.transforms}\n\n\t// flow\n\t${e.flow}\n\n\tgl_PointSize = 1.0;\n\n}\n`}_getGLSLFragmentCode(e){return`#version 300 es\n\n${this.getSignature()}\n\n// extensions\n${e.extensions}\n\n// precision\n${yB}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\n\n// codes\n${e.codes}\n\n// structs\n${e.structs}\n\nvoid main() {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}buildCode(){const e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};this.sortBindingGroups();for(const t in e){let n="// code\n\n";n+=this.flowCode[t];const i=this.flowNodes[t],r=i[i.length-1];for(const e of i){const i=this.getFlowData(e),s=e.name;s&&(n.length>0&&(n+="\n"),n+=`\t// flow -> ${s}\n\t`),n+=`${i.code}\n\t`,e===r&&"compute"!==t&&(n+="// result\n\t","vertex"===t?(n+="gl_Position = ",n+=`${i.result};`):"fragment"===t&&(e.outputNode.isOutputStructNode||(n+="fragColor = ",n+=`${i.result};`)))}const s=e[t];s.extensions=this.getExtensions(t),s.uniforms=this.getUniforms(t),s.attributes=this.getAttributes(t),s.varyings=this.getVaryings(t),s.vars=this.getVars(t),s.structs=this.getStructs(t),s.codes=this.getCodes(t),s.transforms=this.getTransforms(t),s.flow=n}null!==this.material?(this.vertexShader=this._getGLSLVertexCode(e.vertex),this.fragmentShader=this._getGLSLFragmentCode(e.fragment)):this.computeShader=this._getGLSLVertexCode(e.compute)}getUniformFromNode(e,t,n,i=null){const r=super.getUniformFromNode(e,t,n,i),s=this.getDataFromNode(e,n,this.globalCache);let o=s.uniformGPU;if(void 0===o){const i=e.groupNode,a=i.name,l=this.getBindGroupArray(a,n);if("texture"===t)o=new cB(r.name,r.node,i),l.push(o);else if("cubeTexture"===t)o=new uB(r.name,r.node,i),l.push(o);else if("texture3D"===t)o=new hB(r.name,r.node,i),l.push(o);else if("buffer"===t){e.name=`NodeBuffer_${e.id}`,r.name=`buffer${e.id}`;const t=new iB(e,i);t.name=e.name,l.push(t),o=t}else{const e=this.uniformGroups[n]||(this.uniformGroups[n]={});let s=e[a];void 0===s&&(s=new oB(n+"_"+a,i),e[a]=s,l.push(s)),o=this.getNodeUniform(r,t),s.addUniform(o)}s.uniformGPU=o}return r}}let _B=null,xB=null;class bB{constructor(e={}){this.parameters=Object.assign({},e),this.data=new WeakMap,this.renderer=null,this.domElement=null,this.timestampQueryPool={render:null,compute:null},this.trackTimestamp=!0===e.trackTimestamp}async init(e){this.renderer=e}get coordinateSystem(){}beginRender(){}finishRender(){}beginCompute(){}finishCompute(){}draw(){}compute(){}createProgram(){}destroyProgram(){}createBindings(){}updateBindings(){}updateBinding(){}createRenderPipeline(){}createComputePipeline(){}needsRenderUpdate(){}getRenderCacheKey(){}createNodeBuilder(){}createSampler(){}destroySampler(){}createDefaultTexture(){}createTexture(){}updateTexture(){}generateMipmaps(){}destroyTexture(){}async copyTextureToBuffer(){}copyTextureToTexture(){}copyFramebufferToTexture(){}createAttribute(){}createIndexAttribute(){}createStorageAttribute(){}updateAttribute(){}destroyAttribute(){}getContext(){}updateSize(){}updateViewport(){}isOccluded(){}async resolveTimestampsAsync(e="render"){if(!this.trackTimestamp)return void Vc("WebGPURenderer: Timestamp tracking is disabled.");const t=this.timestampQueryPool[e];if(!t)return void Vc(`WebGPURenderer: No timestamp query pool for type '${e}' found.`);const n=await t.resolveQueriesAsync();return this.renderer.info[e].timestamp=n,n}async waitForGPU(){}async getArrayBufferAsync(){}async hasFeatureAsync(){}hasFeature(){}getMaxAnisotropy(){}getDrawingBufferSize(){return _B=_B||new Nc,this.renderer.getDrawingBufferSize(_B)}setScissorTest(){}getClearColor(){const e=this.renderer;return xB=xB||new Yk,e.getClearColor(xB),xB.getRGB(xB),xB}getDomElement(){let e=this.domElement;return null===e&&(e=void 0!==this.parameters.canvas?this.parameters.canvas:Bc(),"setAttribute"in e&&e.setAttribute("data-engine",`three.js r${na} webgpu`),this.domElement=e),e}set(e,t){this.data.set(e,t)}get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}has(e){return this.data.has(e)}delete(e){this.data.delete(e)}dispose(){}}let wB,TB,SB=0;class MB{constructor(e,t){this.buffers=[e.bufferGPU,t],this.type=e.type,this.bufferType=e.bufferType,this.pbo=e.pbo,this.byteLength=e.byteLength,this.bytesPerElement=e.BYTES_PER_ELEMENT,this.version=e.version,this.isInteger=e.isInteger,this.activeBufferIndex=0,this.baseId=e.id}get id(){return`${this.baseId}|${this.activeBufferIndex}`}get bufferGPU(){return this.buffers[this.activeBufferIndex]}get transformBuffer(){return this.buffers[1^this.activeBufferIndex]}switchBuffers(){this.activeBufferIndex^=1}}class EB{constructor(e){this.backend=e}createAttribute(e,t){const n=this.backend,{gl:i}=n,r=e.array,s=e.usage||i.STATIC_DRAW,o=e.isInterleavedBufferAttribute?e.data:e,a=n.get(o);let l,c=a.bufferGPU;if(void 0===c&&(c=this._createBuffer(i,t,r,s),a.bufferGPU=c,a.bufferType=t,a.version=o.version),r instanceof Float32Array)l=i.FLOAT;else if(r instanceof Uint16Array)l=e.isFloat16BufferAttribute?i.HALF_FLOAT:i.UNSIGNED_SHORT;else if(r instanceof Int16Array)l=i.SHORT;else if(r instanceof Uint32Array)l=i.UNSIGNED_INT;else if(r instanceof Int32Array)l=i.INT;else if(r instanceof Int8Array)l=i.BYTE;else if(r instanceof Uint8Array)l=i.UNSIGNED_BYTE;else{if(!(r instanceof Uint8ClampedArray))throw new Error("THREE.WebGLBackend: Unsupported buffer data format: "+r);l=i.UNSIGNED_BYTE}let u={bufferGPU:c,bufferType:t,type:l,byteLength:r.byteLength,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version,pbo:e.pbo,isInteger:l===i.INT||l===i.UNSIGNED_INT||e.gpuType===il,id:SB++};if(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute){const e=this._createBuffer(i,t,r,s);u=new MB(u,e)}n.set(e,u)}updateAttribute(e){const t=this.backend,{gl:n}=t,i=e.array,r=e.isInterleavedBufferAttribute?e.data:e,s=t.get(r),o=s.bufferType,a=e.isInterleavedBufferAttribute?e.data.updateRanges:e.updateRanges;if(n.bindBuffer(o,s.bufferGPU),0===a.length)n.bufferSubData(o,0,i);else{for(let e=0,t=a.length;e<t;e++){const t=a[e];n.bufferSubData(o,t.start*i.BYTES_PER_ELEMENT,i,t.start,t.count)}r.clearUpdateRanges()}n.bindBuffer(o,null),s.version=r.version}destroyAttribute(e){const t=this.backend,{gl:n}=t;e.isInterleavedBufferAttribute&&t.delete(e.data);const i=t.get(e);n.deleteBuffer(i.bufferGPU),t.delete(e)}async getArrayBufferAsync(e){const t=this.backend,{gl:n}=t,i=e.isInterleavedBufferAttribute?e.data:e,{bufferGPU:r}=t.get(i),s=e.array,o=s.byteLength;n.bindBuffer(n.COPY_READ_BUFFER,r);const a=n.createBuffer();n.bindBuffer(n.COPY_WRITE_BUFFER,a),n.bufferData(n.COPY_WRITE_BUFFER,o,n.STREAM_READ),n.copyBufferSubData(n.COPY_READ_BUFFER,n.COPY_WRITE_BUFFER,0,0,o),await t.utils._clientWaitAsync();const l=new e.array.constructor(s.length);return n.bindBuffer(n.COPY_WRITE_BUFFER,a),n.getBufferSubData(n.COPY_WRITE_BUFFER,0,l),n.deleteBuffer(a),n.bindBuffer(n.COPY_READ_BUFFER,null),n.bindBuffer(n.COPY_WRITE_BUFFER,null),l.buffer}_createBuffer(e,t,n,i){const r=e.createBuffer();return e.bindBuffer(t,r),e.bufferData(t,n,i),e.bindBuffer(t,null),r}}class AB{constructor(e){this.backend=e,this.gl=this.backend.gl,this.enabled={},this.currentFlipSided=null,this.currentCullFace=null,this.currentProgram=null,this.currentBlendingEnabled=!1,this.currentBlending=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipledAlpha=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentColorMask=null,this.currentDepthFunc=null,this.currentDepthMask=null,this.currentStencilFunc=null,this.currentStencilRef=null,this.currentStencilFuncMask=null,this.currentStencilFail=null,this.currentStencilZFail=null,this.currentStencilZPass=null,this.currentStencilMask=null,this.currentLineWidth=null,this.currentClippingPlanes=0,this.currentVAO=null,this.currentIndex=null,this.currentBoundFramebuffers={},this.currentDrawbuffers=new WeakMap,this.maxTextures=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this.currentTextureSlot=null,this.currentBoundTextures={},this.currentBoundBufferBases={},this._init()}_init(){const e=this.gl;wB={[pa]:e.FUNC_ADD,[fa]:e.FUNC_SUBTRACT,[ma]:e.FUNC_REVERSE_SUBTRACT},TB={[ga]:e.ZERO,[ya]:e.ONE,[va]:e.SRC_COLOR,[xa]:e.SRC_ALPHA,[Ea]:e.SRC_ALPHA_SATURATE,[Sa]:e.DST_COLOR,[wa]:e.DST_ALPHA,[_a]:e.ONE_MINUS_SRC_COLOR,[ba]:e.ONE_MINUS_SRC_ALPHA,[Ma]:e.ONE_MINUS_DST_COLOR,[Ta]:e.ONE_MINUS_DST_ALPHA};const t=e.getParameter(e.SCISSOR_BOX),n=e.getParameter(e.VIEWPORT);this.currentScissor=(new nu).fromArray(t),this.currentViewport=(new nu).fromArray(n),this._tempVec4=new nu}enable(e){const{enabled:t}=this;!0!==t[e]&&(this.gl.enable(e),t[e]=!0)}disable(e){const{enabled:t}=this;!1!==t[e]&&(this.gl.disable(e),t[e]=!1)}setFlipSided(e){if(this.currentFlipSided!==e){const{gl:t}=this;e?t.frontFace(t.CW):t.frontFace(t.CCW),this.currentFlipSided=e}}setCullFace(e){const{gl:t}=this;0!==e?(this.enable(t.CULL_FACE),e!==this.currentCullFace&&(1===e?t.cullFace(t.BACK):2===e?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):this.disable(t.CULL_FACE),this.currentCullFace=e}setLineWidth(e){const{currentLineWidth:t,gl:n}=this;e!==t&&(n.lineWidth(e),this.currentLineWidth=e)}setBlending(e,t,n,i,r,s,o,a){const{gl:l}=this;if(0!==e){if(!1===this.currentBlendingEnabled&&(this.enable(l.BLEND),this.currentBlendingEnabled=!0),5===e)r=r||t,s=s||n,o=o||i,t===this.currentBlendEquation&&r===this.currentBlendEquationAlpha||(l.blendEquationSeparate(wB[t],wB[r]),this.currentBlendEquation=t,this.currentBlendEquationAlpha=r),n===this.currentBlendSrc&&i===this.currentBlendDst&&s===this.currentBlendSrcAlpha&&o===this.currentBlendDstAlpha||(l.blendFuncSeparate(TB[n],TB[i],TB[s],TB[o]),this.currentBlendSrc=n,this.currentBlendDst=i,this.currentBlendSrcAlpha=s,this.currentBlendDstAlpha=o),this.currentBlending=e,this.currentPremultipledAlpha=!1;else if(e!==this.currentBlending||a!==this.currentPremultipledAlpha){if(this.currentBlendEquation===pa&&this.currentBlendEquationAlpha===pa||(l.blendEquation(l.FUNC_ADD),this.currentBlendEquation=pa,this.currentBlendEquationAlpha=pa),a)switch(e){case 1:l.blendFuncSeparate(l.ONE,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case 2:l.blendFunc(l.ONE,l.ONE);break;case 3:l.blendFuncSeparate(l.ZERO,l.ONE_MINUS_SRC_COLOR,l.ZERO,l.ONE);break;case 4:l.blendFuncSeparate(l.ZERO,l.SRC_COLOR,l.ZERO,l.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}else switch(e){case 1:l.blendFuncSeparate(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case 2:l.blendFunc(l.SRC_ALPHA,l.ONE);break;case 3:l.blendFuncSeparate(l.ZERO,l.ONE_MINUS_SRC_COLOR,l.ZERO,l.ONE);break;case 4:l.blendFunc(l.ZERO,l.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentBlending=e,this.currentPremultipledAlpha=a}}else!0===this.currentBlendingEnabled&&(this.disable(l.BLEND),this.currentBlendingEnabled=!1)}setColorMask(e){this.currentColorMask!==e&&(this.gl.colorMask(e,e,e,e),this.currentColorMask=e)}setDepthTest(e){const{gl:t}=this;e?this.enable(t.DEPTH_TEST):this.disable(t.DEPTH_TEST)}setDepthMask(e){this.currentDepthMask!==e&&(this.gl.depthMask(e),this.currentDepthMask=e)}setDepthFunc(e){if(this.currentDepthFunc!==e){const{gl:t}=this;switch(e){case 0:t.depthFunc(t.NEVER);break;case 1:t.depthFunc(t.ALWAYS);break;case 2:t.depthFunc(t.LESS);break;case 3:default:t.depthFunc(t.LEQUAL);break;case 4:t.depthFunc(t.EQUAL);break;case 5:t.depthFunc(t.GEQUAL);break;case 6:t.depthFunc(t.GREATER);break;case 7:t.depthFunc(t.NOTEQUAL)}this.currentDepthFunc=e}}scissor(e,t,n,i){const r=this._tempVec4.set(e,t,n,i);if(!1===this.currentScissor.equals(r)){const{gl:e}=this;e.scissor(r.x,r.y,r.z,r.w),this.currentScissor.copy(r)}}viewport(e,t,n,i){const r=this._tempVec4.set(e,t,n,i);if(!1===this.currentViewport.equals(r)){const{gl:e}=this;e.viewport(r.x,r.y,r.z,r.w),this.currentViewport.copy(r)}}setScissorTest(e){const t=this.gl;e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST)}setStencilTest(e){const{gl:t}=this;e?this.enable(t.STENCIL_TEST):this.disable(t.STENCIL_TEST)}setStencilMask(e){this.currentStencilMask!==e&&(this.gl.stencilMask(e),this.currentStencilMask=e)}setStencilFunc(e,t,n){this.currentStencilFunc===e&&this.currentStencilRef===t&&this.currentStencilFuncMask===n||(this.gl.stencilFunc(e,t,n),this.currentStencilFunc=e,this.currentStencilRef=t,this.currentStencilFuncMask=n)}setStencilOp(e,t,n){this.currentStencilFail===e&&this.currentStencilZFail===t&&this.currentStencilZPass===n||(this.gl.stencilOp(e,t,n),this.currentStencilFail=e,this.currentStencilZFail=t,this.currentStencilZPass=n)}setMaterial(e,t,n){const{gl:i}=this;2===e.side?this.disable(i.CULL_FACE):this.enable(i.CULL_FACE);let r=1===e.side;t&&(r=!r),this.setFlipSided(r),1===e.blending&&!1===e.transparent?this.setBlending(0):this.setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),this.setDepthFunc(e.depthFunc),this.setDepthTest(e.depthTest),this.setDepthMask(e.depthWrite),this.setColorMask(e.colorWrite);const s=e.stencilWrite;if(this.setStencilTest(s),s&&(this.setStencilMask(e.stencilWriteMask),this.setStencilFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),this.setStencilOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),this.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage&&this.backend.renderer.samples>1?this.enable(i.SAMPLE_ALPHA_TO_COVERAGE):this.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n>0&&this.currentClippingPlanes!==n){const e=12288;for(let t=0;t<8;t++)t<n?this.enable(e+t):this.disable(e+t)}}setPolygonOffset(e,t,n){const{gl:i}=this;e?(this.enable(i.POLYGON_OFFSET_FILL),this.currentPolygonOffsetFactor===t&&this.currentPolygonOffsetUnits===n||(i.polygonOffset(t,n),this.currentPolygonOffsetFactor=t,this.currentPolygonOffsetUnits=n)):this.disable(i.POLYGON_OFFSET_FILL)}useProgram(e){return this.currentProgram!==e&&(this.gl.useProgram(e),this.currentProgram=e,!0)}setVertexState(e,t=null){const n=this.gl;return(this.currentVAO!==e||this.currentIndex!==t)&&(n.bindVertexArray(e),null!==t&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.currentVAO=e,this.currentIndex=t,!0)}resetVertexState(){const e=this.gl;e.bindVertexArray(null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),this.currentVAO=null,this.currentIndex=null}bindFramebuffer(e,t){const{gl:n,currentBoundFramebuffers:i}=this;return i[e]!==t&&(n.bindFramebuffer(e,t),i[e]=t,e===n.DRAW_FRAMEBUFFER&&(i[n.FRAMEBUFFER]=t),e===n.FRAMEBUFFER&&(i[n.DRAW_FRAMEBUFFER]=t),!0)}drawBuffers(e,t){const{gl:n}=this;let i=[],r=!1;if(null!==e.textures){i=this.currentDrawbuffers.get(t),void 0===i&&(i=[],this.currentDrawbuffers.set(t,i));const s=e.textures;if(i.length!==s.length||i[0]!==n.COLOR_ATTACHMENT0){for(let e=0,t=s.length;e<t;e++)i[e]=n.COLOR_ATTACHMENT0+e;i.length=s.length,r=!0}}else i[0]!==n.BACK&&(i[0]=n.BACK,r=!0);r&&n.drawBuffers(i)}activeTexture(e){const{gl:t,currentTextureSlot:n,maxTextures:i}=this;void 0===e&&(e=t.TEXTURE0+i-1),n!==e&&(t.activeTexture(e),this.currentTextureSlot=e)}bindTexture(e,t,n){const{gl:i,currentTextureSlot:r,currentBoundTextures:s,maxTextures:o}=this;void 0===n&&(n=null===r?i.TEXTURE0+o-1:r);let a=s[n];void 0===a&&(a={type:void 0,texture:void 0},s[n]=a),a.type===e&&a.texture===t||(r!==n&&(i.activeTexture(n),this.currentTextureSlot=n),i.bindTexture(e,t),a.type=e,a.texture=t)}bindBufferBase(e,t,n){const{gl:i}=this,r=`${e}-${t}`;return this.currentBoundBufferBases[r]!==n&&(i.bindBufferBase(e,t,n),this.currentBoundBufferBases[r]=n,!0)}unbindTexture(){const{gl:e,currentTextureSlot:t,currentBoundTextures:n}=this,i=n[t];void 0!==i&&void 0!==i.type&&(e.bindTexture(i.type,null),i.type=void 0,i.texture=void 0)}}class CB{constructor(e){this.backend=e,this.gl=this.backend.gl,this.extensions=e.extensions}convert(e,t=""){const{gl:n,extensions:i}=this;let r;const s=Wc.getTransfer(t);if(e===Qa)return n.UNSIGNED_BYTE;if(e===al)return n.UNSIGNED_SHORT_4_4_4_4;if(e===ll)return n.UNSIGNED_SHORT_5_5_5_1;if(e===ul)return n.UNSIGNED_INT_5_9_9_9_REV;if(e===el)return n.BYTE;if(e===tl)return n.SHORT;if(e===nl)return n.UNSIGNED_SHORT;if(e===il)return n.INT;if(e===rl)return n.UNSIGNED_INT;if(e===sl)return n.FLOAT;if(e===ol)return n.HALF_FLOAT;if(e===hl)return n.ALPHA;if(e===dl)return n.RGB;if(e===pl)return n.RGBA;if(e===fl)return n.DEPTH_COMPONENT;if(e===ml)return n.DEPTH_STENCIL;if(e===gl)return n.RED;if(e===yl)return n.RED_INTEGER;if(e===vl)return n.RG;if(e===_l)return n.RG_INTEGER;if(e===xl)return n.RGBA_INTEGER;if(e===bl||e===wl||e===Tl||e===Sl)if(s===ic){if(r=i.get("WEBGL_compressed_texture_s3tc_srgb"),null===r)return null;if(e===bl)return r.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(e===wl)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(e===Tl)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(e===Sl)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(r=i.get("WEBGL_compressed_texture_s3tc"),null===r)return null;if(e===bl)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===wl)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===Tl)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===Sl)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(e===Ml||e===El||e===Al||e===Cl){if(r=i.get("WEBGL_compressed_texture_pvrtc"),null===r)return null;if(e===Ml)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===El)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===Al)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===Cl)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===Rl||e===Nl||e===Pl){if(r=i.get("WEBGL_compressed_texture_etc"),null===r)return null;if(e===Rl||e===Nl)return s===ic?r.COMPRESSED_SRGB8_ETC2:r.COMPRESSED_RGB8_ETC2;if(e===Pl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC}if(e===Dl||e===Ll||e===Il||e===kl||e===Ol||e===Ul||e===Fl||e===Bl||e===zl||e===Vl||e===Gl||e===jl||e===Hl||e===Wl){if(r=i.get("WEBGL_compressed_texture_astc"),null===r)return null;if(e===Dl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:r.COMPRESSED_RGBA_ASTC_4x4_KHR;if(e===Ll)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:r.COMPRESSED_RGBA_ASTC_5x4_KHR;if(e===Il)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:r.COMPRESSED_RGBA_ASTC_5x5_KHR;if(e===kl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:r.COMPRESSED_RGBA_ASTC_6x5_KHR;if(e===Ol)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:r.COMPRESSED_RGBA_ASTC_6x6_KHR;if(e===Ul)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:r.COMPRESSED_RGBA_ASTC_8x5_KHR;if(e===Fl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:r.COMPRESSED_RGBA_ASTC_8x6_KHR;if(e===Bl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:r.COMPRESSED_RGBA_ASTC_8x8_KHR;if(e===zl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:r.COMPRESSED_RGBA_ASTC_10x5_KHR;if(e===Vl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:r.COMPRESSED_RGBA_ASTC_10x6_KHR;if(e===Gl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:r.COMPRESSED_RGBA_ASTC_10x8_KHR;if(e===jl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:r.COMPRESSED_RGBA_ASTC_10x10_KHR;if(e===Hl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:r.COMPRESSED_RGBA_ASTC_12x10_KHR;if(e===Wl)return s===ic?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:r.COMPRESSED_RGBA_ASTC_12x12_KHR}if(e===ql){if(r=i.get("EXT_texture_compression_bptc"),null===r)return null;if(e===ql)return s===ic?r.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:r.COMPRESSED_RGBA_BPTC_UNORM_EXT}if(e===Yl||e===Kl||e===Zl||e===Jl){if(r=i.get("EXT_texture_compression_rgtc"),null===r)return null;if(e===ql)return r.COMPRESSED_RED_RGTC1_EXT;if(e===Kl)return r.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(e===Zl)return r.COMPRESSED_RED_GREEN_RGTC2_EXT;if(e===Jl)return r.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return e===cl?n.UNSIGNED_INT_24_8:void 0!==n[e]?n[e]:null}_clientWaitAsync(){const{gl:e}=this,t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);return e.flush(),new Promise(((n,i)=>{!function r(){const s=e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0);if(s===e.WAIT_FAILED)return e.deleteSync(t),void i();s!==e.TIMEOUT_EXPIRED?(e.deleteSync(t),n()):requestAnimationFrame(r)}()}))}}let RB,NB,PB,DB=!1;class LB{constructor(e){this.backend=e,this.gl=e.gl,this.extensions=e.extensions,this.defaultTextures={},!1===DB&&(this._init(),DB=!0)}_init(){const e=this.gl;RB={[Ha]:e.REPEAT,[Wa]:e.CLAMP_TO_EDGE,[qa]:e.MIRRORED_REPEAT},NB={[Xa]:e.NEAREST,[$a]:e.NEAREST_MIPMAP_NEAREST,[Ya]:e.NEAREST_MIPMAP_LINEAR,[Ka]:e.LINEAR,[Za]:e.LINEAR_MIPMAP_NEAREST,[Ja]:e.LINEAR_MIPMAP_LINEAR},PB={[sc]:e.NEVER,[dc]:e.ALWAYS,[oc]:e.LESS,[lc]:e.LEQUAL,[ac]:e.EQUAL,[hc]:e.GEQUAL,[cc]:e.GREATER,[uc]:e.NOTEQUAL}}getGLTextureType(e){const{gl:t}=this;let n;return n=!0===e.isCubeTexture?t.TEXTURE_CUBE_MAP:!0===e.isArrayTexture||!0===e.isDataArrayTexture||!0===e.isCompressedArrayTexture?t.TEXTURE_2D_ARRAY:!0===e.isData3DTexture?t.TEXTURE_3D:t.TEXTURE_2D,n}getInternalFormat(e,t,n,i,r=!1){const{gl:s,extensions:o}=this;if(null!==e){if(void 0!==s[e])return s[e];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+e+"'")}let a=t;if(t===s.RED&&(n===s.FLOAT&&(a=s.R32F),n===s.HALF_FLOAT&&(a=s.R16F),n===s.UNSIGNED_BYTE&&(a=s.R8),n===s.UNSIGNED_SHORT&&(a=s.R16),n===s.UNSIGNED_INT&&(a=s.R32UI),n===s.BYTE&&(a=s.R8I),n===s.SHORT&&(a=s.R16I),n===s.INT&&(a=s.R32I)),t===s.RED_INTEGER&&(n===s.UNSIGNED_BYTE&&(a=s.R8UI),n===s.UNSIGNED_SHORT&&(a=s.R16UI),n===s.UNSIGNED_INT&&(a=s.R32UI),n===s.BYTE&&(a=s.R8I),n===s.SHORT&&(a=s.R16I),n===s.INT&&(a=s.R32I)),t===s.RG&&(n===s.FLOAT&&(a=s.RG32F),n===s.HALF_FLOAT&&(a=s.RG16F),n===s.UNSIGNED_BYTE&&(a=s.RG8),n===s.UNSIGNED_SHORT&&(a=s.RG16),n===s.UNSIGNED_INT&&(a=s.RG32UI),n===s.BYTE&&(a=s.RG8I),n===s.SHORT&&(a=s.RG16I),n===s.INT&&(a=s.RG32I)),t===s.RG_INTEGER&&(n===s.UNSIGNED_BYTE&&(a=s.RG8UI),n===s.UNSIGNED_SHORT&&(a=s.RG16UI),n===s.UNSIGNED_INT&&(a=s.RG32UI),n===s.BYTE&&(a=s.RG8I),n===s.SHORT&&(a=s.RG16I),n===s.INT&&(a=s.RG32I)),t===s.RGB){const e=r?nc:Wc.getTransfer(i);n===s.FLOAT&&(a=s.RGB32F),n===s.HALF_FLOAT&&(a=s.RGB16F),n===s.UNSIGNED_BYTE&&(a=s.RGB8),n===s.UNSIGNED_SHORT&&(a=s.RGB16),n===s.UNSIGNED_INT&&(a=s.RGB32UI),n===s.BYTE&&(a=s.RGB8I),n===s.SHORT&&(a=s.RGB16I),n===s.INT&&(a=s.RGB32I),n===s.UNSIGNED_BYTE&&(a=e===ic?s.SRGB8:s.RGB8),n===s.UNSIGNED_SHORT_5_6_5&&(a=s.RGB565),n===s.UNSIGNED_SHORT_5_5_5_1&&(a=s.RGB5_A1),n===s.UNSIGNED_SHORT_4_4_4_4&&(a=s.RGB4),n===s.UNSIGNED_INT_5_9_9_9_REV&&(a=s.RGB9_E5)}if(t===s.RGB_INTEGER&&(n===s.UNSIGNED_BYTE&&(a=s.RGB8UI),n===s.UNSIGNED_SHORT&&(a=s.RGB16UI),n===s.UNSIGNED_INT&&(a=s.RGB32UI),n===s.BYTE&&(a=s.RGB8I),n===s.SHORT&&(a=s.RGB16I),n===s.INT&&(a=s.RGB32I)),t===s.RGBA){const e=r?nc:Wc.getTransfer(i);n===s.FLOAT&&(a=s.RGBA32F),n===s.HALF_FLOAT&&(a=s.RGBA16F),n===s.UNSIGNED_BYTE&&(a=s.RGBA8),n===s.UNSIGNED_SHORT&&(a=s.RGBA16),n===s.UNSIGNED_INT&&(a=s.RGBA32UI),n===s.BYTE&&(a=s.RGBA8I),n===s.SHORT&&(a=s.RGBA16I),n===s.INT&&(a=s.RGBA32I),n===s.UNSIGNED_BYTE&&(a=e===ic?s.SRGB8_ALPHA8:s.RGBA8),n===s.UNSIGNED_SHORT_4_4_4_4&&(a=s.RGBA4),n===s.UNSIGNED_SHORT_5_5_5_1&&(a=s.RGB5_A1)}return t===s.RGBA_INTEGER&&(n===s.UNSIGNED_BYTE&&(a=s.RGBA8UI),n===s.UNSIGNED_SHORT&&(a=s.RGBA16UI),n===s.UNSIGNED_INT&&(a=s.RGBA32UI),n===s.BYTE&&(a=s.RGBA8I),n===s.SHORT&&(a=s.RGBA16I),n===s.INT&&(a=s.RGBA32I)),t===s.DEPTH_COMPONENT&&(n===s.UNSIGNED_SHORT&&(a=s.DEPTH_COMPONENT16),n===s.UNSIGNED_INT&&(a=s.DEPTH_COMPONENT24),n===s.FLOAT&&(a=s.DEPTH_COMPONENT32F)),t===s.DEPTH_STENCIL&&n===s.UNSIGNED_INT_24_8&&(a=s.DEPTH24_STENCIL8),a!==s.R16F&&a!==s.R32F&&a!==s.RG16F&&a!==s.RG32F&&a!==s.RGBA16F&&a!==s.RGBA32F||o.get("EXT_color_buffer_float"),a}setTextureParameters(e,t){const{gl:n,extensions:i,backend:r}=this,s=Wc.getPrimaries(Wc.workingColorSpace),o=t.colorSpace===Ql?null:Wc.getPrimaries(t.colorSpace),a=t.colorSpace===Ql||s===o?n.NONE:n.BROWSER_DEFAULT_WEBGL;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t.flipY),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),n.pixelStorei(n.UNPACK_ALIGNMENT,t.unpackAlignment),n.pixelStorei(n.UNPACK_COLORSPACE_CONVERSION_WEBGL,a),n.texParameteri(e,n.TEXTURE_WRAP_S,RB[t.wrapS]),n.texParameteri(e,n.TEXTURE_WRAP_T,RB[t.wrapT]),e!==n.TEXTURE_3D&&e!==n.TEXTURE_2D_ARRAY||t.isArrayTexture||n.texParameteri(e,n.TEXTURE_WRAP_R,RB[t.wrapR]),n.texParameteri(e,n.TEXTURE_MAG_FILTER,NB[t.magFilter]);const l=void 0!==t.mipmaps&&t.mipmaps.length>0,c=t.minFilter===Ka&&l?Ja:t.minFilter;if(n.texParameteri(e,n.TEXTURE_MIN_FILTER,NB[c]),t.compareFunction&&(n.texParameteri(e,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE),n.texParameteri(e,n.TEXTURE_COMPARE_FUNC,PB[t.compareFunction])),!0===i.has("EXT_texture_filter_anisotropic")){if(t.magFilter===Xa)return;if(t.minFilter!==Ya&&t.minFilter!==Ja)return;if(t.type===sl&&!1===i.has("OES_texture_float_linear"))return;if(t.anisotropy>1){const s=i.get("EXT_texture_filter_anisotropic");n.texParameterf(e,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,r.getMaxAnisotropy()))}}}createDefaultTexture(e){const{gl:t,backend:n,defaultTextures:i}=this,r=this.getGLTextureType(e);let s=i[r];void 0===s&&(s=t.createTexture(),n.state.bindTexture(r,s),t.texParameteri(r,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(r,t.TEXTURE_MAG_FILTER,t.NEAREST),i[r]=s),n.set(e,{textureGPU:s,glTextureType:r,isDefault:!0})}createTexture(e,t){const{gl:n,backend:i}=this,{levels:r,width:s,height:o,depth:a}=t,l=i.utils.convert(e.format,e.colorSpace),c=i.utils.convert(e.type),u=this.getInternalFormat(e.internalFormat,l,c,e.colorSpace,e.isVideoTexture),h=n.createTexture(),d=this.getGLTextureType(e);i.state.bindTexture(d,h),this.setTextureParameters(d,e),e.isArrayTexture||e.isDataArrayTexture||e.isCompressedArrayTexture?n.texStorage3D(n.TEXTURE_2D_ARRAY,r,u,s,o,a):e.isData3DTexture?n.texStorage3D(n.TEXTURE_3D,r,u,s,o,a):e.isVideoTexture||n.texStorage2D(d,r,u,s,o),i.set(e,{textureGPU:h,glTextureType:d,glFormat:l,glType:c,glInternalFormat:u})}copyBufferToTexture(e,t){const{gl:n,backend:i}=this,{textureGPU:r,glTextureType:s,glFormat:o,glType:a}=i.get(t),{width:l,height:c}=t.source.data;n.bindBuffer(n.PIXEL_UNPACK_BUFFER,e),i.state.bindTexture(s,r),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),n.texSubImage2D(s,0,0,0,l,c,o,a,0),n.bindBuffer(n.PIXEL_UNPACK_BUFFER,null),i.state.unbindTexture()}updateTexture(e,t){const{gl:n}=this,{width:i,height:r}=t,{textureGPU:s,glTextureType:o,glFormat:a,glType:l,glInternalFormat:c}=this.backend.get(e);if(!e.isRenderTargetTexture&&void 0!==s)if(this.backend.state.bindTexture(o,s),this.setTextureParameters(o,e),e.isCompressedTexture){const i=e.mipmaps,r=t.image;for(let t=0;t<i.length;t++){const s=i[t];e.isCompressedArrayTexture?e.format!==n.RGBA?null!==a?n.compressedTexSubImage3D(n.TEXTURE_2D_ARRAY,t,0,0,0,s.width,s.height,r.depth,a,s.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):n.texSubImage3D(n.TEXTURE_2D_ARRAY,t,0,0,0,s.width,s.height,r.depth,a,l,s.data):null!==a?n.compressedTexSubImage2D(n.TEXTURE_2D,t,0,0,s.width,s.height,a,s.data):console.warn("Unsupported compressed texture format")}}else if(e.isCubeTexture){const e=t.images;for(let t=0;t<6;t++){const s=IB(e[t]);n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,i,r,a,l,s)}}else if(e.isDataArrayTexture||e.isArrayTexture){const e=t.image;n.texSubImage3D(n.TEXTURE_2D_ARRAY,0,0,0,0,e.width,e.height,e.depth,a,l,e.data)}else if(e.isData3DTexture){const e=t.image;n.texSubImage3D(n.TEXTURE_3D,0,0,0,0,e.width,e.height,e.depth,a,l,e.data)}else if(e.isVideoTexture)e.update(),n.texImage2D(o,0,c,a,l,t.image);else{const e=IB(t.image);n.texSubImage2D(o,0,0,0,i,r,a,l,e)}}generateMipmaps(e){const{gl:t,backend:n}=this,{textureGPU:i,glTextureType:r}=n.get(e);n.state.bindTexture(r,i),t.generateMipmap(r)}deallocateRenderBuffers(e){const{gl:t,backend:n}=this;if(e){const i=n.get(e);if(i.renderBufferStorageSetup=void 0,i.framebuffers){for(const e in i.framebuffers)t.deleteFramebuffer(i.framebuffers[e]);delete i.framebuffers}if(i.depthRenderbuffer&&(t.deleteRenderbuffer(i.depthRenderbuffer),delete i.depthRenderbuffer),i.stencilRenderbuffer&&(t.deleteRenderbuffer(i.stencilRenderbuffer),delete i.stencilRenderbuffer),i.msaaFrameBuffer&&(t.deleteFramebuffer(i.msaaFrameBuffer),delete i.msaaFrameBuffer),i.msaaRenderbuffers){for(let e=0;e<i.msaaRenderbuffers.length;e++)t.deleteRenderbuffer(i.msaaRenderbuffers[e]);delete i.msaaRenderbuffers}}}destroyTexture(e){const{gl:t,backend:n}=this,{textureGPU:i,renderTarget:r}=n.get(e);this.deallocateRenderBuffers(r),t.deleteTexture(i),n.delete(e)}copyTextureToTexture(e,t,n=null,i=null,r=0,s=0){const{gl:o,backend:a}=this,{state:l}=this.backend,{textureGPU:c,glTextureType:u,glType:h,glFormat:d}=a.get(t);let p,f,m,g,y,v,_,x,b;l.bindTexture(u,c);const w=e.isCompressedTexture?e.mipmaps[s]:e.image;if(null!==n)p=n.max.x-n.min.x,f=n.max.y-n.min.y,m=n.isBox3?n.max.z-n.min.z:1,g=n.min.x,y=n.min.y,v=n.isBox3?n.min.z:0;else{const t=Math.pow(2,-r);p=Math.floor(w.width*t),f=Math.floor(w.height*t),m=e.isDataArrayTexture||e.isArrayTexture?w.depth:e.isData3DTexture?Math.floor(w.depth*t):1,g=0,y=0,v=0}null!==i?(_=i.x,x=i.y,b=i.z):(_=0,x=0,b=0),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,t.flipY),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),o.pixelStorei(o.UNPACK_ALIGNMENT,t.unpackAlignment);const T=o.getParameter(o.UNPACK_ROW_LENGTH),S=o.getParameter(o.UNPACK_IMAGE_HEIGHT),M=o.getParameter(o.UNPACK_SKIP_PIXELS),E=o.getParameter(o.UNPACK_SKIP_ROWS),A=o.getParameter(o.UNPACK_SKIP_IMAGES);o.pixelStorei(o.UNPACK_ROW_LENGTH,w.width),o.pixelStorei(o.UNPACK_IMAGE_HEIGHT,w.height),o.pixelStorei(o.UNPACK_SKIP_PIXELS,g),o.pixelStorei(o.UNPACK_SKIP_ROWS,y),o.pixelStorei(o.UNPACK_SKIP_IMAGES,v);const C=t.isDataArrayTexture||t.isData3DTexture||t.isArrayTexture;if(e.isRenderTargetTexture||e.isDepthTexture){const n=a.get(e),i=a.get(t),r=a.get(n.renderTarget),s=a.get(i.renderTarget),c=r.framebuffers[n.cacheKey],u=s.framebuffers[i.cacheKey];l.bindFramebuffer(o.READ_FRAMEBUFFER,c),l.bindFramebuffer(o.DRAW_FRAMEBUFFER,u);let h=o.COLOR_BUFFER_BIT;e.isDepthTexture&&(h=o.DEPTH_BUFFER_BIT),o.blitFramebuffer(g,y,p,f,_,x,p,f,h,o.NEAREST),l.bindFramebuffer(o.READ_FRAMEBUFFER,null),l.bindFramebuffer(o.DRAW_FRAMEBUFFER,null)}else C?e.isDataTexture||e.isData3DTexture?o.texSubImage3D(u,s,_,x,b,p,f,m,d,h,w.data):t.isCompressedArrayTexture?o.compressedTexSubImage3D(u,s,_,x,b,p,f,m,d,w.data):o.texSubImage3D(u,s,_,x,b,p,f,m,d,h,w):e.isDataTexture?o.texSubImage2D(u,s,_,x,p,f,d,h,w.data):e.isCompressedTexture?o.compressedTexSubImage2D(u,s,_,x,w.width,w.height,d,w.data):o.texSubImage2D(u,s,_,x,p,f,d,h,w);o.pixelStorei(o.UNPACK_ROW_LENGTH,T),o.pixelStorei(o.UNPACK_IMAGE_HEIGHT,S),o.pixelStorei(o.UNPACK_SKIP_PIXELS,M),o.pixelStorei(o.UNPACK_SKIP_ROWS,E),o.pixelStorei(o.UNPACK_SKIP_IMAGES,A),0===s&&t.generateMipmaps&&o.generateMipmap(u),l.unbindTexture()}copyFramebufferToTexture(e,t,n){const{gl:i}=this,{state:r}=this.backend,{textureGPU:s}=this.backend.get(e),{x:o,y:a,z:l,w:c}=n,u=!0===e.isDepthTexture||t.renderTarget&&t.renderTarget.samples>0,h=t.renderTarget?t.renderTarget.height:this.backend.getDrawingBufferSize().y;if(u){const n=0!==o||0!==a;let u,d;if(!0===e.isDepthTexture?(u=i.DEPTH_BUFFER_BIT,d=i.DEPTH_ATTACHMENT,t.stencil&&(u|=i.STENCIL_BUFFER_BIT)):(u=i.COLOR_BUFFER_BIT,d=i.COLOR_ATTACHMENT0),n){const e=this.backend.get(t.renderTarget),n=e.framebuffers[t.getCacheKey()],d=e.msaaFrameBuffer;r.bindFramebuffer(i.DRAW_FRAMEBUFFER,n),r.bindFramebuffer(i.READ_FRAMEBUFFER,d);const p=h-a-c;i.blitFramebuffer(o,p,o+l,p+c,o,p,o+l,p+c,u,i.NEAREST),r.bindFramebuffer(i.READ_FRAMEBUFFER,n),r.bindTexture(i.TEXTURE_2D,s),i.copyTexSubImage2D(i.TEXTURE_2D,0,0,0,o,p,l,c),r.unbindTexture()}else{const e=i.createFramebuffer();r.bindFramebuffer(i.DRAW_FRAMEBUFFER,e),i.framebufferTexture2D(i.DRAW_FRAMEBUFFER,d,i.TEXTURE_2D,s,0),i.blitFramebuffer(0,0,l,c,0,0,l,c,u,i.NEAREST),i.deleteFramebuffer(e)}}else r.bindTexture(i.TEXTURE_2D,s),i.copyTexSubImage2D(i.TEXTURE_2D,0,0,0,o,h-c-a,l,c),r.unbindTexture();e.generateMipmaps&&this.generateMipmaps(e),this.backend._setFramebuffer(t)}setupRenderBufferStorage(e,t,n,i=!1){const{gl:r}=this,s=t.renderTarget,{depthTexture:o,depthBuffer:a,stencilBuffer:l,width:c,height:u}=s;if(r.bindRenderbuffer(r.RENDERBUFFER,e),a&&!l){let t=r.DEPTH_COMPONENT24;if(!0===i){this.extensions.get("WEBGL_multisampled_render_to_texture").renderbufferStorageMultisampleEXT(r.RENDERBUFFER,s.samples,t,c,u)}else n>0?(o&&o.isDepthTexture&&o.type===r.FLOAT&&(t=r.DEPTH_COMPONENT32F),r.renderbufferStorageMultisample(r.RENDERBUFFER,n,t,c,u)):r.renderbufferStorage(r.RENDERBUFFER,t,c,u);r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,e)}else a&&l&&(n>0?r.renderbufferStorageMultisample(r.RENDERBUFFER,n,r.DEPTH24_STENCIL8,c,u):r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,c,u),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,e))}async copyTextureToBuffer(e,t,n,i,r,s){const{backend:o,gl:a}=this,{textureGPU:l,glFormat:c,glType:u}=this.backend.get(e),h=a.createFramebuffer();a.bindFramebuffer(a.READ_FRAMEBUFFER,h);const d=e.isCubeTexture?a.TEXTURE_CUBE_MAP_POSITIVE_X+s:a.TEXTURE_2D;a.framebufferTexture2D(a.READ_FRAMEBUFFER,a.COLOR_ATTACHMENT0,d,l,0);const p=this._getTypedArrayType(u),f=i*r*this._getBytesPerTexel(u,c),m=a.createBuffer();a.bindBuffer(a.PIXEL_PACK_BUFFER,m),a.bufferData(a.PIXEL_PACK_BUFFER,f,a.STREAM_READ),a.readPixels(t,n,i,r,c,u,0),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),await o.utils._clientWaitAsync();const g=new p(f/p.BYTES_PER_ELEMENT);return a.bindBuffer(a.PIXEL_PACK_BUFFER,m),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,g),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),a.deleteFramebuffer(h),g}_getTypedArrayType(e){const{gl:t}=this;if(e===t.UNSIGNED_BYTE)return Uint8Array;if(e===t.UNSIGNED_SHORT_4_4_4_4)return Uint16Array;if(e===t.UNSIGNED_SHORT_5_5_5_1)return Uint16Array;if(e===t.UNSIGNED_SHORT_5_6_5)return Uint16Array;if(e===t.UNSIGNED_SHORT)return Uint16Array;if(e===t.UNSIGNED_INT)return Uint32Array;if(e===t.HALF_FLOAT)return Uint16Array;if(e===t.FLOAT)return Float32Array;throw new Error(`Unsupported WebGL type: ${e}`)}_getBytesPerTexel(e,t){const{gl:n}=this;let i=0;return e===n.UNSIGNED_BYTE&&(i=1),e!==n.UNSIGNED_SHORT_4_4_4_4&&e!==n.UNSIGNED_SHORT_5_5_5_1&&e!==n.UNSIGNED_SHORT_5_6_5&&e!==n.UNSIGNED_SHORT&&e!==n.HALF_FLOAT||(i=2),e!==n.UNSIGNED_INT&&e!==n.FLOAT||(i=4),t===n.RGBA?4*i:t===n.RGB?3*i:t===n.ALPHA?i:void 0}}function IB(e){return e.isDataTexture?e.image.data:"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas?e:e.data}class kB{constructor(e){this.backend=e,this.gl=this.backend.gl,this.availableExtensions=this.gl.getSupportedExtensions(),this.extensions={}}get(e){let t=this.extensions[e];return void 0===t&&(t=this.gl.getExtension(e),this.extensions[e]=t),t}has(e){return this.availableExtensions.includes(e)}}class OB{constructor(e){this.backend=e,this.maxAnisotropy=null}getMaxAnisotropy(){if(null!==this.maxAnisotropy)return this.maxAnisotropy;const e=this.backend.gl,t=this.backend.extensions;if(!0===t.has("EXT_texture_filter_anisotropic")){const n=t.get("EXT_texture_filter_anisotropic");this.maxAnisotropy=e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else this.maxAnisotropy=0;return this.maxAnisotropy}}const UB={WEBGL_multi_draw:"WEBGL_multi_draw",WEBGL_compressed_texture_astc:"texture-compression-astc",WEBGL_compressed_texture_etc:"texture-compression-etc2",WEBGL_compressed_texture_etc1:"texture-compression-etc1",WEBGL_compressed_texture_pvrtc:"texture-compression-pvrtc",WEBKIT_WEBGL_compressed_texture_pvrtc:"texture-compression-pvrtc",WEBGL_compressed_texture_s3tc:"texture-compression-bc",EXT_texture_compression_bptc:"texture-compression-bptc",EXT_disjoint_timer_query_webgl2:"timestamp-query",OVR_multiview2:"OVR_multiview2"};class FB{constructor(e){this.gl=e.gl,this.extensions=e.extensions,this.info=e.renderer.info,this.mode=null,this.index=0,this.type=null,this.object=null}render(e,t){const{gl:n,mode:i,object:r,type:s,info:o,index:a}=this;0!==a?n.drawElements(i,t,s,e):n.drawArrays(i,e,t),o.update(r,t,1)}renderInstances(e,t,n){const{gl:i,mode:r,type:s,index:o,object:a,info:l}=this;0!==n&&(0!==o?i.drawElementsInstanced(r,t,s,e,n):i.drawArraysInstanced(r,e,t,n),l.update(a,t,n))}renderMultiDraw(e,t,n){const{extensions:i,mode:r,object:s,info:o}=this;if(0===n)return;const a=i.get("WEBGL_multi_draw");if(null===a)for(let i=0;i<n;i++)this.render(e[i],t[i]);else{0!==this.index?a.multiDrawElementsWEBGL(r,t,0,this.type,e,0,n):a.multiDrawArraysWEBGL(r,e,0,t,0,n);let i=0;for(let e=0;e<n;e++)i+=t[e];o.update(s,i,1)}}renderMultiDrawInstances(e,t,n,i){const{extensions:r,mode:s,object:o,info:a}=this;if(0===n)return;const l=r.get("WEBGL_multi_draw");if(null===l)for(let r=0;r<n;r++)this.renderInstances(e[r],t[r],i[r]);else{0!==this.index?l.multiDrawElementsInstancedWEBGL(s,t,0,this.type,e,0,i,0,n):l.multiDrawArraysInstancedWEBGL(s,e,0,t,0,i,0,n);let r=0;for(let e=0;e<n;e++)r+=t[e]*i[e];a.update(o,r,1)}}}class BB{constructor(e=256){this.trackTimestamp=!0,this.maxQueries=e,this.currentQueryIndex=0,this.queryOffsets=new Map,this.isDisposed=!1,this.lastValue=0,this.pendingResolve=!1}allocateQueriesForContext(){}async resolveQueriesAsync(){}dispose(){}}class zB extends BB{constructor(e,t,n=2048){if(super(n),this.gl=e,this.type=t,this.ext=e.getExtension("EXT_disjoint_timer_query_webgl2")||e.getExtension("EXT_disjoint_timer_query"),!this.ext)return console.warn("EXT_disjoint_timer_query not supported; timestamps will be disabled."),void(this.trackTimestamp=!1);this.queries=[];for(let t=0;t<this.maxQueries;t++)this.queries.push(e.createQuery());this.activeQuery=null,this.queryStates=new Map}allocateQueriesForContext(e){if(!this.trackTimestamp)return null;if(this.currentQueryIndex+2>this.maxQueries)return Vc(`WebGPUTimestampQueryPool [${this.type}]: Maximum number of queries exceeded, when using trackTimestamp it is necessary to resolves the queries via renderer.resolveTimestampsAsync( THREE.TimestampQuery.${this.type.toUpperCase()} ).`),null;const t=this.currentQueryIndex;return this.currentQueryIndex+=2,this.queryStates.set(t,"inactive"),this.queryOffsets.set(e.id,t),t}beginQuery(e){if(!this.trackTimestamp||this.isDisposed)return;const t=this.queryOffsets.get(e.id);if(null==t)return;if(null!==this.activeQuery)return;const n=this.queries[t];if(n)try{"inactive"===this.queryStates.get(t)&&(this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,n),this.activeQuery=t,this.queryStates.set(t,"started"))}catch(e){console.error("Error in beginQuery:",e),this.activeQuery=null,this.queryStates.set(t,"inactive")}}endQuery(e){if(!this.trackTimestamp||this.isDisposed)return;const t=this.queryOffsets.get(e.id);if(null!=t&&this.activeQuery===t)try{this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.queryStates.set(t,"ended"),this.activeQuery=null}catch(e){console.error("Error in endQuery:",e),this.queryStates.set(t,"inactive"),this.activeQuery=null}}async resolveQueriesAsync(){if(!this.trackTimestamp||this.pendingResolve)return this.lastValue;this.pendingResolve=!0;try{const e=[];for(const[t,n]of this.queryStates)if("ended"===n){const n=this.queries[t];e.push(this.resolveQuery(n))}if(0===e.length)return this.lastValue;const t=(await Promise.all(e)).reduce(((e,t)=>e+t),0);return this.lastValue=t,this.currentQueryIndex=0,this.queryOffsets.clear(),this.queryStates.clear(),this.activeQuery=null,t}catch(e){return console.error("Error resolving queries:",e),this.lastValue}finally{this.pendingResolve=!1}}async resolveQuery(e){return new Promise((t=>{if(this.isDisposed)return void t(this.lastValue);let n,i=!1;const r=e=>{i||(i=!0,n&&(clearTimeout(n),n=null),t(e))},s=()=>{if(this.isDisposed)r(this.lastValue);else try{if(this.gl.getParameter(this.ext.GPU_DISJOINT_EXT))return void r(this.lastValue);if(!this.gl.getQueryParameter(e,this.gl.QUERY_RESULT_AVAILABLE))return void(n=setTimeout(s,1));const i=this.gl.getQueryParameter(e,this.gl.QUERY_RESULT);t(Number(i)/1e6)}catch(e){console.error("Error checking query:",e),t(this.lastValue)}};s()}))}dispose(){if(!this.isDisposed&&(this.isDisposed=!0,this.trackTimestamp)){for(const e of this.queries)this.gl.deleteQuery(e);this.queries=[],this.queryStates.clear(),this.queryOffsets.clear(),this.lastValue=0,this.activeQuery=null}}}const VB=new Nc;class GB extends bB{constructor(e={}){super(e),this.isWebGLBackend=!0,this.attributeUtils=null,this.extensions=null,this.capabilities=null,this.textureUtils=null,this.bufferRenderer=null,this.gl=null,this.state=null,this.utils=null,this.vaoCache={},this.transformFeedbackCache={},this.discard=!1,this.disjoint=null,this.parallel=null,this._currentContext=null,this._knownBindings=new WeakSet,this._supportsInvalidateFramebuffer="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),this._xrFramebuffer=null}init(e){super.init(e);const t=this.parameters,n={antialias:e.samples>0,alpha:!0,depth:e.depth,stencil:e.stencil},i=void 0!==t.context?t.context:e.domElement.getContext("webgl2",n);function r(t){t.preventDefault();const n={api:"WebGL",message:t.statusMessage||"Unknown reason",reason:null,originalEvent:t};e.onDeviceLost(n)}this._onContextLost=r,e.domElement.addEventListener("webglcontextlost",r,!1),this.gl=i,this.extensions=new kB(this),this.capabilities=new OB(this),this.attributeUtils=new EB(this),this.textureUtils=new LB(this),this.bufferRenderer=new FB(this),this.state=new AB(this),this.utils=new CB(this),this.extensions.get("EXT_color_buffer_float"),this.extensions.get("WEBGL_clip_cull_distance"),this.extensions.get("OES_texture_float_linear"),this.extensions.get("EXT_color_buffer_half_float"),this.extensions.get("WEBGL_multisampled_render_to_texture"),this.extensions.get("WEBGL_render_shared_exponent"),this.extensions.get("WEBGL_multi_draw"),this.extensions.get("OVR_multiview2"),this.disjoint=this.extensions.get("EXT_disjoint_timer_query_webgl2"),this.parallel=this.extensions.get("KHR_parallel_shader_compile")}get coordinateSystem(){return gc}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}async waitForGPU(){await this.utils._clientWaitAsync()}async makeXRCompatible(){!0!==this.gl.getContextAttributes().xrCompatible&&await this.gl.makeXRCompatible()}setXRTarget(e){this._xrFramebuffer=e}setXRRenderTargetTextures(e,t,n=null){const i=this.gl;if(this.set(e.texture,{textureGPU:t,glInternalFormat:i.RGBA8}),null!==n){const t=e.stencilBuffer?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT24;this.set(e.depthTexture,{textureGPU:n,glInternalFormat:t}),!0===this.extensions.has("WEBGL_multisampled_render_to_texture")&&!0===e.autoAllocateDepthBuffer&&!1===e.multiview&&console.warn("THREE.WebGLBackend: Render-to-texture extension was disabled because an external texture was provided"),e.autoAllocateDepthBuffer=!1}}initTimestampQuery(e){if(!this.disjoint||!this.trackTimestamp)return;const t=e.isComputeNode?"compute":"render";this.timestampQueryPool[t]||(this.timestampQueryPool[t]=new zB(this.gl,t,2048));const n=this.timestampQueryPool[t];null!==n.allocateQueriesForContext(e)&&n.beginQuery(e)}prepareTimestampBuffer(e){if(!this.disjoint||!this.trackTimestamp)return;const t=e.isComputeNode?"compute":"render";this.timestampQueryPool[t].endQuery(e)}getContext(){return this.gl}beginRender(e){const{state:t}=this,n=this.get(e);if(e.viewport)this.updateViewport(e);else{const{width:e,height:n}=this.getDrawingBufferSize(VB);t.viewport(0,0,e,n)}if(e.scissor){const{x:n,y:i,width:r,height:s}=e.scissorValue;t.scissor(n,e.height-s-i,r,s)}this.initTimestampQuery(e),n.previousContext=this._currentContext,this._currentContext=e,this._setFramebuffer(e),this.clear(e.clearColor,e.clearDepth,e.clearStencil,e,!1);const i=e.occlusionQueryCount;i>0&&(n.currentOcclusionQueries=n.occlusionQueries,n.currentOcclusionQueryObjects=n.occlusionQueryObjects,n.lastOcclusionObject=null,n.occlusionQueries=new Array(i),n.occlusionQueryObjects=new Array(i),n.occlusionQueryIndex=0)}finishRender(e){const{gl:t,state:n}=this,i=this.get(e),r=i.previousContext;n.resetVertexState();const s=e.occlusionQueryCount;s>0&&(s>i.occlusionQueryIndex&&t.endQuery(t.ANY_SAMPLES_PASSED),this.resolveOccludedAsync(e));const o=e.textures;if(null!==o)for(let e=0;e<o.length;e++){const t=o[e];t.generateMipmaps&&this.generateMipmaps(t)}if(this._currentContext=r,null!==e.textures&&e.renderTarget){const i=this.get(e.renderTarget),{resolveDepthBuffer:r,samples:s}=e.renderTarget;if(s>0&&!1===this._useMultisampledExtension(e.renderTarget)){const r=i.framebuffers[e.getCacheKey()],s=t.COLOR_BUFFER_BIT,o=i.msaaFrameBuffer,a=e.textures;n.bindFramebuffer(t.READ_FRAMEBUFFER,o),n.bindFramebuffer(t.DRAW_FRAMEBUFFER,r);for(let n=0;n<a.length;n++)if(e.scissor){const{x:n,y:r,width:o,height:a}=e.scissorValue,l=e.height-a-r;t.blitFramebuffer(n,l,n+o,l+a,n,l,n+o,l+a,s,t.NEAREST),!0===this._supportsInvalidateFramebuffer&&t.invalidateSubFramebuffer(t.READ_FRAMEBUFFER,i.invalidationArray,n,l,o,a)}else t.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s,t.NEAREST),!0===this._supportsInvalidateFramebuffer&&t.invalidateFramebuffer(t.READ_FRAMEBUFFER,i.invalidationArray)}else if(!1===r&&i.framebuffers){const r=i.framebuffers[e.getCacheKey()];n.bindFramebuffer(t.DRAW_FRAMEBUFFER,r),t.invalidateFramebuffer(t.DRAW_FRAMEBUFFER,i.depthInvalidationArray)}}if(null!==r)if(this._setFramebuffer(r),r.viewport)this.updateViewport(r);else{const{width:e,height:t}=this.getDrawingBufferSize(VB);n.viewport(0,0,e,t)}this.prepareTimestampBuffer(e)}resolveOccludedAsync(e){const t=this.get(e),{currentOcclusionQueries:n,currentOcclusionQueryObjects:i}=t;if(n&&i){const e=new WeakSet,{gl:r}=this;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueries=null;const s=()=>{let o=0;for(let t=0;t<n.length;t++){const s=n[t];null!==s&&(r.getQueryParameter(s,r.QUERY_RESULT_AVAILABLE)&&(0===r.getQueryParameter(s,r.QUERY_RESULT)&&e.add(i[t]),n[t]=null,r.deleteQuery(s),o++))}o<n.length?requestAnimationFrame(s):t.occluded=e};s()}}isOccluded(e,t){const n=this.get(e);return n.occluded&&n.occluded.has(t)}updateViewport(e){const{state:t}=this,{x:n,y:i,width:r,height:s}=e.viewportValue;t.viewport(n,e.height-s-i,r,s)}setScissorTest(e){this.state.setScissorTest(e)}getClearColor(){const e=super.getClearColor();return e.r*=e.a,e.g*=e.a,e.b*=e.a,e}clear(e,t,n,i=null,r=!0){const{gl:s,renderer:o}=this;if(null===i){i={textures:null,clearColorValue:this.getClearColor()}}let a=0;if(e&&(a|=s.COLOR_BUFFER_BIT),t&&(a|=s.DEPTH_BUFFER_BIT),n&&(a|=s.STENCIL_BUFFER_BIT),0!==a){let l;l=i.clearColorValue?i.clearColorValue:this.getClearColor();const c=o.getClearDepth(),u=o.getClearStencil();if(t&&this.state.setDepthMask(!0),null===i.textures)s.clearColor(l.r,l.g,l.b,l.a),s.clear(a);else{if(r&&this._setFramebuffer(i),e)for(let e=0;e<i.textures.length;e++)0===e?s.clearBufferfv(s.COLOR,e,[l.r,l.g,l.b,l.a]):s.clearBufferfv(s.COLOR,e,[0,0,0,1]);t&&n?s.clearBufferfi(s.DEPTH_STENCIL,0,c,u):t?s.clearBufferfv(s.DEPTH,0,[c]):n&&s.clearBufferiv(s.STENCIL,0,[u])}}}beginCompute(e){const{state:t,gl:n}=this;t.bindFramebuffer(n.FRAMEBUFFER,null),this.initTimestampQuery(e)}compute(e,t,n,i){const{state:r,gl:s}=this;!1===this.discard&&(s.enable(s.RASTERIZER_DISCARD),this.discard=!0);const{programGPU:o,transformBuffers:a,attributes:l}=this.get(i),c=this._getVaoKey(l),u=this.vaoCache[c];void 0===u?this._createVao(l):r.setVertexState(u),r.useProgram(o),this._bindUniforms(n);const h=this._getTransformFeedback(a);s.bindTransformFeedback(s.TRANSFORM_FEEDBACK,h),s.beginTransformFeedback(s.POINTS),l[0].isStorageInstancedBufferAttribute?s.drawArraysInstanced(s.POINTS,0,1,t.count):s.drawArrays(s.POINTS,0,t.count),s.endTransformFeedback(),s.bindTransformFeedback(s.TRANSFORM_FEEDBACK,null);for(let e=0;e<a.length;e++){const t=a[e];t.pbo&&this.textureUtils.copyBufferToTexture(t.transformBuffer,t.pbo),t.switchBuffers()}}finishCompute(e){const t=this.gl;this.discard=!1,t.disable(t.RASTERIZER_DISCARD),this.prepareTimestampBuffer(e),this._currentContext&&this._setFramebuffer(this._currentContext)}_isRenderCameraDepthArray(e){return e.depthTexture&&e.depthTexture.isArrayTexture&&e.camera.isArrayCamera}draw(e){const{object:t,pipeline:n,material:i,context:r,hardwareClippingPlanes:s}=e,{programGPU:o}=this.get(n),{gl:a,state:l}=this,c=this.get(r),u=e.getDrawParameters();if(null===u)return;this._bindUniforms(e.getBindings());const h=t.isMesh&&t.matrixWorld.determinant()<0;l.setMaterial(i,h,s),l.useProgram(o);const d=this.get(e);let p=d.staticVao;if(void 0===p||d.geometryId!==e.geometry.id){const t=this._getVaoKey(e.getAttributes());if(p=this.vaoCache[t],void 0===p){let t;({vaoGPU:p,staticVao:t}=this._createVao(e.getAttributes())),t&&(d.staticVao=p,d.geometryId=e.geometry.id)}}const f=e.getIndex(),m=null!==f?this.get(f).bufferGPU:null;l.setVertexState(p,m);const g=c.lastOcclusionObject;if(g!==t&&void 0!==g){if(null!==g&&!0===g.occlusionTest&&(a.endQuery(a.ANY_SAMPLES_PASSED),c.occlusionQueryIndex++),!0===t.occlusionTest){const e=a.createQuery();a.beginQuery(a.ANY_SAMPLES_PASSED,e),c.occlusionQueries[c.occlusionQueryIndex]=e,c.occlusionQueryObjects[c.occlusionQueryIndex]=t}c.lastOcclusionObject=t}const y=this.bufferRenderer;t.isPoints?y.mode=a.POINTS:t.isLineSegments?y.mode=a.LINES:t.isLine?y.mode=a.LINE_STRIP:t.isLineLoop?y.mode=a.LINE_LOOP:!0===i.wireframe?(l.setLineWidth(i.wireframeLinewidth*this.renderer.getPixelRatio()),y.mode=a.LINES):y.mode=a.TRIANGLES;const{vertexCount:v,instanceCount:_}=u;let{firstVertex:x}=u;if(y.object=t,null!==f){x*=f.array.BYTES_PER_ELEMENT;const e=this.get(f);y.index=f.count,y.type=e.type}else y.index=0;const b=()=>{t.isBatchedMesh?null!==t._multiDrawInstances?(Vc("THREE.WebGLBackend: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),y.renderMultiDrawInstances(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount,t._multiDrawInstances)):this.hasFeature("WEBGL_multi_draw")?y.renderMultiDraw(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount):Vc("THREE.WebGLRenderer: WEBGL_multi_draw not supported."):_>1?y.renderInstances(x,v,_):y.render(x,v)};if(!0===e.camera.isArrayCamera&&e.camera.cameras.length>0&&!1===e.camera.isMultiViewCamera){const n=this.get(e.camera),i=e.camera.cameras,r=e.getBindingGroup("cameraIndex").bindings[0];if(void 0===n.indexesGPU||n.indexesGPU.length!==i.length){const e=new Uint32Array([0,0,0,0]),t=[];for(let n=0,r=i.length;n<r;n++){const i=a.createBuffer();e[0]=n,a.bindBuffer(a.UNIFORM_BUFFER,i),a.bufferData(a.UNIFORM_BUFFER,e,a.STATIC_DRAW),t.push(i)}n.indexesGPU=t}const s=this.get(r),o=this.renderer.getPixelRatio(),c=this._currentContext.renderTarget,u=this._isRenderCameraDepthArray(this._currentContext),h=this._currentContext.activeCubeFace;if(u){const e=this.get(c.depthTexture);if(e.clearedRenderId!==this.renderer._nodes.nodeFrame.renderId){e.clearedRenderId=this.renderer._nodes.nodeFrame.renderId;const{stencilBuffer:t}=c;for(let e=0,n=i.length;e<n;e++)this.renderer._activeCubeFace=e,this._currentContext.activeCubeFace=e,this._setFramebuffer(this._currentContext),this.clear(!1,!0,t,this._currentContext,!1);this.renderer._activeCubeFace=h,this._currentContext.activeCubeFace=h}}for(let r=0,c=i.length;r<c;r++){const c=i[r];if(t.layers.test(c.layers)){u&&(this.renderer._activeCubeFace=r,this._currentContext.activeCubeFace=r,this._setFramebuffer(this._currentContext));const t=c.viewport;if(void 0!==t){const n=t.x*o,i=t.y*o,r=t.width*o,s=t.height*o;l.viewport(Math.floor(n),Math.floor(e.context.height-s-i),Math.floor(r),Math.floor(s))}l.bindBufferBase(a.UNIFORM_BUFFER,s.index,n.indexesGPU[r]),b()}this._currentContext.activeCubeFace=h,this.renderer._activeCubeFace=h}}else b()}needsRenderUpdate(){return!1}getRenderCacheKey(){return""}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}async copyTextureToBuffer(e,t,n,i,r,s){return this.textureUtils.copyTextureToBuffer(e,t,n,i,r,s)}createSampler(){}destroySampler(){}createNodeBuilder(e,t){return new vB(e,t)}createProgram(e){const t=this.gl,{stage:n,code:i}=e,r="fragment"===n?t.createShader(t.FRAGMENT_SHADER):t.createShader(t.VERTEX_SHADER);t.shaderSource(r,i),t.compileShader(r),this.set(e,{shaderGPU:r})}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){const n=this.gl,i=e.pipeline,{fragmentProgram:r,vertexProgram:s}=i,o=n.createProgram(),a=this.get(r).shaderGPU,l=this.get(s).shaderGPU;if(n.attachShader(o,a),n.attachShader(o,l),n.linkProgram(o),this.set(i,{programGPU:o,fragmentShader:a,vertexShader:l}),null!==t&&this.parallel){const r=new Promise((t=>{const r=this.parallel,s=()=>{n.getProgramParameter(o,r.COMPLETION_STATUS_KHR)?(this._completeCompile(e,i),t()):requestAnimationFrame(s)};s()}));t.push(r)}else this._completeCompile(e,i)}_handleSource(e,t){const n=e.split("\n"),i=[],r=Math.max(t-6,0),s=Math.min(t+6,n.length);for(let e=r;e<s;e++){const r=e+1;i.push(`${r===t?">":" "} ${r}: ${n[e]}`)}return i.join("\n")}_getShaderErrors(e,t,n){const i=e.getShaderParameter(t,e.COMPILE_STATUS),r=e.getShaderInfoLog(t).trim();if(i&&""===r)return"";const s=/ERROR: 0:(\d+)/.exec(r);if(s){const i=parseInt(s[1]);return n.toUpperCase()+"\n\n"+r+"\n\n"+this._handleSource(e.getShaderSource(t),i)}return r}_logProgramError(e,t,n){if(this.renderer.debug.checkShaderErrors){const i=this.gl,r=i.getProgramInfoLog(e).trim();if(!1===i.getProgramParameter(e,i.LINK_STATUS))if("function"==typeof this.renderer.debug.onShaderError)this.renderer.debug.onShaderError(i,e,n,t);else{const s=this._getShaderErrors(i,n,"vertex"),o=this._getShaderErrors(i,t,"fragment");console.error("THREE.WebGLProgram: Shader Error "+i.getError()+" - VALIDATE_STATUS "+i.getProgramParameter(e,i.VALIDATE_STATUS)+"\n\nProgram Info Log: "+r+"\n"+s+"\n"+o)}else""!==r&&console.warn("THREE.WebGLProgram: Program Info Log:",r)}}_completeCompile(e,t){const{state:n,gl:i}=this,r=this.get(t),{programGPU:s,fragmentShader:o,vertexShader:a}=r;!1===i.getProgramParameter(s,i.LINK_STATUS)&&this._logProgramError(s,o,a),n.useProgram(s);const l=e.getBindings();this._setupBindings(l,s),this.set(t,{programGPU:s})}createComputePipeline(e,t){const{state:n,gl:i}=this,r={stage:"fragment",code:"#version 300 es\nprecision highp float;\nvoid main() {}"};this.createProgram(r);const{computeProgram:s}=e,o=i.createProgram(),a=this.get(r).shaderGPU,l=this.get(s).shaderGPU,c=s.transforms,u=[],h=[];for(let e=0;e<c.length;e++){const t=c[e];u.push(t.varyingName),h.push(t.attributeNode)}i.attachShader(o,a),i.attachShader(o,l),i.transformFeedbackVaryings(o,u,i.SEPARATE_ATTRIBS),i.linkProgram(o),!1===i.getProgramParameter(o,i.LINK_STATUS)&&this._logProgramError(o,a,l),n.useProgram(o),this._setupBindings(t,o);const d=s.attributes,p=[],f=[];for(let e=0;e<d.length;e++){const t=d[e].node.attribute;p.push(t),this.has(t)||this.attributeUtils.createAttribute(t,i.ARRAY_BUFFER)}for(let e=0;e<h.length;e++){const t=h[e].attribute;this.has(t)||this.attributeUtils.createAttribute(t,i.ARRAY_BUFFER);const n=this.get(t);f.push(n)}this.set(e,{programGPU:o,transformBuffers:f,attributes:p})}createBindings(e,t){if(!1===this._knownBindings.has(t)){this._knownBindings.add(t);let e=0,n=0;for(const i of t){this.set(i,{textures:n,uniformBuffers:e});for(const t of i.bindings)t.isUniformBuffer&&e++,t.isSampledTexture&&n++}}this.updateBindings(e,t)}updateBindings(e){const{gl:t}=this,n=this.get(e);let i=n.uniformBuffers,r=n.textures;for(const n of e.bindings)if(n.isUniformsGroup||n.isUniformBuffer){const e=n.buffer,r=t.createBuffer();t.bindBuffer(t.UNIFORM_BUFFER,r),t.bufferData(t.UNIFORM_BUFFER,e,t.DYNAMIC_DRAW),this.set(n,{index:i++,bufferGPU:r})}else if(n.isSampledTexture){const{textureGPU:e,glTextureType:t}=this.get(n.texture);this.set(n,{index:r++,textureGPU:e,glTextureType:t})}}updateBinding(e){const t=this.gl;if(e.isUniformsGroup||e.isUniformBuffer){const n=this.get(e).bufferGPU,i=e.buffer;t.bindBuffer(t.UNIFORM_BUFFER,n),t.bufferData(t.UNIFORM_BUFFER,i,t.DYNAMIC_DRAW)}}createIndexAttribute(e){const t=this.gl;this.attributeUtils.createAttribute(e,t.ELEMENT_ARRAY_BUFFER)}createAttribute(e){if(this.has(e))return;const t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}createStorageAttribute(e){if(this.has(e))return;const t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}hasFeature(e){const t=Object.keys(UB).filter((t=>UB[t]===e)),n=this.extensions;for(let e=0;e<t.length;e++)if(n.has(t[e]))return!0;return!1}getMaxAnisotropy(){return this.capabilities.getMaxAnisotropy()}copyTextureToTexture(e,t,n=null,i=null,r=0,s=0){this.textureUtils.copyTextureToTexture(e,t,n,i,r,s)}copyFramebufferToTexture(e,t,n){this.textureUtils.copyFramebufferToTexture(e,t,n)}_setFramebuffer(e){const{gl:t,state:n}=this;let i=null;if(null!==e.textures){const r=e.renderTarget,s=this.get(r),{samples:o,depthBuffer:a,stencilBuffer:l}=r,c=!0===r.isWebGLCubeRenderTarget,u=!0===r.isRenderTarget3D,h=r.depth>1,d=!0===r.isXRRenderTarget,p=!0===d&&!0===r.hasExternalTextures;let f=s.msaaFrameBuffer,m=s.depthRenderbuffer;const g=this.extensions.get("WEBGL_multisampled_render_to_texture"),y=this.extensions.get("OVR_multiview2"),v=this._useMultisampledExtension(r),_=Gk(e);let x;if(c?(s.cubeFramebuffers||(s.cubeFramebuffers={}),x=s.cubeFramebuffers[_]):d&&!1===p?x=this._xrFramebuffer:(s.framebuffers||(s.framebuffers={}),x=s.framebuffers[_]),void 0===x){x=t.createFramebuffer(),n.bindFramebuffer(t.FRAMEBUFFER,x);const i=e.textures,a=[];if(c){s.cubeFramebuffers[_]=x;const{textureGPU:e}=this.get(i[0]),n=this.renderer._activeCubeFace;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+n,e,0)}else{s.framebuffers[_]=x;for(let n=0;n<i.length;n++){const s=i[n],a=this.get(s);a.renderTarget=e.renderTarget,a.cacheKey=_;const l=t.COLOR_ATTACHMENT0+n;if(r.multiview)y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,l,a.textureGPU,0,o,0,2);else if(u||h){const e=this.renderer._activeCubeFace;t.framebufferTextureLayer(t.FRAMEBUFFER,l,a.textureGPU,0,e)}else v?g.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,l,t.TEXTURE_2D,a.textureGPU,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,l,t.TEXTURE_2D,a.textureGPU,0)}n.drawBuffers(e,x)}const d=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;if(!0===r.autoAllocateDepthBuffer){const n=t.createRenderbuffer();this.textureUtils.setupRenderBufferStorage(n,e,0,v),s.xrDepthRenderbuffer=n,a.push(l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT),t.bindRenderbuffer(t.RENDERBUFFER,n),t.framebufferRenderbuffer(t.FRAMEBUFFER,d,t.RENDERBUFFER,n)}else if(null!==e.depthTexture){a.push(l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT);const n=this.get(e.depthTexture);if(n.renderTarget=e.renderTarget,n.cacheKey=_,r.multiview)y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,d,n.textureGPU,0,o,0,2);else if(p&&v)g.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,d,t.TEXTURE_2D,n.textureGPU,0,o);else if(e.depthTexture.isArrayTexture){const e=this.renderer._activeCubeFace;t.framebufferTextureLayer(t.FRAMEBUFFER,d,n.textureGPU,0,e)}else t.framebufferTexture2D(t.FRAMEBUFFER,d,t.TEXTURE_2D,n.textureGPU,0)}s.depthInvalidationArray=a}else{if(this._isRenderCameraDepthArray(e)){n.bindFramebuffer(t.FRAMEBUFFER,x);const i=this.renderer._activeCubeFace,r=this.get(e.depthTexture),s=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;t.framebufferTextureLayer(t.FRAMEBUFFER,s,r.textureGPU,0,i)}if(d||v||r.multiview){n.bindFramebuffer(t.FRAMEBUFFER,x);const i=this.get(e.textures[0]);r.multiview?y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,i.textureGPU,0,o,0,2):v?g.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i.textureGPU,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i.textureGPU,0);const a=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;if(!0===r.autoAllocateDepthBuffer){const e=s.xrDepthRenderbuffer;t.bindRenderbuffer(t.RENDERBUFFER,e),t.framebufferRenderbuffer(t.FRAMEBUFFER,a,t.RENDERBUFFER,e)}else{const n=this.get(e.depthTexture);r.multiview?y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,a,n.textureGPU,0,o,0,2):v?g.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,a,t.TEXTURE_2D,n.textureGPU,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,a,t.TEXTURE_2D,n.textureGPU,0)}}}if(o>0&&!1===v&&!r.multiview){if(void 0===f){const i=[];f=t.createFramebuffer(),n.bindFramebuffer(t.FRAMEBUFFER,f);const r=[],c=e.textures;for(let n=0;n<c.length;n++){if(r[n]=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,r[n]),i.push(t.COLOR_ATTACHMENT0+n),a){const e=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;i.push(e)}const s=e.textures[n],c=this.get(s);t.renderbufferStorageMultisample(t.RENDERBUFFER,o,c.glInternalFormat,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+n,t.RENDERBUFFER,r[n])}if(s.msaaFrameBuffer=f,s.msaaRenderbuffers=r,void 0===m){m=t.createRenderbuffer(),this.textureUtils.setupRenderBufferStorage(m,e,o),s.depthRenderbuffer=m;const n=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;i.push(n)}s.invalidationArray=i}i=s.msaaFrameBuffer}else i=x}n.bindFramebuffer(t.FRAMEBUFFER,i)}_getVaoKey(e){let t="";for(let n=0;n<e.length;n++){t+=":"+this.get(e[n]).id}return t}_createVao(e){const{gl:t}=this,n=t.createVertexArray();let i="",r=!0;t.bindVertexArray(n);for(let n=0;n<e.length;n++){const s=e[n],o=this.get(s);let a,l;i+=":"+o.id,t.bindBuffer(t.ARRAY_BUFFER,o.bufferGPU),t.enableVertexAttribArray(n),(s.isStorageBufferAttribute||s.isStorageInstancedBufferAttribute)&&(r=!1),!0===s.isInterleavedBufferAttribute?(a=s.data.stride*o.bytesPerElement,l=s.offset*o.bytesPerElement):(a=0,l=0),o.isInteger?t.vertexAttribIPointer(n,s.itemSize,o.type,a,l):t.vertexAttribPointer(n,s.itemSize,o.type,s.normalized,a,l),s.isInstancedBufferAttribute&&!s.isInterleavedBufferAttribute?t.vertexAttribDivisor(n,s.meshPerAttribute):s.isInterleavedBufferAttribute&&s.data.isInstancedInterleavedBuffer&&t.vertexAttribDivisor(n,s.data.meshPerAttribute)}return t.bindBuffer(t.ARRAY_BUFFER,null),this.vaoCache[i]=n,{vaoGPU:n,staticVao:r}}_getTransformFeedback(e){let t="";for(let n=0;n<e.length;n++)t+=":"+e[n].id;let n=this.transformFeedbackCache[t];if(void 0!==n)return n;const{gl:i}=this;n=i.createTransformFeedback(),i.bindTransformFeedback(i.TRANSFORM_FEEDBACK,n);for(let t=0;t<e.length;t++){const n=e[t];i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,t,n.transformBuffer)}return i.bindTransformFeedback(i.TRANSFORM_FEEDBACK,null),this.transformFeedbackCache[t]=n,n}_setupBindings(e,t){const n=this.gl;for(const i of e)for(const e of i.bindings){const i=this.get(e).index;if(e.isUniformsGroup||e.isUniformBuffer){const r=n.getUniformBlockIndex(t,e.name);n.uniformBlockBinding(t,r,i)}else if(e.isSampledTexture){const r=n.getUniformLocation(t,e.name);n.uniform1i(r,i)}}}_bindUniforms(e){const{gl:t,state:n}=this;for(const i of e)for(const e of i.bindings){const i=this.get(e),r=i.index;e.isUniformsGroup||e.isUniformBuffer?n.bindBufferBase(t.UNIFORM_BUFFER,r,i.bufferGPU):e.isSampledTexture&&n.bindTexture(i.glTextureType,i.textureGPU,t.TEXTURE0+r)}}_useMultisampledExtension(e){return!0===e.multiview||e.samples>0&&!0===this.extensions.has("WEBGL_multisampled_render_to_texture")&&!1!==e.autoAllocateDepthBuffer}dispose(){const e=this.extensions.get("WEBGL_lose_context");e&&e.loseContext(),this.renderer.domElement.removeEventListener("webglcontextlost",this._onContextLost)}}const jB="point-list",HB="line-list",WB="line-strip",qB="triangle-list",XB="triangle-strip",$B="never",YB="less",KB="equal",ZB="less-equal",JB="greater",QB="not-equal",ez="greater-equal",tz="always",nz="store",iz="load",rz="clear",sz="ccw",oz="none",az="front",lz="back",cz="uint16",uz="uint32",hz="r8unorm",dz="r8snorm",pz="r8uint",fz="r8sint",mz="r16uint",gz="r16sint",yz="r16float",vz="rg8unorm",_z="rg8snorm",xz="rg8uint",bz="rg8sint",wz="r32uint",Tz="r32sint",Sz="r32float",Mz="rg16uint",Ez="rg16sint",Az="rg16float",Cz="rgba8unorm",Rz="rgba8unorm-srgb",Nz="rgba8snorm",Pz="rgba8uint",Dz="rgba8sint",Lz="bgra8unorm",Iz="bgra8unorm-srgb",kz="rgb9e5ufloat",Oz="rgb10a2unorm",Uz="rgb10a2unorm",Fz="rg32uint",Bz="rg32sint",zz="rg32float",Vz="rgba16uint",Gz="rgba16sint",jz="rgba16float",Hz="rgba32uint",Wz="rgba32sint",qz="rgba32float",Xz="depth16unorm",$z="depth24plus",Yz="depth24plus-stencil8",Kz="depth32float",Zz="depth32float-stencil8",Jz="bc1-rgba-unorm",Qz="bc1-rgba-unorm-srgb",eV="bc2-rgba-unorm",tV="bc2-rgba-unorm-srgb",nV="bc3-rgba-unorm",iV="bc3-rgba-unorm-srgb",rV="bc4-r-unorm",sV="bc4-r-snorm",oV="bc5-rg-unorm",aV="bc5-rg-snorm",lV="bc6h-rgb-ufloat",cV="bc6h-rgb-float",uV="bc7-rgba-unorm",hV="bc7-rgba-srgb",dV="etc2-rgb8unorm",pV="etc2-rgb8unorm-srgb",fV="etc2-rgb8a1unorm",mV="etc2-rgb8a1unorm-srgb",gV="etc2-rgba8unorm",yV="etc2-rgba8unorm-srgb",vV="eac-r11unorm",_V="eac-r11snorm",xV="eac-rg11unorm",bV="eac-rg11snorm",wV="astc-4x4-unorm",TV="astc-4x4-unorm-srgb",SV="astc-5x4-unorm",MV="astc-5x4-unorm-srgb",EV="astc-5x5-unorm",AV="astc-5x5-unorm-srgb",CV="astc-6x5-unorm",RV="astc-6x5-unorm-srgb",NV="astc-6x6-unorm",PV="astc-6x6-unorm-srgb",DV="astc-8x5-unorm",LV="astc-8x5-unorm-srgb",IV="astc-8x6-unorm",kV="astc-8x6-unorm-srgb",OV="astc-8x8-unorm",UV="astc-8x8-unorm-srgb",FV="astc-10x5-unorm",BV="astc-10x5-unorm-srgb",zV="astc-10x6-unorm",VV="astc-10x6-unorm-srgb",GV="astc-10x8-unorm",jV="astc-10x8-unorm-srgb",HV="astc-10x10-unorm",WV="astc-10x10-unorm-srgb",qV="astc-12x10-unorm",XV="astc-12x10-unorm-srgb",$V="astc-12x12-unorm",YV="astc-12x12-unorm-srgb",KV="clamp-to-edge",ZV="repeat",JV="mirror-repeat",QV="linear",eG="nearest",tG="zero",nG="one",iG="src",rG="one-minus-src",sG="src-alpha",oG="one-minus-src-alpha",aG="dst",lG="one-minus-dst",cG="dst-alpha",uG="one-minus-dst-alpha",hG="src-alpha-saturated",dG="constant",pG="one-minus-constant",fG="add",mG="subtract",gG="reverse-subtract",yG="min",vG="max",_G=0,xG=15,bG="keep",wG="zero",TG="replace",SG="invert",MG="increment-clamp",EG="decrement-clamp",AG="increment-wrap",CG="decrement-wrap",RG="storage",NG="read-only-storage",PG="write-only",DG="read-only",LG="read-write",IG="non-filtering",kG="comparison",OG="float",UG="unfilterable-float",FG="depth",BG="sint",zG="uint",VG="2d",GG="3d",jG="2d",HG="2d-array",WG="cube",qG="3d",XG="all",$G="vertex",YG="instance",KG={DepthClipControl:"depth-clip-control",Depth32FloatStencil8:"depth32float-stencil8",TextureCompressionBC:"texture-compression-bc",TextureCompressionETC2:"texture-compression-etc2",TextureCompressionASTC:"texture-compression-astc",TimestampQuery:"timestamp-query",IndirectFirstInstance:"indirect-first-instance",ShaderF16:"shader-f16",RG11B10UFloat:"rg11b10ufloat-renderable",BGRA8UNormStorage:"bgra8unorm-storage",Float32Filterable:"float32-filterable",ClipDistances:"clip-distances",DualSourceBlending:"dual-source-blending",Subgroups:"subgroups"};class ZG extends QF{constructor(e,t){super(e),this.texture=t,this.version=t?t.version:0,this.isSampler=!0}}class JG extends ZG{constructor(e,t,n){super(e,t?t.value:null),this.textureNode=t,this.groupNode=n}update(){this.texture=this.textureNode.value}}class QG extends eB{constructor(e,t){super(e,t?t.array:null),this.attribute=t,this.isStorageBuffer=!0}}let ej=0;class tj extends QG{constructor(e,t){super("StorageBuffer_"+ej++,e?e.value:null),this.nodeUniform=e,this.access=e?e.access:ZS,this.groupNode=t}get buffer(){return this.nodeUniform.value}}class nj extends gk{constructor(e){super(),this.device=e;this.mipmapSampler=e.createSampler({minFilter:QV}),this.flipYSampler=e.createSampler({minFilter:eG}),this.transferPipelines={},this.flipYPipelines={},this.mipmapVertexShaderModule=e.createShaderModule({label:"mipmapVertex",code:"\nstruct VarysStruct {\n\t@builtin( position ) Position: vec4<f32>,\n\t@location( 0 ) vTex : vec2<f32>\n};\n\n@vertex\nfn main( @builtin( vertex_index ) vertexIndex : u32 ) -> VarysStruct {\n\n\tvar Varys : VarysStruct;\n\n\tvar pos = array< vec2<f32>, 4 >(\n\t\tvec2<f32>( -1.0,  1.0 ),\n\t\tvec2<f32>(  1.0,  1.0 ),\n\t\tvec2<f32>( -1.0, -1.0 ),\n\t\tvec2<f32>(  1.0, -1.0 )\n\t);\n\n\tvar tex = array< vec2<f32>, 4 >(\n\t\tvec2<f32>( 0.0, 0.0 ),\n\t\tvec2<f32>( 1.0, 0.0 ),\n\t\tvec2<f32>( 0.0, 1.0 ),\n\t\tvec2<f32>( 1.0, 1.0 )\n\t);\n\n\tVarys.vTex = tex[ vertexIndex ];\n\tVarys.Position = vec4<f32>( pos[ vertexIndex ], 0.0, 1.0 );\n\n\treturn Varys;\n\n}\n"}),this.mipmapFragmentShaderModule=e.createShaderModule({label:"mipmapFragment",code:"\n@group( 0 ) @binding( 0 )\nvar imgSampler : sampler;\n\n@group( 0 ) @binding( 1 )\nvar img : texture_2d<f32>;\n\n@fragment\nfn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {\n\n\treturn textureSample( img, imgSampler, vTex );\n\n}\n"}),this.flipYFragmentShaderModule=e.createShaderModule({label:"flipYFragment",code:"\n@group( 0 ) @binding( 0 )\nvar imgSampler : sampler;\n\n@group( 0 ) @binding( 1 )\nvar img : texture_2d<f32>;\n\n@fragment\nfn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {\n\n\treturn textureSample( img, imgSampler, vec2( vTex.x, 1.0 - vTex.y ) );\n\n}\n"})}getTransferPipeline(e){let t=this.transferPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({label:`mipmap-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.mipmapFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:XB,stripIndexFormat:uz},layout:"auto"}),this.transferPipelines[e]=t),t}getFlipYPipeline(e){let t=this.flipYPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({label:`flipY-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.flipYFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:XB,stripIndexFormat:uz},layout:"auto"}),this.flipYPipelines[e]=t),t}flipY(e,t,n=0){const i=t.format,{width:r,height:s}=t.size,o=this.getTransferPipeline(i),a=this.getFlipYPipeline(i),l=this.device.createTexture({size:{width:r,height:s,depthOrArrayLayers:1},format:i,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),c=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:jG,baseArrayLayer:n}),u=l.createView({baseMipLevel:0,mipLevelCount:1,dimension:jG,baseArrayLayer:0}),h=this.device.createCommandEncoder({}),d=(e,t,n)=>{const i=e.getBindGroupLayout(0),r=this.device.createBindGroup({layout:i,entries:[{binding:0,resource:this.flipYSampler},{binding:1,resource:t}]}),s=h.beginRenderPass({colorAttachments:[{view:n,loadOp:rz,storeOp:nz,clearValue:[0,0,0,0]}]});s.setPipeline(e),s.setBindGroup(0,r),s.draw(4,1,0,0),s.end()};d(o,c,u),d(a,u,c),this.device.queue.submit([h.finish()]),l.destroy()}generateMipmaps(e,t,n=0){const i=this.get(e);void 0===i.useCount&&(i.useCount=0,i.layers=[]);const r=i.layers[n]||this._mipmapCreateBundles(e,t,n),s=this.device.createCommandEncoder({});this._mipmapRunBundles(s,r),this.device.queue.submit([s.finish()]),0!==i.useCount&&(i.layers[n]=r),i.useCount++}_mipmapCreateBundles(e,t,n){const i=this.getTransferPipeline(t.format),r=i.getBindGroupLayout(0);let s=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:jG,baseArrayLayer:n});const o=[];for(let a=1;a<t.mipLevelCount;a++){const l=this.device.createBindGroup({layout:r,entries:[{binding:0,resource:this.mipmapSampler},{binding:1,resource:s}]}),c=e.createView({baseMipLevel:a,mipLevelCount:1,dimension:jG,baseArrayLayer:n}),u={colorAttachments:[{view:c,loadOp:rz,storeOp:nz,clearValue:[0,0,0,0]}]},h=this.device.createRenderBundleEncoder({colorFormats:[t.format]});h.setPipeline(i),h.setBindGroup(0,l),h.draw(4,1,0,0),o.push({renderBundles:[h.finish()],passDescriptor:u}),s=c}return o}_mipmapRunBundles(e,t){const n=t.length;for(let i=0;i<n;i++){const n=t[i],r=e.beginRenderPass(n.passDescriptor);r.executeBundles(n.renderBundles),r.end()}}}const ij={[sc]:"never",[oc]:"less",[ac]:"equal",[lc]:"less-equal",[cc]:"greater",[hc]:"greater-equal",[dc]:"always",[uc]:"not-equal"},rj=[0,1,3,2,4,5];class sj{constructor(e){this.backend=e,this._passUtils=null,this.defaultTexture={},this.defaultCubeTexture={},this.defaultVideoFrame=null,this.colorBuffer=null,this.depthTexture=new ip,this.depthTexture.name="depthBuffer"}createSampler(e){const t=this.backend,n=t.device,i=t.get(e),r={addressModeU:this._convertAddressMode(e.wrapS),addressModeV:this._convertAddressMode(e.wrapT),addressModeW:this._convertAddressMode(e.wrapR),magFilter:this._convertFilterMode(e.magFilter),minFilter:this._convertFilterMode(e.minFilter),mipmapFilter:this._convertFilterMode(e.minFilter),maxAnisotropy:1};r.magFilter===QV&&r.minFilter===QV&&r.mipmapFilter===QV&&(r.maxAnisotropy=e.anisotropy),e.isDepthTexture&&null!==e.compareFunction&&(r.compare=ij[e.compareFunction]),i.sampler=n.createSampler(r)}createDefaultTexture(e){let t;const n=oj(e);e.isCubeTexture?t=this._getDefaultCubeTextureGPU(n):e.isVideoTexture?this.backend.get(e).externalTexture=this._getDefaultVideoFrame():t=this._getDefaultTextureGPU(n),this.backend.get(e).texture=t}createTexture(e,t={}){const n=this.backend,i=n.get(e);if(i.initialized)throw new Error("WebGPUTextureUtils: Texture already initialized.");void 0===t.needsMipmaps&&(t.needsMipmaps=!1),void 0===t.levels&&(t.levels=1),void 0===t.depth&&(t.depth=1);const{width:r,height:s,depth:o,levels:a}=t;e.isFramebufferTexture&&(t.renderTarget?t.format=this.backend.utils.getCurrentColorFormat(t.renderTarget):t.format=this.backend.utils.getPreferredCanvasFormat());const l=this._getDimension(e),c=e.internalFormat||t.format||oj(e,n.device);i.format=c;const{samples:u,primarySamples:h,isMSAA:d}=n.utils.getTextureSampleData(e);let p=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC;!0===e.isStorageTexture&&(p|=GPUTextureUsage.STORAGE_BINDING),!0!==e.isCompressedTexture&&!0!==e.isCompressedArrayTexture&&(p|=GPUTextureUsage.RENDER_ATTACHMENT);const f={label:e.name,size:{width:r,height:s,depthOrArrayLayers:o},mipLevelCount:a,sampleCount:h,dimension:l,format:c,usage:p};if(e.isVideoTexture){const t=e.source.data,n=new VideoFrame(t);f.size.width=n.displayWidth,f.size.height=n.displayHeight,n.close(),i.externalTexture=t}else{if(void 0===c)return console.warn("WebGPURenderer: Texture format not supported."),void this.createDefaultTexture(e);e.isCubeTexture&&(f.textureBindingViewDimension=WG),i.texture=n.device.createTexture(f)}if(d){const e=Object.assign({},f);e.label=e.label+"-msaa",e.sampleCount=u,i.msaaTexture=n.device.createTexture(e)}i.initialized=!0,i.textureDescriptorGPU=f}destroyTexture(e){const t=this.backend,n=t.get(e);void 0!==n.texture&&n.texture.destroy(),void 0!==n.msaaTexture&&n.msaaTexture.destroy(),t.delete(e)}destroySampler(e){delete this.backend.get(e).sampler}generateMipmaps(e){const t=this.backend.get(e);if(e.isCubeTexture)for(let e=0;e<6;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e);else{const n=e.image.depth||1;for(let e=0;e<n;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e)}}getColorBuffer(){this.colorBuffer&&this.colorBuffer.destroy();const e=this.backend,{width:t,height:n}=e.getDrawingBufferSize();return this.colorBuffer=e.device.createTexture({label:"colorBuffer",size:{width:t,height:n,depthOrArrayLayers:1},sampleCount:e.utils.getSampleCount(e.renderer.samples),format:e.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),this.colorBuffer}getDepthBuffer(e=!0,t=!1){const n=this.backend,{width:i,height:r}=n.getDrawingBufferSize(),s=this.depthTexture,o=n.get(s).texture;let a,l;if(t?(a=ml,l=cl):e&&(a=fl,l=rl),void 0!==o){if(s.image.width===i&&s.image.height===r&&s.format===a&&s.type===l)return o;this.destroyTexture(s)}return s.name="depthBuffer",s.format=a,s.type=l,s.image.width=i,s.image.height=r,this.createTexture(s,{width:i,height:r}),n.get(s).texture}updateTexture(e,t){const n=this.backend.get(e),{textureDescriptorGPU:i}=n;if(!e.isRenderTargetTexture&&void 0!==i){if(e.isDataTexture)this._copyBufferToTexture(t.image,n.texture,i,0,e.flipY);else if(e.isArrayTexture||e.isDataArrayTexture||e.isData3DTexture)for(let r=0;r<t.image.depth;r++)this._copyBufferToTexture(t.image,n.texture,i,r,e.flipY,r);else if(e.isCompressedTexture||e.isCompressedArrayTexture)this._copyCompressedBufferToTexture(e.mipmaps,n.texture,i);else if(e.isCubeTexture)this._copyCubeMapToTexture(t.images,n.texture,i,e.flipY,e.premultiplyAlpha);else if(e.isVideoTexture){const t=e.source.data;n.externalTexture=t}else this._copyImageToTexture(t.image,n.texture,i,0,e.flipY,e.premultiplyAlpha);n.version=e.version,e.onUpdate&&e.onUpdate(e)}}async copyTextureToBuffer(e,t,n,i,r,s){const o=this.backend.device,a=this.backend.get(e),l=a.texture,c=a.textureDescriptorGPU.format,u=this._getBytesPerTexel(c);let h=i*u;h=256*Math.ceil(h/256);const d=o.createBuffer({size:i*r*u,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),p=o.createCommandEncoder();p.copyTextureToBuffer({texture:l,origin:{x:t,y:n,z:s}},{buffer:d,bytesPerRow:h},{width:i,height:r});const f=this._getTypedArrayType(c);o.queue.submit([p.finish()]),await d.mapAsync(GPUMapMode.READ);return new f(d.getMappedRange())}_getDefaultTextureGPU(e){let t=this.defaultTexture[e];if(void 0===t){const n=new tu;n.minFilter=Xa,n.magFilter=Xa,this.createTexture(n,{width:1,height:1,format:e}),this.defaultTexture[e]=t=n}return this.backend.get(t).texture}_getDefaultCubeTextureGPU(e){let t=this.defaultTexture[e];if(void 0===t){const n=new Td;n.minFilter=Xa,n.magFilter=Xa,this.createTexture(n,{width:1,height:1,depth:6}),this.defaultCubeTexture[e]=t=n}return this.backend.get(t).texture}_getDefaultVideoFrame(){let e=this.defaultVideoFrame;if(null===e){const t={timestamp:0,codedWidth:1,codedHeight:1,format:"RGBA"};this.defaultVideoFrame=e=new VideoFrame(new Uint8Array([0,0,0,255]),t)}return e}_copyCubeMapToTexture(e,t,n,i,r){for(let s=0;s<6;s++){const o=e[s],a=!0===i?rj[s]:s;o.isDataTexture?this._copyBufferToTexture(o.image,t,n,a,i):this._copyImageToTexture(o,t,n,a,i,r)}}_copyImageToTexture(e,t,n,i,r,s){this.backend.device.queue.copyExternalImageToTexture({source:e,flipY:r},{texture:t,mipLevel:0,origin:{x:0,y:0,z:i},premultipliedAlpha:s},{width:e.width,height:e.height,depthOrArrayLayers:1})}_getPassUtils(){let e=this._passUtils;return null===e&&(this._passUtils=e=new nj(this.backend.device)),e}_generateMipmaps(e,t,n=0){this._getPassUtils().generateMipmaps(e,t,n)}_flipY(e,t,n=0){this._getPassUtils().flipY(e,t,n)}_copyBufferToTexture(e,t,n,i,r,s=0){const o=this.backend.device,a=e.data,l=this._getBytesPerTexel(n.format),c=e.width*l;o.queue.writeTexture({texture:t,mipLevel:0,origin:{x:0,y:0,z:i}},a,{offset:e.width*e.height*l*s,bytesPerRow:c},{width:e.width,height:e.height,depthOrArrayLayers:1}),!0===r&&this._flipY(t,n,i)}_copyCompressedBufferToTexture(e,t,n){const i=this.backend.device,r=this._getBlockData(n.format),s=n.size.depthOrArrayLayers>1;for(let o=0;o<e.length;o++){const a=e[o],l=a.width,c=a.height,u=s?n.size.depthOrArrayLayers:1,h=Math.ceil(l/r.width)*r.byteLength,d=h*Math.ceil(c/r.height);for(let e=0;e<u;e++)i.queue.writeTexture({texture:t,mipLevel:o,origin:{x:0,y:0,z:e}},a.data,{offset:e*d,bytesPerRow:h,rowsPerImage:Math.ceil(c/r.height)},{width:Math.ceil(l/r.width)*r.width,height:Math.ceil(c/r.height)*r.height,depthOrArrayLayers:1})}}_getBlockData(e){return e===Jz||e===Qz?{byteLength:8,width:4,height:4}:e===eV||e===tV||e===nV||e===iV?{byteLength:16,width:4,height:4}:e===rV||e===sV?{byteLength:8,width:4,height:4}:e===oV||e===aV||e===lV||e===cV||e===uV||e===hV?{byteLength:16,width:4,height:4}:e===dV||e===pV||e===fV||e===mV?{byteLength:8,width:4,height:4}:e===gV||e===yV?{byteLength:16,width:4,height:4}:e===vV||e===_V?{byteLength:8,width:4,height:4}:e===xV||e===bV||e===wV||e===TV?{byteLength:16,width:4,height:4}:e===SV||e===MV?{byteLength:16,width:5,height:4}:e===EV||e===AV?{byteLength:16,width:5,height:5}:e===CV||e===RV?{byteLength:16,width:6,height:5}:e===NV||e===PV?{byteLength:16,width:6,height:6}:e===DV||e===LV?{byteLength:16,width:8,height:5}:e===IV||e===kV?{byteLength:16,width:8,height:6}:e===OV||e===UV?{byteLength:16,width:8,height:8}:e===FV||e===BV?{byteLength:16,width:10,height:5}:e===zV||e===VV?{byteLength:16,width:10,height:6}:e===GV||e===jV?{byteLength:16,width:10,height:8}:e===HV||e===WV?{byteLength:16,width:10,height:10}:e===qV||e===XV?{byteLength:16,width:12,height:10}:e===$V||e===YV?{byteLength:16,width:12,height:12}:void 0}_convertAddressMode(e){let t=KV;return e===Ha?t=ZV:e===qa&&(t=JV),t}_convertFilterMode(e){let t=QV;return e!==Xa&&e!==$a&&e!==Ya||(t=eG),t}_getBytesPerTexel(e){return e===hz||e===dz||e===pz||e===fz?1:e===mz||e===gz||e===yz||e===vz||e===_z||e===xz||e===bz?2:e===wz||e===Tz||e===Sz||e===Mz||e===Ez||e===Az||e===Cz||e===Rz||e===Nz||e===Pz||e===Dz||e===Lz||e===Iz||e===kz||e===Oz||e===Uz||e===Kz||e===$z||e===Yz||e===Zz?4:e===Fz||e===Bz||e===zz||e===Vz||e===Gz||e===jz?8:e===Hz||e===Wz||e===qz?16:void 0}_getTypedArrayType(e){return e===pz?Uint8Array:e===fz?Int8Array:e===hz?Uint8Array:e===dz?Int8Array:e===xz?Uint8Array:e===bz?Int8Array:e===vz?Uint8Array:e===_z?Int8Array:e===Pz?Uint8Array:e===Dz?Int8Array:e===Cz?Uint8Array:e===Nz?Int8Array:e===mz?Uint16Array:e===gz?Int16Array:e===Mz?Uint16Array:e===Ez?Int16Array:e===Vz?Uint16Array:e===Gz?Int16Array:e===yz||e===Az||e===jz?Uint16Array:e===wz?Uint32Array:e===Tz?Int32Array:e===Sz?Float32Array:e===Fz?Uint32Array:e===Bz?Int32Array:e===zz?Float32Array:e===Hz?Uint32Array:e===Wz?Int32Array:e===qz?Float32Array:e===Lz||e===Iz?Uint8Array:e===Oz||e===kz||e===Uz?Uint32Array:e===Kz?Float32Array:e===$z||e===Yz?Uint32Array:e===Zz?Float32Array:void 0}_getDimension(e){let t;return t=e.isData3DTexture?GG:VG,t}}function oj(e,t=null){const n=e.format,i=e.type,r=e.colorSpace,s=Wc.getTransfer(r);let o;if(!0===e.isCompressedTexture||!0===e.isCompressedArrayTexture)switch(n){case wl:o=s===ic?Qz:Jz;break;case Tl:o=s===ic?tV:eV;break;case Sl:o=s===ic?iV:nV;break;case Nl:o=s===ic?pV:dV;break;case Pl:o=s===ic?yV:gV;break;case Dl:o=s===ic?TV:wV;break;case Ll:o=s===ic?MV:SV;break;case Il:o=s===ic?AV:EV;break;case kl:o=s===ic?RV:CV;break;case Ol:o=s===ic?PV:NV;break;case Ul:o=s===ic?LV:DV;break;case Fl:o=s===ic?kV:IV;break;case Bl:o=s===ic?UV:OV;break;case zl:o=s===ic?BV:FV;break;case Vl:o=s===ic?VV:zV;break;case Gl:o=s===ic?jV:GV;break;case jl:o=s===ic?WV:HV;break;case Hl:o=s===ic?XV:qV;break;case Wl:o=s===ic?YV:$V;break;case pl:o=s===ic?Rz:Cz;break;default:console.error("WebGPURenderer: Unsupported texture format.",n)}else switch(n){case pl:switch(i){case el:o=Nz;break;case tl:o=Gz;break;case nl:o=Vz;break;case rl:o=Hz;break;case il:o=Wz;break;case Qa:o=s===ic?Rz:Cz;break;case ol:o=jz;break;case sl:o=qz;break;default:console.error("WebGPURenderer: Unsupported texture type with RGBAFormat.",i)}break;case dl:if(i===ul)o=kz;else console.error("WebGPURenderer: Unsupported texture type with RGBFormat.",i);break;case gl:switch(i){case el:o=dz;break;case tl:o=gz;break;case nl:o=mz;break;case rl:o=wz;break;case il:o=Tz;break;case Qa:o=hz;break;case ol:o=yz;break;case sl:o=Sz;break;default:console.error("WebGPURenderer: Unsupported texture type with RedFormat.",i)}break;case vl:switch(i){case el:o=_z;break;case tl:o=Ez;break;case nl:o=Mz;break;case rl:o=Fz;break;case il:o=Bz;break;case Qa:o=vz;break;case ol:o=Az;break;case sl:o=zz;break;default:console.error("WebGPURenderer: Unsupported texture type with RGFormat.",i)}break;case fl:switch(i){case nl:o=Xz;break;case rl:o=$z;break;case sl:o=Kz;break;default:console.error("WebGPURenderer: Unsupported texture type with DepthFormat.",i)}break;case ml:switch(i){case cl:o=Yz;break;case sl:t&&!1===t.features.has(KG.Depth32FloatStencil8)&&console.error('WebGPURenderer: Depth textures with DepthStencilFormat + FloatType can only be used with the "depth32float-stencil8" GPU feature.'),o=Zz;break;default:console.error("WebGPURenderer: Unsupported texture type with DepthStencilFormat.",i)}break;case yl:switch(i){case il:o=Tz;break;case rl:o=wz;break;default:console.error("WebGPURenderer: Unsupported texture type with RedIntegerFormat.",i)}break;case _l:switch(i){case il:o=Bz;break;case rl:o=Fz;break;default:console.error("WebGPURenderer: Unsupported texture type with RGIntegerFormat.",i)}break;case xl:switch(i){case il:o=Wz;break;case rl:o=Hz;break;default:console.error("WebGPURenderer: Unsupported texture type with RGBAIntegerFormat.",i)}break;default:console.error("WebGPURenderer: Unsupported texture format.",n)}return o}const aj=/^[fn]*\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)\s*[\-\>]*\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/i,lj=/([a-z_0-9]+)\s*:\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/gi,cj={f32:"float",i32:"int",u32:"uint",bool:"bool","vec2<f32>":"vec2","vec2<i32>":"ivec2","vec2<u32>":"uvec2","vec2<bool>":"bvec2",vec2f:"vec2",vec2i:"ivec2",vec2u:"uvec2",vec2b:"bvec2","vec3<f32>":"vec3","vec3<i32>":"ivec3","vec3<u32>":"uvec3","vec3<bool>":"bvec3",vec3f:"vec3",vec3i:"ivec3",vec3u:"uvec3",vec3b:"bvec3","vec4<f32>":"vec4","vec4<i32>":"ivec4","vec4<u32>":"uvec4","vec4<bool>":"bvec4",vec4f:"vec4",vec4i:"ivec4",vec4u:"uvec4",vec4b:"bvec4","mat2x2<f32>":"mat2",mat2x2f:"mat2","mat3x3<f32>":"mat3",mat3x3f:"mat3","mat4x4<f32>":"mat4",mat4x4f:"mat4",sampler:"sampler",texture_1d:"texture",texture_2d:"texture",texture_2d_array:"texture",texture_multisampled_2d:"cubeTexture",texture_depth_2d:"depthTexture",texture_depth_2d_array:"depthTexture",texture_depth_multisampled_2d:"depthTexture",texture_depth_cube:"depthTexture",texture_depth_cube_array:"depthTexture",texture_3d:"texture3D",texture_cube:"cubeTexture",texture_cube_array:"cubeTexture",texture_storage_1d:"storageTexture",texture_storage_2d:"storageTexture",texture_storage_2d_array:"storageTexture",texture_storage_3d:"storageTexture"};class uj extends gF{constructor(e){const{type:t,inputs:n,name:i,inputsCode:r,blockCode:s,outputType:o}=(e=>{const t=(e=e.trim()).match(aj);if(null!==t&&4===t.length){const n=t[2],i=[];let r=null;for(;null!==(r=lj.exec(n));)i.push({name:r[1],type:r[2]});const s=[];for(let e=0;e<i.length;e++){const{name:t,type:n}=i[e];let r=n;r.startsWith("ptr")?r="pointer":(r.startsWith("texture")&&(r=n.split("<")[0]),r=cj[r]),s.push(new nF(r,t))}const o=e.substring(t[0].length),a=t[3]||"void",l=void 0!==t[1]?t[1]:"";return{type:cj[a]||a,inputs:s,name:l,inputsCode:n,blockCode:o,outputType:a}}throw new Error("FunctionNode: Function is not a WGSL code.")})(e);super(t,n,i),this.inputsCode=r,this.blockCode=s,this.outputType=o}getCode(e=this.name){const t="void"!==this.outputType?"-> "+this.outputType:"";return`fn ${e} ( ${this.inputsCode.trim()} ) ${t}`+this.blockCode}}class hj extends mF{parseFunction(e){return new uj(e)}}const dj="undefined"!=typeof self?self.GPUShaderStage:{VERTEX:1,FRAGMENT:2,COMPUTE:4},pj={[YS]:"read",[KS]:"write",[ZS]:"read_write"},fj={[Ha]:"repeat",[Wa]:"clamp",[qa]:"mirror"},mj={vertex:dj?dj.VERTEX:1,fragment:dj?dj.FRAGMENT:2,compute:dj?dj.COMPUTE:4},gj={instance:!0,swizzleAssign:!1,storageBuffer:!0},yj={"^^":"tsl_xor"},vj={float:"f32",int:"i32",uint:"u32",bool:"bool",color:"vec3<f32>",vec2:"vec2<f32>",ivec2:"vec2<i32>",uvec2:"vec2<u32>",bvec2:"vec2<bool>",vec3:"vec3<f32>",ivec3:"vec3<i32>",uvec3:"vec3<u32>",bvec3:"vec3<bool>",vec4:"vec4<f32>",ivec4:"vec4<i32>",uvec4:"vec4<u32>",bvec4:"vec4<bool>",mat2:"mat2x2<f32>",mat3:"mat3x3<f32>",mat4:"mat4x4<f32>"},_j={},xj={tsl_xor:new AO("fn tsl_xor( a : bool, b : bool ) -> bool { return ( a || b ) && !( a && b ); }"),mod_float:new AO("fn tsl_mod_float( x : f32, y : f32 ) -> f32 { return x - y * floor( x / y ); }"),mod_vec2:new AO("fn tsl_mod_vec2( x : vec2f, y : vec2f ) -> vec2f { return x - y * floor( x / y ); }"),mod_vec3:new AO("fn tsl_mod_vec3( x : vec3f, y : vec3f ) -> vec3f { return x - y * floor( x / y ); }"),mod_vec4:new AO("fn tsl_mod_vec4( x : vec4f, y : vec4f ) -> vec4f { return x - y * floor( x / y ); }"),equals_bool:new AO("fn tsl_equals_bool( a : bool, b : bool ) -> bool { return a == b; }"),equals_bvec2:new AO("fn tsl_equals_bvec2( a : vec2f, b : vec2f ) -> vec2<bool> { return vec2<bool>( a.x == b.x, a.y == b.y ); }"),equals_bvec3:new AO("fn tsl_equals_bvec3( a : vec3f, b : vec3f ) -> vec3<bool> { return vec3<bool>( a.x == b.x, a.y == b.y, a.z == b.z ); }"),equals_bvec4:new AO("fn tsl_equals_bvec4( a : vec4f, b : vec4f ) -> vec4<bool> { return vec4<bool>( a.x == b.x, a.y == b.y, a.z == b.z, a.w == b.w ); }"),repeatWrapping_float:new AO("fn tsl_repeatWrapping_float( coord: f32 ) -> f32 { return fract( coord ); }"),mirrorWrapping_float:new AO("fn tsl_mirrorWrapping_float( coord: f32 ) -> f32 { let mirrored = fract( coord * 0.5 ) * 2.0; return 1.0 - abs( 1.0 - mirrored ); }"),clampWrapping_float:new AO("fn tsl_clampWrapping_float( coord: f32 ) -> f32 { return clamp( coord, 0.0, 1.0 ); }"),biquadraticTexture:new AO("\nfn tsl_biquadraticTexture( map : texture_2d<f32>, coord : vec2f, iRes : vec2u, level : u32 ) -> vec4f {\n\n\tlet res = vec2f( iRes );\n\n\tlet uvScaled = coord * res;\n\tlet uvWrapping = ( ( uvScaled % res ) + res ) % res;\n\n\t// https://www.shadertoy.com/view/WtyXRy\n\n\tlet uv = uvWrapping - 0.5;\n\tlet iuv = floor( uv );\n\tlet f = fract( uv );\n\n\tlet rg1 = textureLoad( map, vec2u( iuv + vec2( 0.5, 0.5 ) ) % iRes, level );\n\tlet rg2 = textureLoad( map, vec2u( iuv + vec2( 1.5, 0.5 ) ) % iRes, level );\n\tlet rg3 = textureLoad( map, vec2u( iuv + vec2( 0.5, 1.5 ) ) % iRes, level );\n\tlet rg4 = textureLoad( map, vec2u( iuv + vec2( 1.5, 1.5 ) ) % iRes, level );\n\n\treturn mix( mix( rg1, rg2, f.x ), mix( rg3, rg4, f.x ), f.y );\n\n}\n")},bj={dFdx:"dpdx",dFdy:"- dpdy",mod_float:"tsl_mod_float",mod_vec2:"tsl_mod_vec2",mod_vec3:"tsl_mod_vec3",mod_vec4:"tsl_mod_vec4",equals_bool:"tsl_equals_bool",equals_bvec2:"tsl_equals_bvec2",equals_bvec3:"tsl_equals_bvec3",equals_bvec4:"tsl_equals_bvec4",inversesqrt:"inverseSqrt",bitcast:"bitcast<f32>"};"undefined"!=typeof navigator&&/Windows/g.test(navigator.userAgent)&&(xj.pow_float=new AO("fn tsl_pow_float( a : f32, b : f32 ) -> f32 { return select( -pow( -a, b ), pow( a, b ), a > 0.0 ); }"),xj.pow_vec2=new AO("fn tsl_pow_vec2( a : vec2f, b : vec2f ) -> vec2f { return vec2f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ) ); }",[xj.pow_float]),xj.pow_vec3=new AO("fn tsl_pow_vec3( a : vec3f, b : vec3f ) -> vec3f { return vec3f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ) ); }",[xj.pow_float]),xj.pow_vec4=new AO("fn tsl_pow_vec4( a : vec4f, b : vec4f ) -> vec4f { return vec4f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ), tsl_pow_float( a.w, b.w ) ); }",[xj.pow_float]),bj.pow_float="tsl_pow_float",bj.pow_vec2="tsl_pow_vec2",bj.pow_vec3="tsl_pow_vec3",bj.pow_vec4="tsl_pow_vec4");let wj="";!0!==("undefined"!=typeof navigator&&/Firefox|Deno/g.test(navigator.userAgent))&&(wj+="diagnostic( off, derivative_uniformity );\n");class Tj extends eF{constructor(e,t){super(e,t,new hj),this.uniformGroups={},this.builtins={},this.directives={},this.scopedArrays=new Map}needsToWorkingColorSpace(e){return!0===e.isVideoTexture&&e.colorSpace!==Ql}_generateTextureSample(e,t,n,i,r=this.shaderStage){return"fragment"===r?i?`textureSample( ${t}, ${t}_sampler, ${n}, ${i} )`:`textureSample( ${t}, ${t}_sampler, ${n} )`:this._generateTextureSampleLevel(e,t,n,"0",i)}_generateVideoSample(e,t,n=this.shaderStage){if("fragment"===n)return`textureSampleBaseClampToEdge( ${e}, ${e}_sampler, vec2<f32>( ${t}.x, 1.0 - ${t}.y ) )`;console.error(`WebGPURenderer: THREE.VideoTexture does not support ${n} shader.`)}_generateTextureSampleLevel(e,t,n,i,r){return!1===this.isUnfilterable(e)?`textureSampleLevel( ${t}, ${t}_sampler, ${n}, ${i} )`:this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,n,i):this.generateTextureLod(e,t,n,r,i)}generateWrapFunction(e){const t=`tsl_coord_${fj[e.wrapS]}S_${fj[e.wrapT]}_${e.isData3DTexture?"3d":"2d"}T`;let n=_j[t];if(void 0===n){const i=[],r=e.isData3DTexture?"vec3f":"vec2f";let s=`fn ${t}( coord : ${r} ) -> ${r} {\n\n\treturn ${r}(\n`;const o=(e,t)=>{e===Ha?(i.push(xj.repeatWrapping_float),s+=`\t\ttsl_repeatWrapping_float( coord.${t} )`):e===Wa?(i.push(xj.clampWrapping_float),s+=`\t\ttsl_clampWrapping_float( coord.${t} )`):e===qa?(i.push(xj.mirrorWrapping_float),s+=`\t\ttsl_mirrorWrapping_float( coord.${t} )`):(s+=`\t\tcoord.${t}`,console.warn(`WebGPURenderer: Unsupported texture wrap type "${e}" for vertex shader.`))};o(e.wrapS,"x"),s+=",\n",o(e.wrapT,"y"),e.isData3DTexture&&(s+=",\n",o(e.wrapR,"z")),s+="\n\t);\n\n}\n",_j[t]=n=new AO(s,i)}return n.build(this),t}generateArrayDeclaration(e,t){return`array< ${this.getType(e)}, ${t} >`}generateTextureDimension(e,t,n){const i=this.getDataFromNode(e,this.shaderStage,this.globalCache);void 0===i.dimensionsSnippet&&(i.dimensionsSnippet={});let r=i.dimensionsSnippet[n];if(void 0===i.dimensionsSnippet[n]){let s,o;const{primarySamples:a}=this.renderer.backend.utils.getTextureSampleData(e),l=a>1;o=e.isData3DTexture?"vec3<u32>":"vec2<u32>",s=l||e.isVideoTexture||e.isStorageTexture?t:`${t}${n?`, u32( ${n} )`:""}`,r=new VC(new pR(`textureDimensions( ${s} )`,o)),i.dimensionsSnippet[n]=r,(e.isArrayTexture||e.isDataArrayTexture||e.isData3DTexture)&&(i.arrayLayerCount=new VC(new pR(`textureNumLayers(${t})`,"u32"))),e.isTextureCube&&(i.cubeFaceCount=new VC(new pR("6u","u32")))}return r.build(this)}generateFilteredTexture(e,t,n,i="0u"){this._include("biquadraticTexture");return`tsl_biquadraticTexture( ${t}, ${this.generateWrapFunction(e)}( ${n} ), ${this.generateTextureDimension(e,t,i)}, u32( ${i} ) )`}generateTextureLod(e,t,n,i,r="0u"){const s=this.generateWrapFunction(e),o=this.generateTextureDimension(e,t,r),a=e.isData3DTexture?"vec3":"vec2",l=`${a}<u32>( ${s}( ${n} ) * ${a}<f32>( ${o} ) )`;return this.generateTextureLoad(e,t,l,i,r)}generateTextureLoad(e,t,n,i,r="0u"){let s;return!0===e.isVideoTexture?s=`textureLoad( ${t}, ${n} )`:i?s=`textureLoad( ${t}, ${n}, ${i}, u32( ${r} ) )`:(s=`textureLoad( ${t}, ${n}, u32( ${r} ) )`,this.renderer.backend.compatibilityMode&&e.isDepthTexture&&(s+=".x")),s}generateTextureStore(e,t,n,i,r){let s;return s=i?`textureStore( ${t}, ${n}, ${i}, ${r} )`:`textureStore( ${t}, ${n}, ${r} )`,s}isSampleCompare(e){return!0===e.isDepthTexture&&null!==e.compareFunction}isUnfilterable(e){return"float"!==this.getComponentTypeFromTexture(e)||!this.isAvailable("float32Filterable")&&!0===e.isDataTexture&&e.type===sl||!1===this.isSampleCompare(e)&&e.minFilter===Xa&&e.magFilter===Xa||this.renderer.backend.utils.getTextureSampleData(e).primarySamples>1}generateTexture(e,t,n,i,r=this.shaderStage){let s=null;return s=!0===e.isVideoTexture?this._generateVideoSample(t,n,r):this.isUnfilterable(e)?this.generateTextureLod(e,t,n,i,"0",r):this._generateTextureSample(e,t,n,i,r),s}generateTextureGrad(e,t,n,i,r,s=this.shaderStage){if("fragment"===s)return`textureSampleGrad( ${t}, ${t}_sampler, ${n},  ${i[0]}, ${i[1]} )`;console.error(`WebGPURenderer: THREE.TextureNode.gradient() does not support ${s} shader.`)}generateTextureCompare(e,t,n,i,r,s=this.shaderStage){if("fragment"===s)return!0===e.isDepthTexture&&!0===e.isArrayTexture?`textureSampleCompare( ${t}, ${t}_sampler, ${n}, ${r}, ${i} )`:`textureSampleCompare( ${t}, ${t}_sampler, ${n}, ${i} )`;console.error(`WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ${s} shader.`)}generateTextureLevel(e,t,n,i,r,s=this.shaderStage){let o=null;return o=!0===e.isVideoTexture?this._generateVideoSample(t,n,s):this._generateTextureSampleLevel(e,t,n,i,r),o}generateTextureBias(e,t,n,i,r,s=this.shaderStage){if("fragment"===s)return`textureSampleBias( ${t}, ${t}_sampler, ${n}, ${i} )`;console.error(`WebGPURenderer: THREE.TextureNode.biasNode does not support ${s} shader.`)}getPropertyName(e,t=this.shaderStage){if(!0===e.isNodeVarying&&!0===e.needsInterpolation){if("vertex"===t)return`varyings.${e.name}`}else if(!0===e.isNodeUniform){const t=e.name,n=e.type;return"texture"===n||"cubeTexture"===n||"storageTexture"===n||"texture3D"===n?t:"buffer"===n||"storageBuffer"===n||"indirectStorageBuffer"===n?this.isCustomStruct(e)?t:t+".value":e.groupNode.name+"."+t}return super.getPropertyName(e)}getOutputStructName(){return"output"}getFunctionOperator(e){const t=yj[e];return void 0!==t?(this._include(t),t):null}getNodeAccess(e,t){return"compute"!==t?YS:e.access}getStorageAccess(e,t){return pj[this.getNodeAccess(e,t)]}getUniformFromNode(e,t,n,i=null){const r=super.getUniformFromNode(e,t,n,i),s=this.getDataFromNode(e,n,this.globalCache);if(void 0===s.uniformGPU){let o;const a=e.groupNode,l=a.name,c=this.getBindGroupArray(l,n);if("texture"===t||"cubeTexture"===t||"storageTexture"===t||"texture3D"===t){let i=null;const s=this.getNodeAccess(e,n);if("texture"===t||"storageTexture"===t?i=new cB(r.name,r.node,a,s):"cubeTexture"===t?i=new uB(r.name,r.node,a,s):"texture3D"===t&&(i=new hB(r.name,r.node,a,s)),i.store=!0===e.isStorageTextureNode,i.setVisibility(mj[n]),!1===this.isUnfilterable(e.value)&&!1===i.store){const e=new JG(`${r.name}_sampler`,r.node,a);e.setVisibility(mj[n]),c.push(e,i),o=[e,i]}else c.push(i),o=[i]}else if("buffer"===t||"storageBuffer"===t||"indirectStorageBuffer"===t){const s=new("buffer"===t?iB:tj)(e,a);s.setVisibility(mj[n]),c.push(s),o=s,r.name=i||"NodeBuffer_"+r.id}else{const e=this.uniformGroups[n]||(this.uniformGroups[n]={});let i=e[l];void 0===i&&(i=new oB(l,a),i.setVisibility(mj[n]),e[l]=i,c.push(i)),o=this.getNodeUniform(r,t),i.addUniform(o)}s.uniformGPU=o}return r}getBuiltin(e,t,n,i=this.shaderStage){const r=this.builtins[i]||(this.builtins[i]=new Map);return!1===r.has(e)&&r.set(e,{name:e,property:t,type:n}),t}hasBuiltin(e,t=this.shaderStage){return void 0!==this.builtins[t]&&this.builtins[t].has(e)}getVertexIndex(){return"vertex"===this.shaderStage?this.getBuiltin("vertex_index","vertexIndex","u32","attribute"):"vertexIndex"}buildFunctionCode(e){const t=e.layout,n=this.flowShaderNode(e),i=[];for(const e of t.inputs)i.push(e.name+" : "+this.getType(e.type));let r=`fn ${t.name}( ${i.join(", ")} ) -> ${this.getType(t.type)} {\n${n.vars}\n${n.code}\n`;return n.result&&(r+=`\treturn ${n.result};\n`),r+="\n}\n",r}getInstanceIndex(){return"vertex"===this.shaderStage?this.getBuiltin("instance_index","instanceIndex","u32","attribute"):"instanceIndex"}getInvocationLocalIndex(){return this.getBuiltin("local_invocation_index","invocationLocalIndex","u32","attribute")}getSubgroupSize(){return this.enableSubGroups(),this.getBuiltin("subgroup_size","subgroupSize","u32","attribute")}getInvocationSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin("subgroup_invocation_id","invocationSubgroupIndex","u32","attribute")}getSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin("subgroup_id","subgroupIndex","u32","attribute")}getDrawIndex(){return null}getFrontFacing(){return this.getBuiltin("front_facing","isFront","bool")}getFragCoord(){return this.getBuiltin("position","fragCoord","vec4<f32>")+".xy"}getFragDepth(){return"output."+this.getBuiltin("frag_depth","depth","f32","output")}getClipDistance(){return"varyings.hw_clip_distances"}isFlipY(){return!1}enableDirective(e,t=this.shaderStage){(this.directives[t]||(this.directives[t]=new Set)).add(e)}getDirectives(e){const t=[],n=this.directives[e];if(void 0!==n)for(const e of n)t.push(`enable ${e};`);return t.join("\n")}enableSubGroups(){this.enableDirective("subgroups")}enableSubgroupsF16(){this.enableDirective("subgroups-f16")}enableClipDistances(){this.enableDirective("clip_distances")}enableShaderF16(){this.enableDirective("f16")}enableDualSourceBlending(){this.enableDirective("dual_source_blending")}enableHardwareClipping(e){this.enableClipDistances(),this.getBuiltin("clip_distances","hw_clip_distances",`array<f32, ${e} >`,"vertex")}getBuiltins(e){const t=[],n=this.builtins[e];if(void 0!==n)for(const{name:e,property:i,type:r}of n.values())t.push(`@builtin( ${e} ) ${i} : ${r}`);return t.join(",\n\t")}getScopedArray(e,t,n,i){return!1===this.scopedArrays.has(e)&&this.scopedArrays.set(e,{name:e,scope:t,bufferType:n,bufferCount:i}),e}getScopedArrays(e){if("compute"!==e)return;const t=[];for(const{name:e,scope:n,bufferType:i,bufferCount:r}of this.scopedArrays.values()){const s=this.getType(i);t.push(`var<${n}> ${e}: array< ${s}, ${r} >;`)}return t.join("\n")}getAttributes(e){const t=[];if("compute"===e&&(this.getBuiltin("global_invocation_id","globalId","vec3<u32>","attribute"),this.getBuiltin("workgroup_id","workgroupId","vec3<u32>","attribute"),this.getBuiltin("local_invocation_id","localId","vec3<u32>","attribute"),this.getBuiltin("num_workgroups","numWorkgroups","vec3<u32>","attribute"),this.renderer.hasFeature("subgroups")&&(this.enableDirective("subgroups",e),this.getBuiltin("subgroup_size","subgroupSize","u32","attribute"))),"vertex"===e||"compute"===e){const e=this.getBuiltins("attribute");e&&t.push(e);const n=this.getAttributesArray();for(let e=0,i=n.length;e<i;e++){const i=n[e],r=i.name,s=this.getType(i.type);t.push(`@location( ${e} ) ${r} : ${s}`)}}return t.join(",\n\t")}getStructMembers(e){const t=[];for(const n of e.members){const i=e.output?"@location( "+n.index+" ) ":"";let r=this.getType(n.type);n.atomic&&(r="atomic< "+r+" >"),t.push(`\t${i+n.name} : ${r}`)}return e.output&&t.push(`\t${this.getBuiltins("output")}`),t.join(",\n")}getStructs(e){let t="";const n=this.structs[e];if(n.length>0){const e=[];for(const t of n){let n=`struct ${t.name} {\n`;n+=this.getStructMembers(t),n+="\n};",e.push(n)}t="\n"+e.join("\n\n")+"\n"}return t}getVar(e,t,n=null){let i=`var ${t} : `;return i+=null!==n?this.generateArrayDeclaration(e,n):this.getType(e),i}getVars(e){const t=[],n=this.vars[e];if(void 0!==n)for(const e of n)t.push(`\t${this.getVar(e.type,e.name,e.count)};`);return`\n${t.join("\n")}\n`}getVaryings(e){const t=[];if("vertex"===e&&this.getBuiltin("position","Vertex","vec4<f32>","vertex"),"vertex"===e||"fragment"===e){const n=this.varyings,i=this.vars[e];for(let r=0;r<n.length;r++){const s=n[r];if(s.needsInterpolation){let e=`@location( ${r} )`;if(s.interpolationType){const t=null!==s.interpolationSampling?`, ${s.interpolationSampling} )`:" )";e+=` @interpolate( ${s.interpolationType}${t}`}else/^(int|uint|ivec|uvec)/.test(s.type)&&(e+=` @interpolate( ${this.renderer.backend.compatibilityMode?"flat, either":"flat"} )`);t.push(`${e} ${s.name} : ${this.getType(s.type)}`)}else"vertex"===e&&!1===i.includes(s)&&i.push(s)}}const n=this.getBuiltins(e);n&&t.push(n);const i=t.join(",\n\t");return"vertex"===e?this._getWGSLStruct("VaryingsStruct","\t"+i):i}isCustomStruct(e){const t=e.value,n=e.node,i=(t.isBufferAttribute||t.isInstancedBufferAttribute)&&null!==n.structTypeNode,r=n.value&&n.value.array&&"number"==typeof n.value.itemSize&&n.value.array.length>n.value.itemSize;return i&&!r}getUniforms(e){const t=this.uniforms[e],n=[],i=[],r=[],s={};for(const r of t){const t=r.groupNode.name,o=this.bindingsIndexes[t];if("texture"===r.type||"cubeTexture"===r.type||"storageTexture"===r.type||"texture3D"===r.type){const t=r.node.value;let i;!1===this.isUnfilterable(t)&&!0!==r.node.isStorageTextureNode&&(this.isSampleCompare(t)?n.push(`@binding( ${o.binding++} ) @group( ${o.group} ) var ${r.name}_sampler : sampler_comparison;`):n.push(`@binding( ${o.binding++} ) @group( ${o.group} ) var ${r.name}_sampler : sampler;`));let s="";const{primarySamples:a}=this.renderer.backend.utils.getTextureSampleData(t);if(a>1&&(s="_multisampled"),!0===t.isCubeTexture)i="texture_cube<f32>";else if(!0===t.isDepthTexture)i=this.renderer.backend.compatibilityMode&&null===t.compareFunction?`texture${s}_2d<f32>`:`texture_depth${s}_2d${!0===t.isArrayTexture?"_array":""}`;else if(!0===t.isArrayTexture||!0===t.isDataArrayTexture||!0===t.isCompressedArrayTexture)i="texture_2d_array<f32>";else if(!0===t.isVideoTexture)i="texture_external";else if(!0===t.isData3DTexture)i="texture_3d<f32>";else if(!0===r.node.isStorageTextureNode){i=`texture_storage_2d<${oj(t)}, ${this.getStorageAccess(r.node,e)}>`}else{i=`texture${s}_2d<${this.getComponentTypeFromTexture(t).charAt(0)}32>`}n.push(`@binding( ${o.binding++} ) @group( ${o.group} ) var ${r.name} : ${i};`)}else if("buffer"===r.type||"storageBuffer"===r.type||"indirectStorageBuffer"===r.type){const t=r.node,n=this.getType(t.getNodeType(this)),s=t.bufferCount,a=s>0&&"buffer"===r.type?", "+s:"",l=t.isStorageBufferNode?`storage, ${this.getStorageAccess(t,e)}`:"uniform";if(this.isCustomStruct(r))i.push(`@binding( ${o.binding++} ) @group( ${o.group} ) var<${l}> ${r.name} : ${n};`);else{const e=`\tvalue : array< ${t.isAtomic?`atomic<${n}>`:`${n}`}${a} >`;i.push(this._getWGSLStructBinding(r.name,e,l,o.binding++,o.group))}}else{const e=this.getType(this.getVectorType(r.type)),t=r.groupNode.name;(s[t]||(s[t]={index:o.binding++,id:o.group,snippets:[]})).snippets.push(`\t${r.name} : ${e}`)}}for(const e in s){const t=s[e];r.push(this._getWGSLStructBinding(e,t.snippets.join(",\n"),"uniform",t.index,t.id))}let o=n.join("\n");return o+=i.join("\n"),o+=r.join("\n"),o}buildCode(){const e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};this.sortBindingGroups();for(const t in e){this.shaderStage=t;const n=e[t];n.uniforms=this.getUniforms(t),n.attributes=this.getAttributes(t),n.varyings=this.getVaryings(t),n.structs=this.getStructs(t),n.vars=this.getVars(t),n.codes=this.getCodes(t),n.directives=this.getDirectives(t),n.scopedArrays=this.getScopedArrays(t);let i="// code\n\n";i+=this.flowCode[t];const r=this.flowNodes[t],s=r[r.length-1],o=s.outputNode,a=void 0!==o&&!0===o.isOutputStructNode;for(const e of r){const r=this.getFlowData(e),l=e.name;if(l&&(i.length>0&&(i+="\n"),i+=`\t// flow -> ${l}\n`),i+=`${r.code}\n\t`,e===s&&"compute"!==t)if(i+="// result\n\n\t","vertex"===t)i+=`varyings.Vertex = ${r.result};`;else if("fragment"===t)if(a)n.returnType=o.getNodeType(this),n.structs+="var<private> output : "+n.returnType+";",i+=`return ${r.result};`;else{let e="\t@location(0) color: vec4<f32>";const t=this.getBuiltins("output");t&&(e+=",\n\t"+t),n.returnType="OutputStruct",n.structs+=this._getWGSLStruct("OutputStruct",e),n.structs+="\nvar<private> output : OutputStruct;",i+=`output.color = ${r.result};\n\n\treturn output;`}}n.flow=i}this.shaderStage=null,null!==this.material?(this.vertexShader=this._getWGSLVertexCode(e.vertex),this.fragmentShader=this._getWGSLFragmentCode(e.fragment)):this.computeShader=this._getWGSLComputeCode(e.compute,(this.object.workgroupSize||[64]).join(", "))}getMethod(e,t=null){let n;return null!==t&&(n=this._getWGSLMethod(e+"_"+t)),void 0===n&&(n=this._getWGSLMethod(e)),n||e}getType(e){return vj[e]||e}isAvailable(e){let t=gj[e];return void 0===t&&("float32Filterable"===e?t=this.renderer.hasFeature("float32-filterable"):"clipDistance"===e&&(t=this.renderer.hasFeature("clip-distances")),gj[e]=t),t}_getWGSLMethod(e){return void 0!==xj[e]&&this._include(e),bj[e]}_include(e){const t=xj[e];return t.build(this),null!==this.currentFunctionNode&&this.currentFunctionNode.includes.push(t),t}_getWGSLVertexCode(e){return`${this.getSignature()}\n// directives\n${e.directives}\n\n// structs\n${e.structs}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\nvar<private> varyings : VaryingsStruct;\n\n// codes\n${e.codes}\n\n@vertex\nfn main( ${e.attributes} ) -> VaryingsStruct {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n\treturn varyings;\n\n}\n`}_getWGSLFragmentCode(e){return`${this.getSignature()}\n// global\n${wj}\n\n// structs\n${e.structs}\n\n// uniforms\n${e.uniforms}\n\n// codes\n${e.codes}\n\n@fragment\nfn main( ${e.varyings} ) -> ${e.returnType} {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}_getWGSLComputeCode(e,t){return`${this.getSignature()}\n// directives\n${e.directives}\n\n// system\nvar<private> instanceIndex : u32;\n\n// locals\n${e.scopedArrays}\n\n// structs\n${e.structs}\n\n// uniforms\n${e.uniforms}\n\n// codes\n${e.codes}\n\n@compute @workgroup_size( ${t} )\nfn main( ${e.attributes} ) {\n\n\t// system\n\tinstanceIndex = globalId.x + globalId.y * numWorkgroups.x * u32(${t}) + globalId.z * numWorkgroups.x * numWorkgroups.y * u32(${t});\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}_getWGSLStruct(e,t){return`\nstruct ${e} {\n${t}\n};`}_getWGSLStructBinding(e,t,n,i=0,r=0){const s=e+"Struct";return`${this._getWGSLStruct(s,t)}\n@binding( ${i} ) @group( ${r} )\nvar<${n}> ${e} : ${s};`}}class Sj{constructor(e){this.backend=e}getCurrentDepthStencilFormat(e){let t;return null!==e.depthTexture?t=this.getTextureFormatGPU(e.depthTexture):e.depth&&e.stencil?t=Yz:e.depth&&(t=$z),t}getTextureFormatGPU(e){return this.backend.get(e).format}getTextureSampleData(e){let t;if(e.isFramebufferTexture)t=1;else if(e.isDepthTexture&&!e.renderTarget){const e=this.backend.renderer,n=e.getRenderTarget();t=n?n.samples:e.samples}else e.renderTarget&&(t=e.renderTarget.samples);t=t||1;const n=t>1&&null!==e.renderTarget&&!0!==e.isDepthTexture&&!0!==e.isFramebufferTexture;return{samples:t,primarySamples:n?1:t,isMSAA:n}}getCurrentColorFormat(e){let t;return t=null!==e.textures?this.getTextureFormatGPU(e.textures[0]):this.getPreferredCanvasFormat(),t}getCurrentColorSpace(e){return null!==e.textures?e.textures[0].colorSpace:this.backend.renderer.outputColorSpace}getPrimitiveTopology(e,t){return e.isPoints?jB:e.isLineSegments||e.isMesh&&!0===t.wireframe?HB:e.isLine?WB:e.isMesh?qB:void 0}getSampleCount(e){let t=1;return e>1&&(t=Math.pow(2,Math.floor(Math.log2(e))),2===t&&(t=4)),t}getSampleCountRenderContext(e){return null!==e.textures?this.getSampleCount(e.sampleCount):this.getSampleCount(this.backend.renderer.samples)}getPreferredCanvasFormat(){const e=this.backend.parameters.outputType;if(void 0===e)return navigator.gpu.getPreferredCanvasFormat();if(e===Qa)return Lz;if(e===ol)return jz;throw new Error("Unsupported outputType")}}const Mj=new Map([[Int8Array,["sint8","snorm8"]],[Uint8Array,["uint8","unorm8"]],[Int16Array,["sint16","snorm16"]],[Uint16Array,["uint16","unorm16"]],[Int32Array,["sint32","snorm32"]],[Uint32Array,["uint32","unorm32"]],[Float32Array,["float32"]]]),Ej=new Map([[Vh,["float16"]]]),Aj=new Map([[Int32Array,"sint32"],[Int16Array,"sint32"],[Uint32Array,"uint32"],[Uint16Array,"uint32"],[Float32Array,"float32"]]);class Cj{constructor(e){this.backend=e}createAttribute(e,t){const n=this._getBufferAttribute(e),i=this.backend,r=i.get(n);let s=r.buffer;if(void 0===s){const o=i.device;let a=n.array;if(!1===e.normalized)if(a.constructor===Int16Array||a.constructor===Int8Array)a=new Int32Array(a);else if((a.constructor===Uint16Array||a.constructor===Uint8Array)&&(a=new Uint32Array(a),t&GPUBufferUsage.INDEX))for(let e=0;e<a.length;e++)65535===a[e]&&(a[e]=4294967295);if(n.array=a,(n.isStorageBufferAttribute||n.isStorageInstancedBufferAttribute)&&3===n.itemSize){a=new a.constructor(4*n.count);for(let e=0;e<n.count;e++)a.set(n.array.subarray(3*e,3*e+3),4*e);n.itemSize=4,n.array=a,r._force3to4BytesAlignment=!0}const l=a.byteLength,c=l+(4-l%4)%4;s=o.createBuffer({label:n.name,size:c,usage:t,mappedAtCreation:!0}),new a.constructor(s.getMappedRange()).set(a),s.unmap(),r.buffer=s}}updateAttribute(e){const t=this._getBufferAttribute(e),n=this.backend,i=n.device,r=n.get(t),s=n.get(t).buffer;let o=t.array;if(!0===r._force3to4BytesAlignment){o=new o.constructor(4*t.count);for(let e=0;e<t.count;e++)o.set(t.array.subarray(3*e,3*e+3),4*e);t.array=o}const a=this._isTypedArray(o),l=t.updateRanges;if(0===l.length)i.queue.writeBuffer(s,0,o,0);else{const e=a?1:o.BYTES_PER_ELEMENT;for(let t=0,n=l.length;t<n;t++){const n=l[t];let c,u;if(!0===r._force3to4BytesAlignment){c=4*Math.floor(n.start/3)*e,u=4*Math.ceil(n.count/3)*e}else c=n.start*e,u=n.count*e;const h=c*(a?o.BYTES_PER_ELEMENT:1);i.queue.writeBuffer(s,h,o,c,u)}t.clearUpdateRanges()}}createShaderVertexBuffers(e){const t=e.getAttributes(),n=new Map;for(let e=0;e<t.length;e++){const i=t[e],r=i.array.BYTES_PER_ELEMENT,s=this._getBufferAttribute(i);let o=n.get(s);if(void 0===o){let e,t;!0===i.isInterleavedBufferAttribute?(e=i.data.stride*r,t=i.data.isInstancedInterleavedBuffer?YG:$G):(e=i.itemSize*r,t=i.isInstancedBufferAttribute?YG:$G),!1!==i.normalized||i.array.constructor!==Int16Array&&i.array.constructor!==Uint16Array||(e=4),o={arrayStride:e,attributes:[],stepMode:t},n.set(s,o)}const a=this._getVertexFormat(i),l=!0===i.isInterleavedBufferAttribute?i.offset*r:0;o.attributes.push({shaderLocation:e,offset:l,format:a})}return Array.from(n.values())}destroyAttribute(e){const t=this.backend;t.get(this._getBufferAttribute(e)).buffer.destroy(),t.delete(e)}async getArrayBufferAsync(e){const t=this.backend,n=t.device,i=t.get(this._getBufferAttribute(e)).buffer,r=i.size,s=n.createBuffer({label:`${e.name}_readback`,size:r,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),o=n.createCommandEncoder({label:`readback_encoder_${e.name}`});o.copyBufferToBuffer(i,0,s,0,r);const a=o.finish();n.queue.submit([a]),await s.mapAsync(GPUMapMode.READ);const l=s.getMappedRange(),c=new e.array.constructor(l.slice(0));return s.unmap(),c.buffer}_getVertexFormat(e){const{itemSize:t,normalized:n}=e,i=e.array.constructor,r=e.constructor;let s;if(1===t)s=Aj.get(i);else{const e=(Ej.get(r)||Mj.get(i))[n?1:0];if(e){const n=i.BYTES_PER_ELEMENT*t,r=4*Math.floor((n+3)/4)/i.BYTES_PER_ELEMENT;if(r%1)throw new Error("THREE.WebGPUAttributeUtils: Bad vertex format item size.");s=`${e}x${r}`}}return s||console.error("THREE.WebGPUAttributeUtils: Vertex format not supported yet."),s}_isTypedArray(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}}class Rj{constructor(e){this.backend=e,this.bindGroupLayoutCache=new WeakMap}createBindingsLayout(e){const t=this.backend,n=t.device,i=[];let r=0;for(const n of e.bindings){const e={binding:r++,visibility:n.visibility};if(n.isUniformBuffer||n.isStorageBuffer){const t={};n.isStorageBuffer&&(4&n.visibility&&(n.access===ZS||n.access===KS)?t.type=RG:t.type=NG),e.buffer=t}else if(n.isSampler){const i={};n.texture.isDepthTexture&&(null!==n.texture.compareFunction?i.type=kG:t.compatibilityMode&&(i.type=IG)),e.sampler=i}else if(n.isSampledTexture&&n.texture.isVideoTexture)e.externalTexture={};else if(n.isSampledTexture&&n.store){const t={};t.format=this.backend.get(n.texture).texture.format;const i=n.access;t.access=i===ZS?LG:i===KS?PG:DG,e.storageTexture=t}else if(n.isSampledTexture){const i={},{primarySamples:r}=t.utils.getTextureSampleData(n.texture);if(r>1&&(i.multisampled=!0,n.texture.isDepthTexture||(i.sampleType=UG)),n.texture.isDepthTexture)t.compatibilityMode&&null===n.texture.compareFunction?i.sampleType=UG:i.sampleType=FG;else if(n.texture.isDataTexture||n.texture.isDataArrayTexture||n.texture.isData3DTexture){const e=n.texture.type;e===il?i.sampleType=BG:e===rl?i.sampleType=zG:e===sl&&(this.backend.hasFeature("float32-filterable")?i.sampleType=OG:i.sampleType=UG)}n.isSampledCubeTexture?i.viewDimension=WG:n.texture.isArrayTexture||n.texture.isDataArrayTexture||n.texture.isCompressedArrayTexture?i.viewDimension=HG:n.isSampledTexture3D&&(i.viewDimension=qG),e.texture=i}else console.error(`WebGPUBindingUtils: Unsupported binding "${n}".`);i.push(e)}return n.createBindGroupLayout({entries:i})}createBindings(e,t,n,i=0){const{backend:r,bindGroupLayoutCache:s}=this,o=r.get(e);let a,l=s.get(e.bindingsReference);void 0===l&&(l=this.createBindingsLayout(e),s.set(e.bindingsReference,l)),n>0&&(void 0===o.groups&&(o.groups=[],o.versions=[]),o.versions[n]===i&&(a=o.groups[n])),void 0===a&&(a=this.createBindGroup(e,l),n>0&&(o.groups[n]=a,o.versions[n]=i)),o.group=a,o.layout=l}updateBinding(e){const t=this.backend,n=t.device,i=e.buffer,r=t.get(e).buffer;n.queue.writeBuffer(r,0,i,0)}createBindGroupIndex(e,t){const n=this.backend.device,i=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,r=e[0],s=n.createBuffer({label:"bindingCameraIndex_"+r,size:16,usage:i});n.queue.writeBuffer(s,0,e,0);const o=[{binding:0,resource:{buffer:s}}];return n.createBindGroup({label:"bindGroupCameraIndex_"+r,layout:t,entries:o})}createBindGroup(e,t){const n=this.backend,i=n.device;let r=0;const s=[];for(const t of e.bindings){if(t.isUniformBuffer){const e=n.get(t);if(void 0===e.buffer){const n=t.byteLength,r=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,s=i.createBuffer({label:"bindingBuffer_"+t.name,size:n,usage:r});e.buffer=s}s.push({binding:r,resource:{buffer:e.buffer}})}else if(t.isStorageBuffer){const e=n.get(t);if(void 0===e.buffer){const i=t.attribute;e.buffer=n.get(i).buffer}s.push({binding:r,resource:{buffer:e.buffer}})}else if(t.isSampler){const e=n.get(t.texture);s.push({binding:r,resource:e.sampler})}else if(t.isSampledTexture){const e=n.get(t.texture);let o;if(void 0!==e.externalTexture)o=i.importExternalTexture({source:e.externalTexture});else{const n=t.store?1:e.texture.mipLevelCount,i=`view-${e.texture.width}-${e.texture.height}-${n}`;if(o=e[i],void 0===o){const r=XG;let s;s=t.isSampledCubeTexture?WG:t.isSampledTexture3D?qG:t.texture.isArrayTexture||t.texture.isDataArrayTexture||t.texture.isCompressedArrayTexture?HG:jG,o=e[i]=e.texture.createView({aspect:r,dimension:s,mipLevelCount:n})}}s.push({binding:r,resource:o})}r++}return i.createBindGroup({label:"bindGroup_"+e.name,layout:t,entries:s})}}class Nj{constructor(e){this.backend=e,this._activePipelines=new WeakMap}setPipeline(e,t){this._activePipelines.get(e)!==t&&(e.setPipeline(t),this._activePipelines.set(e,t))}_getSampleCount(e){return this.backend.utils.getSampleCountRenderContext(e)}createRenderPipeline(e,t){const{object:n,material:i,geometry:r,pipeline:s}=e,{vertexProgram:o,fragmentProgram:a}=s,l=this.backend,c=l.device,u=l.utils,h=l.get(s),d=[];for(const t of e.getBindings()){const e=l.get(t);d.push(e.layout)}const p=l.attributeUtils.createShaderVertexBuffers(e);let f;0===i.blending||1===i.blending&&!1===i.transparent||(f=this._getBlending(i));let m={};!0===i.stencilWrite&&(m={compare:this._getStencilCompare(i),failOp:this._getStencilOperation(i.stencilFail),depthFailOp:this._getStencilOperation(i.stencilZFail),passOp:this._getStencilOperation(i.stencilZPass)});const g=this._getColorWriteMask(i),y=[];if(null!==e.context.textures){const t=e.context.textures;for(let e=0;e<t.length;e++){const n=u.getTextureFormatGPU(t[e]);y.push({format:n,blend:f,writeMask:g})}}else{const t=u.getCurrentColorFormat(e.context);y.push({format:t,blend:f,writeMask:g})}const v=l.get(o).module,_=l.get(a).module,x=this._getPrimitiveState(n,r,i),b=this._getDepthCompare(i),w=u.getCurrentDepthStencilFormat(e.context),T=this._getSampleCount(e.context),S={label:`renderPipeline_${i.name||i.type}_${i.id}`,vertex:Object.assign({},v,{buffers:p}),fragment:Object.assign({},_,{targets:y}),primitive:x,multisample:{count:T,alphaToCoverageEnabled:i.alphaToCoverage&&T>1},layout:c.createPipelineLayout({bindGroupLayouts:d})},M={},E=e.context.depth,A=e.context.stencil;if(!0!==E&&!0!==A||(!0===E&&(M.format=w,M.depthWriteEnabled=i.depthWrite,M.depthCompare=b),!0===A&&(M.stencilFront=m,M.stencilBack={},M.stencilReadMask=i.stencilFuncMask,M.stencilWriteMask=i.stencilWriteMask),!0===i.polygonOffset&&(M.depthBias=i.polygonOffsetUnits,M.depthBiasSlopeScale=i.polygonOffsetFactor,M.depthBiasClamp=0),S.depthStencil=M),null===t)h.pipeline=c.createRenderPipeline(S);else{const e=new Promise((e=>{c.createRenderPipelineAsync(S).then((t=>{h.pipeline=t,e()}))}));t.push(e)}}createBundleEncoder(e,t="renderBundleEncoder"){const n=this.backend,{utils:i,device:r}=n,s=i.getCurrentDepthStencilFormat(e),o={label:t,colorFormats:[i.getCurrentColorFormat(e)],depthStencilFormat:s,sampleCount:this._getSampleCount(e)};return r.createRenderBundleEncoder(o)}createComputePipeline(e,t){const n=this.backend,i=n.device,r=n.get(e.computeProgram).module,s=n.get(e),o=[];for(const e of t){const t=n.get(e);o.push(t.layout)}s.pipeline=i.createComputePipeline({compute:r,layout:i.createPipelineLayout({bindGroupLayouts:o})})}_getBlending(e){let t,n;const i=e.blending,r=e.blendSrc,s=e.blendDst,o=e.blendEquation;if(5===i){const i=null!==e.blendSrcAlpha?e.blendSrcAlpha:r,a=null!==e.blendDstAlpha?e.blendDstAlpha:s,l=null!==e.blendEquationAlpha?e.blendEquationAlpha:o;t={srcFactor:this._getBlendFactor(r),dstFactor:this._getBlendFactor(s),operation:this._getBlendOperation(o)},n={srcFactor:this._getBlendFactor(i),dstFactor:this._getBlendFactor(a),operation:this._getBlendOperation(l)}}else{const r=(e,i,r,s)=>{t={srcFactor:e,dstFactor:i,operation:fG},n={srcFactor:r,dstFactor:s,operation:fG}};if(e.premultipliedAlpha)switch(i){case 1:r(nG,oG,nG,oG);break;case 2:r(nG,nG,nG,nG);break;case 3:r(tG,rG,tG,nG);break;case 4:r(tG,iG,tG,sG)}else switch(i){case 1:r(sG,oG,nG,oG);break;case 2:r(sG,nG,sG,nG);break;case 3:r(tG,rG,tG,nG);break;case 4:r(tG,iG,tG,iG)}}if(void 0!==t&&void 0!==n)return{color:t,alpha:n};console.error("THREE.WebGPURenderer: Invalid blending: ",i)}_getBlendFactor(e){let t;switch(e){case ga:t=tG;break;case 201:t=nG;break;case 202:t=iG;break;case 203:t=rG;break;case xa:t=sG;break;case ba:t=oG;break;case 208:t=aG;break;case 209:t=lG;break;case 206:t=cG;break;case 207:t=uG;break;case 210:t=hG;break;case 211:t=dG;break;case 212:t=pG;break;default:console.error("THREE.WebGPURenderer: Blend factor not supported.",e)}return t}_getStencilCompare(e){let t;const n=e.stencilFunc;switch(n){case 512:t=$B;break;case 519:t=tz;break;case 513:t=YB;break;case 515:t=ZB;break;case 514:t=KB;break;case 518:t=ez;break;case 516:t=JB;break;case 517:t=QB;break;default:console.error("THREE.WebGPURenderer: Invalid stencil function.",n)}return t}_getStencilOperation(e){let t;switch(e){case rc:t=bG;break;case 0:t=wG;break;case 7681:t=TG;break;case 5386:t=SG;break;case 7682:t=MG;break;case 7683:t=EG;break;case 34055:t=AG;break;case 34056:t=CG;break;default:console.error("THREE.WebGPURenderer: Invalid stencil operation.",t)}return t}_getBlendOperation(e){let t;switch(e){case pa:t=fG;break;case 101:t=mG;break;case 102:t=gG;break;case 103:t=yG;break;case 104:t=vG;break;default:console.error("THREE.WebGPUPipelineUtils: Blend equation not supported.",e)}return t}_getPrimitiveState(e,t,n){const i={},r=this.backend.utils;switch(i.topology=r.getPrimitiveTopology(e,n),null!==t.index&&!0===e.isLine&&!0!==e.isLineSegments&&(i.stripIndexFormat=t.index.array instanceof Uint16Array?cz:uz),n.side){case 0:i.frontFace=sz,i.cullMode=lz;break;case 1:i.frontFace=sz,i.cullMode=az;break;case 2:i.frontFace=sz,i.cullMode=oz;break;default:console.error("THREE.WebGPUPipelineUtils: Unknown material.side value.",n.side)}return i}_getColorWriteMask(e){return!0===e.colorWrite?xG:_G}_getDepthCompare(e){let t;if(!1===e.depthTest)t=tz;else{const n=e.depthFunc;switch(n){case 0:t=$B;break;case 1:t=tz;break;case 2:t=YB;break;case 3:t=ZB;break;case 4:t=KB;break;case 5:t=ez;break;case 6:t=JB;break;case 7:t=QB;break;default:console.error("THREE.WebGPUPipelineUtils: Invalid depth function.",n)}}return t}}class Pj extends BB{constructor(e,t,n=2048){super(n),this.device=e,this.type=t,this.querySet=this.device.createQuerySet({type:"timestamp",count:this.maxQueries,label:`queryset_global_timestamp_${t}`});const i=8*this.maxQueries;this.resolveBuffer=this.device.createBuffer({label:`buffer_timestamp_resolve_${t}`,size:i,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=this.device.createBuffer({label:`buffer_timestamp_result_${t}`,size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})}allocateQueriesForContext(e){if(!this.trackTimestamp||this.isDisposed)return null;if(this.currentQueryIndex+2>this.maxQueries)return Vc(`WebGPUTimestampQueryPool [${this.type}]: Maximum number of queries exceeded, when using trackTimestamp it is necessary to resolves the queries via renderer.resolveTimestampsAsync( THREE.TimestampQuery.${this.type.toUpperCase()} ).`),null;const t=this.currentQueryIndex;return this.currentQueryIndex+=2,this.queryOffsets.set(e.id,t),t}async resolveQueriesAsync(){if(!this.trackTimestamp||0===this.currentQueryIndex||this.isDisposed)return this.lastValue;if(this.pendingResolve)return this.pendingResolve;this.pendingResolve=this._resolveQueries();try{return await this.pendingResolve}finally{this.pendingResolve=null}}async _resolveQueries(){if(this.isDisposed)return this.lastValue;try{if("unmapped"!==this.resultBuffer.mapState)return this.lastValue;const e=new Map(this.queryOffsets),t=this.currentQueryIndex,n=8*t;this.currentQueryIndex=0,this.queryOffsets.clear();const i=this.device.createCommandEncoder();i.resolveQuerySet(this.querySet,0,t,this.resolveBuffer,0),i.copyBufferToBuffer(this.resolveBuffer,0,this.resultBuffer,0,n);const r=i.finish();if(this.device.queue.submit([r]),"unmapped"!==this.resultBuffer.mapState)return this.lastValue;if(await this.resultBuffer.mapAsync(GPUMapMode.READ,0,n),this.isDisposed)return"mapped"===this.resultBuffer.mapState&&this.resultBuffer.unmap(),this.lastValue;const s=new BigUint64Array(this.resultBuffer.getMappedRange(0,n));let o=0;for(const[,t]of e){const e=s[t],n=s[t+1];o+=Number(n-e)/1e6}return this.resultBuffer.unmap(),this.lastValue=o,o}catch(e){return console.error("Error resolving queries:",e),"mapped"===this.resultBuffer.mapState&&this.resultBuffer.unmap(),this.lastValue}}async dispose(){if(!this.isDisposed){if(this.isDisposed=!0,this.pendingResolve)try{await this.pendingResolve}catch(e){console.error("Error waiting for pending resolve:",e)}if(this.resultBuffer&&"mapped"===this.resultBuffer.mapState)try{this.resultBuffer.unmap()}catch(e){console.error("Error unmapping buffer:",e)}this.querySet&&(this.querySet.destroy(),this.querySet=null),this.resolveBuffer&&(this.resolveBuffer.destroy(),this.resolveBuffer=null),this.resultBuffer&&(this.resultBuffer.destroy(),this.resultBuffer=null),this.queryOffsets.clear(),this.pendingResolve=null}}}class Dj extends bB{constructor(e={}){super(e),this.isWebGPUBackend=!0,this.parameters.alpha=void 0===e.alpha||e.alpha,this.parameters.compatibilityMode=void 0!==e.compatibilityMode&&e.compatibilityMode,this.parameters.requiredLimits=void 0===e.requiredLimits?{}:e.requiredLimits,this.compatibilityMode=this.parameters.compatibilityMode,this.device=null,this.context=null,this.colorBuffer=null,this.defaultRenderPassdescriptor=null,this.utils=new Sj(this),this.attributeUtils=new Cj(this),this.bindingUtils=new Rj(this),this.pipelineUtils=new Nj(this),this.textureUtils=new sj(this),this.occludedResolveCache=new Map}async init(e){await super.init(e);const t=this.parameters;let n;if(void 0===t.device){const e={powerPreference:t.powerPreference,featureLevel:t.compatibilityMode?"compatibility":void 0},i="undefined"!=typeof navigator?await navigator.gpu.requestAdapter(e):null;if(null===i)throw new Error("WebGPUBackend: Unable to create WebGPU adapter.");const r=Object.values(KG),s=[];for(const e of r)i.features.has(e)&&s.push(e);const o={requiredFeatures:s,requiredLimits:t.requiredLimits};n=await i.requestDevice(o)}else n=t.device;n.lost.then((t=>{const n={api:"WebGPU",message:t.message||"Unknown reason",reason:t.reason||null,originalEvent:t};e.onDeviceLost(n)}));const i=void 0!==t.context?t.context:e.domElement.getContext("webgpu");this.device=n,this.context=i;const r=t.alpha?"premultiplied":"opaque";this.trackTimestamp=this.trackTimestamp&&this.hasFeature(KG.TimestampQuery),this.context.configure({device:this.device,format:this.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:r}),this.updateSize()}get coordinateSystem(){return yc}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}getContext(){return this.context}_getDefaultRenderPassDescriptor(){let e=this.defaultRenderPassdescriptor;if(null===e){const t=this.renderer;e={colorAttachments:[{view:null}]},!0!==this.renderer.depth&&!0!==this.renderer.stencil||(e.depthStencilAttachment={view:this.textureUtils.getDepthBuffer(t.depth,t.stencil).createView()});const n=e.colorAttachments[0];this.renderer.samples>0?n.view=this.colorBuffer.createView():n.resolveTarget=void 0,this.defaultRenderPassdescriptor=e}const t=e.colorAttachments[0];return this.renderer.samples>0?t.resolveTarget=this.context.getCurrentTexture().createView():t.view=this.context.getCurrentTexture().createView(),e}_isRenderCameraDepthArray(e){return e.depthTexture&&e.depthTexture.image.depth>1&&e.camera.isArrayCamera}_getRenderPassDescriptor(e,t={}){const n=e.renderTarget,i=this.get(n);let r=i.descriptors;if(void 0===r||i.width!==n.width||i.height!==n.height||i.dimensions!==n.dimensions||i.activeMipmapLevel!==e.activeMipmapLevel||i.activeCubeFace!==e.activeCubeFace||i.samples!==n.samples){r={},i.descriptors=r;const e=()=>{n.removeEventListener("dispose",e),this.delete(n)};!1===n.hasEventListener("dispose",e)&&n.addEventListener("dispose",e)}const s=e.getCacheKey();let o=r[s];if(void 0===o){const t=e.textures,a=[];let l;const c=this._isRenderCameraDepthArray(e);for(let i=0;i<t.length;i++){const r=this.get(t[i]),s={label:`colorAttachment_${i}`,baseMipLevel:e.activeMipmapLevel,mipLevelCount:1,baseArrayLayer:e.activeCubeFace,arrayLayerCount:1,dimension:jG};if(n.isRenderTarget3D)l=e.activeCubeFace,s.baseArrayLayer=0,s.dimension=qG,s.depthOrArrayLayers=t[i].image.depth;else if(n.isRenderTarget&&t[i].image.depth>1)if(!0===c){const t=e.camera.cameras;for(let e=0;e<t.length;e++){const t={...s,baseArrayLayer:e,arrayLayerCount:1,dimension:jG},n=r.texture.createView(t);a.push({view:n,resolveTarget:void 0,depthSlice:void 0})}}else s.dimension=HG,s.depthOrArrayLayers=t[i].image.depth;if(!0!==c){const e=r.texture.createView(s);let t,n;void 0!==r.msaaTexture?(t=r.msaaTexture.createView(),n=e):(t=e,n=void 0),a.push({view:t,resolveTarget:n,depthSlice:l})}}if(o={textureViews:a},e.depth){const t=this.get(e.depthTexture),n={};e.depthTexture.isArrayTexture&&(n.dimension=jG,n.arrayLayerCount=1,n.baseArrayLayer=e.activeCubeFace),o.depthStencilView=t.texture.createView(n)}r[s]=o,i.width=n.width,i.height=n.height,i.samples=n.samples,i.activeMipmapLevel=e.activeMipmapLevel,i.activeCubeFace=e.activeCubeFace,i.dimensions=n.dimensions}const a={colorAttachments:[]};for(let e=0;e<o.textureViews.length;e++){const n=o.textureViews[e];let i={r:0,g:0,b:0,a:1};0===e&&t.clearValue&&(i=t.clearValue),a.colorAttachments.push({view:n.view,depthSlice:n.depthSlice,resolveTarget:n.resolveTarget,loadOp:t.loadOp||iz,storeOp:t.storeOp||nz,clearValue:i})}return o.depthStencilView&&(a.depthStencilAttachment={view:o.depthStencilView}),a}beginRender(e){const t=this.get(e),n=this.device,i=e.occlusionQueryCount;let r,s;i>0&&(t.currentOcclusionQuerySet&&t.currentOcclusionQuerySet.destroy(),t.currentOcclusionQueryBuffer&&t.currentOcclusionQueryBuffer.destroy(),t.currentOcclusionQuerySet=t.occlusionQuerySet,t.currentOcclusionQueryBuffer=t.occlusionQueryBuffer,t.currentOcclusionQueryObjects=t.occlusionQueryObjects,r=n.createQuerySet({type:"occlusion",count:i,label:`occlusionQuerySet_${e.id}`}),t.occlusionQuerySet=r,t.occlusionQueryIndex=0,t.occlusionQueryObjects=new Array(i),t.lastOcclusionObject=null),s=null===e.textures?this._getDefaultRenderPassDescriptor():this._getRenderPassDescriptor(e,{loadOp:iz}),this.initTimestampQuery(e,s),s.occlusionQuerySet=r;const o=s.depthStencilAttachment;if(null!==e.textures){const t=s.colorAttachments;for(let n=0;n<t.length;n++){const i=t[n];e.clearColor?(i.clearValue=0===n?e.clearColorValue:{r:0,g:0,b:0,a:1},i.loadOp=rz):i.loadOp=iz,i.storeOp=nz}}else{const t=s.colorAttachments[0];e.clearColor?(t.clearValue=e.clearColorValue,t.loadOp=rz):t.loadOp=iz,t.storeOp=nz}e.depth&&(e.clearDepth?(o.depthClearValue=e.clearDepthValue,o.depthLoadOp=rz):o.depthLoadOp=iz,o.depthStoreOp=nz),e.stencil&&(e.clearStencil?(o.stencilClearValue=e.clearStencilValue,o.stencilLoadOp=rz):o.stencilLoadOp=iz,o.stencilStoreOp=nz);const a=n.createCommandEncoder({label:"renderContext_"+e.id});if(!0===this._isRenderCameraDepthArray(e)){const n=e.camera.cameras;t.layerDescriptors&&t.layerDescriptors.length===n.length?this._updateDepthLayerDescriptors(e,t,n):this._createDepthLayerDescriptors(e,t,s,n),t.bundleEncoders=[],t.bundleSets=[];for(let i=0;i<n.length;i++){const n=this.pipelineUtils.createBundleEncoder(e,"renderBundleArrayCamera_"+i),r={attributes:{},bindingGroups:[],pipeline:null,index:null};t.bundleEncoders.push(n),t.bundleSets.push(r)}t.currentPass=null}else{const n=a.beginRenderPass(s);if(t.currentPass=n,e.viewport&&this.updateViewport(e),e.scissor){const{x:t,y:i,width:r,height:s}=e.scissorValue;n.setScissorRect(t,i,r,s)}}t.descriptor=s,t.encoder=a,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.renderBundles=[]}_createDepthLayerDescriptors(e,t,n,i){const r=n.depthStencilAttachment;t.layerDescriptors=[];const s=this.get(e.depthTexture);s.viewCache||(s.viewCache=[]);for(let o=0;o<i.length;o++){const i={...n,colorAttachments:[{...n.colorAttachments[0],view:n.colorAttachments[o].view}]};if(n.depthStencilAttachment){const t=o;s.viewCache[t]||(s.viewCache[t]=s.texture.createView({dimension:jG,baseArrayLayer:o,arrayLayerCount:1})),i.depthStencilAttachment={view:s.viewCache[t],depthLoadOp:r.depthLoadOp||rz,depthStoreOp:r.depthStoreOp||nz,depthClearValue:r.depthClearValue||1},e.stencil&&(i.depthStencilAttachment.stencilLoadOp=r.stencilLoadOp,i.depthStencilAttachment.stencilStoreOp=r.stencilStoreOp,i.depthStencilAttachment.stencilClearValue=r.stencilClearValue)}else i.depthStencilAttachment={...r};t.layerDescriptors.push(i)}}_updateDepthLayerDescriptors(e,t,n){for(let i=0;i<n.length;i++){const n=t.layerDescriptors[i];if(n.depthStencilAttachment){const t=n.depthStencilAttachment;e.depth&&(e.clearDepth?(t.depthClearValue=e.clearDepthValue,t.depthLoadOp=rz):t.depthLoadOp=iz),e.stencil&&(e.clearStencil?(t.stencilClearValue=e.clearStencilValue,t.stencilLoadOp=rz):t.stencilLoadOp=iz)}}}finishRender(e){const t=this.get(e),n=e.occlusionQueryCount;t.renderBundles.length>0&&t.currentPass.executeBundles(t.renderBundles),n>t.occlusionQueryIndex&&t.currentPass.endOcclusionQuery();const i=t.encoder;if(!0===this._isRenderCameraDepthArray(e)){const n=[];for(let e=0;e<t.bundleEncoders.length;e++){const i=t.bundleEncoders[e];n.push(i.finish())}for(let r=0;r<t.layerDescriptors.length;r++)if(r<n.length){const s=t.layerDescriptors[r],o=i.beginRenderPass(s);if(e.viewport){const{x:t,y:n,width:i,height:r,minDepth:s,maxDepth:a}=e.viewportValue;o.setViewport(t,n,i,r,s,a)}if(e.scissor){const{x:t,y:n,width:i,height:r}=e.scissorValue;o.setScissorRect(t,n,i,r)}o.executeBundles([n[r]]),o.end()}}else t.currentPass&&t.currentPass.end();if(n>0){const i=8*n;let r=this.occludedResolveCache.get(i);void 0===r&&(r=this.device.createBuffer({size:i,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.occludedResolveCache.set(i,r));const s=this.device.createBuffer({size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});t.encoder.resolveQuerySet(t.occlusionQuerySet,0,n,r,0),t.encoder.copyBufferToBuffer(r,0,s,0,i),t.occlusionQueryBuffer=s,this.resolveOccludedAsync(e)}if(this.device.queue.submit([t.encoder.finish()]),null!==e.textures){const t=e.textures;for(let e=0;e<t.length;e++){const n=t[e];!0===n.generateMipmaps&&this.textureUtils.generateMipmaps(n)}}}isOccluded(e,t){const n=this.get(e);return n.occluded&&n.occluded.has(t)}async resolveOccludedAsync(e){const t=this.get(e),{currentOcclusionQueryBuffer:n,currentOcclusionQueryObjects:i}=t;if(n&&i){const e=new WeakSet;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueryBuffer=null,await n.mapAsync(GPUMapMode.READ);const r=n.getMappedRange(),s=new BigUint64Array(r);for(let t=0;t<i.length;t++)s[t]===BigInt(0)&&e.add(i[t]);n.destroy(),t.occluded=e}}updateViewport(e){const{currentPass:t}=this.get(e),{x:n,y:i,width:r,height:s,minDepth:o,maxDepth:a}=e.viewportValue;t.setViewport(n,i,r,s,o,a)}getClearColor(){const e=super.getClearColor();return!0===this.renderer.alpha&&(e.r*=e.a,e.g*=e.a,e.b*=e.a),e}clear(e,t,n,i=null){const r=this.device,s=this.renderer;let o,a,l,c,u=[];if(e){const e=this.getClearColor();a={r:e.r,g:e.g,b:e.b,a:e.a}}if(null===i){l=s.depth,c=s.stencil;const t=this._getDefaultRenderPassDescriptor();if(e){u=t.colorAttachments;const e=u[0];e.clearValue=a,e.loadOp=rz,e.storeOp=nz}(l||c)&&(o=t.depthStencilAttachment)}else{l=i.depth,c=i.stencil;const r={loadOp:e?rz:iz,clearValue:e?a:void 0};l&&(r.depthLoadOp=t?rz:iz,r.depthClearValue=t?s.getClearDepth():void 0,r.depthStoreOp=nz),c&&(r.stencilLoadOp=n?rz:iz,r.stencilClearValue=n?s.getClearStencil():void 0,r.stencilStoreOp=nz);const h=this._getRenderPassDescriptor(i,r);u=h.colorAttachments,o=h.depthStencilAttachment}l&&o&&void 0===o.depthLoadOp&&(t?(o.depthLoadOp=rz,o.depthClearValue=s.getClearDepth(),o.depthStoreOp=nz):(o.depthLoadOp=iz,o.depthStoreOp=nz)),c&&o&&void 0===o.stencilLoadOp&&(n?(o.stencilLoadOp=rz,o.stencilClearValue=s.getClearStencil(),o.stencilStoreOp=nz):(o.stencilLoadOp=iz,o.stencilStoreOp=nz));const h=r.createCommandEncoder({label:"clear"});h.beginRenderPass({colorAttachments:u,depthStencilAttachment:o}).end(),r.queue.submit([h.finish()])}beginCompute(e){const t=this.get(e),n={label:"computeGroup_"+e.id};this.initTimestampQuery(e,n),t.cmdEncoderGPU=this.device.createCommandEncoder({label:"computeGroup_"+e.id}),t.passEncoderGPU=t.cmdEncoderGPU.beginComputePass(n)}compute(e,t,n,i){const{passEncoderGPU:r}=this.get(e),s=this.get(i).pipeline;this.pipelineUtils.setPipeline(r,s);for(let e=0,t=n.length;e<t;e++){const t=n[e],i=this.get(t);r.setBindGroup(e,i.group)}const o=this.device.limits.maxComputeWorkgroupsPerDimension,a=this.get(t);void 0===a.dispatchSize&&(a.dispatchSize={x:0,y:1,z:1});const{dispatchSize:l}=a;t.dispatchCount>o?(l.x=Math.min(t.dispatchCount,o),l.y=Math.ceil(t.dispatchCount/o)):l.x=t.dispatchCount,r.dispatchWorkgroups(l.x,l.y,l.z)}finishCompute(e){const t=this.get(e);t.passEncoderGPU.end(),this.device.queue.submit([t.cmdEncoderGPU.finish()])}async waitForGPU(){await this.device.queue.onSubmittedWorkDone()}draw(e,t){const{object:n,material:i,context:r,pipeline:s}=e,o=e.getBindings(),a=this.get(r),l=this.get(s).pipeline,c=e.getIndex(),u=null!==c,h=e.getDrawParameters();if(null===h)return;const d=(t,n)=>{this.pipelineUtils.setPipeline(t,l),n.pipeline=l;const s=n.bindingGroups;for(let e=0,n=o.length;e<n;e++){const n=o[e],i=this.get(n);s[n.index]!==n.id&&(t.setBindGroup(n.index,i.group),s[n.index]=n.id)}if(!0===u&&n.index!==c){const e=this.get(c).buffer,i=c.array instanceof Uint16Array?cz:uz;t.setIndexBuffer(e,i),n.index=c}const h=e.getVertexBuffers();for(let e=0,i=h.length;e<i;e++){const i=h[e];if(n.attributes[e]!==i){const r=this.get(i).buffer;t.setVertexBuffer(e,r),n.attributes[e]=i}}!0===r.stencil&&!0===i.stencilWrite&&a.currentStencilRef!==i.stencilRef&&(t.setStencilReference(i.stencilRef),a.currentStencilRef=i.stencilRef)},p=(i,r)=>{if(d(i,r),!0===n.isBatchedMesh){const e=n._multiDrawStarts,r=n._multiDrawCounts,s=n._multiDrawCount,o=n._multiDrawInstances;null!==o&&Vc("THREE.WebGPUBackend: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection.");for(let a=0;a<s;a++){const s=o?o[a]:1,l=s>1?0:a;!0===u?i.drawIndexed(r[a],s,e[a]/c.array.BYTES_PER_ELEMENT,0,l):i.draw(r[a],s,e[a],l),t.update(n,r[a],s)}}else if(!0===u){const{vertexCount:r,instanceCount:s,firstVertex:o}=h,a=e.getIndirect();if(null!==a){const e=this.get(a).buffer;i.drawIndexedIndirect(e,0)}else i.drawIndexed(r,s,o,0,0);t.update(n,r,s)}else{const{vertexCount:r,instanceCount:s,firstVertex:o}=h,a=e.getIndirect();if(null!==a){const e=this.get(a).buffer;i.drawIndirect(e,0)}else i.draw(r,s,o,0);t.update(n,r,s)}};if(e.camera.isArrayCamera&&e.camera.cameras.length>0){const t=this.get(e.camera),i=e.camera.cameras,s=e.getBindingGroup("cameraIndex");if(void 0===t.indexesGPU||t.indexesGPU.length!==i.length){const e=this.get(s),n=[],r=new Uint32Array([0,0,0,0]);for(let t=0,s=i.length;t<s;t++){r[0]=t;const i=this.bindingUtils.createBindGroupIndex(r,e.layout);n.push(i)}t.indexesGPU=n}const o=this.renderer.getPixelRatio();for(let e=0,l=i.length;e<l;e++){const l=i[e];if(n.layers.test(l.layers)){const n=l.viewport;let i=a.currentPass,c=a.currentSets;if(a.bundleEncoders){i=a.bundleEncoders[e],c=a.bundleSets[e]}n&&i.setViewport(Math.floor(n.x*o),Math.floor(n.y*o),Math.floor(n.width*o),Math.floor(n.height*o),r.viewportValue.minDepth,r.viewportValue.maxDepth),s&&t.indexesGPU&&(i.setBindGroup(s.index,t.indexesGPU[e]),c.bindingGroups[s.index]=s.id),p(i,c)}}}else if(a.currentPass){if(void 0!==a.occlusionQuerySet){const e=a.lastOcclusionObject;e!==n&&(null!==e&&!0===e.occlusionTest&&(a.currentPass.endOcclusionQuery(),a.occlusionQueryIndex++),!0===n.occlusionTest&&(a.currentPass.beginOcclusionQuery(a.occlusionQueryIndex),a.occlusionQueryObjects[a.occlusionQueryIndex]=n),a.lastOcclusionObject=n)}p(a.currentPass,a.currentSets)}}needsRenderUpdate(e){const t=this.get(e),{object:n,material:i}=e,r=this.utils,s=r.getSampleCountRenderContext(e.context),o=r.getCurrentColorSpace(e.context),a=r.getCurrentColorFormat(e.context),l=r.getCurrentDepthStencilFormat(e.context),c=r.getPrimitiveTopology(n,i);let u=!1;return t.material===i&&t.materialVersion===i.version&&t.transparent===i.transparent&&t.blending===i.blending&&t.premultipliedAlpha===i.premultipliedAlpha&&t.blendSrc===i.blendSrc&&t.blendDst===i.blendDst&&t.blendEquation===i.blendEquation&&t.blendSrcAlpha===i.blendSrcAlpha&&t.blendDstAlpha===i.blendDstAlpha&&t.blendEquationAlpha===i.blendEquationAlpha&&t.colorWrite===i.colorWrite&&t.depthWrite===i.depthWrite&&t.depthTest===i.depthTest&&t.depthFunc===i.depthFunc&&t.stencilWrite===i.stencilWrite&&t.stencilFunc===i.stencilFunc&&t.stencilFail===i.stencilFail&&t.stencilZFail===i.stencilZFail&&t.stencilZPass===i.stencilZPass&&t.stencilFuncMask===i.stencilFuncMask&&t.stencilWriteMask===i.stencilWriteMask&&t.side===i.side&&t.alphaToCoverage===i.alphaToCoverage&&t.sampleCount===s&&t.colorSpace===o&&t.colorFormat===a&&t.depthStencilFormat===l&&t.primitiveTopology===c&&t.clippingContextCacheKey===e.clippingContextCacheKey||(t.material=i,t.materialVersion=i.version,t.transparent=i.transparent,t.blending=i.blending,t.premultipliedAlpha=i.premultipliedAlpha,t.blendSrc=i.blendSrc,t.blendDst=i.blendDst,t.blendEquation=i.blendEquation,t.blendSrcAlpha=i.blendSrcAlpha,t.blendDstAlpha=i.blendDstAlpha,t.blendEquationAlpha=i.blendEquationAlpha,t.colorWrite=i.colorWrite,t.depthWrite=i.depthWrite,t.depthTest=i.depthTest,t.depthFunc=i.depthFunc,t.stencilWrite=i.stencilWrite,t.stencilFunc=i.stencilFunc,t.stencilFail=i.stencilFail,t.stencilZFail=i.stencilZFail,t.stencilZPass=i.stencilZPass,t.stencilFuncMask=i.stencilFuncMask,t.stencilWriteMask=i.stencilWriteMask,t.side=i.side,t.alphaToCoverage=i.alphaToCoverage,t.sampleCount=s,t.colorSpace=o,t.colorFormat=a,t.depthStencilFormat=l,t.primitiveTopology=c,t.clippingContextCacheKey=e.clippingContextCacheKey,u=!0),u}getRenderCacheKey(e){const{object:t,material:n}=e,i=this.utils,r=e.context;return[n.transparent,n.blending,n.premultipliedAlpha,n.blendSrc,n.blendDst,n.blendEquation,n.blendSrcAlpha,n.blendDstAlpha,n.blendEquationAlpha,n.colorWrite,n.depthWrite,n.depthTest,n.depthFunc,n.stencilWrite,n.stencilFunc,n.stencilFail,n.stencilZFail,n.stencilZPass,n.stencilFuncMask,n.stencilWriteMask,n.side,i.getSampleCountRenderContext(r),i.getCurrentColorSpace(r),i.getCurrentColorFormat(r),i.getCurrentDepthStencilFormat(r),i.getPrimitiveTopology(t,n),e.getGeometryCacheKey(),e.clippingContextCacheKey].join()}createSampler(e){this.textureUtils.createSampler(e)}destroySampler(e){this.textureUtils.destroySampler(e)}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}async copyTextureToBuffer(e,t,n,i,r,s){return this.textureUtils.copyTextureToBuffer(e,t,n,i,r,s)}initTimestampQuery(e,t){if(!this.trackTimestamp)return;const n=e.isComputeNode?"compute":"render";this.timestampQueryPool[n]||(this.timestampQueryPool[n]=new Pj(this.device,n,2048));const i=this.timestampQueryPool[n],r=i.allocateQueriesForContext(e);t.timestampWrites={querySet:i.querySet,beginningOfPassWriteIndex:r,endOfPassWriteIndex:r+1}}createNodeBuilder(e,t){return new Tj(e,t)}createProgram(e){this.get(e).module={module:this.device.createShaderModule({code:e.code,label:e.stage+(""!==e.name?`_${e.name}`:"")}),entryPoint:"main"}}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){this.pipelineUtils.createRenderPipeline(e,t)}createComputePipeline(e,t){this.pipelineUtils.createComputePipeline(e,t)}beginBundle(e){const t=this.get(e);t._currentPass=t.currentPass,t._currentSets=t.currentSets,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.currentPass=this.pipelineUtils.createBundleEncoder(e)}finishBundle(e,t){const n=this.get(e),i=n.currentPass.finish();this.get(t).bundleGPU=i,n.currentSets=n._currentSets,n.currentPass=n._currentPass}addBundle(e,t){this.get(e).renderBundles.push(this.get(t).bundleGPU)}createBindings(e,t,n,i){this.bindingUtils.createBindings(e,t,n,i)}updateBindings(e,t,n,i){this.bindingUtils.createBindings(e,t,n,i)}updateBinding(e){this.bindingUtils.updateBinding(e)}createIndexAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.INDEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createIndirectStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}updateSize(){this.colorBuffer=this.textureUtils.getColorBuffer(),this.defaultRenderPassdescriptor=null}getMaxAnisotropy(){return 16}hasFeature(e){return this.device.features.has(e)}copyTextureToTexture(e,t,n=null,i=null,r=0,s=0){let o=0,a=0,l=0,c=0,u=0,h=0,d=e.image.width,p=e.image.height,f=1;null!==n&&(!0===n.isBox3?(c=n.min.x,u=n.min.y,h=n.min.z,d=n.max.x-n.min.x,p=n.max.y-n.min.y,f=n.max.z-n.min.z):(c=n.min.x,u=n.min.y,d=n.max.x-n.min.x,p=n.max.y-n.min.y,f=1)),null!==i&&(o=i.x,a=i.y,l=i.z||0);const m=this.device.createCommandEncoder({label:"copyTextureToTexture_"+e.id+"_"+t.id}),g=this.get(e).texture,y=this.get(t).texture;m.copyTextureToTexture({texture:g,mipLevel:r,origin:{x:c,y:u,z:h}},{texture:y,mipLevel:s,origin:{x:o,y:a,z:l}},[d,p,f]),this.device.queue.submit([m.finish()]),0===s&&t.generateMipmaps&&this.textureUtils.generateMipmaps(t)}copyFramebufferToTexture(e,t,n){const i=this.get(t);let r=null;r=t.renderTarget?e.isDepthTexture?this.get(t.depthTexture).texture:this.get(t.textures[0]).texture:e.isDepthTexture?this.textureUtils.getDepthBuffer(t.depth,t.stencil):this.context.getCurrentTexture();const s=this.get(e).texture;if(r.format!==s.format)return void console.error("WebGPUBackend: copyFramebufferToTexture: Source and destination formats do not match.",r.format,s.format);let o;if(i.currentPass?(i.currentPass.end(),o=i.encoder):o=this.device.createCommandEncoder({label:"copyFramebufferToTexture_"+e.id}),o.copyTextureToTexture({texture:r,origin:[n.x,n.y,0]},{texture:s},[n.z,n.w]),i.currentPass){const{descriptor:e}=i;for(let t=0;t<e.colorAttachments.length;t++)e.colorAttachments[t].loadOp=iz;if(t.depth&&(e.depthStencilAttachment.depthLoadOp=iz),t.stencil&&(e.depthStencilAttachment.stencilLoadOp=iz),i.currentPass=o.beginRenderPass(e),i.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.viewport&&this.updateViewport(t),t.scissor){const{x:e,y:n,width:r,height:s}=t.scissorValue;i.currentPass.setScissorRect(e,n,r,s)}}else this.device.queue.submit([o.finish()]);e.generateMipmaps&&this.textureUtils.generateMipmaps(e)}}class Lj extends Wp{constructor(e,t,n,i,r,s){super(e,t,n,i,r,s),this.iesMap=null}copy(e,t){return super.copy(e,t),this.iesMap=e.iesMap,this}}class Ij extends Wp{constructor(e,t,n,i,r,s){super(e,t,n,i,r,s),this.aspect=null}copy(e,t){return super.copy(e,t),this.aspect=e.aspect,this}}class kj extends PF{constructor(){super(),this.addMaterial(iL,"MeshPhongMaterial"),this.addMaterial(HI,"MeshStandardMaterial"),this.addMaterial(qI,"MeshPhysicalMaterial"),this.addMaterial(KI,"MeshToonMaterial"),this.addMaterial($D,"MeshBasicMaterial"),this.addMaterial(tL,"MeshLambertMaterial"),this.addMaterial(ID,"MeshNormalMaterial"),this.addMaterial(ek,"MeshMatcapMaterial"),this.addMaterial(ND,"LineBasicMaterial"),this.addMaterial(DD,"LineDashedMaterial"),this.addMaterial(ok,"PointsMaterial"),this.addMaterial(rk,"SpriteMaterial"),this.addMaterial(ck,"ShadowMaterial"),this.addLight(_U,Kp),this.addLight(iF,Qp),this.addLight(aF,tf),this.addLight(lF,Wp),this.addLight(dF,ef),this.addLight(pF,Bp),this.addLight(fF,rf),this.addLight(cF,Lj),this.addLight(hF,Ij),this.addToneMapping(yO,1),this.addToneMapping(vO,2),this.addToneMapping(_O,3),this.addToneMapping(bO,4),this.addToneMapping(MO,6),this.addToneMapping(EO,7)}}class Oj extends JF{constructor(e={}){let t;e.forceWebGL?t=GB:(t=Dj,e.getFallback=()=>(console.warn("THREE.WebGPURenderer: WebGPU is not available, running under WebGL2 backend."),new GB(e)));super(new t(e),e),this.library=new kj,this.isWebGPURenderer=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}}const Uj={type:"change"},Fj={type:"start"},Bj={type:"end"},zj=1e-6,Vj=-1,Gj=0,jj=1,Hj=2,Wj=3,qj=4,Xj=new Nc,$j=new Nc,Yj=new Dc,Kj=new Dc,Zj=new Dc,Jj=new Pc,Qj=new Dc,eH=new Dc,tH=new Dc,nH=new Dc;class iH extends mf{constructor(e,t=null){super(e,t),this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.keys=["KeyA","KeyS","KeyD"],this.mouseButtons={LEFT:ia,MIDDLE:ra,RIGHT:sa},this.target=new Dc,this.state=Vj,this.keyState=Vj,this._lastPosition=new Dc,this._lastZoom=1,this._touchZoomDistanceStart=0,this._touchZoomDistanceEnd=0,this._lastAngle=0,this._eye=new Dc,this._movePrev=new Nc,this._moveCurr=new Nc,this._lastAxis=new Dc,this._zoomStart=new Nc,this._zoomEnd=new Nc,this._panStart=new Nc,this._panEnd=new Nc,this._pointers=[],this._pointerPositions={},this._onPointerMove=sH.bind(this),this._onPointerDown=rH.bind(this),this._onPointerUp=oH.bind(this),this._onPointerCancel=aH.bind(this),this._onContextMenu=fH.bind(this),this._onMouseWheel=pH.bind(this),this._onKeyDown=cH.bind(this),this._onKeyUp=lH.bind(this),this._onTouchStart=mH.bind(this),this._onTouchMove=gH.bind(this),this._onTouchEnd=yH.bind(this),this._onMouseDown=uH.bind(this),this._onMouseMove=hH.bind(this),this._onMouseUp=dH.bind(this),this._target0=this.target.clone(),this._position0=this.object.position.clone(),this._up0=this.object.up.clone(),this._zoom0=this.object.zoom,null!==t&&(this.connect(t),this.handleResize()),this.update()}connect(e){super.connect(e),window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerCancel),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="none"}disconnect(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerCancel),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}handleResize(){const e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}update(){this._eye.subVectors(this.object.position,this.target),this.noRotate||this._rotateCamera(),this.noZoom||this._zoomCamera(),this.noPan||this._panCamera(),this.object.position.addVectors(this.target,this._eye),this.object.isPerspectiveCamera?(this._checkDistances(),this.object.lookAt(this.target),this._lastPosition.distanceToSquared(this.object.position)>zj&&(this.dispatchEvent(Uj),this._lastPosition.copy(this.object.position))):this.object.isOrthographicCamera?(this.object.lookAt(this.target),(this._lastPosition.distanceToSquared(this.object.position)>zj||this._lastZoom!==this.object.zoom)&&(this.dispatchEvent(Uj),this._lastPosition.copy(this.object.position),this._lastZoom=this.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type.")}reset(){this.state=Vj,this.keyState=Vj,this.target.copy(this._target0),this.object.position.copy(this._position0),this.object.up.copy(this._up0),this.object.zoom=this._zoom0,this.object.updateProjectionMatrix(),this._eye.subVectors(this.object.position,this.target),this.object.lookAt(this.target),this.dispatchEvent(Uj),this._lastPosition.copy(this.object.position),this._lastZoom=this.object.zoom}_panCamera(){if($j.copy(this._panEnd).sub(this._panStart),$j.lengthSq()){if(this.object.isOrthographicCamera){const e=(this.object.right-this.object.left)/this.object.zoom/this.domElement.clientWidth,t=(this.object.top-this.object.bottom)/this.object.zoom/this.domElement.clientWidth;$j.x*=e,$j.y*=t}$j.multiplyScalar(this._eye.length()*this.panSpeed),Kj.copy(this._eye).cross(this.object.up).setLength($j.x),Kj.add(Yj.copy(this.object.up).setLength($j.y)),this.object.position.add(Kj),this.target.add(Kj),this.staticMoving?this._panStart.copy(this._panEnd):this._panStart.add($j.subVectors(this._panEnd,this._panStart).multiplyScalar(this.dynamicDampingFactor))}}_rotateCamera(){nH.set(this._moveCurr.x-this._movePrev.x,this._moveCurr.y-this._movePrev.y,0);let e=nH.length();e?(this._eye.copy(this.object.position).sub(this.target),Qj.copy(this._eye).normalize(),eH.copy(this.object.up).normalize(),tH.crossVectors(eH,Qj).normalize(),eH.setLength(this._moveCurr.y-this._movePrev.y),tH.setLength(this._moveCurr.x-this._movePrev.x),nH.copy(eH.add(tH)),Zj.crossVectors(nH,this._eye).normalize(),e*=this.rotateSpeed,Jj.setFromAxisAngle(Zj,e),this._eye.applyQuaternion(Jj),this.object.up.applyQuaternion(Jj),this._lastAxis.copy(Zj),this._lastAngle=e):!this.staticMoving&&this._lastAngle&&(this._lastAngle*=Math.sqrt(1-this.dynamicDampingFactor),this._eye.copy(this.object.position).sub(this.target),Jj.setFromAxisAngle(this._lastAxis,this._lastAngle),this._eye.applyQuaternion(Jj),this.object.up.applyQuaternion(Jj)),this._movePrev.copy(this._moveCurr)}_zoomCamera(){let e;this.state===qj?(e=this._touchZoomDistanceStart/this._touchZoomDistanceEnd,this._touchZoomDistanceStart=this._touchZoomDistanceEnd,this.object.isPerspectiveCamera?this._eye.multiplyScalar(e):this.object.isOrthographicCamera?(this.object.zoom=Rc.clamp(this.object.zoom/e,this.minZoom,this.maxZoom),this._lastZoom!==this.object.zoom&&this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")):(e=1+(this._zoomEnd.y-this._zoomStart.y)*this.zoomSpeed,1!==e&&e>0&&(this.object.isPerspectiveCamera?this._eye.multiplyScalar(e):this.object.isOrthographicCamera?(this.object.zoom=Rc.clamp(this.object.zoom/e,this.minZoom,this.maxZoom),this._lastZoom!==this.object.zoom&&this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")),this.staticMoving?this._zoomStart.copy(this._zoomEnd):this._zoomStart.y+=(this._zoomEnd.y-this._zoomStart.y)*this.dynamicDampingFactor)}_getMouseOnScreen(e,t){return Xj.set((e-this.screen.left)/this.screen.width,(t-this.screen.top)/this.screen.height),Xj}_getMouseOnCircle(e,t){return Xj.set((e-.5*this.screen.width-this.screen.left)/(.5*this.screen.width),(this.screen.height+2*(this.screen.top-t))/this.screen.width),Xj}_addPointer(e){this._pointers.push(e)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t].pointerId==e.pointerId)return void this._pointers.splice(t,1)}_trackPointer(e){let t=this._pointerPositions[e.pointerId];void 0===t&&(t=new Nc,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0].pointerId?this._pointers[1]:this._pointers[0];return this._pointerPositions[t.pointerId]}_checkDistances(){this.noZoom&&this.noPan||(this._eye.lengthSq()>this.maxDistance*this.maxDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.maxDistance)),this._zoomStart.copy(this._zoomEnd)),this._eye.lengthSq()<this.minDistance*this.minDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.minDistance)),this._zoomStart.copy(this._zoomEnd)))}}function rH(e){!1!==this.enabled&&(0===this._pointers.length&&(this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),this._addPointer(e),"touch"===e.pointerType?this._onTouchStart(e):this._onMouseDown(e))}function sH(e){!1!==this.enabled&&("touch"===e.pointerType?this._onTouchMove(e):this._onMouseMove(e))}function oH(e){!1!==this.enabled&&("touch"===e.pointerType?this._onTouchEnd(e):this._onMouseUp(),this._removePointer(e),0===this._pointers.length&&(this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp)))}function aH(e){this._removePointer(e)}function lH(){!1!==this.enabled&&(this.keyState=Vj,window.addEventListener("keydown",this._onKeyDown))}function cH(e){!1!==this.enabled&&(window.removeEventListener("keydown",this._onKeyDown),this.keyState===Vj&&(e.code!==this.keys[Gj]||this.noRotate?e.code!==this.keys[jj]||this.noZoom?e.code!==this.keys[Hj]||this.noPan||(this.keyState=Hj):this.keyState=jj:this.keyState=Gj))}function uH(e){let t;switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case ra:this.state=jj;break;case ia:this.state=Gj;break;case sa:this.state=Hj;break;default:this.state=Vj}const n=this.keyState!==Vj?this.keyState:this.state;n!==Gj||this.noRotate?n!==jj||this.noZoom?n!==Hj||this.noPan||(this._panStart.copy(this._getMouseOnScreen(e.pageX,e.pageY)),this._panEnd.copy(this._panStart)):(this._zoomStart.copy(this._getMouseOnScreen(e.pageX,e.pageY)),this._zoomEnd.copy(this._zoomStart)):(this._moveCurr.copy(this._getMouseOnCircle(e.pageX,e.pageY)),this._movePrev.copy(this._moveCurr)),this.dispatchEvent(Fj)}function hH(e){const t=this.keyState!==Vj?this.keyState:this.state;t!==Gj||this.noRotate?t!==jj||this.noZoom?t!==Hj||this.noPan||this._panEnd.copy(this._getMouseOnScreen(e.pageX,e.pageY)):this._zoomEnd.copy(this._getMouseOnScreen(e.pageX,e.pageY)):(this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this._getMouseOnCircle(e.pageX,e.pageY)))}function dH(){this.state=Vj,this.dispatchEvent(Bj)}function pH(e){if(!1!==this.enabled&&!0!==this.noZoom){switch(e.preventDefault(),e.deltaMode){case 2:this._zoomStart.y-=.025*e.deltaY;break;case 1:this._zoomStart.y-=.01*e.deltaY;break;default:this._zoomStart.y-=25e-5*e.deltaY}this.dispatchEvent(Fj),this.dispatchEvent(Bj)}}function fH(e){!1!==this.enabled&&e.preventDefault()}function mH(e){if(this._trackPointer(e),1===this._pointers.length)this.state=Wj,this._moveCurr.copy(this._getMouseOnCircle(this._pointers[0].pageX,this._pointers[0].pageY)),this._movePrev.copy(this._moveCurr);else{this.state=qj;const e=this._pointers[0].pageX-this._pointers[1].pageX,t=this._pointers[0].pageY-this._pointers[1].pageY;this._touchZoomDistanceEnd=this._touchZoomDistanceStart=Math.sqrt(e*e+t*t);const n=(this._pointers[0].pageX+this._pointers[1].pageX)/2,i=(this._pointers[0].pageY+this._pointers[1].pageY)/2;this._panStart.copy(this._getMouseOnScreen(n,i)),this._panEnd.copy(this._panStart)}this.dispatchEvent(Fj)}function gH(e){if(this._trackPointer(e),1===this._pointers.length)this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this._getMouseOnCircle(e.pageX,e.pageY));else{const t=this._getSecondPointerPosition(e),n=e.pageX-t.x,i=e.pageY-t.y;this._touchZoomDistanceEnd=Math.sqrt(n*n+i*i);const r=(e.pageX+t.x)/2,s=(e.pageY+t.y)/2;this._panEnd.copy(this._getMouseOnScreen(r,s))}}function yH(e){switch(this._pointers.length){case 0:this.state=Vj;break;case 1:this.state=Wj,this._moveCurr.copy(this._getMouseOnCircle(e.pageX,e.pageY)),this._movePrev.copy(this._moveCurr);break;case 2:this.state=qj;for(let t=0;t<this._pointers.length;t++)if(this._pointers[t].pointerId!==e.pointerId){const e=this._pointerPositions[this._pointers[t].pointerId];this._moveCurr.copy(this._getMouseOnCircle(e.x,e.y)),this._movePrev.copy(this._moveCurr);break}}this.dispatchEvent(Bj)}const vH={type:"change"},_H={type:"start"},xH={type:"end"},bH=new Lu,wH=new Fd,TH=Math.cos(70*Rc.DEG2RAD),SH=new Dc,MH=2*Math.PI,EH=-1,AH=0,CH=1,RH=2,NH=3,PH=4,DH=5,LH=6,IH=1e-6;class kH extends mf{constructor(e,t=null){super(e,t),this.state=EH,this.target=new Dc,this.cursor=new Dc,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:ia,MIDDLE:ra,RIGHT:sa},this.touches={ONE:oa,TWO:la},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new Dc,this._lastQuaternion=new Pc,this._lastTargetPosition=new Dc,this._quat=(new Pc).setFromUnitVectors(e.up,new Dc(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new pf,this._sphericalDelta=new pf,this._scale=1,this._panOffset=new Dc,this._rotateStart=new Nc,this._rotateEnd=new Nc,this._rotateDelta=new Nc,this._panStart=new Nc,this._panEnd=new Nc,this._panDelta=new Nc,this._dollyStart=new Nc,this._dollyEnd=new Nc,this._dollyDelta=new Nc,this._dollyDirection=new Dc,this._mouse=new Nc,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=UH.bind(this),this._onPointerDown=OH.bind(this),this._onPointerUp=FH.bind(this),this._onContextMenu=WH.bind(this),this._onMouseWheel=VH.bind(this),this._onKeyDown=GH.bind(this),this._onTouchStart=jH.bind(this),this._onTouchMove=HH.bind(this),this._onMouseDown=BH.bind(this),this._onMouseMove=zH.bind(this),this._interceptControlDown=qH.bind(this),this._interceptControlUp=XH.bind(this),null!==this.domElement&&this.connect(this.domElement),this.update()}connect(e){super.connect(e),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1});this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents();this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){null!==this._domElementKeyEvents&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(vH),this.update(),this.state=EH}update(e=null){const t=this.object.position;SH.copy(t).sub(this.target),SH.applyQuaternion(this._quat),this._spherical.setFromVector3(SH),this.autoRotate&&this.state===EH&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let n=this.minAzimuthAngle,i=this.maxAzimuthAngle;isFinite(n)&&isFinite(i)&&(n<-Math.PI?n+=MH:n>Math.PI&&(n-=MH),i<-Math.PI?i+=MH:i>Math.PI&&(i-=MH),this._spherical.theta=n<=i?Math.max(n,Math.min(i,this._spherical.theta)):this._spherical.theta>(n+i)/2?Math.max(n,this._spherical.theta):Math.min(i,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),!0===this.enableDamping?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let r=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const e=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),r=e!=this._spherical.radius}if(SH.setFromSpherical(this._spherical),SH.applyQuaternion(this._quatInverse),t.copy(this.target).add(SH),this.object.lookAt(this.target),!0===this.enableDamping?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let e=null;if(this.object.isPerspectiveCamera){const t=SH.length();e=this._clampDistance(t*this._scale);const n=t-e;this.object.position.addScaledVector(this._dollyDirection,n),this.object.updateMatrixWorld(),r=!!n}else if(this.object.isOrthographicCamera){const t=new Dc(this._mouse.x,this._mouse.y,0);t.unproject(this.object);const n=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),r=n!==this.object.zoom;const i=new Dc(this._mouse.x,this._mouse.y,0);i.unproject(this.object),this.object.position.sub(i).add(t),this.object.updateMatrixWorld(),e=SH.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;null!==e&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(e).add(this.object.position):(bH.origin.copy(this.object.position),bH.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(bH.direction))<TH?this.object.lookAt(this.target):(wH.setFromNormalAndCoplanarPoint(this.object.up,this.target),bH.intersectPlane(wH,this.target))))}else if(this.object.isOrthographicCamera){const e=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),e!==this.object.zoom&&(this.object.updateProjectionMatrix(),r=!0)}return this._scale=1,this._performCursorZoom=!1,!!(r||this._lastPosition.distanceToSquared(this.object.position)>IH||8*(1-this._lastQuaternion.dot(this.object.quaternion))>IH||this._lastTargetPosition.distanceToSquared(this.target)>IH)&&(this.dispatchEvent(vH),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0)}_getAutoRotationAngle(e){return null!==e?MH/60*this.autoRotateSpeed*e:MH/60/60*this.autoRotateSpeed}_getZoomScale(e){const t=Math.abs(.01*e);return Math.pow(.95,this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){SH.setFromMatrixColumn(t,0),SH.multiplyScalar(-e),this._panOffset.add(SH)}_panUp(e,t){!0===this.screenSpacePanning?SH.setFromMatrixColumn(t,1):(SH.setFromMatrixColumn(t,0),SH.crossVectors(this.object.up,SH)),SH.multiplyScalar(e),this._panOffset.add(SH)}_pan(e,t){const n=this.domElement;if(this.object.isPerspectiveCamera){const i=this.object.position;SH.copy(i).sub(this.target);let r=SH.length();r*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*r/n.clientHeight,this.object.matrix),this._panUp(2*t*r/n.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/n.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/n.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const n=this.domElement.getBoundingClientRect(),i=e-n.left,r=t-n.top,s=n.width,o=n.height;this._mouse.x=i/s*2-1,this._mouse.y=-r/o*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(MH*this._rotateDelta.x/t.clientHeight),this._rotateUp(MH*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(MH*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(-MH*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(MH*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(-MH*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(1===this._pointers.length)this._rotateStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._rotateStart.set(n,i)}}_handleTouchStartPan(e){if(1===this._pointers.length)this._panStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panStart.set(n,i)}}_handleTouchStartDolly(e){const t=this._getSecondPointerPosition(e),n=e.pageX-t.x,i=e.pageY-t.y,r=Math.sqrt(n*n+i*i);this._dollyStart.set(0,r)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(1==this._pointers.length)this._rotateEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._rotateEnd.set(n,i)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(MH*this._rotateDelta.x/t.clientHeight),this._rotateUp(MH*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(1===this._pointers.length)this._panEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panEnd.set(n,i)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const t=this._getSecondPointerPosition(e),n=e.pageX-t.x,i=e.pageY-t.y,r=Math.sqrt(n*n+i*i);this._dollyEnd.set(0,r),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const s=.5*(e.pageX+t.x),o=.5*(e.pageY+t.y);this._updateZoomParameters(s,o)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return void this._pointers.splice(t,1)}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];void 0===t&&(t=new Nc,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){const t=e.deltaMode,n={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:n.deltaY*=16;break;case 2:n.deltaY*=100}return e.ctrlKey&&!this._controlActive&&(n.deltaY*=10),n}}function OH(e){!1!==this.enabled&&(0===this._pointers.length&&(this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),this._isTrackingPointer(e)||(this._addPointer(e),"touch"===e.pointerType?this._onTouchStart(e):this._onMouseDown(e)))}function UH(e){!1!==this.enabled&&("touch"===e.pointerType?this._onTouchMove(e):this._onMouseMove(e))}function FH(e){switch(this._removePointer(e),this._pointers.length){case 0:this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(xH),this.state=EH;break;case 1:const t=this._pointers[0],n=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:n.x,pageY:n.y})}}function BH(e){let t;switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case ra:if(!1===this.enableZoom)return;this._handleMouseDownDolly(e),this.state=CH;break;case ia:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===this.enablePan)return;this._handleMouseDownPan(e),this.state=RH}else{if(!1===this.enableRotate)return;this._handleMouseDownRotate(e),this.state=AH}break;case sa:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===this.enableRotate)return;this._handleMouseDownRotate(e),this.state=AH}else{if(!1===this.enablePan)return;this._handleMouseDownPan(e),this.state=RH}break;default:this.state=EH}this.state!==EH&&this.dispatchEvent(_H)}function zH(e){switch(this.state){case AH:if(!1===this.enableRotate)return;this._handleMouseMoveRotate(e);break;case CH:if(!1===this.enableZoom)return;this._handleMouseMoveDolly(e);break;case RH:if(!1===this.enablePan)return;this._handleMouseMovePan(e)}}function VH(e){!1!==this.enabled&&!1!==this.enableZoom&&this.state===EH&&(e.preventDefault(),this.dispatchEvent(_H),this._handleMouseWheel(this._customWheelEvent(e)),this.dispatchEvent(xH))}function GH(e){!1!==this.enabled&&this._handleKeyDown(e)}function jH(e){switch(this._trackPointer(e),this._pointers.length){case 1:switch(this.touches.ONE){case oa:if(!1===this.enableRotate)return;this._handleTouchStartRotate(e),this.state=NH;break;case aa:if(!1===this.enablePan)return;this._handleTouchStartPan(e),this.state=PH;break;default:this.state=EH}break;case 2:switch(this.touches.TWO){case la:if(!1===this.enableZoom&&!1===this.enablePan)return;this._handleTouchStartDollyPan(e),this.state=DH;break;case ca:if(!1===this.enableZoom&&!1===this.enableRotate)return;this._handleTouchStartDollyRotate(e),this.state=LH;break;default:this.state=EH}break;default:this.state=EH}this.state!==EH&&this.dispatchEvent(_H)}function HH(e){switch(this._trackPointer(e),this.state){case NH:if(!1===this.enableRotate)return;this._handleTouchMoveRotate(e),this.update();break;case PH:if(!1===this.enablePan)return;this._handleTouchMovePan(e),this.update();break;case DH:if(!1===this.enableZoom&&!1===this.enablePan)return;this._handleTouchMoveDollyPan(e),this.update();break;case LH:if(!1===this.enableZoom&&!1===this.enableRotate)return;this._handleTouchMoveDollyRotate(e),this.update();break;default:this.state=EH}}function WH(e){!1!==this.enabled&&e.preventDefault()}function qH(e){if("Control"===e.key){this._controlActive=!0;this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0})}}function XH(e){if("Control"===e.key){this._controlActive=!1;this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0})}}const $H={type:"change"},YH=1e-6,KH=new Pc;class ZH extends mf{constructor(e,t=null){super(e,t),this.movementSpeed=1,this.rollSpeed=.005,this.dragToLook=!1,this.autoForward=!1,this._moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this._moveVector=new Dc(0,0,0),this._rotationVector=new Dc(0,0,0),this._lastQuaternion=new Pc,this._lastPosition=new Dc,this._status=0,this._onKeyDown=JH.bind(this),this._onKeyUp=QH.bind(this),this._onPointerMove=tW.bind(this),this._onPointerDown=eW.bind(this),this._onPointerUp=nW.bind(this),this._onPointerCancel=iW.bind(this),this._onContextMenu=rW.bind(this),null!==t&&this.connect(t)}connect(e){super.connect(e),window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.addEventListener("pointercancel",this._onPointerCancel),this.domElement.addEventListener("contextmenu",this._onContextMenu)}disconnect(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerCancel),this.domElement.removeEventListener("contextmenu",this._onContextMenu)}dispose(){this.disconnect()}update(e){if(!1===this.enabled)return;const t=this.object,n=e*this.movementSpeed,i=e*this.rollSpeed;t.translateX(this._moveVector.x*n),t.translateY(this._moveVector.y*n),t.translateZ(this._moveVector.z*n),KH.set(this._rotationVector.x*i,this._rotationVector.y*i,this._rotationVector.z*i,1).normalize(),t.quaternion.multiply(KH),(this._lastPosition.distanceToSquared(t.position)>YH||8*(1-this._lastQuaternion.dot(t.quaternion))>YH)&&(this.dispatchEvent($H),this._lastQuaternion.copy(t.quaternion),this._lastPosition.copy(t.position))}_updateMovementVector(){const e=this._moveState.forward||this.autoForward&&!this._moveState.back?1:0;this._moveVector.x=-this._moveState.left+this._moveState.right,this._moveVector.y=-this._moveState.down+this._moveState.up,this._moveVector.z=-e+this._moveState.back}_updateRotationVector(){this._rotationVector.x=-this._moveState.pitchDown+this._moveState.pitchUp,this._rotationVector.y=-this._moveState.yawRight+this._moveState.yawLeft,this._rotationVector.z=-this._moveState.rollRight+this._moveState.rollLeft}_getContainerDimensions(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}}}function JH(e){if(!e.altKey&&!1!==this.enabled){switch(e.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this._moveState.forward=1;break;case"KeyS":this._moveState.back=1;break;case"KeyA":this._moveState.left=1;break;case"KeyD":this._moveState.right=1;break;case"KeyR":this._moveState.up=1;break;case"KeyF":this._moveState.down=1;break;case"ArrowUp":this._moveState.pitchUp=1;break;case"ArrowDown":this._moveState.pitchDown=1;break;case"ArrowLeft":this._moveState.yawLeft=1;break;case"ArrowRight":this._moveState.yawRight=1;break;case"KeyQ":this._moveState.rollLeft=1;break;case"KeyE":this._moveState.rollRight=1}this._updateMovementVector(),this._updateRotationVector()}}function QH(e){if(!1!==this.enabled){switch(e.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this._moveState.forward=0;break;case"KeyS":this._moveState.back=0;break;case"KeyA":this._moveState.left=0;break;case"KeyD":this._moveState.right=0;break;case"KeyR":this._moveState.up=0;break;case"KeyF":this._moveState.down=0;break;case"ArrowUp":this._moveState.pitchUp=0;break;case"ArrowDown":this._moveState.pitchDown=0;break;case"ArrowLeft":this._moveState.yawLeft=0;break;case"ArrowRight":this._moveState.yawRight=0;break;case"KeyQ":this._moveState.rollLeft=0;break;case"KeyE":this._moveState.rollRight=0}this._updateMovementVector(),this._updateRotationVector()}}function eW(e){if(!1!==this.enabled)if(this.dragToLook)this._status++;else{switch(e.button){case 0:this._moveState.forward=1;break;case 2:this._moveState.back=1}this._updateMovementVector()}}function tW(e){if(!1!==this.enabled&&(!this.dragToLook||this._status>0)){const t=this._getContainerDimensions(),n=t.size[0]/2,i=t.size[1]/2;this._moveState.yawLeft=-(e.pageX-t.offset[0]-n)/n,this._moveState.pitchDown=(e.pageY-t.offset[1]-i)/i,this._updateRotationVector()}}function nW(e){if(!1!==this.enabled){if(this.dragToLook)this._status--,this._moveState.yawLeft=this._moveState.pitchDown=0;else{switch(e.button){case 0:this._moveState.forward=0;break;case 2:this._moveState.back=0}this._updateMovementVector()}this._updateRotationVector()}}function iW(){!1!==this.enabled&&(this.dragToLook?(this._status=0,this._moveState.yawLeft=this._moveState.pitchDown=0):(this._moveState.forward=0,this._moveState.back=0,this._updateMovementVector()),this._updateRotationVector())}function rW(e){!1!==this.enabled&&e.preventDefault()}const sW={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\n\t\t}"};class oW{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const aW=new Zp(-1,1,1,-1,0,1);const lW=new class extends Kh{constructor(){super(),this.setAttribute("position",new Gh([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Gh([0,2,0,0,2,0],2))}};class cW{constructor(e){this._mesh=new ld(lW,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,aW)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class uW extends oW{constructor(e,t="tDiffuse"){super(),this.textureID=t,this.uniforms=null,this.material=null,e instanceof md?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=fd.clone(e.uniforms),this.material=new md({name:void 0!==e.name?e.name:"unspecified",defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this._fsQuad=new cW(this.material)}render(e,t,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture),this._fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this._fsQuad.render(e))}dispose(){this.material.dispose(),this._fsQuad.dispose()}}class hW extends oW{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,n){const i=e.getContext(),r=e.state;let s,o;r.buffers.color.setMask(!1),r.buffers.depth.setMask(!1),r.buffers.color.setLocked(!0),r.buffers.depth.setLocked(!0),this.inverse?(s=0,o=1):(s=1,o=0),r.buffers.stencil.setTest(!0),r.buffers.stencil.setOp(i.REPLACE,i.REPLACE,i.REPLACE),r.buffers.stencil.setFunc(i.ALWAYS,s,4294967295),r.buffers.stencil.setClear(o),r.buffers.stencil.setLocked(!0),e.setRenderTarget(n),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),r.buffers.color.setLocked(!1),r.buffers.depth.setLocked(!1),r.buffers.color.setMask(!0),r.buffers.depth.setMask(!0),r.buffers.stencil.setLocked(!1),r.buffers.stencil.setFunc(i.EQUAL,1,4294967295),r.buffers.stencil.setOp(i.KEEP,i.KEEP,i.KEEP),r.buffers.stencil.setLocked(!0)}}class dW extends oW{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class pW{constructor(e,t){if(this.renderer=e,this._pixelRatio=e.getPixelRatio(),void 0===t){const n=e.getSize(new Nc);this._width=n.width,this._height=n.height,(t=new ru(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:ol})).texture.name="EffectComposer.rt1"}else this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new uW(sW),this.copyPass.material.blending=0,this.clock=new of}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);-1!==t&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){void 0===e&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let n=!1;for(let t=0,i=this.passes.length;t<i;t++){const i=this.passes[t];if(!1!==i.enabled){if(i.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(t),i.render(this.renderer,this.writeBuffer,this.readBuffer,e,n),i.needsSwap){if(n){const t=this.renderer.getContext(),n=this.renderer.state.buffers.stencil;n.setFunc(t.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),n.setFunc(t.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==hW&&(i instanceof hW?n=!0:i instanceof dW&&(n=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(void 0===e){const t=this.renderer.getSize(new Nc);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,(e=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const n=this._width*this._pixelRatio,i=this._height*this._pixelRatio;this.renderTarget1.setSize(n,i),this.renderTarget2.setSize(n,i);for(let e=0;e<this.passes.length;e++)this.passes[e].setSize(n,i)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class fW extends oW{constructor(e,t,n=null,i=null,r=null){super(),this.scene=e,this.camera=t,this.overrideMaterial=n,this.clearColor=i,this.clearAlpha=r,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new Eh}render(e,t,n){const i=e.autoClear;let r,s;e.autoClear=!1,null!==this.overrideMaterial&&(s=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),null!==this.clearColor&&(e.getClearColor(this._oldClearColor),e.setClearColor(this.clearColor,e.getClearAlpha())),null!==this.clearAlpha&&(r=e.getClearAlpha(),e.setClearAlpha(this.clearAlpha)),1==this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:n),!0===this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),null!==this.clearColor&&e.setClearColor(this._oldClearColor),null!==this.clearAlpha&&e.setClearAlpha(r),null!==this.overrideMaterial&&(this.scene.overrideMaterial=s),e.autoClear=i}}var mW=Object.freeze({Linear:Object.freeze({None:function(e){return e},In:function(e){return e},Out:function(e){return e},InOut:function(e){return e}}),Quadratic:Object.freeze({In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}}),Cubic:Object.freeze({In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}}),Quartic:Object.freeze({In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}}),Quintic:Object.freeze({In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}}),Sinusoidal:Object.freeze({In:function(e){return 1-Math.sin((1-e)*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.sin(Math.PI*(.5-e)))}}),Exponential:Object.freeze({In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}}),Circular:Object.freeze({In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}}),Elastic:Object.freeze({In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}}),Back:Object.freeze({In:function(e){var t=1.70158;return 1===e?1:e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return 0===e?0:--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}}),Bounce:Object.freeze({In:function(e){return 1-mW.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*mW.Bounce.In(2*e):.5*mW.Bounce.Out(2*e-1)+.5}}),generatePow:function(e){return void 0===e&&(e=4),e=(e=e<Number.EPSILON?Number.EPSILON:e)>1e4?1e4:e,{In:function(t){return Math.pow(t,e)},Out:function(t){return 1-Math.pow(1-t,e)},InOut:function(t){return t<.5?Math.pow(2*t,e)/2:(1-Math.pow(2-2*t,e))/2+.5}}}}),gW=function(){return performance.now()},yW=function(){function e(){this._tweens={},this._tweensAddedDuringUpdate={}}return e.prototype.getAll=function(){var e=this;return Object.keys(this._tweens).map((function(t){return e._tweens[t]}))},e.prototype.removeAll=function(){this._tweens={}},e.prototype.add=function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},e.prototype.remove=function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},e.prototype.update=function(e,t){void 0===e&&(e=gW()),void 0===t&&(t=!1);var n=Object.keys(this._tweens);if(0===n.length)return!1;for(;n.length>0;){this._tweensAddedDuringUpdate={};for(var i=0;i<n.length;i++){var r=this._tweens[n[i]],s=!t;r&&!1===r.update(e,s)&&!t&&delete this._tweens[n[i]]}n=Object.keys(this._tweensAddedDuringUpdate)}return!0},e}(),vW={Linear:function(e,t){var n=e.length-1,i=n*t,r=Math.floor(i),s=vW.Utils.Linear;return t<0?s(e[0],e[1],i):t>1?s(e[n],e[n-1],n-i):s(e[r],e[r+1>n?n:r+1],i-r)},Utils:{Linear:function(e,t,n){return(t-e)*n+e}}},_W=function(){function e(){}return e.nextId=function(){return e._nextId++},e._nextId=0,e}(),xW=new yW,bW=function(){function e(e,t){void 0===t&&(t=xW),this._object=e,this._group=t,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=mW.Linear.None,this._interpolationFunction=vW.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=_W.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1}return e.prototype.getId=function(){return this._id},e.prototype.isPlaying=function(){return this._isPlaying},e.prototype.isPaused=function(){return this._isPaused},e.prototype.getDuration=function(){return this._duration},e.prototype.to=function(e,t){if(void 0===t&&(t=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=e,this._propertiesAreSetUp=!1,this._duration=t<0?0:t,this},e.prototype.duration=function(e){return void 0===e&&(e=1e3),this._duration=e<0?0:e,this},e.prototype.dynamic=function(e){return void 0===e&&(e=!1),this._isDynamic=e,this},e.prototype.start=function(e,t){if(void 0===e&&(e=gW()),void 0===t&&(t=!1),this._isPlaying)return this;if(this._group&&this._group.add(this),this._repeat=this._initialRepeat,this._reversed)for(var n in this._reversed=!1,this._valuesStartRepeat)this._swapEndStartRepeatValues(n),this._valuesStart[n]=this._valuesStartRepeat[n];if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=e,this._startTime+=this._delayTime,!this._propertiesAreSetUp||t){if(this._propertiesAreSetUp=!0,!this._isDynamic){var i={};for(var r in this._valuesEnd)i[r]=this._valuesEnd[r];this._valuesEnd=i}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,t)}return this},e.prototype.startFromCurrentValues=function(e){return this.start(e,!0)},e.prototype._setupProperties=function(e,t,n,i,r){for(var s in n){var o=e[s],a=Array.isArray(o),l=a?"array":typeof o,c=!a&&Array.isArray(n[s]);if("undefined"!==l&&"function"!==l){if(c){if(0===(g=n[s]).length)continue;for(var u=[o],h=0,d=g.length;h<d;h+=1){var p=this._handleRelativeValue(o,g[h]);if(isNaN(p)){c=!1,console.warn("Found invalid interpolation list. Skipping.");break}u.push(p)}c&&(n[s]=u)}if("object"!==l&&!a||!o||c)(void 0===t[s]||r)&&(t[s]=o),a||(t[s]*=1),i[s]=c?n[s].slice().reverse():t[s]||0;else{t[s]=a?[]:{};var f=o;for(var m in f)t[s][m]=f[m];i[s]=a?[]:{};var g=n[s];if(!this._isDynamic){var y={};for(var m in g)y[m]=g[m];n[s]=g=y}this._setupProperties(f,t[s],g,i[s],r)}}}},e.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._group&&this._group.remove(this),this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},e.prototype.end=function(){return this._goToEnd=!0,this.update(1/0),this},e.prototype.pause=function(e){return void 0===e&&(e=gW()),this._isPaused||!this._isPlaying||(this._isPaused=!0,this._pauseStart=e,this._group&&this._group.remove(this)),this},e.prototype.resume=function(e){return void 0===e&&(e=gW()),this._isPaused&&this._isPlaying?(this._isPaused=!1,this._startTime+=e-this._pauseStart,this._pauseStart=0,this._group&&this._group.add(this),this):this},e.prototype.stopChainedTweens=function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop();return this},e.prototype.group=function(e){return void 0===e&&(e=xW),this._group=e,this},e.prototype.delay=function(e){return void 0===e&&(e=0),this._delayTime=e,this},e.prototype.repeat=function(e){return void 0===e&&(e=0),this._initialRepeat=e,this._repeat=e,this},e.prototype.repeatDelay=function(e){return this._repeatDelayTime=e,this},e.prototype.yoyo=function(e){return void 0===e&&(e=!1),this._yoyo=e,this},e.prototype.easing=function(e){return void 0===e&&(e=mW.Linear.None),this._easingFunction=e,this},e.prototype.interpolation=function(e){return void 0===e&&(e=vW.Linear),this._interpolationFunction=e,this},e.prototype.chain=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._chainedTweens=e,this},e.prototype.onStart=function(e){return this._onStartCallback=e,this},e.prototype.onEveryStart=function(e){return this._onEveryStartCallback=e,this},e.prototype.onUpdate=function(e){return this._onUpdateCallback=e,this},e.prototype.onRepeat=function(e){return this._onRepeatCallback=e,this},e.prototype.onComplete=function(e){return this._onCompleteCallback=e,this},e.prototype.onStop=function(e){return this._onStopCallback=e,this},e.prototype.update=function(e,t){var n,i,r=this;if(void 0===e&&(e=gW()),void 0===t&&(t=!0),this._isPaused)return!0;var s=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying){if(e>s)return!1;t&&this.start(e,!0)}if(this._goToEnd=!1,e<this._startTime)return!0;!1===this._onStartCallbackFired&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),!1===this._onEveryStartCallbackFired&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0);var o=e-this._startTime,a=this._duration+(null!==(n=this._repeatDelayTime)&&void 0!==n?n:this._delayTime),l=this._duration+this._repeat*a,c=function(){if(0===r._duration)return 1;if(o>l)return 1;var e=Math.trunc(o/a),t=o-e*a,n=Math.min(t/r._duration,1);return 0===n&&o===r._duration?1:n}(),u=this._easingFunction(c);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,u),this._onUpdateCallback&&this._onUpdateCallback(this._object,c),0===this._duration||o>=this._duration){if(this._repeat>0){var h=Math.min(Math.trunc((o-this._duration)/a)+1,this._repeat);for(i in isFinite(this._repeat)&&(this._repeat-=h),this._valuesStartRepeat)this._yoyo||"string"!=typeof this._valuesEnd[i]||(this._valuesStartRepeat[i]=this._valuesStartRepeat[i]+parseFloat(this._valuesEnd[i])),this._yoyo&&this._swapEndStartRepeatValues(i),this._valuesStart[i]=this._valuesStartRepeat[i];return this._yoyo&&(this._reversed=!this._reversed),this._startTime+=a*h,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var d=0,p=this._chainedTweens.length;d<p;d++)this._chainedTweens[d].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},e.prototype._updateProperties=function(e,t,n,i){for(var r in n)if(void 0!==t[r]){var s=t[r]||0,o=n[r],a=Array.isArray(e[r]),l=Array.isArray(o);!a&&l?e[r]=this._interpolationFunction(o,i):"object"==typeof o&&o?this._updateProperties(e[r],s,o,i):"number"==typeof(o=this._handleRelativeValue(s,o))&&(e[r]=s+(o-s)*i)}},e.prototype._handleRelativeValue=function(e,t){return"string"!=typeof t?t:"+"===t.charAt(0)||"-"===t.charAt(0)?e+parseFloat(t):parseFloat(t)},e.prototype._swapEndStartRepeatValues=function(e){var t=this._valuesStartRepeat[e],n=this._valuesEnd[e];this._valuesStartRepeat[e]="string"==typeof n?this._valuesStartRepeat[e]+parseFloat(n):this._valuesEnd[e],this._valuesEnd[e]=t},e}();_W.nextId;var wW=xW;wW.getAll.bind(wW),wW.removeAll.bind(wW),wW.add.bind(wW),wW.remove.bind(wW),wW.update.bind(wW);var TW="http://www.w3.org/1999/xhtml",SW={svg:"http://www.w3.org/2000/svg",xhtml:TW,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function MW(e){var t=e+="",n=t.indexOf(":");return n>=0&&"xmlns"!==(t=e.slice(0,n))&&(e=e.slice(n+1)),SW.hasOwnProperty(t)?{space:SW[t],local:e}:e}function EW(e){return function(){var t=this.ownerDocument,n=this.namespaceURI;return n===TW&&t.documentElement.namespaceURI===TW?t.createElement(e):t.createElementNS(n,e)}}function AW(e){return function(){return this.ownerDocument.createElementNS(e.space,e.local)}}function CW(e){var t=MW(e);return(t.local?AW:EW)(t)}function RW(){}function NW(e){return null==e?RW:function(){return this.querySelector(e)}}function PW(){return[]}function DW(e){return null==e?PW:function(){return this.querySelectorAll(e)}}function LW(e){return function(){return function(e){return null==e?[]:Array.isArray(e)?e:Array.from(e)}(e.apply(this,arguments))}}function IW(e){return function(){return this.matches(e)}}function kW(e){return function(t){return t.matches(e)}}var OW=Array.prototype.find;function UW(){return this.firstElementChild}var FW=Array.prototype.filter;function BW(){return Array.from(this.children)}function zW(e){return new Array(e.length)}function VW(e,t){this.ownerDocument=e.ownerDocument,this.namespaceURI=e.namespaceURI,this._next=null,this._parent=e,this.__data__=t}function GW(e,t,n,i,r,s){for(var o,a=0,l=t.length,c=s.length;a<c;++a)(o=t[a])?(o.__data__=s[a],i[a]=o):n[a]=new VW(e,s[a]);for(;a<l;++a)(o=t[a])&&(r[a]=o)}function jW(e,t,n,i,r,s,o){var a,l,c,u=new Map,h=t.length,d=s.length,p=new Array(h);for(a=0;a<h;++a)(l=t[a])&&(p[a]=c=o.call(l,l.__data__,a,t)+"",u.has(c)?r[a]=l:u.set(c,l));for(a=0;a<d;++a)c=o.call(e,s[a],a,s)+"",(l=u.get(c))?(i[a]=l,l.__data__=s[a],u.delete(c)):n[a]=new VW(e,s[a]);for(a=0;a<h;++a)(l=t[a])&&u.get(p[a])===l&&(r[a]=l)}function HW(e){return e.__data__}function WW(e){return"object"==typeof e&&"length"in e?e:Array.from(e)}function qW(e,t){return e<t?-1:e>t?1:e>=t?0:NaN}function XW(e){return function(){this.removeAttribute(e)}}function $W(e){return function(){this.removeAttributeNS(e.space,e.local)}}function YW(e,t){return function(){this.setAttribute(e,t)}}function KW(e,t){return function(){this.setAttributeNS(e.space,e.local,t)}}function ZW(e,t){return function(){var n=t.apply(this,arguments);null==n?this.removeAttribute(e):this.setAttribute(e,n)}}function JW(e,t){return function(){var n=t.apply(this,arguments);null==n?this.removeAttributeNS(e.space,e.local):this.setAttributeNS(e.space,e.local,n)}}function QW(e){return e.ownerDocument&&e.ownerDocument.defaultView||e.document&&e||e.defaultView}function eq(e){return function(){this.style.removeProperty(e)}}function tq(e,t,n){return function(){this.style.setProperty(e,t,n)}}function nq(e,t,n){return function(){var i=t.apply(this,arguments);null==i?this.style.removeProperty(e):this.style.setProperty(e,i,n)}}function iq(e,t){return e.style.getPropertyValue(t)||QW(e).getComputedStyle(e,null).getPropertyValue(t)}function rq(e){return function(){delete this[e]}}function sq(e,t){return function(){this[e]=t}}function oq(e,t){return function(){var n=t.apply(this,arguments);null==n?delete this[e]:this[e]=n}}function aq(e){return e.trim().split(/^|\s+/)}function lq(e){return e.classList||new cq(e)}function cq(e){this._node=e,this._names=aq(e.getAttribute("class")||"")}function uq(e,t){for(var n=lq(e),i=-1,r=t.length;++i<r;)n.add(t[i])}function hq(e,t){for(var n=lq(e),i=-1,r=t.length;++i<r;)n.remove(t[i])}function dq(e){return function(){uq(this,e)}}function pq(e){return function(){hq(this,e)}}function fq(e,t){return function(){(t.apply(this,arguments)?uq:hq)(this,e)}}function mq(){this.textContent=""}function gq(e){return function(){this.textContent=e}}function yq(e){return function(){var t=e.apply(this,arguments);this.textContent=null==t?"":t}}function vq(){this.innerHTML=""}function _q(e){return function(){this.innerHTML=e}}function xq(e){return function(){var t=e.apply(this,arguments);this.innerHTML=null==t?"":t}}function bq(){this.nextSibling&&this.parentNode.appendChild(this)}function wq(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function Tq(){return null}function Sq(){var e=this.parentNode;e&&e.removeChild(this)}function Mq(){var e=this.cloneNode(!1),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function Eq(){var e=this.cloneNode(!0),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function Aq(e){return function(){var t=this.__on;if(t){for(var n,i=0,r=-1,s=t.length;i<s;++i)n=t[i],e.type&&n.type!==e.type||n.name!==e.name?t[++r]=n:this.removeEventListener(n.type,n.listener,n.options);++r?t.length=r:delete this.__on}}}function Cq(e,t,n){return function(){var i,r=this.__on,s=function(e){return function(t){e.call(this,t,this.__data__)}}(t);if(r)for(var o=0,a=r.length;o<a;++o)if((i=r[o]).type===e.type&&i.name===e.name)return this.removeEventListener(i.type,i.listener,i.options),this.addEventListener(i.type,i.listener=s,i.options=n),void(i.value=t);this.addEventListener(e.type,s,n),i={type:e.type,name:e.name,value:t,listener:s,options:n},r?r.push(i):this.__on=[i]}}function Rq(e,t,n){var i=QW(e),r=i.CustomEvent;"function"==typeof r?r=new r(t,n):(r=i.document.createEvent("Event"),n?(r.initEvent(t,n.bubbles,n.cancelable),r.detail=n.detail):r.initEvent(t,!1,!1)),e.dispatchEvent(r)}function Nq(e,t){return function(){return Rq(this,e,t)}}function Pq(e,t){return function(){return Rq(this,e,t.apply(this,arguments))}}VW.prototype={constructor:VW,appendChild:function(e){return this._parent.insertBefore(e,this._next)},insertBefore:function(e,t){return this._parent.insertBefore(e,t)},querySelector:function(e){return this._parent.querySelector(e)},querySelectorAll:function(e){return this._parent.querySelectorAll(e)}},cq.prototype={add:function(e){this._names.indexOf(e)<0&&(this._names.push(e),this._node.setAttribute("class",this._names.join(" ")))},remove:function(e){var t=this._names.indexOf(e);t>=0&&(this._names.splice(t,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(e){return this._names.indexOf(e)>=0}};var Dq=[null];function Lq(e,t){this._groups=e,this._parents=t}function Iq(){return new Lq([[document.documentElement]],Dq)}function kq(e){return"string"==typeof e?new Lq([[document.querySelector(e)]],[document.documentElement]):new Lq([[e]],Dq)}function Oq(e,t){if(e=function(e){let t;for(;t=e.sourceEvent;)e=t;return e}(e),void 0===t&&(t=e.currentTarget),t){var n=t.ownerSVGElement||t;if(n.createSVGPoint){var i=n.createSVGPoint();return i.x=e.clientX,i.y=e.clientY,[(i=i.matrixTransform(t.getScreenCTM().inverse())).x,i.y]}if(t.getBoundingClientRect){var r=t.getBoundingClientRect();return[e.clientX-r.left-t.clientLeft,e.clientY-r.top-t.clientTop]}}return[e.pageX,e.pageY]}Lq.prototype=Iq.prototype={constructor:Lq,select:function(e){"function"!=typeof e&&(e=NW(e));for(var t=this._groups,n=t.length,i=new Array(n),r=0;r<n;++r)for(var s,o,a=t[r],l=a.length,c=i[r]=new Array(l),u=0;u<l;++u)(s=a[u])&&(o=e.call(s,s.__data__,u,a))&&("__data__"in s&&(o.__data__=s.__data__),c[u]=o);return new Lq(i,this._parents)},selectAll:function(e){e="function"==typeof e?LW(e):DW(e);for(var t=this._groups,n=t.length,i=[],r=[],s=0;s<n;++s)for(var o,a=t[s],l=a.length,c=0;c<l;++c)(o=a[c])&&(i.push(e.call(o,o.__data__,c,a)),r.push(o));return new Lq(i,r)},selectChild:function(e){return this.select(null==e?UW:function(e){return function(){return OW.call(this.children,e)}}("function"==typeof e?e:kW(e)))},selectChildren:function(e){return this.selectAll(null==e?BW:function(e){return function(){return FW.call(this.children,e)}}("function"==typeof e?e:kW(e)))},filter:function(e){"function"!=typeof e&&(e=IW(e));for(var t=this._groups,n=t.length,i=new Array(n),r=0;r<n;++r)for(var s,o=t[r],a=o.length,l=i[r]=[],c=0;c<a;++c)(s=o[c])&&e.call(s,s.__data__,c,o)&&l.push(s);return new Lq(i,this._parents)},data:function(e,t){if(!arguments.length)return Array.from(this,HW);var n=t?jW:GW,i=this._parents,r=this._groups;"function"!=typeof e&&(e=function(e){return function(){return e}}(e));for(var s=r.length,o=new Array(s),a=new Array(s),l=new Array(s),c=0;c<s;++c){var u=i[c],h=r[c],d=h.length,p=WW(e.call(u,u&&u.__data__,c,i)),f=p.length,m=a[c]=new Array(f),g=o[c]=new Array(f);n(u,h,m,g,l[c]=new Array(d),p,t);for(var y,v,_=0,x=0;_<f;++_)if(y=m[_]){for(_>=x&&(x=_+1);!(v=g[x])&&++x<f;);y._next=v||null}}return(o=new Lq(o,i))._enter=a,o._exit=l,o},enter:function(){return new Lq(this._enter||this._groups.map(zW),this._parents)},exit:function(){return new Lq(this._exit||this._groups.map(zW),this._parents)},join:function(e,t,n){var i=this.enter(),r=this,s=this.exit();return"function"==typeof e?(i=e(i))&&(i=i.selection()):i=i.append(e+""),null!=t&&(r=t(r))&&(r=r.selection()),null==n?s.remove():n(s),i&&r?i.merge(r).order():r},merge:function(e){for(var t=e.selection?e.selection():e,n=this._groups,i=t._groups,r=n.length,s=i.length,o=Math.min(r,s),a=new Array(r),l=0;l<o;++l)for(var c,u=n[l],h=i[l],d=u.length,p=a[l]=new Array(d),f=0;f<d;++f)(c=u[f]||h[f])&&(p[f]=c);for(;l<r;++l)a[l]=n[l];return new Lq(a,this._parents)},selection:function(){return this},order:function(){for(var e=this._groups,t=-1,n=e.length;++t<n;)for(var i,r=e[t],s=r.length-1,o=r[s];--s>=0;)(i=r[s])&&(o&&4^i.compareDocumentPosition(o)&&o.parentNode.insertBefore(i,o),o=i);return this},sort:function(e){function t(t,n){return t&&n?e(t.__data__,n.__data__):!t-!n}e||(e=qW);for(var n=this._groups,i=n.length,r=new Array(i),s=0;s<i;++s){for(var o,a=n[s],l=a.length,c=r[s]=new Array(l),u=0;u<l;++u)(o=a[u])&&(c[u]=o);c.sort(t)}return new Lq(r,this._parents).order()},call:function(){var e=arguments[0];return arguments[0]=this,e.apply(null,arguments),this},nodes:function(){return Array.from(this)},node:function(){for(var e=this._groups,t=0,n=e.length;t<n;++t)for(var i=e[t],r=0,s=i.length;r<s;++r){var o=i[r];if(o)return o}return null},size:function(){let e=0;for(const t of this)++e;return e},empty:function(){return!this.node()},each:function(e){for(var t=this._groups,n=0,i=t.length;n<i;++n)for(var r,s=t[n],o=0,a=s.length;o<a;++o)(r=s[o])&&e.call(r,r.__data__,o,s);return this},attr:function(e,t){var n=MW(e);if(arguments.length<2){var i=this.node();return n.local?i.getAttributeNS(n.space,n.local):i.getAttribute(n)}return this.each((null==t?n.local?$W:XW:"function"==typeof t?n.local?JW:ZW:n.local?KW:YW)(n,t))},style:function(e,t,n){return arguments.length>1?this.each((null==t?eq:"function"==typeof t?nq:tq)(e,t,null==n?"":n)):iq(this.node(),e)},property:function(e,t){return arguments.length>1?this.each((null==t?rq:"function"==typeof t?oq:sq)(e,t)):this.node()[e]},classed:function(e,t){var n=aq(e+"");if(arguments.length<2){for(var i=lq(this.node()),r=-1,s=n.length;++r<s;)if(!i.contains(n[r]))return!1;return!0}return this.each(("function"==typeof t?fq:t?dq:pq)(n,t))},text:function(e){return arguments.length?this.each(null==e?mq:("function"==typeof e?yq:gq)(e)):this.node().textContent},html:function(e){return arguments.length?this.each(null==e?vq:("function"==typeof e?xq:_q)(e)):this.node().innerHTML},raise:function(){return this.each(bq)},lower:function(){return this.each(wq)},append:function(e){var t="function"==typeof e?e:CW(e);return this.select((function(){return this.appendChild(t.apply(this,arguments))}))},insert:function(e,t){var n="function"==typeof e?e:CW(e),i=null==t?Tq:"function"==typeof t?t:NW(t);return this.select((function(){return this.insertBefore(n.apply(this,arguments),i.apply(this,arguments)||null)}))},remove:function(){return this.each(Sq)},clone:function(e){return this.select(e?Eq:Mq)},datum:function(e){return arguments.length?this.property("__data__",e):this.node().__data__},on:function(e,t,n){var i,r,s=function(e){return e.trim().split(/^|\s+/).map((function(e){var t="",n=e.indexOf(".");return n>=0&&(t=e.slice(n+1),e=e.slice(0,n)),{type:e,name:t}}))}(e+""),o=s.length;if(!(arguments.length<2)){for(a=t?Cq:Aq,i=0;i<o;++i)this.each(a(s[i],t,n));return this}var a=this.node().__on;if(a)for(var l,c=0,u=a.length;c<u;++c)for(i=0,l=a[c];i<o;++i)if((r=s[i]).type===l.type&&r.name===l.name)return l.value},dispatch:function(e,t){return this.each(("function"==typeof t?Pq:Nq)(e,t))},[Symbol.iterator]:function*(){for(var e=this._groups,t=0,n=e.length;t<n;++t)for(var i,r=e[t],s=0,o=r.length;s<o;++s)(i=r[s])&&(yield i)}};var Uq,Fq,Bq,zq,Vq,Gq,jq,Hq,Wq,qq,Xq,$q,Yq={},Kq=[],Zq=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,Jq=Array.isArray;function Qq(e,t){for(var n in t)e[n]=t[n];return e}function eX(e){e&&e.parentNode&&e.parentNode.removeChild(e)}function tX(e,t,n,i,r){var s={type:e,props:t,key:n,ref:i,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:null==r?++Bq:r,__i:-1,__u:0};return null==r&&null!=Fq.vnode&&Fq.vnode(s),s}function nX(e){return e.children}function iX(e,t){this.props=e,this.context=t}function rX(e,t){if(null==t)return e.__?rX(e.__,e.__i+1):null;for(var n;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e)return n.__e;return"function"==typeof e.type?rX(e):null}function sX(e){var t,n;if(null!=(e=e.__)&&null!=e.__c){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e){e.__e=e.__c.base=n.__e;break}return sX(e)}}function oX(e){(!e.__d&&(e.__d=!0)&&Vq.push(e)&&!aX.__r++||Gq!=Fq.debounceRendering)&&((Gq=Fq.debounceRendering)||jq)(aX)}function aX(){for(var e,t,n,i,r,s,o,a=1;Vq.length;)Vq.length>a&&Vq.sort(Hq),e=Vq.shift(),a=Vq.length,e.__d&&(n=void 0,r=(i=(t=e).__v).__e,s=[],o=[],t.__P&&((n=Qq({},i)).__v=i.__v+1,Fq.vnode&&Fq.vnode(n),mX(t.__P,n,i,t.__n,t.__P.namespaceURI,32&i.__u?[r]:null,s,null==r?rX(i):r,!!(32&i.__u),o),n.__v=i.__v,n.__.__k[n.__i]=n,gX(s,n,o),n.__e!=r&&sX(n)));aX.__r=0}function lX(e,t,n,i,r,s,o,a,l,c,u){var h,d,p,f,m,g,y=i&&i.__k||Kq,v=t.length;for(l=cX(n,t,y,l,v),h=0;h<v;h++)null!=(p=n.__k[h])&&(d=-1==p.__i?Yq:y[p.__i]||Yq,p.__i=h,g=mX(e,p,d,r,s,o,a,l,c,u),f=p.__e,p.ref&&d.ref!=p.ref&&(d.ref&&_X(d.ref,null,p),u.push(p.ref,p.__c||f,p)),null==m&&null!=f&&(m=f),4&p.__u||d.__k===p.__k?l=uX(p,l,e):"function"==typeof p.type&&void 0!==g?l=g:f&&(l=f.nextSibling),p.__u&=-7);return n.__e=m,l}function cX(e,t,n,i,r){var s,o,a,l,c,u=n.length,h=u,d=0;for(e.__k=new Array(r),s=0;s<r;s++)null!=(o=t[s])&&"boolean"!=typeof o&&"function"!=typeof o?(l=s+d,(o=e.__k[s]="string"==typeof o||"number"==typeof o||"bigint"==typeof o||o.constructor==String?tX(null,o,null,null,null):Jq(o)?tX(nX,{children:o},null,null,null):null==o.constructor&&o.__b>0?tX(o.type,o.props,o.key,o.ref?o.ref:null,o.__v):o).__=e,o.__b=e.__b+1,a=null,-1!=(c=o.__i=hX(o,n,l,h))&&(h--,(a=n[c])&&(a.__u|=2)),null==a||null==a.__v?(-1==c&&(r>u?d--:r<u&&d++),"function"!=typeof o.type&&(o.__u|=4)):c!=l&&(c==l-1?d--:c==l+1?d++:(c>l?d--:d++,o.__u|=4))):e.__k[s]=null;if(h)for(s=0;s<u;s++)null!=(a=n[s])&&!(2&a.__u)&&(a.__e==i&&(i=rX(a)),xX(a,a));return i}function uX(e,t,n){var i,r;if("function"==typeof e.type){for(i=e.__k,r=0;i&&r<i.length;r++)i[r]&&(i[r].__=e,t=uX(i[r],t,n));return t}e.__e!=t&&(t&&e.type&&!n.contains(t)&&(t=rX(e)),n.insertBefore(e.__e,t||null),t=e.__e);do{t=t&&t.nextSibling}while(null!=t&&8==t.nodeType);return t}function hX(e,t,n,i){var r,s,o=e.key,a=e.type,l=t[n];if(null===l&&null==e.key||l&&o==l.key&&a==l.type&&!(2&l.__u))return n;if(i>(null==l||2&l.__u?0:1))for(r=n-1,s=n+1;r>=0||s<t.length;){if(r>=0){if((l=t[r])&&!(2&l.__u)&&o==l.key&&a==l.type)return r;r--}if(s<t.length){if((l=t[s])&&!(2&l.__u)&&o==l.key&&a==l.type)return s;s++}}return-1}function dX(e,t,n){"-"==t[0]?e.setProperty(t,null==n?"":n):e[t]=null==n?"":"number"!=typeof n||Zq.test(t)?n:n+"px"}function pX(e,t,n,i,r){var s,o;e:if("style"==t)if("string"==typeof n)e.style.cssText=n;else{if("string"==typeof i&&(e.style.cssText=i=""),i)for(t in i)n&&t in n||dX(e.style,t,"");if(n)for(t in n)i&&n[t]==i[t]||dX(e.style,t,n[t])}else if("o"==t[0]&&"n"==t[1])s=t!=(t=t.replace(Wq,"$1")),o=t.toLowerCase(),t=o in e||"onFocusOut"==t||"onFocusIn"==t?o.slice(2):t.slice(2),e.l||(e.l={}),e.l[t+s]=n,n?i?n.u=i.u:(n.u=qq,e.addEventListener(t,s?$q:Xq,s)):e.removeEventListener(t,s?$q:Xq,s);else{if("http://www.w3.org/2000/svg"==r)t=t.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if("width"!=t&&"height"!=t&&"href"!=t&&"list"!=t&&"form"!=t&&"tabIndex"!=t&&"download"!=t&&"rowSpan"!=t&&"colSpan"!=t&&"role"!=t&&"popover"!=t&&t in e)try{e[t]=null==n?"":n;break e}catch(e){}"function"==typeof n||(null==n||!1===n&&"-"!=t[4]?e.removeAttribute(t):e.setAttribute(t,"popover"==t&&1==n?"":n))}}function fX(e){return function(t){if(this.l){var n=this.l[t.type+e];if(null==t.t)t.t=qq++;else if(t.t<n.u)return;return n(Fq.event?Fq.event(t):t)}}}function mX(e,t,n,i,r,s,o,a,l,c){var u,h,d,p,f,m,g,y,v,_,x,b,w,T,S,M,E,A=t.type;if(null!=t.constructor)return null;128&n.__u&&(l=!!(32&n.__u),s=[a=t.__e=n.__e]),(u=Fq.__b)&&u(t);e:if("function"==typeof A)try{if(y=t.props,v="prototype"in A&&A.prototype.render,_=(u=A.contextType)&&i[u.__c],x=u?_?_.props.value:u.__:i,n.__c?g=(h=t.__c=n.__c).__=h.__E:(v?t.__c=h=new A(y,x):(t.__c=h=new iX(y,x),h.constructor=A,h.render=bX),_&&_.sub(h),h.props=y,h.state||(h.state={}),h.context=x,h.__n=i,d=h.__d=!0,h.__h=[],h._sb=[]),v&&null==h.__s&&(h.__s=h.state),v&&null!=A.getDerivedStateFromProps&&(h.__s==h.state&&(h.__s=Qq({},h.__s)),Qq(h.__s,A.getDerivedStateFromProps(y,h.__s))),p=h.props,f=h.state,h.__v=t,d)v&&null==A.getDerivedStateFromProps&&null!=h.componentWillMount&&h.componentWillMount(),v&&null!=h.componentDidMount&&h.__h.push(h.componentDidMount);else{if(v&&null==A.getDerivedStateFromProps&&y!==p&&null!=h.componentWillReceiveProps&&h.componentWillReceiveProps(y,x),!h.__e&&null!=h.shouldComponentUpdate&&!1===h.shouldComponentUpdate(y,h.__s,x)||t.__v==n.__v){for(t.__v!=n.__v&&(h.props=y,h.state=h.__s,h.__d=!1),t.__e=n.__e,t.__k=n.__k,t.__k.some((function(e){e&&(e.__=t)})),b=0;b<h._sb.length;b++)h.__h.push(h._sb[b]);h._sb=[],h.__h.length&&o.push(h);break e}null!=h.componentWillUpdate&&h.componentWillUpdate(y,h.__s,x),v&&null!=h.componentDidUpdate&&h.__h.push((function(){h.componentDidUpdate(p,f,m)}))}if(h.context=x,h.props=y,h.__P=e,h.__e=!1,w=Fq.__r,T=0,v){for(h.state=h.__s,h.__d=!1,w&&w(t),u=h.render(h.props,h.state,h.context),S=0;S<h._sb.length;S++)h.__h.push(h._sb[S]);h._sb=[]}else do{h.__d=!1,w&&w(t),u=h.render(h.props,h.state,h.context),h.state=h.__s}while(h.__d&&++T<25);h.state=h.__s,null!=h.getChildContext&&(i=Qq(Qq({},i),h.getChildContext())),v&&!d&&null!=h.getSnapshotBeforeUpdate&&(m=h.getSnapshotBeforeUpdate(p,f)),M=u,null!=u&&u.type===nX&&null==u.key&&(M=yX(u.props.children)),a=lX(e,Jq(M)?M:[M],t,n,i,r,s,o,a,l,c),h.base=t.__e,t.__u&=-161,h.__h.length&&o.push(h),g&&(h.__E=h.__=null)}catch(e){if(t.__v=null,l||null!=s)if(e.then){for(t.__u|=l?160:128;a&&8==a.nodeType&&a.nextSibling;)a=a.nextSibling;s[s.indexOf(a)]=null,t.__e=a}else for(E=s.length;E--;)eX(s[E]);else t.__e=n.__e,t.__k=n.__k;Fq.__e(e,t,n)}else null==s&&t.__v==n.__v?(t.__k=n.__k,t.__e=n.__e):a=t.__e=vX(n.__e,t,n,i,r,s,o,l,c);return(u=Fq.diffed)&&u(t),128&t.__u?void 0:a}function gX(e,t,n){for(var i=0;i<n.length;i++)_X(n[i],n[++i],n[++i]);Fq.__c&&Fq.__c(t,e),e.some((function(t){try{e=t.__h,t.__h=[],e.some((function(e){e.call(t)}))}catch(e){Fq.__e(e,t.__v)}}))}function yX(e){return"object"!=typeof e||null==e||e.__b&&e.__b>0?e:Jq(e)?e.map(yX):Qq({},e)}function vX(e,t,n,i,r,s,o,a,l){var c,u,h,d,p,f,m,g=n.props,y=t.props,v=t.type;if("svg"==v?r="http://www.w3.org/2000/svg":"math"==v?r="http://www.w3.org/1998/Math/MathML":r||(r="http://www.w3.org/1999/xhtml"),null!=s)for(c=0;c<s.length;c++)if((p=s[c])&&"setAttribute"in p==!!v&&(v?p.localName==v:3==p.nodeType)){e=p,s[c]=null;break}if(null==e){if(null==v)return document.createTextNode(y);e=document.createElementNS(r,v,y.is&&y),a&&(Fq.__m&&Fq.__m(t,s),a=!1),s=null}if(null==v)g===y||a&&e.data==y||(e.data=y);else{if(s=s&&Uq.call(e.childNodes),g=n.props||Yq,!a&&null!=s)for(g={},c=0;c<e.attributes.length;c++)g[(p=e.attributes[c]).name]=p.value;for(c in g)if(p=g[c],"children"==c);else if("dangerouslySetInnerHTML"==c)h=p;else if(!(c in y)){if("value"==c&&"defaultValue"in y||"checked"==c&&"defaultChecked"in y)continue;pX(e,c,null,p,r)}for(c in y)p=y[c],"children"==c?d=p:"dangerouslySetInnerHTML"==c?u=p:"value"==c?f=p:"checked"==c?m=p:a&&"function"!=typeof p||g[c]===p||pX(e,c,p,g[c],r);if(u)a||h&&(u.__html==h.__html||u.__html==e.innerHTML)||(e.innerHTML=u.__html),t.__k=[];else if(h&&(e.innerHTML=""),lX("template"==t.type?e.content:e,Jq(d)?d:[d],t,n,i,"foreignObject"==v?"http://www.w3.org/1999/xhtml":r,s,o,s?s[0]:n.__k&&rX(n,0),a,l),null!=s)for(c=s.length;c--;)eX(s[c]);a||(c="value","progress"==v&&null==f?e.removeAttribute("value"):null!=f&&(f!==e[c]||"progress"==v&&!f||"option"==v&&f!=g[c])&&pX(e,c,f,g[c],r),c="checked",null!=m&&m!=e[c]&&pX(e,c,m,g[c],r))}return e}function _X(e,t,n){try{if("function"==typeof e){var i="function"==typeof e.__u;i&&e.__u(),i&&null==t||(e.__u=e(t))}else e.current=t}catch(e){Fq.__e(e,n)}}function xX(e,t,n){var i,r;if(Fq.unmount&&Fq.unmount(e),(i=e.ref)&&(i.current&&i.current!=e.__e||_X(i,null,t)),null!=(i=e.__c)){if(i.componentWillUnmount)try{i.componentWillUnmount()}catch(e){Fq.__e(e,t)}i.base=i.__P=null}if(i=e.__k)for(r=0;r<i.length;r++)i[r]&&xX(i[r],t,n||"function"!=typeof e.type);n||eX(e.__e),e.__c=e.__=e.__e=void 0}function bX(e,t,n){return this.constructor(e,n)}function wX(e,t,n){var i,r,s;t==document&&(t=document.documentElement),Fq.__&&Fq.__(e,t),i=!1?null:t.__k,r=[],s=[],mX(t,e=t.__k=function(e,t,n){var i,r,s,o={};for(s in t)"key"==s?i=t[s]:"ref"==s?r=t[s]:o[s]=t[s];if(arguments.length>2&&(o.children=arguments.length>3?Uq.call(arguments,2):n),"function"==typeof e&&null!=e.defaultProps)for(s in e.defaultProps)void 0===o[s]&&(o[s]=e.defaultProps[s]);return tX(e,o,i,r,null)}(nX,null,[e]),i||Yq,Yq,t.namespaceURI,i?null:t.firstChild?Uq.call(t.childNodes):null,r,i?i.__e:t.firstChild,false,s),gX(r,e,s)}function TX(e,t,n){var i,r,s,o,a=Qq({},e.props);for(s in e.type&&e.type.defaultProps&&(o=e.type.defaultProps),t)"key"==s?i=t[s]:"ref"==s?r=t[s]:a[s]=void 0===t[s]&&null!=o?o[s]:t[s];return arguments.length>2&&(a.children=arguments.length>3?Uq.call(arguments,2):n),tX(e.type,a,i||e.key,r||e.ref,null)}function SX(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function MX(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function EX(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function AX(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,s,o,a=[],l=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t);else for(;!(l=(i=s.call(n)).done)&&(a.push(i.value),a.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return SX(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?SX(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function CX(e){return CX="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},CX(e)}Uq=Kq.slice,Fq={__e:function(e,t,n,i){for(var r,s,o;t=t.__;)if((r=t.__c)&&!r.__)try{if((s=r.constructor)&&null!=s.getDerivedStateFromError&&(r.setState(s.getDerivedStateFromError(e)),o=r.__d),null!=r.componentDidCatch&&(r.componentDidCatch(e,i||{}),o=r.__d),o)return r.__E=r}catch(t){e=t}throw e}},Bq=0,zq=function(e){return null!=e&&null==e.constructor},iX.prototype.setState=function(e,t){var n;n=null!=this.__s&&this.__s!=this.state?this.__s:this.__s=Qq({},this.state),"function"==typeof e&&(e=e(Qq({},n),this.props)),e&&Qq(n,e),null!=e&&this.__v&&(t&&this._sb.push(t),oX(this))},iX.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),oX(this))},iX.prototype.render=nX,Vq=[],jq="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,Hq=function(e,t){return e.__v.__b-t.__v.__b},aX.__r=0,Wq=/(PointerCapture)$|Capture$/i,qq=0,Xq=fX(!1),$q=fX(!0);var RX=function(e){if("object"!==CX(e))return e;var t,n=TX(e);n.props&&(n.props=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?EX(Object(n),!0).forEach((function(t){MX(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):EX(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},n.props),null!=n&&null!==(t=n.props)&&void 0!==t&&t.children&&(n.props.children=Array.isArray(n.props.children)?n.props.children.map(RX):RX(n.props.children)));return n};!function(e,t){void 0===t&&(t={});var n=t.insertAt;if("undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===n&&i.firstChild?i.insertBefore(r,i.firstChild):i.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}(".float-tooltip-kap {\n  position: absolute;\n  width: max-content; /* prevent shrinking near right edge */\n  max-width: max(50%, 150px);\n  padding: 3px 5px;\n  border-radius: 3px;\n  font: 12px sans-serif;\n  color: #eee;\n  background: rgba(0,0,0,0.6);\n  pointer-events: none;\n}\n");var NX=B_({props:{content:{default:!1},offsetX:{triggerUpdate:!1},offsetY:{triggerUpdate:!1}},init:function(e,t){var n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}).style,i=void 0===n?{}:n,r=kq(!!e&&"object"===CX(e)&&!!e.node&&"function"==typeof e.node?e.node():e);"static"===r.style("position")&&r.style("position","relative"),t.tooltipEl=r.append("div").attr("class","float-tooltip-kap"),Object.entries(i).forEach((function(e){var n=AX(e,2),i=n[0],r=n[1];return t.tooltipEl.style(i,r)})),t.tooltipEl.style("left","-10000px").style("display","none");var s="tooltip-".concat(Math.round(1e12*Math.random()));t.mouseInside=!1,r.on("mousemove.".concat(s),(function(e){t.mouseInside=!0;var n=Oq(e),i=r.node(),s=i.offsetWidth,o=i.offsetHeight,a=[null===t.offsetX||void 0===t.offsetX?"-".concat(n[0]/s*100,"%"):"number"==typeof t.offsetX?"calc(-50% + ".concat(t.offsetX,"px)"):t.offsetX,null===t.offsetY||void 0===t.offsetY?o>130&&o-n[1]<100?"calc(-100% - 6px)":"21px":"number"==typeof t.offsetY?t.offsetY<0?"calc(-100% - ".concat(Math.abs(t.offsetY),"px)"):"".concat(t.offsetY,"px"):t.offsetY];t.tooltipEl.style("left",n[0]+"px").style("top",n[1]+"px").style("transform","translate(".concat(a.join(","),")")),t.content&&t.tooltipEl.style("display","inline")})),r.on("mouseover.".concat(s),(function(){t.mouseInside=!0,t.content&&t.tooltipEl.style("display","inline")})),r.on("mouseout.".concat(s),(function(){t.mouseInside=!1,t.tooltipEl.style("display","none")}))},update:function(e){var t,n;e.tooltipEl.style("display",e.content&&e.mouseInside?"inline":"none"),e.content?e.content instanceof HTMLElement?(e.tooltipEl.text(""),e.tooltipEl.append((function(){return e.content}))):"string"==typeof e.content?e.tooltipEl.html(e.content):!function(e){return zq(TX(e))}(e.content)?(e.tooltipEl.style("display","none"),console.warn("Tooltip content is invalid, skipping.",e.content,e.content.toString())):(e.tooltipEl.text(""),t=e.content,delete(n=e.tooltipEl.node()).__k,wX(RX(t),n)):e.tooltipEl.text("")}});function PX(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function DX(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function LX(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,s,o,a=[],l=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t);else for(;!(l=(i=s.call(n)).done)&&(a.push(i.value),a.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return a}}(e,t)||kX(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function IX(e){return function(e){if(Array.isArray(e))return PX(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||kX(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function kX(e,t){if(e){if("string"==typeof e)return PX(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?PX(e,t):void 0}}!function(e,t){void 0===t&&(t={});var n=t.insertAt;if("undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===n&&i.firstChild?i.insertBefore(r,i.firstChild):i.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}(".scene-nav-info {\n  position: absolute;\n  bottom: 5px;\n  width: 100%;\n  text-align: center;\n  color: slategrey;\n  opacity: 0.7;\n  font-size: 10px;\n  font-family: sans-serif;\n  pointer-events: none;\n  user-select: none;\n}\n\n.scene-container canvas:focus {\n  outline: none;\n}");var OX=window.THREE?window.THREE:{WebGLRenderer:class{constructor(e={}){const{canvas:t=Bc(),context:n=null,depth:i=!0,stencil:r=!1,alpha:s=!1,antialias:o=!1,premultipliedAlpha:a=!0,preserveDrawingBuffer:l=!1,powerPreference:c="default",failIfMajorPerformanceCaveat:u=!1,reverseDepthBuffer:h=!1}=e;let d;if(this.isWebGLRenderer=!0,null!==n){if("undefined"!=typeof WebGLRenderingContext&&n instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");d=n.getContextAttributes().alpha}else d=s;const p=new Uint32Array(4),f=new Int32Array(4);let m=null,g=null;const y=[],v=[];this.domElement=t,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.toneMapping=0,this.toneMappingExposure=1,this.transmissionResolutionScale=1;const _=this;let x=!1;this._outputColorSpace=ec;let b=0,w=0,T=null,S=-1,M=null;const E=new nu,A=new nu;let C=null;const R=new Eh(0);let N=0,P=t.width,D=t.height,L=1,I=null,k=null;const O=new nu(0,0,P,D),U=new nu(0,0,P,D);let F=!1;const B=new Vd;let z=!1,V=!1;const G=new Iu,j=new Iu,H=new Dc,W=new nu,q={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let X=!1;function $(){return null===T?L:1}let Y,K,Z,J,Q,ee,te,ne,ie,re,se,oe,ae,le,ce,ue,he,de,pe,fe,me,ge,ye,ve,_e=n;function xe(e,n){return t.getContext(e,n)}try{const e={alpha:!0,depth:i,stencil:r,antialias:o,premultipliedAlpha:a,preserveDrawingBuffer:l,powerPreference:c,failIfMajorPerformanceCaveat:u};if("setAttribute"in t&&t.setAttribute("data-engine",`three.js r${na}`),t.addEventListener("webglcontextlost",Te,!1),t.addEventListener("webglcontextrestored",Se,!1),t.addEventListener("webglcontextcreationerror",Me,!1),null===_e){const t="webgl2";if(_e=xe(t,e),null===_e)throw xe(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}function be(){Y=new Kf(_e),Y.init(),ge=new qg(_e,Y),K=new Cf(_e,Y,e,ge),Z=new Hg(_e,Y),K.reverseDepthBuffer&&h&&Z.buffers.depth.setReversed(!0),J=new Qf(_e),Q=new Pg,ee=new Wg(_e,Y,Z,Q,K,ge,J),te=new Nf(_),ne=new Yf(_),ie=new vf(_e),ye=new Ef(_e,ie),re=new Zf(_e,ie,J,ye),se=new tm(_e,re,ie,J),pe=new em(_e,K,ee),ue=new Rf(Q),oe=new Ng(_,te,ne,Y,K,ye,ue),ae=new Zg(_,Q),le=new kg,ce=new Vg(Y),de=new Mf(_,te,ne,Z,se,d,a),he=new Gg(_,se,K),ve=new Jg(_e,J,K,Z),fe=new Af(_e,Y,J),me=new Jf(_e,Y,J),J.programs=oe.programs,_.capabilities=K,_.extensions=Y,_.properties=Q,_.renderLists=le,_.shadowMap=he,_.state=Z,_.info=J}be();const we=new $g(_,_e);function Te(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),x=!0}function Se(){console.log("THREE.WebGLRenderer: Context Restored."),x=!1;const e=J.autoReset,t=he.enabled,n=he.autoUpdate,i=he.needsUpdate,r=he.type;be(),J.autoReset=e,he.enabled=t,he.autoUpdate=n,he.needsUpdate=i,he.type=r}function Me(e){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function Ee(e){const t=e.target;t.removeEventListener("dispose",Ee),function(e){(function(e){const t=Q.get(e).programs;void 0!==t&&(t.forEach((function(e){oe.releaseProgram(e)})),e.isShaderMaterial&&oe.releaseShaderCache(e))})(e),Q.remove(e)}(t)}function Ae(e,t,n){!0===e.transparent&&2===e.side&&!1===e.forceSinglePass?(e.side=1,e.needsUpdate=!0,Ue(e,t,n),e.side=0,e.needsUpdate=!0,Ue(e,t,n),e.side=2):Ue(e,t,n)}this.xr=we,this.getContext=function(){return _e},this.getContextAttributes=function(){return _e.getContextAttributes()},this.forceContextLoss=function(){const e=Y.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=Y.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return L},this.setPixelRatio=function(e){void 0!==e&&(L=e,this.setSize(P,D,!1))},this.getSize=function(e){return e.set(P,D)},this.setSize=function(e,n,i=!0){we.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(P=e,D=n,t.width=Math.floor(e*L),t.height=Math.floor(n*L),!0===i&&(t.style.width=e+"px",t.style.height=n+"px"),this.setViewport(0,0,e,n))},this.getDrawingBufferSize=function(e){return e.set(P*L,D*L).floor()},this.setDrawingBufferSize=function(e,n,i){P=e,D=n,L=i,t.width=Math.floor(e*i),t.height=Math.floor(n*i),this.setViewport(0,0,e,n)},this.getCurrentViewport=function(e){return e.copy(E)},this.getViewport=function(e){return e.copy(O)},this.setViewport=function(e,t,n,i){e.isVector4?O.set(e.x,e.y,e.z,e.w):O.set(e,t,n,i),Z.viewport(E.copy(O).multiplyScalar(L).round())},this.getScissor=function(e){return e.copy(U)},this.setScissor=function(e,t,n,i){e.isVector4?U.set(e.x,e.y,e.z,e.w):U.set(e,t,n,i),Z.scissor(A.copy(U).multiplyScalar(L).round())},this.getScissorTest=function(){return F},this.setScissorTest=function(e){Z.setScissorTest(F=e)},this.setOpaqueSort=function(e){I=e},this.setTransparentSort=function(e){k=e},this.getClearColor=function(e){return e.copy(de.getClearColor())},this.setClearColor=function(){de.setClearColor(...arguments)},this.getClearAlpha=function(){return de.getClearAlpha()},this.setClearAlpha=function(){de.setClearAlpha(...arguments)},this.clear=function(e=!0,t=!0,n=!0){let i=0;if(e){let e=!1;if(null!==T){const t=T.texture.format;e=t===xl||t===_l||t===yl}if(e){const e=T.texture.type,t=e===Qa||e===rl||e===nl||e===cl||e===al||e===ll,n=de.getClearColor(),i=de.getClearAlpha(),r=n.r,s=n.g,o=n.b;t?(p[0]=r,p[1]=s,p[2]=o,p[3]=i,_e.clearBufferuiv(_e.COLOR,0,p)):(f[0]=r,f[1]=s,f[2]=o,f[3]=i,_e.clearBufferiv(_e.COLOR,0,f))}else i|=_e.COLOR_BUFFER_BIT}t&&(i|=_e.DEPTH_BUFFER_BIT),n&&(i|=_e.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),_e.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",Te,!1),t.removeEventListener("webglcontextrestored",Se,!1),t.removeEventListener("webglcontextcreationerror",Me,!1),de.dispose(),le.dispose(),ce.dispose(),Q.dispose(),te.dispose(),ne.dispose(),se.dispose(),ye.dispose(),ve.dispose(),oe.dispose(),we.dispose(),we.removeEventListener("sessionstart",Re),we.removeEventListener("sessionend",Ne),Pe.stop()},this.renderBufferDirect=function(e,t,n,i,r,s){null===t&&(t=q);const o=r.isMesh&&r.matrixWorld.determinant()<0,a=function(e,t,n,i,r){!0!==t.isScene&&(t=q);ee.resetTextureUnits();const s=t.fog,o=i.isMeshStandardMaterial?t.environment:null,a=null===T?_.outputColorSpace:!0===T.isXRRenderTarget?T.texture.colorSpace:tc,l=(i.isMeshStandardMaterial?ne:te).get(i.envMap||o),c=!0===i.vertexColors&&!!n.attributes.color&&4===n.attributes.color.itemSize,u=!!n.attributes.tangent&&(!!i.normalMap||i.anisotropy>0),h=!!n.morphAttributes.position,d=!!n.morphAttributes.normal,p=!!n.morphAttributes.color;let f=0;i.toneMapped&&(null!==T&&!0!==T.isXRRenderTarget||(f=_.toneMapping));const m=n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color,y=void 0!==m?m.length:0,v=Q.get(i),x=g.state.lights;if(!0===z&&(!0===V||e!==M)){const t=e===M&&i.id===S;ue.setState(i,e,t)}let b=!1;i.version===v.__version?v.needsLights&&v.lightsStateVersion!==x.state.version||v.outputColorSpace!==a||r.isBatchedMesh&&!1===v.batching?b=!0:r.isBatchedMesh||!0!==v.batching?r.isBatchedMesh&&!0===v.batchingColor&&null===r.colorTexture||r.isBatchedMesh&&!1===v.batchingColor&&null!==r.colorTexture||r.isInstancedMesh&&!1===v.instancing?b=!0:r.isInstancedMesh||!0!==v.instancing?r.isSkinnedMesh&&!1===v.skinning?b=!0:r.isSkinnedMesh||!0!==v.skinning?r.isInstancedMesh&&!0===v.instancingColor&&null===r.instanceColor||r.isInstancedMesh&&!1===v.instancingColor&&null!==r.instanceColor||r.isInstancedMesh&&!0===v.instancingMorph&&null===r.morphTexture||r.isInstancedMesh&&!1===v.instancingMorph&&null!==r.morphTexture||v.envMap!==l||!0===i.fog&&v.fog!==s?b=!0:void 0===v.numClippingPlanes||v.numClippingPlanes===ue.numPlanes&&v.numIntersection===ue.numIntersection?(v.vertexAlphas!==c||v.vertexTangents!==u||v.morphTargets!==h||v.morphNormals!==d||v.morphColors!==p||v.toneMapping!==f||v.morphTargetsCount!==y)&&(b=!0):b=!0:b=!0:b=!0:b=!0:(b=!0,v.__version=i.version);let w=v.currentProgram;!0===b&&(w=Ue(i,t,r));let E=!1,A=!1,C=!1;const R=w.getUniforms(),N=v.uniforms;Z.useProgram(w.program)&&(E=!0,A=!0,C=!0);i.id!==S&&(S=i.id,A=!0);if(E||M!==e){Z.buffers.depth.getReversed()?(G.copy(e.projectionMatrix),function(e){const t=e.elements;t[2]=.5*t[2]+.5*t[3],t[6]=.5*t[6]+.5*t[7],t[10]=.5*t[10]+.5*t[11],t[14]=.5*t[14]+.5*t[15]}(G),function(e){const t=e.elements;-1===t[11]?(t[10]=-t[10]-1,t[14]=-t[14]):(t[10]=-t[10],t[14]=1-t[14])}(G),R.setValue(_e,"projectionMatrix",G)):R.setValue(_e,"projectionMatrix",e.projectionMatrix),R.setValue(_e,"viewMatrix",e.matrixWorldInverse);const t=R.map.cameraPosition;void 0!==t&&t.setValue(_e,H.setFromMatrixPosition(e.matrixWorld)),K.logarithmicDepthBuffer&&R.setValue(_e,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&R.setValue(_e,"isOrthographic",!0===e.isOrthographicCamera),M!==e&&(M=e,A=!0,C=!0)}if(r.isSkinnedMesh){R.setOptional(_e,r,"bindMatrix"),R.setOptional(_e,r,"bindMatrixInverse");const e=r.skeleton;e&&(null===e.boneTexture&&e.computeBoneTexture(),R.setValue(_e,"boneTexture",e.boneTexture,ee))}r.isBatchedMesh&&(R.setOptional(_e,r,"batchingTexture"),R.setValue(_e,"batchingTexture",r._matricesTexture,ee),R.setOptional(_e,r,"batchingIdTexture"),R.setValue(_e,"batchingIdTexture",r._indirectTexture,ee),R.setOptional(_e,r,"batchingColorTexture"),null!==r._colorsTexture&&R.setValue(_e,"batchingColorTexture",r._colorsTexture,ee));const P=n.morphAttributes;void 0===P.position&&void 0===P.normal&&void 0===P.color||pe.update(r,n,w);(A||v.receiveShadow!==r.receiveShadow)&&(v.receiveShadow=r.receiveShadow,R.setValue(_e,"receiveShadow",r.receiveShadow));i.isMeshGouraudMaterial&&null!==i.envMap&&(N.envMap.value=l,N.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1);i.isMeshStandardMaterial&&null===i.envMap&&null!==t.environment&&(N.envMapIntensity.value=t.environmentIntensity);A&&(R.setValue(_e,"toneMappingExposure",_.toneMappingExposure),v.needsLights&&(k=C,(I=N).ambientLightColor.needsUpdate=k,I.lightProbe.needsUpdate=k,I.directionalLights.needsUpdate=k,I.directionalLightShadows.needsUpdate=k,I.pointLights.needsUpdate=k,I.pointLightShadows.needsUpdate=k,I.spotLights.needsUpdate=k,I.spotLightShadows.needsUpdate=k,I.rectAreaLights.needsUpdate=k,I.hemisphereLights.needsUpdate=k),s&&!0===i.fog&&ae.refreshFogUniforms(N,s),ae.refreshMaterialUniforms(N,i,L,D,g.state.transmissionRenderTarget[e.id]),og.upload(_e,Fe(v),N,ee));var I,k;i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(og.upload(_e,Fe(v),N,ee),i.uniformsNeedUpdate=!1);i.isSpriteMaterial&&R.setValue(_e,"center",r.center);if(R.setValue(_e,"modelViewMatrix",r.modelViewMatrix),R.setValue(_e,"normalMatrix",r.normalMatrix),R.setValue(_e,"modelMatrix",r.matrixWorld),i.isShaderMaterial||i.isRawShaderMaterial){const e=i.uniformsGroups;for(let t=0,n=e.length;t<n;t++){const n=e[t];ve.update(n,w),ve.bind(n,w)}}return w}(e,t,n,i,r);Z.setMaterial(i,o);let l=n.index,c=1;if(!0===i.wireframe){if(l=re.getWireframeAttribute(n),void 0===l)return;c=2}const u=n.drawRange,h=n.attributes.position;let d=u.start*c,p=(u.start+u.count)*c;null!==s&&(d=Math.max(d,s.start*c),p=Math.min(p,(s.start+s.count)*c)),null!==l?(d=Math.max(d,0),p=Math.min(p,l.count)):null!=h&&(d=Math.max(d,0),p=Math.min(p,h.count));const f=p-d;if(f<0||f===1/0)return;let m;ye.setup(r,i,a,n,l);let y=fe;if(null!==l&&(m=ie.get(l),y=me,y.setIndex(m)),r.isMesh)!0===i.wireframe?(Z.setLineWidth(i.wireframeLinewidth*$()),y.setMode(_e.LINES)):y.setMode(_e.TRIANGLES);else if(r.isLine){let e=i.linewidth;void 0===e&&(e=1),Z.setLineWidth(e*$()),r.isLineSegments?y.setMode(_e.LINES):r.isLineLoop?y.setMode(_e.LINE_LOOP):y.setMode(_e.LINE_STRIP)}else r.isPoints?y.setMode(_e.POINTS):r.isSprite&&y.setMode(_e.TRIANGLES);if(r.isBatchedMesh)if(null!==r._multiDrawInstances)Vc("THREE.WebGLRenderer: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),y.renderMultiDrawInstances(r._multiDrawStarts,r._multiDrawCounts,r._multiDrawCount,r._multiDrawInstances);else if(Y.get("WEBGL_multi_draw"))y.renderMultiDraw(r._multiDrawStarts,r._multiDrawCounts,r._multiDrawCount);else{const e=r._multiDrawStarts,t=r._multiDrawCounts,n=r._multiDrawCount,s=l?ie.get(l).bytesPerElement:1,o=Q.get(i).currentProgram.getUniforms();for(let i=0;i<n;i++)o.setValue(_e,"_gl_DrawID",i),y.render(e[i]/s,t[i])}else if(r.isInstancedMesh)y.renderInstances(d,f,r.count);else if(n.isInstancedBufferGeometry){const e=void 0!==n._maxInstanceCount?n._maxInstanceCount:1/0,t=Math.min(n.instanceCount,e);y.renderInstances(d,f,t)}else y.render(d,f)},this.compile=function(e,t,n=null){null===n&&(n=e),g=ce.get(n),g.init(t),v.push(g),n.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(g.pushLight(e),e.castShadow&&g.pushShadow(e))})),e!==n&&e.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(g.pushLight(e),e.castShadow&&g.pushShadow(e))})),g.setupLights();const i=new Set;return e.traverse((function(e){if(!(e.isMesh||e.isPoints||e.isLine||e.isSprite))return;const t=e.material;if(t)if(Array.isArray(t))for(let r=0;r<t.length;r++){const s=t[r];Ae(s,n,e),i.add(s)}else Ae(t,n,e),i.add(t)})),g=v.pop(),i},this.compileAsync=function(e,t,n=null){const i=this.compile(e,t,n);return new Promise((t=>{function n(){i.forEach((function(e){Q.get(e).currentProgram.isReady()&&i.delete(e)})),0!==i.size?setTimeout(n,10):t(e)}null!==Y.get("KHR_parallel_shader_compile")?n():setTimeout(n,10)}))};let Ce=null;function Re(){Pe.stop()}function Ne(){Pe.start()}const Pe=new yf;function De(e,t,n,i){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)n=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)g.pushLight(e),e.castShadow&&g.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||B.intersectsSprite(e)){i&&W.setFromMatrixPosition(e.matrixWorld).applyMatrix4(j);const t=se.update(e),r=e.material;r.visible&&m.push(e,t,r,n,W.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||B.intersectsObject(e))){const t=se.update(e),r=e.material;if(i&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),W.copy(e.boundingSphere.center)):(null===t.boundingSphere&&t.computeBoundingSphere(),W.copy(t.boundingSphere.center)),W.applyMatrix4(e.matrixWorld).applyMatrix4(j)),Array.isArray(r)){const i=t.groups;for(let s=0,o=i.length;s<o;s++){const o=i[s],a=r[o.materialIndex];a&&a.visible&&m.push(e,t,a,n,W.z,o)}}else r.visible&&m.push(e,t,r,n,W.z,null)}const r=e.children;for(let e=0,s=r.length;e<s;e++)De(r[e],t,n,i)}function Le(e,t,n,i){const r=e.opaque,s=e.transmissive,o=e.transparent;g.setupLightsView(n),!0===z&&ue.setGlobalState(_.clippingPlanes,n),i&&Z.viewport(E.copy(i)),r.length>0&&ke(r,t,n),s.length>0&&ke(s,t,n),o.length>0&&ke(o,t,n),Z.buffers.depth.setTest(!0),Z.buffers.depth.setMask(!0),Z.buffers.color.setMask(!0),Z.setPolygonOffset(!1)}function Ie(e,t,n,i){if(null!==(!0===n.isScene?n.overrideMaterial:null))return;void 0===g.state.transmissionRenderTarget[i.id]&&(g.state.transmissionRenderTarget[i.id]=new ru(1,1,{generateMipmaps:!0,type:Y.has("EXT_color_buffer_half_float")||Y.has("EXT_color_buffer_float")?ol:Qa,minFilter:Ja,samples:4,stencilBuffer:r,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:Wc.workingColorSpace}));const s=g.state.transmissionRenderTarget[i.id],o=i.viewport||E;s.setSize(o.z*_.transmissionResolutionScale,o.w*_.transmissionResolutionScale);const a=_.getRenderTarget();_.setRenderTarget(s),_.getClearColor(R),N=_.getClearAlpha(),N<1&&_.setClearColor(16777215,.5),_.clear(),X&&de.render(n);const l=_.toneMapping;_.toneMapping=0;const c=i.viewport;if(void 0!==i.viewport&&(i.viewport=void 0),g.setupLightsView(i),!0===z&&ue.setGlobalState(_.clippingPlanes,i),ke(e,n,i),ee.updateMultisampleRenderTarget(s),ee.updateRenderTargetMipmap(s),!1===Y.has("WEBGL_multisampled_render_to_texture")){let e=!1;for(let r=0,s=t.length;r<s;r++){const s=t[r],o=s.object,a=s.geometry,l=s.material,c=s.group;if(2===l.side&&o.layers.test(i.layers)){const t=l.side;l.side=1,l.needsUpdate=!0,Oe(o,n,i,a,l,c),l.side=t,l.needsUpdate=!0,e=!0}}!0===e&&(ee.updateMultisampleRenderTarget(s),ee.updateRenderTargetMipmap(s))}_.setRenderTarget(a),_.setClearColor(R,N),void 0!==c&&(i.viewport=c),_.toneMapping=l}function ke(e,t,n){const i=!0===t.isScene?t.overrideMaterial:null;for(let r=0,s=e.length;r<s;r++){const s=e[r],o=s.object,a=s.geometry,l=s.group;let c=s.material;!0===c.allowOverride&&null!==i&&(c=i),o.layers.test(n.layers)&&Oe(o,t,n,a,c,l)}}function Oe(e,t,n,i,r,s){e.onBeforeRender(_,t,n,i,r,s),e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),r.onBeforeRender(_,t,n,i,e,s),!0===r.transparent&&2===r.side&&!1===r.forceSinglePass?(r.side=1,r.needsUpdate=!0,_.renderBufferDirect(n,t,i,r,e,s),r.side=0,r.needsUpdate=!0,_.renderBufferDirect(n,t,i,r,e,s),r.side=2):_.renderBufferDirect(n,t,i,r,e,s),e.onAfterRender(_,t,n,i,r,s)}function Ue(e,t,n){!0!==t.isScene&&(t=q);const i=Q.get(e),r=g.state.lights,s=g.state.shadowsArray,o=r.state.version,a=oe.getParameters(e,r.state,s,t,n),l=oe.getProgramCacheKey(a);let c=i.programs;i.environment=e.isMeshStandardMaterial?t.environment:null,i.fog=t.fog,i.envMap=(e.isMeshStandardMaterial?ne:te).get(e.envMap||i.environment),i.envMapRotation=null!==i.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation,void 0===c&&(e.addEventListener("dispose",Ee),c=new Map,i.programs=c);let u=c.get(l);if(void 0!==u){if(i.currentProgram===u&&i.lightsStateVersion===o)return Be(e,a),u}else a.uniforms=oe.getUniforms(e),e.onBeforeCompile(a,_),u=oe.acquireProgram(a,l),c.set(l,u),i.uniforms=a.uniforms;const h=i.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(h.clippingPlanes=ue.uniform),Be(e,a),i.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),i.lightsStateVersion=o,i.needsLights&&(h.ambientLightColor.value=r.state.ambient,h.lightProbe.value=r.state.probe,h.directionalLights.value=r.state.directional,h.directionalLightShadows.value=r.state.directionalShadow,h.spotLights.value=r.state.spot,h.spotLightShadows.value=r.state.spotShadow,h.rectAreaLights.value=r.state.rectArea,h.ltc_1.value=r.state.rectAreaLTC1,h.ltc_2.value=r.state.rectAreaLTC2,h.pointLights.value=r.state.point,h.pointLightShadows.value=r.state.pointShadow,h.hemisphereLights.value=r.state.hemi,h.directionalShadowMap.value=r.state.directionalShadowMap,h.directionalShadowMatrix.value=r.state.directionalShadowMatrix,h.spotShadowMap.value=r.state.spotShadowMap,h.spotLightMatrix.value=r.state.spotLightMatrix,h.spotLightMap.value=r.state.spotLightMap,h.pointShadowMap.value=r.state.pointShadowMap,h.pointShadowMatrix.value=r.state.pointShadowMatrix),i.currentProgram=u,i.uniformsList=null,u}function Fe(e){if(null===e.uniformsList){const t=e.currentProgram.getUniforms();e.uniformsList=og.seqWithValue(t.seq,e.uniforms)}return e.uniformsList}function Be(e,t){const n=Q.get(e);n.outputColorSpace=t.outputColorSpace,n.batching=t.batching,n.batchingColor=t.batchingColor,n.instancing=t.instancing,n.instancingColor=t.instancingColor,n.instancingMorph=t.instancingMorph,n.skinning=t.skinning,n.morphTargets=t.morphTargets,n.morphNormals=t.morphNormals,n.morphColors=t.morphColors,n.morphTargetsCount=t.morphTargetsCount,n.numClippingPlanes=t.numClippingPlanes,n.numIntersection=t.numClipIntersection,n.vertexAlphas=t.vertexAlphas,n.vertexTangents=t.vertexTangents,n.toneMapping=t.toneMapping}Pe.setAnimationLoop((function(e){Ce&&Ce(e)})),"undefined"!=typeof self&&Pe.setContext(self),this.setAnimationLoop=function(e){Ce=e,we.setAnimationLoop(e),null===e?Pe.stop():Pe.start()},we.addEventListener("sessionstart",Re),we.addEventListener("sessionend",Ne),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===x)return;if(!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===we.enabled&&!0===we.isPresenting&&(!0===we.cameraAutoUpdate&&we.updateCamera(t),t=we.getCamera()),!0===e.isScene&&e.onBeforeRender(_,e,t,T),g=ce.get(e,v.length),g.init(t),v.push(g),j.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),B.setFromProjectionMatrix(j),V=this.localClippingEnabled,z=ue.init(this.clippingPlanes,V),m=le.get(e,y.length),m.init(),y.push(m),!0===we.enabled&&!0===we.isPresenting){const e=_.xr.getDepthSensingMesh();null!==e&&De(e,t,-1/0,_.sortObjects)}De(e,t,0,_.sortObjects),m.finish(),!0===_.sortObjects&&m.sort(I,k),X=!1===we.enabled||!1===we.isPresenting||!1===we.hasDepthSensing(),X&&de.addToRenderList(m,e),this.info.render.frame++,!0===z&&ue.beginShadows();const n=g.state.shadowsArray;he.render(n,e,t),!0===z&&ue.endShadows(),!0===this.info.autoReset&&this.info.reset();const i=m.opaque,r=m.transmissive;if(g.setupLights(),t.isArrayCamera){const n=t.cameras;if(r.length>0)for(let t=0,s=n.length;t<s;t++){Ie(i,r,e,n[t])}X&&de.render(e);for(let t=0,i=n.length;t<i;t++){const i=n[t];Le(m,e,i,i.viewport)}}else r.length>0&&Ie(i,r,e,t),X&&de.render(e),Le(m,e,t);null!==T&&0===w&&(ee.updateMultisampleRenderTarget(T),ee.updateRenderTargetMipmap(T)),!0===e.isScene&&e.onAfterRender(_,e,t),ye.resetDefaultState(),S=-1,M=null,v.pop(),v.length>0?(g=v[v.length-1],!0===z&&ue.setGlobalState(_.clippingPlanes,g.state.camera)):g=null,y.pop(),m=y.length>0?y[y.length-1]:null},this.getActiveCubeFace=function(){return b},this.getActiveMipmapLevel=function(){return w},this.getRenderTarget=function(){return T},this.setRenderTargetTextures=function(e,t,n){const i=Q.get(e);i.__autoAllocateDepthBuffer=!1===e.resolveDepthBuffer,!1===i.__autoAllocateDepthBuffer&&(i.__useRenderToTexture=!1),Q.get(e.texture).__webglTexture=t,Q.get(e.depthTexture).__webglTexture=i.__autoAllocateDepthBuffer?void 0:n,i.__hasExternalTextures=!0},this.setRenderTargetFramebuffer=function(e,t){const n=Q.get(e);n.__webglFramebuffer=t,n.__useDefaultFramebuffer=void 0===t};const ze=_e.createFramebuffer();this.setRenderTarget=function(e,t=0,n=0){T=e,b=t,w=n;let i=!0,r=null,s=!1,o=!1;if(e){const a=Q.get(e);if(void 0!==a.__useDefaultFramebuffer)Z.bindFramebuffer(_e.FRAMEBUFFER,null),i=!1;else if(void 0===a.__webglFramebuffer)ee.setupRenderTarget(e);else if(a.__hasExternalTextures)ee.rebindTextures(e,Q.get(e.texture).__webglTexture,Q.get(e.depthTexture).__webglTexture);else if(e.depthBuffer){const t=e.depthTexture;if(a.__boundDepthTexture!==t){if(null!==t&&Q.has(t)&&(e.width!==t.image.width||e.height!==t.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");ee.setupDepthRenderbuffer(e)}}const l=e.texture;(l.isData3DTexture||l.isDataArrayTexture||l.isCompressedArrayTexture)&&(o=!0);const c=Q.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(r=Array.isArray(c[t])?c[t][n]:c[t],s=!0):r=e.samples>0&&!1===ee.useMultisampledRTT(e)?Q.get(e).__webglMultisampledFramebuffer:Array.isArray(c)?c[n]:c,E.copy(e.viewport),A.copy(e.scissor),C=e.scissorTest}else E.copy(O).multiplyScalar(L).floor(),A.copy(U).multiplyScalar(L).floor(),C=F;0!==n&&(r=ze);if(Z.bindFramebuffer(_e.FRAMEBUFFER,r)&&i&&Z.drawBuffers(e,r),Z.viewport(E),Z.scissor(A),Z.setScissorTest(C),s){const i=Q.get(e.texture);_e.framebufferTexture2D(_e.FRAMEBUFFER,_e.COLOR_ATTACHMENT0,_e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.__webglTexture,n)}else if(o){const i=Q.get(e.texture),r=t;_e.framebufferTextureLayer(_e.FRAMEBUFFER,_e.COLOR_ATTACHMENT0,i.__webglTexture,n,r)}else if(null!==e&&0!==n){const t=Q.get(e.texture);_e.framebufferTexture2D(_e.FRAMEBUFFER,_e.COLOR_ATTACHMENT0,_e.TEXTURE_2D,t.__webglTexture,n)}S=-1},this.readRenderTargetPixels=function(e,t,n,i,r,s,o,a=0){if(!e||!e.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let l=Q.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==o&&(l=l[o]),l){Z.bindFramebuffer(_e.FRAMEBUFFER,l);try{const o=e.textures[a],l=o.format,c=o.type;if(!K.textureFormatReadable(l))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!K.textureTypeReadable(c))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");t>=0&&t<=e.width-i&&n>=0&&n<=e.height-r&&(e.textures.length>1&&_e.readBuffer(_e.COLOR_ATTACHMENT0+a),_e.readPixels(t,n,i,r,ge.convert(l),ge.convert(c),s))}finally{const e=null!==T?Q.get(T).__webglFramebuffer:null;Z.bindFramebuffer(_e.FRAMEBUFFER,e)}}},this.readRenderTargetPixelsAsync=async function(e,t,n,i,r,s,o,a=0){if(!e||!e.isWebGLRenderTarget)throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let l=Q.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==o&&(l=l[o]),l){if(t>=0&&t<=e.width-i&&n>=0&&n<=e.height-r){Z.bindFramebuffer(_e.FRAMEBUFFER,l);const o=e.textures[a],c=o.format,u=o.type;if(!K.textureFormatReadable(c))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!K.textureTypeReadable(u))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");const h=_e.createBuffer();_e.bindBuffer(_e.PIXEL_PACK_BUFFER,h),_e.bufferData(_e.PIXEL_PACK_BUFFER,s.byteLength,_e.STREAM_READ),e.textures.length>1&&_e.readBuffer(_e.COLOR_ATTACHMENT0+a),_e.readPixels(t,n,i,r,ge.convert(c),ge.convert(u),0);const d=null!==T?Q.get(T).__webglFramebuffer:null;Z.bindFramebuffer(_e.FRAMEBUFFER,d);const p=_e.fenceSync(_e.SYNC_GPU_COMMANDS_COMPLETE,0);return _e.flush(),await function(e,t,n){return new Promise((function(i,r){setTimeout((function s(){switch(e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0)){case e.WAIT_FAILED:r();break;case e.TIMEOUT_EXPIRED:setTimeout(s,n);break;default:i()}}),n)}))}(_e,p,4),_e.bindBuffer(_e.PIXEL_PACK_BUFFER,h),_e.getBufferSubData(_e.PIXEL_PACK_BUFFER,0,s),_e.deleteBuffer(h),_e.deleteSync(p),s}throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")}},this.copyFramebufferToTexture=function(e,t=null,n=0){const i=Math.pow(2,-n),r=Math.floor(e.image.width*i),s=Math.floor(e.image.height*i),o=null!==t?t.x:0,a=null!==t?t.y:0;ee.setTexture2D(e,0),_e.copyTexSubImage2D(_e.TEXTURE_2D,n,0,0,o,a,r,s),Z.unbindTexture()};const Ve=_e.createFramebuffer(),Ge=_e.createFramebuffer();this.copyTextureToTexture=function(e,t,n=null,i=null,r=0,s=null){let o,a,l,c,u,h,d,p,f;null===s&&(0!==r?(Vc("WebGLRenderer: copyTextureToTexture function signature has changed to support src and dst mipmap levels."),s=r,r=0):s=0);const m=e.isCompressedTexture?e.mipmaps[s]:e.image;if(null!==n)o=n.max.x-n.min.x,a=n.max.y-n.min.y,l=n.isBox3?n.max.z-n.min.z:1,c=n.min.x,u=n.min.y,h=n.isBox3?n.min.z:0;else{const t=Math.pow(2,-r);o=Math.floor(m.width*t),a=Math.floor(m.height*t),l=e.isDataArrayTexture?m.depth:e.isData3DTexture?Math.floor(m.depth*t):1,c=0,u=0,h=0}null!==i?(d=i.x,p=i.y,f=i.z):(d=0,p=0,f=0);const g=ge.convert(t.format),y=ge.convert(t.type);let v;t.isData3DTexture?(ee.setTexture3D(t,0),v=_e.TEXTURE_3D):t.isDataArrayTexture||t.isCompressedArrayTexture?(ee.setTexture2DArray(t,0),v=_e.TEXTURE_2D_ARRAY):(ee.setTexture2D(t,0),v=_e.TEXTURE_2D),_e.pixelStorei(_e.UNPACK_FLIP_Y_WEBGL,t.flipY),_e.pixelStorei(_e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),_e.pixelStorei(_e.UNPACK_ALIGNMENT,t.unpackAlignment);const _=_e.getParameter(_e.UNPACK_ROW_LENGTH),x=_e.getParameter(_e.UNPACK_IMAGE_HEIGHT),b=_e.getParameter(_e.UNPACK_SKIP_PIXELS),w=_e.getParameter(_e.UNPACK_SKIP_ROWS),T=_e.getParameter(_e.UNPACK_SKIP_IMAGES);_e.pixelStorei(_e.UNPACK_ROW_LENGTH,m.width),_e.pixelStorei(_e.UNPACK_IMAGE_HEIGHT,m.height),_e.pixelStorei(_e.UNPACK_SKIP_PIXELS,c),_e.pixelStorei(_e.UNPACK_SKIP_ROWS,u),_e.pixelStorei(_e.UNPACK_SKIP_IMAGES,h);const S=e.isDataArrayTexture||e.isData3DTexture,M=t.isDataArrayTexture||t.isData3DTexture;if(e.isDepthTexture){const n=Q.get(e),i=Q.get(t),m=Q.get(n.__renderTarget),g=Q.get(i.__renderTarget);Z.bindFramebuffer(_e.READ_FRAMEBUFFER,m.__webglFramebuffer),Z.bindFramebuffer(_e.DRAW_FRAMEBUFFER,g.__webglFramebuffer);for(let n=0;n<l;n++)S&&(_e.framebufferTextureLayer(_e.READ_FRAMEBUFFER,_e.COLOR_ATTACHMENT0,Q.get(e).__webglTexture,r,h+n),_e.framebufferTextureLayer(_e.DRAW_FRAMEBUFFER,_e.COLOR_ATTACHMENT0,Q.get(t).__webglTexture,s,f+n)),_e.blitFramebuffer(c,u,o,a,d,p,o,a,_e.DEPTH_BUFFER_BIT,_e.NEAREST);Z.bindFramebuffer(_e.READ_FRAMEBUFFER,null),Z.bindFramebuffer(_e.DRAW_FRAMEBUFFER,null)}else if(0!==r||e.isRenderTargetTexture||Q.has(e)){const n=Q.get(e),i=Q.get(t);Z.bindFramebuffer(_e.READ_FRAMEBUFFER,Ve),Z.bindFramebuffer(_e.DRAW_FRAMEBUFFER,Ge);for(let e=0;e<l;e++)S?_e.framebufferTextureLayer(_e.READ_FRAMEBUFFER,_e.COLOR_ATTACHMENT0,n.__webglTexture,r,h+e):_e.framebufferTexture2D(_e.READ_FRAMEBUFFER,_e.COLOR_ATTACHMENT0,_e.TEXTURE_2D,n.__webglTexture,r),M?_e.framebufferTextureLayer(_e.DRAW_FRAMEBUFFER,_e.COLOR_ATTACHMENT0,i.__webglTexture,s,f+e):_e.framebufferTexture2D(_e.DRAW_FRAMEBUFFER,_e.COLOR_ATTACHMENT0,_e.TEXTURE_2D,i.__webglTexture,s),0!==r?_e.blitFramebuffer(c,u,o,a,d,p,o,a,_e.COLOR_BUFFER_BIT,_e.NEAREST):M?_e.copyTexSubImage3D(v,s,d,p,f+e,c,u,o,a):_e.copyTexSubImage2D(v,s,d,p,c,u,o,a);Z.bindFramebuffer(_e.READ_FRAMEBUFFER,null),Z.bindFramebuffer(_e.DRAW_FRAMEBUFFER,null)}else M?e.isDataTexture||e.isData3DTexture?_e.texSubImage3D(v,s,d,p,f,o,a,l,g,y,m.data):t.isCompressedArrayTexture?_e.compressedTexSubImage3D(v,s,d,p,f,o,a,l,g,m.data):_e.texSubImage3D(v,s,d,p,f,o,a,l,g,y,m):e.isDataTexture?_e.texSubImage2D(_e.TEXTURE_2D,s,d,p,o,a,g,y,m.data):e.isCompressedTexture?_e.compressedTexSubImage2D(_e.TEXTURE_2D,s,d,p,m.width,m.height,g,m.data):_e.texSubImage2D(_e.TEXTURE_2D,s,d,p,o,a,g,y,m);_e.pixelStorei(_e.UNPACK_ROW_LENGTH,_),_e.pixelStorei(_e.UNPACK_IMAGE_HEIGHT,x),_e.pixelStorei(_e.UNPACK_SKIP_PIXELS,b),_e.pixelStorei(_e.UNPACK_SKIP_ROWS,w),_e.pixelStorei(_e.UNPACK_SKIP_IMAGES,T),0===s&&t.generateMipmaps&&_e.generateMipmap(v),Z.unbindTexture()},this.copyTextureToTexture3D=function(e,t,n=null,i=null,r=0){return Vc('WebGLRenderer: copyTextureToTexture3D function has been deprecated. Use "copyTextureToTexture" instead.'),this.copyTextureToTexture(e,t,n,i,r)},this.initRenderTarget=function(e){void 0===Q.get(e).__webglFramebuffer&&ee.setupRenderTarget(e)},this.initTexture=function(e){e.isCubeTexture?ee.setTextureCube(e,0):e.isData3DTexture?ee.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?ee.setTexture2DArray(e,0):ee.setTexture2D(e,0),Z.unbindTexture()},this.resetState=function(){b=0,w=0,T=null,Z.reset(),ye.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return gc}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorSpace=Wc._getDrawingBufferColorSpace(e),t.unpackColorSpace=Wc._getUnpackColorSpace()}},Scene:Cd,PerspectiveCamera:xd,Raycaster:uf,SRGBColorSpace:ec,TextureLoader:class extends Op{constructor(e){super(e)}load(e,t,n,i){const r=new tu,s=new Up(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(e,(function(e){r.image=e,r.needsUpdate=!0,void 0!==t&&t(r)}),n,i),r}},Vector2:Nc,Vector3:Dc,Box3:au,Color:Eh,Mesh:ld,SphereGeometry:xp,MeshBasicMaterial:Nh,BackSide:1,Clock:of},UX=B_({props:{width:{default:window.innerWidth,onChange:function(e,t,n){isNaN(e)&&(t.width=n)}},height:{default:window.innerHeight,onChange:function(e,t,n){isNaN(e)&&(t.height=n)}},viewOffset:{default:[0,0]},backgroundColor:{default:"#000011"},backgroundImageUrl:{},onBackgroundImageLoaded:{},showNavInfo:{default:!0},skyRadius:{default:5e4},objects:{default:[]},lights:{default:[]},enablePointerInteraction:{default:!0,onChange:function(e,t){t.hoverObj=null,t.tooltip&&t.tooltip.content(null)},triggerUpdate:!1},pointerRaycasterThrottleMs:{default:50,triggerUpdate:!1},lineHoverPrecision:{default:1,triggerUpdate:!1},pointsHoverPrecision:{default:1,triggerUpdate:!1},hoverOrderComparator:{triggerUpdate:!1},hoverFilter:{default:function(){return!0},triggerUpdate:!1},tooltipContent:{triggerUpdate:!1},hoverDuringDrag:{default:!1,triggerUpdate:!1},clickAfterDrag:{default:!1,triggerUpdate:!1},onHover:{default:function(){},triggerUpdate:!1},onClick:{default:function(){},triggerUpdate:!1},onRightClick:{triggerUpdate:!1}},methods:{tick:function(e){if(e.initialised){e.controls.enabled&&e.controls.update&&e.controls.update(Math.min(1,e.clock.getDelta())),e.postProcessingComposer?e.postProcessingComposer.render():e.renderer.render(e.scene,e.camera),e.extraRenderers.forEach((function(t){return t.render(e.scene,e.camera)}));var t=+new Date;if(e.enablePointerInteraction&&t-e.lastRaycasterCheck>=e.pointerRaycasterThrottleMs){e.lastRaycasterCheck=t;var n=null;if(e.hoverDuringDrag||!e.isPointerDragging){var i=this.intersectingObjects(e.pointerPos.x,e.pointerPos.y);e.hoverOrderComparator&&i.sort((function(t,n){return e.hoverOrderComparator(t.object,n.object)}));var r=i.find((function(t){return e.hoverFilter(t.object)}))||null;n=r?r.object:null,e.intersection=r||null}n!==e.hoverObj&&(e.onHover(n,e.hoverObj,e.intersection),e.tooltip.content(n&&z_(e.tooltipContent)(n,e.intersection)||null),e.hoverObj=n)}e.tweenGroup.update()}return this},getPointerPos:function(e){var t=e.pointerPos;return{x:t.x,y:t.y}},cameraPosition:function(e,t,n,i){var r=e.camera;if(t&&e.initialised){var s=t,o=n||{x:0,y:0,z:0};if(i){var a=Object.assign({},r.position),l=h();e.tweenGroup.add(new bW(a).to(s,i).easing(mW.Quadratic.Out).onUpdate(c).start()),e.tweenGroup.add(new bW(l).to(o,i/3).easing(mW.Quadratic.Out).onUpdate(u).start())}else c(s),u(o);return this}return Object.assign({},r.position,{lookAt:h()});function c(e){var t=e.x,n=e.y,i=e.z;void 0!==t&&(r.position.x=t),void 0!==n&&(r.position.y=n),void 0!==i&&(r.position.z=i)}function u(t){var n=new OX.Vector3(t.x,t.y,t.z);e.controls.target?e.controls.target=n:r.lookAt(n)}function h(){return Object.assign(new OX.Vector3(0,0,-1e3).applyQuaternion(r.quaternion).add(r.position))}},zoomToFit:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,i=arguments.length,r=new Array(i>3?i-3:0),s=3;s<i;s++)r[s-3]=arguments[s];return this.fitToBbox(this.getBbox.apply(this,r),t,n)},fitToBbox:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,r=e.camera;if(t){var s=new OX.Vector3(0,0,0),o=2*Math.max.apply(Math,IX(Object.entries(t).map((function(e){var t=LX(e,2),n=t[0],i=t[1];return Math.max.apply(Math,IX(i.map((function(e){return Math.abs(s[n]-e)}))))})))),a=(1-2*i/e.height)*r.fov,l=o/Math.atan(a*Math.PI/180),c=l/r.aspect,u=Math.max(l,c);if(u>0){var h=s.clone().sub(r.position).normalize().multiplyScalar(-u);this.cameraPosition(h,s,n)}}return this},getBbox:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!0},n=new OX.Box3(new OX.Vector3(0,0,0),new OX.Vector3(0,0,0)),i=e.objects.filter(t);return i.length?(i.forEach((function(e){return n.expandByObject(e)})),Object.assign.apply(Object,IX(["x","y","z"].map((function(e){return DX({},e,[n.min[e],n.max[e]])}))))):null},getScreenCoords:function(e,t,n,i){var r=new OX.Vector3(t,n,i);return r.project(this.camera()),{x:(r.x+1)*e.width/2,y:-(r.y-1)*e.height/2}},getSceneCoords:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=new OX.Vector2(t/e.width*2-1,-n/e.height*2+1),s=new OX.Raycaster;return s.setFromCamera(r,e.camera),Object.assign({},s.ray.at(i,new OX.Vector3))},intersectingObjects:function(e,t,n){var i=new OX.Vector2(t/e.width*2-1,-n/e.height*2+1),r=new OX.Raycaster;return r.params.Line.threshold=e.lineHoverPrecision,r.params.Points.threshold=e.pointsHoverPrecision,r.setFromCamera(i,e.camera),r.intersectObjects(e.objects,!0)},renderer:function(e){return e.renderer},scene:function(e){return e.scene},camera:function(e){return e.camera},postProcessingComposer:function(e){return e.postProcessingComposer},controls:function(e){return e.controls},tbControls:function(e){return e.controls}},stateInit:function(){return{scene:new OX.Scene,camera:new OX.PerspectiveCamera,clock:new OX.Clock,tweenGroup:new yW,lastRaycasterCheck:0}},init:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=n.controlType,r=void 0===i?"trackball":i,s=n.useWebGPU,o=void 0!==s&&s,a=n.rendererConfig,l=void 0===a?{}:a,c=n.extraRenderers,u=void 0===c?[]:c,h=n.waitForLoadComplete,d=void 0===h||h;e.innerHTML="",e.appendChild(t.container=document.createElement("div")),t.container.className="scene-container",t.container.style.position="relative",t.container.appendChild(t.navInfo=document.createElement("div")),t.navInfo.className="scene-nav-info",t.navInfo.textContent={orbit:"Left-click: rotate, Mouse-wheel/middle-click: zoom, Right-click: pan",trackball:"Left-click: rotate, Mouse-wheel/middle-click: zoom, Right-click: pan",fly:"WASD: move, R|F: up | down, Q|E: roll, up|down: pitch, left|right: yaw"}[r]||"",t.navInfo.style.display=t.showNavInfo?null:"none",t.tooltip=new NX(t.container),t.pointerPos=new OX.Vector2,t.pointerPos.x=-2,t.pointerPos.y=-2,["pointermove","pointerdown"].forEach((function(e){return t.container.addEventListener(e,(function(n){if("pointerdown"===e&&(t.isPointerPressed=!0),!t.isPointerDragging&&"pointermove"===n.type&&(n.pressure>0||t.isPointerPressed)&&("touch"!==n.pointerType||void 0===n.movementX||[n.movementX,n.movementY].some((function(e){return Math.abs(e)>1})))&&(t.isPointerDragging=!0),t.enablePointerInteraction){var i=(r=t.container,s=r.getBoundingClientRect(),o=window.pageXOffset||document.documentElement.scrollLeft,a=window.pageYOffset||document.documentElement.scrollTop,{top:s.top+a,left:s.left+o});t.pointerPos.x=n.pageX-i.left,t.pointerPos.y=n.pageY-i.top}var r,s,o,a}),{passive:!0})})),t.container.addEventListener("pointerup",(function(e){t.isPointerPressed&&(t.isPointerPressed=!1,t.isPointerDragging&&(t.isPointerDragging=!1,!t.clickAfterDrag)||requestAnimationFrame((function(){0===e.button&&t.onClick(t.hoverObj||null,e,t.intersection),2===e.button&&t.onRightClick&&t.onRightClick(t.hoverObj||null,e,t.intersection)})))}),{passive:!0,capture:!0}),t.container.addEventListener("contextmenu",(function(e){t.onRightClick&&e.preventDefault()})),t.renderer=new(o?Oj:OX.WebGLRenderer)(Object.assign({antialias:!0,alpha:!0},l)),t.renderer.setPixelRatio(Math.min(2,window.devicePixelRatio)),t.container.appendChild(t.renderer.domElement),t.extraRenderers=u,t.extraRenderers.forEach((function(e){e.domElement.style.position="absolute",e.domElement.style.top="0px",e.domElement.style.pointerEvents="none",t.container.appendChild(e.domElement)})),t.postProcessingComposer=new pW(t.renderer),t.postProcessingComposer.addPass(new fW(t.scene,t.camera)),t.controls=new{trackball:iH,orbit:kH,fly:ZH}[r](t.camera,t.renderer.domElement),"fly"===r&&(t.controls.movementSpeed=300,t.controls.rollSpeed=Math.PI/6,t.controls.dragToLook=!0),"trackball"!==r&&"orbit"!==r||(t.controls.minDistance=.1,t.controls.maxDistance=t.skyRadius,t.controls.addEventListener("start",(function(){t.controlsEngaged=!0})),t.controls.addEventListener("change",(function(){t.controlsEngaged&&(t.controlsDragging=!0)})),t.controls.addEventListener("end",(function(){t.controlsEngaged=!1,t.controlsDragging=!1}))),[t.renderer,t.postProcessingComposer].concat(IX(t.extraRenderers)).forEach((function(e){return e.setSize(t.width,t.height)})),t.camera.aspect=t.width/t.height,t.camera.updateProjectionMatrix(),t.camera.position.z=1e3,t.scene.add(t.skysphere=new OX.Mesh),t.skysphere.visible=!1,t.loadComplete=t.scene.visible=!d,window.scene=t.scene},update:function(e,t){if(e.width&&e.height&&(t.hasOwnProperty("width")||t.hasOwnProperty("height"))){var n,i=e.width,r=e.height;e.container.style.width="".concat(i,"px"),e.container.style.height="".concat(r,"px"),[e.renderer,e.postProcessingComposer].concat(IX(e.extraRenderers)).forEach((function(e){return e.setSize(i,r)})),e.camera.aspect=i/r;var s=e.viewOffset.slice(0,2);s.some((function(e){return e}))&&(n=e.camera).setViewOffset.apply(n,[i,r].concat(IX(s),[i,r])),e.camera.updateProjectionMatrix()}if(t.hasOwnProperty("viewOffset")){var o,a=e.width,l=e.height,c=e.viewOffset.slice(0,2);c.some((function(e){return e}))?(o=e.camera).setViewOffset.apply(o,[a,l].concat(IX(c),[a,l])):e.camera.clearViewOffset()}if(t.hasOwnProperty("skyRadius")&&e.skyRadius&&(e.controls.hasOwnProperty("maxDistance")&&t.skyRadius&&(e.controls.maxDistance=Math.min(e.controls.maxDistance,e.skyRadius)),e.camera.far=2.5*e.skyRadius,e.camera.updateProjectionMatrix(),e.skysphere.geometry=new OX.SphereGeometry(e.skyRadius)),t.hasOwnProperty("backgroundColor")){var u=Jw(e.backgroundColor).alpha;void 0===u&&(u=1),e.renderer.setClearColor(new OX.Color(fT(1,e.backgroundColor)),u)}function h(){e.loadComplete=e.scene.visible=!0}t.hasOwnProperty("backgroundImageUrl")&&(e.backgroundImageUrl?(new OX.TextureLoader).load(e.backgroundImageUrl,(function(t){t.colorSpace=OX.SRGBColorSpace,e.skysphere.material=new OX.MeshBasicMaterial({map:t,side:OX.BackSide}),e.skysphere.visible=!0,e.onBackgroundImageLoaded&&setTimeout(e.onBackgroundImageLoaded),!e.loadComplete&&h()})):(e.skysphere.visible=!1,e.skysphere.material.map=null,!e.loadComplete&&h())),t.hasOwnProperty("showNavInfo")&&(e.navInfo.style.display=e.showNavInfo?null:"none"),t.hasOwnProperty("lights")&&((t.lights||[]).forEach((function(t){return e.scene.remove(t)})),e.lights.forEach((function(t){return e.scene.add(t)}))),t.hasOwnProperty("objects")&&((t.objects||[]).forEach((function(t){return e.scene.remove(t)})),e.objects.forEach((function(t){return e.scene.add(t)})))}});function FX(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function BX(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function zX(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function VX(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?zX(Object(n),!0).forEach((function(t){BX(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):zX(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function GX(e){return function(e){if(Array.isArray(e))return FX(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return FX(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?FX(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function jX(e,t){var n=new t;return n._destructor&&n._destructor(),{linkProp:function(t){return{default:n[t](),onChange:function(n,i){i[e][t](n)},triggerUpdate:!1}},linkMethod:function(t){return function(n){for(var i=n[e],r=arguments.length,s=new Array(r>1?r-1:0),o=1;o<r;o++)s[o-1]=arguments[o];var a=i[t].apply(i,s);return a===i?this:a}}}}!function(e,t){void 0===t&&(t={});var n=t.insertAt;if("undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===n&&i.firstChild?i.insertBefore(r,i.firstChild):i.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}(".graph-info-msg {\n  top: 50%;\n  width: 100%;\n  text-align: center;\n  color: lavender;\n  opacity: 0.7;\n  font-size: 22px;\n  position: absolute;\n  font-family: Sans-serif;\n}\n\n.scene-container .clickable {\n  cursor: pointer;\n}\n\n.scene-container .grabbable {\n  cursor: move;\n  cursor: grab;\n  cursor: -moz-grab;\n  cursor: -webkit-grab;\n}\n\n.scene-container .grabbable:active {\n  cursor: grabbing;\n  cursor: -moz-grabbing;\n  cursor: -webkit-grabbing;\n}");var HX=window.THREE?window.THREE:{AmbientLight:ef,DirectionalLight:Qp,REVISION:na},WX=jX("forceGraph",Cw),qX=Object.assign.apply(Object,GX(["jsonUrl","graphData","numDimensions","dagMode","dagLevelDistance","dagNodeFilter","onDagError","nodeRelSize","nodeId","nodeVal","nodeResolution","nodeColor","nodeAutoColorBy","nodeOpacity","nodeVisibility","nodeThreeObject","nodeThreeObjectExtend","nodePositionUpdate","linkSource","linkTarget","linkVisibility","linkColor","linkAutoColorBy","linkOpacity","linkWidth","linkResolution","linkCurvature","linkCurveRotation","linkMaterial","linkThreeObject","linkThreeObjectExtend","linkPositionUpdate","linkDirectionalArrowLength","linkDirectionalArrowColor","linkDirectionalArrowRelPos","linkDirectionalArrowResolution","linkDirectionalParticles","linkDirectionalParticleSpeed","linkDirectionalParticleWidth","linkDirectionalParticleColor","linkDirectionalParticleResolution","forceEngine","d3AlphaDecay","d3VelocityDecay","d3AlphaMin","ngraphPhysics","warmupTicks","cooldownTicks","cooldownTime","onEngineTick","onEngineStop"].map((function(e){return BX({},e,WX.linkProp(e))})))),XX=Object.assign.apply(Object,GX(["refresh","getGraphBbox","d3Force","d3ReheatSimulation","emitParticle"].map((function(e){return BX({},e,WX.linkMethod(e))})))),$X=jX("renderObjs",UX),YX=Object.assign.apply(Object,GX(["width","height","backgroundColor","showNavInfo","enablePointerInteraction"].map((function(e){return BX({},e,$X.linkProp(e))})))),KX=Object.assign.apply(Object,GX(["lights","cameraPosition","postProcessingComposer"].map((function(e){return BX({},e,$X.linkMethod(e))}))).concat([{graph2ScreenCoords:$X.linkMethod("getScreenCoords"),screen2GraphCoords:$X.linkMethod("getSceneCoords")}])),ZX=B_({props:VX(VX({nodeLabel:{default:"name",triggerUpdate:!1},linkLabel:{default:"name",triggerUpdate:!1},linkHoverPrecision:{default:1,onChange:function(e,t){return t.renderObjs.lineHoverPrecision(e)},triggerUpdate:!1},enableNavigationControls:{default:!0,onChange:function(e,t){var n=t.renderObjs.controls();n&&(n.enabled=e,e&&n.domElement&&n.domElement.dispatchEvent(new PointerEvent("pointerup")))},triggerUpdate:!1},enableNodeDrag:{default:!0,triggerUpdate:!1},onNodeDrag:{default:function(){},triggerUpdate:!1},onNodeDragEnd:{default:function(){},triggerUpdate:!1},onNodeClick:{triggerUpdate:!1},onNodeRightClick:{triggerUpdate:!1},onNodeHover:{triggerUpdate:!1},onLinkClick:{triggerUpdate:!1},onLinkRightClick:{triggerUpdate:!1},onLinkHover:{triggerUpdate:!1},onBackgroundClick:{triggerUpdate:!1},onBackgroundRightClick:{triggerUpdate:!1}},qX),YX),methods:VX(VX({zoomToFit:function(e,t,n){for(var i,r=arguments.length,s=new Array(r>3?r-3:0),o=3;o<r;o++)s[o-3]=arguments[o];return e.renderObjs.fitToBbox((i=e.forceGraph).getGraphBbox.apply(i,s),t,n),this},pauseAnimation:function(e){return null!==e.animationFrameRequestId&&(cancelAnimationFrame(e.animationFrameRequestId),e.animationFrameRequestId=null),this},resumeAnimation:function(e){return null===e.animationFrameRequestId&&this._animationCycle(),this},_animationCycle:function(e){e.enablePointerInteraction&&(this.renderer().domElement.style.cursor=null),e.forceGraph.tickFrame(),e.renderObjs.tick(),e.animationFrameRequestId=requestAnimationFrame(this._animationCycle)},scene:function(e){return e.renderObjs.scene()},camera:function(e){return e.renderObjs.camera()},renderer:function(e){return e.renderObjs.renderer()},controls:function(e){return e.renderObjs.controls()},tbControls:function(e){return e.renderObjs.tbControls()},_destructor:function(){this.pauseAnimation(),this.graphData({nodes:[],links:[]})}},XX),KX),stateInit:function(e){var t=e.controlType,n=e.rendererConfig,i=e.extraRenderers,r=new Cw;return{forceGraph:r,renderObjs:UX({controlType:t,rendererConfig:n,extraRenderers:i}).objects([r]).lights([new HX.AmbientLight(13421772,Math.PI),new HX.DirectionalLight(16777215,.6*Math.PI)])}},init:function(e,t){e.innerHTML="",e.appendChild(t.container=document.createElement("div")),t.container.style.position="relative";var n=document.createElement("div");t.container.appendChild(n),t.renderObjs(n);var i,r=t.renderObjs.camera(),s=t.renderObjs.renderer(),o=t.renderObjs.controls();o.enabled=!!t.enableNavigationControls,t.lastSetCameraZ=r.position.z,t.container.appendChild(i=document.createElement("div")),i.className="graph-info-msg",i.textContent="",t.forceGraph.onLoading((function(){i.textContent="Loading..."})).onFinishLoading((function(){i.textContent=""})).onUpdate((function(){t.graphData=t.forceGraph.graphData(),0===r.position.x&&0===r.position.y&&r.position.z===t.lastSetCameraZ&&t.graphData.nodes.length&&(r.lookAt(t.forceGraph.position),t.lastSetCameraZ=r.position.z=170*Math.cbrt(t.graphData.nodes.length))})).onFinishUpdate((function(){if(t._dragControls){var e=t.graphData.nodes.find((function(e){return e.__initialFixedPos&&!e.__disposeControlsAfterDrag}));e?e.__disposeControlsAfterDrag=!0:t._dragControls.dispose(),t._dragControls=void 0}if(t.enableNodeDrag&&t.enablePointerInteraction&&"d3"===t.forceEngine){var n=t._dragControls=new ES(t.graphData.nodes.map((function(e){return e.__threeObj})).filter((function(e){return e})),r,s.domElement);n.addEventListener("dragstart",(function(e){var t=JX(e.object);if(t){o.enabled=!1,e.object.__initialPos=e.object.position.clone(),e.object.__prevPos=e.object.position.clone();var n=t.__data;!n.__initialFixedPos&&(n.__initialFixedPos={fx:n.fx,fy:n.fy,fz:n.fz}),!n.__initialPos&&(n.__initialPos={x:n.x,y:n.y,z:n.z}),["x","y","z"].forEach((function(e){return n["f".concat(e)]=n[e]})),s.domElement.classList.add("grabbable")}})),n.addEventListener("drag",(function(e){var n=JX(e.object);if(n){if(!e.object.hasOwnProperty("__graphObjType")){var i=e.object.__initialPos,r=e.object.__prevPos,s=e.object.position;n.position.add(s.clone().sub(r)),r.copy(s),s.copy(i)}var o=n.__data,a=n.position,l={x:a.x-o.x,y:a.y-o.y,z:a.z-o.z};["x","y","z"].forEach((function(e){return o["f".concat(e)]=o[e]=a[e]})),t.forceGraph.d3AlphaTarget(.3).resetCountdown(),o.__dragged=!0,t.onNodeDrag(o,l)}})),n.addEventListener("dragend",(function(e){var i=JX(e.object);if(i){delete e.object.__initialPos,delete e.object.__prevPos;var r=i.__data;r.__disposeControlsAfterDrag&&(n.dispose(),delete r.__disposeControlsAfterDrag);var a=r.__initialFixedPos,l=r.__initialPos,c={x:l.x-r.x,y:l.y-r.y,z:l.z-r.z};a&&(["x","y","z"].forEach((function(e){var t="f".concat(e);void 0===a[t]&&delete r[t]})),delete r.__initialFixedPos,delete r.__initialPos,r.__dragged&&(delete r.__dragged,t.onNodeDragEnd(r,c))),t.forceGraph.d3AlphaTarget(0).resetCountdown(),t.enableNavigationControls&&(o.enabled=!0,o.domElement&&o.domElement.ownerDocument&&o.domElement.ownerDocument.dispatchEvent(new PointerEvent("pointerup",{pointerType:"touch"}))),s.domElement.classList.remove("grabbable")}}))}})),HX.REVISION<155&&(t.renderObjs.renderer().useLegacyLights=!1),t.renderObjs.hoverOrderComparator((function(e,t){var n=JX(e);if(!n)return 1;var i=JX(t);if(!i)return-1;var r=function(e){return"node"===e.__graphObjType};return r(i)-r(n)})).tooltipContent((function(e){var n=JX(e);return n&&z_(t["".concat(n.__graphObjType,"Label")])(n.__data)||""})).hoverDuringDrag(!1).onHover((function(e){var n=JX(e);if(n!==t.hoverObj){var i=t.hoverObj?t.hoverObj.__graphObjType:null,r=t.hoverObj?t.hoverObj.__data:null,o=n?n.__graphObjType:null,a=n?n.__data:null;if(i&&i!==o){var l=t["on".concat("node"===i?"Node":"Link","Hover")];l&&l(null,r)}if(o){var c=t["on".concat("node"===o?"Node":"Link","Hover")];c&&c(a,i===o?r:null)}s.domElement.classList[n&&t["on".concat("node"===o?"Node":"Link","Click")]||!n&&t.onBackgroundClick?"add":"remove"]("clickable"),t.hoverObj=n}})).clickAfterDrag(!1).onClick((function(e,n){var i=JX(e);if(i){var r=t["on".concat("node"===i.__graphObjType?"Node":"Link","Click")];r&&r(i.__data,n)}else t.onBackgroundClick&&t.onBackgroundClick(n)})).onRightClick((function(e,n){var i=JX(e);if(i){var r=t["on".concat("node"===i.__graphObjType?"Node":"Link","RightClick")];r&&r(i.__data,n)}else t.onBackgroundRightClick&&t.onBackgroundRightClick(n)})),this._animationCycle()}});function JX(e){for(var t=e;t&&!t.hasOwnProperty("__graphObjType");)t=t.parent;return t}const QX=d(ZX,{methodNames:["emitParticle","d3Force","d3ReheatSimulation","stopAnimation","pauseAnimation","resumeAnimation","cameraPosition","zoomToFit","getGraphBbox","screen2GraphCoords","graph2ScreenCoords","postProcessingComposer","lights","scene","camera","renderer","controls","refresh"],initPropNames:["controlType","rendererConfig","extraRenderers"]});QX.displayName="ForceGraph3D",QX.propTypes=ZT;const e$={passive:!1},t$={capture:!0,passive:!1};function n$(e){e.stopImmediatePropagation()}function i$(e){e.preventDefault(),e.stopImmediatePropagation()}function r$(e){var t=e.document.documentElement,n=kq(e).on("dragstart.drag",i$,t$);"onselectstart"in t?n.on("selectstart.drag",i$,t$):(t.__noselect=t.style.MozUserSelect,t.style.MozUserSelect="none")}function s$(e,t){var n=e.document.documentElement,i=kq(e).on("dragstart.drag",null);t&&(i.on("click.drag",i$,t$),setTimeout((function(){i.on("click.drag",null)}),0)),"onselectstart"in n?i.on("selectstart.drag",null):(n.style.MozUserSelect=n.__noselect,delete n.__noselect)}var o$=e=>()=>e;function a$(e,{sourceEvent:t,subject:n,target:i,identifier:r,active:s,x:o,y:a,dx:l,dy:c,dispatch:u}){Object.defineProperties(this,{type:{value:e,enumerable:!0,configurable:!0},sourceEvent:{value:t,enumerable:!0,configurable:!0},subject:{value:n,enumerable:!0,configurable:!0},target:{value:i,enumerable:!0,configurable:!0},identifier:{value:r,enumerable:!0,configurable:!0},active:{value:s,enumerable:!0,configurable:!0},x:{value:o,enumerable:!0,configurable:!0},y:{value:a,enumerable:!0,configurable:!0},dx:{value:l,enumerable:!0,configurable:!0},dy:{value:c,enumerable:!0,configurable:!0},_:{value:u}})}function l$(e){return!e.ctrlKey&&!e.button}function c$(){return this.parentNode}function u$(e,t){return null==t?{x:e.x,y:e.y}:t}function h$(){return navigator.maxTouchPoints||"ontouchstart"in this}a$.prototype.on=function(){var e=this._.on.apply(this._,arguments);return e===this._?this:e};var d$=Ky("start","end","cancel","interrupt"),p$=[];function f$(e,t,n,i,r,s){var o=e.__transition;if(o){if(n in o)return}else e.__transition={};!function(e,t,n){var i,r=e.__transition;function s(e){n.state=1,n.timer.restart(o,n.delay,n.time),n.delay<=e&&o(e-n.delay)}function o(s){var c,u,h,d;if(1!==n.state)return l();for(c in r)if((d=r[c]).name===n.name){if(3===d.state)return yv(o);4===d.state?(d.state=6,d.timer.stop(),d.on.call("interrupt",e,e.__data__,d.index,d.group),delete r[c]):+c<t&&(d.state=6,d.timer.stop(),d.on.call("cancel",e,e.__data__,d.index,d.group),delete r[c])}if(yv((function(){3===n.state&&(n.state=4,n.timer.restart(a,n.delay,n.time),a(s))})),n.state=2,n.on.call("start",e,e.__data__,n.index,n.group),2===n.state){for(n.state=3,i=new Array(h=n.tween.length),c=0,u=-1;c<h;++c)(d=n.tween[c].value.call(e,e.__data__,n.index,n.group))&&(i[++u]=d);i.length=u+1}}function a(t){for(var r=t<n.duration?n.ease.call(null,t/n.duration):(n.timer.restart(l),n.state=5,1),s=-1,o=i.length;++s<o;)i[s].call(e,r);5===n.state&&(n.on.call("end",e,e.__data__,n.index,n.group),l())}function l(){for(var i in n.state=6,n.timer.stop(),delete r[t],r)return;delete e.__transition}r[t]=n,n.timer=pv(s,0,n.time)}(e,n,{name:t,index:i,group:r,on:d$,tween:p$,time:s.time,delay:s.delay,duration:s.duration,ease:s.ease,timer:null,state:0})}function m$(e,t){var n=y$(e,t);if(n.state>0)throw new Error("too late; already scheduled");return n}function g$(e,t){var n=y$(e,t);if(n.state>3)throw new Error("too late; already running");return n}function y$(e,t){var n=e.__transition;if(!n||!(n=n[t]))throw new Error("transition not found");return n}function v$(e,t){var n,i,r,s=e.__transition,o=!0;if(s){for(r in t=null==t?null:t+"",s)(n=s[r]).name===t?(i=n.state>2&&n.state<5,n.state=6,n.timer.stop(),n.on.call(i?"interrupt":"cancel",e,e.__data__,n.index,n.group),delete s[r]):o=!1;o&&delete e.__transition}}function _$(e,t){var n,i;return function(){var r=g$(this,e),s=r.tween;if(s!==n)for(var o=0,a=(i=n=s).length;o<a;++o)if(i[o].name===t){(i=i.slice()).splice(o,1);break}r.tween=i}}function x$(e,t,n){var i,r;if("function"!=typeof n)throw new Error;return function(){var s=g$(this,e),o=s.tween;if(o!==i){r=(i=o).slice();for(var a={name:t,value:n},l=0,c=r.length;l<c;++l)if(r[l].name===t){r[l]=a;break}l===c&&r.push(a)}s.tween=r}}function b$(e,t,n){var i=e._id;return e.each((function(){var e=g$(this,i);(e.value||(e.value={}))[t]=n.apply(this,arguments)})),function(e){return y$(e,i).value[t]}}function w$(e,t){var n;return("number"==typeof t?Kx:t instanceof Nx?Yx:(n=Nx(t))?(t=n,Yx):Qx)(e,t)}function T$(e){return function(){this.removeAttribute(e)}}function S$(e){return function(){this.removeAttributeNS(e.space,e.local)}}function M$(e,t,n){var i,r,s=n+"";return function(){var o=this.getAttribute(e);return o===s?null:o===i?r:r=t(i=o,n)}}function E$(e,t,n){var i,r,s=n+"";return function(){var o=this.getAttributeNS(e.space,e.local);return o===s?null:o===i?r:r=t(i=o,n)}}function A$(e,t,n){var i,r,s;return function(){var o,a,l=n(this);if(null!=l)return(o=this.getAttribute(e))===(a=l+"")?null:o===i&&a===r?s:(r=a,s=t(i=o,l));this.removeAttribute(e)}}function C$(e,t,n){var i,r,s;return function(){var o,a,l=n(this);if(null!=l)return(o=this.getAttributeNS(e.space,e.local))===(a=l+"")?null:o===i&&a===r?s:(r=a,s=t(i=o,l));this.removeAttributeNS(e.space,e.local)}}function R$(e,t){var n,i;function r(){var r=t.apply(this,arguments);return r!==i&&(n=(i=r)&&function(e,t){return function(n){this.setAttributeNS(e.space,e.local,t.call(this,n))}}(e,r)),n}return r._value=t,r}function N$(e,t){var n,i;function r(){var r=t.apply(this,arguments);return r!==i&&(n=(i=r)&&function(e,t){return function(n){this.setAttribute(e,t.call(this,n))}}(e,r)),n}return r._value=t,r}function P$(e,t){return function(){m$(this,e).delay=+t.apply(this,arguments)}}function D$(e,t){return t=+t,function(){m$(this,e).delay=t}}function L$(e,t){return function(){g$(this,e).duration=+t.apply(this,arguments)}}function I$(e,t){return t=+t,function(){g$(this,e).duration=t}}var k$=Iq.prototype.constructor;function O$(e){return function(){this.style.removeProperty(e)}}var U$=0;function F$(e,t,n,i){this._groups=e,this._parents=t,this._name=n,this._id=i}function B$(){return++U$}var z$=Iq.prototype;F$.prototype={constructor:F$,select:function(e){var t=this._name,n=this._id;"function"!=typeof e&&(e=NW(e));for(var i=this._groups,r=i.length,s=new Array(r),o=0;o<r;++o)for(var a,l,c=i[o],u=c.length,h=s[o]=new Array(u),d=0;d<u;++d)(a=c[d])&&(l=e.call(a,a.__data__,d,c))&&("__data__"in a&&(l.__data__=a.__data__),h[d]=l,f$(h[d],t,n,d,h,y$(a,n)));return new F$(s,this._parents,t,n)},selectAll:function(e){var t=this._name,n=this._id;"function"!=typeof e&&(e=DW(e));for(var i=this._groups,r=i.length,s=[],o=[],a=0;a<r;++a)for(var l,c=i[a],u=c.length,h=0;h<u;++h)if(l=c[h]){for(var d,p=e.call(l,l.__data__,h,c),f=y$(l,n),m=0,g=p.length;m<g;++m)(d=p[m])&&f$(d,t,n,m,p,f);s.push(p),o.push(l)}return new F$(s,o,t,n)},selectChild:z$.selectChild,selectChildren:z$.selectChildren,filter:function(e){"function"!=typeof e&&(e=IW(e));for(var t=this._groups,n=t.length,i=new Array(n),r=0;r<n;++r)for(var s,o=t[r],a=o.length,l=i[r]=[],c=0;c<a;++c)(s=o[c])&&e.call(s,s.__data__,c,o)&&l.push(s);return new F$(i,this._parents,this._name,this._id)},merge:function(e){if(e._id!==this._id)throw new Error;for(var t=this._groups,n=e._groups,i=t.length,r=n.length,s=Math.min(i,r),o=new Array(i),a=0;a<s;++a)for(var l,c=t[a],u=n[a],h=c.length,d=o[a]=new Array(h),p=0;p<h;++p)(l=c[p]||u[p])&&(d[p]=l);for(;a<i;++a)o[a]=t[a];return new F$(o,this._parents,this._name,this._id)},selection:function(){return new k$(this._groups,this._parents)},transition:function(){for(var e=this._name,t=this._id,n=B$(),i=this._groups,r=i.length,s=0;s<r;++s)for(var o,a=i[s],l=a.length,c=0;c<l;++c)if(o=a[c]){var u=y$(o,t);f$(o,e,n,c,a,{time:u.time+u.delay+u.duration,delay:0,duration:u.duration,ease:u.ease})}return new F$(i,this._parents,e,n)},call:z$.call,nodes:z$.nodes,node:z$.node,size:z$.size,empty:z$.empty,each:z$.each,on:function(e,t){var n=this._id;return arguments.length<2?y$(this.node(),n).on.on(e):this.each(function(e,t,n){var i,r,s=function(e){return(e+"").trim().split(/^|\s+/).every((function(e){var t=e.indexOf(".");return t>=0&&(e=e.slice(0,t)),!e||"start"===e}))}(t)?m$:g$;return function(){var o=s(this,e),a=o.on;a!==i&&(r=(i=a).copy()).on(t,n),o.on=r}}(n,e,t))},attr:function(e,t){var n=MW(e),i="transform"===n?ob:w$;return this.attrTween(e,"function"==typeof t?(n.local?C$:A$)(n,i,b$(this,"attr."+e,t)):null==t?(n.local?S$:T$)(n):(n.local?E$:M$)(n,i,t))},attrTween:function(e,t){var n="attr."+e;if(arguments.length<2)return(n=this.tween(n))&&n._value;if(null==t)return this.tween(n,null);if("function"!=typeof t)throw new Error;var i=MW(e);return this.tween(n,(i.local?R$:N$)(i,t))},style:function(e,t,n){var i="transform"==(e+="")?sb:w$;return null==t?this.styleTween(e,function(e,t){var n,i,r;return function(){var s=iq(this,e),o=(this.style.removeProperty(e),iq(this,e));return s===o?null:s===n&&o===i?r:r=t(n=s,i=o)}}(e,i)).on("end.style."+e,O$(e)):"function"==typeof t?this.styleTween(e,function(e,t,n){var i,r,s;return function(){var o=iq(this,e),a=n(this),l=a+"";return null==a&&(this.style.removeProperty(e),l=a=iq(this,e)),o===l?null:o===i&&l===r?s:(r=l,s=t(i=o,a))}}(e,i,b$(this,"style."+e,t))).each(function(e,t){var n,i,r,s,o="style."+t,a="end."+o;return function(){var l=g$(this,e),c=l.on,u=null==l.value[o]?s||(s=O$(t)):void 0;c===n&&r===u||(i=(n=c).copy()).on(a,r=u),l.on=i}}(this._id,e)):this.styleTween(e,function(e,t,n){var i,r,s=n+"";return function(){var o=iq(this,e);return o===s?null:o===i?r:r=t(i=o,n)}}(e,i,t),n).on("end.style."+e,null)},styleTween:function(e,t,n){var i="style."+(e+="");if(arguments.length<2)return(i=this.tween(i))&&i._value;if(null==t)return this.tween(i,null);if("function"!=typeof t)throw new Error;return this.tween(i,function(e,t,n){var i,r;function s(){var s=t.apply(this,arguments);return s!==r&&(i=(r=s)&&function(e,t,n){return function(i){this.style.setProperty(e,t.call(this,i),n)}}(e,s,n)),i}return s._value=t,s}(e,t,null==n?"":n))},text:function(e){return this.tween("text","function"==typeof e?function(e){return function(){var t=e(this);this.textContent=null==t?"":t}}(b$(this,"text",e)):function(e){return function(){this.textContent=e}}(null==e?"":e+""))},textTween:function(e){var t="text";if(arguments.length<1)return(t=this.tween(t))&&t._value;if(null==e)return this.tween(t,null);if("function"!=typeof e)throw new Error;return this.tween(t,function(e){var t,n;function i(){var i=e.apply(this,arguments);return i!==n&&(t=(n=i)&&function(e){return function(t){this.textContent=e.call(this,t)}}(i)),t}return i._value=e,i}(e))},remove:function(){return this.on("end.remove",function(e){return function(){var t=this.parentNode;for(var n in this.__transition)if(+n!==e)return;t&&t.removeChild(this)}}(this._id))},tween:function(e,t){var n=this._id;if(e+="",arguments.length<2){for(var i,r=y$(this.node(),n).tween,s=0,o=r.length;s<o;++s)if((i=r[s]).name===e)return i.value;return null}return this.each((null==t?_$:x$)(n,e,t))},delay:function(e){var t=this._id;return arguments.length?this.each(("function"==typeof e?P$:D$)(t,e)):y$(this.node(),t).delay},duration:function(e){var t=this._id;return arguments.length?this.each(("function"==typeof e?L$:I$)(t,e)):y$(this.node(),t).duration},ease:function(e){var t=this._id;return arguments.length?this.each(function(e,t){if("function"!=typeof t)throw new Error;return function(){g$(this,e).ease=t}}(t,e)):y$(this.node(),t).ease},easeVarying:function(e){if("function"!=typeof e)throw new Error;return this.each(function(e,t){return function(){var n=t.apply(this,arguments);if("function"!=typeof n)throw new Error;g$(this,e).ease=n}}(this._id,e))},end:function(){var e,t,n=this,i=n._id,r=n.size();return new Promise((function(s,o){var a={value:o},l={value:function(){0===--r&&s()}};n.each((function(){var n=g$(this,i),r=n.on;r!==e&&((t=(e=r).copy())._.cancel.push(a),t._.interrupt.push(a),t._.end.push(l)),n.on=t})),0===r&&s()}))},[Symbol.iterator]:z$[Symbol.iterator]};var V$={time:null,delay:0,duration:250,ease:function(e){return((e*=2)<=1?e*e*e:(e-=2)*e*e+2)/2}};function G$(e,t){for(var n;!(n=e.__transition)||!(n=n[t]);)if(!(e=e.parentNode))throw new Error(`transition ${t} not found`);return n}Iq.prototype.interrupt=function(e){return this.each((function(){v$(this,e)}))},Iq.prototype.transition=function(e){var t,n;e instanceof F$?(t=e._id,e=e._name):(t=B$(),(n=V$).time=uv(),e=null==e?null:e+"");for(var i=this._groups,r=i.length,s=0;s<r;++s)for(var o,a=i[s],l=a.length,c=0;c<l;++c)(o=a[c])&&f$(o,e,t,c,a,n||G$(o,t));return new F$(i,this._parents,e,t)};var j$=e=>()=>e;function H$(e,{sourceEvent:t,target:n,transform:i,dispatch:r}){Object.defineProperties(this,{type:{value:e,enumerable:!0,configurable:!0},sourceEvent:{value:t,enumerable:!0,configurable:!0},target:{value:n,enumerable:!0,configurable:!0},transform:{value:i,enumerable:!0,configurable:!0},_:{value:r}})}function W$(e,t,n){this.k=e,this.x=t,this.y=n}W$.prototype={constructor:W$,scale:function(e){return 1===e?this:new W$(this.k*e,this.x,this.y)},translate:function(e,t){return 0===e&0===t?this:new W$(this.k,this.x+this.k*e,this.y+this.k*t)},apply:function(e){return[e[0]*this.k+this.x,e[1]*this.k+this.y]},applyX:function(e){return e*this.k+this.x},applyY:function(e){return e*this.k+this.y},invert:function(e){return[(e[0]-this.x)/this.k,(e[1]-this.y)/this.k]},invertX:function(e){return(e-this.x)/this.k},invertY:function(e){return(e-this.y)/this.k},rescaleX:function(e){return e.copy().domain(e.range().map(this.invertX,this).map(e.invert,e))},rescaleY:function(e){return e.copy().domain(e.range().map(this.invertY,this).map(e.invert,e))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var q$=new W$(1,0,0);function X$(e){for(;!e.__zoom;)if(!(e=e.parentNode))return q$;return e.__zoom}function $$(e){e.stopImmediatePropagation()}function Y$(e){e.preventDefault(),e.stopImmediatePropagation()}function K$(e){return!(e.ctrlKey&&"wheel"!==e.type||e.button)}function Z$(){var e=this;return e instanceof SVGElement?(e=e.ownerSVGElement||e).hasAttribute("viewBox")?[[(e=e.viewBox.baseVal).x,e.y],[e.x+e.width,e.y+e.height]]:[[0,0],[e.width.baseVal.value,e.height.baseVal.value]]:[[0,0],[e.clientWidth,e.clientHeight]]}function J$(){return this.__zoom||q$}function Q$(e){return-e.deltaY*(1===e.deltaMode?.05:e.deltaMode?1:.002)*(e.ctrlKey?10:1)}function eY(){return navigator.maxTouchPoints||"ontouchstart"in this}function tY(e,t,n){var i=e.invertX(t[0][0])-n[0][0],r=e.invertX(t[1][0])-n[1][0],s=e.invertY(t[0][1])-n[0][1],o=e.invertY(t[1][1])-n[1][1];return e.translate(r>i?(i+r)/2:Math.min(0,i)||Math.max(0,r),o>s?(s+o)/2:Math.min(0,s)||Math.max(0,o))}function nY(){var e,t,n,i=K$,r=Z$,s=tY,o=Q$,a=eY,l=[0,1/0],c=[[-1/0,-1/0],[1/0,1/0]],u=250,h=lb,d=Ky("start","zoom","end"),p=0,f=10;function m(e){e.property("__zoom",J$).on("wheel.zoom",w,{passive:!1}).on("mousedown.zoom",T).on("dblclick.zoom",S).filter(a).on("touchstart.zoom",M).on("touchmove.zoom",E).on("touchend.zoom touchcancel.zoom",A).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function g(e,t){return(t=Math.max(l[0],Math.min(l[1],t)))===e.k?e:new W$(t,e.x,e.y)}function y(e,t,n){var i=t[0]-n[0]*e.k,r=t[1]-n[1]*e.k;return i===e.x&&r===e.y?e:new W$(e.k,i,r)}function v(e){return[(+e[0][0]+ +e[1][0])/2,(+e[0][1]+ +e[1][1])/2]}function _(e,t,n,i){e.on("start.zoom",(function(){x(this,arguments).event(i).start()})).on("interrupt.zoom end.zoom",(function(){x(this,arguments).event(i).end()})).tween("zoom",(function(){var e=this,s=arguments,o=x(e,s).event(i),a=r.apply(e,s),l=null==n?v(a):"function"==typeof n?n.apply(e,s):n,c=Math.max(a[1][0]-a[0][0],a[1][1]-a[0][1]),u=e.__zoom,d="function"==typeof t?t.apply(e,s):t,p=h(u.invert(l).concat(c/u.k),d.invert(l).concat(c/d.k));return function(e){if(1===e)e=d;else{var t=p(e),n=c/t[2];e=new W$(n,l[0]-t[0]*n,l[1]-t[1]*n)}o.zoom(null,e)}}))}function x(e,t,n){return!n&&e.__zooming||new b(e,t)}function b(e,t){this.that=e,this.args=t,this.active=0,this.sourceEvent=null,this.extent=r.apply(e,t),this.taps=0}function w(e,...t){if(i.apply(this,arguments)){var n=x(this,t).event(e),r=this.__zoom,a=Math.max(l[0],Math.min(l[1],r.k*Math.pow(2,o.apply(this,arguments)))),u=Oq(e);if(n.wheel)n.mouse[0][0]===u[0]&&n.mouse[0][1]===u[1]||(n.mouse[1]=r.invert(n.mouse[0]=u)),clearTimeout(n.wheel);else{if(r.k===a)return;n.mouse=[u,r.invert(u)],v$(this),n.start()}Y$(e),n.wheel=setTimeout((function(){n.wheel=null,n.end()}),150),n.zoom("mouse",s(y(g(r,a),n.mouse[0],n.mouse[1]),n.extent,c))}}function T(e,...t){if(!n&&i.apply(this,arguments)){var r=e.currentTarget,o=x(this,t,!0).event(e),a=kq(e.view).on("mousemove.zoom",(function(e){if(Y$(e),!o.moved){var t=e.clientX-u,n=e.clientY-h;o.moved=t*t+n*n>p}o.event(e).zoom("mouse",s(y(o.that.__zoom,o.mouse[0]=Oq(e,r),o.mouse[1]),o.extent,c))}),!0).on("mouseup.zoom",(function(e){a.on("mousemove.zoom mouseup.zoom",null),s$(e.view,o.moved),Y$(e),o.event(e).end()}),!0),l=Oq(e,r),u=e.clientX,h=e.clientY;r$(e.view),$$(e),o.mouse=[l,this.__zoom.invert(l)],v$(this),o.start()}}function S(e,...t){if(i.apply(this,arguments)){var n=this.__zoom,o=Oq(e.changedTouches?e.changedTouches[0]:e,this),a=n.invert(o),l=n.k*(e.shiftKey?.5:2),h=s(y(g(n,l),o,a),r.apply(this,t),c);Y$(e),u>0?kq(this).transition().duration(u).call(_,h,o,e):kq(this).call(m.transform,h,o,e)}}function M(n,...r){if(i.apply(this,arguments)){var s,o,a,l,c=n.touches,u=c.length,h=x(this,r,n.changedTouches.length===u).event(n);for($$(n),o=0;o<u;++o)l=[l=Oq(a=c[o],this),this.__zoom.invert(l),a.identifier],h.touch0?h.touch1||h.touch0[2]===l[2]||(h.touch1=l,h.taps=0):(h.touch0=l,s=!0,h.taps=1+!!e);e&&(e=clearTimeout(e)),s&&(h.taps<2&&(t=l[0],e=setTimeout((function(){e=null}),500)),v$(this),h.start())}}function E(e,...t){if(this.__zooming){var n,i,r,o,a=x(this,t).event(e),l=e.changedTouches,u=l.length;for(Y$(e),n=0;n<u;++n)r=Oq(i=l[n],this),a.touch0&&a.touch0[2]===i.identifier?a.touch0[0]=r:a.touch1&&a.touch1[2]===i.identifier&&(a.touch1[0]=r);if(i=a.that.__zoom,a.touch1){var h=a.touch0[0],d=a.touch0[1],p=a.touch1[0],f=a.touch1[1],m=(m=p[0]-h[0])*m+(m=p[1]-h[1])*m,v=(v=f[0]-d[0])*v+(v=f[1]-d[1])*v;i=g(i,Math.sqrt(m/v)),r=[(h[0]+p[0])/2,(h[1]+p[1])/2],o=[(d[0]+f[0])/2,(d[1]+f[1])/2]}else{if(!a.touch0)return;r=a.touch0[0],o=a.touch0[1]}a.zoom("touch",s(y(i,r,o),a.extent,c))}}function A(e,...i){if(this.__zooming){var r,s,o=x(this,i).event(e),a=e.changedTouches,l=a.length;for($$(e),n&&clearTimeout(n),n=setTimeout((function(){n=null}),500),r=0;r<l;++r)s=a[r],o.touch0&&o.touch0[2]===s.identifier?delete o.touch0:o.touch1&&o.touch1[2]===s.identifier&&delete o.touch1;if(o.touch1&&!o.touch0&&(o.touch0=o.touch1,delete o.touch1),o.touch0)o.touch0[1]=this.__zoom.invert(o.touch0[0]);else if(o.end(),2===o.taps&&(s=Oq(s,this),Math.hypot(t[0]-s[0],t[1]-s[1])<f)){var c=kq(this).on("dblclick.zoom");c&&c.apply(this,arguments)}}}return m.transform=function(e,t,n,i){var r=e.selection?e.selection():e;r.property("__zoom",J$),e!==r?_(e,t,n,i):r.interrupt().each((function(){x(this,arguments).event(i).start().zoom(null,"function"==typeof t?t.apply(this,arguments):t).end()}))},m.scaleBy=function(e,t,n,i){m.scaleTo(e,(function(){return this.__zoom.k*("function"==typeof t?t.apply(this,arguments):t)}),n,i)},m.scaleTo=function(e,t,n,i){m.transform(e,(function(){var e=r.apply(this,arguments),i=this.__zoom,o=null==n?v(e):"function"==typeof n?n.apply(this,arguments):n,a=i.invert(o),l="function"==typeof t?t.apply(this,arguments):t;return s(y(g(i,l),o,a),e,c)}),n,i)},m.translateBy=function(e,t,n,i){m.transform(e,(function(){return s(this.__zoom.translate("function"==typeof t?t.apply(this,arguments):t,"function"==typeof n?n.apply(this,arguments):n),r.apply(this,arguments),c)}),null,i)},m.translateTo=function(e,t,n,i,o){m.transform(e,(function(){var e=r.apply(this,arguments),o=this.__zoom,a=null==i?v(e):"function"==typeof i?i.apply(this,arguments):i;return s(q$.translate(a[0],a[1]).scale(o.k).translate("function"==typeof t?-t.apply(this,arguments):-t,"function"==typeof n?-n.apply(this,arguments):-n),e,c)}),i,o)},b.prototype={event:function(e){return e&&(this.sourceEvent=e),this},start:function(){return 1===++this.active&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(e,t){return this.mouse&&"mouse"!==e&&(this.mouse[1]=t.invert(this.mouse[0])),this.touch0&&"touch"!==e&&(this.touch0[1]=t.invert(this.touch0[0])),this.touch1&&"touch"!==e&&(this.touch1[1]=t.invert(this.touch1[0])),this.that.__zoom=t,this.emit("zoom"),this},end:function(){return 0===--this.active&&(delete this.that.__zooming,this.emit("end")),this},emit:function(e){var t=kq(this.that).datum();d.call(e,this.that,new H$(e,{sourceEvent:this.sourceEvent,target:m,transform:this.that.__zoom,dispatch:d}),t)}},m.wheelDelta=function(e){return arguments.length?(o="function"==typeof e?e:j$(+e),m):o},m.filter=function(e){return arguments.length?(i="function"==typeof e?e:j$(!!e),m):i},m.touchable=function(e){return arguments.length?(a="function"==typeof e?e:j$(!!e),m):a},m.extent=function(e){return arguments.length?(r="function"==typeof e?e:j$([[+e[0][0],+e[0][1]],[+e[1][0],+e[1][1]]]),m):r},m.scaleExtent=function(e){return arguments.length?(l[0]=+e[0],l[1]=+e[1],m):[l[0],l[1]]},m.translateExtent=function(e){return arguments.length?(c[0][0]=+e[0][0],c[1][0]=+e[1][0],c[0][1]=+e[0][1],c[1][1]=+e[1][1],m):[[c[0][0],c[0][1]],[c[1][0],c[1][1]]]},m.constrain=function(e){return arguments.length?(s=e,m):s},m.duration=function(e){return arguments.length?(u=+e,m):u},m.interpolate=function(e){return arguments.length?(h=e,m):h},m.on=function(){var e=d.on.apply(d,arguments);return e===d?m:e},m.clickDistance=function(e){return arguments.length?(p=(e=+e)*e,m):Math.sqrt(p)},m.tapDistance=function(e){return arguments.length?(f=+e,m):f},m}X$.prototype=W$.prototype;function iY(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function rY(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}function sY(e,t){return e.get(rY(e,t))}function oY(e,t,n){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.set(e,n)}function aY(e,t,n){return e.set(rY(e,t),n),n}function lY(e,t,n){return t&&function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,uY(i.key),i)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function cY(e){return function(e){if(Array.isArray(e))return iY(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return iY(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?iY(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function uY(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}var hY=function(e,t,n){return(e<<16)+(t<<8)+n},dY=function(e,t){return 123*e%Math.pow(2,t)},pY=new WeakMap,fY=new WeakMap,mY=function(){return lY((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),oY(this,pY,void 0),oY(this,fY,void 0),aY(fY,this,t),this.reset()}),[{key:"reset",value:function(){aY(pY,this,["__reserved for background__"])}},{key:"register",value:function(e){if(sY(pY,this).length>=Math.pow(2,24-sY(fY,this)))return null;var t,n=sY(pY,this).length,i=dY(n,sY(fY,this)),r=(t=n+(i<<24-sY(fY,this)),"#".concat(Math.min(t,Math.pow(2,24)).toString(16).padStart(6,"0")));return sY(pY,this).push(e),r}},{key:"lookup",value:function(e){if(!e)return null;var t="string"==typeof e?function(e){var t=pb(e).toRgb(),n=t.r,i=t.g,r=t.b;return hY(n,i,r)}(e):hY.apply(void 0,cY(e));if(!t)return null;var n=t&Math.pow(2,24-sY(fY,this))-1,i=t>>24-sY(fY,this)&Math.pow(2,sY(fY,this))-1;return dY(n,sY(fY,this))!==i||n>=sY(pY,this).length?null:sY(pY,this)[n]}}])}();const{abs:gY,cos:yY,sin:vY,acos:_Y,atan2:xY,sqrt:bY,pow:wY}=Math;function TY(e){return e<0?-wY(-e,1/3):wY(e,1/3)}const SY=Math.PI,MY=2*SY,EY=SY/2,AY=Number.MAX_SAFE_INTEGER||9007199254740991,CY=Number.MIN_SAFE_INTEGER||-9007199254740991,RY={x:0,y:0,z:0},NY={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(e,t){const n=t(e);let i=n.x*n.x+n.y*n.y;return void 0!==n.z&&(i+=n.z*n.z),bY(i)},compute:function(e,t,n){if(0===e)return t[0].t=0,t[0];const i=t.length-1;if(1===e)return t[i].t=1,t[i];const r=1-e;let s=t;if(0===i)return t[0].t=e,t[0];if(1===i){const t={x:r*s[0].x+e*s[1].x,y:r*s[0].y+e*s[1].y,t:e};return n&&(t.z=r*s[0].z+e*s[1].z),t}if(i<4){let t,o,a,l=r*r,c=e*e,u=0;2===i?(s=[s[0],s[1],s[2],RY],t=l,o=r*e*2,a=c):3===i&&(t=l*r,o=l*e*3,a=r*c*3,u=e*c);const h={x:t*s[0].x+o*s[1].x+a*s[2].x+u*s[3].x,y:t*s[0].y+o*s[1].y+a*s[2].y+u*s[3].y,t:e};return n&&(h.z=t*s[0].z+o*s[1].z+a*s[2].z+u*s[3].z),h}const o=JSON.parse(JSON.stringify(t));for(;o.length>1;){for(let t=0;t<o.length-1;t++)o[t]={x:o[t].x+(o[t+1].x-o[t].x)*e,y:o[t].y+(o[t+1].y-o[t].y)*e},void 0!==o[t].z&&(o[t].z=o[t].z+(o[t+1].z-o[t].z)*e);o.splice(o.length-1,1)}return o[0].t=e,o[0]},computeWithRatios:function(e,t,n,i){const r=1-e,s=n,o=t;let a,l=s[0],c=s[1],u=s[2],h=s[3];return l*=r,c*=e,2===o.length?(a=l+c,{x:(l*o[0].x+c*o[1].x)/a,y:(l*o[0].y+c*o[1].y)/a,z:!!i&&(l*o[0].z+c*o[1].z)/a,t:e}):(l*=r,c*=2*r,u*=e*e,3===o.length?(a=l+c+u,{x:(l*o[0].x+c*o[1].x+u*o[2].x)/a,y:(l*o[0].y+c*o[1].y+u*o[2].y)/a,z:!!i&&(l*o[0].z+c*o[1].z+u*o[2].z)/a,t:e}):(l*=r,c*=1.5*r,u*=3*r,h*=e*e*e,4===o.length?(a=l+c+u+h,{x:(l*o[0].x+c*o[1].x+u*o[2].x+h*o[3].x)/a,y:(l*o[0].y+c*o[1].y+u*o[2].y+h*o[3].y)/a,z:!!i&&(l*o[0].z+c*o[1].z+u*o[2].z+h*o[3].z)/a,t:e}):void 0))},derive:function(e,t){const n=[];for(let i=e,r=i.length,s=r-1;r>1;r--,s--){const e=[];for(let n,r=0;r<s;r++)n={x:s*(i[r+1].x-i[r].x),y:s*(i[r+1].y-i[r].y)},t&&(n.z=s*(i[r+1].z-i[r].z)),e.push(n);n.push(e),i=e}return n},between:function(e,t,n){return t<=e&&e<=n||NY.approximately(e,t)||NY.approximately(e,n)},approximately:function(e,t,n){return gY(e-t)<=(n||1e-6)},length:function(e){const t=NY.Tvalues.length;let n=0;for(let i,r=0;r<t;r++)i=.5*NY.Tvalues[r]+.5,n+=NY.Cvalues[r]*NY.arcfn(i,e);return.5*n},map:function(e,t,n,i,r){return i+(r-i)*((e-t)/(n-t))},lerp:function(e,t,n){const i={x:t.x+e*(n.x-t.x),y:t.y+e*(n.y-t.y)};return void 0!==t.z&&void 0!==n.z&&(i.z=t.z+e*(n.z-t.z)),i},pointToString:function(e){let t=e.x+"/"+e.y;return void 0!==e.z&&(t+="/"+e.z),t},pointsToString:function(e){return"["+e.map(NY.pointToString).join(", ")+"]"},copy:function(e){return JSON.parse(JSON.stringify(e))},angle:function(e,t,n){const i=t.x-e.x,r=t.y-e.y,s=n.x-e.x,o=n.y-e.y;return xY(i*o-r*s,i*s+r*o)},round:function(e,t){const n=""+e,i=n.indexOf(".");return parseFloat(n.substring(0,i+1+t))},dist:function(e,t){const n=e.x-t.x,i=e.y-t.y;return bY(n*n+i*i)},closest:function(e,t){let n,i,r=wY(2,63);return e.forEach((function(e,s){i=NY.dist(t,e),i<r&&(r=i,n=s)})),{mdist:r,mpos:n}},abcratio:function(e,t){if(2!==t&&3!==t)return!1;if(void 0===e)e=.5;else if(0===e||1===e)return e;const n=wY(e,t)+wY(1-e,t);return gY((n-1)/n)},projectionratio:function(e,t){if(2!==t&&3!==t)return!1;if(void 0===e)e=.5;else if(0===e||1===e)return e;const n=wY(1-e,t);return n/(wY(e,t)+n)},lli8:function(e,t,n,i,r,s,o,a){const l=(e-n)*(s-a)-(t-i)*(r-o);return 0!=l&&{x:((e*i-t*n)*(r-o)-(e-n)*(r*a-s*o))/l,y:((e*i-t*n)*(s-a)-(t-i)*(r*a-s*o))/l}},lli4:function(e,t,n,i){const r=e.x,s=e.y,o=t.x,a=t.y,l=n.x,c=n.y,u=i.x,h=i.y;return NY.lli8(r,s,o,a,l,c,u,h)},lli:function(e,t){return NY.lli4(e,e.c,t,t.c)},makeline:function(e,t){return new zY(e.x,e.y,(e.x+t.x)/2,(e.y+t.y)/2,t.x,t.y)},findbbox:function(e){let t=AY,n=AY,i=CY,r=CY;return e.forEach((function(e){const s=e.bbox();t>s.x.min&&(t=s.x.min),n>s.y.min&&(n=s.y.min),i<s.x.max&&(i=s.x.max),r<s.y.max&&(r=s.y.max)})),{x:{min:t,mid:(t+i)/2,max:i,size:i-t},y:{min:n,mid:(n+r)/2,max:r,size:r-n}}},shapeintersections:function(e,t,n,i,r){if(!NY.bboxoverlap(t,i))return[];const s=[],o=[e.startcap,e.forward,e.back,e.endcap],a=[n.startcap,n.forward,n.back,n.endcap];return o.forEach((function(t){t.virtual||a.forEach((function(i){if(i.virtual)return;const o=t.intersects(i,r);o.length>0&&(o.c1=t,o.c2=i,o.s1=e,o.s2=n,s.push(o))}))})),s},makeshape:function(e,t,n){const i=t.points.length,r=e.points.length,s=NY.makeline(t.points[i-1],e.points[0]),o=NY.makeline(e.points[r-1],t.points[0]),a={startcap:s,forward:e,back:t,endcap:o,bbox:NY.findbbox([s,e,t,o]),intersections:function(e){return NY.shapeintersections(a,a.bbox,e,e.bbox,n)}};return a},getminmax:function(e,t,n){if(!n)return{min:0,max:0};let i,r,s=AY,o=CY;-1===n.indexOf(0)&&(n=[0].concat(n)),-1===n.indexOf(1)&&n.push(1);for(let a=0,l=n.length;a<l;a++)i=n[a],r=e.get(i),r[t]<s&&(s=r[t]),r[t]>o&&(o=r[t]);return{min:s,mid:(s+o)/2,max:o,size:o-s}},align:function(e,t){const n=t.p1.x,i=t.p1.y,r=-xY(t.p2.y-i,t.p2.x-n);return e.map((function(e){return{x:(e.x-n)*yY(r)-(e.y-i)*vY(r),y:(e.x-n)*vY(r)+(e.y-i)*yY(r)}}))},roots:function(e,t){t=t||{p1:{x:0,y:0},p2:{x:1,y:0}};const n=e.length-1,i=NY.align(e,t),r=function(e){return 0<=e&&e<=1};if(2===n){const e=i[0].y,t=i[1].y,n=i[2].y,s=e-2*t+n;if(0!==s){const i=-bY(t*t-e*n),o=-e+t;return[-(i+o)/s,-(-i+o)/s].filter(r)}return t!==n&&0===s?[(2*t-n)/(2*t-2*n)].filter(r):[]}const s=i[0].y,o=i[1].y,a=i[2].y;let l=3*o-s-3*a+i[3].y,c=3*s-6*o+3*a,u=-3*s+3*o,h=s;if(NY.approximately(l,0)){if(NY.approximately(c,0))return NY.approximately(u,0)?[]:[-h/u].filter(r);const e=bY(u*u-4*c*h),t=2*c;return[(e-u)/t,(-u-e)/t].filter(r)}c/=l,u/=l,h/=l;const d=(3*u-c*c)/3,p=d/3,f=(2*c*c*c-9*c*u+27*h)/27,m=f/2,g=m*m+p*p*p;let y,v,_,x,b;if(g<0){const e=-d/3,t=bY(e*e*e),n=-f/(2*t),i=_Y(n<-1?-1:n>1?1:n),s=2*TY(t);return _=s*yY(i/3)-c/3,x=s*yY((i+MY)/3)-c/3,b=s*yY((i+2*MY)/3)-c/3,[_,x,b].filter(r)}if(0===g)return y=m<0?TY(-m):-TY(m),_=2*y-c/3,x=-y-c/3,[_,x].filter(r);{const e=bY(g);return y=TY(-m+e),v=TY(m+e),[y-v-c/3].filter(r)}},droots:function(e){if(3===e.length){const t=e[0],n=e[1],i=e[2],r=t-2*n+i;if(0!==r){const e=-bY(n*n-t*i),s=-t+n;return[-(e+s)/r,-(-e+s)/r]}return n!==i&&0===r?[(2*n-i)/(2*(n-i))]:[]}if(2===e.length){const t=e[0],n=e[1];return t!==n?[t/(t-n)]:[]}return[]},curvature:function(e,t,n,i,r){let s,o,a,l,c=0,u=0;const h=NY.compute(e,t),d=NY.compute(e,n),p=h.x*h.x+h.y*h.y;if(i?(s=bY(wY(h.y*d.z-d.y*h.z,2)+wY(h.z*d.x-d.z*h.x,2)+wY(h.x*d.y-d.x*h.y,2)),o=wY(p+h.z*h.z,1.5)):(s=h.x*d.y-h.y*d.x,o=wY(p,1.5)),0===s||0===o)return{k:0,r:0};if(c=s/o,u=o/s,!r){const r=NY.curvature(e-.001,t,n,i,!0).k,s=NY.curvature(e+.001,t,n,i,!0).k;l=(s-c+(c-r))/2,a=(gY(s-c)+gY(c-r))/2}return{k:c,r:u,dk:l,adk:a}},inflections:function(e){if(e.length<4)return[];const t=NY.align(e,{p1:e[0],p2:e.slice(-1)[0]}),n=t[2].x*t[1].y,i=t[3].x*t[1].y,r=t[1].x*t[2].y,s=18*(-3*n+2*i+3*r-t[3].x*t[2].y),o=18*(3*n-i-3*r),a=18*(r-n);if(NY.approximately(s,0)){if(!NY.approximately(o,0)){let e=-a/o;if(0<=e&&e<=1)return[e]}return[]}const l=2*s;if(NY.approximately(l,0))return[];const c=o*o-4*s*a;if(c<0)return[];const u=Math.sqrt(c);return[(u-o)/l,-(o+u)/l].filter((function(e){return 0<=e&&e<=1}))},bboxoverlap:function(e,t){const n=["x","y"],i=n.length;for(let r,s,o,a,l=0;l<i;l++)if(r=n[l],s=e[r].mid,o=t[r].mid,a=(e[r].size+t[r].size)/2,gY(s-o)>=a)return!1;return!0},expandbox:function(e,t){t.x.min<e.x.min&&(e.x.min=t.x.min),t.y.min<e.y.min&&(e.y.min=t.y.min),t.z&&t.z.min<e.z.min&&(e.z.min=t.z.min),t.x.max>e.x.max&&(e.x.max=t.x.max),t.y.max>e.y.max&&(e.y.max=t.y.max),t.z&&t.z.max>e.z.max&&(e.z.max=t.z.max),e.x.mid=(e.x.min+e.x.max)/2,e.y.mid=(e.y.min+e.y.max)/2,e.z&&(e.z.mid=(e.z.min+e.z.max)/2),e.x.size=e.x.max-e.x.min,e.y.size=e.y.max-e.y.min,e.z&&(e.z.size=e.z.max-e.z.min)},pairiteration:function(e,t,n){const i=e.bbox(),r=t.bbox(),s=1e5,o=n||.5;if(i.x.size+i.y.size<o&&r.x.size+r.y.size<o)return[(s*(e._t1+e._t2)/2|0)/s+"/"+(s*(t._t1+t._t2)/2|0)/s];let a=e.split(.5),l=t.split(.5),c=[{left:a.left,right:l.left},{left:a.left,right:l.right},{left:a.right,right:l.right},{left:a.right,right:l.left}];c=c.filter((function(e){return NY.bboxoverlap(e.left.bbox(),e.right.bbox())}));let u=[];return 0===c.length||(c.forEach((function(e){u=u.concat(NY.pairiteration(e.left,e.right,o))})),u=u.filter((function(e,t){return u.indexOf(e)===t}))),u},getccenter:function(e,t,n){const i=t.x-e.x,r=t.y-e.y,s=n.x-t.x,o=n.y-t.y,a=i*yY(EY)-r*vY(EY),l=i*vY(EY)+r*yY(EY),c=s*yY(EY)-o*vY(EY),u=s*vY(EY)+o*yY(EY),h=(e.x+t.x)/2,d=(e.y+t.y)/2,p=(t.x+n.x)/2,f=(t.y+n.y)/2,m=h+a,g=d+l,y=p+c,v=f+u,_=NY.lli8(h,d,m,g,p,f,y,v),x=NY.dist(_,e);let b,w=xY(e.y-_.y,e.x-_.x),T=xY(t.y-_.y,t.x-_.x),S=xY(n.y-_.y,n.x-_.x);return w<S?((w>T||T>S)&&(w+=MY),w>S&&(b=S,S=w,w=b)):S<T&&T<w?(b=S,S=w,w=b):S+=MY,_.s=w,_.e=S,_.r=x,_},numberSort:function(e,t){return e-t}};class PY{constructor(e){this.curves=[],this._3d=!1,e&&(this.curves=e,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map((function(e){return NY.pointsToString(e.points)})).join(", ")+"]"}addCurve(e){this.curves.push(e),this._3d=this._3d||e._3d}length(){return this.curves.map((function(e){return e.length()})).reduce((function(e,t){return e+t}))}curve(e){return this.curves[e]}bbox(){const e=this.curves;for(var t=e[0].bbox(),n=1;n<e.length;n++)NY.expandbox(t,e[n].bbox());return t}offset(e){const t=[];return this.curves.forEach((function(n){t.push(...n.offset(e))})),new PY(t)}}const{abs:DY,min:LY,max:IY,cos:kY,sin:OY,acos:UY,sqrt:FY}=Math,BY=Math.PI;class zY{constructor(e){let t=e&&e.forEach?e:Array.from(arguments).slice(),n=!1;if("object"==typeof t[0]){n=t.length;const e=[];t.forEach((function(t){["x","y","z"].forEach((function(n){void 0!==t[n]&&e.push(t[n])}))})),t=e}let i=!1;const r=t.length;if(n){if(n>4){if(1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");i=!0}}else if(6!==r&&8!==r&&9!==r&&12!==r&&1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const s=this._3d=!i&&(9===r||12===r)||e&&e[0]&&void 0!==e[0].z,o=this.points=[];for(let e=0,n=s?3:2;e<r;e+=n){var a={x:t[e],y:t[e+1]};s&&(a.z=t[e+2]),o.push(a)}const l=this.order=o.length-1,c=this.dims=["x","y"];s&&c.push("z"),this.dimlen=c.length;const u=NY.align(o,{p1:o[0],p2:o[l]}),h=NY.dist(o[0],o[l]);this._linear=u.reduce(((e,t)=>e+DY(t.y)),0)<h/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(e,t,n,i){if(void 0===i&&(i=.5),0===i)return new zY(t,t,n);if(1===i)return new zY(e,t,t);const r=zY.getABC(2,e,t,n,i);return new zY(e,r.A,n)}static cubicFromPoints(e,t,n,i,r){void 0===i&&(i=.5);const s=zY.getABC(3,e,t,n,i);void 0===r&&(r=NY.dist(t,s.C));const o=r*(1-i)/i,a=NY.dist(e,n),l=(n.x-e.x)/a,c=(n.y-e.y)/a,u=r*l,h=r*c,d=o*l,p=o*c,f=t.x-u,m=t.y-h,g=t.x+d,y=t.y+p,v=s.A,_=v.x+(f-v.x)/(1-i),x=v.y+(m-v.y)/(1-i),b=v.x+(g-v.x)/i,w=v.y+(y-v.y)/i,T={x:e.x+(_-e.x)/i,y:e.y+(x-e.y)/i},S={x:n.x+(b-n.x)/(1-i),y:n.y+(w-n.y)/(1-i)};return new zY(e,T,S,n)}static getUtils(){return NY}getUtils(){return zY.getUtils()}static get PolyBezier(){return PY}valueOf(){return this.toString()}toString(){return NY.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const e=this.points,t=["M",e[0].x,e[0].y,2===this.order?"Q":"C"];for(let n=1,i=e.length;n<i;n++)t.push(e[n].x),t.push(e[n].y);return t.join(" ")}setRatios(e){if(e.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=e,this._lut=[]}verify(){const e=this.coordDigest();e!==this._print&&(this._print=e,this.update())}coordDigest(){return this.points.map((function(e,t){return""+t+e.x+e.y+(e.z?e.z:0)})).join("")}update(){this._lut=[],this.dpoints=NY.derive(this.points,this._3d),this.computedirection()}computedirection(){const e=this.points,t=NY.angle(e[0],e[this.order],e[1]);this.clockwise=t>0}length(){return NY.length(this.derivative.bind(this))}static getABC(e=2,t,n,i,r=.5){const s=NY.projectionratio(r,e),o=1-s,a={x:s*t.x+o*i.x,y:s*t.y+o*i.y},l=NY.abcratio(r,e);return{A:{x:n.x+(n.x-a.x)/l,y:n.y+(n.y-a.y)/l},B:n,C:a,S:t,E:i}}getABC(e,t){t=t||this.get(e);let n=this.points[0],i=this.points[this.order];return zY.getABC(this.order,n,t,i,e)}getLUT(e){if(this.verify(),e=e||100,this._lut.length===e+1)return this._lut;this._lut=[],e++,this._lut=[];for(let t,n,i=0;i<e;i++)n=i/(e-1),t=this.compute(n),t.t=n,this._lut.push(t);return this._lut}on(e,n){n=n||5;const i=this.getLUT(),r=[];for(let t,s=0,o=0;s<i.length;s++)t=i[s],NY.dist(t,e)<n&&(r.push(t),o+=s/i.length);return!!r.length&&(t/=r.length)}project(e){const t=this.getLUT(),n=t.length-1,i=NY.closest(t,e),r=i.mpos,s=(r-1)/n,o=(r+1)/n,a=.1/n;let l,c=i.mdist,u=s,h=u;c+=1;for(let t;u<o+a;u+=a)l=this.compute(u),t=NY.dist(e,l),t<c&&(c=t,h=u);return h=h<0?0:h>1?1:h,l=this.compute(h),l.t=h,l.d=c,l}get(e){return this.compute(e)}point(e){return this.points[e]}compute(e){return this.ratios?NY.computeWithRatios(e,this.points,this.ratios,this._3d):NY.compute(e,this.points,this._3d,this.ratios)}raise(){const e=this.points,t=[e[0]],n=e.length;for(let i,r,s=1;s<n;s++)i=e[s],r=e[s-1],t[s]={x:(n-s)/n*i.x+s/n*r.x,y:(n-s)/n*i.y+s/n*r.y};return t[n]=e[n-1],new zY(t)}derivative(e){return NY.compute(e,this.dpoints[0],this._3d)}dderivative(e){return NY.compute(e,this.dpoints[1],this._3d)}align(){let e=this.points;return new zY(NY.align(e,{p1:e[0],p2:e[e.length-1]}))}curvature(e){return NY.curvature(e,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return NY.inflections(this.points)}normal(e){return this._3d?this.__normal3(e):this.__normal2(e)}__normal2(e){const t=this.derivative(e),n=FY(t.x*t.x+t.y*t.y);return{t:e,x:-t.y/n,y:t.x/n}}__normal3(e){const t=this.derivative(e),n=this.derivative(e+.01),i=FY(t.x*t.x+t.y*t.y+t.z*t.z),r=FY(n.x*n.x+n.y*n.y+n.z*n.z);t.x/=i,t.y/=i,t.z/=i,n.x/=r,n.y/=r,n.z/=r;const s={x:n.y*t.z-n.z*t.y,y:n.z*t.x-n.x*t.z,z:n.x*t.y-n.y*t.x},o=FY(s.x*s.x+s.y*s.y+s.z*s.z);s.x/=o,s.y/=o,s.z/=o;const a=[s.x*s.x,s.x*s.y-s.z,s.x*s.z+s.y,s.x*s.y+s.z,s.y*s.y,s.y*s.z-s.x,s.x*s.z-s.y,s.y*s.z+s.x,s.z*s.z];return{t:e,x:a[0]*t.x+a[1]*t.y+a[2]*t.z,y:a[3]*t.x+a[4]*t.y+a[5]*t.z,z:a[6]*t.x+a[7]*t.y+a[8]*t.z}}hull(e){let t=this.points,n=[],i=[],r=0;for(i[r++]=t[0],i[r++]=t[1],i[r++]=t[2],3===this.order&&(i[r++]=t[3]);t.length>1;){n=[];for(let s,o=0,a=t.length-1;o<a;o++)s=NY.lerp(e,t[o],t[o+1]),i[r++]=s,n.push(s);t=n}return i}split(e,t){if(0===e&&t)return this.split(t).left;if(1===t)return this.split(e).right;const n=this.hull(e),i={left:2===this.order?new zY([n[0],n[3],n[5]]):new zY([n[0],n[4],n[7],n[9]]),right:2===this.order?new zY([n[5],n[4],n[2]]):new zY([n[9],n[8],n[6],n[3]]),span:n};return i.left._t1=NY.map(0,0,1,this._t1,this._t2),i.left._t2=NY.map(e,0,1,this._t1,this._t2),i.right._t1=NY.map(e,0,1,this._t1,this._t2),i.right._t2=NY.map(1,0,1,this._t1,this._t2),t?(t=NY.map(t,e,1,0,1),i.right.split(t).left):i}extrema(){const e={};let t=[];return this.dims.forEach(function(n){let i=function(e){return e[n]},r=this.dpoints[0].map(i);e[n]=NY.droots(r),3===this.order&&(r=this.dpoints[1].map(i),e[n]=e[n].concat(NY.droots(r))),e[n]=e[n].filter((function(e){return e>=0&&e<=1})),t=t.concat(e[n].sort(NY.numberSort))}.bind(this)),e.values=t.sort(NY.numberSort).filter((function(e,n){return t.indexOf(e)===n})),e}bbox(){const e=this.extrema(),t={};return this.dims.forEach(function(n){t[n]=NY.getminmax(this,n,e[n])}.bind(this)),t}overlaps(e){const t=this.bbox(),n=e.bbox();return NY.bboxoverlap(t,n)}offset(e,t){if(void 0!==t){const n=this.get(e),i=this.normal(e),r={c:n,n:i,x:n.x+i.x*t,y:n.y+i.y*t};return this._3d&&(r.z=n.z+i.z*t),r}if(this._linear){const t=this.normal(0),n=this.points.map((function(n){const i={x:n.x+e*t.x,y:n.y+e*t.y};return n.z&&t.z&&(i.z=n.z+e*t.z),i}));return[new zY(n)]}return this.reduce().map((function(t){return t._linear?t.offset(e)[0]:t.scale(e)}))}simple(){if(3===this.order){const e=NY.angle(this.points[0],this.points[3],this.points[1]),t=NY.angle(this.points[0],this.points[3],this.points[2]);if(e>0&&t<0||e<0&&t>0)return!1}const e=this.normal(0),t=this.normal(1);let n=e.x*t.x+e.y*t.y;return this._3d&&(n+=e.z*t.z),DY(UY(n))<BY/3}reduce(){let e,t,n=0,i=0,r=.01,s=[],o=[],a=this.extrema().values;for(-1===a.indexOf(0)&&(a=[0].concat(a)),-1===a.indexOf(1)&&a.push(1),n=a[0],e=1;e<a.length;e++)i=a[e],t=this.split(n,i),t._t1=n,t._t2=i,s.push(t),n=i;return s.forEach((function(e){for(n=0,i=0;i<=1;)for(i=n+r;i<=1.01;i+=r)if(t=e.split(n,i),!t.simple()){if(i-=r,DY(n-i)<r)return[];t=e.split(n,i),t._t1=NY.map(n,0,1,e._t1,e._t2),t._t2=NY.map(i,0,1,e._t1,e._t2),o.push(t),n=i;break}n<1&&(t=e.split(n,1),t._t1=NY.map(n,0,1,e._t1,e._t2),t._t2=e._t2,o.push(t))})),o}translate(e,t,n){n="number"==typeof n?n:t;const i=this.order;let r=this.points.map(((e,r)=>(1-r/i)*t+r/i*n));return new zY(this.points.map(((t,n)=>({x:t.x+e.x*r[n],y:t.y+e.y*r[n]}))))}scale(e){const t=this.order;let n=!1;if("function"==typeof e&&(n=e),n&&2===t)return this.raise().scale(n);const i=this.clockwise,r=this.points;if(this._linear)return this.translate(this.normal(0),n?n(0):e,n?n(1):e);const s=n?n(0):e,o=n?n(1):e,a=[this.offset(0,10),this.offset(1,10)],l=[],c=NY.lli4(a[0],a[0].c,a[1],a[1].c);if(!c)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach((function(e){const n=l[e*t]=NY.copy(r[e*t]);n.x+=(e?o:s)*a[e].n.x,n.y+=(e?o:s)*a[e].n.y})),n?([0,1].forEach((function(s){if(2!==t||!s){var o=r[s+1],a={x:o.x-c.x,y:o.y-c.y},u=n?n((s+1)/t):e;n&&!i&&(u=-u);var h=FY(a.x*a.x+a.y*a.y);a.x/=h,a.y/=h,l[s+1]={x:o.x+u*a.x,y:o.y+u*a.y}}})),new zY(l)):([0,1].forEach((e=>{if(2===t&&e)return;const n=l[e*t],i=this.derivative(e),s={x:n.x+i.x,y:n.y+i.y};l[e+1]=NY.lli4(n,s,c,r[e+1])})),new zY(l))}outline(e,t,n,i){if(t=void 0===t?e:t,this._linear){const r=this.normal(0),s=this.points[0],o=this.points[this.points.length-1];let a,l,c;void 0===n&&(n=e,i=t),a={x:s.x+r.x*e,y:s.y+r.y*e},c={x:o.x+r.x*n,y:o.y+r.y*n},l={x:(a.x+c.x)/2,y:(a.y+c.y)/2};const u=[a,l,c];a={x:s.x-r.x*t,y:s.y-r.y*t},c={x:o.x-r.x*i,y:o.y-r.y*i},l={x:(a.x+c.x)/2,y:(a.y+c.y)/2};const h=[c,l,a],d=NY.makeline(h[2],u[0]),p=NY.makeline(u[2],h[0]),f=[d,new zY(u),p,new zY(h)];return new PY(f)}const r=this.reduce(),s=r.length,o=[];let a,l=[],c=0,u=this.length();const h=void 0!==n&&void 0!==i;function d(e,t,n,i,r){return function(s){const o=i/n,a=(i+r)/n,l=t-e;return NY.map(s,0,1,e+o*l,e+a*l)}}r.forEach((function(r){const s=r.length();h?(o.push(r.scale(d(e,n,u,c,s))),l.push(r.scale(d(-t,-i,u,c,s)))):(o.push(r.scale(e)),l.push(r.scale(-t))),c+=s})),l=l.map((function(e){return a=e.points,a[3]?e.points=[a[3],a[2],a[1],a[0]]:e.points=[a[2],a[1],a[0]],e})).reverse();const p=o[0].points[0],f=o[s-1].points[o[s-1].points.length-1],m=l[s-1].points[l[s-1].points.length-1],g=l[0].points[0],y=NY.makeline(m,p),v=NY.makeline(f,g),_=[y].concat(o).concat([v]).concat(l);return new PY(_)}outlineshapes(e,t,n){t=t||e;const i=this.outline(e,t).curves,r=[];for(let e=1,t=i.length;e<t/2;e++){const s=NY.makeshape(i[e],i[t-e],n);s.startcap.virtual=e>1,s.endcap.virtual=e<t/2-1,r.push(s)}return r}intersects(e,t){return e?e.p1&&e.p2?this.lineIntersects(e):(e instanceof zY&&(e=e.reduce()),this.curveintersects(this.reduce(),e,t)):this.selfintersects(t)}lineIntersects(e){const t=LY(e.p1.x,e.p2.x),n=LY(e.p1.y,e.p2.y),i=IY(e.p1.x,e.p2.x),r=IY(e.p1.y,e.p2.y);return NY.roots(this.points,e).filter((e=>{var s=this.get(e);return NY.between(s.x,t,i)&&NY.between(s.y,n,r)}))}selfintersects(e){const t=this.reduce(),n=t.length-2,i=[];for(let r,s,o,a=0;a<n;a++)s=t.slice(a,a+1),o=t.slice(a+2),r=this.curveintersects(s,o,e),i.push(...r);return i}curveintersects(e,t,n){const i=[];e.forEach((function(e){t.forEach((function(t){e.overlaps(t)&&i.push({left:e,right:t})}))}));let r=[];return i.forEach((function(e){const t=NY.pairiteration(e.left,e.right,n);t.length>0&&(r=r.concat(t))})),r}arcs(e){return e=e||.5,this._iterate(e,[])}_error(e,t,n,i){const r=(i-n)/4,s=this.get(n+r),o=this.get(i-r),a=NY.dist(e,t),l=NY.dist(e,s),c=NY.dist(e,o);return DY(l-a)+DY(c-a)}_iterate(e,t){let n,i=0,r=1;do{n=0,r=1;let s,o,a,l,c,u=this.get(i),h=!1,d=!1,p=r,f=1;do{if(d=h,l=a,p=(i+r)/2,s=this.get(p),o=this.get(r),a=NY.getccenter(u,s,o),a.interval={start:i,end:r},h=this._error(a,u,i,r)<=e,c=d&&!h,c||(f=r),h){if(r>=1){if(a.interval.end=f=1,l=a,r>1){let e={x:a.x+a.r*kY(a.e),y:a.y+a.r*OY(a.e)};a.e+=NY.angle({x:a.x,y:a.y},e,this.get(1))}break}r+=(r-i)/2}else r=p}while(!c&&n++<100);if(n>=100)break;l=l||a,t.push(l),i=f}while(r<1);return t}}function VY(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function GY(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,s,o,a=[],l=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t);else for(;!(l=(i=s.call(n)).done)&&(a.push(i.value),a.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return a}}(e,t)||WY(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function jY(e){return function(e){if(Array.isArray(e))return VY(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||WY(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function HY(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}function WY(e,t){if(e){if("string"==typeof e)return VY(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?VY(e,t):void 0}}var qY=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=(t instanceof Array?t.length?t:[void 0]:[t]).map((function(e){return{keyAccessor:e,isProp:!(e instanceof Function)}})),s=e.reduce((function(e,t){var i=e,s=t;return r.forEach((function(e,t){var o,a=e.keyAccessor;if(e.isProp){var l=s,c=l[a],u=function(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n={};for(var i in e)if({}.hasOwnProperty.call(e,i)){if(t.includes(i))continue;n[i]=e[i]}return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)n=s[i],t.includes(n)||{}.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}(l,[a].map(HY));o=c,s=u}else o=a(s,t);t+1<r.length?(i.hasOwnProperty(o)||(i[o]={}),i=i[o]):n?(i.hasOwnProperty(o)||(i[o]=[]),i[o].push(s)):i[o]=s})),e}),{});n instanceof Function&&function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;i===r.length?Object.keys(t).forEach((function(e){return t[e]=n(t[e])})):Object.values(t).forEach((function(t){return e(t,i+1)}))}(s);var o=s;return i&&(o=[],function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];n.length===r.length?o.push({keys:n,vals:t}):Object.entries(t).forEach((function(t){var i=GY(t,2),r=i[0],s=i[1];return e(s,[].concat(jY(n),[r]))}))}(s),t instanceof Array&&0===t.length&&1===o.length&&(o[0].keys=[])),o};function XY(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function $Y(e,t,n){if(KY())return Reflect.construct.apply(null,arguments);var i=[null];return i.push.apply(i,t),new(e.bind.apply(e,i))}function YY(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function KY(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(KY=function(){return!!e})()}function ZY(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function JY(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ZY(Object(n),!0).forEach((function(t){YY(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ZY(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function QY(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,s,o,a=[],l=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t);else for(;!(l=(i=s.call(n)).done)&&(a.push(i.value),a.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw r}}return a}}(e,t)||nK(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function eK(e){return function(e){if(Array.isArray(e))return XY(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||nK(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function tK(e){return tK="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},tK(e)}function nK(e,t){if(e){if("string"==typeof e)return XY(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?XY(e,t):void 0}}!function(e,t){void 0===t&&(t={});var n=t.insertAt;if("undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===n&&i.firstChild?i.insertBefore(r,i.firstChild):i.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}(".force-graph-container canvas {\n  display: block;\n  user-select: none;\n  outline: none;\n  -webkit-tap-highlight-color: transparent;\n}\n\n.force-graph-container .clickable {\n  cursor: pointer;\n}\n\n.force-graph-container .grabbable {\n  cursor: move;\n  cursor: grab;\n  cursor: -moz-grab;\n  cursor: -webkit-grab;\n}\n\n.force-graph-container .grabbable:active {\n  cursor: grabbing;\n  cursor: -moz-grabbing;\n  cursor: -webkit-grabbing;\n}\n");var iK=hx(cb);function rK(e,t,n){t&&"string"==typeof n&&e.filter((function(e){return!e[n]})).forEach((function(e){e[n]=iK(t(e))}))}var sK=function(e,t){return t.onNeedsRedraw&&t.onNeedsRedraw()},oK=function(e,t){if(!t.isShadow){var n=z_(t.linkDirectionalParticles);t.graphData.links.forEach((function(e){var t=Math.round(Math.abs(n(e)));t?e.__photons=eK(Array(t)).map((function(){return{}})):delete e.__photons}))}},aK=B_({props:{graphData:{default:{nodes:[],links:[]},onChange:function(e,t){t.engineRunning=!1,oK(0,t)}},dagMode:{onChange:function(e,t){!e&&(t.graphData.nodes||[]).forEach((function(e){return e.fx=e.fy=void 0}))}},dagLevelDistance:{},dagNodeFilter:{default:function(e){return!0}},onDagError:{triggerUpdate:!1},nodeRelSize:{default:4,triggerUpdate:!1,onChange:sK},nodeId:{default:"id"},nodeVal:{default:"val",triggerUpdate:!1,onChange:sK},nodeColor:{default:"color",triggerUpdate:!1,onChange:sK},nodeAutoColorBy:{},nodeCanvasObject:{triggerUpdate:!1,onChange:sK},nodeCanvasObjectMode:{default:function(){return"replace"},triggerUpdate:!1,onChange:sK},nodeVisibility:{default:!0,triggerUpdate:!1,onChange:sK},linkSource:{default:"source"},linkTarget:{default:"target"},linkVisibility:{default:!0,triggerUpdate:!1,onChange:sK},linkColor:{default:"color",triggerUpdate:!1,onChange:sK},linkAutoColorBy:{},linkLineDash:{triggerUpdate:!1,onChange:sK},linkWidth:{default:1,triggerUpdate:!1,onChange:sK},linkCurvature:{default:0,triggerUpdate:!1,onChange:sK},linkCanvasObject:{triggerUpdate:!1,onChange:sK},linkCanvasObjectMode:{default:function(){return"replace"},triggerUpdate:!1,onChange:sK},linkDirectionalArrowLength:{default:0,triggerUpdate:!1,onChange:sK},linkDirectionalArrowColor:{triggerUpdate:!1,onChange:sK},linkDirectionalArrowRelPos:{default:.5,triggerUpdate:!1,onChange:sK},linkDirectionalParticles:{default:0,triggerUpdate:!1,onChange:oK},linkDirectionalParticleSpeed:{default:.01,triggerUpdate:!1},linkDirectionalParticleWidth:{default:4,triggerUpdate:!1},linkDirectionalParticleColor:{triggerUpdate:!1},globalScale:{default:1,triggerUpdate:!1},d3AlphaMin:{default:0,triggerUpdate:!1},d3AlphaDecay:{default:.0228,triggerUpdate:!1,onChange:function(e,t){t.forceLayout.alphaDecay(e)}},d3AlphaTarget:{default:0,triggerUpdate:!1,onChange:function(e,t){t.forceLayout.alphaTarget(e)}},d3VelocityDecay:{default:.4,triggerUpdate:!1,onChange:function(e,t){t.forceLayout.velocityDecay(e)}},warmupTicks:{default:0,triggerUpdate:!1},cooldownTicks:{default:1/0,triggerUpdate:!1},cooldownTime:{default:15e3,triggerUpdate:!1},onUpdate:{default:function(){},triggerUpdate:!1},onFinishUpdate:{default:function(){},triggerUpdate:!1},onEngineTick:{default:function(){},triggerUpdate:!1},onEngineStop:{default:function(){},triggerUpdate:!1},onNeedsRedraw:{triggerUpdate:!1},isShadow:{default:!1,triggerUpdate:!1}},methods:{d3Force:function(e,t,n){return void 0===n?e.forceLayout.force(t):(e.forceLayout.force(t,n),this)},d3ReheatSimulation:function(e){return e.forceLayout.alpha(1),this.resetCountdown(),this},resetCountdown:function(e){return e.cntTicks=0,e.startTickTime=new Date,e.engineRunning=!0,this},isEngineRunning:function(e){return!!e.engineRunning},tickFrame:function(e){var t,n,i,r,s,o;return!e.isShadow&&e.engineRunning&&(++e.cntTicks>e.cooldownTicks||new Date-e.startTickTime>e.cooldownTime||e.d3AlphaMin>0&&e.forceLayout.alpha()<e.d3AlphaMin?(e.engineRunning=!1,e.onEngineStop()):(e.forceLayout.tick(),e.onEngineTick())),function(){var t=z_(e.linkVisibility),n=z_(e.linkColor),i=z_(e.linkWidth),r=z_(e.linkLineDash),s=z_(e.linkCurvature),o=z_(e.linkCanvasObjectMode),a=e.ctx,l=2*e.isShadow,c=e.graphData.links.filter(t);c.forEach((function(e){var t=s(e);if(!t)return void(e.__controlPoints=null);var n=e.source,i=e.target;if(!(n&&i&&n.hasOwnProperty("x")&&i.hasOwnProperty("x")))return;var r=Math.sqrt(Math.pow(i.x-n.x,2)+Math.pow(i.y-n.y,2));if(r>0){var o=Math.atan2(i.y-n.y,i.x-n.x),a=r*t,l={x:(n.x+i.x)/2+a*Math.cos(o-Math.PI/2),y:(n.y+i.y)/2+a*Math.sin(o-Math.PI/2)};e.__controlPoints=[l.x,l.y]}else{var c=70*t;e.__controlPoints=[i.x,i.y-c,i.x+c,i.y]}}));var u=[],h=[],d=c;if(e.linkCanvasObject){var p=[],f=[];c.forEach((function(e){return({before:u,after:h,replace:p}[o(e)]||f).push(e)})),d=[].concat(eK(u),h,f),u=u.concat(p)}a.save(),u.forEach((function(t){return e.linkCanvasObject(t,a,e.globalScale)})),a.restore();var m=qY(d,[n,i,r]);a.save(),Object.entries(m).forEach((function(t){var n=QY(t,2),i=n[0],s=n[1],o=i&&"undefined"!==i?i:"rgba(0,0,0,0.15)";Object.entries(s).forEach((function(t){var n=QY(t,2),i=n[0],s=n[1],c=(i||1)/e.globalScale+l;Object.entries(s).forEach((function(e){var t=QY(e,2);t[0];var n=t[1],i=r(n[0]);a.beginPath(),n.forEach((function(e){var t=e.source,n=e.target;if(t&&n&&t.hasOwnProperty("x")&&n.hasOwnProperty("x")){a.moveTo(t.x,t.y);var i=e.__controlPoints;i?a[2===i.length?"quadraticCurveTo":"bezierCurveTo"].apply(a,eK(i).concat([n.x,n.y])):a.lineTo(n.x,n.y)}})),a.strokeStyle=o,a.lineWidth=c,a.setLineDash(i||[]),a.stroke()}))}))})),a.restore(),a.save(),h.forEach((function(t){return e.linkCanvasObject(t,a,e.globalScale)})),a.restore()}(),!e.isShadow&&(t=z_(e.linkDirectionalArrowLength),n=z_(e.linkDirectionalArrowRelPos),i=z_(e.linkVisibility),r=z_(e.linkDirectionalArrowColor||e.linkColor),s=z_(e.nodeVal),(o=e.ctx).save(),e.graphData.links.filter(i).forEach((function(i){var a=t(i);if(a&&!(a<0)){var l=i.source,c=i.target;if(l&&c&&l.hasOwnProperty("x")&&c.hasOwnProperty("x")){var u=Math.sqrt(Math.max(0,s(l)||1))*e.nodeRelSize,h=Math.sqrt(Math.max(0,s(c)||1))*e.nodeRelSize,d=Math.min(1,Math.max(0,n(i))),p=r(i)||"rgba(0,0,0,0.28)",f=a/1.6/2,m=i.__controlPoints&&$Y(zY,[l.x,l.y].concat(eK(i.__controlPoints),[c.x,c.y])),g=m?function(e){return m.get(e)}:function(e){return{x:l.x+(c.x-l.x)*e||0,y:l.y+(c.y-l.y)*e||0}},y=m?m.length():Math.sqrt(Math.pow(c.x-l.x,2)+Math.pow(c.y-l.y,2)),v=u+a+(y-u-h-a)*d,_=g(v/y),x=g((v-a)/y),b=g((v-.8*a)/y),w=Math.atan2(_.y-x.y,_.x-x.x)-Math.PI/2;o.beginPath(),o.moveTo(_.x,_.y),o.lineTo(x.x+f*Math.cos(w),x.y+f*Math.sin(w)),o.lineTo(b.x,b.y),o.lineTo(x.x-f*Math.cos(w),x.y-f*Math.sin(w)),o.fillStyle=p,o.fill()}}})),o.restore()),!e.isShadow&&function(){var t=z_(e.linkDirectionalParticles),n=z_(e.linkDirectionalParticleSpeed),i=z_(e.linkDirectionalParticleWidth),r=z_(e.linkVisibility),s=z_(e.linkDirectionalParticleColor||e.linkColor),o=e.ctx;o.save(),e.graphData.links.filter(r).forEach((function(r){var a=t(r);if(r.hasOwnProperty("__photons")&&r.__photons.length){var l=r.source,c=r.target;if(l&&c&&l.hasOwnProperty("x")&&c.hasOwnProperty("x")){var u=n(r),h=r.__photons||[],d=Math.max(0,i(r)/2)/Math.sqrt(e.globalScale),p=s(r)||"rgba(0,0,0,0.28)";o.fillStyle=p;var f=r.__controlPoints?$Y(zY,[l.x,l.y].concat(eK(r.__controlPoints),[c.x,c.y])):null,m=0,g=!1;h.forEach((function(e){var t=!!e.__singleHop;if(e.hasOwnProperty("__progressRatio")||(e.__progressRatio=t?0:m/a),!t&&m++,e.__progressRatio+=u,e.__progressRatio>=1){if(t)return void(g=!0);e.__progressRatio=e.__progressRatio%1}var n=e.__progressRatio,i=f?f.get(n):{x:l.x+(c.x-l.x)*n||0,y:l.y+(c.y-l.y)*n||0};o.beginPath(),o.arc(i.x,i.y,d,0,2*Math.PI,!1),o.fill()})),g&&(r.__photons=r.__photons.filter((function(e){return!e.__singleHop||e.__progressRatio<=1})))}}})),o.restore()}(),function(){var t=z_(e.nodeVisibility),n=z_(e.nodeVal),i=z_(e.nodeColor),r=z_(e.nodeCanvasObjectMode),s=e.ctx,o=e.isShadow/e.globalScale,a=e.graphData.nodes.filter(t);s.save(),a.forEach((function(t){var a=r(t);if(!e.nodeCanvasObject||"before"!==a&&"replace"!==a||(e.nodeCanvasObject(t,s,e.globalScale),"replace"!==a)){var l=Math.sqrt(Math.max(0,n(t)||1))*e.nodeRelSize+o;s.beginPath(),s.arc(t.x,t.y,l,0,2*Math.PI,!1),s.fillStyle=i(t)||"rgba(31, 120, 180, 0.92)",s.fill(),e.nodeCanvasObject&&"after"===a&&e.nodeCanvasObject(t,e.ctx,e.globalScale)}else s.restore()})),s.restore()}(),this},emitParticle:function(e,t){return t&&(!t.__photons&&(t.__photons=[]),t.__photons.push({__singleHop:!0})),this}},stateInit:function(){return{forceLayout:Cv().force("link",$y()).force("charge",Rv()).force("center",vy()).force("dagRadial",null).stop(),engineRunning:!1}},init:function(e,t){t.ctx=e},update:function(e,t){e.engineRunning=!1,e.onUpdate(),null!==e.nodeAutoColorBy&&rK(e.graphData.nodes,z_(e.nodeAutoColorBy),e.nodeColor),null!==e.linkAutoColorBy&&rK(e.graphData.links,z_(e.linkAutoColorBy),e.linkColor),e.graphData.links.forEach((function(t){t.source=t[e.linkSource],t.target=t[e.linkTarget]})),e.forceLayout.stop().alpha(1).nodes(e.graphData.nodes);var n=e.forceLayout.force("link");n&&n.id((function(t){return t[e.nodeId]})).links(e.graphData.links);var i=e.dagMode&&function(e,t){var n=e.nodes,i=e.links,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=r.nodeFilter,o=void 0===s?function(){return!0}:s,a=r.onLoopError,l=void 0===a?function(e){throw"Invalid DAG structure! Found cycle in node path: ".concat(e.join(" -> "),".")}:a,c={};n.forEach((function(e){return c[t(e)]={data:e,out:[],depth:-1,skip:!o(e)}})),i.forEach((function(e){var n=e.source,i=e.target,r=l(n),s=l(i);if(!c.hasOwnProperty(r))throw"Missing source node with id: ".concat(r);if(!c.hasOwnProperty(s))throw"Missing target node with id: ".concat(s);var o=c[r],a=c[s];function l(e){return"object"===tK(e)?t(e):e}o.out.push(a)}));var u=[];return function e(n){for(var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=function(){var s=n[o];if(-1!==i.indexOf(s)){var a=[].concat(eK(i.slice(i.indexOf(s))),[s]).map((function(e){return t(e.data)}));return u.some((function(e){return e.length===a.length&&e.every((function(e,t){return e===a[t]}))}))||(u.push(a),l(a)),1}r>s.depth&&(s.depth=r,e(s.out,[].concat(eK(i),[s]),r+(s.skip?0:1)))},o=0,a=n.length;o<a;o++)s()}(Object.values(c)),Object.assign.apply(Object,[{}].concat(eK(Object.entries(c).filter((function(e){return!QY(e,2)[1].skip})).map((function(e){var t=QY(e,2);return YY({},t[0],t[1].depth)})))))}(e.graphData,(function(t){return t[e.nodeId]}),{nodeFilter:e.dagNodeFilter,onLoopError:e.onDagError||void 0}),r=Math.max.apply(Math,eK(Object.values(i||[]))),s=e.dagLevelDistance||e.graphData.nodes.length/(r||1)*2*(-1!==["radialin","radialout"].indexOf(e.dagMode)?.7:1);if(["lr","rl","td","bu"].includes(t.dagMode)){var o=["lr","rl"].includes(t.dagMode)?"fx":"fy";e.graphData.nodes.filter(e.dagNodeFilter).forEach((function(e){return delete e[o]}))}if(["lr","rl","td","bu"].includes(e.dagMode)){var a=["rl","bu"].includes(e.dagMode),l=["lr","rl"].includes(e.dagMode)?"fx":"fy";e.graphData.nodes.filter(e.dagNodeFilter).forEach((function(t){return t[l]=function(t){return(i[t[e.nodeId]]-r/2)*s*(a?-1:1)}(t)}))}e.forceLayout.force("dagRadial",-1!==["radialin","radialout"].indexOf(e.dagMode)?Nv((function(t){var n=i[t[e.nodeId]]||-1;return("radialin"===e.dagMode?r-n:n)*s})).strength((function(t){return e.dagNodeFilter(t)?1:0})):null);for(var c=0;c<e.warmupTicks&&!(e.d3AlphaMin>0&&e.forceLayout.alpha()<e.d3AlphaMin);c++)e.forceLayout.tick();this.resetCountdown(),e.onFinishUpdate()}});function lK(e,t){var n=e instanceof Array?e:[e],i=new t;return i._destructor&&i._destructor(),{linkProp:function(e){return{default:i[e](),onChange:function(t,i){n.forEach((function(n){return i[n][e](t)}))},triggerUpdate:!1}},linkMethod:function(e){return function(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];var o=[];return n.forEach((function(n){var i=t[n],s=i[e].apply(i,r);s!==i&&o.push(s)})),o.length?o[0]:this}}}}var cK=lK("forceGraph",aK),uK=lK(["forceGraph","shadowGraph"],aK),hK=Object.assign.apply(Object,eK(["nodeColor","nodeAutoColorBy","nodeCanvasObject","nodeCanvasObjectMode","linkColor","linkAutoColorBy","linkLineDash","linkWidth","linkCanvasObject","linkCanvasObjectMode","linkDirectionalArrowLength","linkDirectionalArrowColor","linkDirectionalArrowRelPos","linkDirectionalParticles","linkDirectionalParticleSpeed","linkDirectionalParticleWidth","linkDirectionalParticleColor","dagMode","dagLevelDistance","dagNodeFilter","onDagError","d3AlphaMin","d3AlphaDecay","d3VelocityDecay","warmupTicks","cooldownTicks","cooldownTime","onEngineTick","onEngineStop"].map((function(e){return YY({},e,cK.linkProp(e))}))).concat(eK(["nodeRelSize","nodeId","nodeVal","nodeVisibility","linkSource","linkTarget","linkVisibility","linkCurvature"].map((function(e){return YY({},e,uK.linkProp(e))}))))),dK=Object.assign.apply(Object,eK(["d3Force","d3ReheatSimulation","emitParticle"].map((function(e){return YY({},e,cK.linkMethod(e))}))));function pK(e){if(e.canvas){var t=e.canvas.width,n=e.canvas.height;300===t&&150===n&&(t=n=0);var i=window.devicePixelRatio;t/=i,n/=i,[e.canvas,e.shadowCanvas].forEach((function(r){r.style.width="".concat(e.width,"px"),r.style.height="".concat(e.height,"px"),r.width=e.width*i,r.height=e.height*i,t||n||r.getContext("2d").scale(i,i)}));var r=X$(e.canvas).k;e.zoom.translateBy(e.zoom.__baseElem,(e.width-t)/2/r,(e.height-n)/2/r),e.needsRedraw=!0}}function fK(e){var t=window.devicePixelRatio;e.setTransform(t,0,0,t,0,0)}function mK(e,t,n){e.save(),fK(e),e.clearRect(0,0,t,n),e.restore()}var gK=B_({props:JY({width:{default:window.innerWidth,onChange:function(e,t){return pK(t)},triggerUpdate:!1},height:{default:window.innerHeight,onChange:function(e,t){return pK(t)},triggerUpdate:!1},graphData:{default:{nodes:[],links:[]},onChange:function(e,t){[e.nodes,e.links].every((function(e){return(e||[]).every((function(e){return!e.hasOwnProperty("__indexColor")}))}))&&t.colorTracker.reset(),[{type:"Node",objs:e.nodes},{type:"Link",objs:e.links}].forEach((function(e){var n=e.type;e.objs.filter((function(e){if(!e.hasOwnProperty("__indexColor"))return!0;var n=t.colorTracker.lookup(e.__indexColor);return!n||!n.hasOwnProperty("d")||n.d!==e})).forEach((function(e){e.__indexColor=t.colorTracker.register({type:n,d:e})}))})),t.forceGraph.graphData(e),t.shadowGraph.graphData(e)},triggerUpdate:!1},backgroundColor:{onChange:function(e,t){t.canvas&&e&&(t.canvas.style.background=e)},triggerUpdate:!1},nodeLabel:{default:"name",triggerUpdate:!1},nodePointerAreaPaint:{onChange:function(e,t){t.shadowGraph.nodeCanvasObject(e?function(t,n,i){return e(t,t.__indexColor,n,i)}:null),t.flushShadowCanvas&&t.flushShadowCanvas()},triggerUpdate:!1},linkPointerAreaPaint:{onChange:function(e,t){t.shadowGraph.linkCanvasObject(e?function(t,n,i){return e(t,t.__indexColor,n,i)}:null),t.flushShadowCanvas&&t.flushShadowCanvas()},triggerUpdate:!1},linkLabel:{default:"name",triggerUpdate:!1},linkHoverPrecision:{default:4,triggerUpdate:!1},minZoom:{default:.01,onChange:function(e,t){t.zoom.scaleExtent([e,t.zoom.scaleExtent()[1]])},triggerUpdate:!1},maxZoom:{default:1e3,onChange:function(e,t){t.zoom.scaleExtent([t.zoom.scaleExtent()[0],e])},triggerUpdate:!1},enableNodeDrag:{default:!0,triggerUpdate:!1},enableZoomInteraction:{default:!0,triggerUpdate:!1},enablePanInteraction:{default:!0,triggerUpdate:!1},enableZoomPanInteraction:{default:!0,triggerUpdate:!1},enablePointerInteraction:{default:!0,onChange:function(e,t){t.hoverObj=null},triggerUpdate:!1},autoPauseRedraw:{default:!0,triggerUpdate:!1},onNodeDrag:{default:function(){},triggerUpdate:!1},onNodeDragEnd:{default:function(){},triggerUpdate:!1},onNodeClick:{triggerUpdate:!1},onNodeRightClick:{triggerUpdate:!1},onNodeHover:{triggerUpdate:!1},onLinkClick:{triggerUpdate:!1},onLinkRightClick:{triggerUpdate:!1},onLinkHover:{triggerUpdate:!1},onBackgroundClick:{triggerUpdate:!1},onBackgroundRightClick:{triggerUpdate:!1},onZoom:{triggerUpdate:!1},onZoomEnd:{triggerUpdate:!1},onRenderFramePre:{triggerUpdate:!1},onRenderFramePost:{triggerUpdate:!1}},hK),aliases:{stopAnimation:"pauseAnimation"},methods:JY({graph2ScreenCoords:function(e,t,n){var i=X$(e.canvas);return{x:t*i.k+i.x,y:n*i.k+i.y}},screen2GraphCoords:function(e,t,n){var i=X$(e.canvas);return{x:(t-i.x)/i.k,y:(n-i.y)/i.k}},centerAt:function(e,t,n,i){if(!e.canvas)return null;if(void 0!==t||void 0!==n){var r=Object.assign({},void 0!==t?{x:t}:{},void 0!==n?{y:n}:{});return i?e.tweenGroup.add(new bW(s()).to(r,i).easing(mW.Quadratic.Out).onUpdate(o).start()):o(r),this}return s();function s(){var t=X$(e.canvas);return{x:(e.width/2-t.x)/t.k,y:(e.height/2-t.y)/t.k}}function o(t){var n=t.x,i=t.y;e.zoom.translateTo(e.zoom.__baseElem,void 0===n?s().x:n,void 0===i?s().y:i),e.needsRedraw=!0}},zoom:function(e,t,n){return e.canvas?void 0!==t?(n?e.tweenGroup.add(new bW({k:i()}).to({k:t},n).easing(mW.Quadratic.Out).onUpdate((function(e){return r(e.k)})).start()):r(t),this):i():null;function i(){return X$(e.canvas).k}function r(t){e.zoom.scaleTo(e.zoom.__baseElem,t),e.needsRedraw=!0}},zoomToFit:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,i=arguments.length,r=new Array(i>3?i-3:0),s=3;s<i;s++)r[s-3]=arguments[s];var o=this.getGraphBbox.apply(this,r);if(o){var a={x:(o.x[0]+o.x[1])/2,y:(o.y[0]+o.y[1])/2},l=Math.max(1e-12,Math.min(1e12,(e.width-2*n)/(o.x[1]-o.x[0]),(e.height-2*n)/(o.y[1]-o.y[0])));this.centerAt(a.x,a.y,t),this.zoom(l,t)}return this},getGraphBbox:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!0},n=z_(e.nodeVal),i=function(t){return Math.sqrt(Math.max(0,n(t)||1))*e.nodeRelSize},r=e.graphData.nodes.filter(t).map((function(e){return{x:e.x,y:e.y,r:i(e)}}));return r.length?{x:[W_(r,(function(e){return e.x-e.r})),H_(r,(function(e){return e.x+e.r}))],y:[W_(r,(function(e){return e.y-e.r})),H_(r,(function(e){return e.y+e.r}))]}:null},pauseAnimation:function(e){return e.animationFrameRequestId&&(cancelAnimationFrame(e.animationFrameRequestId),e.animationFrameRequestId=null),this},resumeAnimation:function(e){return e.animationFrameRequestId||this._animationCycle(),this},_destructor:function(){this.pauseAnimation(),this.graphData({nodes:[],links:[]})}},dK),stateInit:function(){return{lastSetZoom:1,zoom:nY(),forceGraph:new aK,shadowGraph:(new aK).cooldownTicks(0).nodeColor("__indexColor").linkColor("__indexColor").isShadow(!0),colorTracker:new mY,tweenGroup:new yW}},init:function(e,t){var n=this;e.innerHTML="";var i=document.createElement("div");i.classList.add("force-graph-container"),i.style.position="relative",e.appendChild(i),t.canvas=document.createElement("canvas"),t.backgroundColor&&(t.canvas.style.background=t.backgroundColor),i.appendChild(t.canvas),t.shadowCanvas=document.createElement("canvas");var r=t.canvas.getContext("2d"),s=t.shadowCanvas.getContext("2d",{willReadFrequently:!0}),o={x:-1e12,y:-1e12},a=function(){var e=null,n=window.devicePixelRatio,i=o.x>0&&o.y>0?s.getImageData(o.x*n,o.y*n,1,1):null;return i&&(e=t.colorTracker.lookup(i.data)),e};kq(t.canvas).call(function(){var e,t,n,i,r=l$,s=c$,o=u$,a=h$,l={},c=Ky("start","drag","end"),u=0,h=0;function d(e){e.on("mousedown.drag",p).filter(a).on("touchstart.drag",g).on("touchmove.drag",y,e$).on("touchend.drag touchcancel.drag",v).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function p(o,a){if(!i&&r.call(this,o,a)){var l=_(this,s.call(this,o,a),o,a,"mouse");l&&(kq(o.view).on("mousemove.drag",f,t$).on("mouseup.drag",m,t$),r$(o.view),n$(o),n=!1,e=o.clientX,t=o.clientY,l("start",o))}}function f(i){if(i$(i),!n){var r=i.clientX-e,s=i.clientY-t;n=r*r+s*s>h}l.mouse("drag",i)}function m(e){kq(e.view).on("mousemove.drag mouseup.drag",null),s$(e.view,n),i$(e),l.mouse("end",e)}function g(e,t){if(r.call(this,e,t)){var n,i,o=e.changedTouches,a=s.call(this,e,t),l=o.length;for(n=0;n<l;++n)(i=_(this,a,e,t,o[n].identifier,o[n]))&&(n$(e),i("start",e,o[n]))}}function y(e){var t,n,i=e.changedTouches,r=i.length;for(t=0;t<r;++t)(n=l[i[t].identifier])&&(i$(e),n("drag",e,i[t]))}function v(e){var t,n,r=e.changedTouches,s=r.length;for(i&&clearTimeout(i),i=setTimeout((function(){i=null}),500),t=0;t<s;++t)(n=l[r[t].identifier])&&(n$(e),n("end",e,r[t]))}function _(e,t,n,i,r,s){var a,h,p,f=c.copy(),m=Oq(s||n,t);if(null!=(p=o.call(e,new a$("beforestart",{sourceEvent:n,target:d,identifier:r,active:u,x:m[0],y:m[1],dx:0,dy:0,dispatch:f}),i)))return a=p.x-m[0]||0,h=p.y-m[1]||0,function n(s,o,c){var g,y=m;switch(s){case"start":l[r]=n,g=u++;break;case"end":delete l[r],--u;case"drag":m=Oq(c||o,t),g=u}f.call(s,e,new a$(s,{sourceEvent:o,subject:p,target:d,identifier:r,active:g,x:m[0]+a,y:m[1]+h,dx:m[0]-y[0],dy:m[1]-y[1],dispatch:f}),i)}}return d.filter=function(e){return arguments.length?(r="function"==typeof e?e:o$(!!e),d):r},d.container=function(e){return arguments.length?(s="function"==typeof e?e:o$(e),d):s},d.subject=function(e){return arguments.length?(o="function"==typeof e?e:o$(e),d):o},d.touchable=function(e){return arguments.length?(a="function"==typeof e?e:o$(!!e),d):a},d.on=function(){var e=c.on.apply(c,arguments);return e===c?d:e},d.clickDistance=function(e){return arguments.length?(h=(e=+e)*e,d):Math.sqrt(h)},d}().subject((function(){if(!t.enableNodeDrag)return null;var e=a();return e&&"Node"===e.type?e.d:null})).on("start",(function(e){var n=e.subject;n.__initialDragPos={x:n.x,y:n.y,fx:n.fx,fy:n.fy},e.active||(n.fx=n.x,n.fy=n.y),t.canvas.classList.add("grabbable")})).on("drag",(function(e){var n=e.subject,i=n.__initialDragPos,r=e,s=X$(t.canvas).k,o={x:i.x+(r.x-i.x)/s-n.x,y:i.y+(r.y-i.y)/s-n.y};["x","y"].forEach((function(e){return n["f".concat(e)]=n[e]=i[e]+(r[e]-i[e])/s})),!n.__dragged&&5>=Math.sqrt(function(e){let t=0;for(let n of e)(n=+n)&&(t+=n);return t}(["x","y"].map((function(t){return Math.pow(e[t]-i[t],2)}))))||(t.forceGraph.d3AlphaTarget(.3).resetCountdown(),t.isPointerDragging=!0,n.__dragged=!0,t.onNodeDrag(n,o))})).on("end",(function(e){var n=e.subject,i=n.__initialDragPos,r={x:n.x-i.x,y:n.y-i.y};void 0===i.fx&&(n.fx=void 0),void 0===i.fy&&(n.fy=void 0),delete n.__initialDragPos,t.forceGraph.d3AlphaTarget()&&t.forceGraph.d3AlphaTarget(0).resetCountdown(),t.canvas.classList.remove("grabbable"),t.isPointerDragging=!1,n.__dragged&&(delete n.__dragged,t.onNodeDragEnd(n,r))}))),t.zoom(t.zoom.__baseElem=kq(t.canvas)),t.zoom.__baseElem.on("dblclick.zoom",null),t.zoom.filter((function(e){return!e.button&&t.enableZoomPanInteraction&&("wheel"!==e.type||z_(t.enableZoomInteraction)(e))&&("wheel"===e.type||z_(t.enablePanInteraction)(e))})).on("zoom",(function(e){var i=e.transform;[r,s].forEach((function(e){fK(e),e.translate(i.x,i.y),e.scale(i.k,i.k)})),t.isPointerDragging=!0,t.onZoom&&t.onZoom(JY(JY({},i),n.centerAt())),t.needsRedraw=!0})).on("end",(function(e){t.isPointerDragging=!1,t.onZoomEnd&&t.onZoomEnd(JY(JY({},e.transform),n.centerAt()))})),pK(t),t.forceGraph.onNeedsRedraw((function(){return t.needsRedraw=!0})).onFinishUpdate((function(){X$(t.canvas).k===t.lastSetZoom&&t.graphData.nodes.length&&(t.zoom.scaleTo(t.zoom.__baseElem,t.lastSetZoom=4/Math.cbrt(t.graphData.nodes.length)),t.needsRedraw=!0)})),t.tooltip=new NX(i),["pointermove","pointerdown"].forEach((function(e){return i.addEventListener(e,(function(n){"pointerdown"===e&&(t.isPointerPressed=!0,t.pointerDownEvent=n),!t.isPointerDragging&&"pointermove"===n.type&&t.onBackgroundClick&&(n.pressure>0||t.isPointerPressed)&&("touch"!==n.pointerType||void 0===n.movementX||[n.movementX,n.movementY].some((function(e){return Math.abs(e)>1})))&&(t.isPointerDragging=!0);var r,s,a,l=(r=i.getBoundingClientRect(),s=window.pageXOffset||document.documentElement.scrollLeft,a=window.pageYOffset||document.documentElement.scrollTop,{top:r.top+a,left:r.left+s});o.x=n.pageX-l.left,o.y=n.pageY-l.top}),{passive:!0})})),i.addEventListener("pointerup",(function(e){if(t.isPointerPressed)if(t.isPointerPressed=!1,t.isPointerDragging)t.isPointerDragging=!1;else{var n=[e,t.pointerDownEvent];requestAnimationFrame((function(){if(0===e.button)if(t.hoverObj){var i=t["on".concat(t.hoverObj.type,"Click")];i&&i.apply(void 0,[t.hoverObj.d].concat(n))}else t.onBackgroundClick&&t.onBackgroundClick.apply(t,n);if(2===e.button)if(t.hoverObj){var r=t["on".concat(t.hoverObj.type,"RightClick")];r&&r.apply(void 0,[t.hoverObj.d].concat(n))}else t.onBackgroundRightClick&&t.onBackgroundRightClick.apply(t,n)}))}}),{passive:!0}),i.addEventListener("contextmenu",(function(e){return!(t.onBackgroundRightClick||t.onNodeRightClick||t.onLinkRightClick)||(e.preventDefault(),!1)})),t.forceGraph(r),t.shadowGraph(s);var l=function(e,t,n){var i=!0,r=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return h_(n)&&(i="leading"in n?!!n.leading:i,r="trailing"in n?!!n.trailing:r),I_(e,t,{leading:i,maxWait:t,trailing:r})}((function(){mK(s,t.width,t.height),t.shadowGraph.linkWidth((function(e){return z_(t.linkWidth)(e)+t.linkHoverPrecision}));var e=X$(t.canvas);t.shadowGraph.globalScale(e.k).tickFrame()}),800);t.flushShadowCanvas=l.flush,(this._animationCycle=function e(){var n=!t.autoPauseRedraw||!!t.needsRedraw||t.forceGraph.isEngineRunning()||t.graphData.links.some((function(e){return e.__photons&&e.__photons.length}));if(t.needsRedraw=!1,t.enablePointerInteraction){var i=t.isPointerDragging?null:a();if(i!==t.hoverObj){var s=t.hoverObj,o=s?s.type:null,c=i?i.type:null;if(o&&o!==c){var u=t["on".concat(o,"Hover")];u&&u(null,s.d)}if(c){var h=t["on".concat(c,"Hover")];h&&h(i.d,o===c?s.d:null)}t.tooltip.content(i&&z_(t["".concat(i.type.toLowerCase(),"Label")])(i.d)||null),t.canvas.classList[i&&t["on".concat(c,"Click")]||!i&&t.onBackgroundClick?"add":"remove"]("clickable"),t.hoverObj=i}n&&l()}if(n){mK(r,t.width,t.height);var d=X$(t.canvas).k;t.onRenderFramePre&&t.onRenderFramePre(r,d),t.forceGraph.globalScale(d).tickFrame(),t.onRenderFramePost&&t.onRenderFramePost(r,d)}t.tweenGroup.update(),t.animationFrameRequestId=requestAnimationFrame(e)})()},update:function(e){}});const yK=d(gK,{methodNames:["emitParticle","d3Force","d3ReheatSimulation","stopAnimation","pauseAnimation","resumeAnimation","centerAt","zoom","zoomToFit","getGraphBbox","screen2GraphCoords","graph2ScreenCoords"]});yK.displayName="ForceGraph2D",yK.propTypes=KT,e.ForceGraph2D=yK,e.ForceGraph3D=QX,e.ForceGraphAR=cS,e.ForceGraphVR=eS}));
